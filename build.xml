<?xml version="1.0"?>
<!--
build file for kissy editor
@author:yiminghe@gmail.com
-->
<project name="kissy-editor-build" default="run">
    <description>Kissy Editor Build File</description>
    <dirname property="current.dir" file="${ant.file.kissy-editor-build}"/>
    <property name="root.dir" location="${current.dir}/../"/>
    <property name="ks-tools.dir" location="${root.dir}/kissy-tools/"/>
    <property name="build.dir" location="${current.dir}/build/"/>
    <property name="version" value="2.0"/>
    <property name="charset" value="utf-8"/>
    <taskdef resource="net/sf/antcontrib/antcontrib.properties"/>

    <!--
    create dir necessarily
    -->
    <target name="prepare">

        <mkdir dir="build"/>
        <copy todir="build">
            <dirset dir="." includes="core/**,plugins/**,ui/**">
            </dirset>
        </copy>
        <copy todir="build">
            <fileset dir="." includes="assets/*.png,assets/*.gif"></fileset>
        </copy>
    </target>

    <target name="run" depends="clean,prepare,concat,minify">

    </target>

    <!--
    minify all js and css to build dir
    -->
    <target name="minify">

        <apply executable="java" verbose="true" dest="build">
            <fileset dir="." includes="**/*.js" excludes="build/**/*,editor.js"/>
            <fileset dir="build" includes="editor-*.js"/>
            <arg line="-jar"/>
            <arg path="${ks-tools.dir}/closure-compiler/compiler.jar"/>
            <arg line="--charset ${charset}"/>
            <arg value="--warning_level"/>
            <arg value="QUIET"/>
            <arg value="--js"/>
            <srcfile/>
            <arg value="--js_output_file"/>
            <targetfile/>
            <mapper type="regexp" from="^(.*)\.(css|js)$" to="\1.\2"/>
        </apply>

        <apply executable="java" verbose="true" dest="build">
            <fileset dir="." includes="**/*.css" excludes="build/**/*"/>
            <arg line="-jar"/>
            <arg path="${ks-tools.dir}/yuicompressor/yuicompressor.jar"/>
            <arg line="--charset ${charset}"/>
            <srcfile/>
            <arg line="-o"/>
            <targetfile/>
            <mapper type="regexp" from="^(.*)\.(css|js)$" to="\1.\2"/>
        </apply>

        <apply executable="java" verbose="true" dest="build">
            <fileset dir="build" includes="editor-all-pkg.js,editor-core-pkg.js"/>
            <arg line="-jar"/>
            <arg path="${ks-tools.dir}/closure-compiler/compiler.jar"/>
            <arg line="--charset ${charset}"/>
            <arg value="--warning_level"/>
            <arg value="QUIET"/>
            <arg value="--js"/>
            <srcfile/>
            <arg value="--js_output_file"/>
            <targetfile/>
            <mapper type="regexp" from="^(.*)\.(css|js)$" to="\1-min.\2"/>
        </apply>

    </target>

    <!--
    concat js files
    -->
    <target name="concat">
        <!--
        kissy editor core ,load plugins dynamically
        -->
        <concat destfile="build/editor-core-pkg.js">
            <filelist dir="."
                      files="editor.js"/>
            <filelist dir="core"
                      files="utils.js,focusmanager.js,definition.js,
                      dtd.js,dom.js,elementpath.js
                      ,walker.js,range.js,domiterator.js,selection.js
                      ,styles.js"/>
        </concat>

        <!--
        full kissy editor ,all plugins static included
        -->
        <concat destfile="build/editor-all-pkg.js">
            <filelist dir="."
                      files="editor.js"/>
            <filelist dir="core"
                      files="utils.js,focusmanager.js,definition.js,
                      dtd.js,dom.js,elementpath.js
                      ,walker.js,range.js,domiterator.js,selection.js
                      ,styles.js"/>
            <fileset dir="ui"
                     includes="**/*.js"/>
            <fileset dir="plugins"
                     includes="**/*.js"/>
        </concat>

    </target>

    <target name="clean">
        <delete dir="build"></delete>
    </target>

</project>