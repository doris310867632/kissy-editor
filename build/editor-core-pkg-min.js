KISSY.add("editor",function(x,H){function G(v,a){var c=this;if(!(c instanceof G))return new G(v,a);if(x.isString(v))v=x.one(v);v[0]||(v=new Node(v));c.cfg=a;x.app(c,x.EventTarget);c.use=function(h){x.use.call(c,h,function(){c.on("dataReady",function(){c.setData(v.val())})},{order:true,global:G})};c.init(v);return H}function y(v){if(!E)return"build/"+v.replace(/\.(js|css)/i,"-min.$1");if(E==="dev")return v;return"build/"+v}x.app(G,x.EventTarget);G.Config.base=x.Config.base+"editor/";var E=x.Config.debug,
q={htmlparser:{attach:false,path:y("plugins/htmldataprocessor/htmlparser/htmlparser.js")}},D=["utils","focusmanager","definition","dtd","dom","elementpath","walker","range","domiterator","selection","styles"],C=["clipboard",{name:"color",useCss:true},{name:"elementpaths",useCss:true},"enterkey","fakeobjects",{name:"flash",requires:["contextmenu","fakeobjects","overlay"]},"font","format",{name:"htmldataprocessor",requires:["htmlparser-text"]},{name:"image",requires:["overlay"]},"indent","justify",
"link","list","maximize","music","preview","removeformat",{name:"smiley",useCss:true},"sourcearea",{name:"table",useCss:true,requires:["overlay","contextmenu"]},{name:"templates",requires:["overlay"],useCss:true},"undo"],j=[{name:"htmlparser-basicwriter",requires:["htmlparser"]},{name:"htmlparser-element",requires:["htmlparser-fragment"]},{name:"htmlparser-filter",requires:["htmlparser-element"]},{name:"htmlparser-fragment",requires:["htmlparser-htmlwriter"]},{name:"htmlparser-htmlwriter",requires:["htmlparser-basicwriter"]},
{name:"htmlparser-text",requires:["htmlparser-filter"]}],o=[{name:"button"},{name:"overlay",useCss:true},{name:"contextmenu",requires:["overlay"],useCss:true}],u,w,z,l,r;u=0;for(w=o.length;u<w;u++){l=z=o[u];r=H;if(!x.isString(z)){r=z.requires;l=z.name}q[l]={attach:false,requires:r,path:y("ui/"+l+".js"),csspath:z.useCss?y("ui/"+l+".css"):""}}u=0;for(w=C.length;u<w;u++){l=z=C[u];r=["button"];if(!x.isString(z)){z.requires&&(r=r.concat(z.requires));l=z.name}q[l]={attach:false,requires:r,csspath:z.useCss?
y("plugins/"+l+"/plugin.css"):H,path:y("plugins/"+l+"/plugin.js")}}u=0;for(w=j.length;u<w;u++){z=j[u];r=H;if(!x.isString(z)){r=z.requires;z=z.name}q[z]={attach:false,requires:r,path:y("plugins/htmldataprocessor/htmlparser/"+z.substring(11)+".js")}}G.add(q);q={};u=0;for(w=D.length;u<w;u++){z=D[u];q[z]={host:"editor",requires:u>0?D[u-1]:[]}}G.add(q);x.Editor=G});
KISSY.Editor.add("utils",function(x){var H=KISSY,G=H.Node,y=H.DOM,E=H.Config.debug;x.Utils={debugUrl:function(q){if(!E)return"build/"+q.replace(/\.(js|css)/i,"-min.$1");if(E==="dev")return q;return"build/"+q},lazyRun:function(q,D,C){var j=q[D],o=q[C];q[D]=function(){j.apply(this,arguments);q[D]=q[C];return o.apply(this,arguments)}},getXY:function(q,D,C,j){C=C.defaultView||C.parentWindow;q-=y.scrollLeft(C);D-=y.scrollTop(C);if(j)if(C!=(j.defaultView||j.parentWindow)&&C.frameElement){j=y._4e_getOffset(C.frameElement,
j);q+=j.left;D+=j.top}return{left:q,top:D}},tryThese:function(){for(var q,D=0,C=arguments.length;D<C;D++){var j=arguments[D];try{q=j();break}catch(o){}}return q},arrayCompare:function(q,D){if(!q&&!D)return true;if(!q||!D||q.length!=D.length)return false;for(var C=0;C<q.length;C++)if(q[C]!==D[C])return false;return true},getByAddress:function(q,D,C){q=q.documentElement;for(var j=0;q&&j<D.length;j++){var o=D[j];if(C)for(var u=-1,w=0;w<q.childNodes.length;w++){var z=q.childNodes[w];if(!(C===true&&z.nodeType==
3&&z.previousSibling&&z.previousSibling.nodeType==3)){u++;if(u==o){q=z;break}}}else q=q.childNodes[o]}return q?new G(q):null},clearAllMarkers:function(q){for(var D in q)q[D]._4e_clearMarkers(q,true)},htmlEncodeAttr:function(q){return q.replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/,"&gt;")},ltrim:function(q){return q.replace(/^\s+/,"")},rtrim:function(q){return q.replace(/\s+$/,"")},trim:function(q){return this.ltrim(this.rtrim(q))},mix:function(){for(var q={},D=0;D<arguments.length;D++)q=
H.mix(q,arguments[D]);return q}}});KISSY.Editor.add("focusmanager",function(x){function H(){this.iframeFocus=true;C=this}function G(){this.iframeFocus=false;C=null}var y=KISSY,E=y.DOM,q=y.Event;y={};var D={},C;y.currentInstance=function(){return C};y.add=function(j){D[j._UUID]=j;var o=E._4e_getWin(j.document);q.on(o,"focus",H,j);q.on(o,"blur",G,j)};y.remove=function(j){delete D[j._UUID];var o=E._4e_getWin(j.document);q.remove(o,"focus",H,j);q.remove(o,"blur",G,j)};x.focusManager=y});
KISSY.Editor.add("definition",function(x){function H(){return o+"<html><head><title>kissy-editor</title><link href='"+x.Config.base+u+"' rel='stylesheet'/></head><body class='ke-editor'>&nbsp;</body><html>"}var G=KISSY,y=G.UA,E=G.DOM,q=G.Node,D=G.Event,C=x.focusManager,j=x.Utils.tryThese,o="<!doctype html>",u=x.Utils.debugUrl("assets/editor-iframe.css"),w=1,z="<div  class='ke-editor-wrap'  > <div class='"+".ke-editor-tools".substring(1)+"'></div><div class='"+".ke-textarea-wrap".substring(1)+'\'><iframe  style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor"  src="'+
(y.ie?"javascript:void(function(){"+encodeURIComponent("document.open();document.close();")+"}())":"")+'"  tabIndex="'+(y.webkit?-1:"$(tabIndex)")+'"  allowTransparency="true" ></iframe></div><div class=\''+".ke-editor-status".substring(1)+"'></div></div>";G.augment(x,{init:function(l){var r=this,v=new q(z.replace(/\$\(tabIndex\)/,l.attr("tabIndex")));v.on("mousedown",function(h){if(y.webkit){var e=E._4e_name(h.target);if(e=="select"||e=="option")return true}h.halt()});r.editorWrap=v;r._UUID=w++;
r.wrap=v.one(".ke-textarea-wrap");r.iframe=r.wrap.one("iframe");r.toolBarDiv=v.one(".ke-editor-tools");r.textarea=l;r.statusDiv=v.one(".ke-editor-status");r.toolBarDiv._4e_unselectable();r._commands={};r._plugins={};var a=l._4e_style("width"),c=l._4e_style("height");if(a){v.css("width",a);l.css("width","100%")}r.textarea.css("display","none");v.insertAfter(l);r.wrap[0].appendChild(l[0]);if(c){r.wrap.css("height",c);l.css("height","100%")}l=r.iframe;r.on("dataReady",function(){r.ready=true;x.fire("instanceCreated",
{editor:r})});y.gecko?l.on("load",r._initIFrame,r):r._initIFrame()},addCommand:function(l,r){this._commands[l]=r},execCommand:function(l){this.fire("save");this._commands[l].exec(this);this.fire("save")},getData:function(){if(x.HtmlDataProcessor)return x.HtmlDataProcessor.toHtml(this.document.body.innerHTML,"p");return this.document.body.innerHTML},setData:function(l){if(x.HtmlDataProcessor)l=x.HtmlDataProcessor.toDataFormat(l,"p");this.document.body.innerHTML=l},sync:function(){this.textarea.val(this.getData())},
_getRawData:function(){return this.document.body.innerHTML},_setRawData:function(l){this.document.body.innerHTML=l},_hideSource:function(){this.iframe.css("display","");this.textarea.css("display","none");this.toolBarDiv.children().css("visibility","");this.statusDiv.children().css("visibility","")},_showSource:function(){this.textarea.css("display","");this.iframe.css("display","none");this.toolBarDiv.children().css("visibility","hidden");this.toolBarDiv.all(".ke-tool-editor-source").css("visibility",
"");this.statusDiv.children().css("visibility","hidden");y.ie<8&&this.textarea.css("height",this.wrap.css("height"))},_prepareIFrameHtml:H,getSelection:function(){var l=new x.Selection(this.document);return!l||l.isInvalid?null:l},focus:function(){var l=E._4e_getWin(this.document);y.webkit&&l&&l.parent&&l.parent.focus();l&&l.focus();this.document&&this.document.body.focus();this.notifySelectionChange()},blur:function(){E._4e_getWin(this.document).blur();this.document&&this.document.body.blur()},_initIFrame:function(){function l(i){j(function(){e.designMode=
"on";setTimeout(function(){e.designMode="off";f.focus();if(!arguments.callee.retry)arguments.callee.retry=true},50)},function(){e.designMode="off";E.attr(f,"contentEditable",false);E.attr(f,"contentEditable",true);!i&&l(1)})}var r=this,v=r.iframe,a=r.textarea[0],c=H(),h=v[0].contentWindow,e=h.document;r.document=e;v.detach();e.open("text/html","replace");e.write(c);e.close();var f=e.body;if(y.ie){f.hideFocus=true;f.disabled=true;f.contentEditable=true;f.removeAttribute("disabled")}else setTimeout(function(){if(y.gecko||
y.opera)f.contentEditable=true;else if(y.webkit)f.parentNode.contentEditable=true;else e.designMode="on"},0);try{e.execCommand("enableObjectResizing",false,true)}catch(m){}try{e.execCommand("enableInlineTableEditing",false,true)}catch(b){}y.webkit&&D.on(e,"mousedown",function(i){i=new q(i.target);G.inArray(i._4e_name(),["img","hr","input","textarea","select"])&&r.getSelection().selectElement(i)});if(y.webkit){D.on(e,"click",function(i){var s=new q(i.target);G.inArray(s._4e_name(),["input","select"])&&
i.preventDefault()});D.on(e,"mouseup",function(i){var s=new q(i.target);G.inArray(s._4e_name(),["input","textarea"])&&i.preventDefault()})}if(y.gecko||y.ie||y.opera){var d;d=new q(E.insertAfter((new q('<span style="position:absolute; left:-10000"></span>'))[0],a));d.on("focus",function(){r.focus()});r.on("destroy",function(){})}if(y.ie&&e.compatMode=="CSS1Compat"||y.gecko||y.opera){var g=new q(e.documentElement);g.on("mousedown",function(i){if(i.target===g[0]){y.gecko&&l(false);d[0].focus()}})}D.on(h,
"focus",function(){if(y.gecko)l(false);else y.opera&&f.focus();r.notifySelectionChange()});y.gecko&&D.on(r.document,"mousedown",function(){r.iframeFocus||l(false)});if(y.ie){D.on(e,"keydown",function(i){if(i.keyCode in{8:1,46:1}){var s=r.getSelection(),J=s.getSelectedElement();if(J){r.fire("save");var O=s.getRanges()[0].createBookmark();J._4e_remove();s.selectBookmarks([O]);r.fire("save");i.preventDefault()}}});if(e.compatMode=="CSS1Compat"){var n={33:1,34:1};D.on(e,"keydown",function(i){i.keyCode in
n&&setTimeout(function(){r.getSelection().scrollIntoView()},0)})}}setTimeout(function(){y.ie&&setTimeout(function(){if(e){f.runtimeStyle.marginBottom="0px";f.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){r.fire("dataReady")},10);C.add(r)},addPlugin:function(l){this.ready?l():this.on("dataReady",l)},_monitor:function(){var l=this;l._monitorId&&clearTimeout(l._monitorId);l._monitorId=setTimeout(function(){var r=l.getSelection();if(r&&!r.isInvalid){r=r.getStartElement();var v=new x.ElementPath(r);
if(!l.previousPath||!l.previousPath.compare(v)){l.previousPath=v;l.fire("selectionChange",{selection:l,path:v,element:r})}}},200)},notifySelectionChange:function(){this.previousPath=null;this._monitor()},insertElement:function(l){var r=this;r.focus();var v=l._4e_name(),a=x.XHTML_DTD,c=x.RANGE,h=x.NODE,e=a.$block[v],f=r.getSelection(),m=f.getRanges(),b,d,g,n,i;r.fire("save");for(var s=m.length-1;s>=0;s--){b=m[s];b.deleteContents();d=!s&&l||l._4e_clone(true);if(e)for(;(n=b.getCommonAncestor(false,true))&&
(i=a[n._4e_name()])&&!(i&&i[v]);)if(n._4e_name()in a.span)b.splitElement(n);else if(b.checkStartOfBlock()&&b.checkEndOfBlock()){b.setStartBefore(n);b.collapse(true);n._4e_remove()}else b.splitBlock();b.insertNode(d);g||(g=d)}b.moveToPosition(g,c.POSITION_AFTER_END);(l=g._4e_nextSourceNode(true))&&l.type==h.NODE_ELEMENT&&b.moveToElementEditablePosition(l);f.selectRanges([b]);r.focus();d&&d._4e_scrollIntoView();setTimeout(function(){r.fire("save")},10)},insertHtml:function(l){if(x.HtmlDataProcessor)l=
x.HtmlDataProcessor.toDataFormat(l);if(y.webkit){l=E.create(l,null,this.document);l=l.nodeType==11?G.makeArray(l.childNodes):[l];for(var r=0;r<l.length;r++)this.insertElement(new q(l[r]))}else{var v=this;v.focus();v.fire("save");r=v.getSelection();if(y.ie){r=r.getNative();r.type=="Control"&&r.clear();r.createRange().pasteHTML(l)}else v.document.execCommand("inserthtml",false,l);v.focus();setTimeout(function(){v.fire("save")},10)}}})});
KISSY.Editor.add("dtd",function(x){x.XHTML_DTD=function(){var H=function(m){for(var b=arguments.length-1;b>0;)KISSY.mix(m,arguments[b--]);return m},G={isindex:1,fieldset:1},y={input:1,button:1,select:1,textarea:1,label:1},E=H({a:1},y),q=H({iframe:1},E),D={hr:1,ul:1,menu:1,div:1,blockquote:1,noscript:1,table:1,center:1,address:1,dir:1,pre:1,h5:1,dl:1,h4:1,noframes:1,h6:1,ol:1,h1:1,h3:1,h2:1},C={ins:1,del:1,script:1,style:1},j=H({b:1,acronym:1,bdo:1,"var":1,"#":1,abbr:1,code:1,br:1,i:1,cite:1,kbd:1,
u:1,strike:1,s:1,tt:1,strong:1,q:1,samp:1,em:1,dfn:1,span:1},C),o=H({sub:1,img:1,object:1,sup:1,basefont:1,map:1,applet:1,font:1,big:1,small:1},j),u=H({p:1},o);y=H({iframe:1},o,y);o={img:1,noscript:1,br:1,kbd:1,center:1,button:1,basefont:1,h5:1,h4:1,samp:1,h6:1,ol:1,h1:1,h3:1,h2:1,form:1,font:1,"#":1,select:1,menu:1,ins:1,abbr:1,label:1,code:1,table:1,script:1,cite:1,input:1,iframe:1,strong:1,textarea:1,noframes:1,big:1,small:1,span:1,hr:1,sub:1,bdo:1,"var":1,div:1,object:1,sup:1,strike:1,dir:1,map:1,
dl:1,applet:1,del:1,isindex:1,fieldset:1,ul:1,b:1,acronym:1,a:1,blockquote:1,i:1,u:1,s:1,tt:1,address:1,q:1,pre:1,p:1,em:1,dfn:1};var w=H({a:1},y),z={tr:1},l={"#":1},r=H({param:1},o),v=H({form:1},G,q,D,u),a={li:1},c={base:1,link:1,meta:1,title:1},h=H(c,{style:1,script:1}),e={head:1,body:1},f={address:1,blockquote:1,center:1,dir:1,div:1,dl:1,fieldset:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,isindex:1,menu:1,noframes:1,ol:1,p:1,pre:1,table:1,ul:1};return{$nonBodyContent:H({html:1},e,c),$block:f,
$blockLimit:{body:1,div:1,td:1,th:1,caption:1,form:1},$inline:w,$body:H({script:1,style:1},f),$cdata:{script:1,style:1},$empty:{area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},$listItem:{dd:1,dt:1,li:1},$list:{ul:1,ol:1,dl:1},$nonEditable:{applet:1,button:1,embed:1,iframe:1,map:1,object:1,option:1,script:1,textarea:1,param:1},$removeEmpty:{abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},$tabIndex:{a:1,area:1,button:1,input:1,object:1,select:1,textarea:1},$tableContent:{caption:1,col:1,colgroup:1,tbody:1,td:1,tfoot:1,th:1,thead:1,tr:1},html:e,head:h,style:l,body:v,base:{},link:{},meta:{},title:l,col:{},tr:{td:1,th:1},img:{},colgroup:{col:1},noscript:v,td:v,br:{},th:v,center:v,kbd:w,button:H(u,D),basefont:{},h5:w,h4:w,samp:w,h6:w,ol:a,h1:w,h3:w,option:l,h2:w,form:H(G,q,D,u),select:{optgroup:1,option:1},font:w,ins:w,menu:a,abbr:w,label:w,table:{thead:1,
col:1,tbody:1,tr:1,colgroup:1,caption:1,tfoot:1},code:w,script:l,tfoot:z,cite:w,li:v,input:{},iframe:v,strong:w,textarea:l,noframes:v,big:w,small:w,span:w,hr:{},dt:w,sub:w,optgroup:{option:1},param:{},bdo:w,"var":w,div:v,object:r,sup:w,dd:v,strike:w,area:{},dir:a,map:H({area:1,form:1,p:1},G,C,D),applet:r,dl:{dt:1,dd:1},del:w,isindex:{},fieldset:H({legend:1},o),thead:z,ul:a,acronym:w,b:w,a:y,blockquote:v,caption:w,i:w,u:w,tbody:z,s:w,address:H(q,u),tt:w,legend:w,q:w,pre:H(j,E),p:w,em:w,dfn:w}}()});
KISSY.Editor.add("dom",function(x){function H(a){return a.replace(/-(\w)/g,function(c,h){return h.toUpperCase()})}var G=KISSY,y=G.DOM,E=G.UA,q=G.Node,D=x.Utils,C={abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};x.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_DOCUMENT_FRAGMENT:11};x.POSITION={};var j=x.NODE,o=x.POSITION;o.POSITION_IDENTICAL=0;o.POSITION_DISCONNECTED=1;o.POSITION_FOLLOWING=
2;o.POSITION_PRECEDING=4;o.POSITION_IS_CONTAINED=8;o.POSITION_CONTAINS=16;var u={},w={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},z={hr:1},l=function(a){return a[0]||a},r=function(a){if(!a[0])return new q(a);return a},v={_4e_equals:function(a,c){if(!a&&!c)return true;if(!a||!c)return false;a=l(a);c=l(c);return a===c},_4e_isBlockBoundary:function(a,c){a=r(a);c=
G.mix(G.mix({},z),c||{});return w[a.css("display")]||c[a._4e_name()]},_4e_getWin:function(a){return a&&"scrollTo"in a&&a.document?a:a&&a.nodeType===9?a.defaultView||a.parentWindow:false},_4e_index:function(a){a=l(a);for(var c=a.parentNode.childNodes,h=0;h<c.length;h++)if(c[h]===a)return h;return-1},_4e_first:function(a,c){a=l(a);if((a=(a=a.firstChild)&&new q(a))&&c&&!c(a))a=a._4e_next(c);return a},_4e_move:function(a,c,h){a._4e_remove();a=l(a);c=l(c);h?c.insertBefore(a,c.firstChild):c.appendChild(a)},
_4e_name:function(a){a=l(a);var c=a.nodeName.toLowerCase();if(E.ie)if((a=a.scopeName)&&a!="HTML")c=a.toLowerCase()+":"+c;return c},_4e_isIdentical:function(a,c){if(a._4e_name()!=c._4e_name())return false;var h=a[0].attributes,e=c[0].attributes,f=h.length,m=e.length;if(!E.ie&&f!=m)return false;for(var b=0;b<f;b++){var d=h[b];if((!E.ie||d.specified&&d.nodeName!="_ke_expando")&&d.nodeValue!=c.attr(d.nodeName))return false}if(E.ie)for(b=0;b<m;b++){d=e[b];if(d.specified&&d.nodeName!="_ke_expando"&&d.nodeValue!=
a.attr(d.nodeName))return false}return true},_4e_isEmptyInlineRemoveable:function(a){a=l(a).childNodes;for(var c=0,h=a.length;c<h;c++){var e=a[c],f=e.nodeType;if(!(f==j.NODE_ELEMENT&&e.getAttribute("_ke_bookmark")))if(f==j.NODE_ELEMENT&&!v._4e_isEmptyInlineRemoveable(e)||f==j.NODE_TEXT&&G.trim(e.nodeValue))return false}return true},_4e_moveChildren:function(a,c,h){a=l(a);c=c[0]||c;if(a!=c)if(h)for(;h=a.lastChild;)c.insertBefore(a.removeChild(h),c.firstChild);else for(;h=a.firstChild;)c.appendChild(a.removeChild(h))},
_4e_mergeSiblings:function(){function a(c,h,e){if(h[0]&&h[0].nodeType==j.NODE_ELEMENT){for(var f=[];h.attr("_ke_bookmark")||h._4e_isEmptyInlineRemoveable();){f.push(h);h=e?new q(h[0].nextSibling):new q(h[0].previousSibling);if(!h[0]||h[0].nodeType!=j.NODE_ELEMENT)return}if(c._4e_isIdentical(h)){for(var m=e?c[0].lastChild:c[0].firstChild;f.length;)f.shift()._4e_move(c,!e);h._4e_moveChildren(c,!e);h._4e_remove();m[0]&&m[0].nodeType==j.NODE_ELEMENT&&m._4e_mergeSiblings()}}}return function(c){if(c[0])if(C[c._4e_name()]||
c._4e_name()=="a"){a(c,new q(c[0].nextSibling),true);a(c,new q(c[0].previousSibling))}}}(),_4e_unselectable:E.gecko?function(a){a=l(a);a.style.MozUserSelect="none"}:E.webkit?function(a){a=l(a);a.style.KhtmlUserSelect="none"}:function(a){a=l(a);if(E.ie||E.opera){var c,h=0;for(a.unselectable="on";c=a.all[h++];)switch(c.tagName.toLowerCase()){case "iframe":case "textarea":case "input":case "select":break;default:c.unselectable="on"}}},_4e_getOffset:function(a,c){a=l(a);var h,e=0;h=0;var f=a.ownerDocument.defaultView||
a.ownerDocument.parentWindow,m=a.ownerDocument,b=m.documentElement;if(a.getBoundingClientRect){if(a!==m.body&&b!==a){h=a.getBoundingClientRect();e=h.left+y.scrollLeft(f);h=h.top+y.scrollTop(f)}if(c)if(f!=(c.defaultView||c.parentWindow)&&f.frameElement){c=v._4e_getOffset(f.frameElement,c);e+=c.left;h+=c.top}}return{left:e,top:h}},_4e_getFrameDocument:function(a){return(a=l(a))&&a.contentWindow.document},_4e_splitText:function(a,c){a=l(a);var h=a.ownerDocument;if(!(!a||a.nodeType!=j.NODE_TEXT)){if(E.ie&&
c==a.nodeValue.length){h=h.createTextNode("");y.insertAfter(h,a);return h}a=new q(a.splitText(c));if(E.ie==8){h=h.createTextNode("");y.insertAfter(h,a[0]);h.parentNode.removeChild(h)}return a}},_4e_parents:function(a,c){a=r(a);var h=[];do h[c?"push":"unshift"](a);while(a=a.parent());return h},_4e_clone:function(a,c,h){a=l(a);a=a.cloneNode(c);if(!h){var e=function(f){if(f.nodeType==j.NODE_ELEMENT){f.removeAttribute("id",false);f.removeAttribute("_ke_expando",false);f=f.childNodes;for(var m=0;m<f.length;m++)e(f[m])}};
e(a)}return new q(a)},_4e_nextSourceNode:function(a,c,h,e){a=l(a);if(e&&!e.call){var f=e[0]||e;e=function(b){b=b[0]||b;return b!==f}}c=!c&&a.firstChild;var m=new q(a);if(!c){if(a.nodeType==j.NODE_ELEMENT&&e&&e(this,true)===false)return null;c=a.nextSibling}for(;!c&&(m=m.parent());){if(e&&e(m,true)===false)return null;c=m[0].nextSibling}if(!c)return null;c=new q(c);if(e&&e(c)===false)return null;if(h&&h!=c[0].nodeType)return c._4e_nextSourceNode(false,h,e);return c},_4e_previousSourceNode:function(a,
c,h,e){a=l(a);if(e&&!e.call){var f=e[0]||e;e=function(b){b=b[0]||b;return b!==f}}c=!c&&a.lastChild;var m=new q(a);if(!c){if(a.nodeType==j.NODE_ELEMENT&&e&&e(a,true)===false)return null;c=a.previousSibling}for(;!c&&(m=m.parent());){if(e&&e(m,true)===false)return null;c=m[0].previousSibling}if(!c)return null;c=new q(c);if(e&&e(c)===false)return null;if(h&&c[0].nodeType!=h)return c._4e_previousSourceNode(false,h,e);return c},_4e_contains:E.ie||E.webkit?function(a,c){a=l(a);c=l(c);return c.nodeType!=
j.NODE_ELEMENT?a.contains(c.parentNode):a!=c&&a.contains(c)}:function(a,c){a=l(a);c=l(c);return!!(a.compareDocumentPosition(c)&16)},_4e_commonAncestor:function(a,c){if(a._4e_equals(c))return a;if(c[0].nodeType!=j.NODE_TEXT&&c._4e_contains(a))return c;a=a[0].nodeType==j.NODE_TEXT?a.parent():a;do if(a[0].nodeType!=j.NODE_TEXT&&a._4e_contains(c))return a;while(a=a.parent());return null},_4e_ascendant:function(a,c,h){a=l(a);if(!h)a=a.parentNode;if(c&&!G.isFunction(c)){var e=c;c=function(f){return f._4e_name()==
e}}for(;a&&a.nodeType!=9;){if(!c||c(new q(a))===true)return new q(a);a=a.parentNode}return null},_4e_hasAttribute:function(a,c){a=l(a);a=a.attributes.getNamedItem(c);return!!(a&&a.specified)},_4e_hasAttributes:E.ie?function(a){a=l(a);for(var c=a.attributes,h=0;h<c.length;h++){var e=c[h];switch(e.nodeName){case "class":if(a.getAttribute("class"))return true;break;case "_ke_expando":continue;default:if(e.specified)return true}}return false}:function(a){a=l(a);E.gecko&&a.removeAttribute("_moz_dirty");
a=a.attributes;return a.length>1||a.length==1&&a[0].nodeName!="_ke_expando"},_4e_position:function(a,c){var h=l(a),e=l(c);if(h.compareDocumentPosition)return h.compareDocumentPosition(e);if(h==e)return o.POSITION_IDENTICAL;if(h.nodeType==j.NODE_ELEMENT&&e.nodeType==j.NODE_ELEMENT){if(h.contains){if(h.contains(e))return o.POSITION_CONTAINS+o.POSITION_PRECEDING;if(e.contains(h))return o.POSITION_IS_CONTAINED+o.POSITION_FOLLOWING}if("sourceIndex"in h)return h.sourceIndex<0||e.sourceIndex<0?o.POSITION_DISCONNECTED:
h.sourceIndex<e.sourceIndex?o.POSITION_PRECEDING:o.POSITION_FOLLOWING}a=a._4e_address();c=c._4e_address();h=Math.min(a.length,c.length);for(e=0;e<=h-1;e++)if(a[e]!=c[e]){if(e<h)return a[e]<c[e]?o.POSITION_PRECEDING:o.POSITION_FOLLOWING;break}return a.length<c.length?o.POSITION_CONTAINS+o.POSITION_PRECEDING:o.POSITION_IS_CONTAINED+o.POSITION_FOLLOWING},_4e_address:function(a,c){a=l(a);var h=[],e=a.ownerDocument.documentElement;for(a=a;a&&a!=e;){var f=a.parentNode,m=-1;if(f){for(var b=0;b<f.childNodes.length;b++){var d=
f.childNodes[b];if(!(c&&d.nodeType==3&&d.previousSibling&&d.previousSibling.nodeType==3)){m++;if(d==a)break}}h.unshift(m)}a=f}return h},_4e_breakParent:function(a,c){var h=new x.Range(a[0].ownerDocument);h.setStartAfter(a);h.setEndAfter(c);c=h.extractContents();h.insertNode(a._4e_remove());a[0].parentNode.insertBefore(c,a[0].nextSibling)},_4e_style:function(a,c,h){if(h!==undefined)return a.css(c,h);a=a[0]||a;return a.style[H(c)]},_4e_remove:function(a,c){var h=l(a),e=h.parentNode;if(e){if(c)for(;c=
h.firstChild;)e.insertBefore(h.removeChild(c),h);e.removeChild(h)}return a},_4e_trim:function(a){y._4e_ltrim(a);y._4e_rtrim(a)},_4e_ltrim:function(a){a=l(a);for(var c;c=a.firstChild;){if(c.nodeType==j.NODE_TEXT){var h=D.ltrim(c.nodeValue),e=c.nodeValue.length;if(h){if(h.length<e){(new q(c))._4e_splitText(e-h.length);a.removeChild(a.firstChild)}}else{a.removeChild(c);continue}}break}},_4e_rtrim:function(a){a=l(a);for(var c;c=a.lastChild;){if(c.type==j.NODE_TEXT){var h=D.rtrim(c.nodeValue),e=c.nodeValue.length;
if(h){if(h.length<e){(new q(c))._4e_splitText(h.length);a.removeChild(a.lastChild)}}else{a.removeChild(c);continue}}break}if(!E.ie&&!E.opera)(c=a.lastChild)&&c.nodeType==1&&c.nodeName.toLowerCase()=="br"&&c.parentNode.removeChild(c)},_4e_appendBogus:function(a){a=l(a);for(var c=a.lastChild;c&&c.nodeType==j.NODE_TEXT&&!G.trim(c.nodeValue);)c=c.previousSibling;if(!c||c.nodeType==j.NODE_TEXT||y._4e_name(c)!=="br"){c=E.opera?a.ownerDocument.createTextNode(""):a.ownerDocument.createElement("br");E.gecko&&
c.setAttribute("type","_moz");a.appendChild(c)}},_4e_previous:function(a,c){a=l(a);var h;do h=(a=a.previousSibling)&&new q(a);while(h&&c&&!c(h));return h},_4e_last:function(a,c){if((a=(a=a[0].lastChild)&&new q(a))&&c&&!c(a))a=a._4e_previous(c);return a},_4e_next:function(a,c){a=l(a);var h;do h=(a=a.nextSibling)&&new q(a);while(h&&c&&!c(h));return h},_4e_outerHtml:function(a){a=l(a);if(a.outerHTML)return a.outerHTML.replace(/<\?[^>]*>/,"");var c=a.ownerDocument.createElement("div");c.appendChild(a.cloneNode(true));
return c.innerHTML},_4e_setMarker:function(a,c,h,e){a[0]||(a=new q(a));var f=a._4e_getData("list_marker_id")||a._4e_setData("list_marker_id",G.guid())._4e_getData("list_marker_id"),m=a._4e_getData("list_marker_names")||a._4e_setData("list_marker_names",{})._4e_getData("list_marker_names");c[f]=a;m[h]=1;return a._4e_setData(h,e)},_4e_clearMarkers:function(a,c,h){a=r(a);var e=a._4e_getData("list_marker_names"),f=a._4e_getData("list_marker_id");for(var m in e)a._4e_removeData(m);a._4e_removeData("list_marker_names");
if(h){a._4e_removeData("list_marker_id");delete c[f]}},_4e_setData:function(a,c,h){var e=y._4e_getUniqueId(a);(u[e]||(u[e]={}))[c]=h;return a},_4e_getData:function(a,c){a=l(a);return(a=(a=a.getAttribute("_ke_expando"))&&u[a])&&a[c]},_4e_removeData:function(a,c){a=l(a);var h=a.getAttribute("_ke_expando");var e=(h=h&&u[h])&&h[c];typeof e!="undefined"&&h&&delete h[c];G.isEmptyObject(h)&&y._4e_clearData(a);return e||null},_4e_clearData:function(a){a=l(a);var c=a.getAttribute("_ke_expando");c&&delete u[c];
c&&a.removeAttribute("_ke_expando")},_4e_getUniqueId:function(a){a=l(a);var c=a.getAttribute("_ke_expando");if(c)return c;c=G.guid();a.setAttribute("_ke_expando",c);return c},_4e_copyAttributes:function(a,c,h){a=l(a);var e=a.attributes;h=h||{};for(var f=0;f<e.length;f++){var m=e[f],b=m.nodeName.toLowerCase(),d;if(!(b in h))if(b=="checked"&&(d=y.attr(a,b)))c.attr(b,d);else if(m.specified||E.ie&&m.nodeValue&&b=="value"){d=y.attr(a,b);if(d===null)d=m.nodeValue;c.attr(b,d)}}if(a.style.cssText!=="")c[0].style.cssText=
a.style.cssText},_4e_isEditable:function(a){a=y._4e_name(a);var c=x.XHTML_DTD;return(a=!c.$nonEditable[a]&&(c[a]||c.span))&&a["#"]},_4e_scrollIntoView:function(a){a=r(a);var c=a[0].ownerDocument,h=y.scrollLeft(c),e=y.scrollTop(c),f=a.offset(),m=f.left;f=f.top;if(y.viewportHeight(c)+e<f||f<e||y.viewportWidth(c)+h<m||m<h)a.scrollIntoView(c)},_4e_getElementsByTagName:function(a,c,h){a=l(a);if(!E.ie&&h)c=h+":"+c;h=[];a=a.getElementsByTagName(c);for(c=0;c<a.length;c++)h.push(new q(a[c]));return h}};G.DOM._4e_inject=
function(a){G.mix(y,a);for(var c in a)a.hasOwnProperty(c)&&function(h){q.prototype[h]=function(){var e=[].slice.call(arguments,0);e.unshift(this);return a[h].apply(null,e)}}(c)};G.DOM._4e_inject(v)});
KISSY.Editor.add("elementpath",function(x){function H(u){var w=null,z=null,l=[];for(u=u;u&&u[0];){if(u[0].nodeType==q.NODE_ELEMENT){if(!this.lastElement)this.lastElement=u;var r=u._4e_name();if(D.ie&&u[0].scopeName!="HTML")r=u[0].scopeName.toLowerCase()+":"+r;if(!z){if(!w&&C[r])w=u;if(j[r])if(!w&&r=="div"&&!o(u))w=u;else z=u}l.push(u);if(r=="body")break}u=u.parent()}this.block=w;this.blockLimit=z;this.elements=l}var G=KISSY,y=G.DOM,E=x.XHTML_DTD,q=x.NODE,D=G.UA,C={address:1,blockquote:1,dl:1,h1:1,
h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},j={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1},o=function(u){u=u[0]||u;u=u.childNodes;for(var w=0,z=u.length;w<z;w++){var l=u[w];if(l.nodeType==q.NODE_ELEMENT&&E.$block[l.nodeName.toLowerCase()])return true}return false};H.prototype={compare:function(u){var w=this.elements;u=u&&u.elements;if(!u||w.length!=u.length)return false;for(var z=0;z<w.length;z++)if(!y._4e_equals(w[z],u[z]))return false;return true},contains:function(u){for(var w=
this.elements,z=0;z<w.length;z++)if(w[z]._4e_name()in u)return w[z];return null}};x.ElementPath=H});
KISSY.Editor.add("walker",function(x){function H(j,o){if(this._.end)return null;var u=this.range,w,z=this.guard,l=this.type,r=j?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start){this._.start=1;u.trim();if(u.collapsed){this.end();return null}}if(!j&&!this._.guardLTR){var v=u.endContainer,a=new C(v[0].childNodes[u.endOffset]);this._.guardLTR=function(f,m){return(!m||!D._4e_equals(v,f))&&(!a[0]||f[0]!==a[0])&&(f[0].nodeType!=q.NODE_ELEMENT||!m||f._4e_name()!="body")}}if(j&&!this._.guardRTL){var c=
u.startContainer,h=u.startOffset>0&&new C(c[0].childNodes[u.startOffset-1]);this._.guardRTL=function(f,m){return f&&f[0]&&(!m||c[0]!==f[0])&&(!h[0]||f[0]!==h[0])&&(f[0].nodeType!=q.NODE_ELEMENT||!m||f._4e_name()!="body")}}var e=j?this._.guardRTL:this._.guardLTR;w=z?function(f,m){if(e(f,m)===false)return false;return z(f,m)}:e;if(this.current)j=this.current[r](false,l,w);else if(j){j=u.endContainer;if(u.endOffset>0){j=new C(j[0].childNodes[u.endOffset-1]);if(w(j)===false)j=null}else j=w(j,true)===
false?null:j._4e_previousSourceNode(true,l,w)}else{j=u.startContainer;if((j=new C(j[0].childNodes[u.startOffset]))&&j[0]){if(w(j)===false)j=null}else j=w(u.startContainer,true)===false?null:u.startContainer._4e_nextSourceNode(true,l,w)}for(;j&&j[0]&&!this._.end;){this.current=j;if(!this.evaluator||this.evaluator(j)!==false){if(!o)return j}else if(o&&this.evaluator)return false;j=j[r](false,l,w)}this.end();return this.current=null}function G(j){for(var o,u=null;o=H.call(this,j);)u=o;return u}function y(j){this.range=
j;this._={}}var E=KISSY,q=x.NODE,D=E.DOM,C=E.Node;E.augment(y,{end:function(){this._.end=1},next:function(){return H.call(this)},previous:function(){return H.call(this,true)},checkForward:function(){return H.call(this,false,true)!==false},checkBackward:function(){return H.call(this,true,true)!==false},lastForward:function(){return G.call(this)},lastBackward:function(){return G.call(this,true)},reset:function(){delete this.current;this._={}}});y.blockBoundary=function(j){return function(o){o[0]||(o=
new C(o));return!(o[0].nodeType==q.NODE_ELEMENT&&o._4e_isBlockBoundary(j))}};y.listItemBoundary=function(){return this.blockBoundary({br:1})};y.bookmark=function(j,o){function u(w){return w&&w[0]&&w._4e_name()=="span"&&w.attr("_ke_bookmark")}return function(w){var z,l;z=w&&w[0]&&w[0].nodeType==q.NODE_TEXT&&(l=w.parent())&&u(l);z=j?z:z||u(w);return o^z}};y.whitespaces=function(j){return function(o){o=(o=o[0]||o)&&o.nodeType==q.NODE_TEXT&&!E.trim(o.nodeValue);return j^o}};y.invisible=function(j){var o=
y.whitespaces();return function(u){u=o(u)||u[0].nodeType==q.NODE_ELEMENT&&!u[0].offsetHeight;return j^u}};x.Walker=y});
KISSY.Editor.add("range",function(x){function H(b){this.endOffset=this.endContainer=this.startOffset=this.startContainer=null;this.collapsed=true;this.document=b}function G(b){var d=b[0].nodeType!=j.NODE_TEXT&&b._4e_name()in v.$removeEmpty,g=!C.trim(b[0].nodeValue);b=!!b.parent().attr("_ke_bookmark");return d||g||b}function y(b){return!f(b)&&!m(b)}function E(b){var d=false,g=w.bookmark(true);return function(n){if(g(n))return true;if(n[0].nodeType==j.NODE_TEXT){if(C.trim(n[0].nodeValue).length)return false}else if(n[0].nodeType==
j.NODE_ELEMENT)if(!e[n._4e_name()])if(!b&&!r.ie&&n._4e_name()=="br"&&!d)d=true;else return false;return true}}function q(b,d){function g(n){return n&&n.nodeName=="span"&&n.getAttribute("_ke_bookmark")}return function(n){var i,s;i=n&&!n.nodeName&&(s=n.parentNode)&&g(s);i=b?i:i||g(n);return d^i}}function D(b){return function(d){d=(d=d[0]||d)&&d.nodeType==j.NODE_TEXT&&!C.trim(d.nodeValue);return b^d}}x.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,
ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,STARTEND:3,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var C=KISSY,j=x.NODE,o=x.RANGE,u=x.POSITION,w=x.Walker,z=C.DOM,l=x.Utils.getByAddress,r=C.UA,v=x.XHTML_DTD,a=x.ElementPath,c=C.Node,h={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1};H.prototype.toString=function(){var b=[];b.push((this.startContainer[0].id||this.startContainer[0].nodeName)+":"+this.startOffset);b.push((this.endContainer[0].id||this.endContainer[0].nodeName)+
":"+this.endOffset);return b.join("<br/>")};C.augment(H,{updateCollapsed:function(){this.collapsed=this.startContainer&&this.endContainer&&z._4e_equals(this.startContainer,this.endContainer)&&this.startOffset==this.endOffset},optimize:function(){var b=this.startContainer,d=this.startOffset;if(b[0].nodeType!=j.NODE_ELEMENT)if(d)d>=b[0].nodeValue.length&&this.setStartAfter(b);else this.setStartBefore(b);b=this.endContainer;d=this.endOffset;if(b[0].nodeType!=j.NODE_ELEMENT)if(d)d>=b[0].nodeValue.length&&
this.setEndAfter(b);else this.setEndBefore(b)},setStartAfter:function(b){this.setStart(b.parent(),b._4e_index()+1)},setStartBefore:function(b){this.setStart(b.parent(),b._4e_index())},setEndAfter:function(b){this.setEnd(b.parent(),b._4e_index()+1)},setEndBefore:function(b){this.setEnd(b.parent(),b._4e_index())},optimizeBookmark:function(){var b=this.startContainer,d=this.endContainer;b&&b._4e_name()=="span"&&b.attr("_ke_bookmark")&&this.setStartAt(b,o.POSITION_BEFORE_START);d&&d._4e_name()=="span"&&
d.attr("_ke_bookmark")&&this.setEndAt(d,o.POSITION_AFTER_END)},setStart:function(b,d){if(b[0].nodeType==j.NODE_ELEMENT&&h[b._4e_name()]){b=b.parent();d=b._4e_index()}this.startContainer=b;this.startOffset=d;if(!this.endContainer){this.endContainer=b;this.endOffset=d}this.updateCollapsed()},setEnd:function(b,d){if(b[0].nodeType==j.NODE_ELEMENT&&h[b._4e_name()]){b=b.parent();d=b._4e_index()+1}this.endContainer=b;this.endOffset=d;if(!this.startContainer){this.startContainer=b;this.startOffset=d}this.updateCollapsed()},
setStartAt:function(b,d){switch(d){case o.POSITION_AFTER_START:this.setStart(b,0);break;case o.POSITION_BEFORE_END:b[0].nodeType==j.NODE_TEXT?this.setStart(b,b[0].nodeValue.length):this.setStart(b,b[0].childNodes.length);break;case o.POSITION_BEFORE_START:this.setStartBefore(b);break;case o.POSITION_AFTER_END:this.setStartAfter(b)}this.updateCollapsed()},setEndAt:function(b,d){switch(d){case o.POSITION_AFTER_START:this.setEnd(b,0);break;case o.POSITION_BEFORE_END:b[0].nodeType==j.NODE_TEXT?this.setEnd(b,
b[0].nodeValue.length):this.setEnd(b,b[0].childNodes.length);break;case o.POSITION_BEFORE_START:this.setEndBefore(b);break;case o.POSITION_AFTER_END:this.setEndAfter(b)}this.updateCollapsed()},execContentsAction:function(b,d){var g=this.startContainer,n=this.endContainer,i=this.startOffset,s=this.endOffset,J,O;this.optimizeBookmark();if(n[0].nodeType==j.NODE_TEXT)n=n._4e_splitText(s);else if(n[0].childNodes.length>0)if(s>=n[0].childNodes.length){n=new c(n[0].appendChild(this.document.createTextNode("")));
O=true}else n=new c(n[0].childNodes[s]);if(g[0].nodeType==j.NODE_TEXT){g._4e_splitText(i);if(z._4e_equals(g,n))n=new c(g[0].nextSibling)}else if(i)if(i>=g[0].childNodes.length){J=new c(this.document.createTextNode(""));g[0].appendChild(J[0]);g=J;J=true}else g=new c(g[0].childNodes[i].previousSibling);else{J=new c(this.document.createTextNode(""));z.insertBefore(J[0],g[0].firstChild);g=J;J=true}i=g._4e_parents();s=n._4e_parents();var F,I,L;for(F=0;F<i.length;F++){I=i[F];L=s[F];if(I[0]!==L[0])break}for(var P=
d,N,S,Y,Z=F;Z<i.length;Z++){N=i[Z];if(P&&N[0]!==g[0])S=P.appendChild(N._4e_clone()[0]);for(N=N[0].nextSibling;N;){if(s[Z]&&N==s[Z][0]||N==n[0])break;Y=N.nextSibling;if(b==2)P.appendChild(N.cloneNode(true));else{N.parentNode.removeChild(N);b==1&&P.appendChild(N)}N=Y}if(S)P=S}P=d;for(d=F;d<s.length;d++){N=s[d];if(b>0&&N[0]!==n[0])S=P.appendChild(N._4e_clone()[0]);if(!i[d]||N[0].parentNode!==i[d][0].parentNode)for(N=N[0].previousSibling;N;){if(i[d]&&N==i[d][0]||N===g[0])break;Y=N.previousSibling;if(b==
2)P.insertBefore(N.cloneNode(true),P.firstChild);else{N.parentNode.removeChild(N);b==1&&P.insertBefore(N,P.firstChild)}N=Y}if(S)P=S}if(b==2){L=this.startContainer[0];if(L.nodeType==j.NODE_TEXT&&L.nextSibling&&L.nextSibling.nodeType==j.NODE_TEXT){L.data+=L.nextSibling.data;L.parentNode.removeChild(L.nextSibling)}L=this.endContainer[0];if(L.nodeType==j.NODE_TEXT&&L.nextSibling&&L.nextSibling.nodeType==j.NODE_TEXT){L.data+=L.nextSibling.data;L.parentNode.removeChild(L.nextSibling)}}else{if(I&&L&&(g[0].parentNode!=
I[0].parentNode||n[0].parentNode!=L[0].parentNode)){b=L._4e_index();J&&L[0].parentNode==g[0].parentNode&&b--;this.setStart(L.parent(),b)}this.collapse(true)}J&&g._4e_remove();O&&n[0].parentNode&&n._4e_remove()},collapse:function(b){if(b){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=this.endOffset}this.collapsed=true},clone:function(){var b=new H(this.document);b.startContainer=this.startContainer;b.startOffset=this.startOffset;
b.endContainer=this.endContainer;b.endOffset=this.endOffset;b.collapsed=this.collapsed;return b},getEnclosedNode:function(){var b=this.clone();b.optimize();if(b.startContainer[0].nodeType!=j.NODE_ELEMENT||b.endContainer[0].nodeType!=j.NODE_ELEMENT)return null;b=b.startContainer[0].childNodes[b.startOffset];for(var d=q(true,undefined),g=D(true),n=function(i){return g(i)&&d(i)};b&&n(b);)b=(new c(b))._4e_nextSourceNode()[0];return new c(b)},shrink:function(b,d){if(!this.collapsed){b=b||o.SHRINK_TEXT;
var g=this.clone(),n=this.startContainer,i=this.endContainer,s=this.startOffset,J=this.endOffset,O=1,F=1;if(n&&n[0].nodeType==j.NODE_TEXT)if(s)if(s>=n[0].nodeValue.length)g.setStartAfter(n);else{g.setStartBefore(n);O=0}else g.setStartBefore(n);if(i&&i[0].nodeType==j.NODE_TEXT)if(J)if(J>=i[0].nodeValue.length)g.setEndAfter(i);else{g.setEndAfter(i);F=0}else g.setEndBefore(i);g=new w(g);g.evaluator=function(L){L=L[0]||L;return L.nodeType==(b==o.SHRINK_ELEMENT?j.NODE_ELEMENT:j.NODE_TEXT)};var I;g.guard=
function(L,P){L=L[0]||L;if(b==o.SHRINK_ELEMENT&&L.nodeType==j.NODE_TEXT)return false;if(P&&L==I)return false;if(!P&&L.nodeType==j.NODE_ELEMENT)I=L;return true};if(O)(n=g[b==o.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(n,d?o.POSITION_AFTER_START:o.POSITION_BEFORE_START);if(F){g.reset();(g=g[b==o.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(g,d?o.POSITION_BEFORE_END:o.POSITION_AFTER_END)}return!!(O||F)}},getTouchedStartNode:function(){var b=this.startContainer;if(this.collapsed||
b[0].nodeType!=j.NODE_ELEMENT)return b;return b.childNodes[this.startOffset]||b},createBookmark2:function(b){var d=this.startContainer,g=this.endContainer,n=this.startOffset,i=this.endOffset,s,J;if(!d||!g)return{start:0,end:0};if(b){if(d[0].nodeType==j.NODE_ELEMENT)if((s=new c(d[0].childNodes[n]))&&s[0]&&s[0].nodeType==j.NODE_TEXT&&n>0&&s[0].previousSibling.nodeType==j.NODE_TEXT){d=s;n=0}for(;d[0].nodeType==j.NODE_TEXT&&(J=d._4e_previous())&&J[0].nodeType==j.NODE_TEXT;){d=J;n+=J[0].nodeValue.length}if(!this.collapsed){if(g[0].nodeType==
j.NODE_ELEMENT)if((s=new c(g[0].childNodes[i]))&&s[0]&&s[0].nodeType==j.NODE_TEXT&&i>0&&s[0].previousSibling.nodeType==j.NODE_TEXT){g=s;i=0}for(;g[0].nodeType==j.NODE_TEXT&&(J=g._4e_previous())&&J[0].nodeType==j.NODE_TEXT;){g=J;i+=J[0].nodeValue.length}}}return{start:d._4e_address(b),end:this.collapsed?null:g._4e_address(b),startOffset:n,endOffset:i,normalized:b,is2:true}},createBookmark:function(b){var d,g,n,i;d=new c("<span></span>",null,this.document);d.attr("_ke_bookmark",1);d.css("display","none");
d.html("&nbsp;");if(b){n=C.guid("ke_bm_");d.attr("id",n+"S")}if(!this.collapsed){g=d._4e_clone();g.html("&nbsp;");b&&g.attr("id",n+"E");i=this.clone();i.collapse();i.insertNode(g)}i=this.clone();i.collapse(true);i.insertNode(d);if(g){this.setStartAfter(d);this.setEndBefore(g)}else this.moveToPosition(d,o.POSITION_AFTER_END);return{startNode:b?n+"S":d,endNode:b?n+"E":g,serializable:b}},moveToPosition:function(b,d){this.setStartAt(b,d);this.collapse(true)},trim:function(b,d){var g=this.startContainer,
n=this.startOffset,i=this.collapsed;if((!b||i)&&g[0]&&g[0].nodeType==j.NODE_TEXT){if(n)if(n>=g[0].nodeValue.length){n=g._4e_index()+1;g=g.parent()}else{b=g._4e_splitText(n);n=g._4e_index()+1;g=g.parent();if(z._4e_equals(this.startContainer,this.endContainer))this.setEnd(b,this.endOffset-this.startOffset);else if(z._4e_equals(g,this.endContainer))this.endOffset+=1}else{n=g._4e_index();g=g.parent()}this.setStart(g,n);if(i){this.collapse(true);return}}g=this.endContainer;n=this.endOffset;if(!(d||i)&&
g[0]&&g[0].nodeType==j.NODE_TEXT){if(n){n>=g.nodeValue.length||g._4e_splitText(n);n=g._4e_index()+1}else n=g._4e_index();g=g.parent();this.setEnd(g,n)}},insertNode:function(b){this.optimizeBookmark();this.trim(false,true);var d=this.startContainer,g=d[0].childNodes[this.startOffset];this.optimizeBookmark();this.trim(false,true);g?z.insertBefore(b[0]||b,g):d[0].appendChild(b[0]||b);z._4e_equals(b.parent(),this.endContainer)&&this.endOffset++;this.setStartBefore(b)},moveToBookmark:function(b){if(b.is2){var d=
l(this.document,b.start,b.normalized),g=b.startOffset,n=b.end&&l(this.document,b.end,b.normalized);b=b.endOffset;this.setStart(d,g);n?this.setEnd(n,b):this.collapse(true)}else{d=(g=b.serializable)?C.one("#"+b.startNode,this.document):b.startNode;b=g?C.one("#"+b.endNode,this.document):b.endNode;this.setStartBefore(d);d._4e_remove();if(b&&b[0]){this.setEndBefore(b);b._4e_remove()}else this.collapse(true)}},getCommonAncestor:function(b,d){var g=this.startContainer,n=this.endContainer;b=z._4e_equals(g,
n)?b&&g[0].nodeType==j.NODE_ELEMENT&&this.startOffset==this.endOffset-1?new c(g[0].childNodes[this.startOffset]):g:g._4e_commonAncestor(n);return d&&b[0].nodeType==j.NODE_TEXT?b.parent():b},enlarge:function(b){switch(b){case o.ENLARGE_ELEMENT:if(this.collapsed)return;b=this.getCommonAncestor();var d=new c(this.document.body),g,n,i,s,J,O=false,F,I;F=this.startContainer;I=this.startOffset;if(F[0].nodeType==j.NODE_TEXT){if(I){F=!C.trim(F[0].nodeValue.substring(0,I)).length&&F;O=!!F}if(F)if(!(s=F[0].previousSibling))i=
F.parent()}else{if(I)s=F[0].childNodes[I-1]||F[0].lastChild;s||(i=F)}for(;i||s;){if(i&&!s){if(!J&&z._4e_equals(i,b))J=true;if(!d._4e_contains(i))break;if(!O||i.css("display")!="inline"){O=false;if(J)g=i;else this.setStartBefore(i)}s=i[0].previousSibling}for(;s;){F=false;if(s.nodeType==j.NODE_TEXT){I=s.nodeValue;if(/[^\s\ufeff]/.test(I))s=null;F=/[\s\ufeff]$/.test(I)}else if(s.offsetWidth>0&&!s.getAttribute("_ke_bookmark"))if(O&&v.$removeEmpty[s.nodeName.toLowerCase()]){I=z.text(s);if(/[^\s\ufeff]/.test(I))s=
null;else for(var L=s.all||s.getElementsByTagName("*"),P=0,N;N=L[P++];)if(!v.$removeEmpty[N.nodeName.toLowerCase()]){s=null;break}if(s)F=!!I.length}else s=null;if(F)if(O)if(J)g=i;else i&&this.setStartBefore(i);else O=true;if(s){F=s.previousSibling;if(!i&&!F){i=new c(s);s=null;break}s=F}else i=null}if(i)i=i.parent()}F=this.endContainer;I=this.endOffset;i=s=null;J=O=false;if(F[0].nodeType==j.NODE_TEXT){F=!C.trim(F[0].nodeValue.substring(I)).length&&F;O=!(F&&F[0].nodeValue.length);if(F)if(!(s=F[0].nextSibling))i=
F.parent()}else(s=F[0].childNodes[I])||(i=F);for(;i||s;){if(i&&!s){if(!J&&z._4e_equals(i,b))J=true;if(!d._4e_contains(i))break;if(!O||i.css("display")!="inline"){O=false;if(J)n=i;else i&&this.setEndAfter(i)}s=i[0].nextSibling}for(;s;){F=false;if(s.nodeType==j.NODE_TEXT){I=s.nodeValue;if(/[^\s\ufeff]/.test(I))s=null;F=/^[\s\ufeff]/.test(I)}else if(s.offsetWidth>0&&!s.getAttribute("_ke_bookmark"))if(O&&v.$removeEmpty[s.nodeName.toLowerCase()]){I=z.text(s);if(/[^\s\ufeff]/.test(I))s=null;else{L=s.all||
s.getElementsByTagName("*");for(P=0;N=L[P++];)if(!v.$removeEmpty[N.nodeName.toLowerCase()]){s=null;break}}if(s)F=!!I.length}else s=null;if(F)if(O)if(J)n=i;else this.setEndAfter(i);if(s){F=s.nextSibling;if(!i&&!F){i=new c(s);s=null;break}s=F}else i=null}if(i)i=i.parent()}if(g&&n){b=g._4e_contains(n)?n:g;this.setStartBefore(b);this.setEndAfter(b)}break;case o.ENLARGE_BLOCK_CONTENTS:case o.ENLARGE_LIST_ITEM_CONTENTS:i=new H(this.document);d=new c(this.document.body);i.setStartAt(d,o.POSITION_AFTER_START);
i.setEnd(this.startContainer,this.startOffset);i=new w(i);var S,Y,Z=w.blockBoundary(b==o.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:null),ca=function($){var k=Z($);k||(S=$);return k};g=function($){var k=ca($);if(!k&&$[0]&&$._4e_name()=="br")Y=$;return k};i.guard=ca;i=i.lastBackward();S=S||d;this.setStartAt(S,S._4e_name()!="br"&&(!i&&this.checkStartOfBlock()||i&&S._4e_contains(i))?o.POSITION_AFTER_START:o.POSITION_AFTER_END);i=this.clone();i.collapse();i.setEndAt(d,o.POSITION_BEFORE_END);i=new w(i);i.guard=
b==o.ENLARGE_LIST_ITEM_CONTENTS?g:ca;S=null;i=i.lastForward();S=S||d;this.setEndAt(S,!i&&this.checkEndOfBlock()||i&&S._4e_contains(i)?o.POSITION_BEFORE_END:o.POSITION_BEFORE_START);Y&&this.setEndAfter(Y)}},checkStartOfBlock:function(){var b=this.startContainer,d=this.startOffset;if(d&&b[0].nodeType==j.NODE_TEXT)if(C.trim(b[0].nodeValue.substring(0,d)).length)return false;this.trim();b=new a(this.startContainer);d=this.clone();d.collapse(true);d.setStartAt(b.block||b.blockLimit,o.POSITION_AFTER_START);
b=new w(d);b.evaluator=E(true);return b.checkBackward()},checkEndOfBlock:function(){var b=this.endContainer,d=this.endOffset;if(b[0].nodeType==j.NODE_TEXT)if(C.trim(b[0].nodeValue.substring(d)).length)return false;this.trim();b=new a(this.endContainer);d=this.clone();d.collapse(false);d.setEndAt(b.block||b.blockLimit,o.POSITION_BEFORE_END);b=new w(d);b.evaluator=E(false);return b.checkForward()},deleteContents:function(){this.collapsed||this.execContentsAction(0)},extractContents:function(){var b=
this.document.createDocumentFragment();this.collapsed||this.execContentsAction(1,b);return b},checkBoundaryOfElement:function(b,d){var g=this.clone();g[d==o.START?"setStartAt":"setEndAt"](b,d==o.START?o.POSITION_AFTER_START:o.POSITION_BEFORE_END);b=new w(g);b.evaluator=G;return b[d==o.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var b=this.startContainer,d=this.endContainer,g=this.startOffset,n=this.endOffset,i;if(b[0].nodeType==j.NODE_ELEMENT){i=b[0].childNodes.length;if(i>
g)b=new c(b[0].childNodes[g]);else if(i<1)b=b._4e_previousSourceNode();else{for(b=b[0];b.lastChild;)b=b.lastChild;b=new c(b);b=b._4e_nextSourceNode()||b}}if(d[0].nodeType==j.NODE_ELEMENT){i=d[0].childNodes.length;if(i>n)d=(new c(d[0].childNodes[n]))._4e_previousSourceNode(true);else if(i<1)d=d._4e_previousSourceNode();else{for(d=d[0];d.lastChild;)d=d.lastChild;d=new c(d)}}if(b._4e_position(d)&u.POSITION_FOLLOWING)b=d;return{startNode:b,endNode:d}},fixBlock:function(b,d){var g=this.createBookmark();
d=new c(this.document.createElement(d));this.collapse(b);this.enlarge(o.ENLARGE_BLOCK_CONTENTS);d[0].appendChild(this.extractContents());d._4e_trim();r.ie||d._4e_appendBogus();this.insertNode(d);this.moveToBookmark(g);return d},splitBlock:function(b){var d=new a(this.startContainer),g=new a(this.endContainer),n=d.block,i=g.block,s=null;if(d.blockLimit[0]!==g.blockLimit[0])return null;if(b!="br"){if(!n){n=this.fixBlock(true,b);i=(new a(this.endContainer)).block}i||(i=this.fixBlock(false,b))}b=n&&this.checkStartOfBlock();
d=i&&this.checkEndOfBlock();this.deleteContents();if(n&&z._4e_equals(n,i))if(d){s=new a(this.startContainer);this.moveToPosition(i,o.POSITION_AFTER_END);i=null}else if(b){s=new a(this.startContainer);this.moveToPosition(n,o.POSITION_BEFORE_START);n=null}else{i=this.splitElement(n);!r.ie&&!C.inArray(n._4e_name(),["ul","ol"])&&n._4e_appendBogus()}return{previousBlock:n,nextBlock:i,wasStartOfBlock:b,wasEndOfBlock:d,elementPath:s}},splitElement:function(b){if(!this.collapsed)return null;this.setEndAt(b,
o.POSITION_BEFORE_END);var d=this.extractContents(),g=b._4e_clone(false);g[0].appendChild(d);g.insertAfter(b);this.moveToPosition(b,o.POSITION_AFTER_END);return g},moveToElementEditablePosition:function(b,d){var g,n=x.XHTML_DTD;if(n.$empty[b._4e_name()])return false;for(;b&&b[0].nodeType==j.NODE_ELEMENT;){if(g=b._4e_isEditable())this.moveToPosition(b,d?o.POSITION_BEFORE_END:o.POSITION_AFTER_START);else if(n.$inline[b._4e_name()]){this.moveToPosition(b,d?o.POSITION_AFTER_END:o.POSITION_BEFORE_START);
return true}if((b=n.$empty[b._4e_name()]?b[d?"_4e_previous":"_4e_next"](y):b[d?"_4e_last":"_4e_first"](y))&&b[0].nodeType==j.NODE_TEXT){this.moveToPosition(b,d?o.POSITION_AFTER_END:o.POSITION_BEFORE_START);return true}}return g},selectNodeContents:function(b){this.setStart(b,0);this.setEnd(b,b[0].nodeType==j.NODE_TEXT?b[0].nodeValue.length:b[0].childNodes.length)}});var e={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},f=new w.whitespaces,m=new w.bookmark;x.Range=H});
KISSY.Editor.add("domiterator",function(x){function H(l){if(!(arguments.length<1)){this.range=l;this.forceBrBreak=false;this.enlargeBr=true;this.enforceRealBlocks=false;this._||(this._={})}}var G=KISSY,y=G.UA,E=x.Walker,q=x.Range,D=x.RANGE,C=x.NODE,j=x.ElementPath,o=G.Node,u=G.DOM,w=/^[\r\n\t ]*$/,z=E.bookmark();G.augment(H,{getNextParagraph:function(l){var r,v,a,c,h;if(!this._.lastNode){v=this.range.clone();v.enlarge(this.forceBrBreak||!this.enlargeBr?D.ENLARGE_LIST_ITEM_CONTENTS:D.ENLARGE_BLOCK_CONTENTS);
var e=new E(v),f=E.bookmark(true,true);e.evaluator=f;this._.nextNode=e.next();e=new E(v);e.evaluator=f;e=e.previous();this._.lastNode=e._4e_nextSourceNode(true);if(this._.lastNode&&this._.lastNode[0].nodeType==C.NODE_TEXT&&!G.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()){f=new q(v.document);f.moveToPosition(this._.lastNode,D.POSITION_AFTER_END);if(f.checkEndOfBlock()){f=new j(f.endContainer);this._.lastNode=(f.block||f.blockLimit)._4e_nextSourceNode(true)}}if(!this._.lastNode){this._.lastNode=
this._.docEndMarker=new o(v.document.createTextNode(""));u.insertAfter(this._.lastNode[0],e[0])}v=null}f=this._.nextNode;e=this._.lastNode;for(this._.nextNode=null;f;){var m=false,b=f[0].nodeType!=C.NODE_ELEMENT,d=false;if(b){if(f[0].nodeType==C.NODE_TEXT)if(w.test(f[0].nodeValue))b=false}else{var g=f._4e_name();if(f._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if(g=="br")b=true;else if(!v&&!f[0].childNodes.length&&g!="hr"){r=f;a=f._4e_equals(e);break}if(v){v.setEndAt(f,D.POSITION_BEFORE_START);
if(g!="br")this._.nextNode=f}m=true}else{if(f[0].firstChild){if(!v){v=new q(this.range.document);v.setStartAt(f,D.POSITION_BEFORE_START)}f=new o(f[0].firstChild);continue}b=true}}if(b&&!v){v=new q(this.range.document);v.setStartAt(f,D.POSITION_BEFORE_START)}a=(!m||b)&&f._4e_equals(e);if(v&&!m)for(;!f[0].nextSibling&&!a;){g=f.parent();if(g._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){m=true;a||g._4e_equals(e);break}f=g;b=true;a=f._4e_equals(e);d=true}b&&v.setEndAt(f,D.POSITION_AFTER_END);f=f._4e_nextSourceNode(d,
null,e);a=!f;if((m||a)&&v){b=v.getBoundaryNodes();m=new j(v.startContainer);if(b.startNode.parent()._4e_equals(m.blockLimit)&&z(b.startNode)&&z(b.endNode)){v=null;this._.nextNode=null}else break}if(a)break}if(!r){if(!v){this._.docEndMarker&&this._.docEndMarker._4e_remove();return this._.nextNode=null}m=new j(v.startContainer);f=m.blockLimit;b={div:1,th:1,td:1};r=m.block;if((!r||!r[0])&&!this.enforceRealBlocks&&b[f._4e_name()]&&v.checkStartOfBlock()&&v.checkEndOfBlock())r=f;else if(!r||this.enforceRealBlocks&&
r._4e_name()=="li"){r=new o(this.range.document.createElement(l||"p"));r[0].appendChild(v.extractContents());r._4e_trim();v.insertNode(r);c=h=true}else if(r._4e_name()!="li"){if(!v.checkStartOfBlock()||!v.checkEndOfBlock()){r=r._4e_clone(false);r[0].appendChild(v.extractContents());r._4e_trim();h=v.splitBlock();c=!h.wasStartOfBlock;h=!h.wasEndOfBlock;v.insertNode(r)}}else if(!a)this._.nextNode=r._4e_equals(e)?null:v.getBoundaryNodes().endNode._4e_nextSourceNode(true,null,e)}if(c){v=new o(r[0].previousSibling);
if(v[0]&&v[0].nodeType==C.NODE_ELEMENT)if(v._4e_name()=="br")v._4e_remove();else v[0].lastChild&&v[0].lastChild.nodeName.toLowerCase()=="br"&&u._4e_remove(v[0].lastChild)}if(h){v=E.bookmark(false,true);c=new o(r[0].lastChild);if(c[0]&&c[0].nodeType==C.NODE_ELEMENT&&c._4e_name()=="br")if(y.ie||c._4e_previous(v)||c._4e_next(v))c._4e_remove()}if(!this._.nextNode)this._.nextNode=a||r._4e_equals(e)?null:r._4e_nextSourceNode(true,null,e);return r}});q.prototype.createIterator=function(){return new H(this)}});
KISSY.Editor.add("selection",function(x){function H(e){this.document=e;this._={cache:{}};if(q.ie){var f=this.getNative().createRange();if(!f||f.item&&f.item(0).ownerDocument!=e||f.parentElement&&f.parentElement().ownerDocument!=e)this.isInvalid=true}}function G(e){e=new H(e);return!e||e.isInvalid?null:e}function y(e){var f=e.document,m=new o(f.body),b=new o(f.documentElement);if(q.ie){if(q.ie<8||document.documentMode==7)b.on("click",function(s){D._4e_name(s.target)==="html"&&e.getSelection().getRanges()[0].select()});
var d,g;m.on("focusin",function(s){if(s.target.nodeName.toUpperCase()=="BODY")if(d){try{d.select()}catch(J){}d=null}});m.on("focus",function(){g=true;i()});m.on("beforedeactivate",function(s){s.relatedTarget||(g=false)});q.ie<8&&C.on(D._4e_getWin(f),"blur",function(){f.selection.empty()});m.on("mousedown",n);m.on("mouseup",function(){g=true;setTimeout(function(){i(true)},0)});m.on("keydown",n);m.on("keyup",function(){g=true;i()});C.on(f,"selectionchange",i);var n=function(){g=false},i=function(s){if(g){var J=
e.document,O=e.getSelection(),F=O&&O.getNative();if(s&&F&&F.type=="None")if(!J.queryCommandEnabled("InsertImage")){setTimeout(function(){i(true)},50);return}var I;if(!(F&&F.type=="Text"&&(I=F.createRange().parentElement().nodeName.toLowerCase())&&I in{input:1,textarea:1})){d=F&&O.getRanges()[0];e._monitor()}}}}else{C.on(f,"mouseup",e._monitor,e);C.on(f,"keyup",e._monitor,e)}}x.SELECTION={};var E=KISSY,q=E.UA,D=E.DOM,C=E.Event,j=x.Utils.tryThese,o=E.Node,u=x.SELECTION,w=x.RANGE,z=x.NODE,l=x.Walker,
r=x.Range;u.SELECTION_NONE=1;u.SELECTION_TEXT=2;u.SELECTION_ELEMENT=3;var v={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};E.augment(H,{getNative:q.ie?function(){return this._.cache.nativeSel||(this._.cache.nativeSel=this.document.selection)}:function(){return this._.cache.nativeSel||(this._.cache.nativeSel=D._4e_getWin(this.document).getSelection())},getType:q.ie?function(){var e=this._.cache;if(e.type)return e.type;
var f=u.SELECTION_NONE;try{var m=this.getNative(),b=m.type;if(b=="Text")f=u.SELECTION_TEXT;if(b=="Control")f=u.SELECTION_ELEMENT;if(m.createRange().parentElement)f=u.SELECTION_TEXT}catch(d){}return e.type=f}:function(){var e=this._.cache;if(e.type)return e.type;var f=u.SELECTION_TEXT,m=this.getNative();if(m){if(m.rangeCount==1){m=m.getRangeAt(0);var b=m.startContainer;if(b==m.endContainer&&b.nodeType==z.NODE_ELEMENT&&m.endOffset-m.startOffset===1&&v[b.childNodes[m.startOffset].nodeName.toLowerCase()])f=
u.SELECTION_ELEMENT}}else f=u.SELECTION_NONE;return e.type=f},getRanges:q.ie?function(){var e=function(f,m){f=f.duplicate();f.collapse(m);m=f.parentElement();for(var b=m.childNodes,d,g=0;g<b.length;g++){var n=b[g];if(n.nodeType==z.NODE_ELEMENT){d=f.duplicate();d.moveToElementText(n);n=d.compareEndPoints("StartToStart",f);var i=d.compareEndPoints("EndToStart",f);d.collapse();if(n>0)break;else if(!n||i==1&&n==-1)return{container:m,offset:g};else if(!i)return{container:m,offset:g+1};d=null}}if(!d){d=
f.duplicate();d.moveToElementText(m);d.collapse(false)}d.setEndPoint("StartToStart",f);f=d.text.replace(/(\r\n|\r)/g,"\n").length;try{for(;f>0;)f-=b[--g].nodeValue.length}catch(s){f=0}return f===0?{container:m,offset:g}:{container:b[g],offset:-f}};return function(){var f=this._.cache;if(f.ranges)return f.ranges;var m=this.getNative(),b=m&&m.createRange(),d=this.getType();if(!m)return[];if(d==u.SELECTION_TEXT){m=new r(this.document);d=e(b,true);m.setStart(new o(d.container),d.offset);d=e(b);m.setEnd(new o(d.container),
d.offset);return f.ranges=[m]}else if(d==u.SELECTION_ELEMENT){f=this._.cache.ranges=[];for(d=0;d<b.length;d++){var g=b.item(d),n=g.parentNode,i=0;for(m=new r(this.document);i<n.childNodes.length&&n.childNodes[i]!=g;i++);m.setStart(new o(n),i);m.setEnd(new o(n),i+1);f.push(m)}return f}return f.ranges=[]}}():function(){var e=this._.cache;if(e.ranges)return e.ranges;var f=[],m=this.getNative();if(!m)return[];for(var b=0;b<m.rangeCount;b++){var d=m.getRangeAt(b),g=new r(this.document);g.setStart(new o(d.startContainer),
d.startOffset);g.setEnd(new o(d.endContainer),d.endOffset);f.push(g)}return e.ranges=f},getStartElement:function(){var e=this._.cache;if(e.startElement!==undefined)return e.startElement;var f,m=this.getNative();switch(this.getType()){case u.SELECTION_ELEMENT:return this.getSelectedElement();case u.SELECTION_TEXT:var b=this.getRanges()[0];if(b)if(!b.collapsed){for(b.optimize();;){f=b.startContainer;if(b.startOffset==(f[0].childNodes?f[0].childNodes.length:f[0].nodeValue.length)&&!f._4e_isBlockBoundary())b.setStartAfter(f);
else break}f=b.startContainer;if(f[0].nodeType!=z.NODE_ELEMENT)return f.parent();f=new o(f[0].childNodes[b.startOffset]);if(!f[0]||f[0].nodeType!=z.NODE_ELEMENT)return b.startContainer;for(b=f[0].firstChild;b&&b.nodeType==z.NODE_ELEMENT;){f=new o(b);b=b.firstChild}return f}if(q.ie){b=m.createRange();b.collapse(true);f=b.parentElement()}else if((f=m.anchorNode)&&f.nodeType!=z.NODE_ELEMENT)f=f.parentNode}return e.startElement=f?new o(f):null},getSelectedElement:function(){var e=this._.cache;if(e.selectedElement!==
undefined)return e.selectedElement;var f=this,m=j(function(){return f.getNative().createRange().item(0)},function(){for(var b=f.getRanges()[0],d,g,n=2;n&&!((d=b.getEnclosedNode())&&d[0].nodeType==z.NODE_ELEMENT&&v[d._4e_name()]&&(g=d));n--)b.shrink(w.SHRINK_ELEMENT);return g[0]});return e.selectedElement=m?new o(m):null},reset:function(){this._.cache={}},selectElement:function(e){var f;if(q.ie){this.getNative().empty();try{f=this.document.body.createControlRange();f.addElement(e[0]);f.select()}catch(m){f=
this.document.body.createTextRange();f.moveToElementText(e[0]);f.select()}finally{}}else{f=this.document.createRange();f.selectNode(e[0]);e=this.getNative();e.removeAllRanges();e.addRange(f)}this.reset()},selectRanges:function(e){if(q.ie)e[0]&&e[0].select();else{var f=this.getNative();if(!f)return;f.removeAllRanges();for(var m=0;m<e.length;m++){var b=e[m],d=this.document.createRange(),g=b.startContainer;b.collapsed&&q.gecko&&q.gecko<1.09&&g[0].nodeType==z.NODE_ELEMENT&&!g[0].childNodes.length&&g[0].appendChild(this.document.createTextNode(""));
d.setStart(g[0],b.startOffset);d.setEnd(b.endContainer[0],b.endOffset);f.addRange(d)}}this.reset()},createBookmarks2:function(e){for(var f=[],m=this.getRanges(),b=0;b<m.length;b++)f.push(m[b].createBookmark2(e));return f},createBookmarks:function(e){for(var f=[],m=this.getRanges(),b=m.length,d,g=0;g<b;g++){f.push(d=m[g].createBookmark(e,true));var n=(e=d.serializable)?E.one("#"+d.startNode):d.startNode;d=e?E.one("#"+d.endNode):d.endNode;for(var i=g+1;i<b;i++){var s=m[i],J=s.startContainer,O=s.endContainer;
D._4e_equals(J,n.parent())&&s.startOffset++;D._4e_equals(J,d.parent())&&s.startOffset++;D._4e_equals(O,n.parent())&&s.endOffset++;D._4e_equals(O,d.parent())&&s.endOffset++}}return f},selectBookmarks:function(e){for(var f=[],m=0;m<e.length;m++){var b=new r(this.document);b.moveToBookmark(e[m]);f.push(b)}this.selectRanges(f);return this},getCommonAncestor:function(){var e=this.getRanges();return e[0].startContainer._4e_commonAncestor(e[e.length-1].endContainer)},scrollIntoView:function(){this.getStartElement().scrollIntoView()}});
x.Selection=H;var a={table:1,tbody:1,tr:1},c=l.whitespaces(true),h=/\ufeff|\u00a0/;r.prototype.select=q.ie?function(e){var f=this.collapsed,m,b;if(this.startContainer[0].nodeType==z.NODE_ELEMENT&&this.startContainer._4e_name()in a||this.endContainer[0].nodeType==z.NODE_ELEMENT&&this.endContainer._4e_name()in a)this.shrink(z.NODE_ELEMENT,true);var d=this.createBookmark(),g=d.startNode,n;if(!f)n=d.endNode;d=this.document.body.createTextRange();d.moveToElementText(g[0]);d.moveStart("character",1);if(n){e=
this.document.body.createTextRange();e.moveToElementText(n[0]);d.setEndPoint("EndToEnd",e);d.moveEnd("character",-1)}else{for(m=g[0].nextSibling;m&&!c(m);)m=m.nextSibling;m=!(m&&m.nodeValue&&m.nodeValue.match(h))&&(e||!g[0].previousSibling||g[0].previousSibling&&D._4e_name(g[0].previousSibling)=="br");b=this.document.createElement("span");b.innerHTML="&#65279;";b=new o(b);D.insertBefore(b[0],g[0]);m&&D.insertBefore(this.document.createTextNode("\ufeff"),g[0])}this.setStartBefore(g);g._4e_remove();
if(f){if(m){d.moveStart("character",-1);d.select();this.document.selection.clear()}else d.select();if(b){this.moveToPosition(b,w.POSITION_BEFORE_START);b._4e_remove()}}else{this.setEndBefore(n);n._4e_remove();d.select()}}:function(){var e=this.startContainer;this.collapsed&&e[0].nodeType==z.NODE_ELEMENT&&!e[0].childNodes.length&&e[0].appendChild(this.document.createTextNode(""));var f=this.document.createRange();f.setStart(e[0],this.startOffset);try{f.setEnd(this.endContainer[0],this.endOffset)}catch(m){if(m.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=
0){this.collapse(true);f.setEnd(this.endContainer[0],this.endOffset)}else throw m;}e=G(this.document).getNative();e.removeAllRanges();e.addRange(f)};x.on("instanceCreated",function(e){y(e.editor)})});
KISSY.Editor.add("styles",function(x){function H(k,p){for(var t in k)k[t]=k[t].replace($,function(A,B){return p[B]})}function G(k,p){if(p){k=n.clone(k);H(k.attributes,p);H(k.styles,p)}p=this.element=(k.element||"*").toLowerCase();this.type=p=="#"||Y[p]?s.STYLE_BLOCK:Z[p]?s.STYLE_OBJECT:s.STYLE_INLINE;this._={definition:k}}function y(k,p){p=p?this.removeFromRange:this.applyToRange;k.body.focus();k=new O(k);for(var t=k.getRanges(),A=0;A<t.length;A++)p.call(this,t[A]);k.selectRanges(t)}function E(k,
p){var t=k.element;if(t=="*")t="span";p=new P(p.createElement(t));return q(p,k)}function q(k,p){var t=p._.definition;p=t.attributes;t=G.getStyleText(t);if(p)for(var A in p)k.attr(A,p[A]);if(t)k[0].style.cssText=t;return k}function D(k){var p=k.createBookmark(true),t=k.createIterator();t.enforceRealBlocks=true;t.enlargeBr=true;for(var A,B=k.document;A=t.getNextParagraph();){var K=E(this,B);u(A,K)}k.moveToBookmark(p)}function C(k,p,t){var A="",B="";k=k.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,
function(K,M,Q){M&&(A=M);Q&&(B=Q);return""});return A+k.replace(p,t)+B}function j(k,p){var t=k.html();t=C(t,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,"");t=t.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1");t=t.replace(/([ \t\n\r]+|&nbsp;)/g," ");t=t.replace(/<br\b[^>]*>/gi,"\n");if(N.ie){k=k[0].ownerDocument.createElement("div");k.appendChild(p[0]);p[0].outerHTML="<pre>"+t+"</pre>";p=new P(k.firstChild);p._4e_remove()}else p.html(t);return p}function o(k){var p=[];C(k._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,
function(t,A,B){return A+"</pre>"+B+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(t,A){p.push(A)});return p}function u(k,p){var t=p._4e_name=="pre",A=k._4e_name=="pre",B=!t&&A;if(t&&!A)p=j(k,p);else if(B)p=z(o(k),p);else k._4e_moveChildren(p);k[0].parentNode.replaceChild(p[0],k[0]);t&&w(p)}function w(k){var p;if((p=k._4e_previousSourceNode(true,F.NODE_ELEMENT))&&p._4e_name()=="pre"){var t=C(p.html(),/\n$/,"")+"\n\n"+C(k.html(),/^\n/,"");if(N.ie)k[0].outerHTML="<pre>"+t+"</pre>";else k.html(t);
p._4e_remove()}}function z(k,p){for(var t=p[0].ownerDocument.createDocumentFragment(),A=0;A<k.length;A++){var B=k[A];B=B.replace(/(\r\n|\r)/g,"\n");B=C(B,/^[ \t]*\n/,"");B=C(B,/\n$/,"");B=C(B,/^[ \t]+|[ \t]+$/g,function(M,Q){return M.length==1?"&nbsp;":Q?" "+(new Array(M.length)).join("&nbsp;"):(new Array(M.length)).join("&nbsp;")+" "});B=B.replace(/\n/g,"<br>");B=B.replace(/[ \t]{2,}/g,function(M){return(new Array(M.length)).join("&nbsp;")+" "});var K=p._4e_clone();K.html(B);t.appendChild(K[0])}return t}
function l(k){var p=k.document;if(k.collapsed){p=E(this,p);k.insertNode(p);k.moveToPosition(p,J.POSITION_BEFORE_END)}else{var t=this.element,A=this._.definition,B,K=x.XHTML_DTD[t]||(B=true,x.XHTML_DTD.span),M=k.createBookmark();k.enlarge(J.ENLARGE_ELEMENT);k.trim();var Q=k.createBookmark(),da=Q.startNode;Q=Q.endNode;for(var T=da,V;T&&T[0];){var R=false;if(i._4e_equals(T,Q)){T=null;R=true}else{var U=T[0].nodeType,aa=U==F.NODE_ELEMENT?T._4e_name():null;if(aa&&T.attr("_ke_bookmark")){T=T._4e_nextSourceNode(true);
continue}if(!aa||K[aa]&&(T._4e_position(Q)|I.POSITION_PRECEDING|I.POSITION_IDENTICAL|I.POSITION_IS_CONTAINED)==I.POSITION_PRECEDING+I.POSITION_IDENTICAL+I.POSITION_IS_CONTAINED&&(!A.childRule||A.childRule(T))){var ba=T.parent();if(ba&&ba[0]&&((x.XHTML_DTD[ba._4e_name()]||x.XHTML_DTD.span)[t]||B)&&(!A.parentRule||A.parentRule(ba))){if(!V&&(!aa||!x.XHTML_DTD.$removeEmpty[aa]||(T._4e_position(Q)|I.POSITION_PRECEDING|I.POSITION_IDENTICAL|I.POSITION_IS_CONTAINED)==I.POSITION_PRECEDING+I.POSITION_IDENTICAL+
I.POSITION_IS_CONTAINED)){V=new L(p);V.setStartBefore(T)}if(U==F.NODE_TEXT||U==F.NODE_ELEMENT&&!T[0].childNodes.length){U=T;for(var W;!U[0].nextSibling&&(W=U.parent(),K[W._4e_name()])&&(W._4e_position(da)|I.POSITION_FOLLOWING|I.POSITION_IDENTICAL|I.POSITION_IS_CONTAINED)==I.POSITION_FOLLOWING+I.POSITION_IDENTICAL+I.POSITION_IS_CONTAINED&&(!A.childRule||A.childRule(W));)U=W;V.setEndAfter(U);U[0].nextSibling||(R=true)}}else R=true}else R=true;T=T._4e_nextSourceNode()}if(R&&V&&!V.collapsed){R=E(this,
p);for(U=V.getCommonAncestor();R&&U&&R[0]&&U[0];){if(U._4e_name()==t){for(var X in A.attributes)R.attr(X)==U.attr(X)&&R[0].removeAttribute(X);for(var ea in A.styles)R._4e_style(ea)==U._4e_style(ea)&&R._4e_style(ea,"");if(!R._4e_hasAttributes()){R=null;break}}U=U.parent()}if(R){R[0].appendChild(V.extractContents());b(this,R);V.insertNode(R);R._4e_mergeSiblings();N.ie||R[0].normalize()}V=null}}da._4e_remove();Q._4e_remove();k.moveToBookmark(M);k.shrink(J.SHRINK_TEXT)}}function r(k){k.enlarge(J.ENLARGE_ELEMENT);
var p=k.createBookmark(),t=p.startNode;if(k.collapsed){for(var A=new S(t.parent()),B,K=0,M;K<A.elements.length&&(M=A.elements[K]);K++){if(M==A.block||M==A.blockLimit)break;if(this.checkElementRemovable(M)){var Q=k.checkBoundaryOfElement(M,J.END),da=!Q&&k.checkBoundaryOfElement(M,J.START);if(da||Q){B=M;B.match=da?"start":"end"}else{M._4e_mergeSiblings();f(this,M)}}}if(B&&B[0]){M=t;for(K=0;;K++){Q=A.elements[K];if(i._4e_equals(Q,B))break;else if(Q.match)continue;else Q=Q._4e_clone();Q[0].appendChild(M[0]);
M=Q}i[B.match=="start"?"insertBefore":"insertAfter"](M[0],B[0])}}else{var T=p.endNode,V=this;A=function(){for(var R=new S(t.parent()),U=new S(T.parent()),aa=null,ba=null,W=0;W<R.elements.length;W++){var X=R.elements[W];if(X==R.block||X==R.blockLimit)break;if(V.checkElementRemovable(X))aa=X}for(W=0;W<U.elements.length;W++){X=U.elements[W];if(X==U.block||X==U.blockLimit)break;if(V.checkElementRemovable(X))ba=X}ba&&T._4e_breakParent(ba);aa&&t._4e_breakParent(aa)};A();for(B=new P(t[0].nextSibling);B[0]!==
T[0];){K=B._4e_nextSourceNode();if(B[0].nodeType==F.NODE_ELEMENT&&this.checkElementRemovable(B)){B._4e_name()==this.element?f(this,B):d(B,e(this)[B._4e_name()]);if(K[0].nodeType==F.NODE_ELEMENT&&K._4e_contains(t)){A();K=new P(t[0].nextSibling)}}B=K}}k.moveToBookmark(p)}function v(k){var p={};k.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(t,A,B){p[A]=B});return p}function a(k,p){typeof k=="string"&&(k=v(k));typeof p=="string"&&(p=v(p));for(var t in k)if(!(t in p&&
(p[t]==k[t]||k[t]=="inherit"||p[t]=="inherit")))return false;return true}function c(k,p){if(p!==false){p=document.createElement("span");p.style.cssText=k;k=p.style.cssText||""}else k=k;return k.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function h(k){var p=k._AC;if(p)return p;p={};var t=0,A=k.attributes;if(A)for(var B in A){t++;p[B]=A[B]}if(A=G.getStyleText(k)){p.style||t++;p.style=A}p._length=t;return k._AC=p}function e(k){if(k._.overrides)return k._.overrides;
var p=k._.overrides={},t=k._.definition.overrides;if(t){n.isArray(t)||(t=[t]);for(var A=0;A<t.length;A++){var B=t[A],K,M;if(typeof B=="string")K=B.toLowerCase();else{K=B.element?B.element.toLowerCase():k.element;M=B.attributes}B=p[K]||(p[K]={});if(M){B=B.attributes=B.attributes||[];for(var Q in M)B.push([Q.toLowerCase(),M[Q]])}}}return p}function f(k,p){var t=k._.definition,A=n.mix(n.mix({},t.attributes),e(k)[p._4e_name()]);t=t.styles;var B=n.isEmptyObject(A)&&n.isEmptyObject(t);for(var K in A)if(!((K==
"class"||k._.definition.fullMatch)&&p.attr(K)!=m(K,A[K]))){B=B||!!p._4e_hasAttribute(K);p.removeAttr(K)}for(var M in t)if(!(k._.definition.fullMatch&&p._4e_style(M)!=m(M,t[M],true))){B=B||!!p._4e_style(M);p._4e_style(M,"")}B&&g(p)}function m(k,p,t){var A=new P("<span></span>");A[t?"_4e_style":"attr"](k,p);return A[t?"_4e_style":"attr"](k)}function b(k,p){for(var t=e(k),A=p.all(k.element),B=A.length;--B>=0;)f(k,new P(A[B]));for(var K in t)if(K!=k.element){A=p.all(K);for(B=A.length-1;B>=0;B--){var M=
new P(A[B]);d(M,t[K])}}}function d(k,p){if(p=p&&p.attributes)for(var t=0;t<p.length;t++){var A=p[t][0],B;if(B=k.attr(A)){var K=p[t][1];if(K===null||K.test&&K.test(B)||typeof K=="string"&&B==K)k[0].removeAttribute(A)}}g(k)}function g(k){if(!k._4e_hasAttributes()){var p=k[0].firstChild,t=k[0].lastChild;k._4e_remove(true);if(p){p.nodeType==F.NODE_ELEMENT&&i._4e_mergeSiblings(p);t&&!p===t&&t.nodeType==F.NODE_ELEMENT&&i._4e_mergeSiblings(t)}}}var n=KISSY,i=n.DOM,s=x.STYLE={},J=x.RANGE,O=x.Selection,F=
x.NODE,I=x.POSITION,L=x.Range,P=n.Node,N=n.UA,S=x.ElementPath,Y={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},Z={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},ca=/\s*(?:;\s*|$)/,$=/#\((.+?)\)/g;s.STYLE_BLOCK=1;s.STYLE_INLINE=2;s.STYLE_OBJECT=3;G.prototype={apply:function(k){y.call(this,k,false)},remove:function(k){y.call(this,k,true)},applyToRange:function(k){return(this.applyToRange=this.type==s.STYLE_INLINE?l:this.type==s.STYLE_BLOCK?D:this.type==
s.STYLE_OBJECT?null:null).call(this,k)},removeFromRange:function(k){return(this.removeFromRange=this.type==s.STYLE_INLINE?r:null).call(this,k)},applyToObject:function(k){q(k,this)},checkElementRemovable:function(k,p){if(!k)return false;var t=this._.definition;if(k._4e_name()==this.element){if(!p&&!k._4e_hasAttributes())return true;t=h(t);if(t._length){for(var A in t)if(A!="_length"){var B=k.attr(A)||"";if(A=="style"?a(t[A],c(B,false)):t[A]==B){if(!p)return true}else if(p)return false}if(p)return true}else return true}if(t=
e(this)[k._4e_name()]){if(!(t=t.attributes))return true;for(p=0;p<t.length;p++){A=t[p][0];if(A=k.attr(A)){B=t[p][1];if(B===null||typeof B=="string"&&A==B||B.test(A))return true}}}return false},checkActive:function(k){switch(this.type){case s.STYLE_BLOCK:return this.checkElementRemovable(k.block||k.blockLimit,true);case s.STYLE_OBJECT:case s.STYLE_INLINE:for(var p=k.elements,t=0,A;t<p.length;t++){A=p[t];if(!(this.type==s.STYLE_INLINE&&(i._4e_equals(A,k.block)||i._4e_equals(A,k.blockLimit))))if(!(this.type==
s.STYLE_OBJECT&&!(A._4e_name()in Z)))if(this.checkElementRemovable(A,true))return true}}return false}};G.getStyleText=function(k){var p=k._ST;if(p)return p;p=k.styles;var t=k.attributes&&k.attributes.style||"",A="";if(t.length)t=t.replace(ca,";");for(var B in p){var K=p[B],M=(B+":"+K).replace(ca,";");if(K=="inherit")A+=M;else t+=M}if(t.length)t=c(t);t+=A;return k._ST=t};x.Style=G});
