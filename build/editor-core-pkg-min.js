KISSY.add("editor",function(y,H){function G(q,x){var a=this;if(!(a instanceof G))return new G(q,x);if(y.isString(q))q=y.one(q);q[0]||(q=new Node(q));a.cfg=x;y.app(a,y.EventTarget);a.use=function(c){y.use.call(a,c,function(){a.on("dataReady",function(){a.setData(q.val())})},{order:true,global:G})};a.init(q)}function B(q){return!v?"build/"+q:q}y.app(G,y.EventTarget);G.Config.base=y.Config.base+"editor/";var v=y.Config.debug,w={htmlparser:{attach:false,path:B("plugins/htmldataprocessor/htmlparser/htmlparser.js")}},
E=["utils","focusmanager","definition","dtd","dom","elementpath","walker","range","domiterator","selection","styles"],D=["clipboard",{name:"color",useCss:true},{name:"elementpaths",useCss:true},"enterkey","fakeobjects",{name:"flash",requires:["fakeobjects","overlay"]},"font","format",{name:"htmldataprocessor",requires:["htmlparser-text"]},{name:"image",requires:["overlay"]},"indent","justify","link","list","maximize","music","preview","removeformat",{name:"smiley",useCss:true},"sourcearea",{name:"table",
useCss:true,requires:["overlay","contextmenu"]},{name:"templates",requires:["overlay"],useCss:true},"undo"],n=[{name:"htmlparser-basicwriter",requires:["htmlparser"]},{name:"htmlparser-element",requires:["htmlparser-fragment"]},{name:"htmlparser-filter",requires:["htmlparser-element"]},{name:"htmlparser-fragment",requires:["htmlparser-htmlwriter"]},{name:"htmlparser-htmlwriter",requires:["htmlparser-basicwriter"]},{name:"htmlparser-text",requires:["htmlparser-filter"]}],p=["button","overlay",{name:"contextmenu",
requires:["overlay"]}],t,u,C,k;t=0;for(u=p.length;t<u;t++){C=p[t];k=H;if(!y.isString(C)){k=C.requires;C=C.name}w[C]={attach:false,requires:k,path:B("ui/"+C+".js"),csspath:B("ui/"+C+".css")}}t=0;for(u=D.length;t<u;t++){p=C=D[t];k=["button"];if(!y.isString(C)){C.requires&&(k=k.concat(C.requires));p=C.name}w[p]={attach:false,requires:k,csspath:C.useCss?B("plugins/"+p+"/plugin.css"):H,path:B("plugins/"+p+"/plugin.js")}}t=0;for(u=n.length;t<u;t++){C=n[t];k=H;if(!y.isString(C)){k=C.requires;C=C.name}w[C]=
{attach:false,requires:k,path:B("plugins/htmldataprocessor/htmlparser/"+C.substring(11)+".js")}}G.add(w);w={};t=0;for(u=E.length;t<u;t++){C=E[t];w[C]={host:"editor",requires:t>0?E[t-1]:[]}}G.add(w);y.Editor=G});
KISSY.Editor.add("utils",function(y){var H=KISSY,G=H.Node,B=H.DOM;y.Utils={debugUrl:function(v){return!H.Config.debug?"build/"+v:v},lazyRun:function(v,w,E){var D=v[w],n=v[E];v[w]=function(){D.apply(this,arguments);v[w]=v[E];return n.apply(this,arguments)}},getXY:function(v,w,E,D){E=E.defaultView||E.parentWindow;v-=B.scrollLeft(E);w-=B.scrollTop(E);if(D)if(E!=(D.defaultView||D.parentWindow)&&E.frameElement){D=B._4e_getOffset(E.frameElement,D);v+=D.left;w+=D.top}return{left:v,top:w}},tryThese:function(){for(var v,
w=0,E=arguments.length;w<E;w++){var D=arguments[w];try{v=D();break}catch(n){}}return v},arrayCompare:function(v,w){if(!v&&!w)return true;if(!v||!w||v.length!=w.length)return false;for(var E=0;E<v.length;E++)if(v[E]!==w[E])return false;return true},getByAddress:function(v,w,E){v=v.documentElement;for(var D=0;v&&D<w.length;D++){var n=w[D];if(E)for(var p=-1,t=0;t<v.childNodes.length;t++){var u=v.childNodes[t];if(!(E===true&&u.nodeType==3&&u.previousSibling&&u.previousSibling.nodeType==3)){p++;if(p==
n){v=u;break}}}else v=v.childNodes[n]}return v?new G(v):null},clearAllMarkers:function(v){for(var w in v)v[w]._4e_clearMarkers(v,true)},htmlEncodeAttr:function(v){return v.replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/,"&gt;")},ltrim:function(v){return v.replace(/^\s+/,"")},rtrim:function(v){return v.replace(/\s+$/,"")},trim:function(v){return this.ltrim(this.rtrim(v))},mix:function(){for(var v={},w=0;w<arguments.length;w++)v=H.mix(v,arguments[w]);return v}}});
KISSY.Editor.add("focusmanager",function(y){function H(){this.iframeFocus=true}function G(){this.iframeFocus=false}var B=KISSY,v=B.DOM,w=B.Event;B={};var E={};B.add=function(D){E[D._UUID]=D;var n=v._4e_getWin(D.document);w.on(n,"focus",H,D);w.on(n,"blur",G,D)};B.remove=function(D){delete E[D._UUID];var n=v._4e_getWin(D.document);w.remove(n,"focus",H,D);w.remove(n,"blur",G,D)};y.focusManager=B});
KISSY.Editor.add("definition",function(y){function H(){return p+"<html><head><title>kissy-editor</title><link href='"+y.Config.base+t+"' rel='stylesheet'/></head><body class='ke-editor'>&nbsp;</body><html>"}var G=KISSY,B=G.UA,v=G.DOM,w=G.Node,E=G.Event,D=y.focusManager,n=y.Utils.tryThese,p="<!doctype html>",t=y.Utils.debugUrl("assets/editor-iframe.css"),u=1,C="<div  class='ke-editor-wrap'  onmousedown=' return false;'  > <div class='"+".ke-editor-tools".substring(1)+"'></div><div class='"+".ke-textarea-wrap".substring(1)+
'\'><iframe  style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor"  src="'+(B.ie?"javascript:void(function(){"+encodeURIComponent("document.open();document.close();")+"}())":"")+'"  tabIndex="'+(B.webkit?-1:"$(tabIndex)")+'"  allowTransparency="true" ></iframe></div><div class=\''+".ke-editor-status".substring(1)+"'></div></div>";G.augment(y,{init:function(k){var q=this,x=new w(C.replace(/\$\(tabIndex\)/,k.attr("tabIndex")));q.editorWrap=x;
q._UUID=u++;q.wrap=x.one(".ke-textarea-wrap");q.iframe=q.wrap.one("iframe");q.toolBarDiv=x.one(".ke-editor-tools");q.textarea=k;q.statusDiv=x.one(".ke-editor-status");q.toolBarDiv._4e_unselectable();q._commands={};q._plugins={};var a=k._4e_style("width"),c=k._4e_style("height");if(a){x.css("width",a);k.css("width","100%")}q.textarea.css("display","none");x.insertAfter(k);q.wrap[0].appendChild(k[0]);if(c){q.wrap.css("height",c);k.css("height","100%")}k=q.iframe;q.on("dataReady",function(){q.ready=
true;y.fire("instanceCreated",{editor:q})});B.gecko?k.on("load",q._initIFrame,q):q._initIFrame()},addCommand:function(k,q){this._commands[k]=q},execCommand:function(k){this._commands[k].exec(this)},getData:function(){if(y.HtmlDataProcessor)return y.HtmlDataProcessor.toHtml(this.document.body.innerHTML,"p");return this.document.body.innerHTML},setData:function(k){if(y.HtmlDataProcessor)k=y.HtmlDataProcessor.toDataFormat(k,"p");this.document.body.innerHTML=k},sync:function(){this.textarea.val(this.getData())},
_getRawData:function(){return this.document.body.innerHTML},_setRawData:function(k){this.document.body.innerHTML=k},_hideSource:function(){this.iframe.css("display","");this.textarea.css("display","none");this.toolBarDiv.children().css("visibility","");this.statusDiv.children().css("visibility","")},_showSource:function(){this.textarea.css("display","");this.iframe.css("display","none");this.toolBarDiv.children().css("visibility","hidden");this.toolBarDiv.all(".ke-tool-editor-source").css("visibility",
"");this.statusDiv.children().css("visibility","hidden");B.ie<8&&this.textarea.css("height",this.wrap.css("height"))},_prepareIFrameHtml:H,getSelection:function(){var k=new y.Selection(this.document);return!k||k.isInvalid?null:k},focus:function(){var k=v._4e_getWin(this.document);B.webkit&&k&&k.parent&&k.parent.focus();k&&k.focus();this.document&&this.document.body.focus();this.notifySelectionChange()},blur:function(){v._4e_getWin(this.document).blur();this.document&&this.document.body.blur()},_initIFrame:function(){function k(h){n(function(){f.designMode=
"on";setTimeout(function(){f.designMode="off";e.focus();if(!arguments.callee.retry)arguments.callee.retry=true},50)},function(){f.designMode="off";v.attr(e,"contentEditable",false);v.attr(e,"contentEditable",true);!h&&k(1)})}var q=this,x=q.iframe,a=q.textarea[0],c=H(),i=x[0].contentWindow,f=i.document;q.document=f;x.detach();f.open("text/html","replace");f.write(c);f.close();var e=f.body;if(B.ie){e.hideFocus=true;e.disabled=true;e.contentEditable=true;e.removeAttribute("disabled")}else setTimeout(function(){if(B.gecko||
B.opera)e.contentEditable=true;else if(B.webkit)e.parentNode.contentEditable=true;else f.designMode="on"},0);try{f.execCommand("enableObjectResizing",false,true)}catch(l){}try{f.execCommand("enableInlineTableEditing",false,true)}catch(b){}B.webkit&&E.on(f,"mousedown",function(h){h=new w(h.target);G.inArray(h._4e_name(),["img","hr","input","textarea","select"])&&q.getSelection().selectElement(h)});if(B.webkit){E.on(f,"click",function(h){var r=new w(h.target);G.inArray(r._4e_name(),["input","select"])&&
h.preventDefault()});E.on(f,"mouseup",function(h){var r=new w(h.target);G.inArray(r._4e_name(),["input","textarea"])&&h.preventDefault()})}if(B.gecko||B.ie||B.opera){var d;d=new w(v.insertAfter((new w('<span style="position:absolute; left:-10000"></span>'))[0],a));d.on("focus",function(){q.focus()});q.on("destroy",function(){})}if(B.ie&&f.compatMode=="CSS1Compat"||B.gecko||B.opera){var g=new w(f.documentElement);g.on("mousedown",function(h){if(h.target===g[0]){B.gecko&&k(false);d[0].focus()}})}E.on(i,
"focus",function(){if(B.gecko)k(false);else B.opera&&e.focus();q.notifySelectionChange()});B.gecko&&E.on(q.document,"mousedown",function(){q.iframeFocus||k(false)});if(B.ie){E.on(f,"keydown",function(h){if(h.keyCode in{8:1,46:1}){var r=q.getSelection(),J=r.getSelectedElement();if(J){q.fire("save");var O=r.getRanges()[0].createBookmark();J.remove();r.selectBookmarks([O]);q.fire("save");h.preventDefault()}}});if(f.compatMode=="CSS1Compat"){var m={33:1,34:1};E.on(f,"keydown",function(h){h.keyCode in
m&&setTimeout(function(){q.getSelection().scrollIntoView()},0)})}}setTimeout(function(){B.ie&&setTimeout(function(){if(f){e.runtimeStyle.marginBottom="0px";e.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){q.fire("dataReady")},10);D.add(q)},addPlugin:function(k){this.ready?k():this.on("dataReady",k)},_monitor:function(){var k=this;k._monitorId&&clearTimeout(k._monitorId);k._monitorId=setTimeout(function(){var q=k.getSelection();if(q&&!q.isInvalid){q=q.getStartElement();var x=new y.ElementPath(q);
if(!k.previousPath||!k.previousPath.compare(x)){k.previousPath=x;k.fire("selectionChange",{selection:k,path:x,element:q})}}},200)},notifySelectionChange:function(){this.previousPath=null;this._monitor()},insertElement:function(k){var q=this;q.focus();var x=k._4e_name(),a=y.XHTML_DTD,c=y.RANGE,i=y.NODE,f=a.$block[x],e=q.getSelection(),l=e.getRanges(),b,d,g,m,h;q.fire("save");for(var r=l.length-1;r>=0;r--){b=l[r];b.deleteContents();d=!r&&k||k._4e_clone(true);if(f)for(;(m=b.getCommonAncestor(false,true))&&
(h=a[m._4e_name()])&&!(h&&h[x]);)if(m._4e_name()in a.span)b.splitElement(m);else if(b.checkStartOfBlock()&&b.checkEndOfBlock()){b.setStartBefore(m);b.collapse(true);m.remove()}else b.splitBlock();b.insertNode(d);g||(g=d)}b.moveToPosition(g,c.POSITION_AFTER_END);(k=g._4e_nextSourceNode(true))&&k.type==i.NODE_ELEMENT&&b.moveToElementEditablePosition(k);e.selectRanges([b]);q.focus();d&&d._4e_scrollIntoView();setTimeout(function(){q.fire("save")},10)},insertHtml:function(k){if(y.HtmlDataProcessor)k=y.HtmlDataProcessor.toDataFormat(k);
if(B.webkit){k=v.create(k,null,this.document);k=k.nodeType==11?G.makeArray(k.childNodes):[k];for(var q=0;q<k.length;q++)this.insertElement(new w(k[q]))}else{var x=this;x.focus();x.fire("save");q=x.getSelection();if(B.ie){q=q.getNative();q.type=="Control"&&q.clear();q.createRange().pasteHTML(k)}else x.document.execCommand("inserthtml",false,k);x.focus();setTimeout(function(){x.fire("save")},10)}}})});
KISSY.Editor.add("dtd",function(y){y.XHTML_DTD=function(){var H=function(l){for(var b=arguments.length-1;b>0;)KISSY.mix(l,arguments[b--]);return l},G={isindex:1,fieldset:1},B={input:1,button:1,select:1,textarea:1,label:1},v=H({a:1},B),w=H({iframe:1},v),E={hr:1,ul:1,menu:1,div:1,blockquote:1,noscript:1,table:1,center:1,address:1,dir:1,pre:1,h5:1,dl:1,h4:1,noframes:1,h6:1,ol:1,h1:1,h3:1,h2:1},D={ins:1,del:1,script:1,style:1},n=H({b:1,acronym:1,bdo:1,"var":1,"#":1,abbr:1,code:1,br:1,i:1,cite:1,kbd:1,
u:1,strike:1,s:1,tt:1,strong:1,q:1,samp:1,em:1,dfn:1,span:1},D),p=H({sub:1,img:1,object:1,sup:1,basefont:1,map:1,applet:1,font:1,big:1,small:1},n),t=H({p:1},p);B=H({iframe:1},p,B);p={img:1,noscript:1,br:1,kbd:1,center:1,button:1,basefont:1,h5:1,h4:1,samp:1,h6:1,ol:1,h1:1,h3:1,h2:1,form:1,font:1,"#":1,select:1,menu:1,ins:1,abbr:1,label:1,code:1,table:1,script:1,cite:1,input:1,iframe:1,strong:1,textarea:1,noframes:1,big:1,small:1,span:1,hr:1,sub:1,bdo:1,"var":1,div:1,object:1,sup:1,strike:1,dir:1,map:1,
dl:1,applet:1,del:1,isindex:1,fieldset:1,ul:1,b:1,acronym:1,a:1,blockquote:1,i:1,u:1,s:1,tt:1,address:1,q:1,pre:1,p:1,em:1,dfn:1};var u=H({a:1},B),C={tr:1},k={"#":1},q=H({param:1},p),x=H({form:1},G,w,E,t),a={li:1},c={base:1,link:1,meta:1,title:1},i=H(c,{style:1,script:1}),f={head:1,body:1},e={address:1,blockquote:1,center:1,dir:1,div:1,dl:1,fieldset:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,isindex:1,menu:1,noframes:1,ol:1,p:1,pre:1,table:1,ul:1};return{$nonBodyContent:H({html:1},f,c),$block:e,
$blockLimit:{body:1,div:1,td:1,th:1,caption:1,form:1},$inline:u,$body:H({script:1,style:1},e),$cdata:{script:1,style:1},$empty:{area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},$listItem:{dd:1,dt:1,li:1},$list:{ul:1,ol:1,dl:1},$nonEditable:{applet:1,button:1,embed:1,iframe:1,map:1,object:1,option:1,script:1,textarea:1,param:1},$removeEmpty:{abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},$tabIndex:{a:1,area:1,button:1,input:1,object:1,select:1,textarea:1},$tableContent:{caption:1,col:1,colgroup:1,tbody:1,td:1,tfoot:1,th:1,thead:1,tr:1},html:f,head:i,style:k,body:x,base:{},link:{},meta:{},title:k,col:{},tr:{td:1,th:1},img:{},colgroup:{col:1},noscript:x,td:x,br:{},th:x,center:x,kbd:u,button:H(t,E),basefont:{},h5:u,h4:u,samp:u,h6:u,ol:a,h1:u,h3:u,option:k,h2:u,form:H(G,w,E,t),select:{optgroup:1,option:1},font:u,ins:u,menu:a,abbr:u,label:u,table:{thead:1,
col:1,tbody:1,tr:1,colgroup:1,caption:1,tfoot:1},code:u,script:k,tfoot:C,cite:u,li:x,input:{},iframe:x,strong:u,textarea:k,noframes:x,big:u,small:u,span:u,hr:{},dt:u,sub:u,optgroup:{option:1},param:{},bdo:u,"var":u,div:x,object:q,sup:u,dd:x,strike:u,area:{},dir:a,map:H({area:1,form:1,p:1},G,D,E),applet:q,dl:{dt:1,dd:1},del:u,isindex:{},fieldset:H({legend:1},p),thead:C,ul:a,acronym:u,b:u,a:B,blockquote:x,caption:u,i:u,u:u,tbody:C,s:u,address:H(w,t),tt:u,legend:u,q:u,pre:H(n,v),p:u,em:u,dfn:u}}()});
KISSY.Editor.add("dom",function(y){function H(a){return a.replace(/-(\w)/g,function(c,i){return i.toUpperCase()})}var G=KISSY,B=G.DOM,v=G.UA,w=G.Node,E=y.Utils,D={abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};y.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_DOCUMENT_FRAGMENT:11};y.POSITION={};var n=y.NODE,p=y.POSITION;p.POSITION_IDENTICAL=0;p.POSITION_DISCONNECTED=1;p.POSITION_FOLLOWING=
2;p.POSITION_PRECEDING=4;p.POSITION_IS_CONTAINED=8;p.POSITION_CONTAINS=16;var t={},u={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},C={hr:1},k=function(a){return a[0]||a},q=function(a){if(!a[0])return new w(a);return a},x={_4e_equals:function(a,c){if(!a&&!c)return true;if(!a||!c)return false;a=k(a);c=k(c);return a===c},_4e_isBlockBoundary:function(a,c){a=q(a);c=
G.mix(G.mix({},C),c||{});return u[a.css("display")]||c[a._4e_name()]},_4e_getWin:function(a){return a&&"scrollTo"in a&&a.document?a:a&&a.nodeType===9?a.defaultView||a.parentWindow:false},_4e_index:function(a){a=k(a);for(var c=a.parentNode.childNodes,i=0;i<c.length;i++)if(c[i]===a)return i;return-1},_4e_first:function(a,c){a=k(a);if((a=(a=a.firstChild)&&new w(a))&&c&&!c(a))a=a._4e_next(c);return a},_4e_move:function(a,c,i){a.remove();a=k(a);c=k(c);i?c.insertBefore(a,c.firstChild):c.appendChild(a)},
_4e_name:function(a){a=k(a);return a.nodeName.toLowerCase()},_4e_isIdentical:function(a,c){if(a._4e_name()!=c._4e_name())return false;var i=a[0].attributes,f=c[0].attributes,e=i.length,l=f.length;if(!v.ie&&e!=l)return false;for(var b=0;b<e;b++){var d=i[b];if((!v.ie||d.specified&&d.nodeName!="_ke_expando")&&d.nodeValue!=c.attr(d.nodeName))return false}if(v.ie)for(b=0;b<l;b++){d=f[b];if(d.specified&&d.nodeName!="_ke_expando"&&d.nodeValue!=a.attr(d.nodeName))return false}return true},_4e_isEmptyInlineRemoveable:function(a){a=
k(a).childNodes;for(var c=0,i=a.length;c<i;c++){var f=a[c],e=f.nodeType;if(!(e==n.NODE_ELEMENT&&f.getAttribute("_ke_bookmark")))if(e==n.NODE_ELEMENT&&!x._4e_isEmptyInlineRemoveable(f)||e==n.NODE_TEXT&&G.trim(f.nodeValue))return false}return true},_4e_moveChildren:function(a,c,i){a=k(a);c=c[0]||c;if(a!=c)if(i)for(;i=a.lastChild;)c.insertBefore(a.removeChild(i),c.firstChild);else for(;i=a.firstChild;)c.appendChild(a.removeChild(i))},_4e_mergeSiblings:function(){function a(c,i,f){if(i[0]&&i[0].nodeType==
n.NODE_ELEMENT){for(var e=[];i.attr("_ke_bookmark")||i._4e_isEmptyInlineRemoveable();){e.push(i);i=f?new w(i[0].nextSibling):new w(i[0].previousSibling);if(!i[0]||i[0].nodeType!=n.NODE_ELEMENT)return}if(c._4e_isIdentical(i)){for(var l=f?c[0].lastChild:c[0].firstChild;e.length;)e.shift()._4e_move(c,!f);i._4e_moveChildren(c,!f);i.remove();l[0]&&l[0].nodeType==n.NODE_ELEMENT&&l._4e_mergeSiblings()}}}return function(c){if(c[0])if(D[c._4e_name()]||c._4e_name()=="a"){a(c,new w(c[0].nextSibling),true);a(c,
new w(c[0].previousSibling))}}}(),_4e_unselectable:v.gecko?function(a){a=k(a);a.style.MozUserSelect="none"}:v.webkit?function(a){a=k(a);a.style.KhtmlUserSelect="none"}:function(a){a=k(a);if(v.ie||v.opera){var c,i=0;for(a.unselectable="on";c=a.all[i++];)switch(c.tagName.toLowerCase()){case "iframe":case "textarea":case "input":case "select":break;default:c.unselectable="on"}}},_4e_getOffset:function(a,c){a=k(a);var i,f=0;i=0;var e=a.ownerDocument.defaultView||a.ownerDocument.parentWindow,l=a.ownerDocument,
b=l.documentElement;if(a.getBoundingClientRect){if(a!==l.body&&b!==a){i=a.getBoundingClientRect();f=i.left+B.scrollLeft(e);i=i.top+B.scrollTop(e)}if(c)if(e!=(c.defaultView||c.parentWindow)&&e.frameElement){c=x._4e_getOffset(e.frameElement,c);f+=c.left;i+=c.top}}return{left:f,top:i}},_4e_getFrameDocument:function(a){return(a=k(a))&&a.contentWindow.document},_4e_splitText:function(a,c){a=k(a);var i=a.ownerDocument;if(!(!a||a.nodeType!=n.NODE_TEXT)){if(v.ie&&c==a.nodeValue.length){i=i.createTextNode("");
B.insertAfter(i,a);return i}a=new w(a.splitText(c));if(v.ie==8){i=i.createTextNode("");B.insertAfter(i,a[0]);i.parentNode.removeChild(i)}return a}},_4e_parents:function(a,c){a=q(a);var i=[];do i[c?"push":"unshift"](a);while(a=a.parent());return i},_4e_clone:function(a,c,i){a=k(a);a=a.cloneNode(c);if(!i){var f=function(e){if(e.nodeType==n.NODE_ELEMENT){e.removeAttribute("id",false);e.removeAttribute("_ke_expando",false);e=e.childNodes;for(var l=0;l<e.length;l++)f(e[l])}};f(a)}return new w(a)},_4e_nextSourceNode:function(a,
c,i,f){a=k(a);if(f&&!f.call){var e=f[0]||f;f=function(b){b=b[0]||b;return b!==e}}c=!c&&a.firstChild;var l=new w(a);if(!c){if(a.nodeType==n.NODE_ELEMENT&&f&&f(this,true)===false)return null;c=a.nextSibling}for(;!c&&(l=l.parent());){if(f&&f(l,true)===false)return null;c=l[0].nextSibling}if(!c)return null;c=new w(c);if(f&&f(c)===false)return null;if(i&&i!=c[0].nodeType)return c._4e_nextSourceNode(false,i,f);return c},_4e_previousSourceNode:function(a,c,i,f){a=k(a);if(f&&!f.call){var e=f[0]||f;f=function(b){b=
b[0]||b;return b!==e}}c=!c&&a.lastChild;var l=new w(a);if(!c){if(a.nodeType==n.NODE_ELEMENT&&f&&f(a,true)===false)return null;c=a.previousSibling}for(;!c&&(l=l.parent());){if(f&&f(l,true)===false)return null;c=l[0].previousSibling}if(!c)return null;c=new w(c);if(f&&f(c)===false)return null;if(i&&c[0].nodeType!=i)return c._4e_previousSourceNode(false,i,f);return c},_4e_contains:v.ie||v.webkit?function(a,c){a=k(a);c=k(c);return c.nodeType!=n.NODE_ELEMENT?a.contains(c.parentNode):a!=c&&a.contains(c)}:
function(a,c){a=k(a);c=k(c);return!!(a.compareDocumentPosition(c)&16)},_4e_commonAncestor:function(a,c){if(a._4e_equals(c))return a;if(c[0].nodeType!=n.NODE_TEXT&&c._4e_contains(a))return c;a=a[0].nodeType==n.NODE_TEXT?a.parent():a;do if(a[0].nodeType!=n.NODE_TEXT&&a._4e_contains(c))return a;while(a=a.parent());return null},_4e_ascendant:function(a,c,i){a=k(a);if(!i)a=a.parentNode;if(c&&!G.isFunction(c)){var f=c;c=function(e){return e._4e_name()==f}}for(;a&&a.nodeType!=9;){if(!c||c(new w(a))===true)return new w(a);
a=a.parentNode}return null},_4e_hasAttribute:function(a,c){a=k(a);a=a.attributes.getNamedItem(c);return!!(a&&a.specified)},_4e_hasAttributes:v.ie?function(a){a=k(a);for(var c=a.attributes,i=0;i<c.length;i++){var f=c[i];switch(f.nodeName){case "class":if(a.getAttribute("class"))return true;break;case "_ke_expando":continue;default:if(f.specified)return true}}return false}:function(a){a=k(a);v.gecko&&a.removeAttribute("_moz_dirty");a=a.attributes;return a.length>1||a.length==1&&a[0].nodeName!="_ke_expando"},
_4e_position:function(a,c){var i=k(a),f=k(c);if(i.compareDocumentPosition)return i.compareDocumentPosition(f);if(i==f)return p.POSITION_IDENTICAL;if(i.nodeType==n.NODE_ELEMENT&&f.nodeType==n.NODE_ELEMENT){if(i.contains){if(i.contains(f))return p.POSITION_CONTAINS+p.POSITION_PRECEDING;if(f.contains(i))return p.POSITION_IS_CONTAINED+p.POSITION_FOLLOWING}if("sourceIndex"in i)return i.sourceIndex<0||f.sourceIndex<0?p.POSITION_DISCONNECTED:i.sourceIndex<f.sourceIndex?p.POSITION_PRECEDING:p.POSITION_FOLLOWING}a=
a._4e_address();c=c._4e_address();i=Math.min(a.length,c.length);for(f=0;f<=i-1;f++)if(a[f]!=c[f]){if(f<i)return a[f]<c[f]?p.POSITION_PRECEDING:p.POSITION_FOLLOWING;break}return a.length<c.length?p.POSITION_CONTAINS+p.POSITION_PRECEDING:p.POSITION_IS_CONTAINED+p.POSITION_FOLLOWING},_4e_address:function(a,c){a=k(a);var i=[],f=a.ownerDocument.documentElement;for(a=a;a&&a!=f;){var e=a.parentNode,l=-1;if(e){for(var b=0;b<e.childNodes.length;b++){var d=e.childNodes[b];if(!(c&&d.nodeType==3&&d.previousSibling&&
d.previousSibling.nodeType==3)){l++;if(d==a)break}}i.unshift(l)}a=e}return i},_4e_breakParent:function(a,c){var i=new y.Range(a[0].ownerDocument);i.setStartAfter(a);i.setEndAfter(c);c=i.extractContents();i.insertNode(a.remove());a[0].parentNode.insertBefore(c,a[0].nextSibling)},_4e_style:function(a,c,i){if(i!==undefined)return a.css(c,i);a=a[0]||a;return a.style[H(c)]},_4e_remove:function(a,c){a=k(a);var i=a.parentNode;if(i){if(c)for(;c=a.firstChild;)i.insertBefore(a.removeChild(c),a);i.removeChild(a)}return this},
_4e_trim:function(a){B._4e_ltrim(a);B._4e_rtrim(a)},_4e_ltrim:function(a){a=k(a);for(var c;c=a.firstChild;){if(c.nodeType==n.NODE_TEXT){var i=E.ltrim(c.nodeValue),f=c.nodeValue.length;if(i){if(i.length<f){(new w(c))._4e_splitText(f-i.length);a.removeChild(a.firstChild)}}else{a.removeChild(c);continue}}break}},_4e_rtrim:function(a){a=k(a);for(var c;c=a.lastChild;){if(c.type==n.NODE_TEXT){var i=E.rtrim(c.nodeValue),f=c.nodeValue.length;if(i){if(i.length<f){(new w(c))._4e_splitText(i.length);a.removeChild(a.lastChild)}}else{a.removeChild(c);
continue}}break}if(!v.ie&&!v.opera)(c=a.lastChild)&&c.nodeType==1&&c.nodeName.toLowerCase()=="br"&&c.parentNode.removeChild(c)},_4e_appendBogus:function(a){a=k(a);for(var c=a.lastChild;c&&c.nodeType==n.NODE_TEXT&&!G.trim(c.nodeValue);)c=c.previousSibling;if(!c||c.nodeType==n.NODE_TEXT||B._4e_name(c)!=="br"){c=v.opera?a.ownerDocument.createTextNode(""):a.ownerDocument.createElement("br");v.gecko&&c.setAttribute("type","_moz");a.appendChild(c)}},_4e_previous:function(a,c){a=k(a);var i;do i=(a=a.previousSibling)&&
new w(a);while(i&&c&&!c(i));return i},_4e_last:function(a,c){if((a=(a=a[0].lastChild)&&new w(a))&&c&&!c(a))a=a._4e_previous(c);return a},_4e_next:function(a,c){a=k(a);var i;do i=(a=a.nextSibling)&&new w(a);while(i&&c&&!c(i));return i},_4e_outerHtml:function(a){a=k(a);if(a.outerHTML)return a.outerHTML.replace(/<\?[^>]*>/,"");var c=a.ownerDocument.createElement("div");c.appendChild(a.cloneNode(true));return c.innerHTML},_4e_setMarker:function(a,c,i,f){a[0]||(a=new w(a));var e=a._4e_getData("list_marker_id")||
a._4e_setData("list_marker_id",G.guid())._4e_getData("list_marker_id"),l=a._4e_getData("list_marker_names")||a._4e_setData("list_marker_names",{})._4e_getData("list_marker_names");c[e]=a;l[i]=1;return a._4e_setData(i,f)},_4e_clearMarkers:function(a,c,i){a=q(a);var f=a._4e_getData("list_marker_names"),e=a._4e_getData("list_marker_id");for(var l in f)a._4e_removeData(l);a._4e_removeData("list_marker_names");if(i){a._4e_removeData("list_marker_id");delete c[e]}},_4e_setData:function(a,c,i){var f=B._4e_getUniqueId(a);
(t[f]||(t[f]={}))[c]=i;return a},_4e_getData:function(a,c){a=k(a);return(a=(a=a.getAttribute("_ke_expando"))&&t[a])&&a[c]},_4e_removeData:function(a,c){a=k(a);var i=a.getAttribute("_ke_expando");var f=(i=i&&t[i])&&i[c];typeof f!="undefined"&&i&&delete i[c];G.isEmptyObject(i)&&B._4e_clearData(a);return f||null},_4e_clearData:function(a){a=k(a);var c=a.getAttribute("_ke_expando");c&&delete t[c];c&&a.removeAttribute("_ke_expando")},_4e_getUniqueId:function(a){a=k(a);var c=a.getAttribute("_ke_expando");
if(c)return c;c=G.guid();a.setAttribute("_ke_expando",c);return c},_4e_copyAttributes:function(a,c,i){a=k(a);var f=a.attributes;i=i||{};for(var e=0;e<f.length;e++){var l=f[e],b=l.nodeName.toLowerCase(),d;if(!(b in i))if(b=="checked"&&(d=B.attr(a,b)))c.attr(b,d);else if(l.specified||v.ie&&l.nodeValue&&b=="value"){d=B.attr(a,b);if(d===null)d=l.nodeValue;c.attr(b,d)}}if(a.style.cssText!=="")c[0].style.cssText=a.style.cssText},_4e_isEditable:function(a){a=B._4e_name(a);var c=y.XHTML_DTD;return(a=!c.$nonEditable[a]&&
(c[a]||c.span))&&a["#"]},_4e_scrollIntoView:function(a){a=q(a);var c=a[0].ownerDocument,i=B.scrollLeft(c),f=B.scrollTop(c),e=a.offset(),l=e.left;e=e.top;if(B.viewportHeight(c)+f<e||e<f||B.viewportWidth(c)+i<l||l<i)a.scrollIntoView(c)}};G.DOM._4e_inject=function(a){G.mix(B,a);for(var c in a)a.hasOwnProperty(c)&&function(i){w.prototype[i]=function(){var f=[].slice.call(arguments,0);f.unshift(this);return a[i].apply(null,f)}}(c)};G.DOM._4e_inject(x)});
KISSY.Editor.add("elementpath",function(y){function H(t){var u=null,C=null,k=[];for(t=t;t&&t[0];){if(t[0].nodeType==w.NODE_ELEMENT){if(!this.lastElement)this.lastElement=t;var q=t._4e_name();if(E.ie&&t[0].scopeName!="HTML")q=t[0].scopeName.toLowerCase()+":"+q;if(!C){if(!u&&D[q])u=t;if(n[q])if(!u&&q=="div"&&!p(t))u=t;else C=t}k.push(t);if(q=="body")break}t=t.parent()}this.block=u;this.blockLimit=C;this.elements=k}var G=KISSY,B=G.DOM,v=y.XHTML_DTD,w=y.NODE,E=G.UA,D={address:1,blockquote:1,dl:1,h1:1,
h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},n={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1},p=function(t){t=t[0]||t;t=t.childNodes;for(var u=0,C=t.length;u<C;u++){var k=t[u];if(k.nodeType==w.NODE_ELEMENT&&v.$block[k.nodeName.toLowerCase()])return true}return false};H.prototype={compare:function(t){var u=this.elements;t=t&&t.elements;if(!t||u.length!=t.length)return false;for(var C=0;C<u.length;C++)if(!B._4e_equals(u[C],t[C]))return false;return true},contains:function(t){for(var u=
this.elements,C=0;C<u.length;C++)if(u[C]._4e_name()in t)return u[C];return null}};y.ElementPath=H});
KISSY.Editor.add("walker",function(y){function H(n,p){if(this._.end)return null;var t=this.range,u,C=this.guard,k=this.type,q=n?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start){this._.start=1;t.trim();if(t.collapsed){this.end();return null}}if(!n&&!this._.guardLTR){var x=t.endContainer,a=new D(x[0].childNodes[t.endOffset]);this._.guardLTR=function(e,l){return(!l||!E._4e_equals(x,e))&&(!a[0]||e[0]!==a[0])&&(e[0].nodeType!=w.NODE_ELEMENT||!l||e._4e_name()!="body")}}if(n&&!this._.guardRTL){var c=
t.startContainer,i=t.startOffset>0&&new D(c[0].childNodes[t.startOffset-1]);this._.guardRTL=function(e,l){return e&&e[0]&&(!l||c[0]!==e[0])&&(!i[0]||e[0]!==i[0])&&(e[0].nodeType!=w.NODE_ELEMENT||!l||e._4e_name()!="body")}}var f=n?this._.guardRTL:this._.guardLTR;u=C?function(e,l){if(f(e,l)===false)return false;return C(e,l)}:f;if(this.current)n=this.current[q](false,k,u);else if(n){n=t.endContainer;if(t.endOffset>0){n=new D(n[0].childNodes[t.endOffset-1]);if(u(n)===false)n=null}else n=u(n,true)===
false?null:n._4e_previousSourceNode(true,k,u)}else{n=t.startContainer;if((n=new D(n[0].childNodes[t.startOffset]))&&n[0]){if(u(n)===false)n=null}else n=u(t.startContainer,true)===false?null:t.startContainer._4e_nextSourceNode(true,k,u)}for(;n&&n[0]&&!this._.end;){this.current=n;if(!this.evaluator||this.evaluator(n)!==false){if(!p)return n}else if(p&&this.evaluator)return false;n=n[q](false,k,u)}this.end();return this.current=null}function G(n){for(var p,t=null;p=H.call(this,n);)t=p;return t}function B(n){this.range=
n;this._={}}var v=KISSY,w=y.NODE,E=v.DOM,D=v.Node;v.augment(B,{end:function(){this._.end=1},next:function(){return H.call(this)},previous:function(){return H.call(this,true)},checkForward:function(){return H.call(this,false,true)!==false},checkBackward:function(){return H.call(this,true,true)!==false},lastForward:function(){return G.call(this)},lastBackward:function(){return G.call(this,true)},reset:function(){delete this.current;this._={}}});B.blockBoundary=function(n){return function(p){p[0]||(p=
new D(p));return!(p[0].nodeType==w.NODE_ELEMENT&&p._4e_isBlockBoundary(n))}};B.listItemBoundary=function(){return this.blockBoundary({br:1})};B.bookmark=function(n,p){function t(u){return u&&u[0]&&u._4e_name()=="span"&&u.attr("_ke_bookmark")}return function(u){var C,k;C=u&&u[0]&&u[0].nodeType==w.NODE_TEXT&&(k=u.parent())&&t(k);C=n?C:C||t(u);return p^C}};B.whitespaces=function(n){return function(p){p=(p=p[0]||p)&&p.nodeType==w.NODE_TEXT&&!v.trim(p.nodeValue);return n^p}};B.invisible=function(n){var p=
B.whitespaces();return function(t){t=p(t)||t[0].nodeType==w.NODE_ELEMENT&&!t[0].offsetHeight;return n^t}};y.Walker=B});
KISSY.Editor.add("range",function(y){function H(b){this.endOffset=this.endContainer=this.startOffset=this.startContainer=null;this.collapsed=true;this.document=b}function G(b){var d=b[0].nodeType!=n.NODE_TEXT&&b._4e_name()in x.$removeEmpty,g=!D.trim(b[0].nodeValue);b=!!b.parent().attr("_ke_bookmark");return d||g||b}function B(b){return!e(b)&&!l(b)}function v(b){var d=false,g=u.bookmark(true);return function(m){if(g(m))return true;if(m[0].nodeType==n.NODE_TEXT){if(D.trim(m[0].nodeValue).length)return false}else if(m[0].nodeType==
n.NODE_ELEMENT)if(!f[m._4e_name()])if(!b&&!q.ie&&m._4e_name()=="br"&&!d)d=true;else return false;return true}}function w(b,d){function g(m){return m&&m.nodeName=="span"&&m.getAttribute("_ke_bookmark")}return function(m){var h,r;h=m&&!m.nodeName&&(r=m.parentNode)&&g(r);h=b?h:h||g(m);return d^h}}function E(b){return function(d){d=(d=d[0]||d)&&d.nodeType==n.NODE_TEXT&&!D.trim(d.nodeValue);return b^d}}y.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,
ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,STARTEND:3,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var D=KISSY,n=y.NODE,p=y.RANGE,t=y.POSITION,u=y.Walker,C=D.DOM,k=y.Utils.getByAddress,q=D.UA,x=y.XHTML_DTD,a=y.ElementPath,c=D.Node,i={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1};H.prototype.toString=function(){var b=[];b.push((this.startContainer[0].id||this.startContainer[0].nodeName)+":"+this.startOffset);b.push((this.endContainer[0].id||this.endContainer[0].nodeName)+
":"+this.endOffset);return b.join("<br/>")};D.augment(H,{updateCollapsed:function(){this.collapsed=this.startContainer&&this.endContainer&&C._4e_equals(this.startContainer,this.endContainer)&&this.startOffset==this.endOffset},optimize:function(){var b=this.startContainer,d=this.startOffset;if(b[0].nodeType!=n.NODE_ELEMENT)if(d)d>=b[0].nodeValue.length&&this.setStartAfter(b);else this.setStartBefore(b);b=this.endContainer;d=this.endOffset;if(b[0].nodeType!=n.NODE_ELEMENT)if(d)d>=b[0].nodeValue.length&&
this.setEndAfter(b);else this.setEndBefore(b)},setStartAfter:function(b){this.setStart(b.parent(),b._4e_index()+1)},setStartBefore:function(b){this.setStart(b.parent(),b._4e_index())},setEndAfter:function(b){this.setEnd(b.parent(),b._4e_index()+1)},setEndBefore:function(b){this.setEnd(b.parent(),b._4e_index())},optimizeBookmark:function(){var b=this.startContainer,d=this.endContainer;b&&b._4e_name()=="span"&&b.attr("_ke_bookmark")&&this.setStartAt(b,p.POSITION_BEFORE_START);d&&d._4e_name()=="span"&&
d.attr("_ke_bookmark")&&this.setEndAt(d,p.POSITION_AFTER_END)},setStart:function(b,d){if(b[0].nodeType==n.NODE_ELEMENT&&i[b._4e_name()]){b=b.parent();d=b._4e_index()}this.startContainer=b;this.startOffset=d;if(!this.endContainer){this.endContainer=b;this.endOffset=d}this.updateCollapsed()},setEnd:function(b,d){if(b[0].nodeType==n.NODE_ELEMENT&&i[b._4e_name()]){b=b.parent();d=b._4e_index()+1}this.endContainer=b;this.endOffset=d;if(!this.startContainer){this.startContainer=b;this.startOffset=d}this.updateCollapsed()},
setStartAt:function(b,d){switch(d){case p.POSITION_AFTER_START:this.setStart(b,0);break;case p.POSITION_BEFORE_END:b[0].nodeType==n.NODE_TEXT?this.setStart(b,b[0].nodeValue.length):this.setStart(b,b[0].childNodes.length);break;case p.POSITION_BEFORE_START:this.setStartBefore(b);break;case p.POSITION_AFTER_END:this.setStartAfter(b)}this.updateCollapsed()},setEndAt:function(b,d){switch(d){case p.POSITION_AFTER_START:this.setEnd(b,0);break;case p.POSITION_BEFORE_END:b[0].nodeType==n.NODE_TEXT?this.setEnd(b,
b[0].nodeValue.length):this.setEnd(b,b[0].childNodes.length);break;case p.POSITION_BEFORE_START:this.setEndBefore(b);break;case p.POSITION_AFTER_END:this.setEndAfter(b)}this.updateCollapsed()},execContentsAction:function(b,d){var g=this.startContainer,m=this.endContainer,h=this.startOffset,r=this.endOffset,J,O;this.optimizeBookmark();if(m[0].nodeType==n.NODE_TEXT)m=m._4e_splitText(r);else if(m[0].childNodes.length>0)if(r>=m[0].childNodes.length){m=new c(m[0].appendChild(this.document.createTextNode("")));
O=true}else m=new c(m[0].childNodes[r]);if(g[0].nodeType==n.NODE_TEXT){g._4e_splitText(h);if(C._4e_equals(g,m))m=new c(g[0].nextSibling)}else if(h)if(h>=g[0].childNodes.length){J=new c(this.document.createTextNode(""));g[0].appendChild(J[0]);g=J;J=true}else g=new c(g[0].childNodes[h].previousSibling);else{J=new c(this.document.createTextNode(""));C.insertBefore(J[0],g[0].firstChild);g=J;J=true}h=g._4e_parents();r=m._4e_parents();var F,I,L;for(F=0;F<h.length;F++){I=h[F];L=r[F];if(I[0]!==L[0])break}for(var P=
d,N,S,Y,Z=F;Z<h.length;Z++){N=h[Z];if(P&&N[0]!==g[0])S=P.appendChild(N._4e_clone()[0]);for(N=N[0].nextSibling;N;){if(r[Z]&&N==r[Z][0]||N==m[0])break;Y=N.nextSibling;if(b==2)P.appendChild(N.cloneNode(true));else{N.parentNode.removeChild(N);b==1&&P.appendChild(N)}N=Y}if(S)P=S}P=d;for(d=F;d<r.length;d++){N=r[d];if(b>0&&N[0]!==m[0])S=P.appendChild(N._4e_clone()[0]);if(!h[d]||N[0].parentNode!==h[d][0].parentNode)for(N=N[0].previousSibling;N;){if(h[d]&&N==h[d][0]||N===g[0])break;Y=N.previousSibling;if(b==
2)P.insertBefore(N.cloneNode(true),P.firstChild);else{N.parentNode.removeChild(N);b==1&&P.insertBefore(N,P.firstChild)}N=Y}if(S)P=S}if(b==2){L=this.startContainer[0];if(L.nodeType==n.NODE_TEXT&&L.nextSibling&&L.nextSibling.nodeType==n.NODE_TEXT){L.data+=L.nextSibling.data;L.parentNode.removeChild(L.nextSibling)}L=this.endContainer[0];if(L.nodeType==n.NODE_TEXT&&L.nextSibling&&L.nextSibling.nodeType==n.NODE_TEXT){L.data+=L.nextSibling.data;L.parentNode.removeChild(L.nextSibling)}}else{if(I&&L&&(g[0].parentNode!=
I[0].parentNode||m[0].parentNode!=L[0].parentNode)){b=L._4e_index();J&&L[0].parentNode==g[0].parentNode&&b--;this.setStart(L.parent(),b)}this.collapse(true)}J&&g.remove();O&&m[0].parentNode&&m.remove()},collapse:function(b){if(b){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=this.endOffset}this.collapsed=true},clone:function(){var b=new H(this.document);b.startContainer=this.startContainer;b.startOffset=this.startOffset;
b.endContainer=this.endContainer;b.endOffset=this.endOffset;b.collapsed=this.collapsed;return b},getEnclosedNode:function(){var b=this.clone();b.optimize();if(b.startContainer[0].nodeType!=n.NODE_ELEMENT||b.endContainer[0].nodeType!=n.NODE_ELEMENT)return null;b=b.startContainer[0].childNodes[b.startOffset];for(var d=w(true,undefined),g=E(true),m=function(h){return g(h)&&d(h)};b&&m(b);)b=(new c(b))._4e_nextSourceNode()[0];return new c(b)},shrink:function(b,d){if(!this.collapsed){b=b||p.SHRINK_TEXT;
var g=this.clone(),m=this.startContainer,h=this.endContainer,r=this.startOffset,J=this.endOffset,O=1,F=1;if(m&&m[0].nodeType==n.NODE_TEXT)if(r)if(r>=m[0].nodeValue.length)g.setStartAfter(m);else{g.setStartBefore(m);O=0}else g.setStartBefore(m);if(h&&h[0].nodeType==n.NODE_TEXT)if(J)if(J>=h[0].nodeValue.length)g.setEndAfter(h);else{g.setEndAfter(h);F=0}else g.setEndBefore(h);g=new u(g);g.evaluator=function(L){L=L[0]||L;return L.nodeType==(b==p.SHRINK_ELEMENT?n.NODE_ELEMENT:n.NODE_TEXT)};var I;g.guard=
function(L,P){L=L[0]||L;if(b==p.SHRINK_ELEMENT&&L.nodeType==n.NODE_TEXT)return false;if(P&&L==I)return false;if(!P&&L.nodeType==n.NODE_ELEMENT)I=L;return true};if(O)(m=g[b==p.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(m,d?p.POSITION_AFTER_START:p.POSITION_BEFORE_START);if(F){g.reset();(g=g[b==p.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(g,d?p.POSITION_BEFORE_END:p.POSITION_AFTER_END)}return!!(O||F)}},getTouchedStartNode:function(){var b=this.startContainer;if(this.collapsed||
b[0].nodeType!=n.NODE_ELEMENT)return b;return b.childNodes[this.startOffset]||b},createBookmark2:function(b){var d=this.startContainer,g=this.endContainer,m=this.startOffset,h=this.endOffset,r,J;if(!d||!g)return{start:0,end:0};if(b){if(d[0].nodeType==n.NODE_ELEMENT)if((r=new c(d[0].childNodes[m]))&&r[0]&&r[0].nodeType==n.NODE_TEXT&&m>0&&r[0].previousSibling.nodeType==n.NODE_TEXT){d=r;m=0}for(;d[0].nodeType==n.NODE_TEXT&&(J=d._4e_previous())&&J[0].nodeType==n.NODE_TEXT;){d=J;m+=J[0].nodeValue.length}if(!this.collapsed){if(g[0].nodeType==
n.NODE_ELEMENT)if((r=new c(g[0].childNodes[h]))&&r[0]&&r[0].nodeType==n.NODE_TEXT&&h>0&&r[0].previousSibling.nodeType==n.NODE_TEXT){g=r;h=0}for(;g[0].nodeType==n.NODE_TEXT&&(J=g._4e_previous())&&J[0].nodeType==n.NODE_TEXT;){g=J;h+=J[0].nodeValue.length}}}return{start:d._4e_address(b),end:this.collapsed?null:g._4e_address(b),startOffset:m,endOffset:h,normalized:b,is2:true}},createBookmark:function(b){var d,g,m,h;d=new c("<span></span>",null,this.document);d.attr("_ke_bookmark",1);d.css("display","none");
d.html("&nbsp;");if(b){m=D.guid("ke_bm_");d.attr("id",m+"S")}if(!this.collapsed){g=d._4e_clone();g.html("&nbsp;");b&&g.attr("id",m+"E");h=this.clone();h.collapse();h.insertNode(g)}h=this.clone();h.collapse(true);h.insertNode(d);if(g){this.setStartAfter(d);this.setEndBefore(g)}else this.moveToPosition(d,p.POSITION_AFTER_END);return{startNode:b?m+"S":d,endNode:b?m+"E":g,serializable:b}},moveToPosition:function(b,d){this.setStartAt(b,d);this.collapse(true)},trim:function(b,d){var g=this.startContainer,
m=this.startOffset,h=this.collapsed;if((!b||h)&&g[0]&&g[0].nodeType==n.NODE_TEXT){if(m)if(m>=g[0].nodeValue.length){m=g._4e_index()+1;g=g.parent()}else{b=g._4e_splitText(m);m=g._4e_index()+1;g=g.parent();if(C._4e_equals(this.startContainer,this.endContainer))this.setEnd(b,this.endOffset-this.startOffset);else if(C._4e_equals(g,this.endContainer))this.endOffset+=1}else{m=g._4e_index();g=g.parent()}this.setStart(g,m);if(h){this.collapse(true);return}}g=this.endContainer;m=this.endOffset;if(!(d||h)&&
g[0]&&g[0].nodeType==n.NODE_TEXT){if(m){m>=g.nodeValue.length||g._4e_splitText(m);m=g._4e_index()+1}else m=g._4e_index();g=g.parent();this.setEnd(g,m)}},insertNode:function(b){this.optimizeBookmark();this.trim(false,true);var d=this.startContainer,g=d[0].childNodes[this.startOffset];this.optimizeBookmark();this.trim(false,true);g?C.insertBefore(b[0]||b,g):d[0].appendChild(b[0]||b);C._4e_equals(b.parent(),this.endContainer)&&this.endOffset++;this.setStartBefore(b)},moveToBookmark:function(b){if(b.is2){var d=
k(this.document,b.start,b.normalized),g=b.startOffset,m=b.end&&k(this.document,b.end,b.normalized);b=b.endOffset;this.setStart(d,g);m?this.setEnd(m,b):this.collapse(true)}else{d=(g=b.serializable)?D.one("#"+b.startNode,this.document):b.startNode;b=g?D.one("#"+b.endNode,this.document):b.endNode;this.setStartBefore(d);d.remove();if(b&&b[0]){this.setEndBefore(b);b.remove()}else this.collapse(true)}},getCommonAncestor:function(b,d){var g=this.startContainer,m=this.endContainer;b=C._4e_equals(g,m)?b&&
g[0].nodeType==n.NODE_ELEMENT&&this.startOffset==this.endOffset-1?new c(g[0].childNodes[this.startOffset]):g:g._4e_commonAncestor(m);return d&&b[0].nodeType==n.NODE_TEXT?b.parent():b},enlarge:function(b){switch(b){case p.ENLARGE_ELEMENT:if(this.collapsed)return;b=this.getCommonAncestor();var d=new c(this.document.body),g,m,h,r,J,O=false,F,I;F=this.startContainer;I=this.startOffset;if(F[0].nodeType==n.NODE_TEXT){if(I){F=!D.trim(F[0].nodeValue.substring(0,I)).length&&F;O=!!F}if(F)if(!(r=F[0].previousSibling))h=
F.parent()}else{if(I)r=F[0].childNodes[I-1]||F[0].lastChild;r||(h=F)}for(;h||r;){if(h&&!r){if(!J&&C._4e_equals(h,b))J=true;if(!d._4e_contains(h))break;if(!O||h.css("display")!="inline"){O=false;if(J)g=h;else this.setStartBefore(h)}r=h[0].previousSibling}for(;r;){F=false;if(r.nodeType==n.NODE_TEXT){I=r.nodeValue;if(/[^\s\ufeff]/.test(I))r=null;F=/[\s\ufeff]$/.test(I)}else if(r.offsetWidth>0&&!r.getAttribute("_ke_bookmark"))if(O&&x.$removeEmpty[r.nodeName.toLowerCase()]){I=C.text(r);if(/[^\s\ufeff]/.test(I))r=
null;else for(var L=r.all||r.getElementsByTagName("*"),P=0,N;N=L[P++];)if(!x.$removeEmpty[N.nodeName.toLowerCase()]){r=null;break}if(r)F=!!I.length}else r=null;if(F)if(O)if(J)g=h;else h&&this.setStartBefore(h);else O=true;if(r){F=r.previousSibling;if(!h&&!F){h=new c(r);r=null;break}r=F}else h=null}if(h)h=h.parent()}F=this.endContainer;I=this.endOffset;h=r=null;J=O=false;if(F[0].nodeType==n.NODE_TEXT){F=!D.trim(F[0].nodeValue.substring(I)).length&&F;O=!(F&&F[0].nodeValue.length);if(F)if(!(r=F[0].nextSibling))h=
F.parent()}else(r=F[0].childNodes[I])||(h=F);for(;h||r;){if(h&&!r){if(!J&&C._4e_equals(h,b))J=true;if(!d._4e_contains(h))break;if(!O||h.css("display")!="inline"){O=false;if(J)m=h;else h&&this.setEndAfter(h)}r=h[0].nextSibling}for(;r;){F=false;if(r.nodeType==n.NODE_TEXT){I=r.nodeValue;if(/[^\s\ufeff]/.test(I))r=null;F=/^[\s\ufeff]/.test(I)}else if(r.offsetWidth>0&&!r.getAttribute("_ke_bookmark"))if(O&&x.$removeEmpty[r.nodeName.toLowerCase()]){I=C.text(r);if(/[^\s\ufeff]/.test(I))r=null;else{L=r.all||
r.getElementsByTagName("*");for(P=0;N=L[P++];)if(!x.$removeEmpty[N.nodeName.toLowerCase()]){r=null;break}}if(r)F=!!I.length}else r=null;if(F)if(O)if(J)m=h;else this.setEndAfter(h);if(r){F=r.nextSibling;if(!h&&!F){h=new c(r);r=null;break}r=F}else h=null}if(h)h=h.parent()}if(g&&m){b=g._4e_contains(m)?m:g;this.setStartBefore(b);this.setEndAfter(b)}break;case p.ENLARGE_BLOCK_CONTENTS:case p.ENLARGE_LIST_ITEM_CONTENTS:h=new H(this.document);d=new c(this.document.body);h.setStartAt(d,p.POSITION_AFTER_START);
h.setEnd(this.startContainer,this.startOffset);h=new u(h);var S,Y,Z=u.blockBoundary(b==p.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:null),ca=function($){var j=Z($);j||(S=$);return j};g=function($){var j=ca($);if(!j&&$[0]&&$._4e_name()=="br")Y=$;return j};h.guard=ca;h=h.lastBackward();S=S||d;this.setStartAt(S,S._4e_name()!="br"&&(!h&&this.checkStartOfBlock()||h&&S._4e_contains(h))?p.POSITION_AFTER_START:p.POSITION_AFTER_END);h=this.clone();h.collapse();h.setEndAt(d,p.POSITION_BEFORE_END);h=new u(h);h.guard=
b==p.ENLARGE_LIST_ITEM_CONTENTS?g:ca;S=null;h=h.lastForward();S=S||d;this.setEndAt(S,!h&&this.checkEndOfBlock()||h&&S._4e_contains(h)?p.POSITION_BEFORE_END:p.POSITION_BEFORE_START);Y&&this.setEndAfter(Y)}},checkStartOfBlock:function(){var b=this.startContainer,d=this.startOffset;if(d&&b[0].nodeType==n.NODE_TEXT)if(D.trim(b[0].nodeValue.substring(0,d)).length)return false;this.trim();b=new a(this.startContainer);d=this.clone();d.collapse(true);d.setStartAt(b.block||b.blockLimit,p.POSITION_AFTER_START);
b=new u(d);b.evaluator=v(true);return b.checkBackward()},checkEndOfBlock:function(){var b=this.endContainer,d=this.endOffset;if(b[0].nodeType==n.NODE_TEXT)if(D.trim(b[0].nodeValue.substring(d)).length)return false;this.trim();b=new a(this.endContainer);d=this.clone();d.collapse(false);d.setEndAt(b.block||b.blockLimit,p.POSITION_BEFORE_END);b=new u(d);b.evaluator=v(false);return b.checkForward()},deleteContents:function(){this.collapsed||this.execContentsAction(0)},extractContents:function(){var b=
this.document.createDocumentFragment();this.collapsed||this.execContentsAction(1,b);return b},checkBoundaryOfElement:function(b,d){var g=this.clone();g[d==p.START?"setStartAt":"setEndAt"](b,d==p.START?p.POSITION_AFTER_START:p.POSITION_BEFORE_END);b=new u(g);b.evaluator=G;return b[d==p.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var b=this.startContainer,d=this.endContainer,g=this.startOffset,m=this.endOffset,h;if(b[0].nodeType==n.NODE_ELEMENT){h=b[0].childNodes.length;if(h>
g)b=new c(b[0].childNodes[g]);else if(h<1)b=b._4e_previousSourceNode();else{for(b=b[0];b.lastChild;)b=b.lastChild;b=new c(b);b=b._4e_nextSourceNode()||b}}if(d[0].nodeType==n.NODE_ELEMENT){h=d[0].childNodes.length;if(h>m)d=(new c(d[0].childNodes[m]))._4e_previousSourceNode(true);else if(h<1)d=d._4e_previousSourceNode();else{for(d=d[0];d.lastChild;)d=d.lastChild;d=new c(d)}}if(b._4e_position(d)&t.POSITION_FOLLOWING)b=d;return{startNode:b,endNode:d}},fixBlock:function(b,d){var g=this.createBookmark();
d=new c(this.document.createElement(d));this.collapse(b);this.enlarge(p.ENLARGE_BLOCK_CONTENTS);d[0].appendChild(this.extractContents());d._4e_trim();q.ie||d._4e_appendBogus();this.insertNode(d);this.moveToBookmark(g);return d},splitBlock:function(b){var d=new a(this.startContainer),g=new a(this.endContainer),m=d.block,h=g.block,r=null;if(d.blockLimit[0]!==g.blockLimit[0])return null;if(b!="br"){if(!m){m=this.fixBlock(true,b);h=(new a(this.endContainer)).block}h||(h=this.fixBlock(false,b))}b=m&&this.checkStartOfBlock();
d=h&&this.checkEndOfBlock();this.deleteContents();if(m&&C._4e_equals(m,h))if(d){r=new a(this.startContainer);this.moveToPosition(h,p.POSITION_AFTER_END);h=null}else if(b){r=new a(this.startContainer);this.moveToPosition(m,p.POSITION_BEFORE_START);m=null}else{h=this.splitElement(m);!q.ie&&!D.inArray(m._4e_name(),["ul","ol"])&&m._4e_appendBogus()}return{previousBlock:m,nextBlock:h,wasStartOfBlock:b,wasEndOfBlock:d,elementPath:r}},splitElement:function(b){if(!this.collapsed)return null;this.setEndAt(b,
p.POSITION_BEFORE_END);var d=this.extractContents(),g=b._4e_clone(false);g[0].appendChild(d);g.insertAfter(b);this.moveToPosition(b,p.POSITION_AFTER_END);return g},moveToElementEditablePosition:function(b,d){var g,m=y.XHTML_DTD;if(m.$empty[b._4e_name()])return false;for(;b&&b[0].nodeType==n.NODE_ELEMENT;){if(g=b._4e_isEditable())this.moveToPosition(b,d?p.POSITION_BEFORE_END:p.POSITION_AFTER_START);else if(m.$inline[b._4e_name()]){this.moveToPosition(b,d?p.POSITION_AFTER_END:p.POSITION_BEFORE_START);
return true}if((b=m.$empty[b._4e_name()]?b[d?"_4e_previous":"_4e_next"](B):b[d?"_4e_last":"_4e_first"](B))&&b[0].nodeType==n.NODE_TEXT){this.moveToPosition(b,d?p.POSITION_AFTER_END:p.POSITION_BEFORE_START);return true}}return g},selectNodeContents:function(b){this.setStart(b,0);this.setEnd(b,b[0].nodeType==n.NODE_TEXT?b[0].nodeValue.length:b[0].childNodes.length)}});var f={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},e=new u.whitespaces,l=new u.bookmark;y.Range=H});
KISSY.Editor.add("domiterator",function(y){function H(k){if(!(arguments.length<1)){this.range=k;this.forceBrBreak=false;this.enlargeBr=true;this.enforceRealBlocks=false;this._||(this._={})}}var G=KISSY,B=G.UA,v=y.Walker,w=y.Range,E=y.RANGE,D=y.NODE,n=y.ElementPath,p=G.Node,t=G.DOM,u=/^[\r\n\t ]*$/,C=v.bookmark();G.augment(H,{getNextParagraph:function(k){var q,x,a,c,i;if(!this._.lastNode){x=this.range.clone();x.enlarge(this.forceBrBreak||!this.enlargeBr?E.ENLARGE_LIST_ITEM_CONTENTS:E.ENLARGE_BLOCK_CONTENTS);
var f=new v(x),e=v.bookmark(true,true);f.evaluator=e;this._.nextNode=f.next();f=new v(x);f.evaluator=e;f=f.previous();this._.lastNode=f._4e_nextSourceNode(true);if(this._.lastNode&&this._.lastNode[0].nodeType==D.NODE_TEXT&&!G.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()){e=new w(x.document);e.moveToPosition(this._.lastNode,E.POSITION_AFTER_END);if(e.checkEndOfBlock()){e=new n(e.endContainer);this._.lastNode=(e.block||e.blockLimit)._4e_nextSourceNode(true)}}if(!this._.lastNode){this._.lastNode=
this._.docEndMarker=new p(x.document.createTextNode(""));t.insertAfter(this._.lastNode[0],f[0])}x=null}e=this._.nextNode;f=this._.lastNode;for(this._.nextNode=null;e;){var l=false,b=e[0].nodeType!=D.NODE_ELEMENT,d=false;if(b){if(e[0].nodeType==D.NODE_TEXT)if(u.test(e[0].nodeValue))b=false}else{var g=e._4e_name();if(e._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if(g=="br")b=true;else if(!x&&!e[0].childNodes.length&&g!="hr"){q=e;a=e._4e_equals(f);break}if(x){x.setEndAt(e,E.POSITION_BEFORE_START);
if(g!="br")this._.nextNode=e}l=true}else{if(e[0].firstChild){if(!x){x=new w(this.range.document);x.setStartAt(e,E.POSITION_BEFORE_START)}e=new p(e[0].firstChild);continue}b=true}}if(b&&!x){x=new w(this.range.document);x.setStartAt(e,E.POSITION_BEFORE_START)}a=(!l||b)&&e._4e_equals(f);if(x&&!l)for(;!e[0].nextSibling&&!a;){g=e.parent();if(g._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){l=true;a||g._4e_equals(f);break}e=g;b=true;a=e._4e_equals(f);d=true}b&&x.setEndAt(e,E.POSITION_AFTER_END);e=e._4e_nextSourceNode(d,
null,f);a=!e;if((l||a)&&x){b=x.getBoundaryNodes();l=new n(x.startContainer);if(b.startNode.parent()._4e_equals(l.blockLimit)&&C(b.startNode)&&C(b.endNode)){x=null;this._.nextNode=null}else break}if(a)break}if(!q){if(!x){this._.docEndMarker&&this._.docEndMarker.remove();return this._.nextNode=null}l=new n(x.startContainer);e=l.blockLimit;b={div:1,th:1,td:1};q=l.block;if((!q||!q[0])&&!this.enforceRealBlocks&&b[e._4e_name()]&&x.checkStartOfBlock()&&x.checkEndOfBlock())q=e;else if(!q||this.enforceRealBlocks&&
q._4e_name()=="li"){q=new p(this.range.document.createElement(k||"p"));q[0].appendChild(x.extractContents());q._4e_trim();x.insertNode(q);c=i=true}else if(q._4e_name()!="li"){if(!x.checkStartOfBlock()||!x.checkEndOfBlock()){q=q._4e_clone(false);q[0].appendChild(x.extractContents());q._4e_trim();i=x.splitBlock();c=!i.wasStartOfBlock;i=!i.wasEndOfBlock;x.insertNode(q)}}else if(!a)this._.nextNode=q._4e_equals(f)?null:x.getBoundaryNodes().endNode._4e_nextSourceNode(true,null,f)}if(c){x=new p(q[0].previousSibling);
if(x[0]&&x[0].nodeType==D.NODE_ELEMENT)if(x._4e_name()=="br")x._4e_remove();else x[0].lastChild&&x[0].lastChild.nodeName.toLowerCase()=="br"&&t._4e_remove(x[0].lastChild)}if(i){x=v.bookmark(false,true);c=new p(q[0].lastChild);if(c[0]&&c[0].nodeType==D.NODE_ELEMENT&&c._4e_name()=="br")if(B.ie||c._4e_previous(x)||c._4e_next(x))c._4e_remove()}if(!this._.nextNode)this._.nextNode=a||q._4e_equals(f)?null:q._4e_nextSourceNode(true,null,f);return q}});w.prototype.createIterator=function(){return new H(this)}});
KISSY.Editor.add("selection",function(y){function H(f){this.document=f;this._={cache:{}};if(w.ie){var e=this.getNative().createRange();if(!e||e.item&&e.item(0).ownerDocument!=f||e.parentElement&&e.parentElement().ownerDocument!=f)this.isInvalid=true}}function G(f){f=new H(f);return!f||f.isInvalid?null:f}function B(f){var e=f.document,l=new p(e.body),b=new p(e.documentElement);if(w.ie){if(w.ie<8||document.documentMode==7)b.on("click",function(r){E._4e_name(r.target)==="html"&&f.getSelection().getRanges()[0].select()});
var d,g;l.on("focusin",function(r){if(r.target.nodeName.toUpperCase()=="BODY")if(d){try{d.select()}catch(J){}d=null}});l.on("focus",function(){g=true;h()});l.on("beforedeactivate",function(r){r.relatedTarget||(g=false)});w.ie<8&&D.on(E._4e_getWin(e),"blur",function(){e.selection.empty()});l.on("mousedown",m);l.on("mouseup",function(){g=true;setTimeout(function(){h(true)},0)});l.on("keydown",m);l.on("keyup",function(){g=true;h()});D.on(e,"selectionchange",h);var m=function(){g=false},h=function(r){if(g){var J=
f.document,O=f.getSelection(),F=O&&O.getNative();if(r&&F&&F.type=="None")if(!J.queryCommandEnabled("InsertImage")){setTimeout(function(){h(true)},50);return}var I;if(!(F&&F.type=="Text"&&(I=F.createRange().parentElement().nodeName.toLowerCase())&&I in{input:1,textarea:1})){d=F&&O.getRanges()[0];f._monitor()}}}}else{D.on(e,"mouseup",f._monitor,f);D.on(e,"keyup",f._monitor,f)}}y.SELECTION={};var v=KISSY,w=v.UA,E=v.DOM,D=v.Event,n=y.Utils.tryThese,p=v.Node,t=y.SELECTION,u=y.RANGE,C=y.NODE,k=y.Walker,
q=y.Range;t.SELECTION_NONE=1;t.SELECTION_TEXT=2;t.SELECTION_ELEMENT=3;var x={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};v.augment(H,{getNative:w.ie?function(){return this._.cache.nativeSel||(this._.cache.nativeSel=this.document.selection)}:function(){return this._.cache.nativeSel||(this._.cache.nativeSel=E._4e_getWin(this.document).getSelection())},getType:w.ie?function(){var f=this._.cache;if(f.type)return f.type;
var e=t.SELECTION_NONE;try{var l=this.getNative(),b=l.type;if(b=="Text")e=t.SELECTION_TEXT;if(b=="Control")e=t.SELECTION_ELEMENT;if(l.createRange().parentElement)e=t.SELECTION_TEXT}catch(d){}return f.type=e}:function(){var f=this._.cache;if(f.type)return f.type;var e=t.SELECTION_TEXT,l=this.getNative();if(l){if(l.rangeCount==1){l=l.getRangeAt(0);var b=l.startContainer;if(b==l.endContainer&&b.nodeType==C.NODE_ELEMENT&&l.endOffset-l.startOffset===1&&x[b.childNodes[l.startOffset].nodeName.toLowerCase()])e=
t.SELECTION_ELEMENT}}else e=t.SELECTION_NONE;return f.type=e},getRanges:w.ie?function(){var f=function(e,l){e=e.duplicate();e.collapse(l);l=e.parentElement();for(var b=l.childNodes,d,g=0;g<b.length;g++){var m=b[g];if(m.nodeType==C.NODE_ELEMENT){d=e.duplicate();d.moveToElementText(m);m=d.compareEndPoints("StartToStart",e);var h=d.compareEndPoints("EndToStart",e);d.collapse();if(m>0)break;else if(!m||h==1&&m==-1)return{container:l,offset:g};else if(!h)return{container:l,offset:g+1};d=null}}if(!d){d=
e.duplicate();d.moveToElementText(l);d.collapse(false)}d.setEndPoint("StartToStart",e);e=d.text.replace(/(\r\n|\r)/g,"\n").length;try{for(;e>0;)e-=b[--g].nodeValue.length}catch(r){e=0}return e===0?{container:l,offset:g}:{container:b[g],offset:-e}};return function(){var e=this._.cache;if(e.ranges)return e.ranges;var l=this.getNative(),b=l&&l.createRange(),d=this.getType();if(!l)return[];if(d==t.SELECTION_TEXT){l=new q(this.document);d=f(b,true);l.setStart(new p(d.container),d.offset);d=f(b);l.setEnd(new p(d.container),
d.offset);return e.ranges=[l]}else if(d==t.SELECTION_ELEMENT){e=this._.cache.ranges=[];for(d=0;d<b.length;d++){var g=b.item(d),m=g.parentNode,h=0;for(l=new q(this.document);h<m.childNodes.length&&m.childNodes[h]!=g;h++);l.setStart(new p(m),h);l.setEnd(new p(m),h+1);e.push(l)}return e}return e.ranges=[]}}():function(){var f=this._.cache;if(f.ranges)return f.ranges;var e=[],l=this.getNative();if(!l)return[];for(var b=0;b<l.rangeCount;b++){var d=l.getRangeAt(b),g=new q(this.document);g.setStart(new p(d.startContainer),
d.startOffset);g.setEnd(new p(d.endContainer),d.endOffset);e.push(g)}return f.ranges=e},getStartElement:function(){var f=this._.cache;if(f.startElement!==undefined)return f.startElement;var e,l=this.getNative();switch(this.getType()){case t.SELECTION_ELEMENT:return this.getSelectedElement();case t.SELECTION_TEXT:var b=this.getRanges()[0];if(b)if(!b.collapsed){for(b.optimize();;){e=b.startContainer;if(b.startOffset==(e[0].childNodes?e[0].childNodes.length:e[0].nodeValue.length)&&!e._4e_isBlockBoundary())b.setStartAfter(e);
else break}e=b.startContainer;if(e[0].nodeType!=C.NODE_ELEMENT)return e.parent();e=new p(e[0].childNodes[b.startOffset]);if(!e[0]||e[0].nodeType!=C.NODE_ELEMENT)return b.startContainer;for(b=e[0].firstChild;b&&b.nodeType==C.NODE_ELEMENT;){e=new p(b);b=b.firstChild}return e}if(w.ie){b=l.createRange();b.collapse(true);e=b.parentElement()}else if((e=l.anchorNode)&&e.nodeType!=C.NODE_ELEMENT)e=e.parentNode}return f.startElement=e?new p(e):null},getSelectedElement:function(){var f=this._.cache;if(f.selectedElement!==
undefined)return f.selectedElement;var e=this,l=n(function(){return e.getNative().createRange().item(0)},function(){for(var b=e.getRanges()[0],d,g,m=2;m&&!((d=b.getEnclosedNode())&&d[0].nodeType==C.NODE_ELEMENT&&x[d._4e_name()]&&(g=d));m--)b.shrink(u.SHRINK_ELEMENT);return g[0]});return f.selectedElement=l?new p(l):null},reset:function(){this._.cache={}},selectElement:function(f){var e;if(w.ie){this.getNative().empty();try{e=this.document.body.createControlRange();e.addElement(f[0]);e.select()}catch(l){e=
this.document.body.createTextRange();e.moveToElementText(f[0]);e.select()}finally{}}else{e=this.document.createRange();e.selectNode(f[0]);f=this.getNative();f.removeAllRanges();f.addRange(e)}this.reset()},selectRanges:function(f){if(w.ie)f[0]&&f[0].select();else{var e=this.getNative();if(!e)return;e.removeAllRanges();for(var l=0;l<f.length;l++){var b=f[l],d=this.document.createRange(),g=b.startContainer;b.collapsed&&w.gecko&&w.gecko<1.09&&g[0].nodeType==C.NODE_ELEMENT&&!g[0].childNodes.length&&g[0].appendChild(this.document.createTextNode(""));
d.setStart(g[0],b.startOffset);d.setEnd(b.endContainer[0],b.endOffset);e.addRange(d)}}this.reset()},createBookmarks2:function(f){for(var e=[],l=this.getRanges(),b=0;b<l.length;b++)e.push(l[b].createBookmark2(f));return e},createBookmarks:function(f){for(var e=[],l=this.getRanges(),b=l.length,d,g=0;g<b;g++){e.push(d=l[g].createBookmark(f,true));var m=(f=d.serializable)?v.one("#"+d.startNode):d.startNode;d=f?v.one("#"+d.endNode):d.endNode;for(var h=g+1;h<b;h++){var r=l[h],J=r.startContainer,O=r.endContainer;
E._4e_equals(J,m.parent())&&r.startOffset++;E._4e_equals(J,d.parent())&&r.startOffset++;E._4e_equals(O,m.parent())&&r.endOffset++;E._4e_equals(O,d.parent())&&r.endOffset++}}return e},selectBookmarks:function(f){for(var e=[],l=0;l<f.length;l++){var b=new q(this.document);b.moveToBookmark(f[l]);e.push(b)}this.selectRanges(e);return this},getCommonAncestor:function(){var f=this.getRanges();return f[0].startContainer._4e_commonAncestor(f[f.length-1].endContainer)},scrollIntoView:function(){this.getStartElement().scrollIntoView()}});
y.Selection=H;var a={table:1,tbody:1,tr:1},c=k.whitespaces(true),i=/\ufeff|\u00a0/;q.prototype.select=w.ie?function(f){var e=this.collapsed,l,b;if(this.startContainer[0].nodeType==C.NODE_ELEMENT&&this.startContainer._4e_name()in a||this.endContainer[0].nodeType==C.NODE_ELEMENT&&this.endContainer._4e_name()in a)this.shrink(C.NODE_ELEMENT,true);var d=this.createBookmark(),g=d.startNode,m;if(!e)m=d.endNode;d=this.document.body.createTextRange();d.moveToElementText(g[0]);d.moveStart("character",1);if(m){f=
this.document.body.createTextRange();f.moveToElementText(m[0]);d.setEndPoint("EndToEnd",f);d.moveEnd("character",-1)}else{for(l=g[0].nextSibling;l&&!c(l);)l=l.nextSibling;l=!(l&&l.nodeValue&&l.nodeValue.match(i))&&(f||!g[0].previousSibling||g[0].previousSibling&&E._4e_name(g[0].previousSibling)=="br");b=this.document.createElement("span");b.innerHTML="&#65279;";b=new p(b);E.insertBefore(b[0],g[0]);l&&E.insertBefore(this.document.createTextNode("\ufeff"),g[0])}this.setStartBefore(g);g._4e_remove();
if(e){if(l){d.moveStart("character",-1);d.select();this.document.selection.clear()}else d.select();if(b){this.moveToPosition(b,u.POSITION_BEFORE_START);b._4e_remove()}}else{this.setEndBefore(m);m.remove();d.select()}}:function(){var f=this.startContainer;this.collapsed&&f[0].nodeType==C.NODE_ELEMENT&&!f[0].childNodes.length&&f[0].appendChild(this.document.createTextNode(""));var e=this.document.createRange();e.setStart(f[0],this.startOffset);try{e.setEnd(this.endContainer[0],this.endOffset)}catch(l){if(l.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=
0){this.collapse(true);e.setEnd(this.endContainer[0],this.endOffset)}else throw l;}f=G(this.document).getNative();f.removeAllRanges();f.addRange(e)};y.on("instanceCreated",function(f){B(f.editor)})});
KISSY.Editor.add("styles",function(y){function H(j,o){for(var s in j)j[s]=j[s].replace($,function(z,A){return o[A]})}function G(j,o){if(o){j=m.clone(j);H(j.attributes,o);H(j.styles,o)}o=this.element=(j.element||"*").toLowerCase();this.type=o=="#"||Y[o]?r.STYLE_BLOCK:Z[o]?r.STYLE_OBJECT:r.STYLE_INLINE;this._={definition:j}}function B(j,o){o=o?this.removeFromRange:this.applyToRange;j.body.focus();j=new O(j);for(var s=j.getRanges(),z=0;z<s.length;z++)o.call(this,s[z]);j.selectRanges(s)}function v(j,
o){var s=j.element;if(s=="*")s="span";o=new P(o.createElement(s));return w(o,j)}function w(j,o){var s=o._.definition;o=s.attributes;s=G.getStyleText(s);if(o)for(var z in o)j.attr(z,o[z]);if(s)j[0].style.cssText=s;return j}function E(j){var o=j.createBookmark(true),s=j.createIterator();s.enforceRealBlocks=true;s.enlargeBr=true;for(var z,A=j.document;z=s.getNextParagraph();){var K=v(this,A);t(z,K)}j.moveToBookmark(o)}function D(j,o,s){var z="",A="";j=j.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,
function(K,M,Q){M&&(z=M);Q&&(A=Q);return""});return z+j.replace(o,s)+A}function n(j,o){var s=j.html();s=D(s,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,"");s=s.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1");s=s.replace(/([ \t\n\r]+|&nbsp;)/g," ");s=s.replace(/<br\b[^>]*>/gi,"\n");if(N.ie){j=j[0].ownerDocument.createElement("div");j.appendChild(o[0]);o[0].outerHTML="<pre>"+s+"</pre>";o=new P(j.firstChild);o.remove()}else o.html(s);return o}function p(j){var o=[];D(j._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,
function(s,z,A){return z+"</pre>"+A+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(s,z){o.push(z)});return o}function t(j,o){var s=o._4e_name=="pre",z=j._4e_name=="pre",A=!s&&z;if(s&&!z)o=n(j,o);else if(A)o=C(p(j),o);else j._4e_moveChildren(o);j[0].parentNode.replaceChild(o[0],j[0]);s&&u(o)}function u(j){var o;if((o=j._4e_previousSourceNode(true,F.NODE_ELEMENT))&&o._4e_name()=="pre"){var s=D(o.html(),/\n$/,"")+"\n\n"+D(j.html(),/^\n/,"");if(N.ie)j[0].outerHTML="<pre>"+s+"</pre>";else j.html(s);
o.remove()}}function C(j,o){for(var s=o[0].ownerDocument.createDocumentFragment(),z=0;z<j.length;z++){var A=j[z];A=A.replace(/(\r\n|\r)/g,"\n");A=D(A,/^[ \t]*\n/,"");A=D(A,/\n$/,"");A=D(A,/^[ \t]+|[ \t]+$/g,function(M,Q){return M.length==1?"&nbsp;":Q?" "+(new Array(M.length)).join("&nbsp;"):(new Array(M.length)).join("&nbsp;")+" "});A=A.replace(/\n/g,"<br>");A=A.replace(/[ \t]{2,}/g,function(M){return(new Array(M.length)).join("&nbsp;")+" "});var K=o._4e_clone();K.html(A);s.appendChild(K[0])}return s}
function k(j){var o=j.document;if(j.collapsed){o=v(this,o);j.insertNode(o);j.moveToPosition(o,J.POSITION_BEFORE_END)}else{var s=this.element,z=this._.definition,A,K=y.XHTML_DTD[s]||(A=true,y.XHTML_DTD.span),M=j.createBookmark();j.enlarge(J.ENLARGE_ELEMENT);j.trim();var Q=j.createBookmark(),da=Q.startNode;Q=Q.endNode;for(var T=da,V;T&&T[0];){var R=false;if(h._4e_equals(T,Q)){T=null;R=true}else{var U=T[0].nodeType,aa=U==F.NODE_ELEMENT?T._4e_name():null;if(aa&&T.attr("_ke_bookmark")){T=T._4e_nextSourceNode(true);
continue}if(!aa||K[aa]&&(T._4e_position(Q)|I.POSITION_PRECEDING|I.POSITION_IDENTICAL|I.POSITION_IS_CONTAINED)==I.POSITION_PRECEDING+I.POSITION_IDENTICAL+I.POSITION_IS_CONTAINED&&(!z.childRule||z.childRule(T))){var ba=T.parent();if(ba&&ba[0]&&((y.XHTML_DTD[ba._4e_name()]||y.XHTML_DTD.span)[s]||A)&&(!z.parentRule||z.parentRule(ba))){if(!V&&(!aa||!y.XHTML_DTD.$removeEmpty[aa]||(T._4e_position(Q)|I.POSITION_PRECEDING|I.POSITION_IDENTICAL|I.POSITION_IS_CONTAINED)==I.POSITION_PRECEDING+I.POSITION_IDENTICAL+
I.POSITION_IS_CONTAINED)){V=new L(o);V.setStartBefore(T)}if(U==F.NODE_TEXT||U==F.NODE_ELEMENT&&!T[0].childNodes.length){U=T;for(var W;!U[0].nextSibling&&(W=U.parent(),K[W._4e_name()])&&(W._4e_position(da)|I.POSITION_FOLLOWING|I.POSITION_IDENTICAL|I.POSITION_IS_CONTAINED)==I.POSITION_FOLLOWING+I.POSITION_IDENTICAL+I.POSITION_IS_CONTAINED&&(!z.childRule||z.childRule(W));)U=W;V.setEndAfter(U);U[0].nextSibling||(R=true)}}else R=true}else R=true;T=T._4e_nextSourceNode()}if(R&&V&&!V.collapsed){R=v(this,
o);for(U=V.getCommonAncestor();R&&U&&R[0]&&U[0];){if(U._4e_name()==s){for(var X in z.attributes)R.attr(X)==U.attr(X)&&R[0].removeAttribute(X);for(var ea in z.styles)R._4e_style(ea)==U._4e_style(ea)&&R._4e_style(ea,"");if(!R._4e_hasAttributes()){R=null;break}}U=U.parent()}if(R){R[0].appendChild(V.extractContents());b(this,R);V.insertNode(R);R._4e_mergeSiblings();N.ie||R[0].normalize()}V=null}}da.remove();Q.remove();j.moveToBookmark(M);j.shrink(J.SHRINK_TEXT)}}function q(j){j.enlarge(J.ENLARGE_ELEMENT);
var o=j.createBookmark(),s=o.startNode;if(j.collapsed){for(var z=new S(s.parent()),A,K=0,M;K<z.elements.length&&(M=z.elements[K]);K++){if(M==z.block||M==z.blockLimit)break;if(this.checkElementRemovable(M)){var Q=j.checkBoundaryOfElement(M,J.END),da=!Q&&j.checkBoundaryOfElement(M,J.START);if(da||Q){A=M;A.match=da?"start":"end"}else{M._4e_mergeSiblings();e(this,M)}}}if(A&&A[0]){M=s;for(K=0;;K++){Q=z.elements[K];if(h._4e_equals(Q,A))break;else if(Q.match)continue;else Q=Q._4e_clone();Q[0].appendChild(M[0]);
M=Q}h[A.match=="start"?"insertBefore":"insertAfter"](M[0],A[0])}}else{var T=o.endNode,V=this;z=function(){for(var R=new S(s.parent()),U=new S(T.parent()),aa=null,ba=null,W=0;W<R.elements.length;W++){var X=R.elements[W];if(X==R.block||X==R.blockLimit)break;if(V.checkElementRemovable(X))aa=X}for(W=0;W<U.elements.length;W++){X=U.elements[W];if(X==U.block||X==U.blockLimit)break;if(V.checkElementRemovable(X))ba=X}ba&&T._4e_breakParent(ba);aa&&s._4e_breakParent(aa)};z();for(A=new P(s[0].nextSibling);A[0]!==
T[0];){K=A._4e_nextSourceNode();if(A[0].nodeType==F.NODE_ELEMENT&&this.checkElementRemovable(A)){A._4e_name()==this.element?e(this,A):d(A,f(this)[A._4e_name()]);if(K[0].nodeType==F.NODE_ELEMENT&&K._4e_contains(s)){z();K=new P(s[0].nextSibling)}}A=K}}j.moveToBookmark(o)}function x(j){var o={};j.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(s,z,A){o[z]=A});return o}function a(j,o){typeof j=="string"&&(j=x(j));typeof o=="string"&&(o=x(o));for(var s in j)if(!(s in o&&
(o[s]==j[s]||j[s]=="inherit"||o[s]=="inherit")))return false;return true}function c(j,o){if(o!==false){o=document.createElement("span");o.style.cssText=j;j=o.style.cssText||""}else j=j;return j.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function i(j){var o=j._AC;if(o)return o;o={};var s=0,z=j.attributes;if(z)for(var A in z){s++;o[A]=z[A]}if(z=G.getStyleText(j)){o.style||s++;o.style=z}o._length=s;return j._AC=o}function f(j){if(j._.overrides)return j._.overrides;
var o=j._.overrides={},s=j._.definition.overrides;if(s){m.isArray(s)||(s=[s]);for(var z=0;z<s.length;z++){var A=s[z],K,M;if(typeof A=="string")K=A.toLowerCase();else{K=A.element?A.element.toLowerCase():j.element;M=A.attributes}A=o[K]||(o[K]={});if(M){A=A.attributes=A.attributes||[];for(var Q in M)A.push([Q.toLowerCase(),M[Q]])}}}return o}function e(j,o){var s=j._.definition,z=m.mix(m.mix({},s.attributes),f(j)[o._4e_name()]);s=s.styles;var A=m.isEmptyObject(z)&&m.isEmptyObject(s);for(var K in z)if(!((K==
"class"||j._.definition.fullMatch)&&o.attr(K)!=l(K,z[K]))){A=A||!!o._4e_hasAttribute(K);o.removeAttr(K)}for(var M in s)if(!(j._.definition.fullMatch&&o._4e_style(M)!=l(M,s[M],true))){A=A||!!o._4e_style(M);o._4e_style(M,"")}A&&g(o)}function l(j,o,s){var z=new P("<span></span>");z[s?"_4e_style":"attr"](j,o);return z[s?"_4e_style":"attr"](j)}function b(j,o){for(var s=f(j),z=o.all(j.element),A=z.length;--A>=0;)e(j,new P(z[A]));for(var K in s)if(K!=j.element){z=o.all(K);for(A=z.length-1;A>=0;A--){var M=
new P(z[A]);d(M,s[K])}}}function d(j,o){if(o=o&&o.attributes)for(var s=0;s<o.length;s++){var z=o[s][0],A;if(A=j.attr(z)){var K=o[s][1];if(K===null||K.test&&K.test(A)||typeof K=="string"&&A==K)j[0].removeAttribute(z)}}g(j)}function g(j){if(!j._4e_hasAttributes()){var o=j[0].firstChild,s=j[0].lastChild;j._4e_remove(true);if(o){o.nodeType==F.NODE_ELEMENT&&h._4e_mergeSiblings(o);s&&!o===s&&s.nodeType==F.NODE_ELEMENT&&h._4e_mergeSiblings(s)}}}var m=KISSY,h=m.DOM,r=y.STYLE={},J=y.RANGE,O=y.Selection,F=
y.NODE,I=y.POSITION,L=y.Range,P=m.Node,N=m.UA,S=y.ElementPath,Y={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},Z={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},ca=/\s*(?:;\s*|$)/,$=/#\((.+?)\)/g;r.STYLE_BLOCK=1;r.STYLE_INLINE=2;r.STYLE_OBJECT=3;G.prototype={apply:function(j){B.call(this,j,false)},remove:function(j){B.call(this,j,true)},applyToRange:function(j){return(this.applyToRange=this.type==r.STYLE_INLINE?k:this.type==r.STYLE_BLOCK?E:this.type==
r.STYLE_OBJECT?null:null).call(this,j)},removeFromRange:function(j){return(this.removeFromRange=this.type==r.STYLE_INLINE?q:null).call(this,j)},applyToObject:function(j){w(j,this)},checkElementRemovable:function(j,o){if(!j)return false;var s=this._.definition;if(j._4e_name()==this.element){if(!o&&!j._4e_hasAttributes())return true;s=i(s);if(s._length){for(var z in s)if(z!="_length"){var A=j.attr(z)||"";if(z=="style"?a(s[z],c(A,false)):s[z]==A){if(!o)return true}else if(o)return false}if(o)return true}else return true}if(s=
f(this)[j._4e_name()]){if(!(s=s.attributes))return true;for(o=0;o<s.length;o++){z=s[o][0];if(z=j.attr(z)){A=s[o][1];if(A===null||typeof A=="string"&&z==A||A.test(z))return true}}}return false},checkActive:function(j){switch(this.type){case r.STYLE_BLOCK:return this.checkElementRemovable(j.block||j.blockLimit,true);case r.STYLE_OBJECT:case r.STYLE_INLINE:for(var o=j.elements,s=0,z;s<o.length;s++){z=o[s];if(!(this.type==r.STYLE_INLINE&&(h._4e_equals(z,j.block)||h._4e_equals(z,j.blockLimit))))if(!(this.type==
r.STYLE_OBJECT&&!(z._4e_name()in Z)))if(this.checkElementRemovable(z,true))return true}}return false}};G.getStyleText=function(j){var o=j._ST;if(o)return o;o=j.styles;var s=j.attributes&&j.attributes.style||"",z="";if(s.length)s=s.replace(ca,";");for(var A in o){var K=o[A],M=(A+":"+K).replace(ca,";");if(K=="inherit")z+=M;else s+=M}if(s.length)s=c(s);s+=z;return j._ST=s};y.Style=G});
