KISSY.add("editor",function(w,H){function G(n,a){var c=this;if(!(c instanceof G))return new G(n,a);if(w.isString(n))n=w.one(n);n[0]||(n=new Node(n));c.cfg=a;w.app(c,w.EventTarget);c.use=function(g){w.use.call(c,g,function(){c.on("dataReady",function(){c.setData(n.val())})},{order:true,global:G})};c.init(n);return H}function x(n){if(!E)return"build/"+n.replace(/\.(js|css)/i,"-min.$1");if(E==="dev")return n;return"build/"+n}w.app(G,w.EventTarget);G.Config.base=w.Config.base+"editor/";var E=w.Config.debug,
D={htmlparser:{attach:false,path:x("plugins/htmldataprocessor/htmlparser/htmlparser.js")}},v=["utils","focusmanager","definition","dtd","dom","elementpath","walker","range","domiterator","selection","styles"],C=["clipboard",{name:"color",useCss:true},{name:"elementpaths",useCss:true},"enterkey","fakeobjects",{name:"flash",requires:["contextmenu","fakeobjects","overlay"]},"font","format",{name:"htmldataprocessor",requires:["htmlparser-text"]},{name:"image",requires:["overlay"]},"indent","justify",
"link","list","maximize","music","preview","removeformat",{name:"smiley",useCss:true},"sourcearea",{name:"table",useCss:true,requires:["overlay","contextmenu"]},{name:"templates",requires:["overlay"],useCss:true},"undo"],j=[{name:"htmlparser-basicwriter",requires:["htmlparser"]},{name:"htmlparser-element",requires:["htmlparser-fragment"]},{name:"htmlparser-filter",requires:["htmlparser-element"]},{name:"htmlparser-fragment",requires:["htmlparser-htmlwriter"]},{name:"htmlparser-htmlwriter",requires:["htmlparser-basicwriter"]},
{name:"htmlparser-text",requires:["htmlparser-filter"]}],l=[{name:"button"},{name:"overlay",useCss:true},{name:"contextmenu",requires:["overlay"],useCss:true}],t,u,A,y,p;t=0;for(u=l.length;t<u;t++){y=A=l[t];p=H;if(!w.isString(A)){p=A.requires;y=A.name}D[y]={attach:false,requires:p,path:x("ui/"+y+".js"),csspath:A.useCss?x("ui/"+y+".css"):""}}t=0;for(u=C.length;t<u;t++){y=A=C[t];p=["button"];if(!w.isString(A)){A.requires&&(p=p.concat(A.requires));y=A.name}D[y]={attach:false,requires:p,csspath:A.useCss?
x("plugins/"+y+"/plugin.css"):H,path:x("plugins/"+y+"/plugin.js")}}t=0;for(u=j.length;t<u;t++){A=j[t];p=H;if(!w.isString(A)){p=A.requires;A=A.name}D[A]={attach:false,requires:p,path:x("plugins/htmldataprocessor/htmlparser/"+A.substring(11)+".js")}}G.add(D);D={};t=0;for(u=v.length;t<u;t++){A=v[t];D[A]={host:"editor",requires:t>0?v[t-1]:[]}}G.add(D);w.Editor=G});
KISSY.Editor.add("utils",function(w){var H=KISSY,G=H.Node,x=H.DOM,E=H.Config.debug,D=H.UA;w.Utils={debugUrl:function(v){if(!E)return"build/"+v.replace(/\.(js|css)/i,"-min.$1");if(E==="dev")return v;return"build/"+v},lazyRun:function(v,C,j){var l=v[C],t=v[j];v[C]=function(){l.apply(this,arguments);v[C]=v[j];return t.apply(this,arguments)}},getXY:function(v,C,j,l){j=j.defaultView||j.parentWindow;v-=x.scrollLeft(j);C-=x.scrollTop(j);if(l)if(j!=(l.defaultView||l.parentWindow)&&j.frameElement){l=x._4e_getOffset(j.frameElement,
l);v+=l.left;C+=l.top}return{left:v,top:C}},tryThese:function(){for(var v,C=0,j=arguments.length;C<j;C++){var l=arguments[C];try{v=l();break}catch(t){}}return v},arrayCompare:function(v,C){if(!v&&!C)return true;if(!v||!C||v.length!=C.length)return false;for(var j=0;j<v.length;j++)if(v[j]!==C[j])return false;return true},getByAddress:function(v,C,j){v=v.documentElement;for(var l=0;v&&l<C.length;l++){var t=C[l];if(j)for(var u=-1,A=0;A<v.childNodes.length;A++){var y=v.childNodes[A];if(!(j===true&&y.nodeType==
3&&y.previousSibling&&y.previousSibling.nodeType==3)){u++;if(u==t){v=y;break}}}else v=v.childNodes[t]}return v?new G(v):null},clearAllMarkers:function(v){for(var C in v)v[C]._4e_clearMarkers(v,true)},htmlEncodeAttr:function(v){return v.replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/,"&gt;")},ltrim:function(v){return v.replace(/^\s+/,"")},rtrim:function(v){return v.replace(/\s+$/,"")},trim:function(v){return this.ltrim(this.rtrim(v))},mix:function(){for(var v={},C=0;C<arguments.length;C++)v=
H.mix(v,arguments[C]);return v},isCustomDomain:function(){if(!D.ie)return false;var v=document.domain,C=window.location.hostname;return v!=C&&v!="["+C+"]"}}});
KISSY.Editor.add("focusmanager",function(w){function H(){this.iframeFocus=true;C=this}function G(){this.iframeFocus=false;C=null}var x=KISSY,E=x.DOM,D=x.Event;x={};var v={},C;x={refreshAll:function(){for(var j in v){var l=v[j];l.document.designMode="off";l.document.designMode="on"}},currentInstance:function(){return C},getInstance:function(j){return v[j]},add:function(j){var l=E._4e_getWin(j.document);D.on(l,"focus",H,j);D.on(l,"blur",G,j)},register:function(j){v[j._UUID]=j},remove:function(j){delete v[j._UUID];
var l=E._4e_getWin(j.document);D.remove(l,"focus",H,j);D.remove(l,"blur",G,j)}};w.focusManager=x});
KISSY.Editor.add("definition",function(w){function H(p){return l+"<html><head><title>kissy-editor</title><link href='"+w.Config.base+t+"' rel='stylesheet'/></head><body class='ke-editor'>&nbsp;</body><html>"+(p?'<script id="ke_actscrpt" type="text/javascript">'+(w.Utils.isCustomDomain()?'document.domain="'+document.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+p+'");<\/script>':"")}var G=KISSY,x=G.UA,E=G.DOM,D=G.Node,v=G.Event,C=w.focusManager,j=w.Utils.tryThese,l="<!doctype html>",t=
w.Utils.debugUrl("assets/editor-iframe.css"),u=1,A="document.open();"+(w.Utils.isCustomDomain()?'document.domain="'+document.domain+'";':"")+"document.close();",y="<div  class='ke-editor-wrap'  > <div class='"+".ke-editor-tools".substring(1)+"'></div><div class='"+".ke-textarea-wrap".substring(1)+'\'><iframe  style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor"  src="'+(x.ie?"javascript:void(function(){"+encodeURIComponent(A)+"}())":"")+'"  tabIndex="'+
(x.webkit?-1:"$(tabIndex)")+'"  allowTransparency="true" ></iframe></div><div class=\''+".ke-editor-status".substring(1)+"'></div></div>";G.augment(w,{init:function(p){var n=this,a=new D(y.replace(/\$\(tabIndex\)/,p.attr("tabIndex")));a.on("mousedown",function(f){if(x.webkit){var e=E._4e_name(f.target);if(e=="select"||e=="option")return true}f.halt()});n.editorWrap=a;n._UUID=u++;C.register(n);n.wrap=a.one(".ke-textarea-wrap");n.iframe=n.wrap.one("iframe");n.toolBarDiv=a.one(".ke-editor-tools");n.textarea=
p;n.statusDiv=a.one(".ke-editor-status");n.toolBarDiv._4e_unselectable();n._commands={};n._plugins={};var c=p._4e_style("width"),g=p._4e_style("height");if(c){a.css("width",c);p.css("width","100%")}n.textarea.css("display","none");a.insertAfter(p);n.wrap[0].appendChild(p[0]);if(g){n.wrap.css("height",g);p.css("height","100%")}p=n.iframe;n.on("dataReady",function(){n.ready=true;w.fire("instanceCreated",{editor:n})});x.gecko?p.on("load",n._setUpIFrame,n):n._setUpIFrame()},addCommand:function(p,n){this._commands[p]=
n},execCommand:function(p){this.fire("save");this._commands[p].exec(this);this.fire("save")},getData:function(){if(w.HtmlDataProcessor)return w.HtmlDataProcessor.toHtml(this.document.body.innerHTML,"p");return this.document.body.innerHTML},setData:function(p){if(w.HtmlDataProcessor)p=w.HtmlDataProcessor.toDataFormat(p,"p");this.document.body.innerHTML=p},sync:function(){this.textarea.val(this.getData())},_getRawData:function(){return this.document.body.innerHTML},_setRawData:function(p){this.document.body.innerHTML=
p},_hideSource:function(){this.iframe.css("display","");this.textarea.css("display","none");this.toolBarDiv.children().css("visibility","");this.statusDiv.children().css("visibility","")},_showSource:function(){this.textarea.css("display","");this.iframe.css("display","none");this.toolBarDiv.children().css("visibility","hidden");this.toolBarDiv.all(".ke-tool-editor-source").css("visibility","");this.statusDiv.children().css("visibility","hidden");x.ie<8&&this.textarea.css("height",this.wrap.css("height"))},
_prepareIFrameHtml:H,getSelection:function(){var p=new w.Selection(this.document);return!p||p.isInvalid?null:p},focus:function(){var p=E._4e_getWin(this.document);x.webkit&&p&&p.parent&&p.parent.focus();p&&p.focus();this.document&&this.document.body.focus();this.notifySelectionChange()},blur:function(){E._4e_getWin(this.document).blur();this.document&&this.document.body.blur()},_setUpIFrame:function(){function p(){f=g.document;n.document=f;a.detach();f.open("text/html","replace");f.write(c);f.close()}
var n=this,a=n.iframe,c=H(n._UUID),g=a[0].contentWindow,f;try{f=g.document}catch(e){a[0].src=a[0].src;if(x.ie&&x.ie<7){setTimeout(p,10);return}}p()},addPlugin:function(p){this.ready?p():this.on("dataReady",p)},_monitor:function(){var p=this;p._monitorId&&clearTimeout(p._monitorId);p._monitorId=setTimeout(function(){var n=p.getSelection();if(n&&!n.isInvalid){n=n.getStartElement();var a=new w.ElementPath(n);if(!p.previousPath||!p.previousPath.compare(a)){p.previousPath=a;p.fire("selectionChange",{selection:p,
path:a,element:n})}}},200)},notifySelectionChange:function(){this.previousPath=null;this._monitor()},insertElement:function(p){var n=this;n.focus();var a=p._4e_name(),c=w.XHTML_DTD,g=w.RANGE,f=w.NODE,e=c.$block[a],m=n.getSelection(),b=m.getRanges(),d,h,o,i,r;n.fire("save");for(var I=b.length-1;I>=0;I--){d=b[I];d.deleteContents();h=!I&&p||p._4e_clone(true);if(e)for(;(i=d.getCommonAncestor(false,true))&&(r=c[i._4e_name()])&&!(r&&r[a]);)if(i._4e_name()in c.span)d.splitElement(i);else if(d.checkStartOfBlock()&&
d.checkEndOfBlock()){d.setStartBefore(i);d.collapse(true);i._4e_remove()}else d.splitBlock();d.insertNode(h);o||(o=h)}d.moveToPosition(o,g.POSITION_AFTER_END);(p=o._4e_nextSourceNode(true))&&p.type==f.NODE_ELEMENT&&d.moveToElementEditablePosition(p);m.selectRanges([d]);n.focus();h&&h._4e_scrollIntoView();setTimeout(function(){n.fire("save")},10)},insertHtml:function(p){if(w.HtmlDataProcessor)p=w.HtmlDataProcessor.toDataFormat(p);if(x.webkit){p=E.create(p,null,this.document);p=p.nodeType==11?G.makeArray(p.childNodes):
[p];for(var n=0;n<p.length;n++)this.insertElement(new D(p[n]))}else{var a=this;a.focus();a.fire("save");n=a.getSelection();if(x.ie){n=n.getNative();n.type=="Control"&&n.clear();n.createRange().pasteHTML(p)}else a.document.execCommand("inserthtml",false,p);a.focus();setTimeout(function(){a.fire("save")},10)}}});w._initIFrame=function(p){function n(i){j(function(){g.designMode="on";setTimeout(function(){g.designMode="off";e.focus();if(!arguments.callee.retry)arguments.callee.retry=true},50)},function(){g.designMode=
"off";E.attr(e,"contentEditable",false);E.attr(e,"contentEditable",true);!i&&n(1)})}var a=C.getInstance(p);p=a.textarea[0];var c=a.iframe[0].contentWindow,g=a.document,f=g.getElementById("ke_actscrpt");f.parentNode.removeChild(f);var e=g.body;if(x.ie){e.hideFocus=true;e.disabled=true;e.contentEditable=true;e.removeAttribute("disabled")}else setTimeout(function(){if(x.gecko||x.opera)e.contentEditable=true;else if(x.webkit)e.parentNode.contentEditable=true;else g.designMode="on"},0);try{g.execCommand("enableObjectResizing",
false,true)}catch(m){}try{g.execCommand("enableInlineTableEditing",false,true)}catch(b){}x.webkit&&v.on(g,"mousedown",function(i){i=new D(i.target);G.inArray(i._4e_name(),["img","hr","input","textarea","select"])&&a.getSelection().selectElement(i)});if(x.webkit){v.on(g,"click",function(i){var r=new D(i.target);G.inArray(r._4e_name(),["input","select"])&&i.preventDefault()});v.on(g,"mouseup",function(i){var r=new D(i.target);G.inArray(r._4e_name(),["input","textarea"])&&i.preventDefault()})}if(x.gecko||
x.ie||x.opera){var d;d=new D(E.insertAfter((new D('<span style="position:absolute; left:-10000"></span>'))[0],p));d.on("focus",function(){a.focus()});a.on("destroy",function(){})}if(x.ie&&g.compatMode=="CSS1Compat"||x.gecko||x.opera){var h=new D(g.documentElement);h.on("mousedown",function(i){if(i.target===h[0]){x.gecko&&n(false);d[0].focus()}})}v.on(c,"focus",function(){if(x.gecko)n(false);else x.opera&&e.focus();a.notifySelectionChange()});x.gecko&&v.on(a.document,"mousedown",function(){a.iframeFocus||
n(false)});if(x.ie){v.on(g,"keydown",function(i){if(i.keyCode in{8:1,46:1}){var r=a.getSelection(),I=r.getSelectedElement();if(I){a.fire("save");var O=r.getRanges()[0].createBookmark();I._4e_remove();r.selectBookmarks([O]);a.fire("save");i.preventDefault()}}});if(g.compatMode=="CSS1Compat"){var o={33:1,34:1};v.on(g,"keydown",function(i){i.keyCode in o&&setTimeout(function(){a.getSelection().scrollIntoView()},0)})}}setTimeout(function(){x.ie&&setTimeout(function(){if(g){e.runtimeStyle.marginBottom=
"0px";e.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){a.fire("dataReady")},10);C.add(a)};x.gecko&&function(){var p=document.body;if(p){var n=p.getAttribute("onpageshow");p.setAttribute("onpageshow",(n?n+";":"")+"event.persisted && KISSY.Editor.focusManager.refreshAll();")}else window.addEventListener("load",arguments.callee,false)}()});
KISSY.Editor.add("dtd",function(w){w.XHTML_DTD=function(){var H=function(m){for(var b=arguments.length-1;b>0;)KISSY.mix(m,arguments[b--]);return m},G={isindex:1,fieldset:1},x={input:1,button:1,select:1,textarea:1,label:1},E=H({a:1},x),D=H({iframe:1},E),v={hr:1,ul:1,menu:1,div:1,blockquote:1,noscript:1,table:1,center:1,address:1,dir:1,pre:1,h5:1,dl:1,h4:1,noframes:1,h6:1,ol:1,h1:1,h3:1,h2:1},C={ins:1,del:1,script:1,style:1},j=H({b:1,acronym:1,bdo:1,"var":1,"#":1,abbr:1,code:1,br:1,i:1,cite:1,kbd:1,
u:1,strike:1,s:1,tt:1,strong:1,q:1,samp:1,em:1,dfn:1,span:1},C),l=H({sub:1,img:1,object:1,sup:1,basefont:1,map:1,applet:1,font:1,big:1,small:1},j),t=H({p:1},l);x=H({iframe:1},l,x);l={img:1,noscript:1,br:1,kbd:1,center:1,button:1,basefont:1,h5:1,h4:1,samp:1,h6:1,ol:1,h1:1,h3:1,h2:1,form:1,font:1,"#":1,select:1,menu:1,ins:1,abbr:1,label:1,code:1,table:1,script:1,cite:1,input:1,iframe:1,strong:1,textarea:1,noframes:1,big:1,small:1,span:1,hr:1,sub:1,bdo:1,"var":1,div:1,object:1,sup:1,strike:1,dir:1,map:1,
dl:1,applet:1,del:1,isindex:1,fieldset:1,ul:1,b:1,acronym:1,a:1,blockquote:1,i:1,u:1,s:1,tt:1,address:1,q:1,pre:1,p:1,em:1,dfn:1};var u=H({a:1},x),A={tr:1},y={"#":1},p=H({param:1},l),n=H({form:1},G,D,v,t),a={li:1},c={base:1,link:1,meta:1,title:1},g=H(c,{style:1,script:1}),f={head:1,body:1},e={address:1,blockquote:1,center:1,dir:1,div:1,dl:1,fieldset:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,isindex:1,menu:1,noframes:1,ol:1,p:1,pre:1,table:1,ul:1};return{$nonBodyContent:H({html:1},f,c),$block:e,
$blockLimit:{body:1,div:1,td:1,th:1,caption:1,form:1},$inline:u,$body:H({script:1,style:1},e),$cdata:{script:1,style:1},$empty:{area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},$listItem:{dd:1,dt:1,li:1},$list:{ul:1,ol:1,dl:1},$nonEditable:{applet:1,button:1,embed:1,iframe:1,map:1,object:1,option:1,script:1,textarea:1,param:1},$removeEmpty:{abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},$tabIndex:{a:1,area:1,button:1,input:1,object:1,select:1,textarea:1},$tableContent:{caption:1,col:1,colgroup:1,tbody:1,td:1,tfoot:1,th:1,thead:1,tr:1},html:f,head:g,style:y,body:n,base:{},link:{},meta:{},title:y,col:{},tr:{td:1,th:1},img:{},colgroup:{col:1},noscript:n,td:n,br:{},th:n,center:n,kbd:u,button:H(t,v),basefont:{},h5:u,h4:u,samp:u,h6:u,ol:a,h1:u,h3:u,option:y,h2:u,form:H(G,D,v,t),select:{optgroup:1,option:1},font:u,ins:u,menu:a,abbr:u,label:u,table:{thead:1,
col:1,tbody:1,tr:1,colgroup:1,caption:1,tfoot:1},code:u,script:y,tfoot:A,cite:u,li:n,input:{},iframe:n,strong:u,textarea:y,noframes:n,big:u,small:u,span:u,hr:{},dt:u,sub:u,optgroup:{option:1},param:{},bdo:u,"var":u,div:n,object:p,sup:u,dd:n,strike:u,area:{},dir:a,map:H({area:1,form:1,p:1},G,C,v),applet:p,dl:{dt:1,dd:1},del:u,isindex:{},fieldset:H({legend:1},l),thead:A,ul:a,acronym:u,b:u,a:x,blockquote:n,caption:u,i:u,u:u,tbody:A,s:u,address:H(D,t),tt:u,legend:u,q:u,pre:H(j,E),p:u,em:u,dfn:u}}()});
KISSY.Editor.add("dom",function(w){function H(a){return a.replace(/-(\w)/g,function(c,g){return g.toUpperCase()})}var G=KISSY,x=G.DOM,E=G.UA,D=G.Node,v=w.Utils,C={abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};w.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_DOCUMENT_FRAGMENT:11};w.POSITION={};var j=w.NODE,l=w.POSITION;l.POSITION_IDENTICAL=0;l.POSITION_DISCONNECTED=1;l.POSITION_FOLLOWING=
2;l.POSITION_PRECEDING=4;l.POSITION_IS_CONTAINED=8;l.POSITION_CONTAINS=16;var t={},u={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},A={hr:1},y=function(a){return a[0]||a},p=function(a){if(!a[0])return new D(a);return a},n={_4e_equals:function(a,c){if(!a&&!c)return true;if(!a||!c)return false;a=y(a);c=y(c);return a===c},_4e_isBlockBoundary:function(a,c){a=p(a);c=
G.mix(G.mix({},A),c||{});return u[a.css("display")]||c[a._4e_name()]},_4e_getWin:function(a){return a&&"scrollTo"in a&&a.document?a:a&&a.nodeType===9?a.defaultView||a.parentWindow:false},_4e_index:function(a){a=y(a);for(var c=a.parentNode.childNodes,g=0;g<c.length;g++)if(c[g]===a)return g;return-1},_4e_first:function(a,c){a=y(a);if((a=(a=a.firstChild)&&new D(a))&&c&&!c(a))a=a._4e_next(c);return a},_4e_move:function(a,c,g){a._4e_remove();a=y(a);c=y(c);g?c.insertBefore(a,c.firstChild):c.appendChild(a)},
_4e_name:function(a){a=y(a);var c=a.nodeName.toLowerCase();if(E.ie)if((a=a.scopeName)&&a!="HTML")c=a.toLowerCase()+":"+c;return c},_4e_isIdentical:function(a,c){if(a._4e_name()!=c._4e_name())return false;var g=a[0].attributes,f=c[0].attributes,e=g.length,m=f.length;if(!E.ie&&e!=m)return false;for(var b=0;b<e;b++){var d=g[b];if((!E.ie||d.specified&&d.nodeName!="_ke_expando")&&d.nodeValue!=c.attr(d.nodeName))return false}if(E.ie)for(b=0;b<m;b++){d=f[b];if(d.specified&&d.nodeName!="_ke_expando"&&d.nodeValue!=
a.attr(d.nodeName))return false}return true},_4e_isEmptyInlineRemoveable:function(a){a=y(a).childNodes;for(var c=0,g=a.length;c<g;c++){var f=a[c],e=f.nodeType;if(!(e==j.NODE_ELEMENT&&f.getAttribute("_ke_bookmark")))if(e==j.NODE_ELEMENT&&!n._4e_isEmptyInlineRemoveable(f)||e==j.NODE_TEXT&&G.trim(f.nodeValue))return false}return true},_4e_moveChildren:function(a,c,g){a=y(a);c=c[0]||c;if(a!=c)if(g)for(;g=a.lastChild;)c.insertBefore(a.removeChild(g),c.firstChild);else for(;g=a.firstChild;)c.appendChild(a.removeChild(g))},
_4e_mergeSiblings:function(){function a(c,g,f){if(g[0]&&g[0].nodeType==j.NODE_ELEMENT){for(var e=[];g.attr("_ke_bookmark")||g._4e_isEmptyInlineRemoveable();){e.push(g);g=f?new D(g[0].nextSibling):new D(g[0].previousSibling);if(!g[0]||g[0].nodeType!=j.NODE_ELEMENT)return}if(c._4e_isIdentical(g)){for(var m=f?c[0].lastChild:c[0].firstChild;e.length;)e.shift()._4e_move(c,!f);g._4e_moveChildren(c,!f);g._4e_remove();m[0]&&m[0].nodeType==j.NODE_ELEMENT&&m._4e_mergeSiblings()}}}return function(c){if(c[0])if(C[c._4e_name()]||
c._4e_name()=="a"){a(c,new D(c[0].nextSibling),true);a(c,new D(c[0].previousSibling))}}}(),_4e_unselectable:E.gecko?function(a){a=y(a);a.style.MozUserSelect="none"}:E.webkit?function(a){a=y(a);a.style.KhtmlUserSelect="none"}:function(a){a=y(a);if(E.ie||E.opera){var c,g=0;for(a.unselectable="on";c=a.all[g++];)switch(c.tagName.toLowerCase()){case "iframe":case "textarea":case "input":case "select":break;default:c.unselectable="on"}}},_4e_getOffset:function(a,c){a=y(a);var g,f=0;g=0;var e=a.ownerDocument.defaultView||
a.ownerDocument.parentWindow,m=a.ownerDocument,b=m.documentElement;if(a.getBoundingClientRect){if(a!==m.body&&b!==a){g=a.getBoundingClientRect();f=g.left+x.scrollLeft(e);g=g.top+x.scrollTop(e)}if(c)if(e!=(c.defaultView||c.parentWindow)&&e.frameElement){c=n._4e_getOffset(e.frameElement,c);f+=c.left;g+=c.top}}return{left:f,top:g}},_4e_getFrameDocument:function(a){return(a=y(a))&&a.contentWindow.document},_4e_splitText:function(a,c){a=y(a);var g=a.ownerDocument;if(!(!a||a.nodeType!=j.NODE_TEXT)){if(E.ie&&
c==a.nodeValue.length){g=g.createTextNode("");x.insertAfter(g,a);return g}a=new D(a.splitText(c));if(E.ie==8){g=g.createTextNode("");x.insertAfter(g,a[0]);g.parentNode.removeChild(g)}return a}},_4e_parents:function(a,c){a=p(a);var g=[];do g[c?"push":"unshift"](a);while(a=a.parent());return g},_4e_clone:function(a,c,g){a=y(a);a=a.cloneNode(c);if(!g){var f=function(e){if(e.nodeType==j.NODE_ELEMENT){e.removeAttribute("id",false);e.removeAttribute("_ke_expando",false);e=e.childNodes;for(var m=0;m<e.length;m++)f(e[m])}};
f(a)}return new D(a)},_4e_nextSourceNode:function(a,c,g,f){a=y(a);if(f&&!f.call){var e=f[0]||f;f=function(b){b=b[0]||b;return b!==e}}c=!c&&a.firstChild;var m=new D(a);if(!c){if(a.nodeType==j.NODE_ELEMENT&&f&&f(this,true)===false)return null;c=a.nextSibling}for(;!c&&(m=m.parent());){if(f&&f(m,true)===false)return null;c=m[0].nextSibling}if(!c)return null;c=new D(c);if(f&&f(c)===false)return null;if(g&&g!=c[0].nodeType)return c._4e_nextSourceNode(false,g,f);return c},_4e_previousSourceNode:function(a,
c,g,f){a=y(a);if(f&&!f.call){var e=f[0]||f;f=function(b){b=b[0]||b;return b!==e}}c=!c&&a.lastChild;var m=new D(a);if(!c){if(a.nodeType==j.NODE_ELEMENT&&f&&f(a,true)===false)return null;c=a.previousSibling}for(;!c&&(m=m.parent());){if(f&&f(m,true)===false)return null;c=m[0].previousSibling}if(!c)return null;c=new D(c);if(f&&f(c)===false)return null;if(g&&c[0].nodeType!=g)return c._4e_previousSourceNode(false,g,f);return c},_4e_contains:E.ie||E.webkit?function(a,c){a=y(a);c=y(c);return c.nodeType!=
j.NODE_ELEMENT?a.contains(c.parentNode):a!=c&&a.contains(c)}:function(a,c){a=y(a);c=y(c);return!!(a.compareDocumentPosition(c)&16)},_4e_commonAncestor:function(a,c){if(a._4e_equals(c))return a;if(c[0].nodeType!=j.NODE_TEXT&&c._4e_contains(a))return c;a=a[0].nodeType==j.NODE_TEXT?a.parent():a;do if(a[0].nodeType!=j.NODE_TEXT&&a._4e_contains(c))return a;while(a=a.parent());return null},_4e_ascendant:function(a,c,g){a=y(a);if(!g)a=a.parentNode;if(c&&!G.isFunction(c)){var f=c;c=function(e){return e._4e_name()==
f}}for(;a&&a.nodeType!=9;){if(!c||c(new D(a))===true)return new D(a);a=a.parentNode}return null},_4e_hasAttribute:function(a,c){a=y(a);a=a.attributes.getNamedItem(c);return!!(a&&a.specified)},_4e_hasAttributes:E.ie?function(a){a=y(a);for(var c=a.attributes,g=0;g<c.length;g++){var f=c[g];switch(f.nodeName){case "class":if(a.getAttribute("class"))return true;break;case "_ke_expando":continue;default:if(f.specified)return true}}return false}:function(a){a=y(a);E.gecko&&a.removeAttribute("_moz_dirty");
a=a.attributes;return a.length>1||a.length==1&&a[0].nodeName!="_ke_expando"},_4e_position:function(a,c){var g=y(a),f=y(c);if(g.compareDocumentPosition)return g.compareDocumentPosition(f);if(g==f)return l.POSITION_IDENTICAL;if(g.nodeType==j.NODE_ELEMENT&&f.nodeType==j.NODE_ELEMENT){if(g.contains){if(g.contains(f))return l.POSITION_CONTAINS+l.POSITION_PRECEDING;if(f.contains(g))return l.POSITION_IS_CONTAINED+l.POSITION_FOLLOWING}if("sourceIndex"in g)return g.sourceIndex<0||f.sourceIndex<0?l.POSITION_DISCONNECTED:
g.sourceIndex<f.sourceIndex?l.POSITION_PRECEDING:l.POSITION_FOLLOWING}a=a._4e_address();c=c._4e_address();g=Math.min(a.length,c.length);for(f=0;f<=g-1;f++)if(a[f]!=c[f]){if(f<g)return a[f]<c[f]?l.POSITION_PRECEDING:l.POSITION_FOLLOWING;break}return a.length<c.length?l.POSITION_CONTAINS+l.POSITION_PRECEDING:l.POSITION_IS_CONTAINED+l.POSITION_FOLLOWING},_4e_address:function(a,c){a=y(a);var g=[],f=a.ownerDocument.documentElement;for(a=a;a&&a!=f;){var e=a.parentNode,m=-1;if(e){for(var b=0;b<e.childNodes.length;b++){var d=
e.childNodes[b];if(!(c&&d.nodeType==3&&d.previousSibling&&d.previousSibling.nodeType==3)){m++;if(d==a)break}}g.unshift(m)}a=e}return g},_4e_breakParent:function(a,c){var g=new w.Range(a[0].ownerDocument);g.setStartAfter(a);g.setEndAfter(c);c=g.extractContents();g.insertNode(a._4e_remove());a[0].parentNode.insertBefore(c,a[0].nextSibling)},_4e_style:function(a,c,g){if(g!==undefined)return a.css(c,g);a=a[0]||a;return a.style[H(c)]},_4e_remove:function(a,c){var g=y(a),f=g.parentNode;if(f){if(c)for(;c=
g.firstChild;)f.insertBefore(g.removeChild(c),g);f.removeChild(g)}return a},_4e_trim:function(a){x._4e_ltrim(a);x._4e_rtrim(a)},_4e_ltrim:function(a){a=y(a);for(var c;c=a.firstChild;){if(c.nodeType==j.NODE_TEXT){var g=v.ltrim(c.nodeValue),f=c.nodeValue.length;if(g){if(g.length<f){(new D(c))._4e_splitText(f-g.length);a.removeChild(a.firstChild)}}else{a.removeChild(c);continue}}break}},_4e_rtrim:function(a){a=y(a);for(var c;c=a.lastChild;){if(c.type==j.NODE_TEXT){var g=v.rtrim(c.nodeValue),f=c.nodeValue.length;
if(g){if(g.length<f){(new D(c))._4e_splitText(g.length);a.removeChild(a.lastChild)}}else{a.removeChild(c);continue}}break}if(!E.ie&&!E.opera)(c=a.lastChild)&&c.nodeType==1&&c.nodeName.toLowerCase()=="br"&&c.parentNode.removeChild(c)},_4e_appendBogus:function(a){a=y(a);for(var c=a.lastChild;c&&c.nodeType==j.NODE_TEXT&&!G.trim(c.nodeValue);)c=c.previousSibling;if(!c||c.nodeType==j.NODE_TEXT||x._4e_name(c)!=="br"){c=E.opera?a.ownerDocument.createTextNode(""):a.ownerDocument.createElement("br");E.gecko&&
c.setAttribute("type","_moz");a.appendChild(c)}},_4e_previous:function(a,c){a=y(a);var g;do g=(a=a.previousSibling)&&new D(a);while(g&&c&&!c(g));return g},_4e_last:function(a,c){if((a=(a=a[0].lastChild)&&new D(a))&&c&&!c(a))a=a._4e_previous(c);return a},_4e_next:function(a,c){a=y(a);var g;do g=(a=a.nextSibling)&&new D(a);while(g&&c&&!c(g));return g},_4e_outerHtml:function(a){a=y(a);if(a.outerHTML)return a.outerHTML.replace(/<\?[^>]*>/,"");var c=a.ownerDocument.createElement("div");c.appendChild(a.cloneNode(true));
return c.innerHTML},_4e_setMarker:function(a,c,g,f){a[0]||(a=new D(a));var e=a._4e_getData("list_marker_id")||a._4e_setData("list_marker_id",G.guid())._4e_getData("list_marker_id"),m=a._4e_getData("list_marker_names")||a._4e_setData("list_marker_names",{})._4e_getData("list_marker_names");c[e]=a;m[g]=1;return a._4e_setData(g,f)},_4e_clearMarkers:function(a,c,g){a=p(a);var f=a._4e_getData("list_marker_names"),e=a._4e_getData("list_marker_id");for(var m in f)a._4e_removeData(m);a._4e_removeData("list_marker_names");
if(g){a._4e_removeData("list_marker_id");delete c[e]}},_4e_setData:function(a,c,g){var f=x._4e_getUniqueId(a);(t[f]||(t[f]={}))[c]=g;return a},_4e_getData:function(a,c){a=y(a);return(a=(a=a.getAttribute("_ke_expando"))&&t[a])&&a[c]},_4e_removeData:function(a,c){a=y(a);var g=a.getAttribute("_ke_expando");var f=(g=g&&t[g])&&g[c];typeof f!="undefined"&&g&&delete g[c];G.isEmptyObject(g)&&x._4e_clearData(a);return f||null},_4e_clearData:function(a){a=y(a);var c=a.getAttribute("_ke_expando");c&&delete t[c];
c&&a.removeAttribute("_ke_expando")},_4e_getUniqueId:function(a){a=y(a);var c=a.getAttribute("_ke_expando");if(c)return c;c=G.guid();a.setAttribute("_ke_expando",c);return c},_4e_copyAttributes:function(a,c,g){a=y(a);var f=a.attributes;g=g||{};for(var e=0;e<f.length;e++){var m=f[e],b=m.nodeName.toLowerCase(),d;if(!(b in g))if(b=="checked"&&(d=x.attr(a,b)))c.attr(b,d);else if(m.specified||E.ie&&m.nodeValue&&b=="value"){d=x.attr(a,b);if(d===null)d=m.nodeValue;c.attr(b,d)}}if(a.style.cssText!=="")c[0].style.cssText=
a.style.cssText},_4e_isEditable:function(a){a=x._4e_name(a);var c=w.XHTML_DTD;return(a=!c.$nonEditable[a]&&(c[a]||c.span))&&a["#"]},_4e_scrollIntoView:function(a){a=p(a);var c=a[0].ownerDocument,g=x.scrollLeft(c),f=x.scrollTop(c),e=a.offset(),m=e.left;e=e.top;if(x.viewportHeight(c)+f<e||e<f||x.viewportWidth(c)+g<m||m<g)a.scrollIntoView(c)},_4e_getElementsByTagName:function(a,c,g){a=y(a);if(!E.ie&&g)c=g+":"+c;g=[];a=a.getElementsByTagName(c);for(c=0;c<a.length;c++)g.push(new D(a[c]));return g}};G.DOM._4e_inject=
function(a){G.mix(x,a);for(var c in a)a.hasOwnProperty(c)&&function(g){D.prototype[g]=function(){var f=[].slice.call(arguments,0);f.unshift(this);return a[g].apply(null,f)}}(c)};G.DOM._4e_inject(n)});
KISSY.Editor.add("elementpath",function(w){function H(t){var u=null,A=null,y=[];for(t=t;t&&t[0];){if(t[0].nodeType==D.NODE_ELEMENT){if(!this.lastElement)this.lastElement=t;var p=t._4e_name();if(v.ie&&t[0].scopeName!="HTML")p=t[0].scopeName.toLowerCase()+":"+p;if(!A){if(!u&&C[p])u=t;if(j[p])if(!u&&p=="div"&&!l(t))u=t;else A=t}y.push(t);if(p=="body")break}t=t.parent()}this.block=u;this.blockLimit=A;this.elements=y}var G=KISSY,x=G.DOM,E=w.XHTML_DTD,D=w.NODE,v=G.UA,C={address:1,blockquote:1,dl:1,h1:1,
h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},j={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1},l=function(t){t=t[0]||t;t=t.childNodes;for(var u=0,A=t.length;u<A;u++){var y=t[u];if(y.nodeType==D.NODE_ELEMENT&&E.$block[y.nodeName.toLowerCase()])return true}return false};H.prototype={compare:function(t){var u=this.elements;t=t&&t.elements;if(!t||u.length!=t.length)return false;for(var A=0;A<u.length;A++)if(!x._4e_equals(u[A],t[A]))return false;return true},contains:function(t){for(var u=
this.elements,A=0;A<u.length;A++)if(u[A]._4e_name()in t)return u[A];return null}};w.ElementPath=H});
KISSY.Editor.add("walker",function(w){function H(j,l){if(this._.end)return null;var t=this.range,u,A=this.guard,y=this.type,p=j?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start){this._.start=1;t.trim();if(t.collapsed){this.end();return null}}if(!j&&!this._.guardLTR){var n=t.endContainer,a=new C(n[0].childNodes[t.endOffset]);this._.guardLTR=function(e,m){return(!m||!v._4e_equals(n,e))&&(!a[0]||e[0]!==a[0])&&(e[0].nodeType!=D.NODE_ELEMENT||!m||e._4e_name()!="body")}}if(j&&!this._.guardRTL){var c=
t.startContainer,g=t.startOffset>0&&new C(c[0].childNodes[t.startOffset-1]);this._.guardRTL=function(e,m){return e&&e[0]&&(!m||c[0]!==e[0])&&(!g[0]||e[0]!==g[0])&&(e[0].nodeType!=D.NODE_ELEMENT||!m||e._4e_name()!="body")}}var f=j?this._.guardRTL:this._.guardLTR;u=A?function(e,m){if(f(e,m)===false)return false;return A(e,m)}:f;if(this.current)j=this.current[p](false,y,u);else if(j){j=t.endContainer;if(t.endOffset>0){j=new C(j[0].childNodes[t.endOffset-1]);if(u(j)===false)j=null}else j=u(j,true)===
false?null:j._4e_previousSourceNode(true,y,u)}else{j=t.startContainer;if((j=new C(j[0].childNodes[t.startOffset]))&&j[0]){if(u(j)===false)j=null}else j=u(t.startContainer,true)===false?null:t.startContainer._4e_nextSourceNode(true,y,u)}for(;j&&j[0]&&!this._.end;){this.current=j;if(!this.evaluator||this.evaluator(j)!==false){if(!l)return j}else if(l&&this.evaluator)return false;j=j[p](false,y,u)}this.end();return this.current=null}function G(j){for(var l,t=null;l=H.call(this,j);)t=l;return t}function x(j){this.range=
j;this._={}}var E=KISSY,D=w.NODE,v=E.DOM,C=E.Node;E.augment(x,{end:function(){this._.end=1},next:function(){return H.call(this)},previous:function(){return H.call(this,true)},checkForward:function(){return H.call(this,false,true)!==false},checkBackward:function(){return H.call(this,true,true)!==false},lastForward:function(){return G.call(this)},lastBackward:function(){return G.call(this,true)},reset:function(){delete this.current;this._={}}});x.blockBoundary=function(j){return function(l){l[0]||(l=
new C(l));return!(l[0].nodeType==D.NODE_ELEMENT&&l._4e_isBlockBoundary(j))}};x.listItemBoundary=function(){return this.blockBoundary({br:1})};x.bookmark=function(j,l){function t(u){return u&&u[0]&&u._4e_name()=="span"&&u.attr("_ke_bookmark")}return function(u){var A,y;A=u&&u[0]&&u[0].nodeType==D.NODE_TEXT&&(y=u.parent())&&t(y);A=j?A:A||t(u);return l^A}};x.whitespaces=function(j){return function(l){l=(l=l[0]||l)&&l.nodeType==D.NODE_TEXT&&!E.trim(l.nodeValue);return j^l}};x.invisible=function(j){var l=
x.whitespaces();return function(t){t=l(t)||t[0].nodeType==D.NODE_ELEMENT&&!t[0].offsetHeight;return j^t}};w.Walker=x});
KISSY.Editor.add("range",function(w){function H(b){this.endOffset=this.endContainer=this.startOffset=this.startContainer=null;this.collapsed=true;this.document=b}function G(b){var d=b[0].nodeType!=j.NODE_TEXT&&b._4e_name()in n.$removeEmpty,h=!C.trim(b[0].nodeValue);b=!!b.parent().attr("_ke_bookmark");return d||h||b}function x(b){return!e(b)&&!m(b)}function E(b){var d=false,h=u.bookmark(true);return function(o){if(h(o))return true;if(o[0].nodeType==j.NODE_TEXT){if(C.trim(o[0].nodeValue).length)return false}else if(o[0].nodeType==
j.NODE_ELEMENT)if(!f[o._4e_name()])if(!b&&!p.ie&&o._4e_name()=="br"&&!d)d=true;else return false;return true}}function D(b,d){function h(o){return o&&o.nodeName=="span"&&o.getAttribute("_ke_bookmark")}return function(o){var i,r;i=o&&!o.nodeName&&(r=o.parentNode)&&h(r);i=b?i:i||h(o);return d^i}}function v(b){return function(d){d=(d=d[0]||d)&&d.nodeType==j.NODE_TEXT&&!C.trim(d.nodeValue);return b^d}}w.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,
ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,STARTEND:3,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var C=KISSY,j=w.NODE,l=w.RANGE,t=w.POSITION,u=w.Walker,A=C.DOM,y=w.Utils.getByAddress,p=C.UA,n=w.XHTML_DTD,a=w.ElementPath,c=C.Node,g={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1};H.prototype.toString=function(){var b=[];b.push((this.startContainer[0].id||this.startContainer[0].nodeName)+":"+this.startOffset);b.push((this.endContainer[0].id||this.endContainer[0].nodeName)+
":"+this.endOffset);return b.join("<br/>")};C.augment(H,{updateCollapsed:function(){this.collapsed=this.startContainer&&this.endContainer&&A._4e_equals(this.startContainer,this.endContainer)&&this.startOffset==this.endOffset},optimize:function(){var b=this.startContainer,d=this.startOffset;if(b[0].nodeType!=j.NODE_ELEMENT)if(d)d>=b[0].nodeValue.length&&this.setStartAfter(b);else this.setStartBefore(b);b=this.endContainer;d=this.endOffset;if(b[0].nodeType!=j.NODE_ELEMENT)if(d)d>=b[0].nodeValue.length&&
this.setEndAfter(b);else this.setEndBefore(b)},setStartAfter:function(b){this.setStart(b.parent(),b._4e_index()+1)},setStartBefore:function(b){this.setStart(b.parent(),b._4e_index())},setEndAfter:function(b){this.setEnd(b.parent(),b._4e_index()+1)},setEndBefore:function(b){this.setEnd(b.parent(),b._4e_index())},optimizeBookmark:function(){var b=this.startContainer,d=this.endContainer;b&&b._4e_name()=="span"&&b.attr("_ke_bookmark")&&this.setStartAt(b,l.POSITION_BEFORE_START);d&&d._4e_name()=="span"&&
d.attr("_ke_bookmark")&&this.setEndAt(d,l.POSITION_AFTER_END)},setStart:function(b,d){if(b[0].nodeType==j.NODE_ELEMENT&&g[b._4e_name()]){b=b.parent();d=b._4e_index()}this.startContainer=b;this.startOffset=d;if(!this.endContainer){this.endContainer=b;this.endOffset=d}this.updateCollapsed()},setEnd:function(b,d){if(b[0].nodeType==j.NODE_ELEMENT&&g[b._4e_name()]){b=b.parent();d=b._4e_index()+1}this.endContainer=b;this.endOffset=d;if(!this.startContainer){this.startContainer=b;this.startOffset=d}this.updateCollapsed()},
setStartAt:function(b,d){switch(d){case l.POSITION_AFTER_START:this.setStart(b,0);break;case l.POSITION_BEFORE_END:b[0].nodeType==j.NODE_TEXT?this.setStart(b,b[0].nodeValue.length):this.setStart(b,b[0].childNodes.length);break;case l.POSITION_BEFORE_START:this.setStartBefore(b);break;case l.POSITION_AFTER_END:this.setStartAfter(b)}this.updateCollapsed()},setEndAt:function(b,d){switch(d){case l.POSITION_AFTER_START:this.setEnd(b,0);break;case l.POSITION_BEFORE_END:b[0].nodeType==j.NODE_TEXT?this.setEnd(b,
b[0].nodeValue.length):this.setEnd(b,b[0].childNodes.length);break;case l.POSITION_BEFORE_START:this.setEndBefore(b);break;case l.POSITION_AFTER_END:this.setEndAfter(b)}this.updateCollapsed()},execContentsAction:function(b,d){var h=this.startContainer,o=this.endContainer,i=this.startOffset,r=this.endOffset,I,O;this.optimizeBookmark();if(o[0].nodeType==j.NODE_TEXT)o=o._4e_splitText(r);else if(o[0].childNodes.length>0)if(r>=o[0].childNodes.length){o=new c(o[0].appendChild(this.document.createTextNode("")));
O=true}else o=new c(o[0].childNodes[r]);if(h[0].nodeType==j.NODE_TEXT){h._4e_splitText(i);if(A._4e_equals(h,o))o=new c(h[0].nextSibling)}else if(i)if(i>=h[0].childNodes.length){I=new c(this.document.createTextNode(""));h[0].appendChild(I[0]);h=I;I=true}else h=new c(h[0].childNodes[i].previousSibling);else{I=new c(this.document.createTextNode(""));A.insertBefore(I[0],h[0].firstChild);h=I;I=true}i=h._4e_parents();r=o._4e_parents();var F,J,L;for(F=0;F<i.length;F++){J=i[F];L=r[F];if(J[0]!==L[0])break}for(var P=
d,N,S,Y,Z=F;Z<i.length;Z++){N=i[Z];if(P&&N[0]!==h[0])S=P.appendChild(N._4e_clone()[0]);for(N=N[0].nextSibling;N;){if(r[Z]&&N==r[Z][0]||N==o[0])break;Y=N.nextSibling;if(b==2)P.appendChild(N.cloneNode(true));else{N.parentNode.removeChild(N);b==1&&P.appendChild(N)}N=Y}if(S)P=S}P=d;for(d=F;d<r.length;d++){N=r[d];if(b>0&&N[0]!==o[0])S=P.appendChild(N._4e_clone()[0]);if(!i[d]||N[0].parentNode!==i[d][0].parentNode)for(N=N[0].previousSibling;N;){if(i[d]&&N==i[d][0]||N===h[0])break;Y=N.previousSibling;if(b==
2)P.insertBefore(N.cloneNode(true),P.firstChild);else{N.parentNode.removeChild(N);b==1&&P.insertBefore(N,P.firstChild)}N=Y}if(S)P=S}if(b==2){L=this.startContainer[0];if(L.nodeType==j.NODE_TEXT&&L.nextSibling&&L.nextSibling.nodeType==j.NODE_TEXT){L.data+=L.nextSibling.data;L.parentNode.removeChild(L.nextSibling)}L=this.endContainer[0];if(L.nodeType==j.NODE_TEXT&&L.nextSibling&&L.nextSibling.nodeType==j.NODE_TEXT){L.data+=L.nextSibling.data;L.parentNode.removeChild(L.nextSibling)}}else{if(J&&L&&(h[0].parentNode!=
J[0].parentNode||o[0].parentNode!=L[0].parentNode)){b=L._4e_index();I&&L[0].parentNode==h[0].parentNode&&b--;this.setStart(L.parent(),b)}this.collapse(true)}I&&h._4e_remove();O&&o[0].parentNode&&o._4e_remove()},collapse:function(b){if(b){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=this.endOffset}this.collapsed=true},clone:function(){var b=new H(this.document);b.startContainer=this.startContainer;b.startOffset=this.startOffset;
b.endContainer=this.endContainer;b.endOffset=this.endOffset;b.collapsed=this.collapsed;return b},getEnclosedNode:function(){var b=this.clone();b.optimize();if(b.startContainer[0].nodeType!=j.NODE_ELEMENT||b.endContainer[0].nodeType!=j.NODE_ELEMENT)return null;b=b.startContainer[0].childNodes[b.startOffset];for(var d=D(true,undefined),h=v(true),o=function(i){return h(i)&&d(i)};b&&o(b);)b=(new c(b))._4e_nextSourceNode()[0];return new c(b)},shrink:function(b,d){if(!this.collapsed){b=b||l.SHRINK_TEXT;
var h=this.clone(),o=this.startContainer,i=this.endContainer,r=this.startOffset,I=this.endOffset,O=1,F=1;if(o&&o[0].nodeType==j.NODE_TEXT)if(r)if(r>=o[0].nodeValue.length)h.setStartAfter(o);else{h.setStartBefore(o);O=0}else h.setStartBefore(o);if(i&&i[0].nodeType==j.NODE_TEXT)if(I)if(I>=i[0].nodeValue.length)h.setEndAfter(i);else{h.setEndAfter(i);F=0}else h.setEndBefore(i);h=new u(h);h.evaluator=function(L){L=L[0]||L;return L.nodeType==(b==l.SHRINK_ELEMENT?j.NODE_ELEMENT:j.NODE_TEXT)};var J;h.guard=
function(L,P){L=L[0]||L;if(b==l.SHRINK_ELEMENT&&L.nodeType==j.NODE_TEXT)return false;if(P&&L==J)return false;if(!P&&L.nodeType==j.NODE_ELEMENT)J=L;return true};if(O)(o=h[b==l.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(o,d?l.POSITION_AFTER_START:l.POSITION_BEFORE_START);if(F){h.reset();(h=h[b==l.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(h,d?l.POSITION_BEFORE_END:l.POSITION_AFTER_END)}return!!(O||F)}},getTouchedStartNode:function(){var b=this.startContainer;if(this.collapsed||
b[0].nodeType!=j.NODE_ELEMENT)return b;return b.childNodes[this.startOffset]||b},createBookmark2:function(b){var d=this.startContainer,h=this.endContainer,o=this.startOffset,i=this.endOffset,r,I;if(!d||!h)return{start:0,end:0};if(b){if(d[0].nodeType==j.NODE_ELEMENT)if((r=new c(d[0].childNodes[o]))&&r[0]&&r[0].nodeType==j.NODE_TEXT&&o>0&&r[0].previousSibling.nodeType==j.NODE_TEXT){d=r;o=0}for(;d[0].nodeType==j.NODE_TEXT&&(I=d._4e_previous())&&I[0].nodeType==j.NODE_TEXT;){d=I;o+=I[0].nodeValue.length}if(!this.collapsed){if(h[0].nodeType==
j.NODE_ELEMENT)if((r=new c(h[0].childNodes[i]))&&r[0]&&r[0].nodeType==j.NODE_TEXT&&i>0&&r[0].previousSibling.nodeType==j.NODE_TEXT){h=r;i=0}for(;h[0].nodeType==j.NODE_TEXT&&(I=h._4e_previous())&&I[0].nodeType==j.NODE_TEXT;){h=I;i+=I[0].nodeValue.length}}}return{start:d._4e_address(b),end:this.collapsed?null:h._4e_address(b),startOffset:o,endOffset:i,normalized:b,is2:true}},createBookmark:function(b){var d,h,o,i;d=new c("<span></span>",null,this.document);d.attr("_ke_bookmark",1);d.css("display","none");
d.html("&nbsp;");if(b){o=C.guid("ke_bm_");d.attr("id",o+"S")}if(!this.collapsed){h=d._4e_clone();h.html("&nbsp;");b&&h.attr("id",o+"E");i=this.clone();i.collapse();i.insertNode(h)}i=this.clone();i.collapse(true);i.insertNode(d);if(h){this.setStartAfter(d);this.setEndBefore(h)}else this.moveToPosition(d,l.POSITION_AFTER_END);return{startNode:b?o+"S":d,endNode:b?o+"E":h,serializable:b}},moveToPosition:function(b,d){this.setStartAt(b,d);this.collapse(true)},trim:function(b,d){var h=this.startContainer,
o=this.startOffset,i=this.collapsed;if((!b||i)&&h[0]&&h[0].nodeType==j.NODE_TEXT){if(o)if(o>=h[0].nodeValue.length){o=h._4e_index()+1;h=h.parent()}else{b=h._4e_splitText(o);o=h._4e_index()+1;h=h.parent();if(A._4e_equals(this.startContainer,this.endContainer))this.setEnd(b,this.endOffset-this.startOffset);else if(A._4e_equals(h,this.endContainer))this.endOffset+=1}else{o=h._4e_index();h=h.parent()}this.setStart(h,o);if(i){this.collapse(true);return}}h=this.endContainer;o=this.endOffset;if(!(d||i)&&
h[0]&&h[0].nodeType==j.NODE_TEXT){if(o){o>=h.nodeValue.length||h._4e_splitText(o);o=h._4e_index()+1}else o=h._4e_index();h=h.parent();this.setEnd(h,o)}},insertNode:function(b){this.optimizeBookmark();this.trim(false,true);var d=this.startContainer,h=d[0].childNodes[this.startOffset];this.optimizeBookmark();this.trim(false,true);h?A.insertBefore(b[0]||b,h):d[0].appendChild(b[0]||b);A._4e_equals(b.parent(),this.endContainer)&&this.endOffset++;this.setStartBefore(b)},moveToBookmark:function(b){if(b.is2){var d=
y(this.document,b.start,b.normalized),h=b.startOffset,o=b.end&&y(this.document,b.end,b.normalized);b=b.endOffset;this.setStart(d,h);o?this.setEnd(o,b):this.collapse(true)}else{d=(h=b.serializable)?C.one("#"+b.startNode,this.document):b.startNode;b=h?C.one("#"+b.endNode,this.document):b.endNode;this.setStartBefore(d);d._4e_remove();if(b&&b[0]){this.setEndBefore(b);b._4e_remove()}else this.collapse(true)}},getCommonAncestor:function(b,d){var h=this.startContainer,o=this.endContainer;b=A._4e_equals(h,
o)?b&&h[0].nodeType==j.NODE_ELEMENT&&this.startOffset==this.endOffset-1?new c(h[0].childNodes[this.startOffset]):h:h._4e_commonAncestor(o);return d&&b[0].nodeType==j.NODE_TEXT?b.parent():b},enlarge:function(b){switch(b){case l.ENLARGE_ELEMENT:if(this.collapsed)return;b=this.getCommonAncestor();var d=new c(this.document.body),h,o,i,r,I,O=false,F,J;F=this.startContainer;J=this.startOffset;if(F[0].nodeType==j.NODE_TEXT){if(J){F=!C.trim(F[0].nodeValue.substring(0,J)).length&&F;O=!!F}if(F)if(!(r=F[0].previousSibling))i=
F.parent()}else{if(J)r=F[0].childNodes[J-1]||F[0].lastChild;r||(i=F)}for(;i||r;){if(i&&!r){if(!I&&A._4e_equals(i,b))I=true;if(!d._4e_contains(i))break;if(!O||i.css("display")!="inline"){O=false;if(I)h=i;else this.setStartBefore(i)}r=i[0].previousSibling}for(;r;){F=false;if(r.nodeType==j.NODE_TEXT){J=r.nodeValue;if(/[^\s\ufeff]/.test(J))r=null;F=/[\s\ufeff]$/.test(J)}else if(r.offsetWidth>0&&!r.getAttribute("_ke_bookmark"))if(O&&n.$removeEmpty[r.nodeName.toLowerCase()]){J=A.text(r);if(/[^\s\ufeff]/.test(J))r=
null;else for(var L=r.all||r.getElementsByTagName("*"),P=0,N;N=L[P++];)if(!n.$removeEmpty[N.nodeName.toLowerCase()]){r=null;break}if(r)F=!!J.length}else r=null;if(F)if(O)if(I)h=i;else i&&this.setStartBefore(i);else O=true;if(r){F=r.previousSibling;if(!i&&!F){i=new c(r);r=null;break}r=F}else i=null}if(i)i=i.parent()}F=this.endContainer;J=this.endOffset;i=r=null;I=O=false;if(F[0].nodeType==j.NODE_TEXT){F=!C.trim(F[0].nodeValue.substring(J)).length&&F;O=!(F&&F[0].nodeValue.length);if(F)if(!(r=F[0].nextSibling))i=
F.parent()}else(r=F[0].childNodes[J])||(i=F);for(;i||r;){if(i&&!r){if(!I&&A._4e_equals(i,b))I=true;if(!d._4e_contains(i))break;if(!O||i.css("display")!="inline"){O=false;if(I)o=i;else i&&this.setEndAfter(i)}r=i[0].nextSibling}for(;r;){F=false;if(r.nodeType==j.NODE_TEXT){J=r.nodeValue;if(/[^\s\ufeff]/.test(J))r=null;F=/^[\s\ufeff]/.test(J)}else if(r.offsetWidth>0&&!r.getAttribute("_ke_bookmark"))if(O&&n.$removeEmpty[r.nodeName.toLowerCase()]){J=A.text(r);if(/[^\s\ufeff]/.test(J))r=null;else{L=r.all||
r.getElementsByTagName("*");for(P=0;N=L[P++];)if(!n.$removeEmpty[N.nodeName.toLowerCase()]){r=null;break}}if(r)F=!!J.length}else r=null;if(F)if(O)if(I)o=i;else this.setEndAfter(i);if(r){F=r.nextSibling;if(!i&&!F){i=new c(r);r=null;break}r=F}else i=null}if(i)i=i.parent()}if(h&&o){b=h._4e_contains(o)?o:h;this.setStartBefore(b);this.setEndAfter(b)}break;case l.ENLARGE_BLOCK_CONTENTS:case l.ENLARGE_LIST_ITEM_CONTENTS:i=new H(this.document);d=new c(this.document.body);i.setStartAt(d,l.POSITION_AFTER_START);
i.setEnd(this.startContainer,this.startOffset);i=new u(i);var S,Y,Z=u.blockBoundary(b==l.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:null),ca=function($){var k=Z($);k||(S=$);return k};h=function($){var k=ca($);if(!k&&$[0]&&$._4e_name()=="br")Y=$;return k};i.guard=ca;i=i.lastBackward();S=S||d;this.setStartAt(S,S._4e_name()!="br"&&(!i&&this.checkStartOfBlock()||i&&S._4e_contains(i))?l.POSITION_AFTER_START:l.POSITION_AFTER_END);i=this.clone();i.collapse();i.setEndAt(d,l.POSITION_BEFORE_END);i=new u(i);i.guard=
b==l.ENLARGE_LIST_ITEM_CONTENTS?h:ca;S=null;i=i.lastForward();S=S||d;this.setEndAt(S,!i&&this.checkEndOfBlock()||i&&S._4e_contains(i)?l.POSITION_BEFORE_END:l.POSITION_BEFORE_START);Y&&this.setEndAfter(Y)}},checkStartOfBlock:function(){var b=this.startContainer,d=this.startOffset;if(d&&b[0].nodeType==j.NODE_TEXT)if(C.trim(b[0].nodeValue.substring(0,d)).length)return false;this.trim();b=new a(this.startContainer);d=this.clone();d.collapse(true);d.setStartAt(b.block||b.blockLimit,l.POSITION_AFTER_START);
b=new u(d);b.evaluator=E(true);return b.checkBackward()},checkEndOfBlock:function(){var b=this.endContainer,d=this.endOffset;if(b[0].nodeType==j.NODE_TEXT)if(C.trim(b[0].nodeValue.substring(d)).length)return false;this.trim();b=new a(this.endContainer);d=this.clone();d.collapse(false);d.setEndAt(b.block||b.blockLimit,l.POSITION_BEFORE_END);b=new u(d);b.evaluator=E(false);return b.checkForward()},deleteContents:function(){this.collapsed||this.execContentsAction(0)},extractContents:function(){var b=
this.document.createDocumentFragment();this.collapsed||this.execContentsAction(1,b);return b},checkBoundaryOfElement:function(b,d){var h=this.clone();h[d==l.START?"setStartAt":"setEndAt"](b,d==l.START?l.POSITION_AFTER_START:l.POSITION_BEFORE_END);b=new u(h);b.evaluator=G;return b[d==l.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var b=this.startContainer,d=this.endContainer,h=this.startOffset,o=this.endOffset,i;if(b[0].nodeType==j.NODE_ELEMENT){i=b[0].childNodes.length;if(i>
h)b=new c(b[0].childNodes[h]);else if(i<1)b=b._4e_previousSourceNode();else{for(b=b[0];b.lastChild;)b=b.lastChild;b=new c(b);b=b._4e_nextSourceNode()||b}}if(d[0].nodeType==j.NODE_ELEMENT){i=d[0].childNodes.length;if(i>o)d=(new c(d[0].childNodes[o]))._4e_previousSourceNode(true);else if(i<1)d=d._4e_previousSourceNode();else{for(d=d[0];d.lastChild;)d=d.lastChild;d=new c(d)}}if(b._4e_position(d)&t.POSITION_FOLLOWING)b=d;return{startNode:b,endNode:d}},fixBlock:function(b,d){var h=this.createBookmark();
d=new c(this.document.createElement(d));this.collapse(b);this.enlarge(l.ENLARGE_BLOCK_CONTENTS);d[0].appendChild(this.extractContents());d._4e_trim();p.ie||d._4e_appendBogus();this.insertNode(d);this.moveToBookmark(h);return d},splitBlock:function(b){var d=new a(this.startContainer),h=new a(this.endContainer),o=d.block,i=h.block,r=null;if(d.blockLimit[0]!==h.blockLimit[0])return null;if(b!="br"){if(!o){o=this.fixBlock(true,b);i=(new a(this.endContainer)).block}i||(i=this.fixBlock(false,b))}b=o&&this.checkStartOfBlock();
d=i&&this.checkEndOfBlock();this.deleteContents();if(o&&A._4e_equals(o,i))if(d){r=new a(this.startContainer);this.moveToPosition(i,l.POSITION_AFTER_END);i=null}else if(b){r=new a(this.startContainer);this.moveToPosition(o,l.POSITION_BEFORE_START);o=null}else{i=this.splitElement(o);!p.ie&&!C.inArray(o._4e_name(),["ul","ol"])&&o._4e_appendBogus()}return{previousBlock:o,nextBlock:i,wasStartOfBlock:b,wasEndOfBlock:d,elementPath:r}},splitElement:function(b){if(!this.collapsed)return null;this.setEndAt(b,
l.POSITION_BEFORE_END);var d=this.extractContents(),h=b._4e_clone(false);h[0].appendChild(d);h.insertAfter(b);this.moveToPosition(b,l.POSITION_AFTER_END);return h},moveToElementEditablePosition:function(b,d){var h,o=w.XHTML_DTD;if(o.$empty[b._4e_name()])return false;for(;b&&b[0].nodeType==j.NODE_ELEMENT;){if(h=b._4e_isEditable())this.moveToPosition(b,d?l.POSITION_BEFORE_END:l.POSITION_AFTER_START);else if(o.$inline[b._4e_name()]){this.moveToPosition(b,d?l.POSITION_AFTER_END:l.POSITION_BEFORE_START);
return true}if((b=o.$empty[b._4e_name()]?b[d?"_4e_previous":"_4e_next"](x):b[d?"_4e_last":"_4e_first"](x))&&b[0].nodeType==j.NODE_TEXT){this.moveToPosition(b,d?l.POSITION_AFTER_END:l.POSITION_BEFORE_START);return true}}return h},selectNodeContents:function(b){this.setStart(b,0);this.setEnd(b,b[0].nodeType==j.NODE_TEXT?b[0].nodeValue.length:b[0].childNodes.length)}});var f={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},e=new u.whitespaces,m=new u.bookmark;w.Range=H});
KISSY.Editor.add("domiterator",function(w){function H(y){if(!(arguments.length<1)){this.range=y;this.forceBrBreak=false;this.enlargeBr=true;this.enforceRealBlocks=false;this._||(this._={})}}var G=KISSY,x=G.UA,E=w.Walker,D=w.Range,v=w.RANGE,C=w.NODE,j=w.ElementPath,l=G.Node,t=G.DOM,u=/^[\r\n\t ]*$/,A=E.bookmark();G.augment(H,{getNextParagraph:function(y){var p,n,a,c,g;if(!this._.lastNode){n=this.range.clone();n.enlarge(this.forceBrBreak||!this.enlargeBr?v.ENLARGE_LIST_ITEM_CONTENTS:v.ENLARGE_BLOCK_CONTENTS);
var f=new E(n),e=E.bookmark(true,true);f.evaluator=e;this._.nextNode=f.next();f=new E(n);f.evaluator=e;f=f.previous();this._.lastNode=f._4e_nextSourceNode(true);if(this._.lastNode&&this._.lastNode[0].nodeType==C.NODE_TEXT&&!G.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()){e=new D(n.document);e.moveToPosition(this._.lastNode,v.POSITION_AFTER_END);if(e.checkEndOfBlock()){e=new j(e.endContainer);this._.lastNode=(e.block||e.blockLimit)._4e_nextSourceNode(true)}}if(!this._.lastNode){this._.lastNode=
this._.docEndMarker=new l(n.document.createTextNode(""));t.insertAfter(this._.lastNode[0],f[0])}n=null}e=this._.nextNode;f=this._.lastNode;for(this._.nextNode=null;e;){var m=false,b=e[0].nodeType!=C.NODE_ELEMENT,d=false;if(b){if(e[0].nodeType==C.NODE_TEXT)if(u.test(e[0].nodeValue))b=false}else{var h=e._4e_name();if(e._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if(h=="br")b=true;else if(!n&&!e[0].childNodes.length&&h!="hr"){p=e;a=e._4e_equals(f);break}if(n){n.setEndAt(e,v.POSITION_BEFORE_START);
if(h!="br")this._.nextNode=e}m=true}else{if(e[0].firstChild){if(!n){n=new D(this.range.document);n.setStartAt(e,v.POSITION_BEFORE_START)}e=new l(e[0].firstChild);continue}b=true}}if(b&&!n){n=new D(this.range.document);n.setStartAt(e,v.POSITION_BEFORE_START)}a=(!m||b)&&e._4e_equals(f);if(n&&!m)for(;!e[0].nextSibling&&!a;){h=e.parent();if(h._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){m=true;a||h._4e_equals(f);break}e=h;b=true;a=e._4e_equals(f);d=true}b&&n.setEndAt(e,v.POSITION_AFTER_END);e=e._4e_nextSourceNode(d,
null,f);a=!e;if((m||a)&&n){b=n.getBoundaryNodes();m=new j(n.startContainer);if(b.startNode.parent()._4e_equals(m.blockLimit)&&A(b.startNode)&&A(b.endNode)){n=null;this._.nextNode=null}else break}if(a)break}if(!p){if(!n){this._.docEndMarker&&this._.docEndMarker._4e_remove();return this._.nextNode=null}m=new j(n.startContainer);e=m.blockLimit;b={div:1,th:1,td:1};p=m.block;if((!p||!p[0])&&!this.enforceRealBlocks&&b[e._4e_name()]&&n.checkStartOfBlock()&&n.checkEndOfBlock())p=e;else if(!p||this.enforceRealBlocks&&
p._4e_name()=="li"){p=new l(this.range.document.createElement(y||"p"));p[0].appendChild(n.extractContents());p._4e_trim();n.insertNode(p);c=g=true}else if(p._4e_name()!="li"){if(!n.checkStartOfBlock()||!n.checkEndOfBlock()){p=p._4e_clone(false);p[0].appendChild(n.extractContents());p._4e_trim();g=n.splitBlock();c=!g.wasStartOfBlock;g=!g.wasEndOfBlock;n.insertNode(p)}}else if(!a)this._.nextNode=p._4e_equals(f)?null:n.getBoundaryNodes().endNode._4e_nextSourceNode(true,null,f)}if(c){n=new l(p[0].previousSibling);
if(n[0]&&n[0].nodeType==C.NODE_ELEMENT)if(n._4e_name()=="br")n._4e_remove();else n[0].lastChild&&n[0].lastChild.nodeName.toLowerCase()=="br"&&t._4e_remove(n[0].lastChild)}if(g){n=E.bookmark(false,true);c=new l(p[0].lastChild);if(c[0]&&c[0].nodeType==C.NODE_ELEMENT&&c._4e_name()=="br")if(x.ie||c._4e_previous(n)||c._4e_next(n))c._4e_remove()}if(!this._.nextNode)this._.nextNode=a||p._4e_equals(f)?null:p._4e_nextSourceNode(true,null,f);return p}});D.prototype.createIterator=function(){return new H(this)}});
KISSY.Editor.add("selection",function(w){function H(f){this.document=f;this._={cache:{}};if(D.ie){var e=this.getNative().createRange();if(!e||e.item&&e.item(0).ownerDocument!=f||e.parentElement&&e.parentElement().ownerDocument!=f)this.isInvalid=true}}function G(f){f=new H(f);return!f||f.isInvalid?null:f}function x(f){var e=f.document,m=new l(e.body),b=new l(e.documentElement);if(D.ie){if(D.ie<8||document.documentMode==7)b.on("click",function(r){v._4e_name(r.target)==="html"&&f.getSelection().getRanges()[0].select()});
var d,h;m.on("focusin",function(r){if(r.target.nodeName.toUpperCase()=="BODY")if(d){try{d.select()}catch(I){}d=null}});m.on("focus",function(){h=true;i()});m.on("beforedeactivate",function(r){r.relatedTarget||(h=false)});D.ie<8&&C.on(v._4e_getWin(e),"blur",function(){e.selection.empty()});m.on("mousedown",o);m.on("mouseup",function(){h=true;setTimeout(function(){i(true)},0)});m.on("keydown",o);m.on("keyup",function(){h=true;i()});C.on(e,"selectionchange",i);var o=function(){h=false},i=function(r){if(h){var I=
f.document,O=f.getSelection(),F=O&&O.getNative();if(r&&F&&F.type=="None")if(!I.queryCommandEnabled("InsertImage")){setTimeout(function(){i(true)},50);return}var J;if(!(F&&F.type=="Text"&&(J=F.createRange().parentElement().nodeName.toLowerCase())&&J in{input:1,textarea:1})){d=F&&O.getRanges()[0];f._monitor()}}}}else{C.on(e,"mouseup",f._monitor,f);C.on(e,"keyup",f._monitor,f)}}w.SELECTION={};var E=KISSY,D=E.UA,v=E.DOM,C=E.Event,j=w.Utils.tryThese,l=E.Node,t=w.SELECTION,u=w.RANGE,A=w.NODE,y=w.Walker,
p=w.Range;t.SELECTION_NONE=1;t.SELECTION_TEXT=2;t.SELECTION_ELEMENT=3;var n={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};E.augment(H,{getNative:D.ie?function(){return this._.cache.nativeSel||(this._.cache.nativeSel=this.document.selection)}:function(){return this._.cache.nativeSel||(this._.cache.nativeSel=v._4e_getWin(this.document).getSelection())},getType:D.ie?function(){var f=this._.cache;if(f.type)return f.type;
var e=t.SELECTION_NONE;try{var m=this.getNative(),b=m.type;if(b=="Text")e=t.SELECTION_TEXT;if(b=="Control")e=t.SELECTION_ELEMENT;if(m.createRange().parentElement)e=t.SELECTION_TEXT}catch(d){}return f.type=e}:function(){var f=this._.cache;if(f.type)return f.type;var e=t.SELECTION_TEXT,m=this.getNative();if(m){if(m.rangeCount==1){m=m.getRangeAt(0);var b=m.startContainer;if(b==m.endContainer&&b.nodeType==A.NODE_ELEMENT&&m.endOffset-m.startOffset===1&&n[b.childNodes[m.startOffset].nodeName.toLowerCase()])e=
t.SELECTION_ELEMENT}}else e=t.SELECTION_NONE;return f.type=e},getRanges:D.ie?function(){var f=function(e,m){e=e.duplicate();e.collapse(m);m=e.parentElement();for(var b=m.childNodes,d,h=0;h<b.length;h++){var o=b[h];if(o.nodeType==A.NODE_ELEMENT){d=e.duplicate();d.moveToElementText(o);o=d.compareEndPoints("StartToStart",e);var i=d.compareEndPoints("EndToStart",e);d.collapse();if(o>0)break;else if(!o||i==1&&o==-1)return{container:m,offset:h};else if(!i)return{container:m,offset:h+1};d=null}}if(!d){d=
e.duplicate();d.moveToElementText(m);d.collapse(false)}d.setEndPoint("StartToStart",e);e=d.text.replace(/(\r\n|\r)/g,"\n").length;try{for(;e>0;)e-=b[--h].nodeValue.length}catch(r){e=0}return e===0?{container:m,offset:h}:{container:b[h],offset:-e}};return function(){var e=this._.cache;if(e.ranges)return e.ranges;var m=this.getNative(),b=m&&m.createRange(),d=this.getType();if(!m)return[];if(d==t.SELECTION_TEXT){m=new p(this.document);d=f(b,true);m.setStart(new l(d.container),d.offset);d=f(b);m.setEnd(new l(d.container),
d.offset);return e.ranges=[m]}else if(d==t.SELECTION_ELEMENT){e=this._.cache.ranges=[];for(d=0;d<b.length;d++){var h=b.item(d),o=h.parentNode,i=0;for(m=new p(this.document);i<o.childNodes.length&&o.childNodes[i]!=h;i++);m.setStart(new l(o),i);m.setEnd(new l(o),i+1);e.push(m)}return e}return e.ranges=[]}}():function(){var f=this._.cache;if(f.ranges)return f.ranges;var e=[],m=this.getNative();if(!m)return[];for(var b=0;b<m.rangeCount;b++){var d=m.getRangeAt(b),h=new p(this.document);h.setStart(new l(d.startContainer),
d.startOffset);h.setEnd(new l(d.endContainer),d.endOffset);e.push(h)}return f.ranges=e},getStartElement:function(){var f=this._.cache;if(f.startElement!==undefined)return f.startElement;var e,m=this.getNative();switch(this.getType()){case t.SELECTION_ELEMENT:return this.getSelectedElement();case t.SELECTION_TEXT:var b=this.getRanges()[0];if(b)if(!b.collapsed){for(b.optimize();;){e=b.startContainer;if(b.startOffset==(e[0].childNodes?e[0].childNodes.length:e[0].nodeValue.length)&&!e._4e_isBlockBoundary())b.setStartAfter(e);
else break}e=b.startContainer;if(e[0].nodeType!=A.NODE_ELEMENT)return e.parent();e=new l(e[0].childNodes[b.startOffset]);if(!e[0]||e[0].nodeType!=A.NODE_ELEMENT)return b.startContainer;for(b=e[0].firstChild;b&&b.nodeType==A.NODE_ELEMENT;){e=new l(b);b=b.firstChild}return e}if(D.ie){b=m.createRange();b.collapse(true);e=b.parentElement()}else if((e=m.anchorNode)&&e.nodeType!=A.NODE_ELEMENT)e=e.parentNode}return f.startElement=e?new l(e):null},getSelectedElement:function(){var f=this._.cache;if(f.selectedElement!==
undefined)return f.selectedElement;var e=this,m=j(function(){return e.getNative().createRange().item(0)},function(){for(var b=e.getRanges()[0],d,h,o=2;o&&!((d=b.getEnclosedNode())&&d[0].nodeType==A.NODE_ELEMENT&&n[d._4e_name()]&&(h=d));o--)b.shrink(u.SHRINK_ELEMENT);return h[0]});return f.selectedElement=m?new l(m):null},reset:function(){this._.cache={}},selectElement:function(f){var e;if(D.ie){this.getNative().empty();try{e=this.document.body.createControlRange();e.addElement(f[0]);e.select()}catch(m){e=
this.document.body.createTextRange();e.moveToElementText(f[0]);e.select()}finally{}}else{e=this.document.createRange();e.selectNode(f[0]);f=this.getNative();f.removeAllRanges();f.addRange(e)}this.reset()},selectRanges:function(f){if(D.ie)f[0]&&f[0].select();else{var e=this.getNative();if(!e)return;e.removeAllRanges();for(var m=0;m<f.length;m++){var b=f[m],d=this.document.createRange(),h=b.startContainer;b.collapsed&&D.gecko&&D.gecko<1.09&&h[0].nodeType==A.NODE_ELEMENT&&!h[0].childNodes.length&&h[0].appendChild(this.document.createTextNode(""));
d.setStart(h[0],b.startOffset);d.setEnd(b.endContainer[0],b.endOffset);e.addRange(d)}}this.reset()},createBookmarks2:function(f){for(var e=[],m=this.getRanges(),b=0;b<m.length;b++)e.push(m[b].createBookmark2(f));return e},createBookmarks:function(f){for(var e=[],m=this.getRanges(),b=m.length,d,h=0;h<b;h++){e.push(d=m[h].createBookmark(f,true));var o=(f=d.serializable)?E.one("#"+d.startNode):d.startNode;d=f?E.one("#"+d.endNode):d.endNode;for(var i=h+1;i<b;i++){var r=m[i],I=r.startContainer,O=r.endContainer;
v._4e_equals(I,o.parent())&&r.startOffset++;v._4e_equals(I,d.parent())&&r.startOffset++;v._4e_equals(O,o.parent())&&r.endOffset++;v._4e_equals(O,d.parent())&&r.endOffset++}}return e},selectBookmarks:function(f){for(var e=[],m=0;m<f.length;m++){var b=new p(this.document);b.moveToBookmark(f[m]);e.push(b)}this.selectRanges(e);return this},getCommonAncestor:function(){var f=this.getRanges();return f[0].startContainer._4e_commonAncestor(f[f.length-1].endContainer)},scrollIntoView:function(){this.getStartElement()._4e_scrollIntoView()}});
w.Selection=H;var a={table:1,tbody:1,tr:1},c=y.whitespaces(true),g=/\ufeff|\u00a0/;p.prototype.select=D.ie?function(f){var e=this.collapsed,m,b;if(this.startContainer[0].nodeType==A.NODE_ELEMENT&&this.startContainer._4e_name()in a||this.endContainer[0].nodeType==A.NODE_ELEMENT&&this.endContainer._4e_name()in a)this.shrink(A.NODE_ELEMENT,true);var d=this.createBookmark(),h=d.startNode,o;if(!e)o=d.endNode;d=this.document.body.createTextRange();d.moveToElementText(h[0]);d.moveStart("character",1);if(o){f=
this.document.body.createTextRange();f.moveToElementText(o[0]);d.setEndPoint("EndToEnd",f);d.moveEnd("character",-1)}else{for(m=h[0].nextSibling;m&&!c(m);)m=m.nextSibling;m=!(m&&m.nodeValue&&m.nodeValue.match(g))&&(f||!h[0].previousSibling||h[0].previousSibling&&v._4e_name(h[0].previousSibling)=="br");b=this.document.createElement("span");b.innerHTML="&#65279;";b=new l(b);v.insertBefore(b[0],h[0]);m&&v.insertBefore(this.document.createTextNode("\ufeff"),h[0])}this.setStartBefore(h);h._4e_remove();
if(e){if(m){d.moveStart("character",-1);d.select();this.document.selection.clear()}else d.select();if(b){this.moveToPosition(b,u.POSITION_BEFORE_START);b._4e_remove()}}else{this.setEndBefore(o);o._4e_remove();d.select()}}:function(){var f=this.startContainer;this.collapsed&&f[0].nodeType==A.NODE_ELEMENT&&!f[0].childNodes.length&&f[0].appendChild(this.document.createTextNode(""));var e=this.document.createRange();e.setStart(f[0],this.startOffset);try{e.setEnd(this.endContainer[0],this.endOffset)}catch(m){if(m.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=
0){this.collapse(true);e.setEnd(this.endContainer[0],this.endOffset)}else throw m;}f=G(this.document).getNative();f.removeAllRanges();f.addRange(e)};w.on("instanceCreated",function(f){x(f.editor)})});
KISSY.Editor.add("styles",function(w){function H(k,q){for(var s in k)k[s]=k[s].replace($,function(z,B){return q[B]})}function G(k,q){if(q){k=o.clone(k);H(k.attributes,q);H(k.styles,q)}q=this.element=(k.element||"*").toLowerCase();this.type=q=="#"||Y[q]?r.STYLE_BLOCK:Z[q]?r.STYLE_OBJECT:r.STYLE_INLINE;this._={definition:k}}function x(k,q){q=q?this.removeFromRange:this.applyToRange;k.body.focus();k=new O(k);for(var s=k.getRanges(),z=0;z<s.length;z++)q.call(this,s[z]);k.selectRanges(s)}function E(k,
q){var s=k.element;if(s=="*")s="span";q=new P(q.createElement(s));return D(q,k)}function D(k,q){var s=q._.definition;q=s.attributes;s=G.getStyleText(s);if(q)for(var z in q)k.attr(z,q[z]);if(s)k[0].style.cssText=s;return k}function v(k){var q=k.createBookmark(true),s=k.createIterator();s.enforceRealBlocks=true;s.enlargeBr=true;for(var z,B=k.document;z=s.getNextParagraph();){var K=E(this,B);t(z,K)}k.moveToBookmark(q)}function C(k,q,s){var z="",B="";k=k.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,
function(K,M,Q){M&&(z=M);Q&&(B=Q);return""});return z+k.replace(q,s)+B}function j(k,q){var s=k.html();s=C(s,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,"");s=s.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1");s=s.replace(/([ \t\n\r]+|&nbsp;)/g," ");s=s.replace(/<br\b[^>]*>/gi,"\n");if(N.ie){k=k[0].ownerDocument.createElement("div");k.appendChild(q[0]);q[0].outerHTML="<pre>"+s+"</pre>";q=new P(k.firstChild);q._4e_remove()}else q.html(s);return q}function l(k){var q=[];C(k._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,
function(s,z,B){return z+"</pre>"+B+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(s,z){q.push(z)});return q}function t(k,q){var s=q._4e_name=="pre",z=k._4e_name=="pre",B=!s&&z;if(s&&!z)q=j(k,q);else if(B)q=A(l(k),q);else k._4e_moveChildren(q);k[0].parentNode.replaceChild(q[0],k[0]);s&&u(q)}function u(k){var q;if((q=k._4e_previousSourceNode(true,F.NODE_ELEMENT))&&q._4e_name()=="pre"){var s=C(q.html(),/\n$/,"")+"\n\n"+C(k.html(),/^\n/,"");if(N.ie)k[0].outerHTML="<pre>"+s+"</pre>";else k.html(s);
q._4e_remove()}}function A(k,q){for(var s=q[0].ownerDocument.createDocumentFragment(),z=0;z<k.length;z++){var B=k[z];B=B.replace(/(\r\n|\r)/g,"\n");B=C(B,/^[ \t]*\n/,"");B=C(B,/\n$/,"");B=C(B,/^[ \t]+|[ \t]+$/g,function(M,Q){return M.length==1?"&nbsp;":Q?" "+(new Array(M.length)).join("&nbsp;"):(new Array(M.length)).join("&nbsp;")+" "});B=B.replace(/\n/g,"<br>");B=B.replace(/[ \t]{2,}/g,function(M){return(new Array(M.length)).join("&nbsp;")+" "});var K=q._4e_clone();K.html(B);s.appendChild(K[0])}return s}
function y(k){var q=k.document;if(k.collapsed){q=E(this,q);k.insertNode(q);k.moveToPosition(q,I.POSITION_BEFORE_END)}else{var s=this.element,z=this._.definition,B,K=w.XHTML_DTD[s]||(B=true,w.XHTML_DTD.span),M=k.createBookmark();k.enlarge(I.ENLARGE_ELEMENT);k.trim();var Q=k.createBookmark(),da=Q.startNode;Q=Q.endNode;for(var T=da,V;T&&T[0];){var R=false;if(i._4e_equals(T,Q)){T=null;R=true}else{var U=T[0].nodeType,aa=U==F.NODE_ELEMENT?T._4e_name():null;if(aa&&T.attr("_ke_bookmark")){T=T._4e_nextSourceNode(true);
continue}if(!aa||K[aa]&&(T._4e_position(Q)|J.POSITION_PRECEDING|J.POSITION_IDENTICAL|J.POSITION_IS_CONTAINED)==J.POSITION_PRECEDING+J.POSITION_IDENTICAL+J.POSITION_IS_CONTAINED&&(!z.childRule||z.childRule(T))){var ba=T.parent();if(ba&&ba[0]&&((w.XHTML_DTD[ba._4e_name()]||w.XHTML_DTD.span)[s]||B)&&(!z.parentRule||z.parentRule(ba))){if(!V&&(!aa||!w.XHTML_DTD.$removeEmpty[aa]||(T._4e_position(Q)|J.POSITION_PRECEDING|J.POSITION_IDENTICAL|J.POSITION_IS_CONTAINED)==J.POSITION_PRECEDING+J.POSITION_IDENTICAL+
J.POSITION_IS_CONTAINED)){V=new L(q);V.setStartBefore(T)}if(U==F.NODE_TEXT||U==F.NODE_ELEMENT&&!T[0].childNodes.length){U=T;for(var W;!U[0].nextSibling&&(W=U.parent(),K[W._4e_name()])&&(W._4e_position(da)|J.POSITION_FOLLOWING|J.POSITION_IDENTICAL|J.POSITION_IS_CONTAINED)==J.POSITION_FOLLOWING+J.POSITION_IDENTICAL+J.POSITION_IS_CONTAINED&&(!z.childRule||z.childRule(W));)U=W;V.setEndAfter(U);U[0].nextSibling||(R=true)}}else R=true}else R=true;T=T._4e_nextSourceNode()}if(R&&V&&!V.collapsed){R=E(this,
q);for(U=V.getCommonAncestor();R&&U&&R[0]&&U[0];){if(U._4e_name()==s){for(var X in z.attributes)R.attr(X)==U.attr(X)&&R[0].removeAttribute(X);for(var ea in z.styles)R._4e_style(ea)==U._4e_style(ea)&&R._4e_style(ea,"");if(!R._4e_hasAttributes()){R=null;break}}U=U.parent()}if(R){R[0].appendChild(V.extractContents());b(this,R);V.insertNode(R);R._4e_mergeSiblings();N.ie||R[0].normalize()}V=null}}da._4e_remove();Q._4e_remove();k.moveToBookmark(M);k.shrink(I.SHRINK_TEXT)}}function p(k){k.enlarge(I.ENLARGE_ELEMENT);
var q=k.createBookmark(),s=q.startNode;if(k.collapsed){for(var z=new S(s.parent()),B,K=0,M;K<z.elements.length&&(M=z.elements[K]);K++){if(M==z.block||M==z.blockLimit)break;if(this.checkElementRemovable(M)){var Q=k.checkBoundaryOfElement(M,I.END),da=!Q&&k.checkBoundaryOfElement(M,I.START);if(da||Q){B=M;B.match=da?"start":"end"}else{M._4e_mergeSiblings();e(this,M)}}}if(B&&B[0]){M=s;for(K=0;;K++){Q=z.elements[K];if(i._4e_equals(Q,B))break;else if(Q.match)continue;else Q=Q._4e_clone();Q[0].appendChild(M[0]);
M=Q}i[B.match=="start"?"insertBefore":"insertAfter"](M[0],B[0])}}else{var T=q.endNode,V=this;z=function(){for(var R=new S(s.parent()),U=new S(T.parent()),aa=null,ba=null,W=0;W<R.elements.length;W++){var X=R.elements[W];if(X==R.block||X==R.blockLimit)break;if(V.checkElementRemovable(X))aa=X}for(W=0;W<U.elements.length;W++){X=U.elements[W];if(X==U.block||X==U.blockLimit)break;if(V.checkElementRemovable(X))ba=X}ba&&T._4e_breakParent(ba);aa&&s._4e_breakParent(aa)};z();for(B=new P(s[0].nextSibling);B[0]!==
T[0];){K=B._4e_nextSourceNode();if(B[0].nodeType==F.NODE_ELEMENT&&this.checkElementRemovable(B)){B._4e_name()==this.element?e(this,B):d(B,f(this)[B._4e_name()]);if(K[0].nodeType==F.NODE_ELEMENT&&K._4e_contains(s)){z();K=new P(s[0].nextSibling)}}B=K}}k.moveToBookmark(q)}function n(k){var q={};k.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(s,z,B){q[z]=B});return q}function a(k,q){typeof k=="string"&&(k=n(k));typeof q=="string"&&(q=n(q));for(var s in k)if(!(s in q&&
(q[s]==k[s]||k[s]=="inherit"||q[s]=="inherit")))return false;return true}function c(k,q){if(q!==false){q=document.createElement("span");q.style.cssText=k;k=q.style.cssText||""}else k=k;return k.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function g(k){var q=k._AC;if(q)return q;q={};var s=0,z=k.attributes;if(z)for(var B in z){s++;q[B]=z[B]}if(z=G.getStyleText(k)){q.style||s++;q.style=z}q._length=s;return k._AC=q}function f(k){if(k._.overrides)return k._.overrides;
var q=k._.overrides={},s=k._.definition.overrides;if(s){o.isArray(s)||(s=[s]);for(var z=0;z<s.length;z++){var B=s[z],K,M;if(typeof B=="string")K=B.toLowerCase();else{K=B.element?B.element.toLowerCase():k.element;M=B.attributes}B=q[K]||(q[K]={});if(M){B=B.attributes=B.attributes||[];for(var Q in M)B.push([Q.toLowerCase(),M[Q]])}}}return q}function e(k,q){var s=k._.definition,z=o.mix(o.mix({},s.attributes),f(k)[q._4e_name()]);s=s.styles;var B=o.isEmptyObject(z)&&o.isEmptyObject(s);for(var K in z)if(!((K==
"class"||k._.definition.fullMatch)&&q.attr(K)!=m(K,z[K]))){B=B||!!q._4e_hasAttribute(K);q.removeAttr(K)}for(var M in s)if(!(k._.definition.fullMatch&&q._4e_style(M)!=m(M,s[M],true))){B=B||!!q._4e_style(M);q._4e_style(M,"")}B&&h(q)}function m(k,q,s){var z=new P("<span></span>");z[s?"_4e_style":"attr"](k,q);return z[s?"_4e_style":"attr"](k)}function b(k,q){for(var s=f(k),z=q.all(k.element),B=z.length;--B>=0;)e(k,new P(z[B]));for(var K in s)if(K!=k.element){z=q.all(K);for(B=z.length-1;B>=0;B--){var M=
new P(z[B]);d(M,s[K])}}}function d(k,q){if(q=q&&q.attributes)for(var s=0;s<q.length;s++){var z=q[s][0],B;if(B=k.attr(z)){var K=q[s][1];if(K===null||K.test&&K.test(B)||typeof K=="string"&&B==K)k[0].removeAttribute(z)}}h(k)}function h(k){if(!k._4e_hasAttributes()){var q=k[0].firstChild,s=k[0].lastChild;k._4e_remove(true);if(q){q.nodeType==F.NODE_ELEMENT&&i._4e_mergeSiblings(q);s&&!q===s&&s.nodeType==F.NODE_ELEMENT&&i._4e_mergeSiblings(s)}}}var o=KISSY,i=o.DOM,r=w.STYLE={},I=w.RANGE,O=w.Selection,F=
w.NODE,J=w.POSITION,L=w.Range,P=o.Node,N=o.UA,S=w.ElementPath,Y={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},Z={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},ca=/\s*(?:;\s*|$)/,$=/#\((.+?)\)/g;r.STYLE_BLOCK=1;r.STYLE_INLINE=2;r.STYLE_OBJECT=3;G.prototype={apply:function(k){x.call(this,k,false)},remove:function(k){x.call(this,k,true)},applyToRange:function(k){return(this.applyToRange=this.type==r.STYLE_INLINE?y:this.type==r.STYLE_BLOCK?v:this.type==
r.STYLE_OBJECT?null:null).call(this,k)},removeFromRange:function(k){return(this.removeFromRange=this.type==r.STYLE_INLINE?p:null).call(this,k)},applyToObject:function(k){D(k,this)},checkElementRemovable:function(k,q){if(!k)return false;var s=this._.definition;if(k._4e_name()==this.element){if(!q&&!k._4e_hasAttributes())return true;s=g(s);if(s._length){for(var z in s)if(z!="_length"){var B=k.attr(z)||"";if(z=="style"?a(s[z],c(B,false)):s[z]==B){if(!q)return true}else if(q)return false}if(q)return true}else return true}if(s=
f(this)[k._4e_name()]){if(!(s=s.attributes))return true;for(q=0;q<s.length;q++){z=s[q][0];if(z=k.attr(z)){B=s[q][1];if(B===null||typeof B=="string"&&z==B||B.test(z))return true}}}return false},checkActive:function(k){switch(this.type){case r.STYLE_BLOCK:return this.checkElementRemovable(k.block||k.blockLimit,true);case r.STYLE_OBJECT:case r.STYLE_INLINE:for(var q=k.elements,s=0,z;s<q.length;s++){z=q[s];if(!(this.type==r.STYLE_INLINE&&(i._4e_equals(z,k.block)||i._4e_equals(z,k.blockLimit))))if(!(this.type==
r.STYLE_OBJECT&&!(z._4e_name()in Z)))if(this.checkElementRemovable(z,true))return true}}return false}};G.getStyleText=function(k){var q=k._ST;if(q)return q;q=k.styles;var s=k.attributes&&k.attributes.style||"",z="";if(s.length)s=s.replace(ca,";");for(var B in q){var K=q[B],M=(B+":"+K).replace(ca,";");if(K=="inherit")z+=M;else s+=M}if(s.length)s=c(s);s+=z;return k._ST=s};w.Style=G});
