KISSY.Editor.add("styles",function(n){function I(a,b){for(var c in a)a[c]=a[c].replace(R,function(e,d){return b[d]})}function A(a,b){if(b){a=r.clone(a);I(a.attributes,b);I(a.styles,b)}b=this.element=(a.element||"*").toLowerCase();this.type=b=="#"||S[b]?m.STYLE_BLOCK:J[b]?m.STYLE_OBJECT:m.STYLE_INLINE;this._={definition:a}}function K(a,b){b=b?this.removeFromRange:this.applyToRange;a.body.focus();a=new T(a);for(var c=a.getRanges(),e=0;e<c.length;e++)b.call(this,c[e]);a.selectRanges(c)}function C(a,
b){var c=a.element;if(c=="*")c="span";b=new v(b.createElement(c));return L(b,a)}function L(a,b){var c=b._.definition;b=c.attributes;c=A.getStyleText(c);if(b)for(var e in b)a.attr(e,b[e]);if(c)a[0].style.cssText=c;return a}function U(a){var b=a.createBookmark(true),c=a.createIterator();c.enforceRealBlocks=true;c.enlargeBr=true;for(var e,d=a.document;e=c.getNextParagraph();){var f=C(this,d);V(e,f)}a.moveToBookmark(b)}function w(a,b,c){var e="",d="";a=a.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,
function(f,g,h){g&&(e=g);h&&(d=h);return""});return e+a.replace(b,c)+d}function W(a,b){var c=a.html();c=w(c,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,"");c=c.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1");c=c.replace(/([ \t\n\r]+|&nbsp;)/g," ");c=c.replace(/<br\b[^>]*>/gi,"\n");if(D.ie){a=a[0].ownerDocument.createElement("div");a.appendChild(b[0]);b[0].outerHTML="<pre>"+c+"</pre>";b=new v(a.firstChild);b._4e_remove()}else b.html(c);return b}function X(a){var b=[];w(a._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,
function(c,e,d){return e+"</pre>"+d+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(c,e){b.push(e)});return b}function V(a,b){var c=b._4e_name=="pre",e=a._4e_name=="pre",d=!c&&e;if(c&&!e)b=W(a,b);else if(d)b=Y(X(a),b);else a._4e_moveChildren(b);a[0].parentNode.replaceChild(b[0],a[0]);c&&Z(b)}function Z(a){var b;if((b=a._4e_previousSourceNode(true,t.NODE_ELEMENT))&&b._4e_name()=="pre"){var c=w(b.html(),/\n$/,"")+"\n\n"+w(a.html(),/^\n/,"");if(D.ie)a[0].outerHTML="<pre>"+c+"</pre>";else a.html(c);
b._4e_remove()}}function Y(a,b){for(var c=b[0].ownerDocument.createDocumentFragment(),e=0;e<a.length;e++){var d=a[e];d=d.replace(/(\r\n|\r)/g,"\n");d=w(d,/^[ \t]*\n/,"");d=w(d,/\n$/,"");d=w(d,/^[ \t]+|[ \t]+$/g,function(g,h){return g.length==1?"&nbsp;":h?" "+(new Array(g.length)).join("&nbsp;"):(new Array(g.length)).join("&nbsp;")+" "});d=d.replace(/\n/g,"<br>");d=d.replace(/[ \t]{2,}/g,function(g){return(new Array(g.length)).join("&nbsp;")+" "});var f=b._4e_clone();f.html(d);c.appendChild(f[0])}return c}
function $(a){var b=a.document;if(a.collapsed){b=C(this,b);a.insertNode(b);a.moveToPosition(b,y.POSITION_BEFORE_END)}else{var c=this.element,e=this._.definition,d,f=n.XHTML_DTD[c]||(d=true,n.XHTML_DTD.span),g=a.createBookmark();a.enlarge(y.ENLARGE_ELEMENT);a.trim();var h=a.createBookmark(),z=h.startNode;h=h.endNode;for(var j=z,o;j&&j[0];){var i=false;if(x._4e_equals(j,h)){j=null;i=true}else{var k=j[0].nodeType,s=k==t.NODE_ELEMENT?j._4e_name():null;if(s&&j.attr("_ke_bookmark")){j=j._4e_nextSourceNode(true);
continue}if(!s||f[s]&&(j._4e_position(h)|l.POSITION_PRECEDING|l.POSITION_IDENTICAL|l.POSITION_IS_CONTAINED)==l.POSITION_PRECEDING+l.POSITION_IDENTICAL+l.POSITION_IS_CONTAINED&&(!e.childRule||e.childRule(j))){var u=j.parent();if(u&&u[0]&&((n.XHTML_DTD[u._4e_name()]||n.XHTML_DTD.span)[c]||d)&&(!e.parentRule||e.parentRule(u))){if(!o&&(!s||!n.XHTML_DTD.$removeEmpty[s]||(j._4e_position(h)|l.POSITION_PRECEDING|l.POSITION_IDENTICAL|l.POSITION_IS_CONTAINED)==l.POSITION_PRECEDING+l.POSITION_IDENTICAL+l.POSITION_IS_CONTAINED)){o=
new aa(b);o.setStartBefore(j)}if(k==t.NODE_TEXT||k==t.NODE_ELEMENT&&!j[0].childNodes.length){k=j;for(var p;!k[0].nextSibling&&(p=k.parent(),f[p._4e_name()])&&(p._4e_position(z)|l.POSITION_FOLLOWING|l.POSITION_IDENTICAL|l.POSITION_IS_CONTAINED)==l.POSITION_FOLLOWING+l.POSITION_IDENTICAL+l.POSITION_IS_CONTAINED&&(!e.childRule||e.childRule(p));)k=p;o.setEndAfter(k);k[0].nextSibling||(i=true)}}else i=true}else i=true;j=j._4e_nextSourceNode()}if(i&&o&&!o.collapsed){i=C(this,b);for(k=o.getCommonAncestor();i&&
k&&i[0]&&k[0];){if(k._4e_name()==c){for(var q in e.attributes)i.attr(q)==k.attr(q)&&i[0].removeAttribute(q);for(var E in e.styles)i._4e_style(E)==k._4e_style(E)&&i._4e_style(E,"");if(!i._4e_hasAttributes()){i=null;break}}k=k.parent()}if(i){i[0].appendChild(o.extractContents());ba(this,i);o.insertNode(i);i._4e_mergeSiblings();D.ie||i[0].normalize()}o=null}}z._4e_remove();h._4e_remove();a.moveToBookmark(g);a.shrink(y.SHRINK_TEXT)}}function ca(a){a.enlarge(y.ENLARGE_ELEMENT);var b=a.createBookmark(),
c=b.startNode;if(a.collapsed){for(var e=new F(c.parent()),d,f=0,g;f<e.elements.length&&(g=e.elements[f]);f++){if(g==e.block||g==e.blockLimit)break;if(this.checkElementRemovable(g)){var h=a.checkBoundaryOfElement(g,y.END),z=!h&&a.checkBoundaryOfElement(g,y.START);if(z||h){d=g;d.match=z?"start":"end"}else{g._4e_mergeSiblings();g._4e_name()==this.element?G(this,g):H(g,B(this)[g._4e_name()])}}}if(d&&d[0]){g=c;for(f=0;;f++){h=e.elements[f];if(x._4e_equals(h,d))break;else if(h.match)continue;else h=h._4e_clone();
h[0].appendChild(g[0]);g=h}x[d.match=="start"?"insertBefore":"insertAfter"](g[0],d[0])}}else{var j=b.endNode,o=this;e=function(){for(var i=new F(c.parent()),k=new F(j.parent()),s=null,u=null,p=0;p<i.elements.length;p++){var q=i.elements[p];if(q==i.block||q==i.blockLimit)break;if(o.checkElementRemovable(q))s=q}for(p=0;p<k.elements.length;p++){q=k.elements[p];if(q==k.block||q==k.blockLimit)break;if(o.checkElementRemovable(q))u=q}u&&j._4e_breakParent(u);s&&c._4e_breakParent(s)};e();for(d=new v(c[0].nextSibling);d[0]!==
j[0];){f=d._4e_nextSourceNode();if(d[0]&&d[0].nodeType==t.NODE_ELEMENT&&this.checkElementRemovable(d)){d._4e_name()==this.element?G(this,d):H(d,B(this)[d._4e_name()]);if(f[0].nodeType==t.NODE_ELEMENT&&f._4e_contains(c)){e();f=new v(c[0].nextSibling)}}d=f}}a.moveToBookmark(b)}function M(a){var b={};a.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(c,e,d){b[e]=d});return b}function da(a,b){typeof a=="string"&&(a=M(a));typeof b=="string"&&(b=M(b));for(var c in a)if(!(c in
b&&(b[c]==a[c]||a[c]=="inherit"||b[c]=="inherit")))return false;return true}function N(a,b){if(b!==false){b=document.createElement("span");b.style.cssText=a;a=b.style.cssText||""}else a=a;return a.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function ea(a){var b=a._AC;if(b)return b;b={};var c=0,e=a.attributes;if(e)for(var d in e){c++;b[d]=e[d]}if(e=A.getStyleText(a)){b.style||c++;b.style=e}b._length=c;return a._AC=b}function B(a){if(a._.overrides)return a._.overrides;
var b=a._.overrides={},c=a._.definition.overrides;if(c){r.isArray(c)||(c=[c]);for(var e=0;e<c.length;e++){var d=c[e],f,g;if(typeof d=="string")f=d.toLowerCase();else{f=d.element?d.element.toLowerCase():a.element;g=d.attributes}d=b[f]||(b[f]={});if(g){d=d.attributes=d.attributes||[];for(var h in g)d.push([h.toLowerCase(),g[h]])}}}return b}function G(a,b){var c=a._.definition,e=r.mix(r.mix({},c.attributes),B(a)[b._4e_name()]);c=c.styles;var d=r.isEmptyObject(e)&&r.isEmptyObject(c);for(var f in e)if(!((f==
"class"||a._.definition.fullMatch)&&b.attr(f)!=O(f,e[f]))){d=d||!!b._4e_hasAttribute(f);b.removeAttr(f)}for(var g in c)if(!(a._.definition.fullMatch&&b._4e_style(g)!=O(g,c[g],true))){d=d||!!b._4e_style(g);b._4e_style(g,"")}d&&P(b)}function O(a,b,c){var e=new v("<span></span>");e[c?"_4e_style":"attr"](a,b);return e[c?"_4e_style":"attr"](a)}function ba(a,b){for(var c=B(a),e=b.all(a.element),d=e.length;--d>=0;)G(a,new v(e[d]));for(var f in c)if(f!=a.element){e=b.all(f);for(d=e.length-1;d>=0;d--){var g=
new v(e[d]);H(g,c[f])}}}function H(a,b){if(b=b&&b.attributes)for(var c=0;c<b.length;c++){var e=b[c][0],d;if(d=a.attr(e)){var f=b[c][1];if(f===null||f.test&&f.test(d)||typeof f=="string"&&d==f)a[0].removeAttribute(e)}}P(a)}function P(a){if(!a._4e_hasAttributes()){var b=a[0].firstChild,c=a[0].lastChild;a._4e_remove(true);if(b){b.nodeType==t.NODE_ELEMENT&&x._4e_mergeSiblings(b);c&&!b===c&&c.nodeType==t.NODE_ELEMENT&&x._4e_mergeSiblings(c)}}}var r=KISSY,x=r.DOM,m=n.STYLE={},y=n.RANGE,T=n.Selection,t=
n.NODE,l=n.POSITION,aa=n.Range,v=r.Node,D=r.UA,F=n.ElementPath,S={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},J={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},Q=/\s*(?:;\s*|$)/,R=/#\((.+?)\)/g;m.STYLE_BLOCK=1;m.STYLE_INLINE=2;m.STYLE_OBJECT=3;A.prototype={apply:function(a){K.call(this,a,false)},remove:function(a){K.call(this,a,true)},applyToRange:function(a){return(this.applyToRange=this.type==m.STYLE_INLINE?$:this.type==m.STYLE_BLOCK?U:this.type==
m.STYLE_OBJECT?null:null).call(this,a)},removeFromRange:function(a){return(this.removeFromRange=this.type==m.STYLE_INLINE?ca:null).call(this,a)},applyToObject:function(a){L(a,this)},checkElementRemovable:function(a,b){if(!a)return false;var c=this._.definition;if(a._4e_name()==this.element){if(!b&&!a._4e_hasAttributes())return true;c=ea(c);if(c._length){for(var e in c)if(e!="_length"){var d=a.attr(e)||"";if(e=="style"?da(c[e],N(d,false)):c[e]==d){if(!b)return true}else if(b)return false}if(b)return true}else return true}if(c=
B(this)[a._4e_name()]){if(!(c=c.attributes))return true;for(b=0;b<c.length;b++){e=c[b][0];if(e=a.attr(e)){d=c[b][1];if(d===null||typeof d=="string"&&e==d||d.test&&d.test(e))return true}}}return false},checkActive:function(a){switch(this.type){case m.STYLE_BLOCK:return this.checkElementRemovable(a.block||a.blockLimit,true);case m.STYLE_OBJECT:case m.STYLE_INLINE:for(var b=a.elements,c=0,e;c<b.length;c++){e=b[c];if(!(this.type==m.STYLE_INLINE&&(x._4e_equals(e,a.block)||x._4e_equals(e,a.blockLimit))))if(!(this.type==
m.STYLE_OBJECT&&!(e._4e_name()in J)))if(this.checkElementRemovable(e,true))return true}}return false}};A.getStyleText=function(a){var b=a._ST;if(b)return b;b=a.styles;var c=a.attributes&&a.attributes.style||"",e="";if(c.length)c=c.replace(Q,";");for(var d in b){var f=b[d],g=(d+":"+f).replace(Q,";");if(f=="inherit")e+=g;else c+=g}if(c.length)c=N(c);c+=e;return a._ST=c};n.Style=A});
