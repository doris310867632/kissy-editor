KISSY.Editor.add("styles",function(n){function I(a,b){for(var c in a)a[c]=a[c].replace(R,function(d,e){return b[e]})}function A(a,b){if(b){a=r.clone(a);I(a.attributes,b);I(a.styles,b)}b=this.element=(a.element||"*").toLowerCase();this.type=b=="#"||S[b]?m.STYLE_BLOCK:J[b]?m.STYLE_OBJECT:m.STYLE_INLINE;this._={definition:a}}function K(a,b){b=b?this.removeFromRange:this.applyToRange;a.body.focus();a=new T(a);for(var c=a.getRanges(),d=0;d<c.length;d++)b.call(this,c[d]);a.selectRanges(c)}function C(a,
b){var c=a.element;if(c=="*")c="span";b=new v(b.createElement(c));return L(b,a)}function L(a,b){var c=b._.definition;b=c.attributes;c=A.getStyleText(c);if(b)for(var d in b)a.attr(d,b[d]);if(c)a[0].style.cssText=c;return a}function U(a){var b=a.createBookmark(true),c=a.createIterator();c.enforceRealBlocks=true;c.enlargeBr=true;for(var d,e=a.document;d=c.getNextParagraph();){var f=C(this,e);V(d,f)}a.moveToBookmark(b)}function w(a,b,c){var d="",e="";a=a.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,
function(f,g,h){g&&(d=g);h&&(e=h);return""});return d+a.replace(b,c)+e}function W(a,b){var c=a.html();c=w(c,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,"");c=c.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1");c=c.replace(/([ \t\n\r]+|&nbsp;)/g," ");c=c.replace(/<br\b[^>]*>/gi,"\n");if(D.ie){a=a[0].ownerDocument.createElement("div");a.appendChild(b[0]);b[0].outerHTML="<pre>"+c+"</pre>";b=new v(a.firstChild);b._4e_remove()}else b.html(c);return b}function X(a){var b=[];w(a._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,
function(c,d,e){return d+"</pre>"+e+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(c,d){b.push(d)});return b}function V(a,b){var c=b._4e_name=="pre",d=a._4e_name=="pre",e=!c&&d;if(c&&!d)b=W(a,b);else if(e)b=Y(X(a),b);else a._4e_moveChildren(b);a[0].parentNode.replaceChild(b[0],a[0]);c&&Z(b)}function Z(a){var b;if((b=a._4e_previousSourceNode(true,t.NODE_ELEMENT))&&b._4e_name()=="pre"){var c=w(b.html(),/\n$/,"")+"\n\n"+w(a.html(),/^\n/,"");if(D.ie)a[0].outerHTML="<pre>"+c+"</pre>";else a.html(c);
b._4e_remove()}}function Y(a,b){for(var c=b[0].ownerDocument.createDocumentFragment(),d=0;d<a.length;d++){var e=a[d];e=e.replace(/(\r\n|\r)/g,"\n");e=w(e,/^[ \t]*\n/,"");e=w(e,/\n$/,"");e=w(e,/^[ \t]+|[ \t]+$/g,function(g,h){return g.length==1?"&nbsp;":h?" "+(new Array(g.length)).join("&nbsp;"):(new Array(g.length)).join("&nbsp;")+" "});e=e.replace(/\n/g,"<br>");e=e.replace(/[ \t]{2,}/g,function(g){return(new Array(g.length)).join("&nbsp;")+" "});var f=b._4e_clone();f.html(e);c.appendChild(f[0])}return c}
function $(a){var b=a.document;if(a.collapsed){b=C(this,b);a.insertNode(b);a.moveToPosition(b,y.POSITION_BEFORE_END)}else{var c=this.element,d=this._.definition,e,f=n.XHTML_DTD[c]||(e=true,n.XHTML_DTD.span),g=a.createBookmark();a.enlarge(y.ENLARGE_ELEMENT);a.trim();var h=a.createBookmark(),z=h.startNode;h=h.endNode;for(var j=z,o;j&&j[0];){var i=false;if(x._4e_equals(j,h)){j=null;i=true}else{var k=j[0].nodeType,s=k==t.NODE_ELEMENT?j._4e_name():null;if(s&&j.attr("_ke_bookmark")){j=j._4e_nextSourceNode(true);
continue}if(!s||f[s]&&(j._4e_position(h)|l.POSITION_PRECEDING|l.POSITION_IDENTICAL|l.POSITION_IS_CONTAINED)==l.POSITION_PRECEDING+l.POSITION_IDENTICAL+l.POSITION_IS_CONTAINED&&(!d.childRule||d.childRule(j))){var u=j.parent();if(u&&u[0]&&((n.XHTML_DTD[u._4e_name()]||n.XHTML_DTD.span)[c]||e)&&(!d.parentRule||d.parentRule(u))){if(!o&&(!s||!n.XHTML_DTD.$removeEmpty[s]||(j._4e_position(h)|l.POSITION_PRECEDING|l.POSITION_IDENTICAL|l.POSITION_IS_CONTAINED)==l.POSITION_PRECEDING+l.POSITION_IDENTICAL+l.POSITION_IS_CONTAINED)){o=
new aa(b);o.setStartBefore(j)}if(k==t.NODE_TEXT||k==t.NODE_ELEMENT&&!j[0].childNodes.length){k=j;for(var p;!k[0].nextSibling&&(p=k.parent(),f[p._4e_name()])&&(p._4e_position(z)|l.POSITION_FOLLOWING|l.POSITION_IDENTICAL|l.POSITION_IS_CONTAINED)==l.POSITION_FOLLOWING+l.POSITION_IDENTICAL+l.POSITION_IS_CONTAINED&&(!d.childRule||d.childRule(p));)k=p;o.setEndAfter(k);k[0].nextSibling||(i=true)}}else i=true}else i=true;j=j._4e_nextSourceNode()}if(i&&o&&!o.collapsed){i=C(this,b);for(k=o.getCommonAncestor();i&&
k&&i[0]&&k[0];){if(k._4e_name()==c){for(var q in d.attributes)i.attr(q)==k.attr(q)&&i[0].removeAttribute(q);for(var E in d.styles)i._4e_style(E)==k._4e_style(E)&&i._4e_style(E,"");if(!i._4e_hasAttributes()){i=null;break}}k=k.parent()}if(i){i[0].appendChild(o.extractContents());ba(this,i);o.insertNode(i);i._4e_mergeSiblings();D.ie||i[0].normalize()}o=null}}z._4e_remove();h._4e_remove();a.moveToBookmark(g);a.shrink(y.SHRINK_TEXT)}}function ca(a){a.enlarge(y.ENLARGE_ELEMENT);var b=a.createBookmark(),
c=b.startNode;if(a.collapsed){for(var d=new F(c.parent()),e,f=0,g;f<d.elements.length&&(g=d.elements[f]);f++){if(g==d.block||g==d.blockLimit)break;if(this.checkElementRemovable(g)){var h=a.checkBoundaryOfElement(g,y.END),z=!h&&a.checkBoundaryOfElement(g,y.START);if(z||h){e=g;e.match=z?"start":"end"}else{g._4e_mergeSiblings();g._4e_name()==this.element?G(this,g):H(g,B(this)[g._4e_name()])}}}if(e&&e[0]){g=c;for(f=0;;f++){h=d.elements[f];if(x._4e_equals(h,e))break;else if(h.match)continue;else h=h._4e_clone();
h[0].appendChild(g[0]);g=h}x[e.match=="start"?"insertBefore":"insertAfter"](g[0],e[0])}}else{var j=b.endNode,o=this;d=function(){for(var i=new F(c.parent()),k=new F(j.parent()),s=null,u=null,p=0;p<i.elements.length;p++){var q=i.elements[p];if(q==i.block||q==i.blockLimit)break;if(o.checkElementRemovable(q))s=q}for(p=0;p<k.elements.length;p++){q=k.elements[p];if(q==k.block||q==k.blockLimit)break;if(o.checkElementRemovable(q))u=q}u&&j._4e_breakParent(u);s&&c._4e_breakParent(s)};d();for(e=new v(c[0].nextSibling);e[0]!==
j[0];){f=e._4e_nextSourceNode();if(e[0].nodeType==t.NODE_ELEMENT&&this.checkElementRemovable(e)){e._4e_name()==this.element?G(this,e):H(e,B(this)[e._4e_name()]);if(f[0].nodeType==t.NODE_ELEMENT&&f._4e_contains(c)){d();f=new v(c[0].nextSibling)}}e=f}}a.moveToBookmark(b)}function M(a){var b={};a.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(c,d,e){b[d]=e});return b}function da(a,b){typeof a=="string"&&(a=M(a));typeof b=="string"&&(b=M(b));for(var c in a)if(!(c in b&&
(b[c]==a[c]||a[c]=="inherit"||b[c]=="inherit")))return false;return true}function N(a,b){if(b!==false){b=document.createElement("span");b.style.cssText=a;a=b.style.cssText||""}else a=a;return a.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function ea(a){var b=a._AC;if(b)return b;b={};var c=0,d=a.attributes;if(d)for(var e in d){c++;b[e]=d[e]}if(d=A.getStyleText(a)){b.style||c++;b.style=d}b._length=c;return a._AC=b}function B(a){if(a._.overrides)return a._.overrides;
var b=a._.overrides={},c=a._.definition.overrides;if(c){r.isArray(c)||(c=[c]);for(var d=0;d<c.length;d++){var e=c[d],f,g;if(typeof e=="string")f=e.toLowerCase();else{f=e.element?e.element.toLowerCase():a.element;g=e.attributes}e=b[f]||(b[f]={});if(g){e=e.attributes=e.attributes||[];for(var h in g)e.push([h.toLowerCase(),g[h]])}}}return b}function G(a,b){var c=a._.definition,d=r.mix(r.mix({},c.attributes),B(a)[b._4e_name()]);c=c.styles;var e=r.isEmptyObject(d)&&r.isEmptyObject(c);for(var f in d)if(!((f==
"class"||a._.definition.fullMatch)&&b.attr(f)!=O(f,d[f]))){e=e||!!b._4e_hasAttribute(f);b.removeAttr(f)}for(var g in c)if(!(a._.definition.fullMatch&&b._4e_style(g)!=O(g,c[g],true))){e=e||!!b._4e_style(g);b._4e_style(g,"")}e&&P(b)}function O(a,b,c){var d=new v("<span></span>");d[c?"_4e_style":"attr"](a,b);return d[c?"_4e_style":"attr"](a)}function ba(a,b){for(var c=B(a),d=b.all(a.element),e=d.length;--e>=0;)G(a,new v(d[e]));for(var f in c)if(f!=a.element){d=b.all(f);for(e=d.length-1;e>=0;e--){var g=
new v(d[e]);H(g,c[f])}}}function H(a,b){if(b=b&&b.attributes)for(var c=0;c<b.length;c++){var d=b[c][0],e;if(e=a.attr(d)){var f=b[c][1];if(f===null||f.test&&f.test(e)||typeof f=="string"&&e==f)a[0].removeAttribute(d)}}P(a)}function P(a){if(!a._4e_hasAttributes()){var b=a[0].firstChild,c=a[0].lastChild;a._4e_remove(true);if(b){b.nodeType==t.NODE_ELEMENT&&x._4e_mergeSiblings(b);c&&!b===c&&c.nodeType==t.NODE_ELEMENT&&x._4e_mergeSiblings(c)}}}var r=KISSY,x=r.DOM,m=n.STYLE={},y=n.RANGE,T=n.Selection,t=
n.NODE,l=n.POSITION,aa=n.Range,v=r.Node,D=r.UA,F=n.ElementPath,S={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},J={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},Q=/\s*(?:;\s*|$)/,R=/#\((.+?)\)/g;m.STYLE_BLOCK=1;m.STYLE_INLINE=2;m.STYLE_OBJECT=3;A.prototype={apply:function(a){K.call(this,a,false)},remove:function(a){K.call(this,a,true)},applyToRange:function(a){return(this.applyToRange=this.type==m.STYLE_INLINE?$:this.type==m.STYLE_BLOCK?U:this.type==
m.STYLE_OBJECT?null:null).call(this,a)},removeFromRange:function(a){return(this.removeFromRange=this.type==m.STYLE_INLINE?ca:null).call(this,a)},applyToObject:function(a){L(a,this)},checkElementRemovable:function(a,b){if(!a)return false;var c=this._.definition;if(a._4e_name()==this.element){if(!b&&!a._4e_hasAttributes())return true;c=ea(c);if(c._length){for(var d in c)if(d!="_length"){var e=a.attr(d)||"";if(d=="style"?da(c[d],N(e,false)):c[d]==e){if(!b)return true}else if(b)return false}if(b)return true}else return true}if(c=
B(this)[a._4e_name()]){if(!(c=c.attributes))return true;for(b=0;b<c.length;b++){d=c[b][0];if(d=a.attr(d)){e=c[b][1];if(e===null||typeof e=="string"&&d==e||e.test(d))return true}}}return false},checkActive:function(a){switch(this.type){case m.STYLE_BLOCK:return this.checkElementRemovable(a.block||a.blockLimit,true);case m.STYLE_OBJECT:case m.STYLE_INLINE:for(var b=a.elements,c=0,d;c<b.length;c++){d=b[c];if(!(this.type==m.STYLE_INLINE&&(x._4e_equals(d,a.block)||x._4e_equals(d,a.blockLimit))))if(!(this.type==
m.STYLE_OBJECT&&!(d._4e_name()in J)))if(this.checkElementRemovable(d,true))return true}}return false}};A.getStyleText=function(a){var b=a._ST;if(b)return b;b=a.styles;var c=a.attributes&&a.attributes.style||"",d="";if(c.length)c=c.replace(Q,";");for(var e in b){var f=b[e],g=(e+":"+f).replace(Q,";");if(f=="inherit")d+=g;else c+=g}if(c.length)c=N(c);c+=d;return a._ST=c};n.Style=A});
