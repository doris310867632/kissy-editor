KISSY.Editor.add("music",function(l){var d=KISSY.Editor;d.MusicInserter||function(){function f(a){f.superclass.constructor.call(this,a);a=this.get("editor");a._toolbars=a._toolbars||{};a._toolbars.music=this;this._init()}function g(a){return a.replace(/^.+niftyplayer\.swf\?file=/,"")}var e=KISSY,i=e.Node,j=e.DOM,n=d.ContextMenu,k=e.Event,o=d.SimpleOverlay,p=d.TripleButton,q='<ke:object  width="165" height="37" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,0,0" classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"><ke:param value="'+
(d.Config.base+'plugins/music/niftyplayer.swf?file=#(music)&amp;as=0"')+' name="movie"></ke:param><ke:param value="high" name="quality"></ke:param><ke:param value="#FFFFFF" name="bgcolor"></ke:param><ke:embed width="165" height="37" type="application/x-shockwave-flash" swliveconnect="true" src="'+(d.Config.base+'plugins/music/niftyplayer.swf?file=#(music)&amp;as=0"')+'quality="high" pluginspage="http://www.macromedia.com/go/getflashplayer" bgcolor="#FFFFFF"></ke:embed></ke:object>',r=/#\(music\)/g,
s=["img.ke_music"];f.ATTRS={editor:{}};e.extend(f,e.Base,{_init:function(){var a=this.get("editor"),b={};this.el=new p({contentCls:"ke-toolbar-music",title:"\u5206\u4eab\u97f3\u4e50",container:a.toolBarDiv});k.on(a.document,"dblclick",this._dblclick,this);for(var c in m)(function(h){b[h]=function(){a.fire("save");a.focus();m[h](a);a.fire("save")}})(c);n.register(a.document,{rules:s,width:"120px",funcs:b});this.el.on("offClick",this.show,this);d.Utils.lazyRun(this,"_prepare","_real")},_prepare:function(){var a=
this,b=a.get("editor");a.content=new i("<div class='ke-popup-wrap' style='width:250px;padding:10px;'><p style='margin:0 0 10px'><label>\u8bf7\u8f93\u5165\u97f3\u4e50\u5730\u5740\uff1a<br/><input value='http://' style='width: 250px;' class='ke-music-url'/></label></p><p><button class='ke-music-insert'>\u63d2\u5165</button>&nbsp;<a href='#' class='ke-music-cancel'>\u53d6\u6d88</a></p></div>");a.d=new o({el:a.content});a.d.on("hide",function(){a.selectedFlash=null;b.focus()});document.body.appendChild(a.content[0]);
var c=a.content.one(".ke-music-cancel"),h=a.content.one(".ke-music-insert");a.musicUrl=a.content.one(".ke-music-url");c.on("click",function(t){a.d.hide();t.halt()},a);k.on(document,"click",a.hide,a);k.on(b.document,"click",a.hide,a);h.on("click",function(){a._insert()})},hide:function(a){var b=this;j._4e_ascendant(a.target,function(c){return c[0]===b.content[0]||c[0]===b.el.el[0]})||this.d.hide()},_real:function(){var a=this.el.el.offset();a.top+=this.el.el.height()+5;if(a.left+this.content.width()>
j.viewportWidth()-60)a.left=j.viewportWidth()-this.content.width()-60;this.d.show(a)},_insert:function(){var a=this.get("editor"),b=this.musicUrl.val();if(b){b=new i(q.replace(r,b),null,a.document);b=a.createFakeElement?a.createFakeElement(b,"ke_music","music",true):b;a.insertElement(b);this.d.hide()}},_dblclick:function(a){var b=new i(a.target);if(b._4e_name()==="img"&&b.hasClass("ke_music")){this.selectedFlash=b;this.show();a.halt()}},show:function(){this._prepare();if(this.selectedFlash){var a=
this.get("editor").restoreRealElement(this.selectedFlash);if(a._4e_name()=="ke:object"){for(var b=a._4e_getElementsByTagName("param","ke"),c=0;c<b.length;c++)if((b[c].attr("name")||"").toLowerCase()=="movie")this.musicUrl.val(g(b[c].attr("value")));b=a._4e_getElementsByTagName("embed","ke");for(c=0;c<b.length;c++)this.musicUrl.val(g(b[c].attr("src")));a=a._4e_getElementsByTagName("object","ke");for(c=0;c<a.length;c++)this.musicUrl.val(g(a[c].attr("data")))}else a._4e_name()=="ke:embed"&&this.musicUrl.val(g(a.attr("src")))}}});
d.MusicInserter=f;var m={"\u7f16\u8f91\u97f3\u4e50":function(a){var b=a.getSelection();if(b=(b=b&&b.getStartElement())&&b._4e_ascendant("img",true))if(b.hasClass("ke_music")){a=a._toolbars.music;a.selectedFlash=b;a.show()}}}}();l.addPlugin(function(){new d.MusicInserter({editor:l})})});
