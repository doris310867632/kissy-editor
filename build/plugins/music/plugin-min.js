KISSY.Editor.add("music",function(k){var d=KISSY.Editor,n=d.NODE;d.MusicInserter||function(){function h(a){h.superclass.constructor.call(this,a);a=this.get("editor");a._toolbars=a._toolbars||{};a._toolbars.music=this;this._init()}function i(a){return a.replace(/^.+niftyplayer\.swf\?file=/,"")}var g=KISSY,l=g.Node,e=g.DOM,o=d.ContextMenu,j=g.Event,p=d.SimpleOverlay,q=d.TripleButton;MUSIC_MARKUP='<object  width="165" height="37" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,0,0" classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"><param value="'+
(d.Config.base+'plugins/music/niftyplayer.swf?file=#(music)&amp;as=0"')+' name="movie"/><param value="high" name="quality"/><param value="#FFFFFF" name="bgcolor"/><embed width="165" height="37" type="application/x-shockwave-flash" swliveconnect="true" src="'+(d.Config.base+'plugins/music/niftyplayer.swf?file=#(music)&amp;as=0"')+'quality="high" pluginspage="http://www.macromedia.com/go/getflashplayer" bgcolor="#FFFFFF" /></object>';music_reg=/#\(music\)/g;flashRules=["img.ke_music"];h.ATTRS={editor:{}};
g.extend(h,g.Base,{_init:function(){var a=this.get("editor"),b={};this.el=new q({contentCls:"ke-toolbar-music",title:"\u5206\u4eab\u97f3\u4e50",container:a.toolBarDiv});j.on(a.document,"dblclick",this._dblclick,this);for(var c in m)(function(f){b[f]=function(){a.fire("save");a.focus();m[f](a);a.fire("save")}})(c);o.register(a.document,{rules:flashRules,width:"120px",funcs:b});this.el.on("offClick",this.show,this);d.Utils.lazyRun(this,"_prepare","_real")},_prepare:function(){var a=this,b=a.get("editor");
a.d=new p({title:"\u63d2\u5165\u97f3\u4e50",mask:true,width:"350px"});var c=a.d;c.body.html("<div><p><label><span style='color:#0066CC;font-weight:bold;'>\u97f3\u4e50\u7f51\u5740\uff1a</span><input class='ke-music-url' style='width:230px' value='http://'/></label></p></div>");c.foot.html("<button class='ke-music-insert'>\u63d2\u5165</button> <button class='ke-music-cancel'>\u53d6\u6d88</button>");a.content=c.el;var f=a.content;c.on("hide",function(){a.selectedFlash=null;b.focus()});c=f.one(".ke-music-cancel");
var r=f.one(".ke-music-insert");a.musicUrl=f.one(".ke-music-url");c.on("click",function(s){a.d.hide();s.halt()});j.on(document,"click",a.hide,a);j.on(b.document,"click",a.hide,a);r.on("click",function(){a._insert()})},hide:function(a){var b=this;e._4e_ascendant(a.target,function(c){return c[0]===b.content[0]||c[0]===b.el.el[0]})||this.d.hide()},_real:function(){this.d.show()},_insert:function(){var a=this.get("editor"),b=this.musicUrl.val();if(b){b=MUSIC_MARKUP.replace(music_reg,b);var c=new l(b,
null,a.document);b=a.createFakeElement?a.createFakeElement(c,"ke_music","music",true,b):c;a.insertElement(b);this.d.hide()}},_dblclick:function(a){var b=new l(a.target);if(b._4e_name()==="img"&&b.hasClass("ke_music")){this.selectedFlash=b;this.show();a.halt()}},show:function(){this._prepare();if(this.selectedFlash){var a=this.get("editor").restoreRealElement(this.selectedFlash);if(a._4e_name()=="object"){a=a[0].childNodes;for(var b=0;b<a.length;b++)if(a[b].nodeType==n.NODE_ELEMENT)if((e.attr(a[b],
"name")||"").toLowerCase()=="movie")this.musicUrl.val(i(e.attr(a[b],"value")));else if(e._4e_name(a[b])=="embed")this.musicUrl.val(i(e.attr(a[b],"src")));else e._4e_name(a[b])=="object"&&this.musicUrl.val(i(e.attr(a[b],"data")))}else a._4e_name()=="embed"&&this.musicUrl.val(i(a.attr("src")))}}});d.MusicInserter=h;var m={"\u7f16\u8f91\u97f3\u4e50":function(a){var b=a.getSelection();if(b=(b=b&&b.getStartElement())&&b._4e_ascendant("img",true))if(b.hasClass("ke_music")){a=a._toolbars.music;a.selectedFlash=
b;a.show()}}}}();k.addPlugin(function(){new d.MusicInserter({editor:k})})});
