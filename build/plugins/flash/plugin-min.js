KISSY.Editor.add("flash",function(l){var d=KISSY.Editor,j=KISSY,h=j.DOM,p=j.Event,u=d.ContextMenu,m=j.Node,v=d.NODE,w=d.TripleButton,q=d.SimpleOverlay,x=/\.swf(?:$|\?)/i,i=d.HtmlDataProcessor,y="niftyplayer.swf",r=d.Utils.getFlashUrl,s=i&&i.dataFilter,z=["img.ke_flash"];d.Flash||function(){function k(a){a=a.attributes;return a.type=="application/x-shockwave-flash"||x.test(a.src||"")}function n(a){return a.indexOf(y)!=-1}function e(a){this.editor=a;a._toolbars=a._toolbars||{};a._toolbars.flash=this;
this._init()}s&&s.addRules({elements:{object:function(a){var b=a.attributes,c="ke_flash",g="flash";if(!(b.classid&&String(b.classid).toLowerCase())){for(b=0;b<a.children.length;b++)if(a.children[b].name=="embed"){if(!k(a.children[b]))return null;if(n(a.children[b].attributes.src)){c="ke_music";g="music"}return i.createFakeParserElement(a,c,g,true)}return null}for(b=0;b<a.children.length;b++){var f=a.children[b];if(f.name=="param"&&f.attributes.name=="movie")if(n(f.attributes.value)){c="ke_music";
g="music";break}}return i.createFakeParserElement(a,c,g,true)},embed:function(a){if(!k(a))return null;var b="ke_flash",c="flash";if(n(a.attributes.src)){b="ke_music";c="music"}return i.createFakeParserElement(a,b,c,true)}}},5);j.augment(e,{_init:function(){var a=this.editor,b={};this.el=new w({container:a.toolBarDiv,contentCls:"ke-toolbar-flash",title:"Flash"});this.el.on("click",this._showConfig,this);p.on(a.document,"dblclick",this._dbclick,this);for(var c in t)(function(g){b[g]=function(){a.fire("save");
a.focus();t[g](a);a.fire("save")}})(c);u.register(a.document,{rules:z,width:"120px",funcs:b});d.Utils.lazyRun(this,"_prepareShow","_realShow");a.on("selectionChange",this._selectionChange,this)},_selectionChange:function(a){a=a.path;var b=a.elements;if(a&&b)if(a=a.lastElement)(a=a._4e_ascendant(function(c){return c._4e_name()==="img"&&!!c.hasClass("ke_flash")},true))?this._showTip(a):this._hideTip()},_showTip:function(a){this._prepareTip(a)},_hideTip:function(){e.tipwin&&e.tipwin.hide()},_prepareTip:function(){e.tip&&
e.tip()},_realTip:function(a){var b=this.editor,c=a._4e_getOffset(document);c.top+=a.height()+5;e.tipwin.show(c);this.selectedFlash=a;a=b.restoreRealElement(this.selectedFlash);e.tipwin.flash=this;e.tipurl.html(r(a));e.tipurl.attr("href",r(a))},_dbclick:function(a){var b=new m(a.target);if(b._4e_name()==="img"&&b.hasClass("ke_flash")){this.selectedFlash=b;this._showConfig();a.halt()}},_prepareShow:function(){var a=this;a.d=new q({title:"\u7f16\u8f91flash",width:"350px",mask:true});a.d.on("hide",function(){a.selectedFlash=
null});a.d.body.html("<div><p><label>\u5730\u5740\ufffd?<input class='ke-flash-url' style='width:280px' /></label></p><p style='margin:5px 0'><label>\u5bbd\u5ea6\ufffd?<input class='ke-flash-width' style='width:110px' /></label>&nbsp;&nbsp;<label>\u9ad8\u5ea6\ufffd?input class='ke-flash-height' style='width:110px' /></label></p>");a.d.foot.html("<button class='ke-flash-ok'>\u786e\u5b9a</button> <button class='ke-flash-cancel'>\u53d6\u6d88</button></div>");a._initD()},_realShow:function(){this.d.show()},
_showConfig:function(){var a=this.editor,b=this.selectedFlash;this._prepareShow();if(b){a=a.restoreRealElement(b);a.attr("width")&&this.dWidth.val(parseInt(a.attr("width")));a.attr("height")&&this.dHeight.val(parseInt(a.attr("height")));if(a._4e_name()=="object"){a=a[0].childNodes;for(b=0;b<a.length;b++)if(a[b].nodeType==v.NODE_ELEMENT)if((h.attr(a[b],"name")||"").toLowerCase()=="movie")this.dUrl.val(h.attr(a[b],"value"));else if(h._4e_name(a[b])=="embed")this.dUrl.val(h.attr(a[b],"src"));else h._4e_name(a[b])==
"object"&&this.dUrl.val(h.attr(a[b],"data"))}else a._4e_name()=="embed"&&this.dUrl.val(a.attr("src"))}else{this.dUrl.val("");this.dWidth.val("");this.dHeight.val("")}},_initD:function(){var a=this,b=a.d;a.dHeight=b.el.one(".ke-flash-height");a.dWidth=b.el.one(".ke-flash-width");a.dUrl=b.el.one(".ke-flash-url");var c=b.el.one(".ke-flash-ok");b=b.el.one(".ke-flash-cancel");c.on("click",a._gen,a);b.on("click",function(){a.d.hide()})},_gen:function(){var a=this.editor,b=this.dUrl.val();if(b){b="<object "+
(parseInt(this.dWidth.val())?" width='"+parseInt(this.dWidth.val())+"' ":" ")+(parseInt(this.dHeight.val())?" height='"+parseInt(this.dHeight.val())+"' ":" ")+' classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"  codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,0,0"><param name="quality" value="high" /><param name="movie" value="'+b+'" /><embed '+(parseInt(this.dWidth.val())?" width='"+parseInt(this.dWidth.val())+"' ":" ")+(parseInt(this.dHeight.val())?" height='"+
parseInt(this.dHeight.val())+"' ":" ")+'pluginspage="http://www.macromedia.com/go/getflashplayer" quality="high"  src="'+b+'"  type="application/x-shockwave-flash"/></object>';var c=new m(b,null,a.document);b=a.createFakeElement?a.createFakeElement(c,"ke_flash","flash",true,b):c;a.insertElement(b);this.d.hide()}}});d.Utils.lazyRun(e.prototype,"_prepareTip","_realTip");d.Flash=e;e.tip=function(){var a=this,b=new m('<div class="ke-bubbleview-bubble" onmousedown="return false;">Flash \u7f51\u5740\ufffd? <a class="ke-bubbleview-url" target="_blank" href="#"></a> -     <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -     <span class="ke-bubbleview-link ke-bubbleview-remove">\u5220\u9664</span></div>'),
c=b.one(".ke-bubbleview-change"),g=b.one(".ke-bubbleview-remove");b._4e_unselectable();a.tipwin=new q({el:b,focusMgr:false});document.body.appendChild(b[0]);a.tipurl=b.one(".ke-bubbleview-url");a.tipwin.on("hide",function(){var f=a.tipwin.flash;f&&(f.selectedFlash=null)});c.on("click",function(f){a.tipwin.flash._showConfig();f.halt()});g.on("click",function(f){var o=a.tipwin.flash;o.selectedFlash._4e_remove();o.editor.notifySelectionChange();o.selectedFlash=null;f.halt()});a.tip=null};var t={"\u7f16\u8f91Flash":function(a){var b=
a.getSelection();if(b=(b=b&&b.getStartElement())&&b._4e_ascendant("img",true))if(b.hasClass("ke_flash")){a=a._toolbars.flash;a.selectedFlash=b;a._showConfig()}}}}();l.addPlugin(function(){new d.Flash(l);var k=h._4e_getWin(l.document);p.on(k,"scroll",function(){d.Flash.tipwin&&d.Flash.tipwin.hide()})})});
