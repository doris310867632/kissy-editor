KISSY.Editor.add("flash",function(j){function q(c){c=c.attributes;return c.type=="application/x-shockwave-flash"||u.test(c.src||"")}function m(c){return c.indexOf(v)!=-1}var f=KISSY.Editor,k=KISSY,h=k.DOM,n=k.Event,w=f.ContextMenu,o=k.Node,x=f.NODE,y=f.TripleButton,r=f.SimpleOverlay,u=/\.swf(?:$|\?)/i,i=j.htmlDataProcessor,v="niftyplayer.swf",s=f.Utils.getFlashUrl,t=i&&i.dataFilter,z=["img.ke_flash"];t&&t.addRules({elements:{object:function(c){var d=c.attributes,a="ke_flash",b="flash";if(!(d.classid&&
String(d.classid).toLowerCase())){for(d=0;d<c.children.length;d++)if(c.children[d].name=="embed"){if(!q(c.children[d]))return null;if(m(c.children[d].attributes.src)){a="ke_music";b="music"}return i.createFakeParserElement(c,a,b,true)}return null}for(d=0;d<c.children.length;d++){var e=c.children[d];if(e.name=="param"&&e.attributes.name=="movie")if(m(e.attributes.value)){a="ke_music";b="music";break}}return i.createFakeParserElement(c,a,b,true)},embed:function(c){if(!q(c))return null;var d="ke_flash",
a="flash";if(m(c.attributes.src)){d="ke_music";a="music"}return i.createFakeParserElement(c,d,a,true)}}},5);f.Flash||function(){function c(a){this.editor=a;a._toolbars=a._toolbars||{};a._toolbars.flash=this;this._init()}k.augment(c,{_init:function(){var a=this.editor,b={};this.el=new y({container:a.toolBarDiv,contentCls:"ke-toolbar-flash",title:"Flash"});this.el.on("click",this._showConfig,this);n.on(a.document,"dblclick",this._dbclick,this);for(var e in d)(function(l){b[l]=function(){a.fire("save");
d[l](a);a.fire("save")}})(e);w.register(a.document,{rules:z,width:"120px",funcs:b});f.Utils.lazyRun(this,"_prepareShow","_realShow");a.on("selectionChange",this._selectionChange,this)},_selectionChange:function(a){a=a.path;var b=a.elements;if(a&&b)if(a=a.lastElement)(a=a._4e_ascendant(function(e){return e._4e_name()==="img"&&!!e.hasClass("ke_flash")},true))?this._showTip(a):this._hideTip()},_showTip:function(a){this._prepareTip(a)},_hideTip:function(){c.tipwin&&c.tipwin.hide()},_prepareTip:function(){c.tip&&
c.tip()},_realTip:function(a){var b=this.editor,e=a._4e_getOffset(document);e.top+=a.height()+5;c.tipwin.show(e);this.selectedFlash=a;a=b.restoreRealElement(this.selectedFlash);c.tipwin.flash=this;c.tipurl.html(s(a));c.tipurl.attr("href",s(a))},_dbclick:function(a){var b=new o(a.target);if(b._4e_name()==="img"&&b.hasClass("ke_flash")){this.selectedFlash=b;this._showConfig();a.halt()}},_prepareShow:function(){var a=this;a.d=new r({title:"\u7f16\u8f91flash",width:"350px",mask:true});a.d.on("hide",function(){a.selectedFlash=
null});a.d.body.html("<div><p><label>\u5730\u5740\ufffd?<input class='ke-flash-url' style='width:280px' /></label></p><p style='margin:5px 0'><label>\u5bbd\u5ea6\ufffd?<input class='ke-flash-width' style='width:110px' /></label>&nbsp;&nbsp;<label>\u9ad8\u5ea6\ufffd?input class='ke-flash-height' style='width:110px' /></label></p>");a.d.foot.html("<button class='ke-flash-ok'>\u786e\u5b9a</button> <button class='ke-flash-cancel'>\u53d6\u6d88</button></div>");a._initD()},_realShow:function(){this.d.show()},
_showConfig:function(){var a=this.editor,b=this.selectedFlash;this._prepareShow();if(b){a=a.restoreRealElement(b);a.attr("width")&&this.dWidth.val(parseInt(a.attr("width")));a.attr("height")&&this.dHeight.val(parseInt(a.attr("height")));if(a._4e_name()=="object"){a=a[0].childNodes;for(b=0;b<a.length;b++)if(a[b].nodeType==x.NODE_ELEMENT)if((h.attr(a[b],"name")||"").toLowerCase()=="movie")this.dUrl.val(h.attr(a[b],"value"));else if(h._4e_name(a[b])=="embed")this.dUrl.val(h.attr(a[b],"src"));else h._4e_name(a[b])==
"object"&&this.dUrl.val(h.attr(a[b],"data"))}else a._4e_name()=="embed"&&this.dUrl.val(a.attr("src"))}else{this.dUrl.val("");this.dWidth.val("");this.dHeight.val("")}},_initD:function(){var a=this,b=a.d;a.dHeight=b.el.one(".ke-flash-height");a.dWidth=b.el.one(".ke-flash-width");a.dUrl=b.el.one(".ke-flash-url");var e=b.el.one(".ke-flash-ok");b=b.el.one(".ke-flash-cancel");e.on("click",a._gen,a);b.on("click",function(){a.d.hide()})},_gen:function(){var a=this.editor,b=this.dUrl.val();if(b){b="<object "+
(parseInt(this.dWidth.val())?" width='"+parseInt(this.dWidth.val())+"' ":" ")+(parseInt(this.dHeight.val())?" height='"+parseInt(this.dHeight.val())+"' ":" ")+' classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"  codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,0,0"><param name="quality" value="high" /><param name="movie" value="'+b+'" /><embed '+(parseInt(this.dWidth.val())?" width='"+parseInt(this.dWidth.val())+"' ":" ")+(parseInt(this.dHeight.val())?" height='"+
parseInt(this.dHeight.val())+"' ":" ")+'pluginspage="http://www.macromedia.com/go/getflashplayer" quality="high"  src="'+b+'"  type="application/x-shockwave-flash"/></object>';var e=new o(b,null,a.document);b=a.createFakeElement?a.createFakeElement(e,"ke_flash","flash",true,b):e;a.insertElement(b);this.selectedFlash&&a.getSelection().selectElement(b);this.d.hide()}}});f.Utils.lazyRun(c.prototype,"_prepareTip","_realTip");f.Flash=c;c.tip=function(){var a=this,b=new o('<div class="ke-bubbleview-bubble" onmousedown="return false;">Flash \u7f51\u5740\ufffd? <a class="ke-bubbleview-url" target="_blank" href="#"></a> -     <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -     <span class="ke-bubbleview-link ke-bubbleview-remove">\u5220\u9664</span></div>'),
e=b.one(".ke-bubbleview-change"),l=b.one(".ke-bubbleview-remove");b._4e_unselectable();a.tipwin=new r({el:b,focusMgr:false});document.body.appendChild(b[0]);a.tipurl=b.one(".ke-bubbleview-url");a.tipwin.on("hide",function(){var g=a.tipwin.flash;g&&(!g.d||!g.d.get("visible"))&&(g.selectedFlash=null)});n.on(document,"click",function(){a.tipwin.hide()});e.on("click",function(g){a.tipwin.flash._showConfig();g.halt()});l.on("click",function(g){var p=a.tipwin.flash;p.selectedFlash._4e_remove();p.editor.notifySelectionChange();
p.selectedFlash=null;g.halt()});a.tip=null};var d={"\u7f16\u8f91Flash":function(a){var b=a.getSelection();if(b=(b=b&&b.getStartElement())&&b._4e_ascendant("img",true))if(b.hasClass("ke_flash")){a=a._toolbars.flash;a.selectedFlash=b;a._showConfig()}}}}();j.addPlugin(function(){new f.Flash(j);var c=h._4e_getWin(j.document);n.on(c,"scroll",function(){f.Flash.tipwin&&f.Flash.tipwin.hide()})})});
