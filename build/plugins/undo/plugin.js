KISSY.Editor.add("undo",function(h){var d=KISSY.Editor,e=KISSY,j=d.Utils.arrayCompare,o=e.UA,p=e.Event;d.UndoManager||function(){function k(a){var b=a._getRawData();a=b&&a.getSelection();this.contents=b;this.bookmarks=a&&a.createBookmarks2(true)}function l(a,b,c){this.s=a;this.fn=b;this.scope=c||window;this.bufferTimer=null}function m(a){this.history=[];this.index=0;this.editor=a;this.bufferTimer=new l(500,this.save,this);this._init()}function n(a,b,c,f){this.editor=a;this.title=c;this.text=b;this.contentCls=
f;this._init()}e.augment(k,{equals:function(a){if(this.contents!=a.contents)return false;var b=this.bookmarks;a=a.bookmarks;if(b||a){if(!b||!a||b.length!=a.length)return false;for(var c=0;c<b.length;c++){var f=b[c],i=a[c];if(f.startOffset!=i.startOffset||f.endOffset!=i.endOffset||!j(f.start,i.start)||!j(f.end,i.end))return false}}return true}});e.augment(l,{run:function(){if(this.bufferTimer){clearTimeout(this.bufferTimer);this.bufferTimer=null}var a=this;this.bufferTimer=setTimeout(function(){a.fn.call(a.scope)},
this.s)}});var q={16:1,17:1,18:1},r={37:1,38:1,39:1,40:1};e.augment(m,{_keyMonitor:function(){var a=this.editor;p.on(a.document,"keydown",function(b){var c=b.keyCode;if(!(c in r||c in q))if(c===90&&(b.ctrlKey||b.metaKey)){a.fire("restore",{d:-1});b.halt()}else if(c===89&&(b.ctrlKey||b.metaKey)){a.fire("restore",{d:1});b.halt()}else a.fire("save",{buffer:1})})},_init:function(){var a=this,b=a.editor;b.on("save",function(c){c.buffer?a.bufferTimer.run():a.save()});b.on("restore",this.restore,this);a._keyMonitor();
a.save()},save:function(){this.history.length>this.index+1&&this.history.splice(this.index+1,this.history.length-this.index-1);var a=this.editor,b=this.history.length>0?this.history[this.history.length-1]:null,c=new k(this.editor);if(!b||!b.equals(c)){this.history.length===30&&this.history.shift();this.history.push(c);this.index=this.history.length-1;a.fire("afterSave",{history:this.history,index:this.index})}},restore:function(a){a=a.d;var b=this.editor,c=this.history.length>0?this.history[this.index+
a]:null;if(c){b._setRawData(c.contents);if(c.bookmarks)this.editor.getSelection().selectBookmarks(c.bookmarks);else if(o.ie){c=this.editor.document.body.createTextRange();c.collapse(true);c.select()}this.index+=a;b.fire("afterRestore",{history:this.history,index:this.index})}}});var g=d.TripleButton,s={redo:1,undo:-1};e.augment(n,{_init:function(){var a=this,b=a.editor;a.el=new g({contentCls:a.contentCls,title:a.title,container:b.toolBarDiv});this.el.set("state",g.DISABLED);b.on("afterSave",this._respond,
this);b.on("afterRestore",this._respond,this);a.el.on("offClick",function(){b.fire("restore",{d:s[a.text]})})},_respond:function(a){this.updateUI(a.history,a.index)},updateUI:function(a,b){if(this.text=="undo")b>0&&a.length>0?this.el.set("state",g.OFF):this.el.set("state",g.DISABLED);else if(this.text=="redo")b<a.length-1?this.el.set("state",g.OFF):this.el.set("state",g.DISABLED)}});d.UndoManager=m;d.RestoreUI=n}();h.addPlugin(function(){new d.UndoManager(h);new d.RestoreUI(h,"undo","\u64a4\u9500",
"ke-toolbar-undo");new d.RestoreUI(h,"redo","\u91cd\u505a","ke-toolbar-redo")})});
