KISSY.Editor.add("list",function(x){var n=KISSY.Editor,r={ol:1,ul:1},z=["ol","ul"],s=KISSY,A=n.RANGE,F=n.ElementPath,B=n.Walker,o=n.NODE,C=s.UA,p=s.Node,m=s.DOM;n.List||function(){function D(a){this.type=a}function w(a){w.superclass.constructor.call(this,a);a=this.get("editor").toolBarDiv;this.el=new y({contentCls:this.get("contentCls"),title:this.get("title"),container:a});this.listCommand=new D(this.get("type"));this.listCommand.state=this.get("status");this._init()}var q={listToArray:function(a,
h,c,j,g){if(!r[a._4e_name()])return[];j||(j=0);c||(c=[]);for(var f=0,b=a[0].childNodes.length;f<b;f++){var d=new p(a[0].childNodes[f]);if(d._4e_name()=="li"){var e={parent:a,indent:j,element:d,contents:[]};if(g)e.grandparent=g;else{e.grandparent=a.parent();if(e.grandparent&&e.grandparent._4e_name()=="li")e.grandparent=e.grandparent.parent()}h&&d._4e_setMarker(h,"listarray_index",c.length);c.push(e);for(var i=0,k=d[0].childNodes.length,l;i<k;i++){l=new p(d[0].childNodes[i]);l[0].nodeType==o.NODE_ELEMENT&&
r[l._4e_name()]?q.listToArray(l,h,c,j+1,e.grandparent):e.contents.push(l)}}}return c},arrayToList:function(a,h,c,j){c||(c=0);if(!a||a.length<c+1)return null;for(var g=a[c].parent[0].ownerDocument,f=g.createDocumentFragment(),b=null,d=c,e=Math.max(a[c].indent,0),i=null;;){var k=a[d];if(k.indent==e){if(!b||a[d].parent._4e_name()!=b._4e_name()){b=a[d].parent._4e_clone(false,true);f.appendChild(b[0])}i=b[0].appendChild(k.element._4e_clone(false,true)[0]);for(var l=0;l<k.contents.length;l++)i.appendChild(k.contents[l]._4e_clone(true,
true)[0]);d++}else if(k.indent==Math.max(e,0)+1){d=q.arrayToList(a,null,d,j);i.appendChild(d.listNode);d=d.nextIndex}else if(k.indent==-1&&!c&&k.grandparent){i=r[k.grandparent._4e_name()]?k.element._4e_clone(false,true)[0]:k.grandparent._4e_name()!="td"?g.createElement(j):g.createDocumentFragment();for(l=0;l<k.contents.length;l++)i.appendChild(k.contents[l]._4e_clone(true,true)[0]);if(i.nodeType==o.NODE_DOCUMENT_FRAGMENT&&d!=a.length-1){i.lastChild&&i.lastChild.nodeType==o.NODE_ELEMENT&&i.lastChild.getAttribute("type")==
"_moz"&&m._4e_remove(i.lastChild);m._4e_appendBogus(i)}if(i.nodeType==o.NODE_ELEMENT&&m._4e_name(i)==j&&i.firstChild){m._4e_trim(i);b=i.firstChild;if(b.nodeType==o.NODE_ELEMENT&&m._4e_isBlockBoundary(b)){b=g.createDocumentFragment();m._4e_moveChildren(i,b);i=b}}b=m._4e_name(i);if(!C.ie&&(b=="div"||b=="p"))m._4e_appendBogus(i);f.appendChild(i);b=null;d++}else return null;if(a.length<=d||Math.max(a[d].indent,0)<e)break}if(h)for(a=new p(f.firstChild);a&&a[0];){a[0].nodeType==o.NODE_ELEMENT&&a._4e_clearMarkers(h,
true);a=a._4e_nextSourceNode()}return{listNode:f,nextIndex:d}}},G=/^h[1-6]$/;D.prototype={changeListType:function(a,h,c,j){var g=q.listToArray(h.root,c),f=[];for(a=0;a<h.contents.length;a++){var b=h.contents[a];b=b._4e_ascendant("li",true);if(!(!b||!b[0]||b._4e_getData("list_item_processed"))){f.push(b);b._4e_setMarker(c,"list_item_processed",true)}}b=new p(h.root[0].ownerDocument.createElement(this.type));for(a=0;a<f.length;a++){var d=f[a]._4e_getData("listarray_index");g[d].parent=b}c=q.arrayToList(g,
c,null,"p");var e;g=c.listNode.childNodes.length;for(a=0;a<g&&(e=new p(c.listNode.childNodes[a]));a++)e._4e_name()==this.type&&j.push(e);m.insertBefore(c.listNode,h.root[0]);h.root._4e_remove()},createList:function(a,h,c){var j=h.contents;a=h.root[0].ownerDocument;var g=[];if(j.length==1&&j[0][0]===h.root[0]){var f=new p(a.createElement("div"));j[0][0].nodeType!=o.NODE_TEXT&&j[0]._4e_moveChildren(f);j[0][0].appendChild(f[0]);j[0]=f}h=h.contents[0].parent();for(f=0;f<j.length;f++)h=h._4e_commonAncestor(j[f].parent());
for(f=0;f<j.length;f++)for(var b=j[f],d;d=b.parent();){if(d[0]===h[0]){g.push(b);break}b=d}if(!(g.length<1)){j=new p(g[g.length-1][0].nextSibling);f=new p(a.createElement(this.type));for(c.push(f);g.length;){c=g.shift();b=new p(a.createElement("li"));if(G.test(c._4e_name()))b[0].appendChild(c[0]);else{c._4e_copyAttributes(b);c._4e_moveChildren(b);c._4e_remove()}f[0].appendChild(b[0]);C.ie||b._4e_appendBogus()}j[0]?m.insertBefore(f[0],j[0]):h[0].appendChild(f[0])}},removeList:function(a,h,c){function j(l){if((i=
new p(e[l?"firstChild":"lastChild"]))&&!(i[0].nodeType==o.NODE_ELEMENT&&i._4e_isBlockBoundary())&&(k=h.root[l?"_4e_previous":"_4e_next"](B.whitespaces(true)))&&!(i[0].nodeType==o.NODE_ELEMENT&&k._4e_isBlockBoundary({br:1})))m[l?"insertBefore":"insertAfter"](a.document.createElement("br"),i[0])}for(var g=q.listToArray(h.root,c),f=[],b=0;b<h.contents.length;b++){var d=h.contents[b];d=d._4e_ascendant("li",true);if(!(!d||d._4e_getData("list_item_processed"))){f.push(d);d._4e_setMarker(c,"list_item_processed",
true)}}d=null;for(b=0;b<f.length;b++){d=f[b]._4e_getData("listarray_index");g[d].indent=-1;d=d}for(b=d+1;b<g.length;b++)if(g[b].indent>Math.max(g[b-1].indent,0)){f=g[b-1].indent+1-g[b].indent;for(d=g[b].indent;g[b]&&g[b].indent>=d;){g[b].indent+=f;b++}b--}var e=q.arrayToList(g,c,null,"p").listNode,i,k;j(true);j();m.insertBefore(e,h.root);h.root._4e_remove()},exec:function(a){a.focus();var h=a.getSelection(),c=h&&h.getRanges();if(!(!c||c.length<1)){for(var j=h.createBookmarks(true),g=[],f={};c.length>
0;){var b=c.shift(),d=b.getBoundaryNodes(),e=d.startNode,i=d.endNode;e[0].nodeType==o.NODE_ELEMENT&&e._4e_name()=="td"&&b.setStartAt(d.startNode,A.POSITION_AFTER_START);i[0].nodeType==o.NODE_ELEMENT&&i._4e_name()=="td"&&b.setEndAt(d.endNode,A.POSITION_BEFORE_END);b=b.createIterator();for(b.forceBrBreak=false;d=b.getNextParagraph();){e=new F(d);i=e.elements;var k=null,l=false,t=e.blockLimit,u;for(e=i.length-1;e>=0&&(u=i[e]);e--)if(r[u._4e_name()]&&t.contains(u)){t._4e_removeData("list_group_object");
if(e=u._4e_getData("list_group_object"))e.contents.push(d);else{e={root:u,contents:[d]};g.push(e);u._4e_setMarker(f,"list_group_object",e)}l=true;break}if(!l)if(t._4e_getData("list_group_object"))t._4e_getData("list_group_object").contents.push(d);else{e={root:t,contents:[d]};t._4e_setMarker(f,"list_group_object",e);g.push(e)}}}for(c=[];g.length>0;){e=g.shift();if(this.state=="off")r[e.root._4e_name()]?this.changeListType(a,e,f,c):this.createList(a,e,c);else this.state=="on"&&r[e.root._4e_name()]&&
this.removeList(a,e,f)}for(e=0;e<c.length;e++){k=c[e];var H=this;(g=function(E){var v=k[E?"_4e_previous":"_4e_next"](B.whitespaces(true));if(v&&v[0]&&v._4e_name()==H.type){v._4e_remove();v._4e_moveChildren(k,E?true:false)}})();g(true)}n.Utils.clearAllMarkers(f);h.selectBookmarks(j);a.focus()}}};var y=n.TripleButton;w.ATTRS={editor:{},type:{},contentCls:{}};s.extend(w,s.Base,{_init:function(){var a=this.get("editor");this.el.on("click",this._change,this);a.on("selectionChange",this._selectionChange,
this)},_change:function(){var a=this.get("editor"),h=this.get("type"),c=this.el,j=this;a.focus();a.fire("save");setTimeout(function(){j.listCommand.state=c.get("state");j.listCommand.exec(a);a.fire("save");a.fire(h+"Change")},10)},_selectionChange:function(a){this.get("editor");var h=this.get("type"),c=a.path,j;a=this.el;var g=c.blockLimit;if(c=c.elements)for(var f=0;f<c.length&&(j=c[f])&&j[0]!==g[0];f++){var b=s.indexOf(c[f]._4e_name(),z);if(b!==-1)if(z[b]===h){a.set("state",y.ON);return}else break}a.set("state",
y.OFF)}});n.ListUtils=q;n.List=w}();x.addPlugin(function(){new n.List({editor:x,title:"\u9879\u76ee\u5217\u8868",contentCls:"ke-toolbar-ul",type:"ul"});new n.List({editor:x,title:"\u7f16\u53f7\u5217\u8868",contentCls:"ke-toolbar-ol",type:"ol"})})});
