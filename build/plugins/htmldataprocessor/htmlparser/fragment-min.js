KISSY.Editor.add("htmlparser-fragment",function(){function r(){this.children=[];this.parent=null;this._={isBlockLike:true,hasInlineStarted:false}}var j=KISSY.Editor;if(!j.HtmlParser.Fragment){var A={colgroup:1,dd:1,dt:1,li:1,option:1,p:1,td:1,tfoot:1,th:1,thead:1,tr:1},B=KISSY,s=j.Utils,v=j.NODE,h=j.XHTML_DTD,C=s.mix({table:1,ul:1,ol:1,dl:1},h.table,h.ul,h.ol,h.dl),y=h.$list,D=h.$listItem;r.FromHtml=function(f,e){function n(b){var g;if(k.length>0)for(var i=0;i<k.length;i++){var d=k[i],c=d.name,l=
h[c],p=a.name&&h[a.name];if((!p||p[c])&&(!b||!l||l[b]||!h[b])){if(!g){m();g=1}d=d.clone();d.parent=a;a=d;k.splice(i,1);i--}}}function m(){for(;w.length;)a.add(w.shift())}function q(b,g,i){g=g||a||x;if(e&&!g.type){var d,c;if((d=b.attributes&&(c=b.attributes._ke_real_element_type)?c:b.name)&&!(d in h.$body)&&!(d in h.$nonBodyContent)){d=a;a=g;o.onTagOpen(e,{});g=a;if(i)a=d}}if(b._.isBlockLike&&b.name!="pre"){i=b.children.length;if((d=b.children[i-1])&&d.type==v.NODE_TEXT)if(c=s.rtrim(d.value))d.value=
c;else b.children.length=i-1}g.add(b);if(b.returnPoint){a=b.returnPoint;delete b.returnPoint}}var o=new j.HtmlParser,x=new r,k=[],w=[],a=x,t=false,u;o.onTagOpen=function(b,g,i){var d=new j.HtmlParser.Element(b,g);if(d.isUnknown&&i)d.isEmpty=true;if(h.$removeEmpty[b])k.push(d);else{if(b=="pre")t=true;else if(b=="br"&&t){a.add(new j.HtmlParser.Text("\n"));return}if(b=="br")w.push(d);else{var c=a.name,l=c&&(h[c]||(a._.isBlockLike?h.div:h.span));if(l&&!d.isUnknown&&!a.isUnknown&&!l[b]){l=false;var p;
if(b in y&&c in y){c=a.children;(c=c[c.length-1])&&c.name in D||q(c=new j.HtmlParser.Element("li"),a);u=a;p=c}else if(b==c)q(a,a.parent);else{if(C[c])u||(u=a);else{q(a,a.parent,true);A[c]||k.unshift(a)}l=true}a=p?p:a.returnPoint||a.parent;if(l){o.onTagOpen.apply(this,arguments);return}}n(b);m();d.parent=a;d.returnPoint=u;u=0;if(d.isEmpty)q(d);else a=d}}};o.onTagClose=function(b){for(var g=k.length-1;g>=0;g--)if(b==k[g].name){k.splice(g,1);return}for(var i=[],d=[],c=a;c.type&&c.name!=b;){c._.isBlockLike||
d.unshift(c);i.push(c);c=c.parent}if(c.type){for(g=0;g<i.length;g++){var l=i[g];q(l,l.parent)}a=c;if(a.name=="pre")t=false;c._.isBlockLike&&m();q(c,c.parent);if(c==a)a=a.parent;k=k.concat(d)}if(b=="body")e=false};o.onText=function(b){if(!a._.hasInlineStarted&&!t){b=s.ltrim(b);if(b.length===0)return}m();n();if(e&&(!a.type||a.name=="body")&&s.trim(b))this.onTagOpen(e,{});t||(b=b.replace(/[\t\r\n ]{2,}|[\t\r\n]/g," "));a.add(new j.HtmlParser.Text(b))};o.onCDATA=function(){};o.onComment=function(b){a.add(new j.HtmlParser.Comment(b))};
o.parse(f);for(m();a.type;){f=a.parent;var z=a;if(e&&(!f.type||f.name=="body")&&!h.$body[z.name]){a=f;o.onTagOpen(e,{});f=a}f.add(z);a=f}return x};B.augment(r,{add:function(f){var e=this.children.length;if(e=e>0&&this.children[e-1]||null){if(f._.isBlockLike&&e.type==v.NODE_TEXT){e.value=s.rtrim(e.value);if(e.value.length===0){this.children.pop();this.add(f);return}}e.next=f}f.previous=e;f.parent=this;this.children.push(f);this._.hasInlineStarted=f.type==v.NODE_TEXT||f.type==v.NODE_ELEMENT&&!f._.isBlockLike},
writeHtml:function(f,e){var n;this.filterChildren=function(){var m=new j.HtmlParser.BasicWriter;this.writeChildrenHtml.call(this,m,e,true);m=m.getHtml();this.children=(new r.FromHtml(m)).children;n=1};!this.name&&e&&e.onFragment(this);this.writeChildrenHtml(f,n?null:e)},writeChildrenHtml:function(f,e){for(var n=0;n<this.children.length;n++)this.children[n].writeHtml(f,e)}});j.HtmlParser.Fragment=r}});
