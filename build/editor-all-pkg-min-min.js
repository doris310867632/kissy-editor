KISSY.add("editor",function(y,r){function B(m,p){var a=this;if(!(a instanceof B))return new B(m,p);if(y.isString(m))m=y.one(m);m[0]||(m=new Node(m));a.cfg=p;y.app(a,y.EventTarget);a.use=function(c){y.use.call(a,c,function(){a.on("dataReady",function(){a.setData(m.val())})},{order:true,global:B})};a.init(m)}function t(m){return!n?"build/"+m:m}y.app(B,y.EventTarget);B.Config.base=y.Config.base+"editor/";var n=y.Config.debug,z={htmlparser:{attach:false,path:t("plugins/htmldataprocessor/htmlparser/htmlparser.js")}},
q=["utils","focusmanager","definition","dtd","dom","elementpath","walker","range","domiterator","selection","styles"],u=["clipboard",{name:"color",useCss:true},{name:"elementpaths",useCss:true},"enterkey","fakeobjects",{name:"flash",requires:["fakeobjects","overlay"]},"font","format",{name:"htmldataprocessor",requires:["htmlparser-text"]},{name:"image",requires:["overlay"]},"indent","justify","link","list","maximize","music","preview","removeformat",{name:"smiley",useCss:true},"sourcearea",{name:"table",
useCss:true,requires:["overlay","contextmenu"]},{name:"templates",requires:["overlay"],useCss:true},"undo"],f=[{name:"htmlparser-basicwriter",requires:["htmlparser"]},{name:"htmlparser-element",requires:["htmlparser-fragment"]},{name:"htmlparser-filter",requires:["htmlparser-element"]},{name:"htmlparser-fragment",requires:["htmlparser-htmlwriter"]},{name:"htmlparser-htmlwriter",requires:["htmlparser-basicwriter"]},{name:"htmlparser-text",requires:["htmlparser-filter"]}],g=["button","overlay",{name:"contextmenu",
requires:["overlay"]}],i,l,v,k;i=0;for(l=g.length;i<l;i++){v=g[i];k=r;if(!y.isString(v)){k=v.requires;v=v.name}z[v]={attach:false,requires:k,path:t("ui/"+v+".js"),csspath:t("ui/"+v+".css")}}i=0;for(l=u.length;i<l;i++){g=v=u[i];k=["button"];if(!y.isString(v)){v.requires&&(k=k.concat(v.requires));g=v.name}z[g]={attach:false,requires:k,csspath:v.useCss?t("plugins/"+g+"/plugin.css"):r,path:t("plugins/"+g+"/plugin.js")}}i=0;for(l=f.length;i<l;i++){v=f[i];k=r;if(!y.isString(v)){k=v.requires;v=v.name}z[v]=
{attach:false,requires:k,path:t("plugins/htmldataprocessor/htmlparser/"+v.substring(11)+".js")}}B.add(z);z={};i=0;for(l=q.length;i<l;i++){v=q[i];z[v]={host:"editor",requires:i>0?q[i-1]:[]}}B.add(z);y.Editor=B});
KISSY.Editor.add("utils",function(y){var r=KISSY,B=r.Node,t=r.DOM;y.Utils={debugUrl:function(n){return!r.Config.debug?"build/"+n:n},lazyRun:function(n,z,q){var u=n[z],f=n[q];n[z]=function(){u.apply(this,arguments);n[z]=n[q];return f.apply(this,arguments)}},getXY:function(n,z,q,u){q=q.defaultView||q.parentWindow;n-=t.scrollLeft(q);z-=t.scrollTop(q);if(u)if(q!=(u.defaultView||u.parentWindow)&&q.frameElement){u=t._4e_getOffset(q.frameElement,u);n+=u.left;z+=u.top}return{left:n,top:z}},tryThese:function(){for(var n,
z=0,q=arguments.length;z<q;z++){var u=arguments[z];try{n=u();break}catch(f){}}return n},arrayCompare:function(n,z){if(!n&&!z)return true;if(!n||!z||n.length!=z.length)return false;for(var q=0;q<n.length;q++)if(n[q]!==z[q])return false;return true},getByAddress:function(n,z,q){n=n.documentElement;for(var u=0;n&&u<z.length;u++){var f=z[u];if(q)for(var g=-1,i=0;i<n.childNodes.length;i++){var l=n.childNodes[i];if(!(q===true&&l.nodeType==3&&l.previousSibling&&l.previousSibling.nodeType==3)){g++;if(g==
f){n=l;break}}}else n=n.childNodes[f]}return n?new B(n):null},clearAllMarkers:function(n){for(var z in n)n[z]._4e_clearMarkers(n,true)},htmlEncodeAttr:function(n){return n.replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/,"&gt;")},ltrim:function(n){return n.replace(/^\s+/,"")},rtrim:function(n){return n.replace(/\s+$/,"")},trim:function(n){return this.ltrim(this.rtrim(n))},mix:function(){for(var n={},z=0;z<arguments.length;z++)n=r.mix(n,arguments[z]);return n}}});
KISSY.Editor.add("focusmanager",function(y){function r(){this.iframeFocus=true}function B(){this.iframeFocus=false}var t=KISSY,n=t.DOM,z=t.Event;t={};var q={};t.add=function(u){q[u._UUID]=u;var f=n._4e_getWin(u.document);z.on(f,"focus",r,u);z.on(f,"blur",B,u)};t.remove=function(u){delete q[u._UUID];var f=n._4e_getWin(u.document);z.remove(f,"focus",r,u);z.remove(f,"blur",B,u)};y.focusManager=t});
KISSY.Editor.add("definition",function(y){function r(){return g+"<html><head><title>kissy-editor</title><link href='"+y.Config.base+i+"' rel='stylesheet'/></head><body class='ke-editor'>&nbsp;</body><html>"}var B=KISSY,t=B.UA,n=B.DOM,z=B.Node,q=B.Event,u=y.focusManager,f=y.Utils.tryThese,g="<!doctype html>",i=y.Utils.debugUrl("assets/editor-iframe.css"),l=1,v="<div  class='ke-editor-wrap'  onmousedown=' return false;'  > <div class='"+".ke-editor-tools".substring(1)+"'></div><div class='"+".ke-textarea-wrap".substring(1)+
'\'><iframe  style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor"  src="'+(t.ie?"javascript:void(function(){"+encodeURIComponent("document.open();document.close();")+"}())":"")+'"  tabIndex="'+(t.webkit?-1:"$(tabIndex)")+'"  allowTransparency="true" ></iframe></div><div class=\''+".ke-editor-status".substring(1)+"'></div></div>";B.augment(y,{init:function(k){var m=this,p=new z(v.replace(/\$\(tabIndex\)/,k.attr("tabIndex")));m.editorWrap=p;
m._UUID=l++;m.wrap=p.one(".ke-textarea-wrap");m.iframe=m.wrap.one("iframe");m.toolBarDiv=p.one(".ke-editor-tools");m.textarea=k;m.statusDiv=p.one(".ke-editor-status");m.toolBarDiv._4e_unselectable();m._commands={};m._plugins={};var a=k._4e_style("width"),c=k._4e_style("height");if(a){p.css("width",a);k.css("width","100%")}m.textarea.css("display","none");p.insertAfter(k);m.wrap[0].appendChild(k[0]);if(c){m.wrap.css("height",c);k.css("height","100%")}k=m.iframe;m.on("dataReady",function(){m.ready=
true;y.fire("instanceCreated",{editor:m})});t.gecko?k.on("load",m._initIFrame,m):m._initIFrame()},addCommand:function(k,m){this._commands[k]=m},execCommand:function(k){this._commands[k].exec(this)},getData:function(){if(y.HtmlDataProcessor)return y.HtmlDataProcessor.toHtml(this.document.body.innerHTML,"p");return this.document.body.innerHTML},setData:function(k){if(y.HtmlDataProcessor)k=y.HtmlDataProcessor.toDataFormat(k,"p");this.document.body.innerHTML=k},sync:function(){this.textarea.val(this.getData())},
_getRawData:function(){return this.document.body.innerHTML},_setRawData:function(k){this.document.body.innerHTML=k},_hideSource:function(){this.iframe.css("display","");this.textarea.css("display","none");this.toolBarDiv.children().css("visibility","");this.statusDiv.children().css("visibility","")},_showSource:function(){this.textarea.css("display","");this.iframe.css("display","none");this.toolBarDiv.children().css("visibility","hidden");this.toolBarDiv.all(".ke-tool-editor-source").css("visibility",
"");this.statusDiv.children().css("visibility","hidden");t.ie<8&&this.textarea.css("height",this.wrap.css("height"))},_prepareIFrameHtml:r,getSelection:function(){var k=new y.Selection(this.document);return!k||k.isInvalid?null:k},focus:function(){var k=n._4e_getWin(this.document);t.webkit&&k&&k.parent&&k.parent.focus();k&&k.focus();this.document&&this.document.body.focus();this.notifySelectionChange()},blur:function(){n._4e_getWin(this.document).blur();this.document&&this.document.body.blur()},_initIFrame:function(){function k(w){f(function(){e.designMode=
"on";setTimeout(function(){e.designMode="off";h.focus();if(!arguments.callee.retry)arguments.callee.retry=true},50)},function(){e.designMode="off";n.attr(h,"contentEditable",false);n.attr(h,"contentEditable",true);!w&&k(1)})}var m=this,p=m.iframe,a=m.textarea[0],c=r(),j=p[0].contentWindow,e=j.document;m.document=e;p.detach();e.open("text/html","replace");e.write(c);e.close();var h=e.body;if(t.ie){h.hideFocus=true;h.disabled=true;h.contentEditable=true;h.removeAttribute("disabled")}else setTimeout(function(){if(t.gecko||
t.opera)h.contentEditable=true;else if(t.webkit)h.parentNode.contentEditable=true;else e.designMode="on"},0);try{e.execCommand("enableObjectResizing",false,true)}catch(s){}try{e.execCommand("enableInlineTableEditing",false,true)}catch(b){}t.webkit&&q.on(e,"mousedown",function(w){w=new z(w.target);B.inArray(w._4e_name(),["img","hr","input","textarea","select"])&&m.getSelection().selectElement(w)});if(t.webkit){q.on(e,"click",function(w){var C=new z(w.target);B.inArray(C._4e_name(),["input","select"])&&
w.preventDefault()});q.on(e,"mouseup",function(w){var C=new z(w.target);B.inArray(C._4e_name(),["input","textarea"])&&w.preventDefault()})}if(t.gecko||t.ie||t.opera){var d;d=new z(n.insertAfter((new z('<span style="position:absolute; left:-10000"></span>'))[0],a));d.on("focus",function(){m.focus()});m.on("destroy",function(){})}if(t.ie&&e.compatMode=="CSS1Compat"||t.gecko||t.opera){var o=new z(e.documentElement);o.on("mousedown",function(w){if(w.target===o[0]){t.gecko&&k(false);d[0].focus()}})}q.on(j,
"focus",function(){if(t.gecko)k(false);else t.opera&&h.focus();m.notifySelectionChange()});t.gecko&&q.on(m.document,"mousedown",function(){m.iframeFocus||k(false)});if(t.ie){q.on(e,"keydown",function(w){if(w.keyCode in{8:1,46:1}){var C=m.getSelection(),I=C.getSelectedElement();if(I){m.fire("save");var x=C.getRanges()[0].createBookmark();I.remove();C.selectBookmarks([x]);m.fire("save");w.preventDefault()}}});if(e.compatMode=="CSS1Compat"){var A={33:1,34:1};q.on(e,"keydown",function(w){w.keyCode in
A&&setTimeout(function(){m.getSelection().scrollIntoView()},0)})}}setTimeout(function(){t.ie&&setTimeout(function(){if(e){h.runtimeStyle.marginBottom="0px";h.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){m.fire("dataReady")},10);u.add(m)},addPlugin:function(k){this.ready?k():this.on("dataReady",k)},_monitor:function(){var k=this;k._monitorId&&clearTimeout(k._monitorId);k._monitorId=setTimeout(function(){var m=k.getSelection();if(m&&!m.isInvalid){m=m.getStartElement();var p=new y.ElementPath(m);
if(!k.previousPath||!k.previousPath.compare(p)){k.previousPath=p;k.fire("selectionChange",{selection:k,path:p,element:m})}}},200)},notifySelectionChange:function(){this.previousPath=null;this._monitor()},insertElement:function(k){var m=this;m.focus();var p=k._4e_name(),a=y.XHTML_DTD,c=y.RANGE,j=y.NODE,e=a.$block[p],h=m.getSelection(),s=h.getRanges(),b,d,o,A,w;m.fire("save");for(var C=s.length-1;C>=0;C--){b=s[C];b.deleteContents();d=!C&&k||k._4e_clone(true);if(e)for(;(A=b.getCommonAncestor(false,true))&&
(w=a[A._4e_name()])&&!(w&&w[p]);)if(A._4e_name()in a.span)b.splitElement(A);else if(b.checkStartOfBlock()&&b.checkEndOfBlock()){b.setStartBefore(A);b.collapse(true);A.remove()}else b.splitBlock();b.insertNode(d);o||(o=d)}b.moveToPosition(o,c.POSITION_AFTER_END);(k=o._4e_nextSourceNode(true))&&k.type==j.NODE_ELEMENT&&b.moveToElementEditablePosition(k);h.selectRanges([b]);m.focus();d&&d._4e_scrollIntoView();setTimeout(function(){m.fire("save")},10)},insertHtml:function(k){if(y.HtmlDataProcessor)k=y.HtmlDataProcessor.toDataFormat(k);
if(t.webkit){k=n.create(k,null,this.document);k=k.nodeType==11?B.makeArray(k.childNodes):[k];for(var m=0;m<k.length;m++)this.insertElement(new z(k[m]))}else{var p=this;p.focus();p.fire("save");m=p.getSelection();if(t.ie){m=m.getNative();m.type=="Control"&&m.clear();m.createRange().pasteHTML(k)}else p.document.execCommand("inserthtml",false,k);p.focus();setTimeout(function(){p.fire("save")},10)}}})});
KISSY.Editor.add("dtd",function(y){y.XHTML_DTD=function(){var r=function(s){for(var b=arguments.length-1;b>0;)KISSY.mix(s,arguments[b--]);return s},B={isindex:1,fieldset:1},t={input:1,button:1,select:1,textarea:1,label:1},n=r({a:1},t),z=r({iframe:1},n),q={hr:1,ul:1,menu:1,div:1,blockquote:1,noscript:1,table:1,center:1,address:1,dir:1,pre:1,h5:1,dl:1,h4:1,noframes:1,h6:1,ol:1,h1:1,h3:1,h2:1},u={ins:1,del:1,script:1,style:1},f=r({b:1,acronym:1,bdo:1,"var":1,"#":1,abbr:1,code:1,br:1,i:1,cite:1,kbd:1,
u:1,strike:1,s:1,tt:1,strong:1,q:1,samp:1,em:1,dfn:1,span:1},u),g=r({sub:1,img:1,object:1,sup:1,basefont:1,map:1,applet:1,font:1,big:1,small:1},f),i=r({p:1},g);t=r({iframe:1},g,t);g={img:1,noscript:1,br:1,kbd:1,center:1,button:1,basefont:1,h5:1,h4:1,samp:1,h6:1,ol:1,h1:1,h3:1,h2:1,form:1,font:1,"#":1,select:1,menu:1,ins:1,abbr:1,label:1,code:1,table:1,script:1,cite:1,input:1,iframe:1,strong:1,textarea:1,noframes:1,big:1,small:1,span:1,hr:1,sub:1,bdo:1,"var":1,div:1,object:1,sup:1,strike:1,dir:1,map:1,
dl:1,applet:1,del:1,isindex:1,fieldset:1,ul:1,b:1,acronym:1,a:1,blockquote:1,i:1,u:1,s:1,tt:1,address:1,q:1,pre:1,p:1,em:1,dfn:1};var l=r({a:1},t),v={tr:1},k={"#":1},m=r({param:1},g),p=r({form:1},B,z,q,i),a={li:1},c={base:1,link:1,meta:1,title:1},j=r(c,{style:1,script:1}),e={head:1,body:1},h={address:1,blockquote:1,center:1,dir:1,div:1,dl:1,fieldset:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,isindex:1,menu:1,noframes:1,ol:1,p:1,pre:1,table:1,ul:1};return{$nonBodyContent:r({html:1},e,c),$block:h,
$blockLimit:{body:1,div:1,td:1,th:1,caption:1,form:1},$inline:l,$body:r({script:1,style:1},h),$cdata:{script:1,style:1},$empty:{area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},$listItem:{dd:1,dt:1,li:1},$list:{ul:1,ol:1,dl:1},$nonEditable:{applet:1,button:1,embed:1,iframe:1,map:1,object:1,option:1,script:1,textarea:1,param:1},$removeEmpty:{abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},$tabIndex:{a:1,area:1,button:1,input:1,object:1,select:1,textarea:1},$tableContent:{caption:1,col:1,colgroup:1,tbody:1,td:1,tfoot:1,th:1,thead:1,tr:1},html:e,head:j,style:k,body:p,base:{},link:{},meta:{},title:k,col:{},tr:{td:1,th:1},img:{},colgroup:{col:1},noscript:p,td:p,br:{},th:p,center:p,kbd:l,button:r(i,q),basefont:{},h5:l,h4:l,samp:l,h6:l,ol:a,h1:l,h3:l,option:k,h2:l,form:r(B,z,q,i),select:{optgroup:1,option:1},font:l,ins:l,menu:a,abbr:l,label:l,table:{thead:1,
col:1,tbody:1,tr:1,colgroup:1,caption:1,tfoot:1},code:l,script:k,tfoot:v,cite:l,li:p,input:{},iframe:p,strong:l,textarea:k,noframes:p,big:l,small:l,span:l,hr:{},dt:l,sub:l,optgroup:{option:1},param:{},bdo:l,"var":l,div:p,object:m,sup:l,dd:p,strike:l,area:{},dir:a,map:r({area:1,form:1,p:1},B,u,q),applet:m,dl:{dt:1,dd:1},del:l,isindex:{},fieldset:r({legend:1},g),thead:v,ul:a,acronym:l,b:l,a:t,blockquote:p,caption:l,i:l,u:l,tbody:v,s:l,address:r(z,i),tt:l,legend:l,q:l,pre:r(f,n),p:l,em:l,dfn:l}}()});
KISSY.Editor.add("dom",function(y){function r(a){return a.replace(/-(\w)/g,function(c,j){return j.toUpperCase()})}var B=KISSY,t=B.DOM,n=B.UA,z=B.Node,q=y.Utils,u={abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};y.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_DOCUMENT_FRAGMENT:11};y.POSITION={};var f=y.NODE,g=y.POSITION;g.POSITION_IDENTICAL=0;g.POSITION_DISCONNECTED=1;g.POSITION_FOLLOWING=
2;g.POSITION_PRECEDING=4;g.POSITION_IS_CONTAINED=8;g.POSITION_CONTAINS=16;var i={},l={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},v={hr:1},k=function(a){return a[0]||a},m=function(a){if(!a[0])return new z(a);return a},p={_4e_equals:function(a,c){if(!a&&!c)return true;if(!a||!c)return false;a=k(a);c=k(c);return a===c},_4e_isBlockBoundary:function(a,c){a=m(a);c=
B.mix(B.mix({},v),c||{});return l[a.css("display")]||c[a._4e_name()]},_4e_getWin:function(a){return a&&"scrollTo"in a&&a.document?a:a&&a.nodeType===9?a.defaultView||a.parentWindow:false},_4e_index:function(a){a=k(a);for(var c=a.parentNode.childNodes,j=0;j<c.length;j++)if(c[j]===a)return j;return-1},_4e_first:function(a,c){a=k(a);if((a=(a=a.firstChild)&&new z(a))&&c&&!c(a))a=a._4e_next(c);return a},_4e_move:function(a,c,j){a.remove();a=k(a);c=k(c);j?c.insertBefore(a,c.firstChild):c.appendChild(a)},
_4e_name:function(a){a=k(a);return a.nodeName.toLowerCase()},_4e_isIdentical:function(a,c){if(a._4e_name()!=c._4e_name())return false;var j=a[0].attributes,e=c[0].attributes,h=j.length,s=e.length;if(!n.ie&&h!=s)return false;for(var b=0;b<h;b++){var d=j[b];if((!n.ie||d.specified&&d.nodeName!="_ke_expando")&&d.nodeValue!=c.attr(d.nodeName))return false}if(n.ie)for(b=0;b<s;b++){d=e[b];if(d.specified&&d.nodeName!="_ke_expando"&&d.nodeValue!=a.attr(d.nodeName))return false}return true},_4e_isEmptyInlineRemoveable:function(a){a=
k(a).childNodes;for(var c=0,j=a.length;c<j;c++){var e=a[c],h=e.nodeType;if(!(h==f.NODE_ELEMENT&&e.getAttribute("_ke_bookmark")))if(h==f.NODE_ELEMENT&&!p._4e_isEmptyInlineRemoveable(e)||h==f.NODE_TEXT&&B.trim(e.nodeValue))return false}return true},_4e_moveChildren:function(a,c,j){a=k(a);c=c[0]||c;if(a!=c)if(j)for(;j=a.lastChild;)c.insertBefore(a.removeChild(j),c.firstChild);else for(;j=a.firstChild;)c.appendChild(a.removeChild(j))},_4e_mergeSiblings:function(){function a(c,j,e){if(j[0]&&j[0].nodeType==
f.NODE_ELEMENT){for(var h=[];j.attr("_ke_bookmark")||j._4e_isEmptyInlineRemoveable();){h.push(j);j=e?new z(j[0].nextSibling):new z(j[0].previousSibling);if(!j[0]||j[0].nodeType!=f.NODE_ELEMENT)return}if(c._4e_isIdentical(j)){for(var s=e?c[0].lastChild:c[0].firstChild;h.length;)h.shift()._4e_move(c,!e);j._4e_moveChildren(c,!e);j.remove();s[0]&&s[0].nodeType==f.NODE_ELEMENT&&s._4e_mergeSiblings()}}}return function(c){if(c[0])if(u[c._4e_name()]||c._4e_name()=="a"){a(c,new z(c[0].nextSibling),true);a(c,
new z(c[0].previousSibling))}}}(),_4e_unselectable:n.gecko?function(a){a=k(a);a.style.MozUserSelect="none"}:n.webkit?function(a){a=k(a);a.style.KhtmlUserSelect="none"}:function(a){a=k(a);if(n.ie||n.opera){var c,j=0;for(a.unselectable="on";c=a.all[j++];)switch(c.tagName.toLowerCase()){case "iframe":case "textarea":case "input":case "select":break;default:c.unselectable="on"}}},_4e_getOffset:function(a,c){a=k(a);var j,e=0;j=0;var h=a.ownerDocument.defaultView||a.ownerDocument.parentWindow,s=a.ownerDocument,
b=s.documentElement;if(a.getBoundingClientRect){if(a!==s.body&&b!==a){j=a.getBoundingClientRect();e=j.left+t.scrollLeft(h);j=j.top+t.scrollTop(h)}if(c)if(h!=(c.defaultView||c.parentWindow)&&h.frameElement){c=p._4e_getOffset(h.frameElement,c);e+=c.left;j+=c.top}}return{left:e,top:j}},_4e_getFrameDocument:function(a){return(a=k(a))&&a.contentWindow.document},_4e_splitText:function(a,c){a=k(a);var j=a.ownerDocument;if(!(!a||a.nodeType!=f.NODE_TEXT)){if(n.ie&&c==a.nodeValue.length){j=j.createTextNode("");
t.insertAfter(j,a);return j}a=new z(a.splitText(c));if(n.ie==8){j=j.createTextNode("");t.insertAfter(j,a[0]);j.parentNode.removeChild(j)}return a}},_4e_parents:function(a,c){a=m(a);var j=[];do j[c?"push":"unshift"](a);while(a=a.parent());return j},_4e_clone:function(a,c,j){a=k(a);a=a.cloneNode(c);if(!j){var e=function(h){if(h.nodeType==f.NODE_ELEMENT){h.removeAttribute("id",false);h.removeAttribute("_ke_expando",false);h=h.childNodes;for(var s=0;s<h.length;s++)e(h[s])}};e(a)}return new z(a)},_4e_nextSourceNode:function(a,
c,j,e){a=k(a);if(e&&!e.call){var h=e[0]||e;e=function(b){b=b[0]||b;return b!==h}}c=!c&&a.firstChild;var s=new z(a);if(!c){if(a.nodeType==f.NODE_ELEMENT&&e&&e(this,true)===false)return null;c=a.nextSibling}for(;!c&&(s=s.parent());){if(e&&e(s,true)===false)return null;c=s[0].nextSibling}if(!c)return null;c=new z(c);if(e&&e(c)===false)return null;if(j&&j!=c[0].nodeType)return c._4e_nextSourceNode(false,j,e);return c},_4e_previousSourceNode:function(a,c,j,e){a=k(a);if(e&&!e.call){var h=e[0]||e;e=function(b){b=
b[0]||b;return b!==h}}c=!c&&a.lastChild;var s=new z(a);if(!c){if(a.nodeType==f.NODE_ELEMENT&&e&&e(a,true)===false)return null;c=a.previousSibling}for(;!c&&(s=s.parent());){if(e&&e(s,true)===false)return null;c=s[0].previousSibling}if(!c)return null;c=new z(c);if(e&&e(c)===false)return null;if(j&&c[0].nodeType!=j)return c._4e_previousSourceNode(false,j,e);return c},_4e_contains:n.ie||n.webkit?function(a,c){a=k(a);c=k(c);return c.nodeType!=f.NODE_ELEMENT?a.contains(c.parentNode):a!=c&&a.contains(c)}:
function(a,c){a=k(a);c=k(c);return!!(a.compareDocumentPosition(c)&16)},_4e_commonAncestor:function(a,c){if(a._4e_equals(c))return a;if(c[0].nodeType!=f.NODE_TEXT&&c._4e_contains(a))return c;a=a[0].nodeType==f.NODE_TEXT?a.parent():a;do if(a[0].nodeType!=f.NODE_TEXT&&a._4e_contains(c))return a;while(a=a.parent());return null},_4e_ascendant:function(a,c,j){a=k(a);if(!j)a=a.parentNode;if(c&&!B.isFunction(c)){var e=c;c=function(h){return h._4e_name()==e}}for(;a&&a.nodeType!=9;){if(!c||c(new z(a))===true)return new z(a);
a=a.parentNode}return null},_4e_hasAttribute:function(a,c){a=k(a);a=a.attributes.getNamedItem(c);return!!(a&&a.specified)},_4e_hasAttributes:n.ie?function(a){a=k(a);for(var c=a.attributes,j=0;j<c.length;j++){var e=c[j];switch(e.nodeName){case "class":if(a.getAttribute("class"))return true;break;case "_ke_expando":continue;default:if(e.specified)return true}}return false}:function(a){a=k(a);n.gecko&&a.removeAttribute("_moz_dirty");a=a.attributes;return a.length>1||a.length==1&&a[0].nodeName!="_ke_expando"},
_4e_position:function(a,c){var j=k(a),e=k(c);if(j.compareDocumentPosition)return j.compareDocumentPosition(e);if(j==e)return g.POSITION_IDENTICAL;if(j.nodeType==f.NODE_ELEMENT&&e.nodeType==f.NODE_ELEMENT){if(j.contains){if(j.contains(e))return g.POSITION_CONTAINS+g.POSITION_PRECEDING;if(e.contains(j))return g.POSITION_IS_CONTAINED+g.POSITION_FOLLOWING}if("sourceIndex"in j)return j.sourceIndex<0||e.sourceIndex<0?g.POSITION_DISCONNECTED:j.sourceIndex<e.sourceIndex?g.POSITION_PRECEDING:g.POSITION_FOLLOWING}a=
a._4e_address();c=c._4e_address();j=Math.min(a.length,c.length);for(e=0;e<=j-1;e++)if(a[e]!=c[e]){if(e<j)return a[e]<c[e]?g.POSITION_PRECEDING:g.POSITION_FOLLOWING;break}return a.length<c.length?g.POSITION_CONTAINS+g.POSITION_PRECEDING:g.POSITION_IS_CONTAINED+g.POSITION_FOLLOWING},_4e_address:function(a,c){a=k(a);var j=[],e=a.ownerDocument.documentElement;for(a=a;a&&a!=e;){var h=a.parentNode,s=-1;if(h){for(var b=0;b<h.childNodes.length;b++){var d=h.childNodes[b];if(!(c&&d.nodeType==3&&d.previousSibling&&
d.previousSibling.nodeType==3)){s++;if(d==a)break}}j.unshift(s)}a=h}return j},_4e_breakParent:function(a,c){var j=new y.Range(a[0].ownerDocument);j.setStartAfter(a);j.setEndAfter(c);c=j.extractContents();j.insertNode(a.remove());a[0].parentNode.insertBefore(c,a[0].nextSibling)},_4e_style:function(a,c,j){if(j!==undefined)return a.css(c,j);a=a[0]||a;return a.style[r(c)]},_4e_remove:function(a,c){a=k(a);var j=a.parentNode;if(j){if(c)for(;c=a.firstChild;)j.insertBefore(a.removeChild(c),a);j.removeChild(a)}return this},
_4e_trim:function(a){t._4e_ltrim(a);t._4e_rtrim(a)},_4e_ltrim:function(a){a=k(a);for(var c;c=a.firstChild;){if(c.nodeType==f.NODE_TEXT){var j=q.ltrim(c.nodeValue),e=c.nodeValue.length;if(j){if(j.length<e){(new z(c))._4e_splitText(e-j.length);a.removeChild(a.firstChild)}}else{a.removeChild(c);continue}}break}},_4e_rtrim:function(a){a=k(a);for(var c;c=a.lastChild;){if(c.type==f.NODE_TEXT){var j=q.rtrim(c.nodeValue),e=c.nodeValue.length;if(j){if(j.length<e){(new z(c))._4e_splitText(j.length);a.removeChild(a.lastChild)}}else{a.removeChild(c);
continue}}break}if(!n.ie&&!n.opera)(c=a.lastChild)&&c.nodeType==1&&c.nodeName.toLowerCase()=="br"&&c.parentNode.removeChild(c)},_4e_appendBogus:function(a){a=k(a);for(var c=a.lastChild;c&&c.nodeType==f.NODE_TEXT&&!B.trim(c.nodeValue);)c=c.previousSibling;if(!c||c.nodeType==f.NODE_TEXT||t._4e_name(c)!=="br"){c=n.opera?a.ownerDocument.createTextNode(""):a.ownerDocument.createElement("br");n.gecko&&c.setAttribute("type","_moz");a.appendChild(c)}},_4e_previous:function(a,c){a=k(a);var j;do j=(a=a.previousSibling)&&
new z(a);while(j&&c&&!c(j));return j},_4e_last:function(a,c){if((a=(a=a[0].lastChild)&&new z(a))&&c&&!c(a))a=a._4e_previous(c);return a},_4e_next:function(a,c){a=k(a);var j;do j=(a=a.nextSibling)&&new z(a);while(j&&c&&!c(j));return j},_4e_outerHtml:function(a){a=k(a);if(a.outerHTML)return a.outerHTML.replace(/<\?[^>]*>/,"");var c=a.ownerDocument.createElement("div");c.appendChild(a.cloneNode(true));return c.innerHTML},_4e_setMarker:function(a,c,j,e){a[0]||(a=new z(a));var h=a._4e_getData("list_marker_id")||
a._4e_setData("list_marker_id",B.guid())._4e_getData("list_marker_id"),s=a._4e_getData("list_marker_names")||a._4e_setData("list_marker_names",{})._4e_getData("list_marker_names");c[h]=a;s[j]=1;return a._4e_setData(j,e)},_4e_clearMarkers:function(a,c,j){a=m(a);var e=a._4e_getData("list_marker_names"),h=a._4e_getData("list_marker_id");for(var s in e)a._4e_removeData(s);a._4e_removeData("list_marker_names");if(j){a._4e_removeData("list_marker_id");delete c[h]}},_4e_setData:function(a,c,j){var e=t._4e_getUniqueId(a);
(i[e]||(i[e]={}))[c]=j;return a},_4e_getData:function(a,c){a=k(a);return(a=(a=a.getAttribute("_ke_expando"))&&i[a])&&a[c]},_4e_removeData:function(a,c){a=k(a);var j=a.getAttribute("_ke_expando"),e=(j=j&&i[j])&&j[c];typeof e!="undefined"&&j&&delete j[c];B.isEmptyObject(j)&&t._4e_clearData(a);return e||null},_4e_clearData:function(a){a=k(a);var c=a.getAttribute("_ke_expando");c&&delete i[c];c&&a.removeAttribute("_ke_expando")},_4e_getUniqueId:function(a){a=k(a);var c=a.getAttribute("_ke_expando");if(c)return c;
c=B.guid();a.setAttribute("_ke_expando",c);return c},_4e_copyAttributes:function(a,c,j){a=k(a);var e=a.attributes;j=j||{};for(var h=0;h<e.length;h++){var s=e[h],b=s.nodeName.toLowerCase(),d;if(!(b in j))if(b=="checked"&&(d=t.attr(a,b)))c.attr(b,d);else if(s.specified||n.ie&&s.nodeValue&&b=="value"){d=t.attr(a,b);if(d===null)d=s.nodeValue;c.attr(b,d)}}if(a.style.cssText!=="")c[0].style.cssText=a.style.cssText},_4e_isEditable:function(a){a=t._4e_name(a);var c=y.XHTML_DTD;return(a=!c.$nonEditable[a]&&
(c[a]||c.span))&&a["#"]},_4e_scrollIntoView:function(a){a=m(a);var c=a[0].ownerDocument,j=t.scrollLeft(c),e=t.scrollTop(c),h=a.offset(),s=h.left;h=h.top;if(t.viewportHeight(c)+e<h||h<e||t.viewportWidth(c)+j<s||s<j)a.scrollIntoView(c)}};B.DOM._4e_inject=function(a){B.mix(t,a);for(var c in a)a.hasOwnProperty(c)&&function(j){z.prototype[j]=function(){var e=[].slice.call(arguments,0);e.unshift(this);return a[j].apply(null,e)}}(c)};B.DOM._4e_inject(p)});
KISSY.Editor.add("elementpath",function(y){function r(i){var l=null,v=null,k=[];for(i=i;i&&i[0];){if(i[0].nodeType==z.NODE_ELEMENT){if(!this.lastElement)this.lastElement=i;var m=i._4e_name();if(q.ie&&i[0].scopeName!="HTML")m=i[0].scopeName.toLowerCase()+":"+m;if(!v){if(!l&&u[m])l=i;if(f[m])if(!l&&m=="div"&&!g(i))l=i;else v=i}k.push(i);if(m=="body")break}i=i.parent()}this.block=l;this.blockLimit=v;this.elements=k}var B=KISSY,t=B.DOM,n=y.XHTML_DTD,z=y.NODE,q=B.UA,u={address:1,blockquote:1,dl:1,h1:1,
h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},f={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1},g=function(i){i=i[0]||i;i=i.childNodes;for(var l=0,v=i.length;l<v;l++){var k=i[l];if(k.nodeType==z.NODE_ELEMENT&&n.$block[k.nodeName.toLowerCase()])return true}return false};r.prototype={compare:function(i){var l=this.elements;i=i&&i.elements;if(!i||l.length!=i.length)return false;for(var v=0;v<l.length;v++)if(!t._4e_equals(l[v],i[v]))return false;return true},contains:function(i){for(var l=
this.elements,v=0;v<l.length;v++)if(l[v]._4e_name()in i)return l[v];return null}};y.ElementPath=r});
KISSY.Editor.add("walker",function(y){function r(f,g){if(this._.end)return null;var i=this.range,l,v=this.guard,k=this.type,m=f?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start){this._.start=1;i.trim();if(i.collapsed){this.end();return null}}if(!f&&!this._.guardLTR){var p=i.endContainer,a=new u(p[0].childNodes[i.endOffset]);this._.guardLTR=function(h,s){return(!s||!q._4e_equals(p,h))&&(!a[0]||h[0]!==a[0])&&(h[0].nodeType!=z.NODE_ELEMENT||!s||h._4e_name()!="body")}}if(f&&!this._.guardRTL){var c=
i.startContainer,j=i.startOffset>0&&new u(c[0].childNodes[i.startOffset-1]);this._.guardRTL=function(h,s){return h&&h[0]&&(!s||c[0]!==h[0])&&(!j[0]||h[0]!==j[0])&&(h[0].nodeType!=z.NODE_ELEMENT||!s||h._4e_name()!="body")}}var e=f?this._.guardRTL:this._.guardLTR;l=v?function(h,s){if(e(h,s)===false)return false;return v(h,s)}:e;if(this.current)f=this.current[m](false,k,l);else if(f){f=i.endContainer;if(i.endOffset>0){f=new u(f[0].childNodes[i.endOffset-1]);if(l(f)===false)f=null}else f=l(f,true)===
false?null:f._4e_previousSourceNode(true,k,l)}else{f=i.startContainer;if((f=new u(f[0].childNodes[i.startOffset]))&&f[0]){if(l(f)===false)f=null}else f=l(i.startContainer,true)===false?null:i.startContainer._4e_nextSourceNode(true,k,l)}for(;f&&f[0]&&!this._.end;){this.current=f;if(!this.evaluator||this.evaluator(f)!==false){if(!g)return f}else if(g&&this.evaluator)return false;f=f[m](false,k,l)}this.end();return this.current=null}function B(f){for(var g,i=null;g=r.call(this,f);)i=g;return i}function t(f){this.range=
f;this._={}}var n=KISSY,z=y.NODE,q=n.DOM,u=n.Node;n.augment(t,{end:function(){this._.end=1},next:function(){return r.call(this)},previous:function(){return r.call(this,true)},checkForward:function(){return r.call(this,false,true)!==false},checkBackward:function(){return r.call(this,true,true)!==false},lastForward:function(){return B.call(this)},lastBackward:function(){return B.call(this,true)},reset:function(){delete this.current;this._={}}});t.blockBoundary=function(f){return function(g){g[0]||(g=
new u(g));return!(g[0].nodeType==z.NODE_ELEMENT&&g._4e_isBlockBoundary(f))}};t.listItemBoundary=function(){return this.blockBoundary({br:1})};t.bookmark=function(f,g){function i(l){return l&&l[0]&&l._4e_name()=="span"&&l.attr("_ke_bookmark")}return function(l){var v,k;v=l&&l[0]&&l[0].nodeType==z.NODE_TEXT&&(k=l.parent())&&i(k);v=f?v:v||i(l);return g^v}};t.whitespaces=function(f){return function(g){g=(g=g[0]||g)&&g.nodeType==z.NODE_TEXT&&!n.trim(g.nodeValue);return f^g}};t.invisible=function(f){var g=
t.whitespaces();return function(i){i=g(i)||i[0].nodeType==z.NODE_ELEMENT&&!i[0].offsetHeight;return f^i}};y.Walker=t});
KISSY.Editor.add("range",function(y){function r(b){this.endOffset=this.endContainer=this.startOffset=this.startContainer=null;this.collapsed=true;this.document=b}function B(b){var d=b[0].nodeType!=f.NODE_TEXT&&b._4e_name()in p.$removeEmpty,o=!u.trim(b[0].nodeValue);b=!!b.parent().attr("_ke_bookmark");return d||o||b}function t(b){return!h(b)&&!s(b)}function n(b){var d=false,o=l.bookmark(true);return function(A){if(o(A))return true;if(A[0].nodeType==f.NODE_TEXT){if(u.trim(A[0].nodeValue).length)return false}else if(A[0].nodeType==
f.NODE_ELEMENT)if(!e[A._4e_name()])if(!b&&!m.ie&&A._4e_name()=="br"&&!d)d=true;else return false;return true}}function z(b,d){function o(A){return A&&A.nodeName=="span"&&A.getAttribute("_ke_bookmark")}return function(A){var w,C;w=A&&!A.nodeName&&(C=A.parentNode)&&o(C);w=b?w:w||o(A);return d^w}}function q(b){return function(d){d=(d=d[0]||d)&&d.nodeType==f.NODE_TEXT&&!u.trim(d.nodeValue);return b^d}}y.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,
ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,STARTEND:3,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var u=KISSY,f=y.NODE,g=y.RANGE,i=y.POSITION,l=y.Walker,v=u.DOM,k=y.Utils.getByAddress,m=u.UA,p=y.XHTML_DTD,a=y.ElementPath,c=u.Node,j={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1};r.prototype.toString=function(){var b=[];b.push((this.startContainer[0].id||this.startContainer[0].nodeName)+":"+this.startOffset);b.push((this.endContainer[0].id||this.endContainer[0].nodeName)+
":"+this.endOffset);return b.join("<br/>")};u.augment(r,{updateCollapsed:function(){this.collapsed=this.startContainer&&this.endContainer&&v._4e_equals(this.startContainer,this.endContainer)&&this.startOffset==this.endOffset},optimize:function(){var b=this.startContainer,d=this.startOffset;if(b[0].nodeType!=f.NODE_ELEMENT)if(d)d>=b[0].nodeValue.length&&this.setStartAfter(b);else this.setStartBefore(b);b=this.endContainer;d=this.endOffset;if(b[0].nodeType!=f.NODE_ELEMENT)if(d)d>=b[0].nodeValue.length&&
this.setEndAfter(b);else this.setEndBefore(b)},setStartAfter:function(b){this.setStart(b.parent(),b._4e_index()+1)},setStartBefore:function(b){this.setStart(b.parent(),b._4e_index())},setEndAfter:function(b){this.setEnd(b.parent(),b._4e_index()+1)},setEndBefore:function(b){this.setEnd(b.parent(),b._4e_index())},optimizeBookmark:function(){var b=this.startContainer,d=this.endContainer;b&&b._4e_name()=="span"&&b.attr("_ke_bookmark")&&this.setStartAt(b,g.POSITION_BEFORE_START);d&&d._4e_name()=="span"&&
d.attr("_ke_bookmark")&&this.setEndAt(d,g.POSITION_AFTER_END)},setStart:function(b,d){if(b[0].nodeType==f.NODE_ELEMENT&&j[b._4e_name()]){b=b.parent();d=b._4e_index()}this.startContainer=b;this.startOffset=d;if(!this.endContainer){this.endContainer=b;this.endOffset=d}this.updateCollapsed()},setEnd:function(b,d){if(b[0].nodeType==f.NODE_ELEMENT&&j[b._4e_name()]){b=b.parent();d=b._4e_index()+1}this.endContainer=b;this.endOffset=d;if(!this.startContainer){this.startContainer=b;this.startOffset=d}this.updateCollapsed()},
setStartAt:function(b,d){switch(d){case g.POSITION_AFTER_START:this.setStart(b,0);break;case g.POSITION_BEFORE_END:b[0].nodeType==f.NODE_TEXT?this.setStart(b,b[0].nodeValue.length):this.setStart(b,b[0].childNodes.length);break;case g.POSITION_BEFORE_START:this.setStartBefore(b);break;case g.POSITION_AFTER_END:this.setStartAfter(b)}this.updateCollapsed()},setEndAt:function(b,d){switch(d){case g.POSITION_AFTER_START:this.setEnd(b,0);break;case g.POSITION_BEFORE_END:b[0].nodeType==f.NODE_TEXT?this.setEnd(b,
b[0].nodeValue.length):this.setEnd(b,b[0].childNodes.length);break;case g.POSITION_BEFORE_START:this.setEndBefore(b);break;case g.POSITION_AFTER_END:this.setEndAfter(b)}this.updateCollapsed()},execContentsAction:function(b,d){var o=this.startContainer,A=this.endContainer,w=this.startOffset,C=this.endOffset,I,x;this.optimizeBookmark();if(A[0].nodeType==f.NODE_TEXT)A=A._4e_splitText(C);else if(A[0].childNodes.length>0)if(C>=A[0].childNodes.length){A=new c(A[0].appendChild(this.document.createTextNode("")));
x=true}else A=new c(A[0].childNodes[C]);if(o[0].nodeType==f.NODE_TEXT){o._4e_splitText(w);if(v._4e_equals(o,A))A=new c(o[0].nextSibling)}else if(w)if(w>=o[0].childNodes.length){I=new c(this.document.createTextNode(""));o[0].appendChild(I[0]);o=I;I=true}else o=new c(o[0].childNodes[w].previousSibling);else{I=new c(this.document.createTextNode(""));v.insertBefore(I[0],o[0].firstChild);o=I;I=true}w=o._4e_parents();C=A._4e_parents();var D,G,J;for(D=0;D<w.length;D++){G=w[D];J=C[D];if(G[0]!==J[0])break}for(var N=
d,M,Q,R,W=D;W<w.length;W++){M=w[W];if(N&&M[0]!==o[0])Q=N.appendChild(M._4e_clone()[0]);for(M=M[0].nextSibling;M;){if(C[W]&&M==C[W][0]||M==A[0])break;R=M.nextSibling;if(b==2)N.appendChild(M.cloneNode(true));else{M.parentNode.removeChild(M);b==1&&N.appendChild(M)}M=R}if(Q)N=Q}N=d;for(d=D;d<C.length;d++){M=C[d];if(b>0&&M[0]!==A[0])Q=N.appendChild(M._4e_clone()[0]);if(!w[d]||M[0].parentNode!==w[d][0].parentNode)for(M=M[0].previousSibling;M;){if(w[d]&&M==w[d][0]||M===o[0])break;R=M.previousSibling;if(b==
2)N.insertBefore(M.cloneNode(true),N.firstChild);else{M.parentNode.removeChild(M);b==1&&N.insertBefore(M,N.firstChild)}M=R}if(Q)N=Q}if(b==2){J=this.startContainer[0];if(J.nodeType==f.NODE_TEXT&&J.nextSibling&&J.nextSibling.nodeType==f.NODE_TEXT){J.data+=J.nextSibling.data;J.parentNode.removeChild(J.nextSibling)}J=this.endContainer[0];if(J.nodeType==f.NODE_TEXT&&J.nextSibling&&J.nextSibling.nodeType==f.NODE_TEXT){J.data+=J.nextSibling.data;J.parentNode.removeChild(J.nextSibling)}}else{if(G&&J&&(o[0].parentNode!=
G[0].parentNode||A[0].parentNode!=J[0].parentNode)){b=J._4e_index();I&&J[0].parentNode==o[0].parentNode&&b--;this.setStart(J.parent(),b)}this.collapse(true)}I&&o.remove();x&&A[0].parentNode&&A.remove()},collapse:function(b){if(b){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=this.endOffset}this.collapsed=true},clone:function(){var b=new r(this.document);b.startContainer=this.startContainer;b.startOffset=this.startOffset;
b.endContainer=this.endContainer;b.endOffset=this.endOffset;b.collapsed=this.collapsed;return b},getEnclosedNode:function(){var b=this.clone();b.optimize();if(b.startContainer[0].nodeType!=f.NODE_ELEMENT||b.endContainer[0].nodeType!=f.NODE_ELEMENT)return null;b=b.startContainer[0].childNodes[b.startOffset];for(var d=z(true,undefined),o=q(true),A=function(w){return o(w)&&d(w)};b&&A(b);)b=(new c(b))._4e_nextSourceNode()[0];return new c(b)},shrink:function(b,d){if(!this.collapsed){b=b||g.SHRINK_TEXT;
var o=this.clone(),A=this.startContainer,w=this.endContainer,C=this.startOffset,I=this.endOffset,x=1,D=1;if(A&&A[0].nodeType==f.NODE_TEXT)if(C)if(C>=A[0].nodeValue.length)o.setStartAfter(A);else{o.setStartBefore(A);x=0}else o.setStartBefore(A);if(w&&w[0].nodeType==f.NODE_TEXT)if(I)if(I>=w[0].nodeValue.length)o.setEndAfter(w);else{o.setEndAfter(w);D=0}else o.setEndBefore(w);o=new l(o);o.evaluator=function(J){J=J[0]||J;return J.nodeType==(b==g.SHRINK_ELEMENT?f.NODE_ELEMENT:f.NODE_TEXT)};var G;o.guard=
function(J,N){J=J[0]||J;if(b==g.SHRINK_ELEMENT&&J.nodeType==f.NODE_TEXT)return false;if(N&&J==G)return false;if(!N&&J.nodeType==f.NODE_ELEMENT)G=J;return true};if(x)(A=o[b==g.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(A,d?g.POSITION_AFTER_START:g.POSITION_BEFORE_START);if(D){o.reset();(o=o[b==g.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(o,d?g.POSITION_BEFORE_END:g.POSITION_AFTER_END)}return!!(x||D)}},getTouchedStartNode:function(){var b=this.startContainer;if(this.collapsed||
b[0].nodeType!=f.NODE_ELEMENT)return b;return b.childNodes[this.startOffset]||b},createBookmark2:function(b){var d=this.startContainer,o=this.endContainer,A=this.startOffset,w=this.endOffset,C,I;if(!d||!o)return{start:0,end:0};if(b){if(d[0].nodeType==f.NODE_ELEMENT)if((C=new c(d[0].childNodes[A]))&&C[0]&&C[0].nodeType==f.NODE_TEXT&&A>0&&C[0].previousSibling.nodeType==f.NODE_TEXT){d=C;A=0}for(;d[0].nodeType==f.NODE_TEXT&&(I=d._4e_previous())&&I[0].nodeType==f.NODE_TEXT;){d=I;A+=I[0].nodeValue.length}if(!this.collapsed){if(o[0].nodeType==
f.NODE_ELEMENT)if((C=new c(o[0].childNodes[w]))&&C[0]&&C[0].nodeType==f.NODE_TEXT&&w>0&&C[0].previousSibling.nodeType==f.NODE_TEXT){o=C;w=0}for(;o[0].nodeType==f.NODE_TEXT&&(I=o._4e_previous())&&I[0].nodeType==f.NODE_TEXT;){o=I;w+=I[0].nodeValue.length}}}return{start:d._4e_address(b),end:this.collapsed?null:o._4e_address(b),startOffset:A,endOffset:w,normalized:b,is2:true}},createBookmark:function(b){var d,o,A,w;d=new c("<span></span>",null,this.document);d.attr("_ke_bookmark",1);d.css("display","none");
d.html("&nbsp;");if(b){A=u.guid("ke_bm_");d.attr("id",A+"S")}if(!this.collapsed){o=d._4e_clone();o.html("&nbsp;");b&&o.attr("id",A+"E");w=this.clone();w.collapse();w.insertNode(o)}w=this.clone();w.collapse(true);w.insertNode(d);if(o){this.setStartAfter(d);this.setEndBefore(o)}else this.moveToPosition(d,g.POSITION_AFTER_END);return{startNode:b?A+"S":d,endNode:b?A+"E":o,serializable:b}},moveToPosition:function(b,d){this.setStartAt(b,d);this.collapse(true)},trim:function(b,d){var o=this.startContainer,
A=this.startOffset,w=this.collapsed;if((!b||w)&&o[0]&&o[0].nodeType==f.NODE_TEXT){if(A)if(A>=o[0].nodeValue.length){A=o._4e_index()+1;o=o.parent()}else{b=o._4e_splitText(A);A=o._4e_index()+1;o=o.parent();if(v._4e_equals(this.startContainer,this.endContainer))this.setEnd(b,this.endOffset-this.startOffset);else if(v._4e_equals(o,this.endContainer))this.endOffset+=1}else{A=o._4e_index();o=o.parent()}this.setStart(o,A);if(w){this.collapse(true);return}}o=this.endContainer;A=this.endOffset;if(!(d||w)&&
o[0]&&o[0].nodeType==f.NODE_TEXT){if(A){A>=o.nodeValue.length||o._4e_splitText(A);A=o._4e_index()+1}else A=o._4e_index();o=o.parent();this.setEnd(o,A)}},insertNode:function(b){this.optimizeBookmark();this.trim(false,true);var d=this.startContainer,o=d[0].childNodes[this.startOffset];this.optimizeBookmark();this.trim(false,true);o?v.insertBefore(b[0]||b,o):d[0].appendChild(b[0]||b);v._4e_equals(b.parent(),this.endContainer)&&this.endOffset++;this.setStartBefore(b)},moveToBookmark:function(b){if(b.is2){var d=
k(this.document,b.start,b.normalized),o=b.startOffset,A=b.end&&k(this.document,b.end,b.normalized);b=b.endOffset;this.setStart(d,o);A?this.setEnd(A,b):this.collapse(true)}else{d=(o=b.serializable)?u.one("#"+b.startNode,this.document):b.startNode;b=o?u.one("#"+b.endNode,this.document):b.endNode;this.setStartBefore(d);d.remove();if(b&&b[0]){this.setEndBefore(b);b.remove()}else this.collapse(true)}},getCommonAncestor:function(b,d){var o=this.startContainer,A=this.endContainer;b=v._4e_equals(o,A)?b&&
o[0].nodeType==f.NODE_ELEMENT&&this.startOffset==this.endOffset-1?new c(o[0].childNodes[this.startOffset]):o:o._4e_commonAncestor(A);return d&&b[0].nodeType==f.NODE_TEXT?b.parent():b},enlarge:function(b){switch(b){case g.ENLARGE_ELEMENT:if(this.collapsed)return;b=this.getCommonAncestor();var d=new c(this.document.body),o,A,w,C,I,x=false,D,G;D=this.startContainer;G=this.startOffset;if(D[0].nodeType==f.NODE_TEXT){if(G){D=!u.trim(D[0].nodeValue.substring(0,G)).length&&D;x=!!D}if(D)if(!(C=D[0].previousSibling))w=
D.parent()}else{if(G)C=D[0].childNodes[G-1]||D[0].lastChild;C||(w=D)}for(;w||C;){if(w&&!C){if(!I&&v._4e_equals(w,b))I=true;if(!d._4e_contains(w))break;if(!x||w.css("display")!="inline"){x=false;if(I)o=w;else this.setStartBefore(w)}C=w[0].previousSibling}for(;C;){D=false;if(C.nodeType==f.NODE_TEXT){G=C.nodeValue;if(/[^\s\ufeff]/.test(G))C=null;D=/[\s\ufeff]$/.test(G)}else if(C.offsetWidth>0&&!C.getAttribute("_ke_bookmark"))if(x&&p.$removeEmpty[C.nodeName.toLowerCase()]){G=v.text(C);if(/[^\s\ufeff]/.test(G))C=
null;else for(var J=C.all||C.getElementsByTagName("*"),N=0,M;M=J[N++];)if(!p.$removeEmpty[M.nodeName.toLowerCase()]){C=null;break}if(C)D=!!G.length}else C=null;if(D)if(x)if(I)o=w;else w&&this.setStartBefore(w);else x=true;if(C){D=C.previousSibling;if(!w&&!D){w=new c(C);C=null;break}C=D}else w=null}if(w)w=w.parent()}D=this.endContainer;G=this.endOffset;w=C=null;I=x=false;if(D[0].nodeType==f.NODE_TEXT){D=!u.trim(D[0].nodeValue.substring(G)).length&&D;x=!(D&&D[0].nodeValue.length);if(D)if(!(C=D[0].nextSibling))w=
D.parent()}else(C=D[0].childNodes[G])||(w=D);for(;w||C;){if(w&&!C){if(!I&&v._4e_equals(w,b))I=true;if(!d._4e_contains(w))break;if(!x||w.css("display")!="inline"){x=false;if(I)A=w;else w&&this.setEndAfter(w)}C=w[0].nextSibling}for(;C;){D=false;if(C.nodeType==f.NODE_TEXT){G=C.nodeValue;if(/[^\s\ufeff]/.test(G))C=null;D=/^[\s\ufeff]/.test(G)}else if(C.offsetWidth>0&&!C.getAttribute("_ke_bookmark"))if(x&&p.$removeEmpty[C.nodeName.toLowerCase()]){G=v.text(C);if(/[^\s\ufeff]/.test(G))C=null;else{J=C.all||
C.getElementsByTagName("*");for(N=0;M=J[N++];)if(!p.$removeEmpty[M.nodeName.toLowerCase()]){C=null;break}}if(C)D=!!G.length}else C=null;if(D)if(x)if(I)A=w;else this.setEndAfter(w);if(C){D=C.nextSibling;if(!w&&!D){w=new c(C);C=null;break}C=D}else w=null}if(w)w=w.parent()}if(o&&A){b=o._4e_contains(A)?A:o;this.setStartBefore(b);this.setEndAfter(b)}break;case g.ENLARGE_BLOCK_CONTENTS:case g.ENLARGE_LIST_ITEM_CONTENTS:w=new r(this.document);d=new c(this.document.body);w.setStartAt(d,g.POSITION_AFTER_START);
w.setEnd(this.startContainer,this.startOffset);w=new l(w);var Q,R,W=l.blockBoundary(b==g.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:null),$=function(aa){var E=W(aa);E||(Q=aa);return E};o=function(aa){var E=$(aa);if(!E&&aa[0]&&aa._4e_name()=="br")R=aa;return E};w.guard=$;w=w.lastBackward();Q=Q||d;this.setStartAt(Q,Q._4e_name()!="br"&&(!w&&this.checkStartOfBlock()||w&&Q._4e_contains(w))?g.POSITION_AFTER_START:g.POSITION_AFTER_END);w=this.clone();w.collapse();w.setEndAt(d,g.POSITION_BEFORE_END);w=new l(w);w.guard=
b==g.ENLARGE_LIST_ITEM_CONTENTS?o:$;Q=null;w=w.lastForward();Q=Q||d;this.setEndAt(Q,!w&&this.checkEndOfBlock()||w&&Q._4e_contains(w)?g.POSITION_BEFORE_END:g.POSITION_BEFORE_START);R&&this.setEndAfter(R)}},checkStartOfBlock:function(){var b=this.startContainer,d=this.startOffset;if(d&&b[0].nodeType==f.NODE_TEXT)if(u.trim(b[0].nodeValue.substring(0,d)).length)return false;this.trim();b=new a(this.startContainer);d=this.clone();d.collapse(true);d.setStartAt(b.block||b.blockLimit,g.POSITION_AFTER_START);
b=new l(d);b.evaluator=n(true);return b.checkBackward()},checkEndOfBlock:function(){var b=this.endContainer,d=this.endOffset;if(b[0].nodeType==f.NODE_TEXT)if(u.trim(b[0].nodeValue.substring(d)).length)return false;this.trim();b=new a(this.endContainer);d=this.clone();d.collapse(false);d.setEndAt(b.block||b.blockLimit,g.POSITION_BEFORE_END);b=new l(d);b.evaluator=n(false);return b.checkForward()},deleteContents:function(){this.collapsed||this.execContentsAction(0)},extractContents:function(){var b=
this.document.createDocumentFragment();this.collapsed||this.execContentsAction(1,b);return b},checkBoundaryOfElement:function(b,d){var o=this.clone();o[d==g.START?"setStartAt":"setEndAt"](b,d==g.START?g.POSITION_AFTER_START:g.POSITION_BEFORE_END);b=new l(o);b.evaluator=B;return b[d==g.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var b=this.startContainer,d=this.endContainer,o=this.startOffset,A=this.endOffset,w;if(b[0].nodeType==f.NODE_ELEMENT){w=b[0].childNodes.length;if(w>
o)b=new c(b[0].childNodes[o]);else if(w<1)b=b._4e_previousSourceNode();else{for(b=b[0];b.lastChild;)b=b.lastChild;b=new c(b);b=b._4e_nextSourceNode()||b}}if(d[0].nodeType==f.NODE_ELEMENT){w=d[0].childNodes.length;if(w>A)d=(new c(d[0].childNodes[A]))._4e_previousSourceNode(true);else if(w<1)d=d._4e_previousSourceNode();else{for(d=d[0];d.lastChild;)d=d.lastChild;d=new c(d)}}if(b._4e_position(d)&i.POSITION_FOLLOWING)b=d;return{startNode:b,endNode:d}},fixBlock:function(b,d){var o=this.createBookmark();
d=new c(this.document.createElement(d));this.collapse(b);this.enlarge(g.ENLARGE_BLOCK_CONTENTS);d[0].appendChild(this.extractContents());d._4e_trim();m.ie||d._4e_appendBogus();this.insertNode(d);this.moveToBookmark(o);return d},splitBlock:function(b){var d=new a(this.startContainer),o=new a(this.endContainer),A=d.block,w=o.block,C=null;if(d.blockLimit[0]!==o.blockLimit[0])return null;if(b!="br"){if(!A){A=this.fixBlock(true,b);w=(new a(this.endContainer)).block}w||(w=this.fixBlock(false,b))}b=A&&this.checkStartOfBlock();
d=w&&this.checkEndOfBlock();this.deleteContents();if(A&&v._4e_equals(A,w))if(d){C=new a(this.startContainer);this.moveToPosition(w,g.POSITION_AFTER_END);w=null}else if(b){C=new a(this.startContainer);this.moveToPosition(A,g.POSITION_BEFORE_START);A=null}else{w=this.splitElement(A);!m.ie&&!u.inArray(A._4e_name(),["ul","ol"])&&A._4e_appendBogus()}return{previousBlock:A,nextBlock:w,wasStartOfBlock:b,wasEndOfBlock:d,elementPath:C}},splitElement:function(b){if(!this.collapsed)return null;this.setEndAt(b,
g.POSITION_BEFORE_END);var d=this.extractContents(),o=b._4e_clone(false);o[0].appendChild(d);o.insertAfter(b);this.moveToPosition(b,g.POSITION_AFTER_END);return o},moveToElementEditablePosition:function(b,d){var o,A=y.XHTML_DTD;if(A.$empty[b._4e_name()])return false;for(;b&&b[0].nodeType==f.NODE_ELEMENT;){if(o=b._4e_isEditable())this.moveToPosition(b,d?g.POSITION_BEFORE_END:g.POSITION_AFTER_START);else if(A.$inline[b._4e_name()]){this.moveToPosition(b,d?g.POSITION_AFTER_END:g.POSITION_BEFORE_START);
return true}if((b=A.$empty[b._4e_name()]?b[d?"_4e_previous":"_4e_next"](t):b[d?"_4e_last":"_4e_first"](t))&&b[0].nodeType==f.NODE_TEXT){this.moveToPosition(b,d?g.POSITION_AFTER_END:g.POSITION_BEFORE_START);return true}}return o},selectNodeContents:function(b){this.setStart(b,0);this.setEnd(b,b[0].nodeType==f.NODE_TEXT?b[0].nodeValue.length:b[0].childNodes.length)}});var e={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},h=new l.whitespaces,s=new l.bookmark;y.Range=r});
KISSY.Editor.add("domiterator",function(y){function r(k){if(!(arguments.length<1)){this.range=k;this.forceBrBreak=false;this.enlargeBr=true;this.enforceRealBlocks=false;this._||(this._={})}}var B=KISSY,t=B.UA,n=y.Walker,z=y.Range,q=y.RANGE,u=y.NODE,f=y.ElementPath,g=B.Node,i=B.DOM,l=/^[\r\n\t ]*$/,v=n.bookmark();B.augment(r,{getNextParagraph:function(k){var m,p,a,c,j;if(!this._.lastNode){p=this.range.clone();p.enlarge(this.forceBrBreak||!this.enlargeBr?q.ENLARGE_LIST_ITEM_CONTENTS:q.ENLARGE_BLOCK_CONTENTS);
var e=new n(p),h=n.bookmark(true,true);e.evaluator=h;this._.nextNode=e.next();e=new n(p);e.evaluator=h;e=e.previous();this._.lastNode=e._4e_nextSourceNode(true);if(this._.lastNode&&this._.lastNode[0].nodeType==u.NODE_TEXT&&!B.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()){h=new z(p.document);h.moveToPosition(this._.lastNode,q.POSITION_AFTER_END);if(h.checkEndOfBlock()){h=new f(h.endContainer);this._.lastNode=(h.block||h.blockLimit)._4e_nextSourceNode(true)}}if(!this._.lastNode){this._.lastNode=
this._.docEndMarker=new g(p.document.createTextNode(""));i.insertAfter(this._.lastNode[0],e[0])}p=null}h=this._.nextNode;e=this._.lastNode;for(this._.nextNode=null;h;){var s=false,b=h[0].nodeType!=u.NODE_ELEMENT,d=false;if(b){if(h[0].nodeType==u.NODE_TEXT)if(l.test(h[0].nodeValue))b=false}else{var o=h._4e_name();if(h._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if(o=="br")b=true;else if(!p&&!h[0].childNodes.length&&o!="hr"){m=h;a=h._4e_equals(e);break}if(p){p.setEndAt(h,q.POSITION_BEFORE_START);
if(o!="br")this._.nextNode=h}s=true}else{if(h[0].firstChild){if(!p){p=new z(this.range.document);p.setStartAt(h,q.POSITION_BEFORE_START)}h=new g(h[0].firstChild);continue}b=true}}if(b&&!p){p=new z(this.range.document);p.setStartAt(h,q.POSITION_BEFORE_START)}a=(!s||b)&&h._4e_equals(e);if(p&&!s)for(;!h[0].nextSibling&&!a;){o=h.parent();if(o._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){s=true;a||o._4e_equals(e);break}h=o;b=true;a=h._4e_equals(e);d=true}b&&p.setEndAt(h,q.POSITION_AFTER_END);h=h._4e_nextSourceNode(d,
null,e);a=!h;if((s||a)&&p){b=p.getBoundaryNodes();s=new f(p.startContainer);if(b.startNode.parent()._4e_equals(s.blockLimit)&&v(b.startNode)&&v(b.endNode)){p=null;this._.nextNode=null}else break}if(a)break}if(!m){if(!p){this._.docEndMarker&&this._.docEndMarker.remove();return this._.nextNode=null}s=new f(p.startContainer);h=s.blockLimit;b={div:1,th:1,td:1};m=s.block;if((!m||!m[0])&&!this.enforceRealBlocks&&b[h._4e_name()]&&p.checkStartOfBlock()&&p.checkEndOfBlock())m=h;else if(!m||this.enforceRealBlocks&&
m._4e_name()=="li"){m=new g(this.range.document.createElement(k||"p"));m[0].appendChild(p.extractContents());m._4e_trim();p.insertNode(m);c=j=true}else if(m._4e_name()!="li"){if(!p.checkStartOfBlock()||!p.checkEndOfBlock()){m=m._4e_clone(false);m[0].appendChild(p.extractContents());m._4e_trim();j=p.splitBlock();c=!j.wasStartOfBlock;j=!j.wasEndOfBlock;p.insertNode(m)}}else if(!a)this._.nextNode=m._4e_equals(e)?null:p.getBoundaryNodes().endNode._4e_nextSourceNode(true,null,e)}if(c){p=new g(m[0].previousSibling);
if(p[0]&&p[0].nodeType==u.NODE_ELEMENT)if(p._4e_name()=="br")p._4e_remove();else p[0].lastChild&&p[0].lastChild.nodeName.toLowerCase()=="br"&&i._4e_remove(p[0].lastChild)}if(j){p=n.bookmark(false,true);c=new g(m[0].lastChild);if(c[0]&&c[0].nodeType==u.NODE_ELEMENT&&c._4e_name()=="br")if(t.ie||c._4e_previous(p)||c._4e_next(p))c._4e_remove()}if(!this._.nextNode)this._.nextNode=a||m._4e_equals(e)?null:m._4e_nextSourceNode(true,null,e);return m}});z.prototype.createIterator=function(){return new r(this)}});
KISSY.Editor.add("selection",function(y){function r(e){this.document=e;this._={cache:{}};if(z.ie){var h=this.getNative().createRange();if(!h||h.item&&h.item(0).ownerDocument!=e||h.parentElement&&h.parentElement().ownerDocument!=e)this.isInvalid=true}}function B(e){e=new r(e);return!e||e.isInvalid?null:e}function t(e){var h=e.document,s=new g(h.body),b=new g(h.documentElement);if(z.ie){if(z.ie<8||document.documentMode==7)b.on("click",function(C){q._4e_name(C.target)==="html"&&e.getSelection().getRanges()[0].select()});
var d,o;s.on("focusin",function(C){if(C.target.nodeName.toUpperCase()=="BODY")if(d){try{d.select()}catch(I){}d=null}});s.on("focus",function(){o=true;w()});s.on("beforedeactivate",function(C){C.relatedTarget||(o=false)});z.ie<8&&u.on(q._4e_getWin(h),"blur",function(){h.selection.empty()});s.on("mousedown",A);s.on("mouseup",function(){o=true;setTimeout(function(){w(true)},0)});s.on("keydown",A);s.on("keyup",function(){o=true;w()});u.on(h,"selectionchange",w);var A=function(){o=false},w=function(C){if(o){var I=
e.document,x=e.getSelection(),D=x&&x.getNative();if(C&&D&&D.type=="None")if(!I.queryCommandEnabled("InsertImage")){setTimeout(function(){w(true)},50);return}var G;if(!(D&&D.type=="Text"&&(G=D.createRange().parentElement().nodeName.toLowerCase())&&G in{input:1,textarea:1})){d=D&&x.getRanges()[0];e._monitor()}}}}else{u.on(h,"mouseup",e._monitor,e);u.on(h,"keyup",e._monitor,e)}}y.SELECTION={};var n=KISSY,z=n.UA,q=n.DOM,u=n.Event,f=y.Utils.tryThese,g=n.Node,i=y.SELECTION,l=y.RANGE,v=y.NODE,k=y.Walker,
m=y.Range;i.SELECTION_NONE=1;i.SELECTION_TEXT=2;i.SELECTION_ELEMENT=3;var p={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};n.augment(r,{getNative:z.ie?function(){return this._.cache.nativeSel||(this._.cache.nativeSel=this.document.selection)}:function(){return this._.cache.nativeSel||(this._.cache.nativeSel=q._4e_getWin(this.document).getSelection())},getType:z.ie?function(){var e=this._.cache;if(e.type)return e.type;
var h=i.SELECTION_NONE;try{var s=this.getNative(),b=s.type;if(b=="Text")h=i.SELECTION_TEXT;if(b=="Control")h=i.SELECTION_ELEMENT;if(s.createRange().parentElement)h=i.SELECTION_TEXT}catch(d){}return e.type=h}:function(){var e=this._.cache;if(e.type)return e.type;var h=i.SELECTION_TEXT,s=this.getNative();if(s){if(s.rangeCount==1){s=s.getRangeAt(0);var b=s.startContainer;if(b==s.endContainer&&b.nodeType==v.NODE_ELEMENT&&s.endOffset-s.startOffset===1&&p[b.childNodes[s.startOffset].nodeName.toLowerCase()])h=
i.SELECTION_ELEMENT}}else h=i.SELECTION_NONE;return e.type=h},getRanges:z.ie?function(){var e=function(h,s){h=h.duplicate();h.collapse(s);s=h.parentElement();for(var b=s.childNodes,d,o=0;o<b.length;o++){var A=b[o];if(A.nodeType==v.NODE_ELEMENT){d=h.duplicate();d.moveToElementText(A);A=d.compareEndPoints("StartToStart",h);var w=d.compareEndPoints("EndToStart",h);d.collapse();if(A>0)break;else if(!A||w==1&&A==-1)return{container:s,offset:o};else if(!w)return{container:s,offset:o+1};d=null}}if(!d){d=
h.duplicate();d.moveToElementText(s);d.collapse(false)}d.setEndPoint("StartToStart",h);h=d.text.replace(/(\r\n|\r)/g,"\n").length;try{for(;h>0;)h-=b[--o].nodeValue.length}catch(C){h=0}return h===0?{container:s,offset:o}:{container:b[o],offset:-h}};return function(){var h=this._.cache;if(h.ranges)return h.ranges;var s=this.getNative(),b=s&&s.createRange(),d=this.getType();if(!s)return[];if(d==i.SELECTION_TEXT){s=new m(this.document);d=e(b,true);s.setStart(new g(d.container),d.offset);d=e(b);s.setEnd(new g(d.container),
d.offset);return h.ranges=[s]}else if(d==i.SELECTION_ELEMENT){h=this._.cache.ranges=[];for(d=0;d<b.length;d++){var o=b.item(d),A=o.parentNode,w=0;for(s=new m(this.document);w<A.childNodes.length&&A.childNodes[w]!=o;w++);s.setStart(new g(A),w);s.setEnd(new g(A),w+1);h.push(s)}return h}return h.ranges=[]}}():function(){var e=this._.cache;if(e.ranges)return e.ranges;var h=[],s=this.getNative();if(!s)return[];for(var b=0;b<s.rangeCount;b++){var d=s.getRangeAt(b),o=new m(this.document);o.setStart(new g(d.startContainer),
d.startOffset);o.setEnd(new g(d.endContainer),d.endOffset);h.push(o)}return e.ranges=h},getStartElement:function(){var e=this._.cache;if(e.startElement!==undefined)return e.startElement;var h,s=this.getNative();switch(this.getType()){case i.SELECTION_ELEMENT:return this.getSelectedElement();case i.SELECTION_TEXT:var b=this.getRanges()[0];if(b)if(!b.collapsed){for(b.optimize();;){h=b.startContainer;if(b.startOffset==(h[0].childNodes?h[0].childNodes.length:h[0].nodeValue.length)&&!h._4e_isBlockBoundary())b.setStartAfter(h);
else break}h=b.startContainer;if(h[0].nodeType!=v.NODE_ELEMENT)return h.parent();h=new g(h[0].childNodes[b.startOffset]);if(!h[0]||h[0].nodeType!=v.NODE_ELEMENT)return b.startContainer;for(b=h[0].firstChild;b&&b.nodeType==v.NODE_ELEMENT;){h=new g(b);b=b.firstChild}return h}if(z.ie){b=s.createRange();b.collapse(true);h=b.parentElement()}else if((h=s.anchorNode)&&h.nodeType!=v.NODE_ELEMENT)h=h.parentNode}return e.startElement=h?new g(h):null},getSelectedElement:function(){var e=this._.cache;if(e.selectedElement!==
undefined)return e.selectedElement;var h=this,s=f(function(){return h.getNative().createRange().item(0)},function(){for(var b=h.getRanges()[0],d,o,A=2;A&&!((d=b.getEnclosedNode())&&d[0].nodeType==v.NODE_ELEMENT&&p[d._4e_name()]&&(o=d));A--)b.shrink(l.SHRINK_ELEMENT);return o[0]});return e.selectedElement=s?new g(s):null},reset:function(){this._.cache={}},selectElement:function(e){var h;if(z.ie){this.getNative().empty();try{h=this.document.body.createControlRange();h.addElement(e[0]);h.select()}catch(s){h=
this.document.body.createTextRange();h.moveToElementText(e[0]);h.select()}finally{}}else{h=this.document.createRange();h.selectNode(e[0]);e=this.getNative();e.removeAllRanges();e.addRange(h)}this.reset()},selectRanges:function(e){if(z.ie)e[0]&&e[0].select();else{var h=this.getNative();if(!h)return;h.removeAllRanges();for(var s=0;s<e.length;s++){var b=e[s],d=this.document.createRange(),o=b.startContainer;b.collapsed&&z.gecko&&z.gecko<1.09&&o[0].nodeType==v.NODE_ELEMENT&&!o[0].childNodes.length&&o[0].appendChild(this.document.createTextNode(""));
d.setStart(o[0],b.startOffset);d.setEnd(b.endContainer[0],b.endOffset);h.addRange(d)}}this.reset()},createBookmarks2:function(e){for(var h=[],s=this.getRanges(),b=0;b<s.length;b++)h.push(s[b].createBookmark2(e));return h},createBookmarks:function(e){for(var h=[],s=this.getRanges(),b=s.length,d,o=0;o<b;o++){h.push(d=s[o].createBookmark(e,true));var A=(e=d.serializable)?n.one("#"+d.startNode):d.startNode;d=e?n.one("#"+d.endNode):d.endNode;for(var w=o+1;w<b;w++){var C=s[w],I=C.startContainer,x=C.endContainer;
q._4e_equals(I,A.parent())&&C.startOffset++;q._4e_equals(I,d.parent())&&C.startOffset++;q._4e_equals(x,A.parent())&&C.endOffset++;q._4e_equals(x,d.parent())&&C.endOffset++}}return h},selectBookmarks:function(e){for(var h=[],s=0;s<e.length;s++){var b=new m(this.document);b.moveToBookmark(e[s]);h.push(b)}this.selectRanges(h);return this},getCommonAncestor:function(){var e=this.getRanges();return e[0].startContainer._4e_commonAncestor(e[e.length-1].endContainer)},scrollIntoView:function(){this.getStartElement().scrollIntoView()}});
y.Selection=r;var a={table:1,tbody:1,tr:1},c=k.whitespaces(true),j=/\ufeff|\u00a0/;m.prototype.select=z.ie?function(e){var h=this.collapsed,s,b;if(this.startContainer[0].nodeType==v.NODE_ELEMENT&&this.startContainer._4e_name()in a||this.endContainer[0].nodeType==v.NODE_ELEMENT&&this.endContainer._4e_name()in a)this.shrink(v.NODE_ELEMENT,true);var d=this.createBookmark(),o=d.startNode,A;if(!h)A=d.endNode;d=this.document.body.createTextRange();d.moveToElementText(o[0]);d.moveStart("character",1);if(A){e=
this.document.body.createTextRange();e.moveToElementText(A[0]);d.setEndPoint("EndToEnd",e);d.moveEnd("character",-1)}else{for(s=o[0].nextSibling;s&&!c(s);)s=s.nextSibling;s=!(s&&s.nodeValue&&s.nodeValue.match(j))&&(e||!o[0].previousSibling||o[0].previousSibling&&q._4e_name(o[0].previousSibling)=="br");b=this.document.createElement("span");b.innerHTML="&#65279;";b=new g(b);q.insertBefore(b[0],o[0]);s&&q.insertBefore(this.document.createTextNode("\ufeff"),o[0])}this.setStartBefore(o);o._4e_remove();
if(h){if(s){d.moveStart("character",-1);d.select();this.document.selection.clear()}else d.select();if(b){this.moveToPosition(b,l.POSITION_BEFORE_START);b._4e_remove()}}else{this.setEndBefore(A);A.remove();d.select()}}:function(){var e=this.startContainer;this.collapsed&&e[0].nodeType==v.NODE_ELEMENT&&!e[0].childNodes.length&&e[0].appendChild(this.document.createTextNode(""));var h=this.document.createRange();h.setStart(e[0],this.startOffset);try{h.setEnd(this.endContainer[0],this.endOffset)}catch(s){if(s.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=
0){this.collapse(true);h.setEnd(this.endContainer[0],this.endOffset)}else throw s;}e=B(this.document).getNative();e.removeAllRanges();e.addRange(h)};y.on("instanceCreated",function(e){t(e.editor)})});
KISSY.Editor.add("styles",function(y){function r(E,F){for(var H in E)E[H]=E[H].replace(aa,function(K,L){return F[L]})}function B(E,F){if(F){E=A.clone(E);r(E.attributes,F);r(E.styles,F)}F=this.element=(E.element||"*").toLowerCase();this.type=F=="#"||R[F]?C.STYLE_BLOCK:W[F]?C.STYLE_OBJECT:C.STYLE_INLINE;this._={definition:E}}function t(E,F){F=F?this.removeFromRange:this.applyToRange;E.body.focus();E=new x(E);for(var H=E.getRanges(),K=0;K<H.length;K++)F.call(this,H[K]);E.selectRanges(H)}function n(E,
F){var H=E.element;if(H=="*")H="span";F=new N(F.createElement(H));return z(F,E)}function z(E,F){var H=F._.definition;F=H.attributes;H=B.getStyleText(H);if(F)for(var K in F)E.attr(K,F[K]);if(H)E[0].style.cssText=H;return E}function q(E){var F=E.createBookmark(true),H=E.createIterator();H.enforceRealBlocks=true;H.enlargeBr=true;for(var K,L=E.document;K=H.getNextParagraph();){var O=n(this,L);i(K,O)}E.moveToBookmark(F)}function u(E,F,H){var K="",L="";E=E.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,
function(O,P,S){P&&(K=P);S&&(L=S);return""});return K+E.replace(F,H)+L}function f(E,F){var H=E.html();H=u(H,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,"");H=H.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1");H=H.replace(/([ \t\n\r]+|&nbsp;)/g," ");H=H.replace(/<br\b[^>]*>/gi,"\n");if(M.ie){E=E[0].ownerDocument.createElement("div");E.appendChild(F[0]);F[0].outerHTML="<pre>"+H+"</pre>";F=new N(E.firstChild);F.remove()}else F.html(H);return F}function g(E){var F=[];u(E._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,
function(H,K,L){return K+"</pre>"+L+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(H,K){F.push(K)});return F}function i(E,F){var H=F._4e_name=="pre",K=E._4e_name=="pre",L=!H&&K;if(H&&!K)F=f(E,F);else if(L)F=v(g(E),F);else E._4e_moveChildren(F);E[0].parentNode.replaceChild(F[0],E[0]);H&&l(F)}function l(E){var F;if((F=E._4e_previousSourceNode(true,D.NODE_ELEMENT))&&F._4e_name()=="pre"){var H=u(F.html(),/\n$/,"")+"\n\n"+u(E.html(),/^\n/,"");if(M.ie)E[0].outerHTML="<pre>"+H+"</pre>";else E.html(H);
F.remove()}}function v(E,F){for(var H=F[0].ownerDocument.createDocumentFragment(),K=0;K<E.length;K++){var L=E[K];L=L.replace(/(\r\n|\r)/g,"\n");L=u(L,/^[ \t]*\n/,"");L=u(L,/\n$/,"");L=u(L,/^[ \t]+|[ \t]+$/g,function(P,S){return P.length==1?"&nbsp;":S?" "+(new Array(P.length)).join("&nbsp;"):(new Array(P.length)).join("&nbsp;")+" "});L=L.replace(/\n/g,"<br>");L=L.replace(/[ \t]{2,}/g,function(P){return(new Array(P.length)).join("&nbsp;")+" "});var O=F._4e_clone();O.html(L);H.appendChild(O[0])}return H}
function k(E){var F=E.document;if(E.collapsed){F=n(this,F);E.insertNode(F);E.moveToPosition(F,I.POSITION_BEFORE_END)}else{var H=this.element,K=this._.definition,L,O=y.XHTML_DTD[H]||(L=true,y.XHTML_DTD.span),P=E.createBookmark();E.enlarge(I.ENLARGE_ELEMENT);E.trim();var S=E.createBookmark(),da=S.startNode;S=S.endNode;for(var U=da,X;U&&U[0];){var T=false;if(w._4e_equals(U,S)){U=null;T=true}else{var V=U[0].nodeType,ba=V==D.NODE_ELEMENT?U._4e_name():null;if(ba&&U.attr("_ke_bookmark")){U=U._4e_nextSourceNode(true);
continue}if(!ba||O[ba]&&(U._4e_position(S)|G.POSITION_PRECEDING|G.POSITION_IDENTICAL|G.POSITION_IS_CONTAINED)==G.POSITION_PRECEDING+G.POSITION_IDENTICAL+G.POSITION_IS_CONTAINED&&(!K.childRule||K.childRule(U))){var ca=U.parent();if(ca&&ca[0]&&((y.XHTML_DTD[ca._4e_name()]||y.XHTML_DTD.span)[H]||L)&&(!K.parentRule||K.parentRule(ca))){if(!X&&(!ba||!y.XHTML_DTD.$removeEmpty[ba]||(U._4e_position(S)|G.POSITION_PRECEDING|G.POSITION_IDENTICAL|G.POSITION_IS_CONTAINED)==G.POSITION_PRECEDING+G.POSITION_IDENTICAL+
G.POSITION_IS_CONTAINED)){X=new J(F);X.setStartBefore(U)}if(V==D.NODE_TEXT||V==D.NODE_ELEMENT&&!U[0].childNodes.length){V=U;for(var Y;!V[0].nextSibling&&(Y=V.parent(),O[Y._4e_name()])&&(Y._4e_position(da)|G.POSITION_FOLLOWING|G.POSITION_IDENTICAL|G.POSITION_IS_CONTAINED)==G.POSITION_FOLLOWING+G.POSITION_IDENTICAL+G.POSITION_IS_CONTAINED&&(!K.childRule||K.childRule(Y));)V=Y;X.setEndAfter(V);V[0].nextSibling||(T=true)}}else T=true}else T=true;U=U._4e_nextSourceNode()}if(T&&X&&!X.collapsed){T=n(this,
F);for(V=X.getCommonAncestor();T&&V&&T[0]&&V[0];){if(V._4e_name()==H){for(var Z in K.attributes)T.attr(Z)==V.attr(Z)&&T[0].removeAttribute(Z);for(var ea in K.styles)T._4e_style(ea)==V._4e_style(ea)&&T._4e_style(ea,"");if(!T._4e_hasAttributes()){T=null;break}}V=V.parent()}if(T){T[0].appendChild(X.extractContents());b(this,T);X.insertNode(T);T._4e_mergeSiblings();M.ie||T[0].normalize()}X=null}}da.remove();S.remove();E.moveToBookmark(P);E.shrink(I.SHRINK_TEXT)}}function m(E){E.enlarge(I.ENLARGE_ELEMENT);
var F=E.createBookmark(),H=F.startNode;if(E.collapsed){for(var K=new Q(H.parent()),L,O=0,P;O<K.elements.length&&(P=K.elements[O]);O++){if(P==K.block||P==K.blockLimit)break;if(this.checkElementRemovable(P)){var S=E.checkBoundaryOfElement(P,I.END),da=!S&&E.checkBoundaryOfElement(P,I.START);if(da||S){L=P;L.match=da?"start":"end"}else{P._4e_mergeSiblings();h(this,P)}}}if(L&&L[0]){P=H;for(O=0;;O++){S=K.elements[O];if(w._4e_equals(S,L))break;else if(S.match)continue;else S=S._4e_clone();S[0].appendChild(P[0]);
P=S}w[L.match=="start"?"insertBefore":"insertAfter"](P[0],L[0])}}else{var U=F.endNode,X=this;K=function(){for(var T=new Q(H.parent()),V=new Q(U.parent()),ba=null,ca=null,Y=0;Y<T.elements.length;Y++){var Z=T.elements[Y];if(Z==T.block||Z==T.blockLimit)break;if(X.checkElementRemovable(Z))ba=Z}for(Y=0;Y<V.elements.length;Y++){Z=V.elements[Y];if(Z==V.block||Z==V.blockLimit)break;if(X.checkElementRemovable(Z))ca=Z}ca&&U._4e_breakParent(ca);ba&&H._4e_breakParent(ba)};K();for(L=new N(H[0].nextSibling);L[0]!==
U[0];){O=L._4e_nextSourceNode();if(L[0].nodeType==D.NODE_ELEMENT&&this.checkElementRemovable(L)){L._4e_name()==this.element?h(this,L):d(L,e(this)[L._4e_name()]);if(O[0].nodeType==D.NODE_ELEMENT&&O._4e_contains(H)){K();O=new N(H[0].nextSibling)}}L=O}}E.moveToBookmark(F)}function p(E){var F={};E.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(H,K,L){F[K]=L});return F}function a(E,F){typeof E=="string"&&(E=p(E));typeof F=="string"&&(F=p(F));for(var H in E)if(!(H in F&&
(F[H]==E[H]||E[H]=="inherit"||F[H]=="inherit")))return false;return true}function c(E,F){if(F!==false){F=document.createElement("span");F.style.cssText=E;E=F.style.cssText||""}else E=E;return E.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function j(E){var F=E._AC;if(F)return F;F={};var H=0,K=E.attributes;if(K)for(var L in K){H++;F[L]=K[L]}if(K=B.getStyleText(E)){F.style||H++;F.style=K}F._length=H;return E._AC=F}function e(E){if(E._.overrides)return E._.overrides;
var F=E._.overrides={},H=E._.definition.overrides;if(H){A.isArray(H)||(H=[H]);for(var K=0;K<H.length;K++){var L=H[K],O,P;if(typeof L=="string")O=L.toLowerCase();else{O=L.element?L.element.toLowerCase():E.element;P=L.attributes}L=F[O]||(F[O]={});if(P){L=L.attributes=L.attributes||[];for(var S in P)L.push([S.toLowerCase(),P[S]])}}}return F}function h(E,F){var H=E._.definition,K=A.mix(A.mix({},H.attributes),e(E)[F._4e_name()]);H=H.styles;var L=A.isEmptyObject(K)&&A.isEmptyObject(H);for(var O in K)if(!((O==
"class"||E._.definition.fullMatch)&&F.attr(O)!=s(O,K[O]))){L=L||!!F._4e_hasAttribute(O);F.removeAttr(O)}for(var P in H)if(!(E._.definition.fullMatch&&F._4e_style(P)!=s(P,H[P],true))){L=L||!!F._4e_style(P);F._4e_style(P,"")}L&&o(F)}function s(E,F,H){var K=new N("<span></span>");K[H?"_4e_style":"attr"](E,F);return K[H?"_4e_style":"attr"](E)}function b(E,F){for(var H=e(E),K=F.all(E.element),L=K.length;--L>=0;)h(E,new N(K[L]));for(var O in H)if(O!=E.element){K=F.all(O);for(L=K.length-1;L>=0;L--){var P=
new N(K[L]);d(P,H[O])}}}function d(E,F){if(F=F&&F.attributes)for(var H=0;H<F.length;H++){var K=F[H][0],L;if(L=E.attr(K)){var O=F[H][1];if(O===null||O.test&&O.test(L)||typeof O=="string"&&L==O)E[0].removeAttribute(K)}}o(E)}function o(E){if(!E._4e_hasAttributes()){var F=E[0].firstChild,H=E[0].lastChild;E._4e_remove(true);if(F){F.nodeType==D.NODE_ELEMENT&&w._4e_mergeSiblings(F);H&&!F===H&&H.nodeType==D.NODE_ELEMENT&&w._4e_mergeSiblings(H)}}}var A=KISSY,w=A.DOM,C=y.STYLE={},I=y.RANGE,x=y.Selection,D=
y.NODE,G=y.POSITION,J=y.Range,N=A.Node,M=A.UA,Q=y.ElementPath,R={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},W={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},$=/\s*(?:;\s*|$)/,aa=/#\((.+?)\)/g;C.STYLE_BLOCK=1;C.STYLE_INLINE=2;C.STYLE_OBJECT=3;B.prototype={apply:function(E){t.call(this,E,false)},remove:function(E){t.call(this,E,true)},applyToRange:function(E){return(this.applyToRange=this.type==C.STYLE_INLINE?k:this.type==C.STYLE_BLOCK?q:this.type==
C.STYLE_OBJECT?null:null).call(this,E)},removeFromRange:function(E){return(this.removeFromRange=this.type==C.STYLE_INLINE?m:null).call(this,E)},applyToObject:function(E){z(E,this)},checkElementRemovable:function(E,F){if(!E)return false;var H=this._.definition;if(E._4e_name()==this.element){if(!F&&!E._4e_hasAttributes())return true;H=j(H);if(H._length){for(var K in H)if(K!="_length"){var L=E.attr(K)||"";if(K=="style"?a(H[K],c(L,false)):H[K]==L){if(!F)return true}else if(F)return false}if(F)return true}else return true}if(H=
e(this)[E._4e_name()]){if(!(H=H.attributes))return true;for(F=0;F<H.length;F++){K=H[F][0];if(K=E.attr(K)){L=H[F][1];if(L===null||typeof L=="string"&&K==L||L.test(K))return true}}}return false},checkActive:function(E){switch(this.type){case C.STYLE_BLOCK:return this.checkElementRemovable(E.block||E.blockLimit,true);case C.STYLE_OBJECT:case C.STYLE_INLINE:for(var F=E.elements,H=0,K;H<F.length;H++){K=F[H];if(!(this.type==C.STYLE_INLINE&&(w._4e_equals(K,E.block)||w._4e_equals(K,E.blockLimit))))if(!(this.type==
C.STYLE_OBJECT&&!(K._4e_name()in W)))if(this.checkElementRemovable(K,true))return true}}return false}};B.getStyleText=function(E){var F=E._ST;if(F)return F;F=E.styles;var H=E.attributes&&E.attributes.style||"",K="";if(H.length)H=H.replace($,";");for(var L in F){var O=F[L],P=(L+":"+O).replace($,";");if(O=="inherit")K+=P;else H+=P}if(H.length)H=c(H);H+=K;return E._ST=H};y.Style=B});
KISSY.Editor.add("button",function(){function y(n){y.superclass.constructor.call(this,n);this._init()}var r=KISSY.Editor,B=KISSY,t=B.Node;y.ON="on";y.OFF="off";y.DISABLED="disabled";y.ON_CLASS="ke-triplebutton-on";y.OFF_CLASS="ke-triplebutton-off";y.DISABLED_CLASS="ke-triplebutton-disabled";y.ATTRS={state:{value:"off"},container:{},text:{},contentCls:{},cls:{}};B.extend(y,B.Base,{_init:function(){var n=this.get("container")[0]||this.get("container");this.el=new t("<a class='ke-triplebutton ke-triplebutton-off' href='#' role=\"button\"></a>");
this.el._4e_unselectable();this._attachCls();if(this.get("text"))this.el.html(this.get("text"));else if(this.get("contentCls")){this.el.html("<span class='ke-toolbar-item "+this.get("contentCls")+"'></span>");this.el.one("span")._4e_unselectable()}this.get("title")&&this.el.attr("title",this.get("title"));n.appendChild(this.el[0]);this.el.on("click",this._action,this);this.on("afterStateChange",this._stateChange,this)},_attachCls:function(){var n=this.get("cls");n&&this.el.addClass(n)},_stateChange:function(n){this["_"+
n.newVal]();this._attachCls()},_action:function(n){this.fire(this.get("state")+"Click",n);this.fire("click",n);n.preventDefault()},_on:function(){this.el[0].className="ke-triplebutton ke-triplebutton-on"},_off:function(){this.el[0].className="ke-triplebutton ke-triplebutton-off"},_disabled:function(){this.el[0].className="ke-triplebutton ke-triplebutton-disabled"}});r.TripleButton=y});
KISSY.Editor.add("contextmenu",function(){function y(u){this.cfg=B.clone(u);r.Utils.lazyRun(this,"_prepareShow","_realShow")}var r=KISSY.Editor,B=KISSY,t=B.Node,n=B.Event,z=[];y.register=function(u,f){var g=new y(f);z.push({doc:u,tags:f.tags,instance:g});if(!u.ke_contextmenu){u.ke_contextmenu=1;n.on(u,"mousedown",y.hide);n.on(u,"contextmenu",function(i){y.hide.call(this);for(var l=new t(i.target);l;){var v=l._4e_name(),k=false;if(v=="body")break;for(var m=0;m<z.length;m++){var p=z[m].tags,a=z[m].instance;
if(u===z[m].doc&&B.inArray(v,p)){i.preventDefault();k=true;a.show(r.Utils.getXY(i.pageX,i.pageY,u,document));break}}if(k)break;l=l.parent()}})}return g};y.hide=function(){for(var u=0;u<z.length;u++){var f=z[u].instance;this===z[u].doc&&f.hide()}};var q=r.SimpleOverlay;B.augment(y,{_init:function(){var u=this,f=u.cfg,g=f.funcs;u.elDom=new t("<div class='ke-contextmenu'></div>");var i=u.elDom;i.css("width",f.width);document.body.appendChild(i[0]);u.el=new q({el:i});for(var l in g){f=new t("<a href='#'>"+
l+"</a>");i[0].appendChild(f[0]);(function(v,k){v.on("click",function(m){k();u.hide();m.halt()})})(f,g[l])}},hide:function(){this.el&&this.el.hide()},_realShow:function(u){this.el.show(u)},_prepareShow:function(){this._init()},show:function(u){this._prepareShow(u)}});r.ContextMenu=y;console.log("contexmenu loaded!")});
KISSY.Editor.add("overlay",function(){function y(){var f=this;y.superclass.constructor.apply(f,arguments);f._init();if(B.UA.ie===6){f.on("show",function(){var g=f.get("el"),i=parseInt(g.css("width"));g=g[0].offsetHeight;u&&u.css({width:i+"px",height:g+"px"});u&&u.offset(f.get("el").offset())});f.on("hide",function(){u&&u.offset({left:-999,top:-999})})}if(f.get("mask")){f.on("show",function(){z&&z.css({left:"0px",top:"0px"});q&&q.css({left:"0px",top:"0px"})});f.on("hide",function(){z&&z.css({left:"-9999px",
top:"-9999px"});q&&q.css({left:"-9999px",top:"-9999px"})})}f.hide()}var r=KISSY.Editor,B=KISSY,t=B.Node,n=B.DOM,z,q,u;y.init=function(){var f=document.body;z=new t('<div class="ke-mask">&nbsp;</div>');z.css({left:"-9999px",top:"-9999px"});z.css({width:"100%",height:n.docHeight()+"px",opacity:0.4});z.appendTo(f);if(B.UA.ie==6){u=new t("<iframe class='ke-dialog-iframe'></iframe>");f.appendChild(u[0]);q=new t("<iframe class='ke-mask'></iframe>");q.css({left:"-9999px",top:"-9999px"});q.css({width:"100%",
height:n.docHeight()+"px",opacity:0.4});q.appendTo(f)}y.init=null};y.ATTRS={title:{value:""},width:{value:"450px"},visible:{value:true},mask:{value:false}};B.extend(y,B.Base,{_init:function(){var f=this,g=f.get("el");f.on("afterVisibleChange",function(i){if(i=i.newVal){typeof i=="boolean"?f.center():g.offset(i);f.fire("show")}else{g.css({left:"-9999px",top:"-9999px"});f.fire("hide")}});if(!g){g=new t("<div class='ke-dialog' style='width:"+f.get("width")+"'><div class='ke-hd clearfix'><div class='ke-hd-title'><h1>"+
f.get("title")+"</h1></div><div class='ke-hd-x'><a class='ke-close' href='#'>X</a></div></div><div class='ke-bd'></div><div class='ke-ft'><a href='#' class='ke-focus'></a></div></div>");document.body.appendChild(g[0]);f.set("el",g);f.el=g;f.body=g.one(".ke-bd");f._close=g.one(".ke-close");f._title=g.one(".ke-hd-title").one("h1");f.on("titleChange",function(i){f._title.html(i.newVal)});f.on("widthChange",function(i){f.el.css("width",i.newVal)});f._close.on("click",function(i){i.preventDefault();f.hide()})}},
center:function(){var f=this.get("el"),g=parseInt(f.css("width")),i=f[0].offsetHeight,l=n.viewportWidth(),v=n.viewportHeight();g=(l-g)/2+n.scrollLeft();i=(v-i)/2+n.scrollTop();f.css({left:g+"px",top:i+"px"})},_prepareShow:function(){y.init()},_realShow:function(f){this.get("el");this.set("visible",f||true)},show:function(f){this._prepareShow(f)},hide:function(){this.get("el");this.set("visible",false)}});r.Utils.lazyRun(y.prototype,"_prepareShow","_realShow");r.SimpleOverlay=y});
KISSY.Editor.add("clipboard",function(y){var r=KISSY.Editor,B=KISSY,t=B.Node,n=B.UA,z=r.Range,q=r.RANGE,u=B.Event;r.Paste||function(){function f(g){this.editor=g;this._init()}B.augment(f,{_init:function(){var g=this.editor;n.ie?u.on(g.document,"keydown",this._paste,this):u.on(g.document,"paste",this._paste,this)},_paste:function(g){if(!(g.type==="keydown"&&!(g.keyCode===86&&(g.ctrlKey||g.metaKey)))){var i=this.editor;g=i.document;var l=i.getSelection(),v=new z(g),k=new t(n.webkit?"<body></body>":
"<div></div>",null,g);n.webkit&&k[0].appendChild(g.createTextNode("\u00a0"));g.body.appendChild(k[0]);k.css({position:"absolute",top:l.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});k.css("left","-1000px");var m=l.createBookmarks();v.setStartAt(k,q.POSITION_AFTER_START);v.setEndAt(k,q.POSITION_BEFORE_END);v.select(true);setTimeout(function(){k.remove();var p;k=n.webkit&&(p=k._4e_first())&&p[0]&&p.hasClass("Apple-style-span")?p:k;l.selectBookmarks(m);i.insertHtml(k.html())},
0)}}});r.Paste=f}();y.addPlugin(function(){new r.Paste(y)})});
KISSY.Editor.add("color",function(y){function r(h){return("0"+h).slice(h.length-1,h.length+1)}function B(h){h=n.trim(h);if(h.charAt(0)=="#")h=h.substring(1);h=h.replace(/\s+/g,"");var s="";if(/^[0-9a-f]{3,3}$/i.test(h))s=h.replace(/[0-9a-f]/ig,function(d){return d+d});else{var b=h.match(i);if(b&&b[0])for(h=1;h<4;h++)s+=r(parseInt(b[h]).toString(16));else s=h}return"#"+s.toLowerCase()}for(var t=KISSY.Editor,n=KISSY,z=n.Node,q=n.Event,u=t.SimpleOverlay,f=t.Style,g=n.DOM,i=/^rgb\((\d+),(\d+),(\d+)\)$/i,
l="000,800000,8B4513,2F4F4F,008080,000080,4B0082,696969,B22222,A52A2A,DAA520,006400,40E0D0,0000CD,800080,808080,F00,FF8C00,FFD700,008000,0FF,00F,EE82EE,A9A9A9,FFA07A,FFA500,FFFF00,00FF00,AFEEEE,ADD8E6,DDA0DD,D3D3D3,FFF0F5,FAEBD7,FFFFE0,F0FFF0,F0FFFF,F0F8FF,E6E6FA,FFF".split(/,/),v={element:"span",styles:{color:"#(color)"},overrides:[{element:"font",attributes:{color:null}}]},k={element:"span",styles:{"background-color":"#(color)"}},m="<div class='ke-popup-wrap ke-color-wrap'><a class='ke-color-remove' href=\"javascript:void('\u6e05\u9664');\"><span>\u6e05\u9664</span></a><table>",
p={},a={},c=0;c<5;c++){m+="<tr>";for(var j=0;j<8;j++){var e=B(l[8*c+j]);m+="<td>";m+="<a href='javascript:void(0);' class='ke-color-a'><span style='background-color:"+e+"'></span></a>";m+="</td>";p[e]=new f(k,{color:e});a[e]=new f(v,{color:e})}m+="</tr>"}p.inherit=new f(k,{color:"inherit"});a.inherit=new f(v,{color:"inherit"});m+="</table></div>";t.ColorSupport||function(){function h(b){h.superclass.constructor.call(this,b);this._init()}var s=t.TripleButton;h.ATTRS={editor:{},styles:{},contentCls:{},
text:{}};n.extend(h,n.Base,{_init:function(){var b=this.get("editor").toolBarDiv;b=new s({container:b,title:this.get("title"),contentCls:this.get("contentCls")});b.on("offClick",this._showColors,this);this.el=b;t.Utils.lazyRun(this,"_prepare","_real")},_hidePanel:function(b){var d=this;g._4e_ascendant(b.target,function(o){return o[0]===d.el.el[0]},true)||this.colorWin.hide()},_selectColor:function(b){b.halt();var d=this.get("editor");b=b.target;if(g._4e_name(b)=="span"||g._4e_name(b)=="a"){b=new z(b);
if(b._4e_name()=="a")b=b.one("span");var o=this.get("styles");d.fire("save");b._4e_style("background-color")?o[B(b._4e_style("background-color"))].apply(d.document):o.inherit.remove(d.document);d.fire("save");d.focus();this.colorWin.hide()}},_prepare:function(){this.colorPanel=new z(m);this.colorWin=new u({el:this.colorPanel,mask:false});document.body.appendChild(this.colorPanel[0]);this.colorPanel.on("click",this._selectColor,this);q.on(document,"click",this._hidePanel,this);q.on(y.document,"click",
this._hidePanel,this)},_real:function(){var b=this.el.el.offset();b.top+=this.el.el.height()+5;if(b.left+this.colorPanel.width()>g.viewportWidth()-60)b.left=g.viewportWidth()-this.colorPanel.width()-60;this.colorWin.show(b)},_showColors:function(b){this._prepare(b)}});t.ColorSupport=h}();y.addPlugin(function(){new t.ColorSupport({editor:y,styles:p,title:"\u80cc\u666f\u989c\u8272",contentCls:"ke-toolbar-bgcolor",text:"bgcolor"});new t.ColorSupport({editor:y,styles:a,title:"\u6587\u672c\u989c\u8272",
contentCls:"ke-toolbar-color",text:"color"})})});
KISSY.Editor.add("elementpaths",function(y){var r=KISSY.Editor,B=KISSY,t=B.Node,n=B.DOM;r.ElementPaths||function(){function z(q){this.cfg=q;this._cache=[];this._init()}B.augment(z,{_init:function(){var q=this.cfg.editor;this.holder=new t("<div>");this.holder.appendTo(q.statusDiv);q.on("selectionChange",this._selectionChange,this)},_selectionChange:function(q){var u=this.cfg.editor,f=this.holder;f=f[0]||f;q=q.path.elements;var g,i;g=this._cache;for(i=0;i<g.length;i++){g[i].detach("click");g[i].remove()}this._cache=
[];for(i=0;i<q.length;i++){g=q[i];var l=new t("<a href='#' class='elementpath'>"+(g.attr("_ke_real_element_type")||g._4e_name())+"</a>");this._cache.push(l);(function(v){l.on("click",function(k){k.halt();u.focus();setTimeout(function(){u.getSelection().selectElement(v)},50)})})(g);f.firstChild?n.insertBefore(l[0],f.firstChild):f.appendChild(l[0])}}});r.ElementPaths=z}();y.addPlugin(function(){new r.ElementPaths({editor:y})})});
KISSY.Editor.add("enterkey",function(y){var r=KISSY.Editor,B=KISSY,t=B.UA,n=/^h[1-6]$/,z=r.XHTML_DTD,q=B.Node,u=B.Event,f=r.Walker,g=r.ElementPath;r.enterBlock||function(){function i(k){k=k.getSelection().getRanges();for(var m=k.length-1;m>0;m--)k[m].deleteContents();return k[0]}function l(k){var m=i(k),p=m.document;if(m.checkStartOfBlock()&&m.checkEndOfBlock()){var a=(new g(m.startContainer)).block;if(a&&(a._4e_name()=="li"||a.parent()._4e_name()=="li")){k.execCommand("outdent");return}}var c=m.splitBlock("p");
if(c){k=c.previousBlock;a=c.nextBlock;var j=c.wasStartOfBlock,e=c.wasEndOfBlock,h;if(a){h=a.parent();if(h._4e_name()=="li"){a._4e_breakParent(h);a._4e_move(a._4e_next(),true)}}else if(k&&(h=k.parent())&&h._4e_name()=="li"){k._4e_breakParent(h);m.moveToElementEditablePosition(k._4e_next());k._4e_move(k._4e_previous())}if(!j&&!e){if(a._4e_name()=="li"&&(h=a._4e_first(f.invisible(true)))&&B.inArray(h._4e_name(),["ul","ol"]))(t.ie?new q(p.createTextNode("\u00a0")):new q(p.createElement("br"))).insertBefore(h);
a&&m.moveToElementEditablePosition(a)}else{var s;if(k){if(k._4e_name()=="li"||!n.test(k._4e_name()))s=k._4e_clone()}else if(a)s=a._4e_clone();s||(s=new q("p",null,p));if(h=c.elementPath){c=0;for(var b=h.elements.length;c<b;c++){var d=h.elements[c];if(d._4e_equals(h.block)||d._4e_equals(h.blockLimit))break;if(z.$removeEmpty[d.getName()]){d=d._4e_clone();s._4e_moveChildren(d);s.append(d)}}}t.ie||s._4e_appendBogus();m.insertNode(s);if(t.ie&&j&&(!e||!k[0].childNodes.length)){m.moveToElementEditablePosition(e?
k:s);m.select()}m.moveToElementEditablePosition(j&&!e?a:s)}if(!t.ie)if(a){p=new q(p.createElement("span"));p.html("&nbsp;");m.insertNode(p);p._4e_scrollIntoView();m.deleteContents()}else s._4e_scrollIntoView();m.select()}}function v(k){u.on(k.document,"keydown",function(m){if(m.keyCode===13)if(!m.shiftKey){k.execCommand("enterBlock");m.preventDefault()}})}v.enterBlock=l;r.EnterKey=v}();y.addPlugin(function(){y.addCommand("enterBlock",{exec:r.EnterKey.enterBlock});r.EnterKey(y)})});
KISSY.Editor.add("fakeobjects",function(){var y=KISSY.Editor,r=KISSY,B=r.Node,t=y.NODE,n=y.HtmlParser,z=r.Editor,q=y.HtmlDataProcessor,u=q&&q.htmlFilter;y.FakeObjects||function(){var f={elements:{$:function(g){var i=g.attributes;if((i=(i=(i=i&&i._ke_realelement)&&new n.Fragment.FromHtml(decodeURIComponent(i)))&&i.children[0])&&g.attributes._ke_resizable){var l=g.attributes.style;if(l){var v=/(?:^|\s)width\s*:\s*(\d+)/i.exec(l);g=v&&v[1];l=(v=/(?:^|\s)height\s*:\s*(\d+)/i.exec(l))&&v[1];if(g)i.attributes.width=
g;if(l)i.attributes.height=l}}return i}}};u&&u.addRules(f);q&&r.mix(q,{createFakeParserElement:function(g,i,l,v){var k;k=new n.BasicWriter;g.writeHtml(k);k=k.getHtml();var m=g.attributes.style;if(g.attributes.width)m="width:"+g.attributes.width+"px;"+m;if(g.attributes.height)m="height:"+g.attributes.height+"px;"+m;g={"class":i,src:y.Config.base+"assets/spacer.gif",_ke_realelement:encodeURIComponent(k),_ke_real_node_type:g.type,style:m,align:g.attributes.align||""};if(l)g._ke_real_element_type=l;if(v)g._ke_resizable=
v;return new n.Element("img",g)}});y.FakeObjects=1}();r.augment(z,{createFakeElement:function(f,g,i,l){var v=f.attr("style")||"";if(f.attr("width"))v="width:"+f.attr("width")+"px;"+v;if(f.attr("height"))v="height:"+f.attr("height")+"px;"+v;f={"class":g,src:y.Config.base+"assets/spacer.gif",_ke_realelement:encodeURIComponent(f._4e_outerHtml()),_ke_real_node_type:f[0].nodeType,align:f.attr("align")||"",style:v};if(i)f._ke_real_element_type=i;if(l)f._ke_resizable=l;return new B("<img/>",f,this.document)},
restoreRealElement:function(f){if(f.attr("_ke_real_node_type")!=t.NODE_ELEMENT)return null;return new B(decodeURIComponent(f.attr("_ke_realelement")),this.document)}})});
KISSY.Editor.add("flash",function(y){var r=KISSY.Editor,B=KISSY,t=B.Node,n=r.TripleButton,z=r.SimpleOverlay,q=/\.swf(?:$|\?)/i,u=r.HtmlDataProcessor,f="niftyplayer.swf",g=u&&u.dataFilter;r.Flash||function(){function i(k){k=k.attributes;return k.type=="application/x-shockwave-flash"||q.test(k.src||"")}function l(k){return k.indexOf(f)!=-1}function v(k){this.editor=k;this._init()}g&&g.addRules({elements:{object:function(k){var m=k.attributes,p="ke_flash",a="flash";if(!(m.classid&&String(m.classid).toLowerCase())){for(m=
0;m<k.children.length;m++)if(k.children[m].name=="embed"){if(!i(k.children[m]))return null;if(l(k.children[m].attributes.src)){p="ke_music";a="music"}return u.createFakeParserElement(k,p,a,true)}return null}for(m=0;m<k.children.length;m++){var c=k.children[m];if(c.name=="param"&&c.attributes.name=="movie")if(l(c.attributes.value)){p="ke_music";a="music";break}}return u.createFakeParserElement(k,p,a,true)},embed:function(k){if(!i(k))return null;var m="ke_flash",p="flash";if(l(k.attributes.src)){m=
"ke_music";p="music"}return u.createFakeParserElement(k,m,p,true)}}},5);B.augment(v,{_init:function(){this.el=new n({container:this.editor.toolBarDiv,contentCls:"ke-toolbar-flash",title:"Flash"});this.el.on("click",this._showConfig,this);r.Utils.lazyRun(this,"_prepareShow","_realShow")},_prepareShow:function(){this.d=new z({title:"\u7f16\u8f91flash",width:"350px",mask:true});this.d.body.html("<div style='margin:10px;'><p><label>\u5730\u5740\uff1a<input class='ke-flash-url' style='width:280px' /></label></p><p style='margin:5px 0'><label>\u5bbd\u5ea6\uff1a<input class='ke-flash-width' style='width:120px' /></label>&nbsp;&nbsp;<label>\u9ad8\u5ea6\uff1a<input class='ke-flash-height' style='width:110px' /></label></p><p style='margin:5px 0;text-align:right;'><button>\u786e\u5b9a</button></p></div>");
this._initD()},_realShow:function(){this.d.show()},_showConfig:function(){this._prepareShow()},_initD:function(){var k=this.d;this.dHeight=k.el.one(".ke-flash-height");this.dWidth=k.el.one(".ke-flash-width");this.dUrl=k.el.one(".ke-flash-url");k.el.one("button").on("click",this._gen,this)},_gen:function(){var k=this.editor,m=this.dUrl.val();if(m){m=new t("<object "+(parseInt(this.dWidth.val())?" width='"+parseInt(this.dWidth.val())+"' ":" ")+(parseInt(this.dHeight.val())?" height='"+parseInt(this.dHeight.val())+
"' ":" ")+'classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0"><param name="quality" value="high" /><param name="movie" value="'+m+'" /><embed '+(parseInt(this.dWidth.val())?" width='"+parseInt(this.dWidth.val())+"' ":" ")+(parseInt(this.dHeight.val())?" height='"+parseInt(this.dHeight.val())+"' ":" ")+'pluginspage="http://www.macromedia.com/go/getflashplayer" quality="high" src="'+m+'" type="application/x-shockwave-flash"></embed></object>',
null,k.document);m=k.createFakeElement?k.createFakeElement(m,"ke_flash","flash",true):m;k.insertElement(m);this.d.hide()}}});r.Flash=v}();y.addPlugin(function(){new r.Flash(y)})});
KISSY.Editor.add("font",function(y){var r=KISSY.Editor,B=KISSY,t=r.Style,n=r.TripleButton,z=B.Node,q=["8px","10px","12px","14px","18px","24px","36px","48px","60px","72px","84px","96px","108px"],u={},f="<select title='\u5927\u5c0f'><option value=''>\u5927\u5c0f / \u6e05\u9664</option>",g={element:"span",styles:{"font-size":"#(size)"},overrides:[{element:"font",attributes:{size:null}}]},i=["\u5b8b\u4f53","\u9ed1\u4f53","\u96b6\u4e66","\u6977\u4f53_GB2312","\u5fae\u8f6f\u96c5\u9ed1","Georgia","Times New Roman",
"Impact","Courier New","Arial","Verdana","Tahoma"],l={},v="<select title='\u5b57\u4f53'><option value=''>\u5b57\u4f53 / \u6e05\u9664</option>",k={element:"span",styles:{"font-family":"#(family)"},overrides:[{element:"font",attributes:{face:null}}]},m;for(m=0;m<q.length;m++){var p=q[m];u[p]=new t(g,{size:p});f+="<option value='"+p+"'>"+p+"</option>"}f+="</select>";for(m=0;m<i.length;m++){q=i[m];l[q]=new t(k,{family:q});v+="<option value='"+q+"'>"+q+"</option>"}v+="</select>";r.Font||function(){function a(j){a.superclass.constructor.call(this,
j);this._init()}function c(j){c.superclass.constructor.call(this,j);this._init()}a.ATTRS={v:{value:""},html:{},styles:{},editor:{}};B.extend(a,B.Base,{_init:function(){var j=this.get("editor"),e=j.toolBarDiv,h=this.get("html");this.el=new z(h);e[0].appendChild(this.el[0]);this.el.on("change",this._change,this);j.on("selectionChange",this._selectionChange,this);this.on("afterVChange",this._vChange,this)},_vChange:function(j){var e=this.get("editor"),h=j.newVal;j=j.preVal;var s=this.get("styles");e.focus();
e.fire("save");if(h)s[h].apply(e.document);else{h=j;s[h].remove(e.document)}e.fire("save")},_change:function(){this.set("v",this.el.val())},_selectionChange:function(j){this.get("editor");var e=this.get("v");j=j.path.elements;for(var h=this.get("styles"),s=0,b;s<j.length;s++){b=j[s];for(var d in h)if(h[d].checkElementRemovable(b,true)){if(d!=e){this._set("v",d);this.el.val(d)}return}}if(e!=""){this._set("v","");this.el.val("")}}});c.ATTRS={editor:{},text:{},contentCls:{},title:{},style:{}};B.extend(c,
B.Base,{_init:function(){var j=this.get("editor"),e=this.get("text");this.get("style");var h=this.get("title");this.el=new n({text:e,title:h,contentCls:this.get("contentCls"),container:j.toolBarDiv});this.el.on("offClick",this._on,this);this.el.on("onClick",this._off,this);j.on("selectionChange",this._selectionChange,this)},_on:function(){var j=this.get("editor");this.get("text");var e=this.get("style");this.get("title");e.apply(j.document);j.notifySelectionChange();j.focus()},_off:function(){var j=
this.get("editor");this.get("text");var e=this.get("style");this.get("title");e.remove(j.document);j.notifySelectionChange();j.focus()},_selectionChange:function(j){this.get("editor");this.get("text");var e=this.get("style");this.get("title");e.checkActive(j.path)?this.el.set("state",n.ON):this.el.set("state",n.OFF)}});a.SingleFont=c;r.Font=a}();y.addPlugin(function(){new r.Font({editor:y,styles:u,html:f});new r.Font({editor:y,styles:l,html:v});new r.Font.SingleFont({contentCls:"ke-toolbar-bold",
title:"\u7c97\u4f53",editor:y,style:new t({element:"strong"})});new r.Font.SingleFont({contentCls:"ke-toolbar-italic",title:"\u659c\u4f53",editor:y,style:new t({element:"em"})});new r.Font.SingleFont({contentCls:"ke-toolbar-underline",title:"\u4e0b\u5212\u7ebf",editor:y,style:new t({element:"u"})});new r.Font.SingleFont({contentCls:"ke-toolbar-strikeThrough",title:"\u5220\u9664\u7ebf",editor:y,style:new t({element:"del"})})})});
KISSY.Editor.add("format",function(y){var r=KISSY.Editor,B=KISSY,t=B.Node;r.Format||function(){function n(i){n.superclass.constructor.call(this,i);this.el=new t(z);this._init()}var z="<select title='\u683c\u5f0f'>",q={"\u6807\u9898 / \u6e05\u9664":"p","\u6807\u98981":"h1","\u6807\u98982":"h2","\u6807\u98983":"h3","\u6807\u98984":"h4","\u6807\u98985":"h5","\u6807\u98986":"h6"},u={},f=r.Style;for(var g in q)if(q[g]){u[q[g]]=new f({element:q[g]});z+="<option value='"+q[g]+"'>"+g+"</option>"}z+="</select>";
n.ATTRS={v:{value:"p"},editor:{}};B.extend(n,B.Base,{_init:function(){var i=this.get("editor"),l=this.el;i.toolBarDiv[0].appendChild(this.el[0]);l.on("change",this._change,this);i.on("selectionChange",this._selectionChange,this);this.on("afterVChange",this._vChange,this)},_vChange:function(i){var l=this.get("editor");i=i.newVal;l.focus();l.fire("save");u[i].apply(l.document);l.fire("save");l.fire("formatChange",this.get("v"))},_change:function(){this.set("v",this.el.val())},_selectionChange:function(i){this.get("editor");
var l=this.get("v");i=i.path;for(var v in u)if(u[v].checkActive(i)){if(v!=l){this._set("v",v);this.el.val(v)}return}this._set("v","p");this.el.val("p")}});r.Format=n}();y.addPlugin(function(){new r.Format({editor:y})})});
KISSY.Editor.add("htmlparser-basicwriter",function(){function y(){this._={output:[]}}var r=KISSY.Editor,B=r.Utils;if(!r.HtmlParser.BasicWriter){KISSY.augment(y,{openTag:function(t){this._.output.push("<",t)},openTagClose:function(t,n){n?this._.output.push(" />"):this._.output.push(">")},attribute:function(t,n){if(typeof n=="string")n=B.htmlEncodeAttr(n);this._.output.push(" ",t,'="',n,'"')},closeTag:function(t){this._.output.push("</",t,">")},text:function(t){this._.output.push(t)},comment:function(t){this._.output.push("<!--",
t,"--\>")},write:function(t){this._.output.push(t)},reset:function(){this._.output=[];this._.indent=false},getHtml:function(t){var n=this._.output.join("");t&&this.reset();return n}});r.HtmlParser.BasicWriter=y}});
KISSY.Editor.add("htmlparser-element",function(){function y(n,z){this.name=n;this.attributes=z||(z={});this.children=[];var q=z._ke_real_element_type||n;z=r.XHTML_DTD;q=!!(z.$nonBodyContent[q]||z.$block[q]||z.$listItem[q]||z.$tableContent[q]||z.$nonEditable[q]||q=="br");var u=!!z.$empty[n];this.isEmpty=u;this.isUnknown=!z[n];this._={isBlockLike:q,hasInlineStarted:u||!q}}var r=KISSY.Editor;if(!r.HtmlParser.Element){var B=r.NODE,t=function(n,z){n=n[0];z=z[0];return n<z?-1:n>z?1:0};KISSY.augment(y,{type:B.NODE_ELEMENT,
add:r.HtmlParser.Fragment.prototype.add,clone:function(){return new y(this.name,this.attributes)},writeHtml:function(n,z){var q=this.attributes,u=this,f=u.name,g,i,l,v;u.filterChildren=function(){if(!v){var p=new r.HtmlParser.BasicWriter;r.HtmlParser.Fragment.prototype.writeChildrenHtml.call(u,p,z);u.children=(new r.HtmlParser.Fragment.fromHtml(p.getHtml())).children;v=1}};if(z){for(;;){if(!(f=z.onElementName(f)))return;u.name=f;if(!(u=z.onElement(u)))return;u.parent=this.parent;if(u.name==f)break;
if(u.type!=B.NODE_ELEMENT){u.writeHtml(n,z);return}f=u.name;if(!f){this.writeChildrenHtml.call(u,n,v?null:z);return}}q=u.attributes}n.openTag(f,q);for(var k=[],m=0;m<2;m++)for(g in q){i=g;l=q[g];if(m==1)k.push([g,l]);else if(z){for(;;)if(i=z.onAttributeName(g))if(i!=g){delete q[g];g=i}else break;else{delete q[g];break}if(i)if((l=z.onAttribute(u,i,l))===false)delete q[i];else q[i]=l}}n.sortAttributes&&k.sort(t);q=k.length;for(m=0;m<q;m++){g=k[m];n.attribute(g[0],g[1])}n.openTagClose(f,u.isEmpty);if(!u.isEmpty){this.writeChildrenHtml.call(u,
n,v?null:z);n.closeTag(f)}},writeChildrenHtml:function(){r.HtmlParser.Fragment.prototype.writeChildrenHtml.apply(this,arguments)}});r.HtmlParser.Element=y}});
KISSY.Editor.add("htmlparser-filter",function(){function y(f){this._={elementNames:[],attributeNames:[],elements:{$length:0},attributes:{$length:0}};f&&this.addRules(f,10)}function r(f,g){for(var i=0;f&&i<g.length;i++){var l=g[i];f=f.replace(l[0],l[1])}return f}function B(f,g,i){if(typeof g=="function")g=[g];var l,v;v=f.length;var k=g&&g.length;if(k){for(l=0;l<v&&f[l].pri<i;l++);for(v=k-1;v>=0;v--)if(k=g[v]){k.pri=i;f.splice(l,0,k)}}}function t(f,g,i){if(g)for(var l in g){var v=f[l];f[l]=n(v,g[l],
i);v||f.$length++}}function n(f,g,i){if(g){g.pri=i;if(f){if(f.splice)B(f,g,i);else{f=f.pri>i?[g,f]:[f,g];f.filter=z}return f}else return g.filter=g}}function z(f){for(var g=f.type||f instanceof q.HtmlParser.Fragment,i=0;i<this.length;i++){if(g)var l=f.type,v=f.name;var k=this[i].apply(window,arguments);if(k===false)return k;if(g){if(k&&(k.name!=v||k.type!=l))return k}else if(typeof k!="string")return k;k!=undefined&&(f=k)}return f}var q=KISSY.Editor,u=q.NODE;if(!q.HtmlParser.Filter){KISSY.augment(y,
{addRules:function(f,g){if(typeof g!="number")g=10;B(this._.elementNames,f.elementNames,g);B(this._.attributeNames,f.attributeNames,g);t(this._.elements,f.elements,g);t(this._.attributes,f.attributes,g);this._.text=n(this._.text,f.text,g)||this._.text;this._.comment=n(this._.comment,f.comment,g)||this._.comment;this._.root=n(this._.root,f.root,g)||this._.root},onElementName:function(f){return r(f,this._.elementNames)},onAttributeName:function(f){return r(f,this._.attributeNames)},onText:function(f){var g=
this._.text;return g?g.filter(f):f},onComment:function(f,g){var i=this._.comment;return i?i.filter(f,g):f},onFragment:function(f){var g=this._.root;return g?g.filter(f):f},onElement:function(f){for(var g=[this._.elements["^"],this._.elements[f.name],this._.elements.$],i,l=0;l<3;l++)if(i=g[l]){i=i.filter(f,this);if(i===false)return null;if(i&&i!=f)return this.onNode(i);if(f.parent&&!f.name)break}return f},onNode:function(f){var g=f.type;return g==u.NODE_ELEMENT?this.onElement(f):g==u.NODE_TEXT?new q.HtmlParser.Text(this.onText(f.value)):
null},onAttribute:function(f,g,i){if(g=this._.attributes[g]){f=g.filter(i,f,this);if(f===false)return false;if(typeof f!="undefined")return f}return i}});q.HtmlParser.Filter=y}});
KISSY.Editor.add("htmlparser-fragment",function(){function y(){this.children=[];this.parent=null;this._={isBlockLike:true,hasInlineStarted:false}}var r=KISSY.Editor;if(!r.HtmlParser.Fragment){var B={colgroup:1,dd:1,dt:1,li:1,option:1,p:1,td:1,tfoot:1,th:1,thead:1,tr:1},t=KISSY,n=r.Utils,z=r.NODE,q=r.XHTML_DTD,u=n.mix({table:1,ul:1,ol:1,dl:1},q.table,q.ul,q.ol,q.dl),f=q.$list,g=q.$listItem;y.FromHtml=function(i,l){function v(d){var o;if(c.length>0)for(var A=0;A<c.length;A++){var w=c[A],C=w.name,I=
q[C],x=e.name&&q[e.name];if((!x||x[C])&&(!d||!I||I[d]||!q[d])){if(!o){k();o=1}w=w.clone();w.parent=e;e=w;c.splice(A,1);A--}}}function k(){for(;j.length;)e.add(j.shift())}function m(d,o,A){o=o||e||a;if(l&&!o.type){var w,C;if((w=d.attributes&&(C=d.attributes._ke_real_element_type)?C:d.name)&&!(w in q.$body)&&!(w in q.$nonBodyContent)){w=e;e=o;p.onTagOpen(l,{});o=e;if(A)e=w}}if(d._.isBlockLike&&d.name!="pre"){A=d.children.length;if((w=d.children[A-1])&&w.type==z.NODE_TEXT)if(C=n.rtrim(w.value))w.value=
C;else d.children.length=A-1}o.add(d);if(d.returnPoint){e=d.returnPoint;delete d.returnPoint}}var p=new r.HtmlParser,a=new y,c=[],j=[],e=a,h=false,s;p.onTagOpen=function(d,o,A){var w=new r.HtmlParser.Element(d,o);if(w.isUnknown&&A)w.isEmpty=true;if(q.$removeEmpty[d])c.push(w);else{if(d=="pre")h=true;else if(d=="br"&&h){e.add(new r.HtmlParser.Text("\n"));return}if(d=="br")j.push(w);else{var C=e.name,I=C&&(q[C]||(e._.isBlockLike?q.div:q.span));if(I&&!w.isUnknown&&!e.isUnknown&&!I[d]){I=false;var x;
if(d in f&&C in f){C=e.children;(C=C[C.length-1])&&C.name in g||m(C=new r.HtmlParser.Element("li"),e);s=e;x=C}else if(d==C)m(e,e.parent);else{if(u[C])s||(s=e);else{m(e,e.parent,true);B[C]||c.unshift(e)}I=true}e=x?x:e.returnPoint||e.parent;if(I){p.onTagOpen.apply(this,arguments);return}}v(d);k();w.parent=e;w.returnPoint=s;s=0;if(w.isEmpty)m(w);else e=w}}};p.onTagClose=function(d){for(var o=c.length-1;o>=0;o--)if(d==c[o].name){c.splice(o,1);return}for(var A=[],w=[],C=e;C.type&&C.name!=d;){C._.isBlockLike||
w.unshift(C);A.push(C);C=C.parent}if(C.type){for(o=0;o<A.length;o++){var I=A[o];m(I,I.parent)}e=C;if(e.name=="pre")h=false;C._.isBlockLike&&k();m(C,C.parent);if(C==e)e=e.parent;c=c.concat(w)}if(d=="body")l=false};p.onText=function(d){if(!e._.hasInlineStarted&&!h){d=n.ltrim(d);if(d.length===0)return}k();v();if(l&&(!e.type||e.name=="body")&&n.trim(d))this.onTagOpen(l,{});h||(d=d.replace(/[\t\r\n ]{2,}|[\t\r\n]/g," "));e.add(new r.HtmlParser.Text(d))};p.onCDATA=function(){};p.onComment=function(){};
p.parse(i);for(k();e.type;){i=e.parent;var b=e;if(l&&(!i.type||i.name=="body")&&!q.$body[b.name]){e=i;p.onTagOpen(l,{});i=e}i.add(b);e=i}return a};t.augment(y,{add:function(i){var l=this.children.length;if(l=l>0&&this.children[l-1]||null){if(i._.isBlockLike&&l.type==z.NODE_TEXT){l.value=n.rtrim(l.value);if(l.value.length===0){this.children.pop();this.add(i);return}}l.next=i}i.previous=l;i.parent=this;this.children.push(i);this._.hasInlineStarted=i.type==z.NODE_TEXT||i.type==z.NODE_ELEMENT&&!i._.isBlockLike},
writeHtml:function(i,l){var v;this.filterChildren=function(){var k=new r.HtmlParser.BasicWriter;this.writeChildrenHtml.call(this,k,l,true);k=k.getHtml();this.children=(new y.FromHtml(k)).children;v=1};!this.name&&l&&l.onFragment(this);this.writeChildrenHtml(i,v?null:l)},writeChildrenHtml:function(i,l){for(var v=0;v<this.children.length;v++)this.children[v].writeHtml(i,l)}});r.HtmlParser.Fragment=y}});
KISSY.Editor.add("htmlparser",function(){function y(){this._={htmlPartsRegex:new RegExp("<(?:(?:\\/([^>]+)>)|(?:!--([\\S|\\s]*?)--\>)|(?:([^\\s>]+)\\s*((?:(?:[^\"'>]+)|(?:\"[^\"]*\")|(?:'[^']*'))*)\\/?>))","g")}}var r=KISSY.Editor;if(!r.HtmlParser){var B=/([\w\-:.]+)(?:(?:\s*=\s*(?:(?:"([^"]*)")|(?:'([^']*)')|([^\s>]+)))|(?=\s|$))/g,t={checked:1,compact:1,declare:1,defer:1,disabled:1,ismap:1,multiple:1,nohref:1,noresize:1,noshade:1,nowrap:1,readonly:1,selected:1},n=r.XHTML_DTD;KISSY.augment(y,{onTagOpen:function(){},
onTagClose:function(){},onText:function(){},onCDATA:function(){},onComment:function(){},parse:function(z){for(var q,u,f=0,g;q=this._.htmlPartsRegex.exec(z);){u=q.index;if(u>f){f=z.substring(f,u);g?g.push(f):this.onText(f)}f=this._.htmlPartsRegex.lastIndex;if(u=q[1]){u=u.toLowerCase();if(g&&n.$cdata[u]){this.onCDATA(g.join(""));g=null}if(!g){this.onTagClose(u);continue}}if(g)g.push(q[0]);else if(u=q[3]){u=u.toLowerCase();var i={},l;q=q[4];var v=!!(q&&q.charAt(q.length-1)=="/");if(q)for(;l=B.exec(q);){var k=
l[1].toLowerCase();l=l[2]||l[3]||l[4]||"";i[k]=!l&&t[k]?k:l}this.onTagOpen(u,i,v);if(!g&&n.$cdata[u])g=[]}else if(u=q[2])this.onComment(u)}z.length>f&&this.onText(z.substring(f,z.length))}});r.HtmlParser=y}});
KISSY.Editor.add("htmlparser-htmlwriter",function(){function y(){y.superclass.constructor.call(this);this.indentationChars="\t";this.selfClosingEnd=" />";this.lineBreakChars="\n";this.forceSimpleAmpersand=false;this.sortAttributes=true;this._.indent=false;this._.indentation="";this._.rules={};var t=r.XHTML_DTD;for(var n in B.mix({},t.$nonBodyContent,t.$block,t.$listItem,t.$tableContent))this.setRules(n,{indent:true,breakBeforeOpen:true,breakAfterOpen:true,breakBeforeClose:!t[n]["#"],breakAfterClose:true});
this.setRules("br",{breakAfterOpen:true});this.setRules("title",{indent:false,breakAfterOpen:false});this.setRules("style",{indent:false,breakBeforeClose:true});this.setRules("pre",{indent:false})}var r=KISSY.Editor,B=r.Utils;if(!r.HtmlParser.HtmlWriter){KISSY.extend(y,r.HtmlParser.BasicWriter,{openTag:function(t){var n=this._.rules[t];if(this._.indent)this.indentation();else if(n&&n.breakBeforeOpen){this.lineBreak();this.indentation()}this._.output.push("<",t)},openTagClose:function(t,n){t=this._.rules[t];
if(n)this._.output.push(this.selfClosingEnd);else{this._.output.push(">");if(t&&t.indent)this._.indentation+=this.indentationChars}t&&t.breakAfterOpen&&this.lineBreak()},attribute:function(t,n){if(typeof n=="string"){this.forceSimpleAmpersand&&(n=n.replace(/&amp;/g,"&"));n=B.htmlEncodeAttr(n)}this._.output.push(" ",t,'="',n,'"')},closeTag:function(t){var n=this._.rules[t];if(n&&n.indent)this._.indentation=this._.indentation.substr(this.indentationChars.length);if(this._.indent)this.indentation();
else if(n&&n.breakBeforeClose){this.lineBreak();this.indentation()}this._.output.push("</",t,">");n&&n.breakAfterClose&&this.lineBreak()},text:function(t){if(this._.indent){this.indentation();t=B.ltrim(t)}this._.output.push(t)},comment:function(t){this._.indent&&this.indentation();this._.output.push("<!--",t,"--\>")},lineBreak:function(){this._.output.length>0&&this._.output.push(this.lineBreakChars);this._.indent=true},indentation:function(){this._.output.push(this._.indentation);this._.indent=false},
setRules:function(t,n){var z=this._.rules[t];if(z)B.mix(z,n);else this._.rules[t]=n}});r.HtmlParser.HtmlWriter=y}});KISSY.Editor.add("htmlparser-text",function(){function y(B){this.value=B;this._={isBlockLike:false}}var r=KISSY.Editor;if(!r.HtmlParser.Text){KISSY.augment(y,{type:r.NODE.NODE_TEXT,writeHtml:function(B,t){var n=this.value;t&&!(n=t.onText(n,this))||B.text(n)}});r.HtmlParser.Text=y}});
KISSY.Editor.add("htmldataprocessor",function(){var y=KISSY.Editor;if(!y.HtmlDataProcessor){var r=KISSY.UA,B=y.HtmlParser,t=new B.Filter,n=new B.Filter,z={elementNames:[[/^script$/,""],[/^iframe$/,""],[/^style$/,""],[/^link$/,""],[/^meta$/,""],[/^\?xml:namespace$/,""]],elements:{embed:function(q){var u=q.parent;if(u&&u.name=="object"){var f=u.attributes.width;u=u.attributes.height;f&&(q.attributes.width=f);u&&(q.attributes.height=u)}},param:function(q){q.children=[];q.isEmpty=true;return q},a:function(q){if(!(q.children.length||
q.attributes.name))return false}},attributes:{"class":function(q){if(/ke_/.test(q))return q;return false}}};if(r.ie)z.attributes.style=function(q){return q.toLowerCase()};t.addRules(z);n.addRules(z);y.HtmlDataProcessor={htmlFilter:t,dataFilter:n,toHtml:function(q,u){var f=new B.HtmlWriter;B.Fragment.FromHtml(q,u).writeHtml(f,t);return f.getHtml(true)},toDataFormat:function(q,u){var f=new B.HtmlWriter;q=B.Fragment.FromHtml(q,u);f.reset();q.writeHtml(f,n);return f.getHtml(true)}}}});
KISSY.Editor.add("image",function(y){var r=KISSY.Editor,B=KISSY,t=B.Node,n=B.DOM,z=B.Event,q=r.SimpleOverlay;r.ImageInserter||function(){function u(g){u.superclass.constructor.call(this,g);this._init()}var f=r.TripleButton;u.ATTRS={editor:{}};B.extend(u,B.Base,{_init:function(){var g=this.get("editor").toolBarDiv;this.el=new f({contentCls:"ke-toolbar-image",title:"\u56fe\u50cf",container:g});this.el.on("offClick",this.show,this);r.Utils.lazyRun(this,"_prepare","_real")},_prepare:function(){var g=
this,i=this.get("editor");this.content=new t("<div class='ke-popup-wrap' style='width:250px;padding:10px;'><p style='margin:0 0 10px'><label>\u8bf7\u8f93\u5165\u56fe\u7247\u5730\u5740\uff1a<br/><input value='http://' style='width: 250px;' class='ke-img-url'/></label></p><p><button class='ke-img-insert'>\u63d2\u5165</button>&nbsp;<a href='#' class='ke-img-cancel'>\u53d6\u6d88</a></p></div>");this.d=new q({el:this.content});document.body.appendChild(this.content[0]);var l=this.content.one(".ke-img-cancel"),
v=this.content.one(".ke-img-insert");this.imgUrl=this.content.one(".ke-img-url");l.on("click",function(k){this.d.hide();k.halt()},this);z.on(document,"click",this.hide,this);z.on(i.document,"click",this.hide,this);v.on("click",function(){g._insert()})},hide:function(g){var i=this;n._4e_ascendant(g.target,function(l){return l[0]===i.content[0]||l[0]===i.el.el[0]},true)||this.d.hide()},_real:function(){var g=this.el.el.offset();g.top+=this.el.el.height()+5;console.log(this.content.width(),g.left,n.viewportWidth());
if(g.left+this.content.width()>n.viewportWidth()-60)g.left=n.viewportWidth()-this.content.width()-60;this.d.show(g)},_insert:function(){var g=this.get("editor"),i=this.imgUrl.val();if(i){i=new t("<img src='"+i+"'/>",null,g.document);g.insertElement(i);this.d.hide()}},show:function(){this._prepare()}});r.ImageInserter=u}();y.addPlugin(function(){new r.ImageInserter({editor:y})})});
KISSY.Editor.add("indent",function(y){var r=KISSY.Editor,B={ol:1,ul:1},t=KISSY,n=r.Walker,z=t.DOM,q=t.Node,u=t.UA,f=r.NODE;r.Indent||function(){function g(j){this.type=j;this.indentCssProperty="margin-left";this.indentOffset=40;this.indentUnit="px"}function i(j){return j.type=CKEDITOR.NODE_ELEMENT&&j.is("li")}function l(j,e,h){var s=e.startContainer;for(j=e.endContainer;s&&s.parent()[0]!==h[0];)s=s.parent();for(;j&&j.parent()[0]!==h[0];)j=j.parent();if(s&&j){var b=s;s=[];for(var d=false;!d;){if(b[0]===
j[0])d=true;s.push(b);b=b.next()}if(!(s.length<1)){b=h._4e_parents(true);for(j=0;j<b.length;j++)if(B[b[j]._4e_name()]){h=b[j];break}b=this.type=="indent"?1:-1;j=s[0];d=s[s.length-1];s={};var o=r.ListUtils.listToArray(h,s),A=o[d._4e_getData("listarray_index")].indent;for(j=j._4e_getData("listarray_index");j<=d._4e_getData("listarray_index");j++){o[j].indent+=b;var w=o[j].parent;o[j].parent=new q(w[0].ownerDocument.createElement(w._4e_name()))}for(j=d._4e_getData("listarray_index")+1;j<o.length&&o[j].indent>
A;j++)o[j].indent+=b;d=r.ListUtils.arrayToList(o,s,null,"p",0);b=[];if(this.type=="outdent"){var C;if((C=h.parent())&&C._4e_name()=="li"){o=d.listNode.childNodes;var I;for(j=o.length-1;j>=0;j--)if((I=new q(o[j]))&&I._4e_name()=="li")b.push(I)}}if(d){z.insertBefore(d.listNode,h[0]);h._4e_remove()}if(b&&b.length)for(j=0;j<b.length;j++){for(I=h=b[j];(I=I.next())&&I._4e_name()in B;){u.ie&&!h._4e_first(function(x){return p(x)&&a(x)})&&h[0].appendChild(e.document.createTextNode("\u00a0"));h[0].appendChild(I[0])}z.insertAfter(h[0],
C[0])}for(j in s)s[j]._4e_clearMarkers(s,true)}}}function v(j,e){e=e.createIterator();e.enforceRealBlocks=true;e.enlargeBr=true;for(var h;h=e.getNextParagraph();)k.call(this,j,h)}function k(j,e){j=parseInt(e._4e_style(this.indentCssProperty),10);if(isNaN(j))j=0;j+=(this.type=="indent"?1:-1)*this.indentOffset;if(j<0)return false;j=Math.max(j,0);j=Math.ceil(j/this.indentOffset)*this.indentOffset;e.css(this.indentCssProperty,j?j+this.indentUnit:"");e[0].style.cssText===""&&e[0].removeAttribute("style");
return true}function m(j){m.superclass.constructor.call(this,j);j=this.get("editor").toolBarDiv;this.el=new c({container:j,contentCls:this.get("contentCls"),title:this.get("title")});this.indentCommand=new g(this.get("type"));this._init()}var p=n.whitespaces(true),a=n.bookmark(false,true);t.augment(g,{exec:function(j){j.focus();for(var e=j.getSelection(),h=e&&e.getRanges()[0],s=h.startContainer,b=h.endContainer,d=h.getCommonAncestor();d&&!(d[0].nodeType==f.NODE_ELEMENT&&B[d._4e_name()]);)d=d.parent();
if(d&&s[0].nodeType==f.NODE_ELEMENT&&s._4e_name()in B){s=new n(h);s.evaluator=i;h.startContainer=s.next()}if(d&&b[0].nodeType==f.NODE_ELEMENT&&b._4e_name()in B){s=new n(h);s.evaluator=i;h.endContainer=s.previous()}b=e.createBookmarks(true);if(d){for(s=d._4e_first();s&&s[0]&&s._4e_name()!="li";)s=s.next();var o=h.startContainer;(s[0]==o[0]||s._4e_contains(o))&&k.call(this,j,d)||l.call(this,j,h,d)}else v.call(this,j,h);j.focus();e.selectBookmarks(b)}});var c=r.TripleButton;m.ATTRS={type:{},contentCls:{},
editor:{}};t.extend(m,t.Base,{_init:function(){var j=this.get("editor"),e=this.el;e.on("offClick",this.exec,this);this.get("type")=="outdent"?j.on("selectionChange",this._selectionChange,this):e.set("state",c.OFF)},exec:function(){var j=this.get("editor"),e=this;j.focus();j.fire("save");setTimeout(function(){e.indentCommand.exec(j);j.fire("save");j.notifySelectionChange()},10)},_selectionChange:function(j){this.get("editor");this.get("type");var e=j.path,h=e.blockLimit;j=this.el;if(e.contains(B))j.set("state",
c.OFF);else(e=e.block||h)&&e._4e_style(this.indentCommand.indentCssProperty)?j.set("state",c.OFF):j.set("state",c.DISABLED)}});r.Indent=m}();y.addPlugin(function(){y.addCommand("outdent",new r.Indent({editor:y,title:"\u51cf\u5c11\u7f29\u8fdb\u91cf",contentCls:"ke-toolbar-outdent",type:"outdent"}));y.addCommand("indent",new r.Indent({editor:y,title:"\u589e\u52a0\u7f29\u8fdb\u91cf",contentCls:"ke-toolbar-indent",type:"indent"}))})});
KISSY.Editor.add("justify",function(y){var r=KISSY.Editor,B=KISSY,t=r.TripleButton;r.Justify||function(){function n(q,u,f,g){this.editor=q;this.v=u;this.contentCls=g;this.title=f;this._init()}var z=/(-moz-|-webkit-|start|auto)/i;B.augment(n,{_init:function(){var q=this.editor;this.el=new t({contentCls:this.contentCls,title:this.title,container:q.toolBarDiv});q.on("selectionChange",this._selectionChange,this);this.el.on("click",this._effect,this)},_effect:function(){var q=this.editor,u=q.getSelection(),
f=this.el.get("state");if(u){var g=u.createBookmarks(),i=u.getRanges(),l,v;q.fire("save");for(var k=i.length-1;k>=0;k--){l=i[k].createIterator();for(l.enlargeBr=true;v=l.getNextParagraph();){v.removeAttr("align");f==t.OFF?v.css("text-align",this.v):v.css("text-align","")}}q.focus();q.notifySelectionChange();u.selectBookmarks(g);q.fire("save")}},_selectionChange:function(q){var u=this.el;q=q.path;if(q=q.block||q.blockLimit){q=q.css("text-align").replace(z,"");q==this.v||!q&&this.v=="left"?u.set("state",
t.ON):u.set("state",t.OFF)}}});r.Justify=n}();y.addPlugin(function(){new r.Justify(y,"left","\u5de6\u5bf9\u9f50","ke-toolbar-alignleft");new r.Justify(y,"center","\u5c45\u4e2d\u5bf9\u9f50","ke-toolbar-aligncenter");new r.Justify(y,"right","\u53f3\u5bf9\u9f50","ke-toolbar-alignright")})});
KISSY.Editor.add("link",function(y){var r=KISSY.Editor,B=KISSY,t=B.DOM,n=B.Event,z=r.TripleButton,q=r.Style,u=B.Node,f=r.Range,g=r.SimpleOverlay,i=r.HtmlDataProcessor,l=i&&i.dataFilter;r.Link||function(){function v(p){this.editor=p;this._init()}l&&l.addRules({elements:{a:function(p){for(var a in p.attributes)a=="href"||a=="target"||delete p.attributes[a]}}});var k={element:"a",attributes:{href:"#(href)",target:"#(target)"}};v.init=function(){var p=this;p.d=new g({title:"\u7f16\u8f91\u8d85\u94fe\u63a5",
mask:true,width:"300px"});p.d.body.html(m);p.urlEl=p.d.body.one(".ke-link-url");p.targetEl=p.d.body.one(".ke-link-blank");var a=p.d.body.one(".ke-link-cancel");p.ok=p.d.body.one(".ke-link-ok");v.ok.on("click",function(c){v.d.link._link();c.halt()},this);a.on("click",function(c){p.d.hide();c.halt()},p);v.init=null};v.tip=function(){var p=new u('<div class="ke-bubbleview-bubble" onmousedown="return false;">\u524d\u5f80\u94fe\u63a5\uff1a  <a href=""  target="_blank" class="ke-bubbleview-url"></a> -     <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -     <span class="ke-bubbleview-link ke-bubbleview-remove">\u53bb\u9664</span></div>');
p._4e_unselectable();this.tipwin=new g({el:p});document.body.appendChild(p[0]);this.tipurl=p.one(".ke-bubbleview-url");var a=p.one(".ke-bubbleview-change");p=p.one(".ke-bubbleview-remove");a.on("click",function(c){v.tipwin.link.show();c.halt()});p.on("click",function(c){v.tipwin.link._removeLink();c.halt()});v.tip=null};var m="<div style='padding: 10px;'><p><label>URL\uff1a<input class='ke-link-url' style='width:230px' value='http://'/></label></p><p style='margin-top: 5px;padding-left:35px'><label><input class='ke-link-blank' type='checkbox'/> &nbsp; \u5728\u65b0\u7a97\u53e3\u6253\u5f00\u94fe\u63a5</label></p><p style='margin-top: 5px;'><label><button class='ke-link-ok'>\u786e\u5b9a</button>&nbsp;<a href='#' class='ke-link-cancel'>\u53d6\u6d88</a></label></p></div>";
B.augment(v,{_init:function(){var p=this.editor;this.el=new z({container:p.toolBarDiv,contentCls:"ke-toolbar-link",title:"\u63d2\u5165\u7f16\u8f91\u8d85\u94fe\u63a5"});this.el.on("click",this.show,this);p.on("selectionChange",this._selectionChange,this)},_prepareTip:function(){v.tip&&v.tip()},_realTip:function(p){var a=p._4e_getOffset(document);a.top+=p.height()+5;v.tipwin.show(a);this._a=p;v.tipwin.link=this;v.tipurl.html(p.attr("href"));v.tipurl.attr("href",p.attr("href"))},_showTip:function(p){this._prepareTip(p)},
_hideTip:function(){v.tipwin&&v.tipwin.hide()},_removeLink:function(){var p=this._a,a=this.editor;a.focus();var c={href:p.attr("href")};if(p._4e_hasAttribute("target"))c.target=p.attr("target");p=new q(k,c);a.fire("save");p.remove(a.document);a.fire("save");this._hideTip();a.focus();a.notifySelectionChange()},_selectionChange:function(p){p=p.path;var a=p.elements;if(p&&a)if(p=p.lastElement)(p=p._4e_ascendant(function(c){return c._4e_name()==="a"&&!!c.attr("href")},true))?this._showTip(p):this._hideTip()},
hide:function(){v.d.hide()},_getSelectedLink:function(){var p=this.editor;if(v.tipwin&&v.tipwin.get("visible")){(p=p.getSelection().getRanges()[0].getCommonAncestor())&&(p=p._4e_ascendant(function(a){return a._4e_name()=="a"&&!!a.attr("href")},true));if(p&&p[0]==v.tipwin.link._a[0])return p}},_link:function(){var p=this.editor,a=v.urlEl.val();p.focus();if(B.trim(a)){var c=this._getSelectedLink();if(c){var j=new f(p.document);j.selectNodeContents(c);p.getSelection().selectRanges([j]);this._removeLink()}a=
{href:a};a.target=v.targetEl[0].checked?"_blank":"_self";a=new q(k,a);p.fire("save");a.apply(p.document);p.fire("save");this.hide();p.focus();p.notifySelectionChange()}},_prepare:function(){v.init&&v.init()},_real:function(){v.d.link=this;var p=this._getSelectedLink();if(p){v.urlEl.val(p.attr("href"));v.targetEl[0].checked=p.attr("target")=="_blank"}v.d.show()},show:function(){this._prepare()}});r.Utils.lazyRun(v.prototype,"_prepare","_real");r.Utils.lazyRun(v.prototype,"_prepareTip","_realTip");
r.Link=v}();y.addPlugin(function(){new r.Link(y);var v=t._4e_getWin(y.document);n.on(v,"scroll",function(){r.Link.tipwin&&r.Link.tipwin.hide()})})});
KISSY.Editor.add("list",function(y){var r=KISSY.Editor,B={ol:1,ul:1},t=["ol","ul"],n=KISSY,z=r.RANGE,q=r.ElementPath,u=r.Walker,f=r.NODE,g=n.UA,i=n.Node,l=n.DOM;r.List||function(){function v(c){this.type=c}function k(c){k.superclass.constructor.call(this,c);c=this.get("editor").toolBarDiv;this.el=new a({contentCls:this.get("contentCls"),title:this.get("title"),container:c});this.listCommand=new v(this.get("type"));this.listCommand.state=this.get("status");this._init()}var m={listToArray:function(c,
j,e,h,s){if(!B[c._4e_name()])return[];h||(h=0);e||(e=[]);for(var b=0,d=c[0].childNodes.length;b<d;b++){var o=new i(c[0].childNodes[b]);if(o._4e_name()=="li"){var A={parent:c,indent:h,element:o,contents:[]};if(s)A.grandparent=s;else{A.grandparent=c.parent();if(A.grandparent&&A.grandparent._4e_name()=="li")A.grandparent=A.grandparent.parent()}j&&o._4e_setMarker(j,"listarray_index",e.length);e.push(A);for(var w=0,C=o[0].childNodes.length,I;w<C;w++){I=new i(o[0].childNodes[w]);I[0].nodeType==f.NODE_ELEMENT&&
B[I._4e_name()]?m.listToArray(I,j,e,h+1,A.grandparent):A.contents.push(I)}}}return e},arrayToList:function(c,j,e,h){e||(e=0);if(!c||c.length<e+1)return null;for(var s=c[e].parent[0].ownerDocument,b=s.createDocumentFragment(),d=null,o=e,A=Math.max(c[e].indent,0),w=null;;){var C=c[o];if(C.indent==A){if(!d||c[o].parent._4e_name()!=d._4e_name()){d=c[o].parent._4e_clone(false,true);b.appendChild(d[0])}w=d[0].appendChild(C.element._4e_clone(false,true)[0]);for(var I=0;I<C.contents.length;I++)w.appendChild(C.contents[I]._4e_clone(true,
true)[0]);o++}else if(C.indent==Math.max(A,0)+1){o=m.arrayToList(c,null,o,h);w.appendChild(o.listNode);o=o.nextIndex}else if(C.indent==-1&&!e&&C.grandparent){w=B[C.grandparent._4e_name()]?C.element._4e_clone(false,true)[0]:C.grandparent._4e_name()!="td"?s.createElement(h):s.createDocumentFragment();for(I=0;I<C.contents.length;I++)w.appendChild(C.contents[I]._4e_clone(true,true)[0]);if(w.nodeType==f.NODE_DOCUMENT_FRAGMENT&&o!=c.length-1){w.lastChild&&w.lastChild.nodeType==f.NODE_ELEMENT&&w.lastChild.getAttribute("type")==
"_moz"&&l._4e_remove(w.lastChild);l._4e_appendBogus(w)}if(w.nodeType==f.NODE_ELEMENT&&l._4e_name(w)==h&&w.firstChild){l._4e_trim(w);d=w.firstChild;if(d.nodeType==f.NODE_ELEMENT&&l._4e_isBlockBoundary(d)){d=s.createDocumentFragment();l._4e_moveChildren(w,d);w=d}}d=l._4e_name(w);if(!g.ie&&(d=="div"||d=="p"))l._4e_appendBogus(w);b.appendChild(w);d=null;o++}else return null;if(c.length<=o||Math.max(c[o].indent,0)<A)break}if(j)for(c=new i(b.firstChild);c&&c[0];){c[0].nodeType==f.NODE_ELEMENT&&c._4e_clearMarkers(j,
true);c=c._4e_nextSourceNode()}return{listNode:b,nextIndex:o}}},p=/^h[1-6]$/;v.prototype={changeListType:function(c,j,e,h){var s=m.listToArray(j.root,e),b=[];for(c=0;c<j.contents.length;c++){var d=j.contents[c];d=d._4e_ascendant("li",true);if(!(!d||!d[0]||d._4e_getData("list_item_processed"))){b.push(d);d._4e_setMarker(e,"list_item_processed",true)}}d=new i(j.root[0].ownerDocument.createElement(this.type));for(c=0;c<b.length;c++){var o=b[c]._4e_getData("listarray_index");s[o].parent=d}e=m.arrayToList(s,
e,null,"p");var A;s=e.listNode.childNodes.length;for(c=0;c<s&&(A=new i(e.listNode.childNodes[c]));c++)A._4e_name()==this.type&&h.push(A);l.insertBefore(e.listNode,j.root[0]);j.root._4e_remove()},createList:function(c,j,e){var h=j.contents;c=j.root[0].ownerDocument;var s=[];if(h.length==1&&h[0][0]===j.root[0]){var b=new i(c.createElement("div"));h[0][0].nodeType!=f.NODE_TEXT&&h[0]._4e_moveChildren(b);h[0][0].appendChild(b[0]);h[0]=b}j=j.contents[0].parent();for(b=0;b<h.length;b++)j=j._4e_commonAncestor(h[b].parent());
for(b=0;b<h.length;b++)for(var d=h[b],o;o=d.parent();){if(o[0]===j[0]){s.push(d);break}d=o}if(!(s.length<1)){h=new i(s[s.length-1][0].nextSibling);b=new i(c.createElement(this.type));for(e.push(b);s.length;){e=s.shift();d=new i(c.createElement("li"));if(p.test(e._4e_name()))d[0].appendChild(e[0]);else{e._4e_copyAttributes(d);e._4e_moveChildren(d);e._4e_remove()}b[0].appendChild(d[0]);g.ie||d._4e_appendBogus()}h[0]?l.insertBefore(b[0],h[0]):j[0].appendChild(b[0])}},removeList:function(c,j,e){function h(I){if((w=
new i(A[I?"firstChild":"lastChild"]))&&!(w[0].nodeType==f.NODE_ELEMENT&&w._4e_isBlockBoundary())&&(C=j.root[I?"_4e_previous":"_4e_next"](u.whitespaces(true)))&&!(w[0].nodeType==f.NODE_ELEMENT&&C._4e_isBlockBoundary({br:1})))l[I?"insertBefore":"insertAfter"](c.document.createElement("br"),w[0])}for(var s=m.listToArray(j.root,e),b=[],d=0;d<j.contents.length;d++){var o=j.contents[d];o=o._4e_ascendant("li",true);if(!(!o||o._4e_getData("list_item_processed"))){b.push(o);o._4e_setMarker(e,"list_item_processed",
true)}}o=null;for(d=0;d<b.length;d++){o=b[d]._4e_getData("listarray_index");s[o].indent=-1;o=o}for(d=o+1;d<s.length;d++)if(s[d].indent>Math.max(s[d-1].indent,0)){b=s[d-1].indent+1-s[d].indent;for(o=s[d].indent;s[d]&&s[d].indent>=o;){s[d].indent+=b;d++}d--}var A=m.arrayToList(s,e,null,"p").listNode,w,C;h(true);h();l.insertBefore(A,j.root);j.root._4e_remove()},exec:function(c){c.focus();var j=c.getSelection(),e=j&&j.getRanges();if(!(!e||e.length<1)){for(var h=j.createBookmarks(true),s=[],b={};e.length>
0;){var d=e.shift(),o=d.getBoundaryNodes(),A=o.startNode,w=o.endNode;A[0].nodeType==f.NODE_ELEMENT&&A._4e_name()=="td"&&d.setStartAt(o.startNode,z.POSITION_AFTER_START);w[0].nodeType==f.NODE_ELEMENT&&w._4e_name()=="td"&&d.setEndAt(o.endNode,z.POSITION_BEFORE_END);d=d.createIterator();for(d.forceBrBreak=false;o=d.getNextParagraph();){A=new q(o);w=A.elements;var C=null,I=false,x=A.blockLimit,D;for(A=w.length-1;A>=0&&(D=w[A]);A--)if(B[D._4e_name()]&&x.contains(D)){x._4e_removeData("list_group_object");
if(A=D._4e_getData("list_group_object"))A.contents.push(o);else{A={root:D,contents:[o]};s.push(A);D._4e_setMarker(b,"list_group_object",A)}I=true;break}if(!I)if(x._4e_getData("list_group_object"))x._4e_getData("list_group_object").contents.push(o);else{A={root:x,contents:[o]};x._4e_setMarker(b,"list_group_object",A);s.push(A)}}}for(e=[];s.length>0;){A=s.shift();if(this.state=="off")B[A.root._4e_name()]?this.changeListType(c,A,b,e):this.createList(c,A,e);else this.state=="on"&&B[A.root._4e_name()]&&
this.removeList(c,A,b)}for(A=0;A<e.length;A++){C=e[A];var G=this;(s=function(J){var N=C[J?"_4e_previous":"_4e_next"](u.whitespaces(true));if(N&&N[0]&&N._4e_name()==G.type){N._4e_remove();N._4e_moveChildren(C,J?true:false)}})();s(true)}r.Utils.clearAllMarkers(b);j.selectBookmarks(h);c.focus()}}};var a=r.TripleButton;k.ATTRS={editor:{},type:{},contentCls:{}};n.extend(k,n.Base,{_init:function(){var c=this.get("editor");this.el.on("click",this._change,this);c.on("selectionChange",this._selectionChange,
this)},_change:function(){var c=this.get("editor"),j=this.get("type"),e=this.el,h=this;c.focus();c.fire("save");setTimeout(function(){h.listCommand.state=e.get("state");h.listCommand.exec(c);c.fire("save");c.fire(j+"Change")},10)},_selectionChange:function(c){this.get("editor");var j=this.get("type"),e=c.path,h;c=this.el;var s=e.blockLimit;if(e=e.elements)for(var b=0;b<e.length&&(h=e[b])&&h[0]!==s[0];b++){var d=n.indexOf(e[b]._4e_name(),t);if(d!==-1)if(t[d]===j){c.set("state",a.ON);return}else break}c.set("state",
a.OFF)}});r.ListUtils=m;r.List=k}();y.addPlugin(function(){new r.List({editor:y,title:"\u9879\u76ee\u5217\u8868",contentCls:"ke-toolbar-ul",type:"ul"});new r.List({editor:y,title:"\u7f16\u53f7\u5217\u8868",contentCls:"ke-toolbar-ol",type:"ol"})})});
KISSY.Editor.add("maximize",function(y){var r=KISSY.Editor,B=KISSY,t=B.UA,n=B.Node,z=B.Event,q=r.TripleButton,u=B.DOM,f;r.Maximize||function(){function g(i){this.editor=i;this._init()}g.init=function(){f=new n("<iframe style='position:absolute;top:-9999px;left:-9999px;' frameborder='0'></iframe>");document.body.appendChild(f[0]);g.init=null};B.augment(g,{_init:function(){this.el=new q({container:this.editor.toolBarDiv,cls:"ke-tool-editor-source",title:"\u5168\u5c4f",contentCls:"ke-toolbar-maximize"});
this.el.on("offClick",this.maximize,this);this.el.on("onClick",this.restore,this);r.Utils.lazyRun(this,"_prepare","_real")},restore:function(){var i=this,l=i.editor;z.remove(window,"resize",i._maximize,i);this._saveEditorStatus();l.wrap.css({height:i.iframeHeight});(new n(document.body)).css({width:"",height:"",overflow:""});l.editorWrap.css({position:"static",width:i.editorWrapWidth});f.css({left:"-99999px",top:"-99999px"});window.scrollTo(i.scrollLeft,i.scrollTop);i.el.set("state",q.OFF);setTimeout(function(){i._restoreEditorStatus()},
30)},_saveSate:function(){var i=this.editor;this.iframeHeight=i.wrap._4e_style("height");this.editorWrapWidth=i.editorWrap._4e_style("width");this.scrollLeft=u.scrollLeft();this.scrollTop=u.scrollTop();window.scrollTo(0,0)},_saveEditorStatus:function(){var i=this.editor;if(t.gecko&&i.iframeFocus)this.savedRanges=(i=i.getSelection())&&i.getRanges()},_restoreEditorStatus:function(){var i=this.editor,l;if(t.gecko&&i.iframeFocus){l=i.getSelection();this.el.el[0].focus();i.focus();this.savedRanges&&l&&
l.selectRanges(this.savedRanges)}if(i.iframeFocus&&l)(l=l.getStartElement())&&l[0]&&l.scrollIntoView(i.document,false)},_maximize:function(){var i=this.editor,l=u.viewportHeight(),v=u.viewportWidth(),k=i.statusDiv?i.statusDiv.height():0,m=i.toolBarDiv.height();if(t.ie)document.body.style.overflow="hidden";else(new n(document.body)).css({width:0,height:0,overflow:"hidden"});i.editorWrap.css({position:"absolute",zIndex:9999,width:v+"px"});f.css({zIndex:9998,height:l+"px",width:v+"px"});i.editorWrap.offset({left:0,
top:0});f.css({left:0,top:0});i.wrap.css({height:l-k-m-14+"px"})},_real:function(){var i=this;this._saveEditorStatus();this._saveSate();this._maximize();this._maximize();z.on(window,"resize",i._maximize,i);this.el.set("state",q.ON);setTimeout(function(){i._restoreEditorStatus()},30)},_prepare:function(){g.init&&g.init()},maximize:function(){this._prepare()}});r.Maximize=g}();y.addPlugin(function(){new r.Maximize(y)})});
KISSY.Editor.add("music",function(y){var r=KISSY.Editor;r.MusicInserter||function(){function B(l){B.superclass.constructor.call(this,l);this._init()}var t=KISSY,n=t.Node,z=t.DOM,q=t.Event,u=r.SimpleOverlay,f=r.TripleButton,g='<object  width="165" height="37" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,0,0" classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"><param value="'+(r.Config.base+'plugins/music/niftyplayer.swf?file=#(music)&amp;as=0"')+' name="movie"><param value="high" name="quality"><param value="#FFFFFF" name="bgcolor"><embed width="165" height="37" type="application/x-shockwave-flash" swliveconnect="true" src="'+
(r.Config.base+'plugins/music/niftyplayer.swf?file=#(music)&amp;as=0"')+'quality="high" pluginspage="http://www.macromedia.com/go/getflashplayer" bgcolor="#FFFFFF"></object>',i=/#\(music\)/g;B.ATTRS={editor:{}};t.extend(B,t.Base,{_init:function(){var l=this.get("editor").toolBarDiv;this.el=new f({contentCls:"ke-toolbar-music",title:"\u5206\u4eab\u97f3\u4e50",container:l});this.el.on("offClick",this.show,this);r.Utils.lazyRun(this,"_prepare","_real")},_prepare:function(){var l=this,v=this.get("editor");
this.content=new n("<div class='ke-popup-wrap' style='width:250px;padding:10px;'><p style='margin:0 0 10px'><label>\u8bf7\u8f93\u5165\u97f3\u4e50\u5730\u5740\uff1a<br/><input value='http://' style='width: 250px;' class='ke-music-url'/></label></p><p><button class='ke-music-insert'>\u63d2\u5165</button>&nbsp;<a href='#' class='ke-music-cancel'>\u53d6\u6d88</a></p></div>");this.d=new u({el:this.content});document.body.appendChild(this.content[0]);var k=this.content.one(".ke-music-cancel"),m=this.content.one(".ke-music-insert");
this.musicUrl=this.content.one(".ke-music-url");k.on("click",function(p){this.d.hide();p.halt()},this);q.on(document,"click",this.hide,this);q.on(v.document,"click",this.hide,this);m.on("click",function(){l._insert()})},hide:function(l){var v=this;z._4e_ascendant(l.target,function(k){return k[0]===v.content[0]||k[0]===v.el.el[0]})||this.d.hide()},_real:function(){var l=this.el.el.offset();l.top+=this.el.el.height()+5;if(l.left+this.content.width()>z.viewportWidth()-60)l.left=z.viewportWidth()-this.content.width()-
60;this.d.show(l)},_insert:function(){var l=this.get("editor"),v=this.musicUrl.val();if(v){v=new n(g.replace(i,v),null,l.document);v=l.createFakeElement?l.createFakeElement(v,"ke_music","music",true):v;l.insertElement(v);this.d.hide()}},show:function(){this._prepare()}});r.MusicInserter=B}();y.addPlugin(function(){new r.MusicInserter({editor:y})})});
KISSY.Editor.add("preview",function(y){var r=KISSY.Editor,B=KISSY,t=r.TripleButton;r.Preview||function(){function n(z){this.editor=z;this._init()}B.augment(n,{_init:function(){this.el=new t({container:this.editor.toolBarDiv,cls:"ke-tool-editor-source",title:"\u9884\u89c8",contentCls:"ke-toolbar-preview"});this.el.on("offClick",this._show,this)},_show:function(){var z=this.editor,q=640,u=420,f=80;try{var g=window.screen;q=Math.round(g.width*0.8);u=Math.round(g.height*0.7);f=Math.round(g.width*0.1)}catch(i){}z=
z._prepareIFrameHtml().replace(/<body[^>]+>.+<\/body>/,"<body>\n"+z.getData()+"\n</body>");q=window.open("",null,"toolbar=yes,location=no,status=yes,menubar=yes,scrollbars=yes,resizable=yes,width="+q+",height="+u+",left="+f);q.document.open();q.document.write(z);q.document.close()}});r.Preview=n}();y.addPlugin(function(){new r.Preview(y)})});
KISSY.Editor.add("removeformat",function(y){function r(i){this.editor=i;this._init()}function B(i,l){for(var v=0;v<l.length;v++)i.removeAttr(l[v])}var t=KISSY.Editor,n=KISSY,z=t.RANGE,q=t.ElementPath,u=t.NODE,f=t.TripleButton,g="b,big,code,del,dfn,em,font,i,ins,kbd,q,samp,small,span,strike,strong,sub,sup,tt,u,var";removeFormatAttributes="class,style,lang,width,height,align,hspace,valign".split(",");g=new RegExp("^(?:"+g.replace(/,/g,"|")+")$","i");n.augment(r,{_init:function(){this.el=new f({title:"\u6e05\u9664\u683c\u5f0f",
contentCls:"ke-toolbar-removeformat",container:this.editor.toolBarDiv});this.el.on("offClick",this._remove,this)},_remove:function(){var i=this.editor,l=g,v=removeFormatAttributes;l.lastIndex=0;i.focus();var k=i.getSelection().getRanges();i.fire("save");for(var m=0,p;p=k[m];m++)if(!p.collapsed){p.enlarge(z.ENLARGE_ELEMENT);var a=p.createBookmark(),c=a.startNode,j=a.endNode,e=function(h){for(var s=new q(h),b=s.elements,d=1,o;o=b[d];d++){if(o._4e_equals(s.block)||o._4e_equals(s.blockLimit))break;l.test(o.getName())&&
h.breakParent(o)}};e(c);e(j);for(c=c._4e_nextSourceNode(true,u.NODE_ELEMENT);c;){if(c._4e_equals(j))break;e=c._4e_nextSourceNode(false,u.NODE_ELEMENT);c._4e_name()=="img"&&c.attr("_cke_realelement")||(l.test(c._4e_name())?c._4e_remove(true):B(c,v));c=e}p.moveToBookmark(a)}i.getSelection().selectRanges(k);i.fire("save")}});y.addPlugin(function(){new r(y)})});
KISSY.Editor.add("smiley",function(y){var r=KISSY.Editor,B=KISSY,t=B.DOM,n=B.Event,z=B.Node,q=r.SimpleOverlay,u=r.TripleButton;r.Smiley||function(){function f(l){this.editor=l;this._init()}for(var g="<div class='ke-popup-wrap'><div class='ke-smiley-sprite'>",i=0;i<=98;i++)g+="<a href='#' data-icon='http://a.tbcdn.cn/sys/wangwang/smiley/48x48/"+i+".gif'></a>";g+="</div></div>";B.augment(f,{_init:function(){this.el=new u({contentCls:"ke-toolbar-smiley",title:"\u63d2\u5165\u8868\u60c5",container:this.editor.toolBarDiv});
this.el.on("offClick",this._show,this);r.Utils.lazyRun(this,"_prepare","_real")},_hidePanel:function(l){var v=this;t._4e_ascendant(l.target,function(k){return k[0]===v.el.el[0]})||this.smileyWin.hide()},_selectSmiley:function(l){l.halt();var v=this.editor;l=l.target;var k;if(t._4e_name(l)=="a"&&(k=t.attr(l,"data-icon"))){k=new z("<img src='"+k+"'/>",null,v.document);v.insertElement(k);v.focus();this.smileyWin.hide()}},_prepare:function(){var l=this.editor;this.smileyPanel=new z(g);this.smileyWin=
new q({el:this.smileyPanel,mask:false});document.body.appendChild(this.smileyPanel[0]);this.smileyPanel.on("click",this._selectSmiley,this);n.on(document,"click",this._hidePanel,this);n.on(l.document,"click",this._hidePanel,this)},_real:function(){var l=this.el.el.offset();l.top+=this.el.el.height()+5;if(l.left+this.smileyPanel.width()>t.viewportWidth()-60)l.left=t.viewportWidth()-this.smileyPanel.width()-60;this.smileyWin.show(l)},_show:function(l){this._prepare(l)}});r.Smiley=f}();y.addPlugin(function(){new r.Smiley(y)})});
KISSY.Editor.add("sourcearea",function(y){var r=KISSY.Editor,B=KISSY,t=B.UA,n=r.TripleButton;r.SourceArea||function(){function z(q){this.editor=q;this._init()}B.augment(z,{_init:function(){var q=this.editor;this.el=new n({container:q.toolBarDiv,cls:"ke-tool-editor-source",title:"\u6e90\u7801",contentCls:"ke-toolbar-source"});this.el.on("offClick",this._show,this);this.el.on("onClick",this._hide,this);q.textarea.on("mousedown",function(u){u.stopPropagation()})},_show:function(){var q=this.editor,u=
this.el;q.textarea.val(q.getData());q._showSource();u.set("state",n.ON)},_hide:function(){var q=this.editor,u=q.textarea,f=this.el;q._hideSource();q.setData(u.val());if(t.gecko&&q.iframeFocus){f.el[0].focus();q.focus()}f.set("state",n.OFF)}});r.SourceArea=z}();y.addPlugin(function(){new r.SourceArea(y)})});
KISSY.Editor.add("table",function(y,r){console.log("table loaded!");var B=KISSY.Editor,t=KISSY,n=t.Node,z=t.DOM,q=B.Walker,u=t.UA,f=B.NODE,g=B.TripleButton,i=B.SimpleOverlay,l=B.ContextMenu,v=["tr","th","td","tbody","table"],k=t.trim,m;m=(u.ie===6?["table.%2,","table.%2 td, table.%2 th,","{","border : #d3d3d3 1px dotted","}"]:[" table.%2,"," table.%2 > tr > td,  table.%2 > tr > th,"," table.%2 > tbody > tr > td,  table.%2 > tbody > tr > th,"," table.%2 > thead > tr > td,  table.%2 > thead > tr > th,",
" table.%2 > tfoot > tr > td,  table.%2 > tfoot > tr > th","{","border : #d3d3d3 1px dotted","}"]).join("").replace(/%2/g,"ke_show_border");B.TableUI||function(){function p(x){this.editor=x;this.selectedTable=null;x._toolbars=x._toolbars||{};x._toolbars.table=this;this._init()}function a(x){return k(x).length!=0}function c(x){function D($){if(!(N.length>0))if($[0].nodeType==f.NODE_ELEMENT&&C.test($._4e_name())&&!$._4e_getData("selected_cell")){$._4e_setMarker(M,"selected_cell",true);N.push($)}}for(var G=
x.createBookmarks(),J=x.getRanges(),N=[],M={},Q=0;Q<J.length;Q++){var R=J[Q];if(R.collapsed){R=R.getCommonAncestor();(R=R._4e_ascendant("td",true)||R._4e_ascendant("th",true))&&N.push(R)}else{R=new q(R);var W;for(R.guard=D;W=R.next();)if((W=W.parent())&&C.test(W._4e_name())&&!W._4e_getData("selected_cell")){W._4e_setMarker(M,"selected_cell",true);N.push(W)}}}B.Utils.clearAllMarkers(M);x.selectBookmarks(G);return N}function j(x){x=x.cells;for(var D=0;D<x.length;D++){x[D].innerHTML="";u.ie||(new n(x[D]))._4e_appendBogus()}}
function e(x,D){if(x=x.getStartElement()._4e_ascendant("tr")){var G=x._4e_clone(true);G.insertBefore(x);j(D?G[0]:x[0])}}function h(x){if(x instanceof B.Selection){var D=c(x),G=D.length;x=[];for(var J,N,M=0;M<G;M++){var Q=D[M].parent(),R=Q[0].rowIndex;!M&&(J=R-1);x[R]=Q;M==G-1&&(N=R+1)}M=Q._4e_ascendant("table");J=new n(N<M[0].rows.length&&M[0].rows[N]||J>0&&M[0].rows[J]||M[0].parentNode);for(M=x.length;M>=0;M--)x[M]&&h(x[M]);return J}else if(x instanceof n){M=x._4e_ascendant("table");M[0].rows.length==
1?M._4e_remove():x._4e_remove()}return 0}function s(x,D){x=x.getStartElement();if(x=x._4e_ascendant("td",true)||x._4e_ascendant("th",true))for(var G=x._4e_ascendant("table"),J=x[0].cellIndex,N=0;N<G[0].rows.length;N++){var M=G[0].rows[N];if(!(M.cells.length<J+1)){x=new n(M.cells[J].cloneNode(false));u.ie||x._4e_appendBogus();M=new n(M.cells[J]);D?x.insertBefore(M):x.insertAfter(M)}}}function b(x){var D=[],G=x[0]&&x[0]._4e_ascendant("table"),J,N,M,Q;J=0;for(N=x.length;J<N;J++)D.push(x[J][0].cellIndex);
D.sort();J=1;for(N=D.length;J<N;J++)if(D[J]-D[J-1]>1){M=D[J-1]+1;break}M||(M=D[0]>0?D[0]-1:D[D.length-1]+1);x=G[0].rows;J=0;for(N=x.length;J<N;J++)if(Q=x[J].cells[M])break;return Q?new n(Q):G.previous()}function d(x){if(x instanceof B.Selection){var D=c(x),G=b(D);for(x=D.length-1;x>=0;x--)D[x]&&d(D[x]);return G}else if(x instanceof n){D=x._4e_ascendant("table");if(!D)return null;G=x[0].cellIndex;for(x=D[0].rows.length-1;x>=0;x--){var J=new n(D[0].rows[x]);if(!G&&J[0].cells.length==1)h(J);else J[0].cells[G]&&
J[0].removeChild(J[0].cells[G])}}return null}function o(x,D){var G=new B.Range(x[0].ownerDocument);if(!G.moveToElementEditablePosition(x,D?true:r)){G.selectNodeContents(x);G.collapse(D?false:true)}G.select(true)}var A=B.HtmlDataProcessor,w=A&&A.dataFilter;A=A&&A.htmlFilter;w&&w.addRules({elements:{table:function(x){x=x.attributes;var D=x["class"],G=parseInt(x.border,10);if(!G||G<=0)x["class"]=(D||"")+" ke_show_border"}}});A&&A.addRules({elements:{table:function(x){x=x.attributes;var D=x["class"];
if(D)x["class"]=t.trim(D.replace("ke_show_border","").replace(/\s{2}/," "))}}});t.augment(p,{_init:function(){var x=this.editor,D={};this.el=new g({contentCls:"ke-toolbar-table",title:"\u8868\u683c",container:x.toolBarDiv});this.el.on("offClick",this._tableShow,this);for(var G in I)(function(J){D[J]=function(){x.fire("save");x.focus();I[J](x);x.fire("save")}})(G);l.register(x.document,{tags:v,width:"120px",funcs:D});B.Utils.lazyRun(this,"_prepareTableShow","_realTableShow")},_tableInit:function(){var x=
this,D=x.editor,G=new i({width:"350px",mask:true,title:"\u7f16\u8f91\u8868\u683c"});G.body.html("<table class='ke-table-config'><tr><td><label>\u884c\u6570\uff1a <input value='2' class='ke-table-rows ke-table-create-only' size='8'/></label></td><td><label>\u5bbd\u5ea6\uff1a <input value='200' class='ke-table-width' size='8'/></label> <select class='ke-table-width-unit'><option value='px'>\u50cf\u7d20</option><option value='%'>\u767e\u5206\u6bd4</option></select></td></tr><tr><td><label>\u5217\u6570\uff1a <input class='ke-table-cols ke-table-create-only' value='3' size='8'/></label></td><td><label>\u9ad8\u5ea6\uff1a <input value='200' class='ke-table-height' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td><label>\u6807\u9898\u683c\uff1a <select class='ke-table-head ke-table-create-only'><option value=''>\u65e0</option><option value='1'>\u6709</option></select></td><td><label>\u95f4\u8ddd\uff1a <input value='1' class='ke-table-cellspacing' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td><label>\u5bf9\u9f50\uff1a <select class='ke-table-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option><option value='center'>\u4e2d\u95f4\u5bf9\u9f50</option></select></label></td><td><label>\u8fb9\u8ddd\uff1a <input value='1' class='ke-table-cellpadding' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td></td><td><label>\u8fb9\u6846\uff1a <input value='1' class='ke-table-border' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td colspan='2'><label>\u6807\u9898\uff1a<input class='ke-table-caption' style='width:270px'></label></td></tr><tr><td colspan='2' style='text-align:center'><button class='ke-table-ok'>\u786e\u5b9a</button></td></tr></table>");
G.twidth=G.body.one(".ke-table-width");G.theight=G.body.one(".ke-table-height");G.tcellspacing=G.body.one(".ke-table-cellspacing");G.tcellpadding=G.body.one(".ke-table-cellpadding");G.tborder=G.body.one(".ke-table-border");G.tcaption=G.body.one(".ke-table-caption");G.talign=G.body.one(".ke-table-align");G.trows=G.body.one(".ke-table-rows");G.tcols=G.body.one(".ke-table-cols");G.thead=G.body.one(".ke-table-head");G.tok=G.body.one(".ke-table-ok");G.tclose=G.body.one(".ke-table-close");G.twidthunit=
G.body.one(".ke-table-width-unit");x.tableDialog=G;G.tok.on("click",x._tableOk,x);G.on("hide",function(){x.selectedTable=null;D.focus()})},_tableOk:function(){this.selectedTable?this._modifyTable():this._genTable()},_modifyTable:function(){var x=this.tableDialog,D=this.selectedTable,G=D.one("caption");a(x.talign.val())&&D.attr("align",k(x.talign.val()));a(x.tcellspacing.val())&&D.attr("cellspacing",k(x.tcellspacing.val()));a(x.tcellpadding.val())&&D.attr("cellpadding",k(x.tcellpadding.val()));a(x.tborder.val())&&
D.attr("border",k(x.tborder.val()));!a(x.tborder.val())||x.tborder.val()=="0"?D.addClass("ke_show_border"):D.remoevClass("ke_show_border");a(x.twidth.val())&&D.css("width",k(x.twidth.val())+x.twidthunit.val());a(x.theight.val())&&D.css("height",k(x.theight.val()));if(a(x.tcaption.val()))G&&G[0]?G.html(k(x.tcaption.val())):(new n("<caption><span>"+k(x.tcaption.val())+"</span></caption>")).insertBefore(D[0].firstChild);else G&&G._4e_remove();x.hide()},_genTable:function(){var x=this.tableDialog,D="<table ",
G,J=parseInt(x.tcols.val()),N=parseInt(x.trows.val()),M=u.ie?"":"<br/>",Q=this.editor;if(t.trim(x.talign.val()).length!=0)D+="align='"+t.trim(x.talign.val())+"' ";if(t.trim(x.tcellspacing.val()).length!=0)D+="cellspacing='"+t.trim(x.tcellspacing.val())+"' ";if(t.trim(x.tcellpadding.val()).length!=0)D+="cellpadding='"+t.trim(x.tcellpadding.val())+"' ";if(t.trim(x.tborder.val()).length!=0)D+="border='"+t.trim(x.tborder.val())+"' ";if(t.trim(x.twidth.val()).length!=0||t.trim(x.theight.val()).length!=
0){D+="style='";if(t.trim(x.twidth.val()).length!=0)D+="width:"+t.trim(x.twidth.val())+x.twidthunit.val()+";";if(t.trim(x.theight.val()).length!=0)D+="height:"+t.trim(x.theight.val())+"px;";D+="' "}if(t.trim(x.tborder.val()).length==0||t.trim(x.tborder.val())=="0")D+="class='ke_show_border' ";D+=">";if(t.trim(x.tcaption.val()))D+="<caption><span>"+t.trim(x.tcaption.val())+"</span></caption>";if(x.thead.val()){D+="<thead>";D+="<tr>";for(G=0;G<J;G++)D+="<th>"+M+"</th>";D+="</tr>";D+="</thead>"}D+="<tbody>";
for(var R=0;R<N;R++){D+="<tr>";for(G=0;G<J;G++)D+="<td>"+M+"</td>";D+="</tr>"}D+="</tbody>";D+="</table>";D=new n(D,null,Q.document);Q.insertElement(D);x.hide()},_fillTableDialog:function(){var x=this.tableDialog,D=this.selectedTable,G=D.one("caption");x.talign.val(D.attr("align")||"");x.tcellspacing.val(D.attr("cellspacing")||"");x.tcellpadding.val(D.attr("cellpadding")||"");x.tborder.val(D.attr("border")|"");var J=D._4e_style("width")||"";x.twidth.val(J.replace(/px|%/i,""));J.indexOf("%")!=-1?x.twidthunit.val("%"):
x.twidthunit.val("px");x.theight.val((D._4e_style("height")||"").replace(/px|%/i,""));J="";if(G)J=G.text();x.tcaption.val(J);x.trows.val(D.one("tbody").children().length);x.tcols.val(D.one("tr").children().length);x.thead.val(D._4e_first(function(N){return N._4e_name()=="thead"})?"1":"")},_realTableShow:function(){if(this.selectedTable){this._fillTableDialog();this.tableDialog.body.all(".ke-table-create-only").attr("disabled","disabled")}else this.tableDialog.body.all(".ke-table-create-only").removeAttr("disabled");
this.tableDialog.show()},_prepareTableShow:function(){this._tableInit()},_tableShow:function(){this._prepareTableShow()}});var C=/^(?:td|th)$/,I={"\u8868\u683c\u5c5e\u6027":function(x){var D=x.getSelection();if(D=(D=D&&D.getStartElement())&&D._4e_ascendant("table",true)){x=x._toolbars.table;x.selectedTable=D;x._tableShow()}},"\u5220\u9664\u8868\u683c":function(x){var D=(x=x.getSelection())&&x.getStartElement();if(D=D&&D._4e_ascendant("table",true)){x.selectElement(D);var G=x.getRanges()[0];G.collapse();
x.selectRanges([G]);x=D.parent();x[0].childNodes.length==1&&x._4e_name()!="body"?x._4e_remove():D._4e_remove()}},"\u5220\u9664\u884c":function(x){x=x.getSelection();o(h(x),r)},"\u5220\u9664\u5217":function(x){x=x.getSelection();(x=d(x))&&o(x,true)},"\u5728\u4e0a\u65b9\u63d2\u5165\u884c":function(x){x=x.getSelection();e(x,true)},"\u5728\u4e0b\u65b9\u63d2\u5165\u884c":function(x){x=x.getSelection();e(x,r)},"\u5728\u5de6\u4fa7\u63d2\u5165\u5217":function(x){x=x.getSelection();s(x,true)},"\u5728\u53f3\u4fa7\u63d2\u5165\u5217":function(x){x=
x.getSelection();s(x,r)}};B.TableUI=p}();y.addPlugin(function(){var p=y.document;new B.TableUI(y);var a=z.create("<style>",null,p);p.getElementsByTagName("head")[0].appendChild(a);if(a.styleSheet)a.styleSheet.cssText=m;else a.appendChild(p.createTextNode(m))})});
KISSY.Editor.add("templates",function(y){var r=KISSY.Editor,B=KISSY,t=B.Node,n=r.TripleButton,z=r.SimpleOverlay;r.TplUI||function(){function q(u){this.editor=u;this._init()}B.augment(q,{_init:function(){(new n({container:this.editor.toolBarDiv,contentCls:"ke-toolbar-template",title:"\u6a21\u677f"})).on("click",this._show,this);r.Utils.lazyRun(this,"_prepare","_real")},_prepare:function(){for(var u=this.editor,f=u.cfg.pluginConfig.templates,g="<div class='ke-tpl'>",i=0;i<f.length;i++)g+="<a href='javascript:void(0)' class='ke-tpl-list' tabIndex='-1'>"+
f[i].demo+"</a>";g+="</div>";this._initDialogOk=true;var l=new z({mask:true,title:"\u5185\u5bb9\u6a21\u677f"});l.body.html(g);g=l.body.all(".ke-tpl-list");l.on("hide",function(){u.focus()});g.on("click",function(v){v.halt();v=(new t(v.target))._4e_index();v!=-1&&u.insertHtml(f[v].html);l.hide()});this.ui=l},_real:function(){this.ui.show()},_show:function(){this._prepare()}});r.TplUI=q}();y.addPlugin(function(){new r.TplUI(y)})});
KISSY.Editor.add("undo",function(y){var r=KISSY.Editor,B=KISSY,t=r.Utils.arrayCompare,n=B.UA,z=B.Event;r.UndoManager||function(){function q(m){var p=m._getRawData();m=p&&m.getSelection();this.contents=p;this.bookmarks=m&&m.createBookmarks2(true)}function u(m,p,a){this.s=m;this.fn=p;this.scope=a||window;this.bufferTimer=null}function f(m){this.history=[];this.index=0;this.editor=m;this.bufferTimer=new u(500,this.save,this);this._init()}function g(m,p,a,c){this.editor=m;this.title=a;this.text=p;this.contentCls=
c;this._init()}B.augment(q,{equals:function(m){if(this.contents!=m.contents)return false;var p=this.bookmarks;m=m.bookmarks;if(p||m){if(!p||!m||p.length!=m.length)return false;for(var a=0;a<p.length;a++){var c=p[a],j=m[a];if(c.startOffset!=j.startOffset||c.endOffset!=j.endOffset||!t(c.start,j.start)||!t(c.end,j.end))return false}}return true}});B.augment(u,{run:function(){if(this.bufferTimer){clearTimeout(this.bufferTimer);this.bufferTimer=null}var m=this;this.bufferTimer=setTimeout(function(){m.fn.call(m.scope)},
this.s)}});var i={16:1,17:1,18:1},l={37:1,38:1,39:1,40:1};B.augment(f,{_keyMonitor:function(){var m=this.editor;z.on(m.document,"keydown",function(p){var a=p.keyCode;if(!(a in l||a in i))if(a===90&&(p.ctrlKey||p.metaKey)){m.fire("restore",{d:-1});p.halt()}else if(a===89&&(p.ctrlKey||p.metaKey)){m.fire("restore",{d:1});p.halt()}else m.fire("save",{buffer:1})})},_init:function(){var m=this,p=m.editor;p.on("save",function(a){a.buffer?m.bufferTimer.run():m.save()});p.on("restore",this.restore,this);m._keyMonitor();
m.save()},save:function(){this.history.length>this.index+1&&this.history.splice(this.index+1,this.history.length-this.index-1);var m=this.editor,p=this.history.length>0?this.history[this.history.length-1]:null,a=new q(this.editor);if(!p||!p.equals(a)){this.history.length===30&&this.history.shift();this.history.push(a);this.index=this.history.length-1;m.fire("afterSave",{history:this.history,index:this.index})}},restore:function(m){m=m.d;var p=this.editor,a=this.history.length>0?this.history[this.index+
m]:null;if(a){p._setRawData(a.contents);if(a.bookmarks)this.editor.getSelection().selectBookmarks(a.bookmarks);else if(n.ie){a=this.editor.document.body.createTextRange();a.collapse(true);a.select()}this.index+=m;p.fire("afterRestore",{history:this.history,index:this.index})}}});var v=r.TripleButton,k={redo:1,undo:-1};B.augment(g,{_init:function(){var m=this,p=m.editor;m.el=new v({contentCls:m.contentCls,title:m.title,container:p.toolBarDiv});this.el.set("state",v.DISABLED);p.on("afterSave",this._respond,
this);p.on("afterRestore",this._respond,this);m.el.on("offClick",function(){p.fire("restore",{d:k[m.text]})})},_respond:function(m){this.updateUI(m.history,m.index)},updateUI:function(m,p){if(this.text=="undo")p>0&&m.length>0?this.el.set("state",v.OFF):this.el.set("state",v.DISABLED);else if(this.text=="redo")p<m.length-1?this.el.set("state",v.OFF):this.el.set("state",v.DISABLED)}});r.UndoManager=f;r.RestoreUI=g}();y.addPlugin(function(){new r.UndoManager(y);new r.RestoreUI(y,"undo","\u64a4\u9500",
"ke-toolbar-undo");new r.RestoreUI(y,"redo","\u91cd\u505a","ke-toolbar-redo")})});
