KISSY.add("editor",function(w,p){function A(t,a){var b=this;if(!(b instanceof A))return new A(t,a);if(w.isString(t))t=w.one(t);t[0]||(t=new Node(t));b.cfg=a;w.app(b,w.EventTarget);b.use=function(g){w.use.call(b,g,function(){b.on("dataReady",function(){b.setData(t.val())})},{order:true,global:A})};b.init(t);return p}function q(t){if(!s)return"build/"+t.replace(/\.(js|css)/i,"-min.$1");if(s==="dev")return t;return"build/"+t}w.app(A,w.EventTarget);A.Config.base=w.Config.base+"editor/";var s=w.Config.debug,
C={htmlparser:{attach:false,path:q("plugins/htmldataprocessor/htmlparser/htmlparser.js")}},m=["utils","focusmanager","definition","dtd","dom","elementpath","walker","range","domiterator","selection","styles"],y=["clipboard",{name:"color",useCss:true},{name:"elementpaths",useCss:true},"enterkey","fakeobjects",{name:"flash",requires:["contextmenu","fakeobjects","overlay"]},"font","format",{name:"htmldataprocessor",requires:["htmlparser-text"]},{name:"image",requires:["overlay"]},"indent","justify",
"link","list","maximize","music","preview","removeformat",{name:"smiley",useCss:true},"sourcearea",{name:"table",useCss:true,requires:["overlay","contextmenu"]},{name:"templates",requires:["overlay"],useCss:true},"undo"],j=[{name:"htmlparser-basicwriter",requires:["htmlparser"]},{name:"htmlparser-element",requires:["htmlparser-fragment"]},{name:"htmlparser-filter",requires:["htmlparser-element"]},{name:"htmlparser-fragment",requires:["htmlparser-htmlwriter"]},{name:"htmlparser-htmlwriter",requires:["htmlparser-basicwriter"]},
{name:"htmlparser-text",requires:["htmlparser-filter"]}],e=[{name:"button"},{name:"overlay",useCss:true},{name:"contextmenu",requires:["overlay"],useCss:true}],i,k,r,v,o;i=0;for(k=e.length;i<k;i++){v=r=e[i];o=p;if(!w.isString(r)){o=r.requires;v=r.name}C[v]={attach:false,requires:o,path:q("ui/"+v+".js"),csspath:r.useCss?q("ui/"+v+".css"):""}}i=0;for(k=y.length;i<k;i++){v=r=y[i];o=["button"];if(!w.isString(r)){r.requires&&(o=o.concat(r.requires));v=r.name}C[v]={attach:false,requires:o,csspath:r.useCss?
q("plugins/"+v+"/plugin.css"):p,path:q("plugins/"+v+"/plugin.js")}}i=0;for(k=j.length;i<k;i++){r=j[i];o=p;if(!w.isString(r)){o=r.requires;r=r.name}C[r]={attach:false,requires:o,path:q("plugins/htmldataprocessor/htmlparser/"+r.substring(11)+".js")}}A.add(C);C={};i=0;for(k=m.length;i<k;i++){r=m[i];C[r]={host:"editor",requires:i>0?m[i-1]:[]}}A.add(C);w.Editor=A});
KISSY.Editor.add("utils",function(w){var p=KISSY,A=p.Node,q=p.DOM,s=p.Config.debug,C=p.UA;w.Utils={getFlashUrl:function(m){var y="",j=w.NODE;if(m._4e_name()=="object"){m=m[0].childNodes;for(var e=0;e<m.length;e++)if(m[e].nodeType==j.NODE_ELEMENT)if((q.attr(m[e],"name")||"").toLowerCase()=="movie")y=q.attr(m[e],"value");else if(q._4e_name(m[e])=="embed")y=q.attr(m[e],"src");else q._4e_name(m[e])=="object"&&q.attr(m[e],"data")}else if(m._4e_name()=="embed")y=m.attr("src");return y},debugUrl:function(m){if(!s)return"build/"+
m.replace(/\.(js|css)/i,"-min.$1");if(s==="dev")return m;return"build/"+m},lazyRun:function(m,y,j){var e=m[y],i=m[j];m[y]=function(){e.apply(this,arguments);m[y]=m[j];return i.apply(this,arguments)}},getXY:function(m,y,j,e){j=j.defaultView||j.parentWindow;m-=q.scrollLeft(j);y-=q.scrollTop(j);if(e)if(j!=(e.defaultView||e.parentWindow)&&j.frameElement){e=q._4e_getOffset(j.frameElement,e);m+=e.left;y+=e.top}return{left:m,top:y}},tryThese:function(){for(var m,y=0,j=arguments.length;y<j;y++){var e=arguments[y];
try{m=e();break}catch(i){}}return m},arrayCompare:function(m,y){if(!m&&!y)return true;if(!m||!y||m.length!=y.length)return false;for(var j=0;j<m.length;j++)if(m[j]!==y[j])return false;return true},getByAddress:function(m,y,j){m=m.documentElement;for(var e=0;m&&e<y.length;e++){var i=y[e];if(j)for(var k=-1,r=0;r<m.childNodes.length;r++){var v=m.childNodes[r];if(!(j===true&&v.nodeType==3&&v.previousSibling&&v.previousSibling.nodeType==3)){k++;if(k==i){m=v;break}}}else m=m.childNodes[i]}return m?new A(m):
null},clearAllMarkers:function(m){for(var y in m)m[y]._4e_clearMarkers(m,true)},htmlEncodeAttr:function(m){return m.replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/,"&gt;")},ltrim:function(m){return m.replace(/^\s+/,"")},rtrim:function(m){return m.replace(/\s+$/,"")},trim:function(m){return this.ltrim(this.rtrim(m))},mix:function(){for(var m={},y=0;y<arguments.length;y++)m=p.mix(m,arguments[y]);return m},isCustomDomain:function(){if(!C.ie)return false;var m=document.domain,y=window.location.hostname;
return m!=y&&m!="["+y+"]"}}});
KISSY.Editor.add("focusmanager",function(w){function p(){this.iframeFocus=true;y=this}function A(){this.iframeFocus=false;y=null}var q=KISSY,s=q.DOM,C=q.Event;q={};var m={},y;q={refreshAll:function(){for(var j in m){var e=m[j];e.document.designMode="off";e.document.designMode="on"}},currentInstance:function(){return y},getInstance:function(j){return m[j]},add:function(j){var e=s._4e_getWin(j.document);C.on(e,"focus",p,j);C.on(e,"blur",A,j)},register:function(j){m[j._UUID]=j},remove:function(j){delete m[j._UUID];
var e=s._4e_getWin(j.document);C.remove(e,"focus",p,j);C.remove(e,"blur",A,j)}};w.focusManager=q});
KISSY.Editor.add("definition",function(w){function p(o){return e+"<html><head><title>kissy-editor</title><link href='"+w.Config.base+i+"' rel='stylesheet'/></head><body class='ke-editor'>&nbsp;</body><html>"+(o?'<script id="ke_actscrpt" type="text/javascript">'+(w.Utils.isCustomDomain()?'document.domain="'+document.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+o+'");<\/script>':"")}var A=KISSY,q=A.UA,s=A.DOM,C=A.Node,m=A.Event,y=w.focusManager,j=w.Utils.tryThese,e="<!doctype html>",i=
w.Utils.debugUrl("assets/editor-iframe.css"),k=1,r="document.open();"+(w.Utils.isCustomDomain()?'document.domain="'+document.domain+'";':"")+"document.close();",v="<div  class='ke-editor-wrap'  > <div class='"+".ke-editor-tools".substring(1)+"'></div><div class='"+".ke-textarea-wrap".substring(1)+'\'><iframe  style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor"  src="'+(q.ie?"javascript:void(function(){"+encodeURIComponent(r)+"}())":"")+'"  tabIndex="'+
(q.webkit?-1:"$(tabIndex)")+'"  allowTransparency="true" ></iframe></div><div class=\''+".ke-editor-status".substring(1)+"'></div></div>";A.augment(w,{init:function(o){var t=this,a=new C(v.replace(/\$\(tabIndex\)/,o.attr("tabIndex")));a.on("mousedown",function(h){if(q.webkit){var d=s._4e_name(h.target);if(d=="select"||d=="option")return true}h.halt()});t.editorWrap=a;t._UUID=k++;y.register(t);t.wrap=a.one(".ke-textarea-wrap");t.iframe=t.wrap.one("iframe");t.toolBarDiv=a.one(".ke-editor-tools");t.textarea=
o;t.statusDiv=a.one(".ke-editor-status");t.toolBarDiv._4e_unselectable();t._commands={};t._plugins={};var b=o._4e_style("width"),g=o._4e_style("height");if(b){a.css("width",b);o.css("width","100%")}t.textarea.css("display","none");a.insertAfter(o);t.wrap[0].appendChild(o[0]);if(g){t.wrap.css("height",g);o.css("height","100%")}o=t.iframe;t.on("dataReady",function(){t.ready=true;w.fire("instanceCreated",{editor:t})});q.gecko?o.on("load",t._setUpIFrame,t):t._setUpIFrame()},addCommand:function(o,t){this._commands[o]=
t},execCommand:function(o){this.fire("save");this._commands[o].exec(this);this.fire("save")},getData:function(){if(w.HtmlDataProcessor)return w.HtmlDataProcessor.toHtml(this.document.body.innerHTML,"p");return this.document.body.innerHTML},setData:function(o){if(w.HtmlDataProcessor)o=w.HtmlDataProcessor.toDataFormat(o,"p");this.document.body.innerHTML=o},sync:function(){this.textarea.val(this.getData())},_getRawData:function(){return this.document.body.innerHTML},_setRawData:function(o){this.document.body.innerHTML=
o},_hideSource:function(){this.iframe.css("display","");this.textarea.css("display","none");this.toolBarDiv.children().css("visibility","");this.statusDiv.children().css("visibility","")},_showSource:function(){this.textarea.css("display","");this.iframe.css("display","none");this.toolBarDiv.children().css("visibility","hidden");this.toolBarDiv.all(".ke-tool-editor-source").css("visibility","");this.statusDiv.children().css("visibility","hidden");q.ie<8&&this.textarea.css("height",this.wrap.css("height"))},
_prepareIFrameHtml:p,getSelection:function(){var o=new w.Selection(this.document);return!o||o.isInvalid?null:o},focus:function(){var o=s._4e_getWin(this.document);q.webkit&&o&&o.parent&&o.parent.focus();o&&o.focus();this.document&&this.document.body.focus();this.notifySelectionChange()},blur:function(){s._4e_getWin(this.document).blur();this.document&&this.document.body.blur()},_setUpIFrame:function(){function o(){h=g.document;t.document=h;a.detach();h.open("text/html","replace");h.write(b);h.close()}
var t=this,a=t.iframe,b=p(t._UUID),g=a[0].contentWindow,h;try{h=g.document}catch(d){a[0].src=a[0].src;if(q.ie&&q.ie<7){setTimeout(o,10);return}}o()},addPlugin:function(o){this.ready?o():this.on("dataReady",o)},_monitor:function(){var o=this;o._monitorId&&clearTimeout(o._monitorId);o._monitorId=setTimeout(function(){var t=o.getSelection();if(t&&!t.isInvalid){t=t.getStartElement();var a=new w.ElementPath(t);if(!o.previousPath||!o.previousPath.compare(a)){o.previousPath=a;o.fire("selectionChange",{selection:o,
path:a,element:t})}}},200)},notifySelectionChange:function(){this.previousPath=null;this._monitor()},insertElement:function(o){var t=this;t.focus();var a=o._4e_name(),b=w.XHTML_DTD,g=w.RANGE,h=w.NODE,d=b.$block[a],l=t.getSelection(),c=l.getRanges(),f,n,z,u,D;t.fire("save");for(var I=c.length-1;I>=0;I--){f=c[I];f.deleteContents();n=!I&&o||o._4e_clone(true);if(d)for(;(u=f.getCommonAncestor(false,true))&&(D=b[u._4e_name()])&&!(D&&D[a]);)if(u._4e_name()in b.span)f.splitElement(u);else if(f.checkStartOfBlock()&&
f.checkEndOfBlock()){f.setStartBefore(u);f.collapse(true);u._4e_remove()}else f.splitBlock();f.insertNode(n);z||(z=n)}f.moveToPosition(z,g.POSITION_AFTER_END);(o=z._4e_nextSourceNode(true))&&o.type==h.NODE_ELEMENT&&f.moveToElementEditablePosition(o);l.selectRanges([f]);t.focus();n&&n._4e_scrollIntoView();setTimeout(function(){t.fire("save")},10)},insertHtml:function(o){if(w.HtmlDataProcessor)o=w.HtmlDataProcessor.toDataFormat(o);if(q.webkit){o=s.create(o,null,this.document);o=o.nodeType==11?A.makeArray(o.childNodes):
[o];for(var t=0;t<o.length;t++)this.insertElement(new C(o[t]))}else{var a=this;a.focus();a.fire("save");t=a.getSelection();if(q.ie){t=t.getNative();t.type=="Control"&&t.clear();t.createRange().pasteHTML(o)}else a.document.execCommand("inserthtml",false,o);a.focus();setTimeout(function(){a.fire("save")},10)}}});w._initIFrame=function(o){function t(u){j(function(){g.designMode="on";setTimeout(function(){g.designMode="off";d.focus();if(!arguments.callee.retry)arguments.callee.retry=true},10)},function(){g.designMode=
"off";s.attr(d,"contentEditable",false);s.attr(d,"contentEditable",true);!u&&t(1)})}var a=y.getInstance(o);o=a.textarea[0];var b=a.iframe[0].contentWindow,g=a.document,h=g.getElementById("ke_actscrpt");h.parentNode.removeChild(h);var d=g.body;if(q.ie){d.hideFocus=true;d.disabled=true;d.contentEditable=true;d.removeAttribute("disabled")}else setTimeout(function(){if(q.gecko||q.opera)d.contentEditable=true;else if(q.webkit)d.parentNode.contentEditable=true;else g.designMode="on"},0);try{g.execCommand("enableObjectResizing",
false,true)}catch(l){}try{g.execCommand("enableInlineTableEditing",false,true)}catch(c){}q.webkit&&m.on(g,"mousedown",function(u){u=new C(u.target);A.inArray(u._4e_name(),["img","hr","input","textarea","select"])&&a.getSelection().selectElement(u)});if(q.webkit){m.on(g,"click",function(u){var D=new C(u.target);A.inArray(D._4e_name(),["input","select"])&&u.preventDefault()});m.on(g,"mouseup",function(u){var D=new C(u.target);A.inArray(D._4e_name(),["input","textarea"])&&u.preventDefault()})}if(q.gecko||
q.ie||q.opera){var f;f=new C(s.insertAfter((new C('<span style="position:absolute; left:-10000"></span>'))[0],o));f.on("focus",function(){a.focus()});a.on("destroy",function(){})}if(q.ie&&g.compatMode=="CSS1Compat"||q.gecko||q.opera){var n=new C(g.documentElement);n.on("mousedown",function(u){if(u.target===n[0]){q.gecko&&t(false);f[0].focus()}})}m.on(b,"focus",function(){if(q.gecko)t(false);else q.opera&&d.focus();a.notifySelectionChange()});q.gecko&&m.on(a.document,"mousedown",function(){a.iframeFocus||
t(false)});if(q.ie){m.on(g,"keydown",function(u){if(u.keyCode in{8:1,46:1}){var D=a.getSelection(),I=D.getSelectedElement();if(I){a.fire("save");var x=D.getRanges()[0].createBookmark();I._4e_remove();D.selectBookmarks([x]);a.fire("save");u.preventDefault()}}});if(g.compatMode=="CSS1Compat"){var z={33:1,34:1};m.on(g,"keydown",function(u){u.keyCode in z&&setTimeout(function(){a.getSelection().scrollIntoView()},0)})}}setTimeout(function(){q.ie&&setTimeout(function(){if(g){d.runtimeStyle.marginBottom=
"0px";d.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){a.fire("dataReady")},10);y.add(a)};q.gecko&&function(){var o=document.body;if(o){var t=o.getAttribute("onpageshow");o.setAttribute("onpageshow",(t?t+";":"")+"event.persisted && KISSY.Editor.focusManager.refreshAll();")}else window.addEventListener("load",arguments.callee,false)}()});
KISSY.Editor.add("dtd",function(w){w.XHTML_DTD=function(){var p=function(l){for(var c=arguments.length-1;c>0;)KISSY.mix(l,arguments[c--]);return l},A={isindex:1,fieldset:1},q={input:1,button:1,select:1,textarea:1,label:1},s=p({a:1},q),C=p({iframe:1},s),m={hr:1,ul:1,menu:1,div:1,blockquote:1,noscript:1,table:1,center:1,address:1,dir:1,pre:1,h5:1,dl:1,h4:1,noframes:1,h6:1,ol:1,h1:1,h3:1,h2:1},y={ins:1,del:1,script:1,style:1},j=p({b:1,acronym:1,bdo:1,"var":1,"#":1,abbr:1,code:1,br:1,i:1,cite:1,kbd:1,
u:1,strike:1,s:1,tt:1,strong:1,q:1,samp:1,em:1,dfn:1,span:1},y),e=p({sub:1,img:1,object:1,sup:1,basefont:1,map:1,applet:1,font:1,big:1,small:1},j),i=p({p:1},e);q=p({iframe:1},e,q);e={img:1,noscript:1,br:1,kbd:1,center:1,button:1,basefont:1,h5:1,h4:1,samp:1,h6:1,ol:1,h1:1,h3:1,h2:1,form:1,font:1,"#":1,select:1,menu:1,ins:1,abbr:1,label:1,code:1,table:1,script:1,cite:1,input:1,iframe:1,strong:1,textarea:1,noframes:1,big:1,small:1,span:1,hr:1,sub:1,bdo:1,"var":1,div:1,object:1,sup:1,strike:1,dir:1,map:1,
dl:1,applet:1,del:1,isindex:1,fieldset:1,ul:1,b:1,acronym:1,a:1,blockquote:1,i:1,u:1,s:1,tt:1,address:1,q:1,pre:1,p:1,em:1,dfn:1};var k=p({a:1},q),r={tr:1},v={"#":1},o=p({param:1},e),t=p({form:1},A,C,m,i),a={li:1},b={base:1,link:1,meta:1,title:1},g=p(b,{style:1,script:1}),h={head:1,body:1},d={address:1,blockquote:1,center:1,dir:1,div:1,dl:1,fieldset:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,isindex:1,menu:1,noframes:1,ol:1,p:1,pre:1,table:1,ul:1};return{$nonBodyContent:p({html:1},h,b),$block:d,
$blockLimit:{body:1,div:1,td:1,th:1,caption:1,form:1},$inline:k,$body:p({script:1,style:1},d),$cdata:{script:1,style:1},$empty:{area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},$listItem:{dd:1,dt:1,li:1},$list:{ul:1,ol:1,dl:1},$nonEditable:{applet:1,button:1,embed:1,iframe:1,map:1,object:1,option:1,script:1,textarea:1,param:1},$removeEmpty:{abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},$tabIndex:{a:1,area:1,button:1,input:1,object:1,select:1,textarea:1},$tableContent:{caption:1,col:1,colgroup:1,tbody:1,td:1,tfoot:1,th:1,thead:1,tr:1},html:h,head:g,style:v,body:t,base:{},link:{},meta:{},title:v,col:{},tr:{td:1,th:1},img:{},colgroup:{col:1},noscript:t,td:t,br:{},th:t,center:t,kbd:k,button:p(i,m),basefont:{},h5:k,h4:k,samp:k,h6:k,ol:a,h1:k,h3:k,option:v,h2:k,form:p(A,C,m,i),select:{optgroup:1,option:1},font:k,ins:k,menu:a,abbr:k,label:k,table:{thead:1,
col:1,tbody:1,tr:1,colgroup:1,caption:1,tfoot:1},code:k,script:v,tfoot:r,cite:k,li:t,input:{},iframe:t,strong:k,textarea:v,noframes:t,big:k,small:k,span:k,hr:{},dt:k,sub:k,optgroup:{option:1},param:{},bdo:k,"var":k,div:t,object:o,sup:k,dd:t,strike:k,area:{},dir:a,map:p({area:1,form:1,p:1},A,y,m),applet:o,dl:{dt:1,dd:1},del:k,isindex:{},fieldset:p({legend:1},e),thead:r,ul:a,acronym:k,b:k,a:q,blockquote:t,caption:k,i:k,u:k,tbody:r,s:k,address:p(C,i),tt:k,legend:k,q:k,pre:p(j,s),p:k,em:k,dfn:k}}()});
KISSY.Editor.add("dom",function(w){function p(a){return a.replace(/-(\w)/g,function(b,g){return g.toUpperCase()})}var A=KISSY,q=A.DOM,s=A.UA,C=A.Node,m=w.Utils,y={abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};w.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_DOCUMENT_FRAGMENT:11};w.POSITION={};var j=w.NODE,e=w.POSITION;e.POSITION_IDENTICAL=0;e.POSITION_DISCONNECTED=1;e.POSITION_FOLLOWING=
2;e.POSITION_PRECEDING=4;e.POSITION_IS_CONTAINED=8;e.POSITION_CONTAINS=16;var i={},k={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},r={hr:1},v=function(a){return a[0]||a},o=function(a){if(!a[0])return new C(a);return a},t={_4e_equals:function(a,b){if(!a&&!b)return true;if(!a||!b)return false;a=v(a);b=v(b);return a===b},_4e_isBlockBoundary:function(a,b){a=o(a);b=
A.mix(A.mix({},r),b||{});return k[a.css("display")]||b[a._4e_name()]},_4e_getWin:function(a){return a&&"scrollTo"in a&&a.document?a:a&&a.nodeType===9?a.defaultView||a.parentWindow:false},_4e_index:function(a){a=v(a);for(var b=a.parentNode.childNodes,g=0;g<b.length;g++)if(b[g]===a)return g;return-1},_4e_first:function(a,b){a=v(a);if((a=(a=a.firstChild)&&new C(a))&&b&&!b(a))a=a._4e_next(b);return a},_4e_move:function(a,b,g){a._4e_remove();a=v(a);b=v(b);g?b.insertBefore(a,b.firstChild):b.appendChild(a)},
_4e_name:function(a){a=v(a);var b=a.nodeName.toLowerCase();if(s.ie)if((a=a.scopeName)&&a!="HTML")b=a.toLowerCase()+":"+b;return b},_4e_isIdentical:function(a,b){if(a._4e_name()!=b._4e_name())return false;var g=a[0].attributes,h=b[0].attributes,d=g.length,l=h.length;if(!s.ie&&d!=l)return false;for(var c=0;c<d;c++){var f=g[c];if((!s.ie||f.specified&&f.nodeName!="_ke_expando")&&f.nodeValue!=b.attr(f.nodeName))return false}if(s.ie)for(c=0;c<l;c++){f=h[c];if(f.specified&&f.nodeName!="_ke_expando"&&f.nodeValue!=
a.attr(f.nodeName))return false}return true},_4e_isEmptyInlineRemoveable:function(a){a=v(a).childNodes;for(var b=0,g=a.length;b<g;b++){var h=a[b],d=h.nodeType;if(!(d==j.NODE_ELEMENT&&h.getAttribute("_ke_bookmark")))if(d==j.NODE_ELEMENT&&!t._4e_isEmptyInlineRemoveable(h)||d==j.NODE_TEXT&&A.trim(h.nodeValue))return false}return true},_4e_moveChildren:function(a,b,g){a=v(a);b=b[0]||b;if(a!=b)if(g)for(;g=a.lastChild;)b.insertBefore(a.removeChild(g),b.firstChild);else for(;g=a.firstChild;)b.appendChild(a.removeChild(g))},
_4e_mergeSiblings:function(){function a(b,g,h){if(g[0]&&g[0].nodeType==j.NODE_ELEMENT){for(var d=[];g.attr("_ke_bookmark")||g._4e_isEmptyInlineRemoveable();){d.push(g);g=h?new C(g[0].nextSibling):new C(g[0].previousSibling);if(!g[0]||g[0].nodeType!=j.NODE_ELEMENT)return}if(b._4e_isIdentical(g)){for(var l=h?b[0].lastChild:b[0].firstChild;d.length;)d.shift()._4e_move(b,!h);g._4e_moveChildren(b,!h);g._4e_remove();l[0]&&l[0].nodeType==j.NODE_ELEMENT&&l._4e_mergeSiblings()}}}return function(b){if(b[0])if(y[b._4e_name()]||
b._4e_name()=="a"){a(b,new C(b[0].nextSibling),true);a(b,new C(b[0].previousSibling))}}}(),_4e_unselectable:s.gecko?function(a){a=v(a);a.style.MozUserSelect="none"}:s.webkit?function(a){a=v(a);a.style.KhtmlUserSelect="none"}:function(a){a=v(a);if(s.ie||s.opera){var b,g=0;for(a.unselectable="on";b=a.all[g++];)switch(b.tagName.toLowerCase()){case "iframe":case "textarea":case "input":case "select":break;default:b.unselectable="on"}}},_4e_getOffset:function(a,b){a=v(a);var g,h=0;g=0;var d=a.ownerDocument.defaultView||
a.ownerDocument.parentWindow,l=a.ownerDocument,c=l.documentElement;b=b||l;if(a.getBoundingClientRect){if(a!==l.body&&c!==a){g=a.getBoundingClientRect();h=g.left+(b===l?q.scrollLeft(d):0);g=g.top+(b===l?q.scrollTop(d):0)}if(b)if(d!=(b.defaultView||b.parentWindow)&&d.frameElement){b=t._4e_getOffset(d.frameElement,b);h+=b.left;g+=b.top}}return{left:h,top:g}},_4e_getFrameDocument:function(a){return(a=v(a))&&a.contentWindow.document},_4e_splitText:function(a,b){a=v(a);var g=a.ownerDocument;if(!(!a||a.nodeType!=
j.NODE_TEXT)){if(s.ie&&b==a.nodeValue.length){g=g.createTextNode("");q.insertAfter(g,a);return g}a=new C(a.splitText(b));if(s.ie==8){g=g.createTextNode("");q.insertAfter(g,a[0]);g.parentNode.removeChild(g)}return a}},_4e_parents:function(a,b){a=o(a);var g=[];do g[b?"push":"unshift"](a);while(a=a.parent());return g},_4e_clone:function(a,b,g){a=v(a);a=a.cloneNode(b);if(!g){var h=function(d){if(d.nodeType==j.NODE_ELEMENT){d.removeAttribute("id",false);d.removeAttribute("_ke_expando",false);d=d.childNodes;
for(var l=0;l<d.length;l++)h(d[l])}};h(a)}return new C(a)},_4e_nextSourceNode:function(a,b,g,h){a=v(a);if(h&&!h.call){var d=h[0]||h;h=function(c){c=c[0]||c;return c!==d}}b=!b&&a.firstChild;var l=new C(a);if(!b){if(a.nodeType==j.NODE_ELEMENT&&h&&h(this,true)===false)return null;b=a.nextSibling}for(;!b&&(l=l.parent());){if(h&&h(l,true)===false)return null;b=l[0].nextSibling}if(!b)return null;b=new C(b);if(h&&h(b)===false)return null;if(g&&g!=b[0].nodeType)return b._4e_nextSourceNode(false,g,h);return b},
_4e_previousSourceNode:function(a,b,g,h){a=v(a);if(h&&!h.call){var d=h[0]||h;h=function(c){c=c[0]||c;return c!==d}}b=!b&&a.lastChild;var l=new C(a);if(!b){if(a.nodeType==j.NODE_ELEMENT&&h&&h(a,true)===false)return null;b=a.previousSibling}for(;!b&&(l=l.parent());){if(h&&h(l,true)===false)return null;b=l[0].previousSibling}if(!b)return null;b=new C(b);if(h&&h(b)===false)return null;if(g&&b[0].nodeType!=g)return b._4e_previousSourceNode(false,g,h);return b},_4e_contains:s.ie||s.webkit?function(a,b){a=
v(a);b=v(b);return b.nodeType!=j.NODE_ELEMENT?a.contains(b.parentNode):a!=b&&a.contains(b)}:function(a,b){a=v(a);b=v(b);return!!(a.compareDocumentPosition(b)&16)},_4e_commonAncestor:function(a,b){if(a._4e_equals(b))return a;if(b[0].nodeType!=j.NODE_TEXT&&b._4e_contains(a))return b;a=a[0].nodeType==j.NODE_TEXT?a.parent():a;do if(a[0].nodeType!=j.NODE_TEXT&&a._4e_contains(b))return a;while(a=a.parent());return null},_4e_ascendant:function(a,b,g){a=v(a);if(!g)a=a.parentNode;if(b&&!A.isFunction(b)){var h=
b;b=function(d){return d._4e_name()==h}}for(;a&&a.nodeType!=9;){if(!b||b(new C(a))===true)return new C(a);a=a.parentNode}return null},_4e_hasAttribute:function(a,b){a=v(a);a=a.attributes.getNamedItem(b);return!!(a&&a.specified)},_4e_hasAttributes:s.ie?function(a){a=v(a);for(var b=a.attributes,g=0;g<b.length;g++){var h=b[g];switch(h.nodeName){case "class":if(a.getAttribute("class"))return true;break;case "_ke_expando":continue;default:if(h.specified)return true}}return false}:function(a){a=v(a);s.gecko&&
a.removeAttribute("_moz_dirty");a=a.attributes;return a.length>1||a.length==1&&a[0].nodeName!="_ke_expando"},_4e_position:function(a,b){var g=v(a),h=v(b);if(g.compareDocumentPosition)return g.compareDocumentPosition(h);if(g==h)return e.POSITION_IDENTICAL;if(g.nodeType==j.NODE_ELEMENT&&h.nodeType==j.NODE_ELEMENT){if(g.contains){if(g.contains(h))return e.POSITION_CONTAINS+e.POSITION_PRECEDING;if(h.contains(g))return e.POSITION_IS_CONTAINED+e.POSITION_FOLLOWING}if("sourceIndex"in g)return g.sourceIndex<
0||h.sourceIndex<0?e.POSITION_DISCONNECTED:g.sourceIndex<h.sourceIndex?e.POSITION_PRECEDING:e.POSITION_FOLLOWING}a=a._4e_address();b=b._4e_address();g=Math.min(a.length,b.length);for(h=0;h<=g-1;h++)if(a[h]!=b[h]){if(h<g)return a[h]<b[h]?e.POSITION_PRECEDING:e.POSITION_FOLLOWING;break}return a.length<b.length?e.POSITION_CONTAINS+e.POSITION_PRECEDING:e.POSITION_IS_CONTAINED+e.POSITION_FOLLOWING},_4e_address:function(a,b){a=v(a);var g=[],h=a.ownerDocument.documentElement;for(a=a;a&&a!=h;){var d=a.parentNode,
l=-1;if(d){for(var c=0;c<d.childNodes.length;c++){var f=d.childNodes[c];if(!(b&&f.nodeType==3&&f.previousSibling&&f.previousSibling.nodeType==3)){l++;if(f==a)break}}g.unshift(l)}a=d}return g},_4e_breakParent:function(a,b){var g=new w.Range(a[0].ownerDocument);g.setStartAfter(a);g.setEndAfter(b);b=g.extractContents();g.insertNode(a._4e_remove());a[0].parentNode.insertBefore(b,a[0].nextSibling)},_4e_style:function(a,b,g){if(g!==undefined)return a.css(b,g);a=a[0]||a;return a.style[p(b)]},_4e_remove:function(a,
b){var g=v(a),h=g.parentNode;if(h){if(b)for(;b=g.firstChild;)h.insertBefore(g.removeChild(b),g);h.removeChild(g)}return a},_4e_trim:function(a){q._4e_ltrim(a);q._4e_rtrim(a)},_4e_ltrim:function(a){a=v(a);for(var b;b=a.firstChild;){if(b.nodeType==j.NODE_TEXT){var g=m.ltrim(b.nodeValue),h=b.nodeValue.length;if(g){if(g.length<h){(new C(b))._4e_splitText(h-g.length);a.removeChild(a.firstChild)}}else{a.removeChild(b);continue}}break}},_4e_rtrim:function(a){a=v(a);for(var b;b=a.lastChild;){if(b.type==j.NODE_TEXT){var g=
m.rtrim(b.nodeValue),h=b.nodeValue.length;if(g){if(g.length<h){(new C(b))._4e_splitText(g.length);a.removeChild(a.lastChild)}}else{a.removeChild(b);continue}}break}if(!s.ie&&!s.opera)(b=a.lastChild)&&b.nodeType==1&&b.nodeName.toLowerCase()=="br"&&b.parentNode.removeChild(b)},_4e_appendBogus:function(a){a=v(a);for(var b=a.lastChild;b&&b.nodeType==j.NODE_TEXT&&!A.trim(b.nodeValue);)b=b.previousSibling;if(!b||b.nodeType==j.NODE_TEXT||q._4e_name(b)!=="br"){b=s.opera?a.ownerDocument.createTextNode(""):
a.ownerDocument.createElement("br");s.gecko&&b.setAttribute("type","_moz");a.appendChild(b)}},_4e_previous:function(a,b){a=v(a);var g;do g=(a=a.previousSibling)&&new C(a);while(g&&b&&!b(g));return g},_4e_last:function(a,b){if((a=(a=a[0].lastChild)&&new C(a))&&b&&!b(a))a=a._4e_previous(b);return a},_4e_next:function(a,b){a=v(a);var g;do g=(a=a.nextSibling)&&new C(a);while(g&&b&&!b(g));return g},_4e_outerHtml:function(a){a=v(a);if(a.outerHTML)return a.outerHTML.replace(/<\?[^>]*>/,"");var b=a.ownerDocument.createElement("div");
b.appendChild(a.cloneNode(true));return b.innerHTML},_4e_setMarker:function(a,b,g,h){a[0]||(a=new C(a));var d=a._4e_getData("list_marker_id")||a._4e_setData("list_marker_id",A.guid())._4e_getData("list_marker_id"),l=a._4e_getData("list_marker_names")||a._4e_setData("list_marker_names",{})._4e_getData("list_marker_names");b[d]=a;l[g]=1;return a._4e_setData(g,h)},_4e_clearMarkers:function(a,b,g){a=o(a);var h=a._4e_getData("list_marker_names"),d=a._4e_getData("list_marker_id");for(var l in h)a._4e_removeData(l);
a._4e_removeData("list_marker_names");if(g){a._4e_removeData("list_marker_id");delete b[d]}},_4e_setData:function(a,b,g){var h=q._4e_getUniqueId(a);(i[h]||(i[h]={}))[b]=g;return a},_4e_getData:function(a,b){a=v(a);return(a=(a=a.getAttribute("_ke_expando"))&&i[a])&&a[b]},_4e_removeData:function(a,b){a=v(a);var g=a.getAttribute("_ke_expando");var h=(g=g&&i[g])&&g[b];typeof h!="undefined"&&g&&delete g[b];A.isEmptyObject(g)&&q._4e_clearData(a);return h||null},_4e_clearData:function(a){a=v(a);var b=a.getAttribute("_ke_expando");
b&&delete i[b];b&&a.removeAttribute("_ke_expando")},_4e_getUniqueId:function(a){a=v(a);var b=a.getAttribute("_ke_expando");if(b)return b;b=A.guid();a.setAttribute("_ke_expando",b);return b},_4e_copyAttributes:function(a,b,g){a=v(a);var h=a.attributes;g=g||{};for(var d=0;d<h.length;d++){var l=h[d],c=l.nodeName.toLowerCase(),f;if(!(c in g))if(c=="checked"&&(f=q.attr(a,c)))b.attr(c,f);else if(l.specified||s.ie&&l.nodeValue&&c=="value"){f=q.attr(a,c);if(f===null)f=l.nodeValue;b.attr(c,f)}}if(a.style.cssText!==
"")b[0].style.cssText=a.style.cssText},_4e_isEditable:function(a){a=q._4e_name(a);var b=w.XHTML_DTD;return(a=!b.$nonEditable[a]&&(b[a]||b.span))&&a["#"]},_4e_scrollIntoView:function(a){a=o(a);var b=a[0].ownerDocument,g=q.scrollLeft(b),h=q.scrollTop(b),d=a.offset(),l=d.left;d=d.top;if(q.viewportHeight(b)+h<d||d<h||q.viewportWidth(b)+g<l||l<g)a.scrollIntoView(b)},_4e_getElementsByTagName:function(a,b,g){a=v(a);if(!s.ie&&g)b=g+":"+b;g=[];a=a.getElementsByTagName(b);for(b=0;b<a.length;b++)g.push(new C(a[b]));
return g}};A.DOM._4e_inject=function(a){A.mix(q,a);for(var b in a)a.hasOwnProperty(b)&&function(g){C.prototype[g]=function(){var h=[].slice.call(arguments,0);h.unshift(this);return a[g].apply(null,h)}}(b)};A.DOM._4e_inject(t)});
KISSY.Editor.add("elementpath",function(w){function p(i){var k=null,r=null,v=[];for(i=i;i&&i[0];){if(i[0].nodeType==C.NODE_ELEMENT){if(!this.lastElement)this.lastElement=i;var o=i._4e_name();if(m.ie&&i[0].scopeName!="HTML")o=i[0].scopeName.toLowerCase()+":"+o;if(!r){if(!k&&y[o])k=i;if(j[o])if(!k&&o=="div"&&!e(i))k=i;else r=i}v.push(i);if(o=="body")break}i=i.parent()}this.block=k;this.blockLimit=r;this.elements=v}var A=KISSY,q=A.DOM,s=w.XHTML_DTD,C=w.NODE,m=A.UA,y={address:1,blockquote:1,dl:1,h1:1,
h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},j={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1},e=function(i){i=i[0]||i;i=i.childNodes;for(var k=0,r=i.length;k<r;k++){var v=i[k];if(v.nodeType==C.NODE_ELEMENT&&s.$block[v.nodeName.toLowerCase()])return true}return false};p.prototype={compare:function(i){var k=this.elements;i=i&&i.elements;if(!i||k.length!=i.length)return false;for(var r=0;r<k.length;r++)if(!q._4e_equals(k[r],i[r]))return false;return true},contains:function(i){for(var k=
this.elements,r=0;r<k.length;r++)if(k[r]._4e_name()in i)return k[r];return null}};w.ElementPath=p});
KISSY.Editor.add("walker",function(w){function p(j,e){if(this._.end)return null;var i=this.range,k,r=this.guard,v=this.type,o=j?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start){this._.start=1;i.trim();if(i.collapsed){this.end();return null}}if(!j&&!this._.guardLTR){var t=i.endContainer,a=new y(t[0].childNodes[i.endOffset]);this._.guardLTR=function(d,l){return(!l||!m._4e_equals(t,d))&&(!a[0]||d[0]!==a[0])&&(d[0].nodeType!=C.NODE_ELEMENT||!l||d._4e_name()!="body")}}if(j&&!this._.guardRTL){var b=
i.startContainer,g=i.startOffset>0&&new y(b[0].childNodes[i.startOffset-1]);this._.guardRTL=function(d,l){return d&&d[0]&&(!l||b[0]!==d[0])&&(!g[0]||d[0]!==g[0])&&(d[0].nodeType!=C.NODE_ELEMENT||!l||d._4e_name()!="body")}}var h=j?this._.guardRTL:this._.guardLTR;k=r?function(d,l){if(h(d,l)===false)return false;return r(d,l)}:h;if(this.current)j=this.current[o](false,v,k);else if(j){j=i.endContainer;if(i.endOffset>0){j=new y(j[0].childNodes[i.endOffset-1]);if(k(j)===false)j=null}else j=k(j,true)===
false?null:j._4e_previousSourceNode(true,v,k)}else{j=i.startContainer;if((j=new y(j[0].childNodes[i.startOffset]))&&j[0]){if(k(j)===false)j=null}else j=k(i.startContainer,true)===false?null:i.startContainer._4e_nextSourceNode(true,v,k)}for(;j&&j[0]&&!this._.end;){this.current=j;if(!this.evaluator||this.evaluator(j)!==false){if(!e)return j}else if(e&&this.evaluator)return false;j=j[o](false,v,k)}this.end();return this.current=null}function A(j){for(var e,i=null;e=p.call(this,j);)i=e;return i}function q(j){this.range=
j;this._={}}var s=KISSY,C=w.NODE,m=s.DOM,y=s.Node;s.augment(q,{end:function(){this._.end=1},next:function(){return p.call(this)},previous:function(){return p.call(this,true)},checkForward:function(){return p.call(this,false,true)!==false},checkBackward:function(){return p.call(this,true,true)!==false},lastForward:function(){return A.call(this)},lastBackward:function(){return A.call(this,true)},reset:function(){delete this.current;this._={}}});q.blockBoundary=function(j){return function(e){e[0]||(e=
new y(e));return!(e[0].nodeType==C.NODE_ELEMENT&&e._4e_isBlockBoundary(j))}};q.listItemBoundary=function(){return this.blockBoundary({br:1})};q.bookmark=function(j,e){function i(k){return k&&k[0]&&k._4e_name()=="span"&&k.attr("_ke_bookmark")}return function(k){var r,v;r=k&&k[0]&&k[0].nodeType==C.NODE_TEXT&&(v=k.parent())&&i(v);r=j?r:r||i(k);return e^r}};q.whitespaces=function(j){return function(e){e=(e=e[0]||e)&&e.nodeType==C.NODE_TEXT&&!s.trim(e.nodeValue);return j^e}};q.invisible=function(j){var e=
q.whitespaces();return function(i){i=e(i)||i[0].nodeType==C.NODE_ELEMENT&&!i[0].offsetHeight;return j^i}};w.Walker=q});
KISSY.Editor.add("range",function(w){function p(c){this.endOffset=this.endContainer=this.startOffset=this.startContainer=null;this.collapsed=true;this.document=c}function A(c){var f=c[0].nodeType!=j.NODE_TEXT&&c._4e_name()in t.$removeEmpty,n=!y.trim(c[0].nodeValue);c=!!c.parent().attr("_ke_bookmark");return f||n||c}function q(c){return!d(c)&&!l(c)}function s(c){var f=false,n=k.bookmark(true);return function(z){if(n(z))return true;if(z[0].nodeType==j.NODE_TEXT){if(y.trim(z[0].nodeValue).length)return false}else if(z[0].nodeType==
j.NODE_ELEMENT)if(!h[z._4e_name()])if(!c&&!o.ie&&z._4e_name()=="br"&&!f)f=true;else return false;return true}}function C(c,f){function n(z){return z&&z.nodeName=="span"&&z.getAttribute("_ke_bookmark")}return function(z){var u,D;u=z&&!z.nodeName&&(D=z.parentNode)&&n(D);u=c?u:u||n(z);return f^u}}function m(c){return function(f){f=(f=f[0]||f)&&f.nodeType==j.NODE_TEXT&&!y.trim(f.nodeValue);return c^f}}w.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,
ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,STARTEND:3,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var y=KISSY,j=w.NODE,e=w.RANGE,i=w.POSITION,k=w.Walker,r=y.DOM,v=w.Utils.getByAddress,o=y.UA,t=w.XHTML_DTD,a=w.ElementPath,b=y.Node,g={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1};p.prototype.toString=function(){var c=[];c.push((this.startContainer[0].id||this.startContainer[0].nodeName)+":"+this.startOffset);c.push((this.endContainer[0].id||this.endContainer[0].nodeName)+
":"+this.endOffset);return c.join("<br/>")};y.augment(p,{updateCollapsed:function(){this.collapsed=this.startContainer&&this.endContainer&&r._4e_equals(this.startContainer,this.endContainer)&&this.startOffset==this.endOffset},optimize:function(){var c=this.startContainer,f=this.startOffset;if(c[0].nodeType!=j.NODE_ELEMENT)if(f)f>=c[0].nodeValue.length&&this.setStartAfter(c);else this.setStartBefore(c);c=this.endContainer;f=this.endOffset;if(c[0].nodeType!=j.NODE_ELEMENT)if(f)f>=c[0].nodeValue.length&&
this.setEndAfter(c);else this.setEndBefore(c)},setStartAfter:function(c){this.setStart(c.parent(),c._4e_index()+1)},setStartBefore:function(c){this.setStart(c.parent(),c._4e_index())},setEndAfter:function(c){this.setEnd(c.parent(),c._4e_index()+1)},setEndBefore:function(c){this.setEnd(c.parent(),c._4e_index())},optimizeBookmark:function(){var c=this.startContainer,f=this.endContainer;c&&c._4e_name()=="span"&&c.attr("_ke_bookmark")&&this.setStartAt(c,e.POSITION_BEFORE_START);f&&f._4e_name()=="span"&&
f.attr("_ke_bookmark")&&this.setEndAt(f,e.POSITION_AFTER_END)},setStart:function(c,f){if(c[0].nodeType==j.NODE_ELEMENT&&g[c._4e_name()]){c=c.parent();f=c._4e_index()}this.startContainer=c;this.startOffset=f;if(!this.endContainer){this.endContainer=c;this.endOffset=f}this.updateCollapsed()},setEnd:function(c,f){if(c[0].nodeType==j.NODE_ELEMENT&&g[c._4e_name()]){c=c.parent();f=c._4e_index()+1}this.endContainer=c;this.endOffset=f;if(!this.startContainer){this.startContainer=c;this.startOffset=f}this.updateCollapsed()},
setStartAt:function(c,f){switch(f){case e.POSITION_AFTER_START:this.setStart(c,0);break;case e.POSITION_BEFORE_END:c[0].nodeType==j.NODE_TEXT?this.setStart(c,c[0].nodeValue.length):this.setStart(c,c[0].childNodes.length);break;case e.POSITION_BEFORE_START:this.setStartBefore(c);break;case e.POSITION_AFTER_END:this.setStartAfter(c)}this.updateCollapsed()},setEndAt:function(c,f){switch(f){case e.POSITION_AFTER_START:this.setEnd(c,0);break;case e.POSITION_BEFORE_END:c[0].nodeType==j.NODE_TEXT?this.setEnd(c,
c[0].nodeValue.length):this.setEnd(c,c[0].childNodes.length);break;case e.POSITION_BEFORE_START:this.setEndBefore(c);break;case e.POSITION_AFTER_END:this.setEndAfter(c)}this.updateCollapsed()},execContentsAction:function(c,f){var n=this.startContainer,z=this.endContainer,u=this.startOffset,D=this.endOffset,I,x;this.optimizeBookmark();if(z[0].nodeType==j.NODE_TEXT)z=z._4e_splitText(D);else if(z[0].childNodes.length>0)if(D>=z[0].childNodes.length){z=new b(z[0].appendChild(this.document.createTextNode("")));
x=true}else z=new b(z[0].childNodes[D]);if(n[0].nodeType==j.NODE_TEXT){n._4e_splitText(u);if(r._4e_equals(n,z))z=new b(n[0].nextSibling)}else if(u)if(u>=n[0].childNodes.length){I=new b(this.document.createTextNode(""));n[0].appendChild(I[0]);n=I;I=true}else n=new b(n[0].childNodes[u].previousSibling);else{I=new b(this.document.createTextNode(""));r.insertBefore(I[0],n[0].firstChild);n=I;I=true}u=n._4e_parents();D=z._4e_parents();var B,H,J;for(B=0;B<u.length;B++){H=u[B];J=D[B];if(H[0]!==J[0])break}for(var N=
f,M,Q,R,W=B;W<u.length;W++){M=u[W];if(N&&M[0]!==n[0])Q=N.appendChild(M._4e_clone()[0]);for(M=M[0].nextSibling;M;){if(D[W]&&M==D[W][0]||M==z[0])break;R=M.nextSibling;if(c==2)N.appendChild(M.cloneNode(true));else{M.parentNode.removeChild(M);c==1&&N.appendChild(M)}M=R}if(Q)N=Q}N=f;for(f=B;f<D.length;f++){M=D[f];if(c>0&&M[0]!==z[0])Q=N.appendChild(M._4e_clone()[0]);if(!u[f]||M[0].parentNode!==u[f][0].parentNode)for(M=M[0].previousSibling;M;){if(u[f]&&M==u[f][0]||M===n[0])break;R=M.previousSibling;if(c==
2)N.insertBefore(M.cloneNode(true),N.firstChild);else{M.parentNode.removeChild(M);c==1&&N.insertBefore(M,N.firstChild)}M=R}if(Q)N=Q}if(c==2){J=this.startContainer[0];if(J.nodeType==j.NODE_TEXT&&J.nextSibling&&J.nextSibling.nodeType==j.NODE_TEXT){J.data+=J.nextSibling.data;J.parentNode.removeChild(J.nextSibling)}J=this.endContainer[0];if(J.nodeType==j.NODE_TEXT&&J.nextSibling&&J.nextSibling.nodeType==j.NODE_TEXT){J.data+=J.nextSibling.data;J.parentNode.removeChild(J.nextSibling)}}else{if(H&&J&&(n[0].parentNode!=
H[0].parentNode||z[0].parentNode!=J[0].parentNode)){c=J._4e_index();I&&J[0].parentNode==n[0].parentNode&&c--;this.setStart(J.parent(),c)}this.collapse(true)}I&&n._4e_remove();x&&z[0].parentNode&&z._4e_remove()},collapse:function(c){if(c){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=this.endOffset}this.collapsed=true},clone:function(){var c=new p(this.document);c.startContainer=this.startContainer;c.startOffset=this.startOffset;
c.endContainer=this.endContainer;c.endOffset=this.endOffset;c.collapsed=this.collapsed;return c},getEnclosedNode:function(){var c=this.clone();c.optimize();if(c.startContainer[0].nodeType!=j.NODE_ELEMENT||c.endContainer[0].nodeType!=j.NODE_ELEMENT)return null;c=c.startContainer[0].childNodes[c.startOffset];for(var f=C(true,undefined),n=m(true),z=function(u){return n(u)&&f(u)};c&&z(c);)c=(new b(c))._4e_nextSourceNode()[0];return new b(c)},shrink:function(c,f){if(!this.collapsed){c=c||e.SHRINK_TEXT;
var n=this.clone(),z=this.startContainer,u=this.endContainer,D=this.startOffset,I=this.endOffset,x=1,B=1;if(z&&z[0].nodeType==j.NODE_TEXT)if(D)if(D>=z[0].nodeValue.length)n.setStartAfter(z);else{n.setStartBefore(z);x=0}else n.setStartBefore(z);if(u&&u[0].nodeType==j.NODE_TEXT)if(I)if(I>=u[0].nodeValue.length)n.setEndAfter(u);else{n.setEndAfter(u);B=0}else n.setEndBefore(u);n=new k(n);n.evaluator=function(J){J=J[0]||J;return J.nodeType==(c==e.SHRINK_ELEMENT?j.NODE_ELEMENT:j.NODE_TEXT)};var H;n.guard=
function(J,N){J=J[0]||J;if(c==e.SHRINK_ELEMENT&&J.nodeType==j.NODE_TEXT)return false;if(N&&J==H)return false;if(!N&&J.nodeType==j.NODE_ELEMENT)H=J;return true};if(x)(z=n[c==e.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(z,f?e.POSITION_AFTER_START:e.POSITION_BEFORE_START);if(B){n.reset();(n=n[c==e.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(n,f?e.POSITION_BEFORE_END:e.POSITION_AFTER_END)}return!!(x||B)}},getTouchedStartNode:function(){var c=this.startContainer;if(this.collapsed||
c[0].nodeType!=j.NODE_ELEMENT)return c;return c.childNodes[this.startOffset]||c},createBookmark2:function(c){var f=this.startContainer,n=this.endContainer,z=this.startOffset,u=this.endOffset,D,I;if(!f||!n)return{start:0,end:0};if(c){if(f[0].nodeType==j.NODE_ELEMENT)if((D=new b(f[0].childNodes[z]))&&D[0]&&D[0].nodeType==j.NODE_TEXT&&z>0&&D[0].previousSibling.nodeType==j.NODE_TEXT){f=D;z=0}for(;f[0].nodeType==j.NODE_TEXT&&(I=f._4e_previous())&&I[0].nodeType==j.NODE_TEXT;){f=I;z+=I[0].nodeValue.length}if(!this.collapsed){if(n[0].nodeType==
j.NODE_ELEMENT)if((D=new b(n[0].childNodes[u]))&&D[0]&&D[0].nodeType==j.NODE_TEXT&&u>0&&D[0].previousSibling.nodeType==j.NODE_TEXT){n=D;u=0}for(;n[0].nodeType==j.NODE_TEXT&&(I=n._4e_previous())&&I[0].nodeType==j.NODE_TEXT;){n=I;u+=I[0].nodeValue.length}}}return{start:f._4e_address(c),end:this.collapsed?null:n._4e_address(c),startOffset:z,endOffset:u,normalized:c,is2:true}},createBookmark:function(c){var f,n,z,u;f=new b("<span></span>",null,this.document);f.attr("_ke_bookmark",1);f.css("display","none");
f.html("&nbsp;");if(c){z=y.guid("ke_bm_");f.attr("id",z+"S")}if(!this.collapsed){n=f._4e_clone();n.html("&nbsp;");c&&n.attr("id",z+"E");u=this.clone();u.collapse();u.insertNode(n)}u=this.clone();u.collapse(true);u.insertNode(f);if(n){this.setStartAfter(f);this.setEndBefore(n)}else this.moveToPosition(f,e.POSITION_AFTER_END);return{startNode:c?z+"S":f,endNode:c?z+"E":n,serializable:c}},moveToPosition:function(c,f){this.setStartAt(c,f);this.collapse(true)},trim:function(c,f){var n=this.startContainer,
z=this.startOffset,u=this.collapsed;if((!c||u)&&n[0]&&n[0].nodeType==j.NODE_TEXT){if(z)if(z>=n[0].nodeValue.length){z=n._4e_index()+1;n=n.parent()}else{c=n._4e_splitText(z);z=n._4e_index()+1;n=n.parent();if(r._4e_equals(this.startContainer,this.endContainer))this.setEnd(c,this.endOffset-this.startOffset);else if(r._4e_equals(n,this.endContainer))this.endOffset+=1}else{z=n._4e_index();n=n.parent()}this.setStart(n,z);if(u){this.collapse(true);return}}n=this.endContainer;z=this.endOffset;if(!(f||u)&&
n[0]&&n[0].nodeType==j.NODE_TEXT){if(z){z>=n.nodeValue.length||n._4e_splitText(z);z=n._4e_index()+1}else z=n._4e_index();n=n.parent();this.setEnd(n,z)}},insertNode:function(c){this.optimizeBookmark();this.trim(false,true);var f=this.startContainer,n=f[0].childNodes[this.startOffset];this.optimizeBookmark();this.trim(false,true);n?r.insertBefore(c[0]||c,n):f[0].appendChild(c[0]||c);r._4e_equals(c.parent(),this.endContainer)&&this.endOffset++;this.setStartBefore(c)},moveToBookmark:function(c){if(c.is2){var f=
v(this.document,c.start,c.normalized),n=c.startOffset,z=c.end&&v(this.document,c.end,c.normalized);c=c.endOffset;this.setStart(f,n);z?this.setEnd(z,c):this.collapse(true)}else{f=(n=c.serializable)?y.one("#"+c.startNode,this.document):c.startNode;c=n?y.one("#"+c.endNode,this.document):c.endNode;this.setStartBefore(f);f._4e_remove();if(c&&c[0]){this.setEndBefore(c);c._4e_remove()}else this.collapse(true)}},getCommonAncestor:function(c,f){var n=this.startContainer,z=this.endContainer;c=r._4e_equals(n,
z)?c&&n[0].nodeType==j.NODE_ELEMENT&&this.startOffset==this.endOffset-1?new b(n[0].childNodes[this.startOffset]):n:n._4e_commonAncestor(z);return f&&c[0].nodeType==j.NODE_TEXT?c.parent():c},enlarge:function(c){switch(c){case e.ENLARGE_ELEMENT:if(this.collapsed)return;c=this.getCommonAncestor();var f=new b(this.document.body),n,z,u,D,I,x=false,B,H;B=this.startContainer;H=this.startOffset;if(B[0].nodeType==j.NODE_TEXT){if(H){B=!y.trim(B[0].nodeValue.substring(0,H)).length&&B;x=!!B}if(B)if(!(D=B[0].previousSibling))u=
B.parent()}else{if(H)D=B[0].childNodes[H-1]||B[0].lastChild;D||(u=B)}for(;u||D;){if(u&&!D){if(!I&&r._4e_equals(u,c))I=true;if(!f._4e_contains(u))break;if(!x||u.css("display")!="inline"){x=false;if(I)n=u;else this.setStartBefore(u)}D=u[0].previousSibling}for(;D;){B=false;if(D.nodeType==j.NODE_TEXT){H=D.nodeValue;if(/[^\s\ufeff]/.test(H))D=null;B=/[\s\ufeff]$/.test(H)}else if(D.offsetWidth>0&&!D.getAttribute("_ke_bookmark"))if(x&&t.$removeEmpty[D.nodeName.toLowerCase()]){H=r.text(D);if(/[^\s\ufeff]/.test(H))D=
null;else for(var J=D.all||D.getElementsByTagName("*"),N=0,M;M=J[N++];)if(!t.$removeEmpty[M.nodeName.toLowerCase()]){D=null;break}if(D)B=!!H.length}else D=null;if(B)if(x)if(I)n=u;else u&&this.setStartBefore(u);else x=true;if(D){B=D.previousSibling;if(!u&&!B){u=new b(D);D=null;break}D=B}else u=null}if(u)u=u.parent()}B=this.endContainer;H=this.endOffset;u=D=null;I=x=false;if(B[0].nodeType==j.NODE_TEXT){B=!y.trim(B[0].nodeValue.substring(H)).length&&B;x=!(B&&B[0].nodeValue.length);if(B)if(!(D=B[0].nextSibling))u=
B.parent()}else(D=B[0].childNodes[H])||(u=B);for(;u||D;){if(u&&!D){if(!I&&r._4e_equals(u,c))I=true;if(!f._4e_contains(u))break;if(!x||u.css("display")!="inline"){x=false;if(I)z=u;else u&&this.setEndAfter(u)}D=u[0].nextSibling}for(;D;){B=false;if(D.nodeType==j.NODE_TEXT){H=D.nodeValue;if(/[^\s\ufeff]/.test(H))D=null;B=/^[\s\ufeff]/.test(H)}else if(D.offsetWidth>0&&!D.getAttribute("_ke_bookmark"))if(x&&t.$removeEmpty[D.nodeName.toLowerCase()]){H=r.text(D);if(/[^\s\ufeff]/.test(H))D=null;else{J=D.all||
D.getElementsByTagName("*");for(N=0;M=J[N++];)if(!t.$removeEmpty[M.nodeName.toLowerCase()]){D=null;break}}if(D)B=!!H.length}else D=null;if(B)if(x)if(I)z=u;else this.setEndAfter(u);if(D){B=D.nextSibling;if(!u&&!B){u=new b(D);D=null;break}D=B}else u=null}if(u)u=u.parent()}if(n&&z){c=n._4e_contains(z)?z:n;this.setStartBefore(c);this.setEndAfter(c)}break;case e.ENLARGE_BLOCK_CONTENTS:case e.ENLARGE_LIST_ITEM_CONTENTS:u=new p(this.document);f=new b(this.document.body);u.setStartAt(f,e.POSITION_AFTER_START);
u.setEnd(this.startContainer,this.startOffset);u=new k(u);var Q,R,W=k.blockBoundary(c==e.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:null),$=function(aa){var E=W(aa);E||(Q=aa);return E};n=function(aa){var E=$(aa);if(!E&&aa[0]&&aa._4e_name()=="br")R=aa;return E};u.guard=$;u=u.lastBackward();Q=Q||f;this.setStartAt(Q,Q._4e_name()!="br"&&(!u&&this.checkStartOfBlock()||u&&Q._4e_contains(u))?e.POSITION_AFTER_START:e.POSITION_AFTER_END);u=this.clone();u.collapse();u.setEndAt(f,e.POSITION_BEFORE_END);u=new k(u);u.guard=
c==e.ENLARGE_LIST_ITEM_CONTENTS?n:$;Q=null;u=u.lastForward();Q=Q||f;this.setEndAt(Q,!u&&this.checkEndOfBlock()||u&&Q._4e_contains(u)?e.POSITION_BEFORE_END:e.POSITION_BEFORE_START);R&&this.setEndAfter(R)}},checkStartOfBlock:function(){var c=this.startContainer,f=this.startOffset;if(f&&c[0].nodeType==j.NODE_TEXT)if(y.trim(c[0].nodeValue.substring(0,f)).length)return false;this.trim();c=new a(this.startContainer);f=this.clone();f.collapse(true);f.setStartAt(c.block||c.blockLimit,e.POSITION_AFTER_START);
c=new k(f);c.evaluator=s(true);return c.checkBackward()},checkEndOfBlock:function(){var c=this.endContainer,f=this.endOffset;if(c[0].nodeType==j.NODE_TEXT)if(y.trim(c[0].nodeValue.substring(f)).length)return false;this.trim();c=new a(this.endContainer);f=this.clone();f.collapse(false);f.setEndAt(c.block||c.blockLimit,e.POSITION_BEFORE_END);c=new k(f);c.evaluator=s(false);return c.checkForward()},deleteContents:function(){this.collapsed||this.execContentsAction(0)},extractContents:function(){var c=
this.document.createDocumentFragment();this.collapsed||this.execContentsAction(1,c);return c},checkBoundaryOfElement:function(c,f){var n=this.clone();n[f==e.START?"setStartAt":"setEndAt"](c,f==e.START?e.POSITION_AFTER_START:e.POSITION_BEFORE_END);c=new k(n);c.evaluator=A;return c[f==e.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var c=this.startContainer,f=this.endContainer,n=this.startOffset,z=this.endOffset,u;if(c[0].nodeType==j.NODE_ELEMENT){u=c[0].childNodes.length;if(u>
n)c=new b(c[0].childNodes[n]);else if(u<1)c=c._4e_previousSourceNode();else{for(c=c[0];c.lastChild;)c=c.lastChild;c=new b(c);c=c._4e_nextSourceNode()||c}}if(f[0].nodeType==j.NODE_ELEMENT){u=f[0].childNodes.length;if(u>z)f=(new b(f[0].childNodes[z]))._4e_previousSourceNode(true);else if(u<1)f=f._4e_previousSourceNode();else{for(f=f[0];f.lastChild;)f=f.lastChild;f=new b(f)}}if(c._4e_position(f)&i.POSITION_FOLLOWING)c=f;return{startNode:c,endNode:f}},fixBlock:function(c,f){var n=this.createBookmark();
f=new b(this.document.createElement(f));this.collapse(c);this.enlarge(e.ENLARGE_BLOCK_CONTENTS);f[0].appendChild(this.extractContents());f._4e_trim();o.ie||f._4e_appendBogus();this.insertNode(f);this.moveToBookmark(n);return f},splitBlock:function(c){var f=new a(this.startContainer),n=new a(this.endContainer),z=f.block,u=n.block,D=null;if(f.blockLimit[0]!==n.blockLimit[0])return null;if(c!="br"){if(!z){z=this.fixBlock(true,c);u=(new a(this.endContainer)).block}u||(u=this.fixBlock(false,c))}c=z&&this.checkStartOfBlock();
f=u&&this.checkEndOfBlock();this.deleteContents();if(z&&r._4e_equals(z,u))if(f){D=new a(this.startContainer);this.moveToPosition(u,e.POSITION_AFTER_END);u=null}else if(c){D=new a(this.startContainer);this.moveToPosition(z,e.POSITION_BEFORE_START);z=null}else{u=this.splitElement(z);!o.ie&&!y.inArray(z._4e_name(),["ul","ol"])&&z._4e_appendBogus()}return{previousBlock:z,nextBlock:u,wasStartOfBlock:c,wasEndOfBlock:f,elementPath:D}},splitElement:function(c){if(!this.collapsed)return null;this.setEndAt(c,
e.POSITION_BEFORE_END);var f=this.extractContents(),n=c._4e_clone(false);n[0].appendChild(f);n.insertAfter(c);this.moveToPosition(c,e.POSITION_AFTER_END);return n},moveToElementEditablePosition:function(c,f){var n,z=w.XHTML_DTD;if(z.$empty[c._4e_name()])return false;for(;c&&c[0].nodeType==j.NODE_ELEMENT;){if(n=c._4e_isEditable())this.moveToPosition(c,f?e.POSITION_BEFORE_END:e.POSITION_AFTER_START);else if(z.$inline[c._4e_name()]){this.moveToPosition(c,f?e.POSITION_AFTER_END:e.POSITION_BEFORE_START);
return true}if((c=z.$empty[c._4e_name()]?c[f?"_4e_previous":"_4e_next"](q):c[f?"_4e_last":"_4e_first"](q))&&c[0].nodeType==j.NODE_TEXT){this.moveToPosition(c,f?e.POSITION_AFTER_END:e.POSITION_BEFORE_START);return true}}return n},selectNodeContents:function(c){this.setStart(c,0);this.setEnd(c,c[0].nodeType==j.NODE_TEXT?c[0].nodeValue.length:c[0].childNodes.length)}});var h={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},d=new k.whitespaces,l=new k.bookmark;w.Range=p});
KISSY.Editor.add("domiterator",function(w){function p(v){if(!(arguments.length<1)){this.range=v;this.forceBrBreak=false;this.enlargeBr=true;this.enforceRealBlocks=false;this._||(this._={})}}var A=KISSY,q=A.UA,s=w.Walker,C=w.Range,m=w.RANGE,y=w.NODE,j=w.ElementPath,e=A.Node,i=A.DOM,k=/^[\r\n\t ]*$/,r=s.bookmark();A.augment(p,{getNextParagraph:function(v){var o,t,a,b,g;if(!this._.lastNode){t=this.range.clone();t.enlarge(this.forceBrBreak||!this.enlargeBr?m.ENLARGE_LIST_ITEM_CONTENTS:m.ENLARGE_BLOCK_CONTENTS);
var h=new s(t),d=s.bookmark(true,true);h.evaluator=d;this._.nextNode=h.next();h=new s(t);h.evaluator=d;h=h.previous();this._.lastNode=h._4e_nextSourceNode(true);if(this._.lastNode&&this._.lastNode[0].nodeType==y.NODE_TEXT&&!A.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()){d=new C(t.document);d.moveToPosition(this._.lastNode,m.POSITION_AFTER_END);if(d.checkEndOfBlock()){d=new j(d.endContainer);this._.lastNode=(d.block||d.blockLimit)._4e_nextSourceNode(true)}}if(!this._.lastNode){this._.lastNode=
this._.docEndMarker=new e(t.document.createTextNode(""));i.insertAfter(this._.lastNode[0],h[0])}t=null}d=this._.nextNode;h=this._.lastNode;for(this._.nextNode=null;d;){var l=false,c=d[0].nodeType!=y.NODE_ELEMENT,f=false;if(c){if(d[0].nodeType==y.NODE_TEXT)if(k.test(d[0].nodeValue))c=false}else{var n=d._4e_name();if(d._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if(n=="br")c=true;else if(!t&&!d[0].childNodes.length&&n!="hr"){o=d;a=d._4e_equals(h);break}if(t){t.setEndAt(d,m.POSITION_BEFORE_START);
if(n!="br")this._.nextNode=d}l=true}else{if(d[0].firstChild){if(!t){t=new C(this.range.document);t.setStartAt(d,m.POSITION_BEFORE_START)}d=new e(d[0].firstChild);continue}c=true}}if(c&&!t){t=new C(this.range.document);t.setStartAt(d,m.POSITION_BEFORE_START)}a=(!l||c)&&d._4e_equals(h);if(t&&!l)for(;!d[0].nextSibling&&!a;){n=d.parent();if(n._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){l=true;a||n._4e_equals(h);break}d=n;c=true;a=d._4e_equals(h);f=true}c&&t.setEndAt(d,m.POSITION_AFTER_END);d=d._4e_nextSourceNode(f,
null,h);a=!d;if((l||a)&&t){c=t.getBoundaryNodes();l=new j(t.startContainer);if(c.startNode.parent()._4e_equals(l.blockLimit)&&r(c.startNode)&&r(c.endNode)){t=null;this._.nextNode=null}else break}if(a)break}if(!o){if(!t){this._.docEndMarker&&this._.docEndMarker._4e_remove();return this._.nextNode=null}l=new j(t.startContainer);d=l.blockLimit;c={div:1,th:1,td:1};o=l.block;if((!o||!o[0])&&!this.enforceRealBlocks&&c[d._4e_name()]&&t.checkStartOfBlock()&&t.checkEndOfBlock())o=d;else if(!o||this.enforceRealBlocks&&
o._4e_name()=="li"){o=new e(this.range.document.createElement(v||"p"));o[0].appendChild(t.extractContents());o._4e_trim();t.insertNode(o);b=g=true}else if(o._4e_name()!="li"){if(!t.checkStartOfBlock()||!t.checkEndOfBlock()){o=o._4e_clone(false);o[0].appendChild(t.extractContents());o._4e_trim();g=t.splitBlock();b=!g.wasStartOfBlock;g=!g.wasEndOfBlock;t.insertNode(o)}}else if(!a)this._.nextNode=o._4e_equals(h)?null:t.getBoundaryNodes().endNode._4e_nextSourceNode(true,null,h)}if(b){t=new e(o[0].previousSibling);
if(t[0]&&t[0].nodeType==y.NODE_ELEMENT)if(t._4e_name()=="br")t._4e_remove();else t[0].lastChild&&t[0].lastChild.nodeName.toLowerCase()=="br"&&i._4e_remove(t[0].lastChild)}if(g){t=s.bookmark(false,true);b=new e(o[0].lastChild);if(b[0]&&b[0].nodeType==y.NODE_ELEMENT&&b._4e_name()=="br")if(q.ie||b._4e_previous(t)||b._4e_next(t))b._4e_remove()}if(!this._.nextNode)this._.nextNode=a||o._4e_equals(h)?null:o._4e_nextSourceNode(true,null,h);return o}});C.prototype.createIterator=function(){return new p(this)}});
KISSY.Editor.add("selection",function(w){function p(h){this.document=h;this._={cache:{}};if(C.ie){var d=this.getNative().createRange();if(!d||d.item&&d.item(0).ownerDocument!=h||d.parentElement&&d.parentElement().ownerDocument!=h)this.isInvalid=true}}function A(h){h=new p(h);return!h||h.isInvalid?null:h}function q(h){var d=h.document,l=new e(d.body),c=new e(d.documentElement);if(C.ie){if(C.ie<8||document.documentMode==7)c.on("click",function(D){m._4e_name(D.target)==="html"&&h.getSelection().getRanges()[0].select()});
var f,n;l.on("focusin",function(D){if(D.target.nodeName.toUpperCase()=="BODY")if(f){try{f.select()}catch(I){}f=null}});l.on("focus",function(){n=true;u()});l.on("beforedeactivate",function(D){D.relatedTarget||(n=false)});C.ie<8&&y.on(m._4e_getWin(d),"blur",function(){d.selection.empty()});l.on("mousedown",z);l.on("mouseup",function(){n=true;setTimeout(function(){u(true)},0)});l.on("keydown",z);l.on("keyup",function(){n=true;u()});y.on(d,"selectionchange",u);var z=function(){n=false},u=function(D){if(n){var I=
h.document,x=h.getSelection(),B=x&&x.getNative();if(D&&B&&B.type=="None")if(!I.queryCommandEnabled("InsertImage")){setTimeout(function(){u(true)},50);return}var H;if(!(B&&B.type=="Text"&&(H=B.createRange().parentElement().nodeName.toLowerCase())&&H in{input:1,textarea:1})){f=B&&x.getRanges()[0];h._monitor()}}}}else{y.on(d,"mouseup",h._monitor,h);y.on(d,"keyup",h._monitor,h)}}w.SELECTION={};var s=KISSY,C=s.UA,m=s.DOM,y=s.Event,j=w.Utils.tryThese,e=s.Node,i=w.SELECTION,k=w.RANGE,r=w.NODE,v=w.Walker,
o=w.Range;i.SELECTION_NONE=1;i.SELECTION_TEXT=2;i.SELECTION_ELEMENT=3;var t={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};s.augment(p,{getNative:C.ie?function(){return this._.cache.nativeSel||(this._.cache.nativeSel=this.document.selection)}:function(){return this._.cache.nativeSel||(this._.cache.nativeSel=m._4e_getWin(this.document).getSelection())},getType:C.ie?function(){var h=this._.cache;if(h.type)return h.type;
var d=i.SELECTION_NONE;try{var l=this.getNative(),c=l.type;if(c=="Text")d=i.SELECTION_TEXT;if(c=="Control")d=i.SELECTION_ELEMENT;if(l.createRange().parentElement)d=i.SELECTION_TEXT}catch(f){}return h.type=d}:function(){var h=this._.cache;if(h.type)return h.type;var d=i.SELECTION_TEXT,l=this.getNative();if(l){if(l.rangeCount==1){l=l.getRangeAt(0);var c=l.startContainer;if(c==l.endContainer&&c.nodeType==r.NODE_ELEMENT&&l.endOffset-l.startOffset===1&&t[c.childNodes[l.startOffset].nodeName.toLowerCase()])d=
i.SELECTION_ELEMENT}}else d=i.SELECTION_NONE;return h.type=d},getRanges:C.ie?function(){var h=function(d,l){d=d.duplicate();d.collapse(l);l=d.parentElement();for(var c=l.childNodes,f,n=0;n<c.length;n++){var z=c[n];if(z.nodeType==r.NODE_ELEMENT){f=d.duplicate();f.moveToElementText(z);z=f.compareEndPoints("StartToStart",d);var u=f.compareEndPoints("EndToStart",d);f.collapse();if(z>0)break;else if(!z||u==1&&z==-1)return{container:l,offset:n};else if(!u)return{container:l,offset:n+1};f=null}}if(!f){f=
d.duplicate();f.moveToElementText(l);f.collapse(false)}f.setEndPoint("StartToStart",d);d=f.text.replace(/(\r\n|\r)/g,"\n").length;try{for(;d>0;)d-=c[--n].nodeValue.length}catch(D){d=0}return d===0?{container:l,offset:n}:{container:c[n],offset:-d}};return function(){var d=this._.cache;if(d.ranges)return d.ranges;var l=this.getNative(),c=l&&l.createRange(),f=this.getType();if(!l)return[];if(f==i.SELECTION_TEXT){l=new o(this.document);f=h(c,true);l.setStart(new e(f.container),f.offset);f=h(c);l.setEnd(new e(f.container),
f.offset);return d.ranges=[l]}else if(f==i.SELECTION_ELEMENT){d=this._.cache.ranges=[];for(f=0;f<c.length;f++){var n=c.item(f),z=n.parentNode,u=0;for(l=new o(this.document);u<z.childNodes.length&&z.childNodes[u]!=n;u++);l.setStart(new e(z),u);l.setEnd(new e(z),u+1);d.push(l)}return d}return d.ranges=[]}}():function(){var h=this._.cache;if(h.ranges)return h.ranges;var d=[],l=this.getNative();if(!l)return[];for(var c=0;c<l.rangeCount;c++){var f=l.getRangeAt(c),n=new o(this.document);n.setStart(new e(f.startContainer),
f.startOffset);n.setEnd(new e(f.endContainer),f.endOffset);d.push(n)}return h.ranges=d},getStartElement:function(){var h=this._.cache;if(h.startElement!==undefined)return h.startElement;var d,l=this.getNative();switch(this.getType()){case i.SELECTION_ELEMENT:return this.getSelectedElement();case i.SELECTION_TEXT:var c=this.getRanges()[0];if(c)if(!c.collapsed){for(c.optimize();;){d=c.startContainer;if(c.startOffset==(d[0].childNodes?d[0].childNodes.length:d[0].nodeValue.length)&&!d._4e_isBlockBoundary())c.setStartAfter(d);
else break}d=c.startContainer;if(d[0].nodeType!=r.NODE_ELEMENT)return d.parent();d=new e(d[0].childNodes[c.startOffset]);if(!d[0]||d[0].nodeType!=r.NODE_ELEMENT)return c.startContainer;for(c=d[0].firstChild;c&&c.nodeType==r.NODE_ELEMENT;){d=new e(c);c=c.firstChild}return d}if(C.ie){c=l.createRange();c.collapse(true);d=c.parentElement()}else if((d=l.anchorNode)&&d.nodeType!=r.NODE_ELEMENT)d=d.parentNode}return h.startElement=d?new e(d):null},getSelectedElement:function(){var h=this._.cache;if(h.selectedElement!==
undefined)return h.selectedElement;var d=this,l=j(function(){return d.getNative().createRange().item(0)},function(){for(var c=d.getRanges()[0],f,n,z=2;z&&!((f=c.getEnclosedNode())&&f[0].nodeType==r.NODE_ELEMENT&&t[f._4e_name()]&&(n=f));z--)c.shrink(k.SHRINK_ELEMENT);return n[0]});return h.selectedElement=l?new e(l):null},reset:function(){this._.cache={}},selectElement:function(h){var d;if(C.ie)try{d=this.document.body.createControlRange();d.addElement(h[0]);d.select()}catch(l){d=this.document.body.createTextRange();
d.moveToElementText(h[0]);d.select()}finally{}else{d=this.document.createRange();d.selectNode(h[0]);h=this.getNative();h.removeAllRanges();h.addRange(d)}this.reset()},selectRanges:function(h){if(C.ie)h[0]&&h[0].select();else{var d=this.getNative();if(!d)return;d.removeAllRanges();for(var l=0;l<h.length;l++){var c=h[l],f=this.document.createRange(),n=c.startContainer;c.collapsed&&C.gecko&&C.gecko<1.09&&n[0].nodeType==r.NODE_ELEMENT&&!n[0].childNodes.length&&n[0].appendChild(this.document.createTextNode(""));
f.setStart(n[0],c.startOffset);f.setEnd(c.endContainer[0],c.endOffset);d.addRange(f)}}this.reset()},createBookmarks2:function(h){for(var d=[],l=this.getRanges(),c=0;c<l.length;c++)d.push(l[c].createBookmark2(h));return d},createBookmarks:function(h){for(var d=[],l=this.getRanges(),c=l.length,f,n=0;n<c;n++){d.push(f=l[n].createBookmark(h,true));var z=(h=f.serializable)?s.one("#"+f.startNode):f.startNode;f=h?s.one("#"+f.endNode):f.endNode;for(var u=n+1;u<c;u++){var D=l[u],I=D.startContainer,x=D.endContainer;
m._4e_equals(I,z.parent())&&D.startOffset++;m._4e_equals(I,f.parent())&&D.startOffset++;m._4e_equals(x,z.parent())&&D.endOffset++;m._4e_equals(x,f.parent())&&D.endOffset++}}return d},selectBookmarks:function(h){for(var d=[],l=0;l<h.length;l++){var c=new o(this.document);c.moveToBookmark(h[l]);d.push(c)}this.selectRanges(d);return this},getCommonAncestor:function(){var h=this.getRanges();return h[0].startContainer._4e_commonAncestor(h[h.length-1].endContainer)},scrollIntoView:function(){this.getStartElement()._4e_scrollIntoView()}});
w.Selection=p;var a={table:1,tbody:1,tr:1},b=v.whitespaces(true),g=/\ufeff|\u00a0/;o.prototype.select=C.ie?function(h){var d=this.collapsed,l,c;if(this.startContainer[0]===this.endContainer[0]&&this.endOffset-this.startOffset==1){var f=this.startContainer[0].childNodes[this.startOffset];if(f.nodeType==r.NODE_ELEMENT){(new p(this.document)).selectElement(new e(f));return}}if(this.startContainer[0].nodeType==r.NODE_ELEMENT&&this.startContainer._4e_name()in a||this.endContainer[0].nodeType==r.NODE_ELEMENT&&
this.endContainer._4e_name()in a)this.shrink(r.NODE_ELEMENT,true);var n=this.createBookmark();f=n.startNode;var z;if(!d)z=n.endNode;n=this.document.body.createTextRange();n.moveToElementText(f[0]);n.moveStart("character",1);if(z){h=this.document.body.createTextRange();h.moveToElementText(z[0]);n.setEndPoint("EndToEnd",h);n.moveEnd("character",-1)}else{for(l=f[0].nextSibling;l&&!b(l);)l=l.nextSibling;l=!(l&&l.nodeValue&&l.nodeValue.match(g))&&(h||!f[0].previousSibling||f[0].previousSibling&&m._4e_name(f[0].previousSibling)==
"br");c=this.document.createElement("span");c.innerHTML="&#65279;";c=new e(c);m.insertBefore(c[0],f[0]);l&&m.insertBefore(this.document.createTextNode("\ufeff"),f[0])}this.setStartBefore(f);f._4e_remove();if(d){if(l){n.moveStart("character",-1);n.select();this.document.selection.clear()}else n.select();if(c){this.moveToPosition(c,k.POSITION_BEFORE_START);c._4e_remove()}}else{this.setEndBefore(z);z._4e_remove();n.select()}}:function(){var h=this.startContainer;this.collapsed&&h[0].nodeType==r.NODE_ELEMENT&&
!h[0].childNodes.length&&h[0].appendChild(this.document.createTextNode(""));var d=this.document.createRange();d.setStart(h[0],this.startOffset);try{d.setEnd(this.endContainer[0],this.endOffset)}catch(l){if(l.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=0){this.collapse(true);d.setEnd(this.endContainer[0],this.endOffset)}else throw l;}h=A(this.document).getNative();h.removeAllRanges();h.addRange(d)};w.on("instanceCreated",function(h){q(h.editor)})});
KISSY.Editor.add("styles",function(w){function p(E,F){for(var G in E)E[G]=E[G].replace(aa,function(L,K){return F[K]})}function A(E,F){if(F){E=z.clone(E);p(E.attributes,F);p(E.styles,F)}F=this.element=(E.element||"*").toLowerCase();this.type=F=="#"||R[F]?D.STYLE_BLOCK:W[F]?D.STYLE_OBJECT:D.STYLE_INLINE;this._={definition:E}}function q(E,F){F=F?this.removeFromRange:this.applyToRange;E.body.focus();E=new x(E);for(var G=E.getRanges(),L=0;L<G.length;L++)F.call(this,G[L]);E.selectRanges(G)}function s(E,
F){var G=E.element;if(G=="*")G="span";F=new N(F.createElement(G));return C(F,E)}function C(E,F){var G=F._.definition;F=G.attributes;G=A.getStyleText(G);if(F)for(var L in F)E.attr(L,F[L]);if(G)E[0].style.cssText=G;return E}function m(E){var F=E.createBookmark(true),G=E.createIterator();G.enforceRealBlocks=true;G.enlargeBr=true;for(var L,K=E.document;L=G.getNextParagraph();){var O=s(this,K);i(L,O)}E.moveToBookmark(F)}function y(E,F,G){var L="",K="";E=E.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,
function(O,P,S){P&&(L=P);S&&(K=S);return""});return L+E.replace(F,G)+K}function j(E,F){var G=E.html();G=y(G,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,"");G=G.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1");G=G.replace(/([ \t\n\r]+|&nbsp;)/g," ");G=G.replace(/<br\b[^>]*>/gi,"\n");if(M.ie){E=E[0].ownerDocument.createElement("div");E.appendChild(F[0]);F[0].outerHTML="<pre>"+G+"</pre>";F=new N(E.firstChild);F._4e_remove()}else F.html(G);return F}function e(E){var F=[];y(E._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,
function(G,L,K){return L+"</pre>"+K+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(G,L){F.push(L)});return F}function i(E,F){var G=F._4e_name=="pre",L=E._4e_name=="pre",K=!G&&L;if(G&&!L)F=j(E,F);else if(K)F=r(e(E),F);else E._4e_moveChildren(F);E[0].parentNode.replaceChild(F[0],E[0]);G&&k(F)}function k(E){var F;if((F=E._4e_previousSourceNode(true,B.NODE_ELEMENT))&&F._4e_name()=="pre"){var G=y(F.html(),/\n$/,"")+"\n\n"+y(E.html(),/^\n/,"");if(M.ie)E[0].outerHTML="<pre>"+G+"</pre>";else E.html(G);
F._4e_remove()}}function r(E,F){for(var G=F[0].ownerDocument.createDocumentFragment(),L=0;L<E.length;L++){var K=E[L];K=K.replace(/(\r\n|\r)/g,"\n");K=y(K,/^[ \t]*\n/,"");K=y(K,/\n$/,"");K=y(K,/^[ \t]+|[ \t]+$/g,function(P,S){return P.length==1?"&nbsp;":S?" "+(new Array(P.length)).join("&nbsp;"):(new Array(P.length)).join("&nbsp;")+" "});K=K.replace(/\n/g,"<br>");K=K.replace(/[ \t]{2,}/g,function(P){return(new Array(P.length)).join("&nbsp;")+" "});var O=F._4e_clone();O.html(K);G.appendChild(O[0])}return G}
function v(E){var F=E.document;if(E.collapsed){F=s(this,F);E.insertNode(F);E.moveToPosition(F,I.POSITION_BEFORE_END)}else{var G=this.element,L=this._.definition,K,O=w.XHTML_DTD[G]||(K=true,w.XHTML_DTD.span),P=E.createBookmark();E.enlarge(I.ENLARGE_ELEMENT);E.trim();var S=E.createBookmark(),da=S.startNode;S=S.endNode;for(var U=da,X;U&&U[0];){var T=false;if(u._4e_equals(U,S)){U=null;T=true}else{var V=U[0].nodeType,ba=V==B.NODE_ELEMENT?U._4e_name():null;if(ba&&U.attr("_ke_bookmark")){U=U._4e_nextSourceNode(true);
continue}if(!ba||O[ba]&&(U._4e_position(S)|H.POSITION_PRECEDING|H.POSITION_IDENTICAL|H.POSITION_IS_CONTAINED)==H.POSITION_PRECEDING+H.POSITION_IDENTICAL+H.POSITION_IS_CONTAINED&&(!L.childRule||L.childRule(U))){var ca=U.parent();if(ca&&ca[0]&&((w.XHTML_DTD[ca._4e_name()]||w.XHTML_DTD.span)[G]||K)&&(!L.parentRule||L.parentRule(ca))){if(!X&&(!ba||!w.XHTML_DTD.$removeEmpty[ba]||(U._4e_position(S)|H.POSITION_PRECEDING|H.POSITION_IDENTICAL|H.POSITION_IS_CONTAINED)==H.POSITION_PRECEDING+H.POSITION_IDENTICAL+
H.POSITION_IS_CONTAINED)){X=new J(F);X.setStartBefore(U)}if(V==B.NODE_TEXT||V==B.NODE_ELEMENT&&!U[0].childNodes.length){V=U;for(var Y;!V[0].nextSibling&&(Y=V.parent(),O[Y._4e_name()])&&(Y._4e_position(da)|H.POSITION_FOLLOWING|H.POSITION_IDENTICAL|H.POSITION_IS_CONTAINED)==H.POSITION_FOLLOWING+H.POSITION_IDENTICAL+H.POSITION_IS_CONTAINED&&(!L.childRule||L.childRule(Y));)V=Y;X.setEndAfter(V);V[0].nextSibling||(T=true)}}else T=true}else T=true;U=U._4e_nextSourceNode()}if(T&&X&&!X.collapsed){T=s(this,
F);for(V=X.getCommonAncestor();T&&V&&T[0]&&V[0];){if(V._4e_name()==G){for(var Z in L.attributes)T.attr(Z)==V.attr(Z)&&T[0].removeAttribute(Z);for(var ea in L.styles)T._4e_style(ea)==V._4e_style(ea)&&T._4e_style(ea,"");if(!T._4e_hasAttributes()){T=null;break}}V=V.parent()}if(T){T[0].appendChild(X.extractContents());c(this,T);X.insertNode(T);T._4e_mergeSiblings();M.ie||T[0].normalize()}X=null}}da._4e_remove();S._4e_remove();E.moveToBookmark(P);E.shrink(I.SHRINK_TEXT)}}function o(E){E.enlarge(I.ENLARGE_ELEMENT);
var F=E.createBookmark(),G=F.startNode;if(E.collapsed){for(var L=new Q(G.parent()),K,O=0,P;O<L.elements.length&&(P=L.elements[O]);O++){if(P==L.block||P==L.blockLimit)break;if(this.checkElementRemovable(P)){var S=E.checkBoundaryOfElement(P,I.END),da=!S&&E.checkBoundaryOfElement(P,I.START);if(da||S){K=P;K.match=da?"start":"end"}else{P._4e_mergeSiblings();P._4e_name()==this.element?d(this,P):f(P,h(this)[P._4e_name()])}}}if(K&&K[0]){P=G;for(O=0;;O++){S=L.elements[O];if(u._4e_equals(S,K))break;else if(S.match)continue;
else S=S._4e_clone();S[0].appendChild(P[0]);P=S}u[K.match=="start"?"insertBefore":"insertAfter"](P[0],K[0])}}else{var U=F.endNode,X=this;L=function(){for(var T=new Q(G.parent()),V=new Q(U.parent()),ba=null,ca=null,Y=0;Y<T.elements.length;Y++){var Z=T.elements[Y];if(Z==T.block||Z==T.blockLimit)break;if(X.checkElementRemovable(Z))ba=Z}for(Y=0;Y<V.elements.length;Y++){Z=V.elements[Y];if(Z==V.block||Z==V.blockLimit)break;if(X.checkElementRemovable(Z))ca=Z}ca&&U._4e_breakParent(ca);ba&&G._4e_breakParent(ba)};
L();for(K=new N(G[0].nextSibling);K[0]!==U[0];){O=K._4e_nextSourceNode();if(K[0]&&K[0].nodeType==B.NODE_ELEMENT&&this.checkElementRemovable(K)){K._4e_name()==this.element?d(this,K):f(K,h(this)[K._4e_name()]);if(O[0].nodeType==B.NODE_ELEMENT&&O._4e_contains(G)){L();O=new N(G[0].nextSibling)}}K=O}}E.moveToBookmark(F)}function t(E){var F={};E.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(G,L,K){F[L]=K});return F}function a(E,F){typeof E=="string"&&(E=t(E));typeof F==
"string"&&(F=t(F));for(var G in E)if(!(G in F&&(F[G]==E[G]||E[G]=="inherit"||F[G]=="inherit")))return false;return true}function b(E,F){if(F!==false){F=document.createElement("span");F.style.cssText=E;E=F.style.cssText||""}else E=E;return E.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function g(E){var F=E._AC;if(F)return F;F={};var G=0,L=E.attributes;if(L)for(var K in L){G++;F[K]=L[K]}if(L=A.getStyleText(E)){F.style||G++;F.style=L}F._length=G;return E._AC=
F}function h(E){if(E._.overrides)return E._.overrides;var F=E._.overrides={},G=E._.definition.overrides;if(G){z.isArray(G)||(G=[G]);for(var L=0;L<G.length;L++){var K=G[L],O,P;if(typeof K=="string")O=K.toLowerCase();else{O=K.element?K.element.toLowerCase():E.element;P=K.attributes}K=F[O]||(F[O]={});if(P){K=K.attributes=K.attributes||[];for(var S in P)K.push([S.toLowerCase(),P[S]])}}}return F}function d(E,F){var G=E._.definition,L=z.mix(z.mix({},G.attributes),h(E)[F._4e_name()]);G=G.styles;var K=z.isEmptyObject(L)&&
z.isEmptyObject(G);for(var O in L)if(!((O=="class"||E._.definition.fullMatch)&&F.attr(O)!=l(O,L[O]))){K=K||!!F._4e_hasAttribute(O);F.removeAttr(O)}for(var P in G)if(!(E._.definition.fullMatch&&F._4e_style(P)!=l(P,G[P],true))){K=K||!!F._4e_style(P);F._4e_style(P,"")}K&&n(F)}function l(E,F,G){var L=new N("<span></span>");L[G?"_4e_style":"attr"](E,F);return L[G?"_4e_style":"attr"](E)}function c(E,F){for(var G=h(E),L=F.all(E.element),K=L.length;--K>=0;)d(E,new N(L[K]));for(var O in G)if(O!=E.element){L=
F.all(O);for(K=L.length-1;K>=0;K--){var P=new N(L[K]);f(P,G[O])}}}function f(E,F){if(F=F&&F.attributes)for(var G=0;G<F.length;G++){var L=F[G][0],K;if(K=E.attr(L)){var O=F[G][1];if(O===null||O.test&&O.test(K)||typeof O=="string"&&K==O)E[0].removeAttribute(L)}}n(E)}function n(E){if(!E._4e_hasAttributes()){var F=E[0].firstChild,G=E[0].lastChild;E._4e_remove(true);if(F){F.nodeType==B.NODE_ELEMENT&&u._4e_mergeSiblings(F);G&&!F===G&&G.nodeType==B.NODE_ELEMENT&&u._4e_mergeSiblings(G)}}}var z=KISSY,u=z.DOM,
D=w.STYLE={},I=w.RANGE,x=w.Selection,B=w.NODE,H=w.POSITION,J=w.Range,N=z.Node,M=z.UA,Q=w.ElementPath,R={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},W={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},$=/\s*(?:;\s*|$)/,aa=/#\((.+?)\)/g;D.STYLE_BLOCK=1;D.STYLE_INLINE=2;D.STYLE_OBJECT=3;A.prototype={apply:function(E){q.call(this,E,false)},remove:function(E){q.call(this,E,true)},applyToRange:function(E){return(this.applyToRange=this.type==D.STYLE_INLINE?
v:this.type==D.STYLE_BLOCK?m:this.type==D.STYLE_OBJECT?null:null).call(this,E)},removeFromRange:function(E){return(this.removeFromRange=this.type==D.STYLE_INLINE?o:null).call(this,E)},applyToObject:function(E){C(E,this)},checkElementRemovable:function(E,F){if(!E)return false;var G=this._.definition;if(E._4e_name()==this.element){if(!F&&!E._4e_hasAttributes())return true;G=g(G);if(G._length){for(var L in G)if(L!="_length"){var K=E.attr(L)||"";if(L=="style"?a(G[L],b(K,false)):G[L]==K){if(!F)return true}else if(F)return false}if(F)return true}else return true}if(G=
h(this)[E._4e_name()]){if(!(G=G.attributes))return true;for(F=0;F<G.length;F++){L=G[F][0];if(L=E.attr(L)){K=G[F][1];if(K===null||typeof K=="string"&&L==K||K.test&&K.test(L))return true}}}return false},checkActive:function(E){switch(this.type){case D.STYLE_BLOCK:return this.checkElementRemovable(E.block||E.blockLimit,true);case D.STYLE_OBJECT:case D.STYLE_INLINE:for(var F=E.elements,G=0,L;G<F.length;G++){L=F[G];if(!(this.type==D.STYLE_INLINE&&(u._4e_equals(L,E.block)||u._4e_equals(L,E.blockLimit))))if(!(this.type==
D.STYLE_OBJECT&&!(L._4e_name()in W)))if(this.checkElementRemovable(L,true))return true}}return false}};A.getStyleText=function(E){var F=E._ST;if(F)return F;F=E.styles;var G=E.attributes&&E.attributes.style||"",L="";if(G.length)G=G.replace($,";");for(var K in F){var O=F[K],P=(K+":"+O).replace($,";");if(O=="inherit")L+=P;else G+=P}if(G.length)G=b(G);G+=L;return E._ST=G};w.Style=A});
KISSY.Editor.add("button",function(){function w(s){w.superclass.constructor.call(this,s);this._init()}var p=KISSY.Editor,A=KISSY,q=A.Node;w.ON="on";w.OFF="off";w.DISABLED="disabled";w.ON_CLASS="ke-triplebutton-on";w.OFF_CLASS="ke-triplebutton-off";w.DISABLED_CLASS="ke-triplebutton-disabled";w.ATTRS={state:{value:"off"},container:{},text:{},contentCls:{},cls:{}};A.extend(w,A.Base,{_init:function(){var s=this.get("container")[0]||this.get("container");this.el=new q("<a class='ke-triplebutton ke-triplebutton-off' href='#' role=\"button\"></a>");
this.el._4e_unselectable();this._attachCls();if(this.get("text"))this.el.html(this.get("text"));else if(this.get("contentCls")){this.el.html("<span class='ke-toolbar-item "+this.get("contentCls")+"'></span>");this.el.one("span")._4e_unselectable()}this.get("title")&&this.el.attr("title",this.get("title"));s.appendChild(this.el[0]);this.el.on("click",this._action,this);this.on("afterStateChange",this._stateChange,this)},_attachCls:function(){var s=this.get("cls");s&&this.el.addClass(s)},_stateChange:function(s){this["_"+
s.newVal]();this._attachCls()},_action:function(s){this.fire(this.get("state")+"Click",s);this.fire("click",s);s.preventDefault()},_on:function(){this.el[0].className="ke-triplebutton ke-triplebutton-on"},_off:function(){this.el[0].className="ke-triplebutton ke-triplebutton-off"},_disabled:function(){this.el[0].className="ke-triplebutton ke-triplebutton-disabled"}});p.TripleButton=w});
KISSY.Editor.add("contextmenu",function(){function w(e){this.cfg=q.clone(e);A.Utils.lazyRun(this,"_prepareShow","_realShow")}function p(e,i){for(var k=0;k<i.length;k++)if(C.test(e,i[k]))return true;return false}var A=KISSY.Editor,q=KISSY,s=q.Node,C=q.DOM,m=q.Event,y=[];w.register=function(e,i){var k=new w(i);y.push({doc:e,rules:i.rules,instance:k});if(!e.ke_contextmenu){e.ke_contextmenu=1;m.on(e,"mousedown",w.hide);m.on(e,"contextmenu",function(r){w.hide.call(this);for(var v=new s(r.target);v;){var o=
false;if(v._4e_name()=="body")break;for(var t=0;t<y.length;t++){var a=y[t].instance,b=y[t].rules;if(e===y[t].doc&&p(v[0],b)){r.preventDefault();o=true;a.show(A.Utils.getXY(r.pageX,r.pageY,e,document));break}}if(o)break;v=v.parent()}})}return k};w.hide=function(){for(var e=0;e<y.length;e++){var i=y[e].instance;this===y[e].doc&&i.hide()}};var j=A.SimpleOverlay;q.augment(w,{_init:function(){var e=this,i=e.cfg,k=i.funcs;e.elDom=new s("<div class='ke-contextmenu' onmousedown='return false;'></div>");var r=
e.elDom;r.css("width",i.width);document.body.appendChild(r[0]);e.el=new j({el:r});for(var v in k){i=new s("<a href='#'>"+v+"</a>");r[0].appendChild(i[0]);(function(o,t){o._4e_unselectable();o.on("click",function(a){e.hide();a.halt();setTimeout(t,30)})})(i,k[v])}},hide:function(){this.el&&this.el.hide()},_realShow:function(e){this.el.show(e)},_prepareShow:function(){this._init()},show:function(e){this._prepareShow(e)}});A.ContextMenu=w});
KISSY.Editor.add("overlay",function(){function w(){var i=this;w.superclass.constructor.apply(i,arguments);i._init();if(A.UA.ie===6){i.on("show",function(){var k=i.get("el"),r=parseInt(k.css("width"));k=k[0].offsetHeight;e&&e.css({width:r+"px",height:k+"px"});e&&e.offset(i.get("el").offset())});i.on("hide",function(){e&&e.offset({left:-999,top:-999})})}if(i.get("mask")){i.on("show",function(){y&&y.css({left:"0px",top:"0px"});j&&j.css({left:"0px",top:"0px"})});i.on("hide",function(){y&&y.css({left:"-9999px",
top:"-9999px"});j&&j.css({left:"-9999px",top:"-9999px"})})}i.hide()}var p=KISSY.Editor,A=KISSY,q=A.UA,s=p.focusManager,C=A.Node,m=A.DOM,y,j,e;w.init=function(){var i=document.body;y=new C('<div class="ke-mask">&nbsp;</div>');y.css({left:"-9999px",top:"-9999px"});y.css({width:"100%",height:m.docHeight()+"px",opacity:0.4});y.appendTo(i);if(A.UA.ie==6){e=new C("<iframe class='ke-dialog-iframe'></iframe>");i.appendChild(e[0]);j=new C("<iframe class='ke-mask'></iframe>");j.css({left:"-9999px",top:"-9999px"});
j.css({width:"100%",height:m.docHeight()+"px",opacity:0.4});j.appendTo(i)}w.init=null};w.ATTRS={title:{value:""},width:{value:"450px"},visible:{value:false},focusMgr:{value:true},mask:{value:false}};A.extend(w,A.Base,{_init:function(){var i=this,k=i.get("el");i.on("afterVisibleChange",function(r){if(r=r.newVal){typeof r=="boolean"?i.center():k.offset(r);i.fire("show")}else{k.css({left:"-9999px",top:"-9999px"});i.fire("hide")}});i.get("focusMgr")&&i.on("beforeVisibleChange",i._editorFocusMg,i);if(k){k[0].appendChild((new C("<a href='#' class='ke-focus' style='width:0;height:0;margin:0;padding:0;overflow:hidden;outline:none;font-size:0;'></a>"))[0]);
i.el=k}else{k=new C("<div class='ke-dialog' style='width:"+i.get("width")+"'><div class='ke-hd'><span class='ke-hd-title'>"+i.get("title")+"</span><span class='ke-hd-x'><a class='ke-close' href='#'>X</a></span></div><div class='ke-bd'></div><div class='ke-ft'></div><a href='#' tabindex='-1' class='ke-focus'></a></div>");document.body.appendChild(k[0]);i.set("el",k);i.el=k;i.body=k.one(".ke-bd");i.foot=k.one(".ke-ft");i._close=k.one(".ke-close");i._title=k.one(".ke-hd-title").one("h1");i._close.on("click",
function(r){r.preventDefault();i.hide()})}k.css({left:"-9999px",top:"-9999px"})},center:function(){var i=this.get("el"),k=parseInt(i.css("width")),r=i[0].offsetHeight,v=m.viewportWidth(),o=m.viewportHeight();k=(v-k)/2+m.scrollLeft();r=(o-r)/2+m.scrollTop();if(r-m.scrollTop()>200)r-=150;i.css({left:k+"px",top:r+"px"})},_prepareShow:function(){w.init()},_getFocusEl:function(){if(this._focusEl)return this._focusEl;return this._focusEl=this.el.one(".ke-focus")[0]},_editorFocusMg:function(i){var k=this._focusEditor;
if(i.newVal){k=this._focusEditor=s.currentInstance();this._getFocusEl().focus();var r=this.el.one("input");if(r)setTimeout(function(){try{r[0].focus();r[0].select()}catch(v){}},0);else if(q.ie&&k)if(i=k.document.selection.createRange())if(i.item&&i.item(0).ownerDocument==k.document){k=document.body.createTextRange();k.moveToElementText(this.el._4e_first()[0]);k.collapse(true);k.select()}}else k&&k.focus()},_realShow:function(i){this.get("el");this.set("visible",i||true)},show:function(i){this._prepareShow(i)},
hide:function(){this.get("el");this.set("visible",false)}});p.Utils.lazyRun(w.prototype,"_prepareShow","_realShow");p.SimpleOverlay=w});
KISSY.Editor.add("clipboard",function(w){var p=KISSY.Editor,A=KISSY,q=A.Node,s=A.UA,C=p.Range,m=p.RANGE,y=A.Event;p.Paste||function(){function j(e){this.editor=e;this._init()}A.augment(j,{_init:function(){var e=this.editor;s.ie?y.on(e.document,"keydown",this._paste,this):y.on(e.document,"paste",this._paste,this)},_paste:function(e){if(!(e.type==="keydown"&&!(e.keyCode===86&&(e.ctrlKey||e.metaKey)))){var i=this.editor;e=i.document;var k=i.getSelection(),r=new C(e),v=new q(s.webkit?"<body></body>":
"<div></div>",null,e);s.webkit&&v[0].appendChild(e.createTextNode("\u00a0"));e.body.appendChild(v[0]);v.css({position:"absolute",top:k.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});v.css("left","-1000px");var o=k.createBookmarks();r.setStartAt(v,m.POSITION_AFTER_START);r.setEndAt(v,m.POSITION_BEFORE_END);r.select(true);setTimeout(function(){v._4e_remove();var t;v=s.webkit&&(t=v._4e_first())&&t[0]&&t.hasClass("Apple-style-span")?t:v;k.selectBookmarks(o);i.insertHtml(v.html())},
0)}}});p.Paste=j}();w.addPlugin(function(){new p.Paste(w)})});
KISSY.Editor.add("color",function(w){function p(d){return("0"+d).slice(d.length-1,d.length+1)}function A(d){d=s.trim(d);if(d.charAt(0)=="#")d=d.substring(1);d=d.replace(/\s+/g,"");var l="";if(/^[0-9a-f]{3,3}$/i.test(d))l=d.replace(/[0-9a-f]/ig,function(f){return f+f});else{var c=d.match(i);if(c&&c[0])for(d=1;d<4;d++)l+=p(parseInt(c[d]).toString(16));else l=d}return"#"+l.toLowerCase()}for(var q=KISSY.Editor,s=KISSY,C=s.Node,m=s.Event,y=q.SimpleOverlay,j=q.Style,e=s.DOM,i=/^rgb\((\d+),(\d+),(\d+)\)$/i,
k="000,800000,8B4513,2F4F4F,008080,000080,4B0082,696969,B22222,A52A2A,DAA520,006400,40E0D0,0000CD,800080,808080,F00,FF8C00,FFD700,008000,0FF,00F,EE82EE,A9A9A9,FFA07A,FFA500,FFFF00,00FF00,AFEEEE,ADD8E6,DDA0DD,D3D3D3,FFF0F5,FAEBD7,FFFFE0,F0FFF0,F0FFFF,F0F8FF,E6E6FA,FFF".split(/,/),r={element:"span",styles:{color:"#(color)"},overrides:[{element:"font",attributes:{color:null}}]},v={element:"span",styles:{"background-color":"#(color)"}},o="<div class='ke-popup-wrap ke-color-wrap'><a class='ke-color-remove' href=\"javascript:void('\u6e05\u9664');\"><span>\u6e05\u9664</span></a><table>",
t={},a={},b=0;b<5;b++){o+="<tr>";for(var g=0;g<8;g++){var h=A(k[8*b+g]);o+="<td>";o+="<a href='javascript:void(0);' class='ke-color-a'><span style='background-color:"+h+"'></span></a>";o+="</td>";t[h]=new j(v,{color:h});a[h]=new j(r,{color:h})}o+="</tr>"}t.inherit=new j(v,{color:"inherit"});a.inherit=new j(r,{color:"inherit"});o+="</table></div>";q.ColorSupport||function(){function d(c){d.superclass.constructor.call(this,c);this._init()}var l=q.TripleButton;d.ATTRS={editor:{},styles:{},contentCls:{},
text:{}};s.extend(d,s.Base,{_init:function(){var c=this.get("editor").toolBarDiv;c=new l({container:c,title:this.get("title"),contentCls:this.get("contentCls")});c.on("offClick",this._showColors,this);this.el=c;q.Utils.lazyRun(this,"_prepare","_real")},_hidePanel:function(c){var f=this;e._4e_ascendant(c.target,function(n){return n[0]===f.el.el[0]},true)||this.colorWin.hide()},_selectColor:function(c){c.halt();var f=this.get("editor");c=c.target;if(e._4e_name(c)=="span"||e._4e_name(c)=="a"){c=new C(c);
if(c._4e_name()=="a")c=c.one("span");var n=this.get("styles");f.fire("save");c._4e_style("background-color")?n[A(c._4e_style("background-color"))].apply(f.document):n.inherit.remove(f.document);f.fire("save");f.focus();this.colorWin.hide()}},_prepare:function(){this.colorPanel=new C(o);this.colorWin=new y({el:this.colorPanel,mask:false,focusMgr:false});document.body.appendChild(this.colorPanel[0]);this.colorPanel.on("click",this._selectColor,this);m.on(document,"click",this._hidePanel,this);m.on(w.document,
"click",this._hidePanel,this)},_real:function(){var c=this.el.el.offset();c.top+=this.el.el.height()+5;if(c.left+this.colorPanel.width()>e.viewportWidth()-60)c.left=e.viewportWidth()-this.colorPanel.width()-60;this.colorWin.show(c)},_showColors:function(c){this._prepare(c)}});q.ColorSupport=d}();w.addPlugin(function(){new q.ColorSupport({editor:w,styles:t,title:"\u80cc\u666f\u989c\u8272",contentCls:"ke-toolbar-bgcolor",text:"bgcolor"});new q.ColorSupport({editor:w,styles:a,title:"\u6587\u672c\u989c\u8272",
contentCls:"ke-toolbar-color",text:"color"})})});
KISSY.Editor.add("elementpaths",function(w){var p=KISSY.Editor,A=KISSY,q=A.Node,s=A.DOM;p.ElementPaths||function(){function C(m){this.cfg=m;this._cache=[];this._init()}A.augment(C,{_init:function(){var m=this.cfg.editor;this.holder=new q("<div>");this.holder.appendTo(m.statusDiv);m.on("selectionChange",this._selectionChange,this)},_selectionChange:function(m){var y=this.cfg.editor,j=this.holder;j=j[0]||j;m=m.path.elements;var e,i;e=this._cache;for(i=0;i<e.length;i++){e[i].detach("click");e[i]._4e_remove()}this._cache=
[];for(i=0;i<m.length;i++){e=m[i];var k=new q("<a href='#' class='elementpath'>"+(e.attr("_ke_real_element_type")||e._4e_name())+"</a>");this._cache.push(k);(function(r){k.on("click",function(v){v.halt();y.focus();setTimeout(function(){y.getSelection().selectElement(r)},50)})})(e);j.firstChild?s.insertBefore(k[0],j.firstChild):j.appendChild(k[0])}}});p.ElementPaths=C}();w.addPlugin(function(){new p.ElementPaths({editor:w})})});
KISSY.Editor.add("enterkey",function(w){var p=KISSY.Editor,A=KISSY,q=A.UA,s=/^h[1-6]$/,C=p.XHTML_DTD,m=A.Node,y=A.Event,j=p.Walker,e=p.ElementPath;p.enterBlock||function(){function i(v){v=v.getSelection().getRanges();for(var o=v.length-1;o>0;o--)v[o].deleteContents();return v[0]}function k(v){var o=i(v),t=o.document;if(o.checkStartOfBlock()&&o.checkEndOfBlock()){var a=(new e(o.startContainer)).block;if(a&&(a._4e_name()=="li"||a.parent()._4e_name()=="li")){v.execCommand("outdent");return}}var b=o.splitBlock("p");
if(b){v=b.previousBlock;a=b.nextBlock;var g=b.wasStartOfBlock,h=b.wasEndOfBlock,d;if(a){d=a.parent();if(d._4e_name()=="li"){a._4e_breakParent(d);a._4e_move(a._4e_next(),true)}}else if(v&&(d=v.parent())&&d._4e_name()=="li"){v._4e_breakParent(d);o.moveToElementEditablePosition(v._4e_next());v._4e_move(v._4e_previous())}if(!g&&!h){if(a._4e_name()=="li"&&(d=a._4e_first(j.invisible(true)))&&A.inArray(d._4e_name(),["ul","ol"]))(q.ie?new m(t.createTextNode("\u00a0")):new m(t.createElement("br"))).insertBefore(d);
a&&o.moveToElementEditablePosition(a)}else{var l;if(v){if(v._4e_name()=="li"||!s.test(v._4e_name()))l=v._4e_clone()}else if(a)l=a._4e_clone();l||(l=new m("p",null,t));if(d=b.elementPath){b=0;for(var c=d.elements.length;b<c;b++){var f=d.elements[b];if(f._4e_equals(d.block)||f._4e_equals(d.blockLimit))break;if(C.$removeEmpty[f._4e_name()]){f=f._4e_clone();l._4e_moveChildren(f);l.append(f)}}}q.ie||l._4e_appendBogus();o.insertNode(l);if(q.ie&&g&&(!h||!v[0].childNodes.length)){o.moveToElementEditablePosition(h?
v:l);o.select()}o.moveToElementEditablePosition(g&&!h?a:l)}if(!q.ie)if(a){t=new m(t.createElement("span"));t.html("&nbsp;");o.insertNode(t);t._4e_scrollIntoView();o.deleteContents()}else l._4e_scrollIntoView();o.select()}}function r(v){y.on(v.document,"keydown",function(o){if(o.keyCode===13)if(!o.shiftKey){v.execCommand("enterBlock");o.preventDefault()}})}r.enterBlock=k;p.EnterKey=r}();w.addPlugin(function(){w.addCommand("enterBlock",{exec:p.EnterKey.enterBlock});p.EnterKey(w)})});
KISSY.Editor.add("fakeobjects",function(){var w=KISSY.Editor,p=KISSY,A=p.Node,q=w.NODE,s=w.HtmlParser,C=p.Editor,m=w.HtmlDataProcessor,y=m&&m.htmlFilter;w.FakeObjects||function(){var j={elements:{$:function(e){var i=e.attributes;if((i=(i=(i=i&&i._ke_realelement)&&new s.Fragment.FromHtml(decodeURIComponent(i)))&&i.children[0])&&e.attributes._ke_resizable){var k=e.attributes.style;if(k){var r=/(?:^|\s)width\s*:\s*(\d+)/i.exec(k);e=r&&r[1];k=(r=/(?:^|\s)height\s*:\s*(\d+)/i.exec(k))&&r[1];if(e)i.attributes.width=
e;if(k)i.attributes.height=k}}return i}}};y&&y.addRules(j);m&&p.mix(m,{createFakeParserElement:function(e,i,k,r){var v;v=new s.BasicWriter;e.writeHtml(v);v=v.getHtml();var o=e.attributes.style;if(e.attributes.width)o="width:"+e.attributes.width+"px;"+o;if(e.attributes.height)o="height:"+e.attributes.height+"px;"+o;e={"class":i,src:w.Config.base+"assets/spacer.gif",_ke_realelement:encodeURIComponent(v),_ke_real_node_type:e.type,style:o,align:e.attributes.align||""};if(k)e._ke_real_element_type=k;if(r)e._ke_resizable=
r;return new s.Element("img",e)}});w.FakeObjects=1}();p.augment(C,{createFakeElement:function(j,e,i,k,r){var v=j.attr("style")||"";if(j.attr("width"))v="width:"+j.attr("width")+"px;"+v;if(j.attr("height"))v="height:"+j.attr("height")+"px;"+v;j={"class":e,src:w.Config.base+"assets/spacer.gif",_ke_realelement:encodeURIComponent(r||j._4e_outerHtml()),_ke_real_node_type:j[0].nodeType,align:j.attr("align")||"",style:v};if(i)j._ke_real_element_type=i;if(k)j._ke_resizable=k;return new A("<img/>",j,this.document)},
restoreRealElement:function(j){if(j.attr("_ke_real_node_type")!=q.NODE_ELEMENT)return null;j=decodeURIComponent(j.attr("_ke_realelement"));var e=new A("<div>",null,this.document);e.html(j);return e._4e_first(function(i){return i[0].nodeType==q.NODE_ELEMENT})._4e_remove()}})});
KISSY.Editor.add("flash",function(w){var p=KISSY.Editor,A=KISSY,q=A.DOM,s=A.Event,C=p.ContextMenu,m=A.Node,y=p.NODE,j=p.TripleButton,e=p.SimpleOverlay,i=/\.swf(?:$|\?)/i,k=p.HtmlDataProcessor,r="niftyplayer.swf",v=p.Utils.getFlashUrl,o=k&&k.dataFilter,t=["img.ke_flash"];p.Flash||function(){function a(d){d=d.attributes;return d.type=="application/x-shockwave-flash"||i.test(d.src||"")}function b(d){return d.indexOf(r)!=-1}function g(d){this.editor=d;d._toolbars=d._toolbars||{};d._toolbars.flash=this;
this._init()}o&&o.addRules({elements:{object:function(d){var l=d.attributes,c="ke_flash",f="flash";if(!(l.classid&&String(l.classid).toLowerCase())){for(l=0;l<d.children.length;l++)if(d.children[l].name=="embed"){if(!a(d.children[l]))return null;if(b(d.children[l].attributes.src)){c="ke_music";f="music"}return k.createFakeParserElement(d,c,f,true)}return null}for(l=0;l<d.children.length;l++){var n=d.children[l];if(n.name=="param"&&n.attributes.name=="movie")if(b(n.attributes.value)){c="ke_music";
f="music";break}}return k.createFakeParserElement(d,c,f,true)},embed:function(d){if(!a(d))return null;var l="ke_flash",c="flash";if(b(d.attributes.src)){l="ke_music";c="music"}return k.createFakeParserElement(d,l,c,true)}}},5);A.augment(g,{_init:function(){var d=this.editor,l={};this.el=new j({container:d.toolBarDiv,contentCls:"ke-toolbar-flash",title:"Flash"});this.el.on("click",this._showConfig,this);s.on(d.document,"dblclick",this._dbclick,this);for(var c in h)(function(f){l[f]=function(){d.fire("save");
d.focus();h[f](d);d.fire("save")}})(c);C.register(d.document,{rules:t,width:"120px",funcs:l});p.Utils.lazyRun(this,"_prepareShow","_realShow");d.on("selectionChange",this._selectionChange,this)},_selectionChange:function(d){d=d.path;var l=d.elements;if(d&&l)if(d=d.lastElement)(d=d._4e_ascendant(function(c){return c._4e_name()==="img"&&!!c.hasClass("ke_flash")},true))?this._showTip(d):this._hideTip()},_showTip:function(d){this._prepareTip(d)},_hideTip:function(){g.tipwin&&g.tipwin.hide()},_prepareTip:function(){g.tip&&
g.tip()},_realTip:function(d){var l=this.editor,c=d._4e_getOffset(document);c.top+=d.height()+5;g.tipwin.show(c);this.selectedFlash=d;d=l.restoreRealElement(this.selectedFlash);g.tipwin.flash=this;g.tipurl.html(v(d));g.tipurl.attr("href",v(d))},_dbclick:function(d){var l=new m(d.target);if(l._4e_name()==="img"&&l.hasClass("ke_flash")){this.selectedFlash=l;this._showConfig();d.halt()}},_prepareShow:function(){var d=this;d.d=new e({title:"\u7f16\u8f91flash",width:"350px",mask:true});d.d.on("hide",function(){d.selectedFlash=
null});d.d.body.html("<div><p><label>\u5730\u5740\uff1a <input class='ke-flash-url' style='width:280px' /></label></p><p style='margin:5px 0'><label>\u5bbd\u5ea6\uff1a <input class='ke-flash-width' style='width:110px' /></label>&nbsp;&nbsp;<label>\u9ad8\u5ea6\uff1a<input class='ke-flash-height' style='width:110px' /></label></p>");d.d.foot.html("<button class='ke-flash-ok'>\u786e\u5b9a</button> <button class='ke-flash-cancel'>\u53d6\u6d88</button></div>");d._initD()},_realShow:function(){this.d.show()},
_showConfig:function(){var d=this.editor,l=this.selectedFlash;this._prepareShow();if(l){d=d.restoreRealElement(l);d.attr("width")&&this.dWidth.val(parseInt(d.attr("width")));d.attr("height")&&this.dHeight.val(parseInt(d.attr("height")));if(d._4e_name()=="object"){d=d[0].childNodes;for(l=0;l<d.length;l++)if(d[l].nodeType==y.NODE_ELEMENT)if((q.attr(d[l],"name")||"").toLowerCase()=="movie")this.dUrl.val(q.attr(d[l],"value"));else if(q._4e_name(d[l])=="embed")this.dUrl.val(q.attr(d[l],"src"));else q._4e_name(d[l])==
"object"&&this.dUrl.val(q.attr(d[l],"data"))}else d._4e_name()=="embed"&&this.dUrl.val(d.attr("src"))}else{this.dUrl.val("");this.dWidth.val("");this.dHeight.val("")}},_initD:function(){var d=this,l=d.d;d.dHeight=l.el.one(".ke-flash-height");d.dWidth=l.el.one(".ke-flash-width");d.dUrl=l.el.one(".ke-flash-url");var c=l.el.one(".ke-flash-ok");l=l.el.one(".ke-flash-cancel");c.on("click",d._gen,d);l.on("click",function(){d.d.hide()})},_gen:function(){var d=this.editor,l=this.dUrl.val();if(l){l="<object "+
(parseInt(this.dWidth.val())?" width='"+parseInt(this.dWidth.val())+"' ":" ")+(parseInt(this.dHeight.val())?" height='"+parseInt(this.dHeight.val())+"' ":" ")+' classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"  codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,0,0"><param name="quality" value="high" /><param name="movie" value="'+l+'" /><embed '+(parseInt(this.dWidth.val())?" width='"+parseInt(this.dWidth.val())+"' ":" ")+(parseInt(this.dHeight.val())?" height='"+
parseInt(this.dHeight.val())+"' ":" ")+'pluginspage="http://www.macromedia.com/go/getflashplayer" quality="high"  src="'+l+'"  type="application/x-shockwave-flash"/></object>';var c=new m(l,null,d.document);l=d.createFakeElement?d.createFakeElement(c,"ke_flash","flash",true,l):c;d.insertElement(l);this.selectedFlash&&d.getSelection().selectElement(l);this.d.hide()}}});p.Utils.lazyRun(g.prototype,"_prepareTip","_realTip");p.Flash=g;g.tip=function(){var d=this,l=new m('<div class="ke-bubbleview-bubble" onmousedown="return false;">Flash \u7f51\u5740\uff1a  <a class="ke-bubbleview-url" target="_blank" href="#"></a> -     <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -     <span class="ke-bubbleview-link ke-bubbleview-remove">\u5220\u9664</span></div>'),
c=l.one(".ke-bubbleview-change"),f=l.one(".ke-bubbleview-remove");l._4e_unselectable();d.tipwin=new e({el:l,focusMgr:false});document.body.appendChild(l[0]);d.tipurl=l.one(".ke-bubbleview-url");d.tipwin.on("hide",function(){var n=d.tipwin.flash;n&&(n.selectedFlash=null)});s.on(document,"click",function(){d.tipwin.hide()});c.on("click",function(n){d.tipwin.flash._showConfig();n.halt()});f.on("click",function(n){var z=d.tipwin.flash;z.selectedFlash._4e_remove();z.editor.notifySelectionChange();z.selectedFlash=
null;n.halt()});d.tip=null};var h={"\u7f16\u8f91Flash":function(d){var l=d.getSelection();if(l=(l=l&&l.getStartElement())&&l._4e_ascendant("img",true))if(l.hasClass("ke_flash")){d=d._toolbars.flash;d.selectedFlash=l;d._showConfig()}}}}();w.addPlugin(function(){new p.Flash(w);var a=q._4e_getWin(w.document);s.on(a,"scroll",function(){p.Flash.tipwin&&p.Flash.tipwin.hide()})})});
KISSY.Editor.add("font",function(w){var p=KISSY.Editor,A=KISSY,q=p.Style,s=p.TripleButton,C=A.Node,m=["8px","10px","12px","14px","18px","24px","36px","48px","60px","72px","84px","96px","108px"],y={},j="<select title='\u5927\u5c0f' style='width:110px;height:21px;'><option value=''>\u5927\u5c0f / \u6e05\u9664</option>",e={element:"span",styles:{"font-size":"#(size)"},overrides:[{element:"font",attributes:{size:null}}]},i=["\u5b8b\u4f53","\u9ed1\u4f53","\u96b6\u4e66","\u6977\u4f53_GB2312","\u5fae\u8f6f\u96c5\u9ed1",
"Georgia","Times New Roman","Impact","Courier New","Arial","Verdana","Tahoma"],k={},r="<select title='\u5b57\u4f53' ><option value=''>\u5b57\u4f53 / \u6e05\u9664</option>",v={element:"span",styles:{"font-family":"#(family)"},overrides:[{element:"font",attributes:{face:null}}]},o;for(o=0;o<m.length;o++){var t=m[o];y[t]=new q(e,{size:t});j+="<option value='"+t+"'>"+t+"</option>"}j+="</select>";for(o=0;o<i.length;o++){m=i[o];k[m]=new q(v,{family:m});r+="<option style='font-family:"+m+"'  value='"+m+
"'>"+m+"</option>"}r+="</select>";p.Font||function(){function a(g){a.superclass.constructor.call(this,g);this._init()}function b(g){b.superclass.constructor.call(this,g);this._init()}a.ATTRS={v:{value:""},html:{},styles:{},editor:{}};A.extend(a,A.Base,{_init:function(){var g=this.get("editor"),h=g.toolBarDiv,d=this.get("html");this.el=new C(d);h[0].appendChild(this.el[0]);this.el.on("change",this._change,this);g.on("selectionChange",this._selectionChange,this);this.on("afterVChange",this._vChange,
this)},_vChange:function(g){var h=this.get("editor"),d=g.newVal;g=g.preVal;var l=this.get("styles");h.focus();h.fire("save");if(d)l[d].apply(h.document);else{d=g;l[d].remove(h.document)}h.fire("save");h.notifySelectionChange()},_change:function(){this.set("v",this.el.val())},_selectionChange:function(g){this.get("editor");var h=this.get("v");g=g.path.elements;for(var d=this.get("styles"),l=0,c;l<g.length;l++){c=g[l];for(var f in d)if(d[f].checkElementRemovable(c,true)){if(f!=h){this._set("v",f);this.el.val(f)}return}}if(h!=
""){this._set("v","");this.el.val("")}}});b.ATTRS={editor:{},text:{},contentCls:{},title:{},style:{}};A.extend(b,A.Base,{_init:function(){var g=this.get("editor"),h=this.get("text");this.get("style");var d=this.get("title");this.el=new s({text:h,title:d,contentCls:this.get("contentCls"),container:g.toolBarDiv});this.el.on("offClick",this._on,this);this.el.on("onClick",this._off,this);g.on("selectionChange",this._selectionChange,this)},_on:function(){var g=this.get("editor");this.get("text");var h=
this.get("style");this.get("title");g.fire("save");h.apply(g.document);g.fire("save");g.notifySelectionChange();g.focus()},_off:function(){var g=this.get("editor");this.get("text");var h=this.get("style");this.get("title");g.fire("save");h.remove(g.document);g.fire("save");g.notifySelectionChange();g.focus()},_selectionChange:function(g){this.get("editor");this.get("text");var h=this.get("style");this.get("title");h.checkActive(g.path)?this.el.set("state",s.ON):this.el.set("state",s.OFF)}});a.SingleFont=
b;p.Font=a}();w.addPlugin(function(){new p.Font({editor:w,styles:y,html:j});new p.Font({editor:w,styles:k,html:r});new p.Font.SingleFont({contentCls:"ke-toolbar-bold",title:"\u7c97\u4f53 ",editor:w,style:new q({element:"strong",overrides:[{element:"b"},{element:"span",attributes:{style:"font-weight: bold;"}}]})});new p.Font.SingleFont({contentCls:"ke-toolbar-italic",title:"\u659c\u4f53 ",editor:w,style:new q({element:"em",overrides:[{element:"i"},{element:"span",attributes:{style:"font-style: italic;"}}]})});
new p.Font.SingleFont({contentCls:"ke-toolbar-underline",title:"\u4e0b\u5212\u7ebf ",editor:w,style:new q({element:"u",overrides:[{element:"span",attributes:{style:"text-decoration: underline;"}}]})});new p.Font.SingleFont({contentCls:"ke-toolbar-strikeThrough",title:"\u5220\u9664\u7ebf ",editor:w,style:new q({element:"del",overrides:[{element:"span",attributes:{style:"text-decoration: line-through;"}},{element:"s"}]})})})});
KISSY.Editor.add("format",function(w){var p=KISSY.Editor,A=KISSY,q=A.Node;p.Format||function(){function s(k){s.superclass.constructor.call(this,k);this.el=new q(C);this._init()}var C="<select style='height:21px' title='\u683c\u5f0f'>",m={"\u6807\u9898 / \u6e05\u9664":"p","\u6807\u98981":"h1","\u6807\u98982":"h2","\u6807\u98983":"h3","\u6807\u98984":"h4","\u6807\u98985":"h5","\u6807\u98986":"h6"},y={h1:"2em",h2:"1.5em",h3:"1.17em",h4:"1em",h5:"0.83em",h6:"0.67em"},j={},e=p.Style;for(var i in m)if(m[i]){j[m[i]]=
new e({element:m[i]});C+="<option style='font-size:"+y[m[i]]+"'value='"+m[i]+"'>"+i+"</option>"}C+="</select>";s.ATTRS={v:{value:"p"},editor:{}};A.extend(s,A.Base,{_init:function(){var k=this.get("editor"),r=this.el;k.toolBarDiv[0].appendChild(this.el[0]);r.on("change",this._change,this);k.on("selectionChange",this._selectionChange,this);this.on("afterVChange",this._vChange,this)},_vChange:function(k){var r=this.get("editor");k=k.newVal;r.focus();r.fire("save");j[k].apply(r.document);r.fire("save");
r.fire("formatChange",this.get("v"))},_change:function(){this.set("v",this.el.val())},_selectionChange:function(k){this.get("editor");var r=this.get("v");k=k.path;for(var v in j)if(j[v].checkActive(k)){if(v!=r){this._set("v",v);this.el.val(v)}return}this._set("v","p");this.el.val("p")}});p.Format=s}();w.addPlugin(function(){new p.Format({editor:w})})});
KISSY.Editor.add("htmlparser-basicwriter",function(){function w(){this._={output:[]}}var p=KISSY.Editor,A=p.Utils;if(!p.HtmlParser.BasicWriter){KISSY.augment(w,{openTag:function(q){this._.output.push("<",q)},openTagClose:function(q,s){s?this._.output.push(" />"):this._.output.push(">")},attribute:function(q,s){if(typeof s=="string")s=A.htmlEncodeAttr(s);this._.output.push(" ",q,'="',s,'"')},closeTag:function(q){this._.output.push("</",q,">")},text:function(q){this._.output.push(q)},comment:function(q){this._.output.push("<!--",
q,"--\>")},write:function(q){this._.output.push(q)},reset:function(){this._.output=[];this._.indent=false},getHtml:function(q){var s=this._.output.join("");q&&this.reset();return s}});p.HtmlParser.BasicWriter=w}});
KISSY.Editor.add("htmlparser-element",function(){function w(s,C){this.name=s;this.attributes=C||(C={});this.children=[];var m=C._ke_real_element_type||s;C=p.XHTML_DTD;m=!!(C.$nonBodyContent[m]||C.$block[m]||C.$listItem[m]||C.$tableContent[m]||C.$nonEditable[m]||m=="br");var y=!!C.$empty[s];this.isEmpty=y;this.isUnknown=!C[s];this._={isBlockLike:m,hasInlineStarted:y||!m}}var p=KISSY.Editor;if(!p.HtmlParser.Element){var A=p.NODE,q=function(s,C){s=s[0];C=C[0];return s<C?-1:s>C?1:0};KISSY.augment(w,{type:A.NODE_ELEMENT,
add:p.HtmlParser.Fragment.prototype.add,clone:function(){return new w(this.name,this.attributes)},writeHtml:function(s,C){var m=this.attributes,y=this,j=y.name,e,i,k,r;y.filterChildren=function(){if(!r){var t=new p.HtmlParser.BasicWriter;p.HtmlParser.Fragment.prototype.writeChildrenHtml.call(y,t,C);y.children=(new p.HtmlParser.Fragment.FromHtml(t.getHtml())).children;r=1}};if(C){for(;;){if(!(j=C.onElementName(j)))return;y.name=j;if(!(y=C.onElement(y)))return;y.parent=this.parent;if(y.name==j)break;
if(y.type!=A.NODE_ELEMENT){y.writeHtml(s,C);return}j=y.name;if(!j){this.writeChildrenHtml.call(y,s,r?null:C);return}}m=y.attributes}s.openTag(j,m);for(var v=[],o=0;o<2;o++)for(e in m){i=e;k=m[e];if(o==1)v.push([e,k]);else if(C){for(;;)if(i=C.onAttributeName(e))if(i!=e){delete m[e];e=i}else break;else{delete m[e];break}if(i)if((k=C.onAttribute(y,i,k))===false)delete m[i];else m[i]=k}}s.sortAttributes&&v.sort(q);m=v.length;for(o=0;o<m;o++){e=v[o];s.attribute(e[0],e[1])}s.openTagClose(j,y.isEmpty);if(!y.isEmpty){this.writeChildrenHtml.call(y,
s,r?null:C);s.closeTag(j)}},writeChildrenHtml:function(){p.HtmlParser.Fragment.prototype.writeChildrenHtml.apply(this,arguments)}});p.HtmlParser.Element=w}});
KISSY.Editor.add("htmlparser-filter",function(){function w(j){this._={elementNames:[],attributeNames:[],elements:{$length:0},attributes:{$length:0}};j&&this.addRules(j,10)}function p(j,e){for(var i=0;j&&i<e.length;i++){var k=e[i];j=j.replace(k[0],k[1])}return j}function A(j,e,i){if(typeof e=="function")e=[e];var k,r;r=j.length;var v=e&&e.length;if(v){for(k=0;k<r&&j[k].pri<i;k++);for(r=v-1;r>=0;r--)if(v=e[r]){v.pri=i;j.splice(k,0,v)}}}function q(j,e,i){if(e)for(var k in e){var r=j[k];j[k]=s(r,e[k],
i);r||j.$length++}}function s(j,e,i){if(e){e.pri=i;if(j){if(j.splice)A(j,e,i);else{j=j.pri>i?[e,j]:[j,e];j.filter=C}return j}else return e.filter=e}}function C(j){for(var e=j.type||j instanceof m.HtmlParser.Fragment,i=0;i<this.length;i++){if(e)var k=j.type,r=j.name;var v=this[i].apply(window,arguments);if(v===false)return v;if(e){if(v&&(v.name!=r||v.type!=k))return v}else if(typeof v!="string")return v;v!=undefined&&(j=v)}return j}var m=KISSY.Editor,y=m.NODE;if(!m.HtmlParser.Filter){KISSY.augment(w,
{addRules:function(j,e){if(typeof e!="number")e=10;A(this._.elementNames,j.elementNames,e);A(this._.attributeNames,j.attributeNames,e);q(this._.elements,j.elements,e);q(this._.attributes,j.attributes,e);this._.text=s(this._.text,j.text,e)||this._.text;this._.comment=s(this._.comment,j.comment,e)||this._.comment;this._.root=s(this._.root,j.root,e)||this._.root},onElementName:function(j){return p(j,this._.elementNames)},onAttributeName:function(j){return p(j,this._.attributeNames)},onText:function(j){var e=
this._.text;return e?e.filter(j):j},onComment:function(j,e){var i=this._.comment;return i?i.filter(j,e):j},onFragment:function(j){var e=this._.root;return e?e.filter(j):j},onElement:function(j){for(var e=[this._.elements["^"],this._.elements[j.name],this._.elements.$],i,k=0;k<3;k++)if(i=e[k]){i=i.filter(j,this);if(i===false)return null;if(i&&i!=j)return this.onNode(i);if(j.parent&&!j.name)break}return j},onNode:function(j){var e=j.type;return e==y.NODE_ELEMENT?this.onElement(j):e==y.NODE_TEXT?new m.HtmlParser.Text(this.onText(j.value)):
null},onAttribute:function(j,e,i){if(e=this._.attributes[e]){j=e.filter(i,j,this);if(j===false)return false;if(typeof j!="undefined")return j}return i}});m.HtmlParser.Filter=w}});
KISSY.Editor.add("htmlparser-fragment",function(){function w(){this.children=[];this.parent=null;this._={isBlockLike:true,hasInlineStarted:false}}var p=KISSY.Editor;if(!p.HtmlParser.Fragment){var A={colgroup:1,dd:1,dt:1,li:1,option:1,p:1,td:1,tfoot:1,th:1,thead:1,tr:1},q=KISSY,s=p.Utils,C=p.NODE,m=p.XHTML_DTD,y=s.mix({table:1,ul:1,ol:1,dl:1},m.table,m.ul,m.ol,m.dl),j=m.$list,e=m.$listItem;w.FromHtml=function(i,k){function r(f){var n;if(b.length>0)for(var z=0;z<b.length;z++){var u=b[z],D=u.name,I=
m[D],x=h.name&&m[h.name];if((!x||x[D])&&(!f||!I||I[f]||!m[f])){if(!n){v();n=1}u=u.clone();u.parent=h;h=u;b.splice(z,1);z--}}}function v(){for(;g.length;)h.add(g.shift())}function o(f,n,z){n=n||h||a;if(k&&!n.type){var u,D;if((u=f.attributes&&(D=f.attributes._ke_real_element_type)?D:f.name)&&!(u in m.$body)&&!(u in m.$nonBodyContent)){u=h;h=n;t.onTagOpen(k,{});n=h;if(z)h=u}}if(f._.isBlockLike&&f.name!="pre"){z=f.children.length;if((u=f.children[z-1])&&u.type==C.NODE_TEXT)if(D=s.rtrim(u.value))u.value=
D;else f.children.length=z-1}n.add(f);if(f.returnPoint){h=f.returnPoint;delete f.returnPoint}}var t=new p.HtmlParser,a=new w,b=[],g=[],h=a,d=false,l;t.onTagOpen=function(f,n,z){var u=new p.HtmlParser.Element(f,n);if(u.isUnknown&&z)u.isEmpty=true;if(m.$removeEmpty[f])b.push(u);else{if(f=="pre")d=true;else if(f=="br"&&d){h.add(new p.HtmlParser.Text("\n"));return}if(f=="br")g.push(u);else{var D=h.name,I=D&&(m[D]||(h._.isBlockLike?m.div:m.span));if(I&&!u.isUnknown&&!h.isUnknown&&!I[f]){I=false;var x;
if(f in j&&D in j){D=h.children;(D=D[D.length-1])&&D.name in e||o(D=new p.HtmlParser.Element("li"),h);l=h;x=D}else if(f==D)o(h,h.parent);else{if(y[D])l||(l=h);else{o(h,h.parent,true);A[D]||b.unshift(h)}I=true}h=x?x:h.returnPoint||h.parent;if(I){t.onTagOpen.apply(this,arguments);return}}r(f);v();u.parent=h;u.returnPoint=l;l=0;if(u.isEmpty)o(u);else h=u}}};t.onTagClose=function(f){for(var n=b.length-1;n>=0;n--)if(f==b[n].name){b.splice(n,1);return}for(var z=[],u=[],D=h;D.type&&D.name!=f;){D._.isBlockLike||
u.unshift(D);z.push(D);D=D.parent}if(D.type){for(n=0;n<z.length;n++){var I=z[n];o(I,I.parent)}h=D;if(h.name=="pre")d=false;D._.isBlockLike&&v();o(D,D.parent);if(D==h)h=h.parent;b=b.concat(u)}if(f=="body")k=false};t.onText=function(f){if(!h._.hasInlineStarted&&!d){f=s.ltrim(f);if(f.length===0)return}v();r();if(k&&(!h.type||h.name=="body")&&s.trim(f))this.onTagOpen(k,{});d||(f=f.replace(/[\t\r\n ]{2,}|[\t\r\n]/g," "));h.add(new p.HtmlParser.Text(f))};t.onCDATA=function(){};t.onComment=function(){};
t.parse(i);for(v();h.type;){i=h.parent;var c=h;if(k&&(!i.type||i.name=="body")&&!m.$body[c.name]){h=i;t.onTagOpen(k,{});i=h}i.add(c);h=i}return a};q.augment(w,{add:function(i){var k=this.children.length;if(k=k>0&&this.children[k-1]||null){if(i._.isBlockLike&&k.type==C.NODE_TEXT){k.value=s.rtrim(k.value);if(k.value.length===0){this.children.pop();this.add(i);return}}k.next=i}i.previous=k;i.parent=this;this.children.push(i);this._.hasInlineStarted=i.type==C.NODE_TEXT||i.type==C.NODE_ELEMENT&&!i._.isBlockLike},
writeHtml:function(i,k){var r;this.filterChildren=function(){var v=new p.HtmlParser.BasicWriter;this.writeChildrenHtml.call(this,v,k,true);v=v.getHtml();this.children=(new w.FromHtml(v)).children;r=1};!this.name&&k&&k.onFragment(this);this.writeChildrenHtml(i,r?null:k)},writeChildrenHtml:function(i,k){for(var r=0;r<this.children.length;r++)this.children[r].writeHtml(i,k)}});p.HtmlParser.Fragment=w}});
KISSY.Editor.add("htmlparser",function(){function w(){this._={htmlPartsRegex:new RegExp("<(?:(?:\\/([^>]+)>)|(?:!--([\\S|\\s]*?)--\>)|(?:([^\\s>]+)\\s*((?:(?:[^\"'>]+)|(?:\"[^\"]*\")|(?:'[^']*'))*)\\/?>))","g")}}var p=KISSY.Editor;if(!p.HtmlParser){var A=/([\w\-:.]+)(?:(?:\s*=\s*(?:(?:"([^"]*)")|(?:'([^']*)')|([^\s>]+)))|(?=\s|$))/g,q={checked:1,compact:1,declare:1,defer:1,disabled:1,ismap:1,multiple:1,nohref:1,noresize:1,noshade:1,nowrap:1,readonly:1,selected:1},s=p.XHTML_DTD;KISSY.augment(w,{onTagOpen:function(){},
onTagClose:function(){},onText:function(){},onCDATA:function(){},onComment:function(){},parse:function(C){for(var m,y,j=0,e;m=this._.htmlPartsRegex.exec(C);){y=m.index;if(y>j){j=C.substring(j,y);e?e.push(j):this.onText(j)}j=this._.htmlPartsRegex.lastIndex;if(y=m[1]){y=y.toLowerCase();if(e&&s.$cdata[y]){this.onCDATA(e.join(""));e=null}if(!e){this.onTagClose(y);continue}}if(e)e.push(m[0]);else if(y=m[3]){y=y.toLowerCase();var i={},k;m=m[4];var r=!!(m&&m.charAt(m.length-1)=="/");if(m)for(;k=A.exec(m);){var v=
k[1].toLowerCase();k=k[2]||k[3]||k[4]||"";i[v]=!k&&q[v]?v:k}this.onTagOpen(y,i,r);if(!e&&s.$cdata[y])e=[]}else if(y=m[2])this.onComment(y)}C.length>j&&this.onText(C.substring(j,C.length))}});p.HtmlParser=w}});
KISSY.Editor.add("htmlparser-htmlwriter",function(){function w(){w.superclass.constructor.call(this);this.indentationChars="\t";this.selfClosingEnd=" />";this.lineBreakChars="\n";this.forceSimpleAmpersand=false;this.sortAttributes=true;this._.indent=false;this._.indentation="";this._.rules={};var q=p.XHTML_DTD;for(var s in A.mix({},q.$nonBodyContent,q.$block,q.$listItem,q.$tableContent))this.setRules(s,{indent:true,breakBeforeOpen:true,breakAfterOpen:true,breakBeforeClose:!q[s]["#"],breakAfterClose:true});
this.setRules("br",{breakAfterOpen:true});this.setRules("title",{indent:false,breakAfterOpen:false});this.setRules("style",{indent:false,breakBeforeClose:true});this.setRules("pre",{indent:false})}var p=KISSY.Editor,A=p.Utils;if(!p.HtmlParser.HtmlWriter){KISSY.extend(w,p.HtmlParser.BasicWriter,{openTag:function(q){var s=this._.rules[q];if(this._.indent)this.indentation();else if(s&&s.breakBeforeOpen){this.lineBreak();this.indentation()}this._.output.push("<",q)},openTagClose:function(q,s){q=this._.rules[q];
if(s)this._.output.push(this.selfClosingEnd);else{this._.output.push(">");if(q&&q.indent)this._.indentation+=this.indentationChars}q&&q.breakAfterOpen&&this.lineBreak()},attribute:function(q,s){if(typeof s=="string"){this.forceSimpleAmpersand&&(s=s.replace(/&amp;/g,"&"));s=A.htmlEncodeAttr(s)}this._.output.push(" ",q,'="',s,'"')},closeTag:function(q){var s=this._.rules[q];if(s&&s.indent)this._.indentation=this._.indentation.substr(this.indentationChars.length);if(this._.indent)this.indentation();
else if(s&&s.breakBeforeClose){this.lineBreak();this.indentation()}this._.output.push("</",q,">");s&&s.breakAfterClose&&this.lineBreak()},text:function(q){if(this._.indent){this.indentation();q=A.ltrim(q)}this._.output.push(q)},comment:function(q){this._.indent&&this.indentation();this._.output.push("<!--",q,"--\>")},lineBreak:function(){this._.output.length>0&&this._.output.push(this.lineBreakChars);this._.indent=true},indentation:function(){this._.output.push(this._.indentation);this._.indent=false},
setRules:function(q,s){var C=this._.rules[q];if(C)A.mix(C,s);else this._.rules[q]=s}});p.HtmlParser.HtmlWriter=w}});KISSY.Editor.add("htmlparser-text",function(){function w(A){this.value=A;this._={isBlockLike:false}}var p=KISSY.Editor;if(!p.HtmlParser.Text){KISSY.augment(w,{type:p.NODE.NODE_TEXT,writeHtml:function(A,q){var s=this.value;q&&!(s=q.onText(s,this))||A.text(s)}});p.HtmlParser.Text=w}});
KISSY.Editor.add("htmldataprocessor",function(){function w(e){e=e.replace(/mso-[^;]+(;|$)/ig,"").replace(/line-height[^;]+(;|$)/ig,"").replace(/font-size[^;]+pt(;|$)/ig,"").replace(/font-family[^;]+(;|$)/ig,"").replace(/display\s*:\s*none\s*(;|$)/ig,"");return A.trim(e)}var p=KISSY.Editor;if(!p.HtmlDataProcessor){var A=KISSY,q=A.UA,s=p.HtmlParser,C=new s.Filter,m=new s.Filter,y={elementNames:[[/^script$/i,""],[/^iframe$/i,""],[/^style$/i,""],[/^link$/i,""],[/^meta$/i,""],[/^\?xml.*$/i,""],[/^.*namespace.*$/i,
""]],elements:{font:function(e){delete e.name},$:function(e){(e.name||"").indexOf(":")!=-1&&delete e.name},table:function(e){var i=e.attributes.border;if(!i||i=="0")e.attributes["class"]="ke_show_border"},span:function(e){var i=e.attributes.style;if(!i||!w(i)){e.filterChildren();delete e.name}}},attributes:{"class":function(e){if(/^ke_/.test(e))return e;return false},style:function(e){e=w(e);if(!e)return false;return e}},attributeNames:[[/^on/,"ck_on"],[/^lang$/,""]]},j={elementNames:[[/^ke:/,""],
[/^\?xml:namespace$/,""]],elements:{embed:function(e){var i=e.parent;if(i&&i.name=="object"){var k=i.attributes.width;i=i.attributes.height;k&&(e.attributes.width=k);i&&(e.attributes.height=i)}},param:function(e){e.children=[];e.isEmpty=true;return e},a:function(e){if(!(e.children.length||e.attributes.name))return false},span:function(e){if(!e.children.length)return false}},attributes:{},attributeNames:[[/^ck_on/,"on"]]};if(q.ie)j.attributes.style=function(e){return e.toLowerCase()};C.addRules(j);
m.addRules(y);p.HtmlDataProcessor={htmlFilter:C,dataFilter:m,toHtml:function(e,i){var k=new s.HtmlWriter;s.Fragment.FromHtml(e,i).writeHtml(k,C);return k.getHtml(true)},toDataFormat:function(e,i){var k=new s.HtmlWriter;e=s.Fragment.FromHtml(e,i);k.reset();e.writeHtml(k,m);return k.getHtml(true)}}}});
KISSY.Editor.add("image",function(w){var p=KISSY.Editor,A=KISSY,q=A.Node,s=A.DOM,C=A.Event,m=p.SimpleOverlay;p.ImageInserter||function(){function y(e){y.superclass.constructor.call(this,e);this._init()}var j=p.TripleButton;y.ATTRS={editor:{}};A.extend(y,A.Base,{_init:function(){var e=this.get("editor").toolBarDiv;this.el=new j({contentCls:"ke-toolbar-image",title:"\u56fe\u50cf",container:e});this.el.on("offClick",this.show,this);p.Utils.lazyRun(this,"_prepare","_real")},_prepare:function(){var e=
this,i=e.get("editor");e.d=new m({title:"\u63d2\u5165\u56fe\u7247",mask:true,width:"350px"});var k=e.d;k.body.html("<div><p><label><span style='color:#0066CC;font-weight:bold;'>\u56fe\u7247\u7f51\u5740\uff1a</span><input class='ke-img-url' style='width:230px' value='http://'/></label></p></div>");k.foot.html("<button class='ke-img-insert'>\u63d2\u5165</button> <button class='ke-img-cancel'>\u53d6\u6d88</button>");e.content=k.el;k=e.content;var r=k.one(".ke-img-cancel"),v=k.one(".ke-img-insert");e.imgUrl=
k.one(".ke-img-url");r.on("click",function(o){e.d.hide();o.halt()});C.on(document,"click",e.hide,e);C.on(i.document,"click",e.hide,e);v.on("click",function(){e._insert()})},hide:function(e){var i=this;s._4e_ascendant(e.target,function(k){return k[0]===i.content[0]||k[0]===i.el.el[0]},true)||this.d.hide()},_real:function(){this.d.show()},_insert:function(){var e=this.get("editor"),i=this.imgUrl.val();if(i){i=new q("<img src='"+i+"'/>",null,e.document);e.insertElement(i);this.d.hide()}},show:function(){this._prepare()}});
p.ImageInserter=y}();w.addPlugin(function(){new p.ImageInserter({editor:w})})});
KISSY.Editor.add("indent",function(w){var p=KISSY.Editor,A={ol:1,ul:1},q=KISSY,s=p.Walker,C=q.DOM,m=q.Node,y=q.UA,j=p.NODE;p.Indent||function(){function e(g){this.type=g;this.indentCssProperty="margin-left";this.indentOffset=40;this.indentUnit="px"}function i(g){return g.type=CKEDITOR.NODE_ELEMENT&&g.is("li")}function k(g,h,d){var l=h.startContainer;for(g=h.endContainer;l&&l.parent()[0]!==d[0];)l=l.parent();for(;g&&g.parent()[0]!==d[0];)g=g.parent();if(l&&g){var c=l;l=[];for(var f=false;!f;){if(c[0]===
g[0])f=true;l.push(c);c=c.next()}if(!(l.length<1)){c=d._4e_parents(true);for(g=0;g<c.length;g++)if(A[c[g]._4e_name()]){d=c[g];break}c=this.type=="indent"?1:-1;g=l[0];f=l[l.length-1];l={};var n=p.ListUtils.listToArray(d,l),z=n[f._4e_getData("listarray_index")].indent;for(g=g._4e_getData("listarray_index");g<=f._4e_getData("listarray_index");g++){n[g].indent+=c;var u=n[g].parent;n[g].parent=new m(u[0].ownerDocument.createElement(u._4e_name()))}for(g=f._4e_getData("listarray_index")+1;g<n.length&&n[g].indent>
z;g++)n[g].indent+=c;f=p.ListUtils.arrayToList(n,l,null,"p",0);c=[];if(this.type=="outdent"){var D;if((D=d.parent())&&D._4e_name()=="li"){n=f.listNode.childNodes;var I;for(g=n.length-1;g>=0;g--)if((I=new m(n[g]))&&I._4e_name()=="li")c.push(I)}}if(f){C.insertBefore(f.listNode,d[0]);d._4e_remove()}if(c&&c.length)for(g=0;g<c.length;g++){for(I=d=c[g];(I=I.next())&&I._4e_name()in A;){y.ie&&!d._4e_first(function(x){return t(x)&&a(x)})&&d[0].appendChild(h.document.createTextNode("\u00a0"));d[0].appendChild(I[0])}C.insertAfter(d[0],
D[0])}for(g in l)l[g]._4e_clearMarkers(l,true)}}}function r(g,h){h=h.createIterator();h.enforceRealBlocks=true;h.enlargeBr=true;for(var d;d=h.getNextParagraph();)v.call(this,g,d)}function v(g,h){g=parseInt(h._4e_style(this.indentCssProperty),10);if(isNaN(g))g=0;g+=(this.type=="indent"?1:-1)*this.indentOffset;if(g<0)return false;g=Math.max(g,0);g=Math.ceil(g/this.indentOffset)*this.indentOffset;h.css(this.indentCssProperty,g?g+this.indentUnit:"");h[0].style.cssText===""&&h[0].removeAttribute("style");
return true}function o(g){o.superclass.constructor.call(this,g);g=this.get("editor").toolBarDiv;this.el=new b({container:g,contentCls:this.get("contentCls"),title:this.get("title")});this.indentCommand=new e(this.get("type"));this._init()}var t=s.whitespaces(true),a=s.bookmark(false,true);q.augment(e,{exec:function(g){g.focus();for(var h=g.getSelection(),d=h&&h.getRanges()[0],l=d.startContainer,c=d.endContainer,f=d.getCommonAncestor();f&&!(f[0].nodeType==j.NODE_ELEMENT&&A[f._4e_name()]);)f=f.parent();
if(f&&l[0].nodeType==j.NODE_ELEMENT&&l._4e_name()in A){l=new s(d);l.evaluator=i;d.startContainer=l.next()}if(f&&c[0].nodeType==j.NODE_ELEMENT&&c._4e_name()in A){l=new s(d);l.evaluator=i;d.endContainer=l.previous()}c=h.createBookmarks(true);if(f){for(l=f._4e_first();l&&l[0]&&l._4e_name()!="li";)l=l.next();var n=d.startContainer;(l[0]==n[0]||l._4e_contains(n))&&v.call(this,g,f)||k.call(this,g,d,f)}else r.call(this,g,d);g.focus();h.selectBookmarks(c)}});var b=p.TripleButton;o.ATTRS={type:{},contentCls:{},
editor:{}};q.extend(o,q.Base,{_init:function(){var g=this.get("editor"),h=this.el;h.on("offClick",this.exec,this);this.get("type")=="outdent"?g.on("selectionChange",this._selectionChange,this):h.set("state",b.OFF)},exec:function(){var g=this.get("editor"),h=this;g.focus();g.fire("save");setTimeout(function(){h.indentCommand.exec(g);g.fire("save");g.notifySelectionChange()},10)},_selectionChange:function(g){this.get("editor");this.get("type");var h=g.path,d=h.blockLimit;g=this.el;if(h.contains(A))g.set("state",
b.OFF);else(h=h.block||d)&&h._4e_style(this.indentCommand.indentCssProperty)?g.set("state",b.OFF):g.set("state",b.DISABLED)}});p.Indent=o}();w.addPlugin(function(){w.addCommand("outdent",new p.Indent({editor:w,title:"\u51cf\u5c11\u7f29\u8fdb\u91cf",contentCls:"ke-toolbar-outdent",type:"outdent"}));w.addCommand("indent",new p.Indent({editor:w,title:"\u589e\u52a0\u7f29\u8fdb\u91cf",contentCls:"ke-toolbar-indent",type:"indent"}))})});
KISSY.Editor.add("justify",function(w){var p=KISSY.Editor,A=KISSY,q=p.TripleButton;p.Justify||function(){function s(m,y,j,e){this.editor=m;this.v=y;this.contentCls=e;this.title=j;this._init()}var C=/(-moz-|-webkit-|start|auto)/i;A.augment(s,{_init:function(){var m=this.editor;this.el=new q({contentCls:this.contentCls,title:this.title,container:m.toolBarDiv});m.on("selectionChange",this._selectionChange,this);this.el.on("click",this._effect,this)},_effect:function(){var m=this.editor,y=m.getSelection(),
j=this.el.get("state");if(y){var e=y.createBookmarks(),i=y.getRanges(),k,r;m.fire("save");for(var v=i.length-1;v>=0;v--){k=i[v].createIterator();for(k.enlargeBr=true;r=k.getNextParagraph();){r.removeAttr("align");j==q.OFF?r.css("text-align",this.v):r.css("text-align","")}}m.focus();m.notifySelectionChange();y.selectBookmarks(e);m.fire("save")}},_selectionChange:function(m){var y=this.el;m=m.path;if(m=m.block||m.blockLimit){m=m.css("text-align").replace(C,"");m==this.v||!m&&this.v=="left"?y.set("state",
q.ON):y.set("state",q.OFF)}}});p.Justify=s}();w.addPlugin(function(){new p.Justify(w,"left","\u5de6\u5bf9\u9f50","ke-toolbar-alignleft");new p.Justify(w,"center","\u5c45\u4e2d\u5bf9\u9f50","ke-toolbar-aligncenter");new p.Justify(w,"right","\u53f3\u5bf9\u9f50","ke-toolbar-alignright")})});
KISSY.Editor.add("link",function(w){var p=KISSY.Editor,A=KISSY,q=A.DOM,s=A.Event,C=p.TripleButton,m=p.Style,y=A.Node,j=p.Range,e=p.SimpleOverlay,i=p.HtmlDataProcessor,k=i&&i.dataFilter;p.Link||function(){function r(a){this.editor=a;this._init()}k&&k.addRules({elements:{a:function(a){for(var b in a.attributes)b=="href"||b=="target"||delete a.attributes[b]}}});var v={element:"a",attributes:{href:"#(href)",target:"#(target)"}};r.init=function(){var a=this;a.d=new e({title:"\u4fee\u6539\u94fe\u63a5",
mask:true,width:"300px"});a.d.body.html(o);a.d.foot.html(t);a.urlEl=a.d.body.one(".ke-link-url");a.targetEl=a.d.body.one(".ke-link-blank");var b=a.d.foot.one(".ke-link-cancel");a.ok=a.d.foot.one(".ke-link-ok");r.ok.on("click",function(g){r.d.link._link();g.halt()},this);b.on("click",function(g){a.d.hide();g.halt()},a);r.init=null};r.tip=function(){var a=this,b=new y('<div class="ke-bubbleview-bubble" onmousedown="return false;">\u524d\u5f80\u94fe\u63a5\uff1a  <a href=""  target="_blank" class="ke-bubbleview-url"></a> -     <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -     <span class="ke-bubbleview-link ke-bubbleview-remove">\u53bb\u9664</span></div>');
b._4e_unselectable();a.tipwin=new e({el:b,focusMgr:false});document.body.appendChild(b[0]);a.tipurl=b.one(".ke-bubbleview-url");var g=b.one(".ke-bubbleview-change");b=b.one(".ke-bubbleview-remove");g.on("click",function(h){r.tipwin.link.show();h.halt()});s.on(document,"click",function(){a.tipwin.hide()});b.on("click",function(h){r.tipwin.link._removeLink();h.halt()});r.tip=null};var o="<div><p><label><span style='color:#0066CC;font-weight:bold;'>\u7f51\u5740\uff1a</span><input class='ke-link-url' style='width:230px' value='http://'/></label></p><p style='margin-top: 5px;padding-left:45px'><label><input class='ke-link-blank' type='checkbox'/> &nbsp; \u5728\u65b0\u7a97\u53e3\u6253\u5f00\u94fe\u63a5</label></p></div>",
t="<button class='ke-link-ok'>\u786e\u5b9a</button> <button class='ke-link-cancel'>\u53d6\u6d88</button>";A.augment(r,{_init:function(){var a=this.editor;this.el=new C({container:a.toolBarDiv,contentCls:"ke-toolbar-link",title:"\u7f16\u8f91\u8d85\u94fe\u63a5 "});this.el.on("click",this.show,this);a.on("selectionChange",this._selectionChange,this)},_prepareTip:function(){r.tip&&r.tip()},_realTip:function(a){var b=a._4e_getOffset(document);b.top+=a.height()+5;r.tipwin.show(b);this._a=a;r.tipwin.link=
this;r.tipurl.html(a.attr("href"));r.tipurl.attr("href",a.attr("href"))},_showTip:function(a){this._prepareTip(a)},_hideTip:function(){r.tipwin&&r.tipwin.hide()},_removeLink:function(){var a=this._a,b=this.editor;b.focus();var g={href:a.attr("href")};if(a._4e_hasAttribute("target"))g.target=a.attr("target");a=new m(v,g);b.fire("save");a.remove(b.document);b.fire("save");b.focus();b.notifySelectionChange()},_selectionChange:function(a){a=a.path;var b=a.elements;if(a&&b)if(a=a.lastElement)(a=a._4e_ascendant(function(g){return g._4e_name()===
"a"&&!!g.attr("href")},true))?this._showTip(a):this._hideTip()},hide:function(){r.d.hide()},_getSelectedLink:function(){var a=this.editor;if(r.tipwin&&r.tipwin.get("visible")){(a=a.getSelection().getRanges()[0].getCommonAncestor())&&(a=a._4e_ascendant(function(b){return b._4e_name()=="a"&&!!b.attr("href")},true));if(a&&a[0]==r.tipwin.link._a[0])return a}},_link:function(){var a,b=this.editor,g=r.urlEl.val();b.focus();if(A.trim(g)){var h=this._getSelectedLink();if(h){a=new j(b.document);a.selectNodeContents(h);
b.getSelection().selectRanges([a]);this._removeLink()}h={href:g};h.target=r.targetEl[0].checked?"_blank":"_self";a=b.getSelection().getRanges()[0];if(a.collapsed){a=new y("<a href='"+g+"' target='"+h.target+"'>"+g+"</a>",null,b.document);b.insertElement(a)}else{b.fire("save");(new m(v,h)).apply(b.document);b.fire("save")}this.hide();b.focus();b.notifySelectionChange()}},_prepare:function(){r.init&&r.init()},_real:function(){r.d.link=this;var a=this._getSelectedLink();if(a){r.urlEl.val(a.attr("href"));
r.targetEl[0].checked=a.attr("target")=="_blank"}r.d.show()},show:function(){this._prepare()}});p.Utils.lazyRun(r.prototype,"_prepare","_real");p.Utils.lazyRun(r.prototype,"_prepareTip","_realTip");p.Link=r}();w.addPlugin(function(){new p.Link(w);var r=q._4e_getWin(w.document);s.on(r,"scroll",function(){p.Link.tipwin&&p.Link.tipwin.hide()})})});
KISSY.Editor.add("list",function(w){var p=KISSY.Editor,A={ol:1,ul:1},q=["ol","ul"],s=KISSY,C=p.RANGE,m=p.ElementPath,y=p.Walker,j=p.NODE,e=s.UA,i=s.Node,k=s.DOM;p.List||function(){function r(b){this.type=b}function v(b){v.superclass.constructor.call(this,b);b=this.get("editor").toolBarDiv;this.el=new a({contentCls:this.get("contentCls"),title:this.get("title"),container:b});this.listCommand=new r(this.get("type"));this.listCommand.state=this.get("status");this._init()}var o={listToArray:function(b,
g,h,d,l){if(!A[b._4e_name()])return[];d||(d=0);h||(h=[]);for(var c=0,f=b[0].childNodes.length;c<f;c++){var n=new i(b[0].childNodes[c]);if(n._4e_name()=="li"){var z={parent:b,indent:d,element:n,contents:[]};if(l)z.grandparent=l;else{z.grandparent=b.parent();if(z.grandparent&&z.grandparent._4e_name()=="li")z.grandparent=z.grandparent.parent()}g&&n._4e_setMarker(g,"listarray_index",h.length);h.push(z);for(var u=0,D=n[0].childNodes.length,I;u<D;u++){I=new i(n[0].childNodes[u]);I[0].nodeType==j.NODE_ELEMENT&&
A[I._4e_name()]?o.listToArray(I,g,h,d+1,z.grandparent):z.contents.push(I)}}}return h},arrayToList:function(b,g,h,d){h||(h=0);if(!b||b.length<h+1)return null;for(var l=b[h].parent[0].ownerDocument,c=l.createDocumentFragment(),f=null,n=h,z=Math.max(b[h].indent,0),u=null;;){var D=b[n];if(D.indent==z){if(!f||b[n].parent._4e_name()!=f._4e_name()){f=b[n].parent._4e_clone(false,true);c.appendChild(f[0])}u=f[0].appendChild(D.element._4e_clone(false,true)[0]);for(var I=0;I<D.contents.length;I++)u.appendChild(D.contents[I]._4e_clone(true,
true)[0]);n++}else if(D.indent==Math.max(z,0)+1){n=o.arrayToList(b,null,n,d);u.appendChild(n.listNode);n=n.nextIndex}else if(D.indent==-1&&!h&&D.grandparent){u=A[D.grandparent._4e_name()]?D.element._4e_clone(false,true)[0]:D.grandparent._4e_name()!="td"?l.createElement(d):l.createDocumentFragment();for(I=0;I<D.contents.length;I++)u.appendChild(D.contents[I]._4e_clone(true,true)[0]);if(u.nodeType==j.NODE_DOCUMENT_FRAGMENT&&n!=b.length-1){u.lastChild&&u.lastChild.nodeType==j.NODE_ELEMENT&&u.lastChild.getAttribute("type")==
"_moz"&&k._4e_remove(u.lastChild);k._4e_appendBogus(u)}if(u.nodeType==j.NODE_ELEMENT&&k._4e_name(u)==d&&u.firstChild){k._4e_trim(u);f=u.firstChild;if(f.nodeType==j.NODE_ELEMENT&&k._4e_isBlockBoundary(f)){f=l.createDocumentFragment();k._4e_moveChildren(u,f);u=f}}f=k._4e_name(u);if(!e.ie&&(f=="div"||f=="p"))k._4e_appendBogus(u);c.appendChild(u);f=null;n++}else return null;if(b.length<=n||Math.max(b[n].indent,0)<z)break}if(g)for(b=new i(c.firstChild);b&&b[0];){b[0].nodeType==j.NODE_ELEMENT&&b._4e_clearMarkers(g,
true);b=b._4e_nextSourceNode()}return{listNode:c,nextIndex:n}}},t=/^h[1-6]$/;r.prototype={changeListType:function(b,g,h,d){var l=o.listToArray(g.root,h),c=[];for(b=0;b<g.contents.length;b++){var f=g.contents[b];f=f._4e_ascendant("li",true);if(!(!f||!f[0]||f._4e_getData("list_item_processed"))){c.push(f);f._4e_setMarker(h,"list_item_processed",true)}}f=new i(g.root[0].ownerDocument.createElement(this.type));for(b=0;b<c.length;b++){var n=c[b]._4e_getData("listarray_index");l[n].parent=f}h=o.arrayToList(l,
h,null,"p");var z;l=h.listNode.childNodes.length;for(b=0;b<l&&(z=new i(h.listNode.childNodes[b]));b++)z._4e_name()==this.type&&d.push(z);k.insertBefore(h.listNode,g.root[0]);g.root._4e_remove()},createList:function(b,g,h){var d=g.contents;b=g.root[0].ownerDocument;var l=[];if(d.length==1&&d[0][0]===g.root[0]){var c=new i(b.createElement("div"));d[0][0].nodeType!=j.NODE_TEXT&&d[0]._4e_moveChildren(c);d[0][0].appendChild(c[0]);d[0]=c}g=g.contents[0].parent();for(c=0;c<d.length;c++)g=g._4e_commonAncestor(d[c].parent());
for(c=0;c<d.length;c++)for(var f=d[c],n;n=f.parent();){if(n[0]===g[0]){l.push(f);break}f=n}if(!(l.length<1)){d=new i(l[l.length-1][0].nextSibling);c=new i(b.createElement(this.type));for(h.push(c);l.length;){h=l.shift();f=new i(b.createElement("li"));if(t.test(h._4e_name()))f[0].appendChild(h[0]);else{h._4e_copyAttributes(f);h._4e_moveChildren(f);h._4e_remove()}c[0].appendChild(f[0]);e.ie||f._4e_appendBogus()}d[0]?k.insertBefore(c[0],d[0]):g[0].appendChild(c[0])}},removeList:function(b,g,h){function d(I){if((u=
new i(z[I?"firstChild":"lastChild"]))&&!(u[0].nodeType==j.NODE_ELEMENT&&u._4e_isBlockBoundary())&&(D=g.root[I?"_4e_previous":"_4e_next"](y.whitespaces(true)))&&!(u[0].nodeType==j.NODE_ELEMENT&&D._4e_isBlockBoundary({br:1})))k[I?"insertBefore":"insertAfter"](b.document.createElement("br"),u[0])}for(var l=o.listToArray(g.root,h),c=[],f=0;f<g.contents.length;f++){var n=g.contents[f];n=n._4e_ascendant("li",true);if(!(!n||n._4e_getData("list_item_processed"))){c.push(n);n._4e_setMarker(h,"list_item_processed",
true)}}n=null;for(f=0;f<c.length;f++){n=c[f]._4e_getData("listarray_index");l[n].indent=-1;n=n}for(f=n+1;f<l.length;f++)if(l[f].indent>Math.max(l[f-1].indent,0)){c=l[f-1].indent+1-l[f].indent;for(n=l[f].indent;l[f]&&l[f].indent>=n;){l[f].indent+=c;f++}f--}var z=o.arrayToList(l,h,null,"p").listNode,u,D;d(true);d();k.insertBefore(z,g.root);g.root._4e_remove()},exec:function(b){b.focus();var g=b.getSelection(),h=g&&g.getRanges();if(!(!h||h.length<1)){for(var d=g.createBookmarks(true),l=[],c={};h.length>
0;){var f=h.shift(),n=f.getBoundaryNodes(),z=n.startNode,u=n.endNode;z[0].nodeType==j.NODE_ELEMENT&&z._4e_name()=="td"&&f.setStartAt(n.startNode,C.POSITION_AFTER_START);u[0].nodeType==j.NODE_ELEMENT&&u._4e_name()=="td"&&f.setEndAt(n.endNode,C.POSITION_BEFORE_END);f=f.createIterator();for(f.forceBrBreak=false;n=f.getNextParagraph();){z=new m(n);u=z.elements;var D=null,I=false,x=z.blockLimit,B;for(z=u.length-1;z>=0&&(B=u[z]);z--)if(A[B._4e_name()]&&x.contains(B)){x._4e_removeData("list_group_object");
if(z=B._4e_getData("list_group_object"))z.contents.push(n);else{z={root:B,contents:[n]};l.push(z);B._4e_setMarker(c,"list_group_object",z)}I=true;break}if(!I)if(x._4e_getData("list_group_object"))x._4e_getData("list_group_object").contents.push(n);else{z={root:x,contents:[n]};x._4e_setMarker(c,"list_group_object",z);l.push(z)}}}for(h=[];l.length>0;){z=l.shift();if(this.state=="off")A[z.root._4e_name()]?this.changeListType(b,z,c,h):this.createList(b,z,h);else this.state=="on"&&A[z.root._4e_name()]&&
this.removeList(b,z,c)}for(z=0;z<h.length;z++){D=h[z];var H=this;(l=function(J){var N=D[J?"_4e_previous":"_4e_next"](y.whitespaces(true));if(N&&N[0]&&N._4e_name()==H.type){N._4e_remove();N._4e_moveChildren(D,J?true:false)}})();l(true)}p.Utils.clearAllMarkers(c);g.selectBookmarks(d);b.focus()}}};var a=p.TripleButton;v.ATTRS={editor:{},type:{},contentCls:{}};s.extend(v,s.Base,{_init:function(){var b=this.get("editor");this.el.on("click",this._change,this);b.on("selectionChange",this._selectionChange,
this)},_change:function(){var b=this.get("editor"),g=this.get("type"),h=this.el,d=this;b.focus();b.fire("save");setTimeout(function(){d.listCommand.state=h.get("state");d.listCommand.exec(b);b.fire("save");b.fire(g+"Change")},10)},_selectionChange:function(b){this.get("editor");var g=this.get("type"),h=b.path,d;b=this.el;var l=h.blockLimit;if(h=h.elements)for(var c=0;c<h.length&&(d=h[c])&&d[0]!==l[0];c++){var f=s.indexOf(h[c]._4e_name(),q);if(f!==-1)if(q[f]===g){b.set("state",a.ON);return}else break}b.set("state",
a.OFF)}});p.ListUtils=o;p.List=v}();w.addPlugin(function(){new p.List({editor:w,title:"\u9879\u76ee\u5217\u8868",contentCls:"ke-toolbar-ul",type:"ul"});new p.List({editor:w,title:"\u7f16\u53f7\u5217\u8868",contentCls:"ke-toolbar-ol",type:"ol"})})});
KISSY.Editor.add("maximize",function(w){var p=KISSY.Editor,A=KISSY,q=A.UA,s=A.Node,C=A.Event,m=p.TripleButton,y=A.DOM,j;p.Maximize||function(){function e(i){this.editor=i;this._init()}e.init=function(){j=new s("<iframe style='position:absolute;top:-9999px;left:-9999px;' frameborder='0'></iframe>");document.body.appendChild(j[0]);e.init=null};A.augment(e,{_init:function(){this.el=new m({container:this.editor.toolBarDiv,cls:"ke-tool-editor-source",title:"\u5168\u5c4f",contentCls:"ke-toolbar-maximize"});
this.el.on("offClick",this.maximize,this);this.el.on("onClick",this.restore,this);p.Utils.lazyRun(this,"_prepare","_real")},restore:function(){var i=this,k=i.editor;C.remove(window,"resize",i._maximize,i);this._saveEditorStatus();k.wrap.css({height:i.iframeHeight});(new s(document.body)).css({width:"",height:"",overflow:""});document.documentElement.style.overflow="";k.editorWrap.css({position:"static",width:i.editorWrapWidth});j.css({left:"-99999px",top:"-99999px"});window.scrollTo(i.scrollLeft,
i.scrollTop);i.el.set("state",m.OFF);setTimeout(function(){i._restoreEditorStatus()},30);k.notifySelectionChange()},_saveSate:function(){var i=this.editor;this.iframeHeight=i.wrap._4e_style("height");this.editorWrapWidth=i.editorWrap._4e_style("width");this.scrollLeft=y.scrollLeft();this.scrollTop=y.scrollTop();window.scrollTo(0,0)},_saveEditorStatus:function(){var i=this.editor;if(q.gecko&&i.iframeFocus)this.savedRanges=(i=i.getSelection())&&i.getRanges()},_restoreEditorStatus:function(){var i=this.editor,
k=i.getSelection();if(q.gecko&&i.iframeFocus){this.el.el[0].focus();i.focus();this.savedRanges&&k&&k.selectRanges(this.savedRanges)}if(i.iframeFocus&&k)(i=k.getStartElement())&&i[0]&&i._4e_scrollIntoView()},_maximize:function(){var i=this.editor,k=y.viewportHeight(),r=y.viewportWidth(),v=i.statusDiv?i.statusDiv.height():0,o=i.toolBarDiv.height();if(q.ie){document.documentElement.style.overflow="hidden";document.body.style.overflow="hidden"}else(new s(document.body)).css({width:0,height:0,overflow:"hidden"});
i.editorWrap.css({position:"absolute",zIndex:990,width:r+"px"});j.css({zIndex:985,height:k+"px",width:r+"px"});i.editorWrap.offset({left:0,top:0});j.css({left:0,top:0});i.wrap.css({height:k-v-o-14+"px"});i.notifySelectionChange()},_real:function(){var i=this;this._saveEditorStatus();this._saveSate();this._maximize();this._maximize();C.on(window,"resize",i._maximize,i);this.el.set("state",m.ON);setTimeout(function(){i._restoreEditorStatus()},30)},_prepare:function(){e.init&&e.init()},maximize:function(){this._prepare()}});
p.Maximize=e}();w.addPlugin(function(){new p.Maximize(w)})});
KISSY.Editor.add("music",function(w){var p=KISSY,A=p.Node,q=p.DOM,s=p.Editor,C=p.Event;s.MusicInserter||function(){function m(a){m.superclass.constructor.call(this,a);a=this.get("editor");a._toolbars=a._toolbars||{};a._toolbars.music=this;this._init()}function y(a){return a.replace(/^.+niftyplayer\.swf\?file=/,"")}var j=s.ContextMenu,e=s.SimpleOverlay,i=s.TripleButton,k=s.Utils.getFlashUrl,r='<object  width="165" height="37" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,0,0" classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"><param value="'+(s.Config.base+
'plugins/music/niftyplayer.swf?file=#(music)"')+' name="movie"/><param value="high" name="quality"/><param value="#FFFFFF" name="bgcolor"/><embed width="165" height="37" type="application/x-shockwave-flash" swliveconnect="true" src="'+(s.Config.base+'plugins/music/niftyplayer.swf?file=#(music)"')+'quality="high" pluginspage="http://www.macromedia.com/go/getflashplayer" bgcolor="#FFFFFF" /></object>',v=/#\(music\)/g,o=["img.ke_music"];m.ATTRS={editor:{}};m.tip=function(){var a=this,b=new A('<div class="ke-bubbleview-bubble" onmousedown="return false;">\u97f3\u4e50\u7f51\u5740\uff1a  <a class="ke-bubbleview-url" target="_blank" href="#"></a> -     <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -     <span class="ke-bubbleview-link ke-bubbleview-remove">\u5220\u9664</span></div>');
b._4e_unselectable();a.tipwin=new e({el:b,focusMgr:false});document.body.appendChild(b[0]);a.tipurl=b.one(".ke-bubbleview-url");var g=b.one(".ke-bubbleview-change");b=b.one(".ke-bubbleview-remove");g.on("click",function(h){a.tipwin.music.show();h.halt()});a.tipwin.on("hide",function(){var h=a.tipwin.music;h&&(h.selectedFlash=null)});C.on(document,"click",function(){a.tipwin.hide()});b.on("click",function(h){var d=a.tipwin.music;d.selectedFlash._4e_remove();d.get("editor").notifySelectionChange();
h.halt()});a.tip=null};p.extend(m,p.Base,{_init:function(){var a=this.get("editor"),b={};this.el=new i({contentCls:"ke-toolbar-music",title:"\u5206\u4eab\u97f3\u4e50",container:a.toolBarDiv});C.on(a.document,"dblclick",this._dblclick,this);for(var g in t)(function(h){b[h]=function(){t[h](a)}})(g);j.register(a.document,{rules:o,width:"120px",funcs:b});this.el.on("offClick",this.show,this);s.Utils.lazyRun(this,"_prepare","_real");a.on("selectionChange",this._selectionChange,this)},_selectionChange:function(a){a=
a.path;var b=a.elements;if(a&&b)if(a=a.lastElement)(a=a._4e_ascendant(function(g){return g._4e_name()==="img"&&!!g.hasClass("ke_music")},true))?this._showTip(a):this._hideTip()},_showTip:function(a){this._prepareTip(a)},_hideTip:function(){m.tipwin&&m.tipwin.hide()},_prepareTip:function(){m.tip&&m.tip()},_realTip:function(a){var b=this.get("editor"),g=a._4e_getOffset(document);g.top+=a.height()+5;m.tipwin.show(g);this.selectedFlash=a;a=b.restoreRealElement(this.selectedFlash);m.tipwin.music=this;
m.tipurl.html(y(k(a)));m.tipurl.attr("href",y(k(a)))},_prepare:function(){var a=this,b=a.get("editor");a.d=new e({title:"\u7f16\u8f91\u97f3\u4e50",mask:true,width:"350px"});var g=a.d;g.body.html("<div><p><label><span style='color:#0066CC;font-weight:bold;'>\u97f3\u4e50\u7f51\u5740\uff1a </span><input class='ke-music-url' style='width:230px' value='http://'/></label></p></div>");g.foot.html("<button class='ke-music-insert'>\u786e\u5b9a</button> <button class='ke-music-cancel'>\u53d6\u6d88</button>");
a.content=g.el;var h=a.content;g.on("hide",function(){a.selectedFlash=null});g=h.one(".ke-music-cancel");var d=h.one(".ke-music-insert");a.musicUrl=h.one(".ke-music-url");g.on("click",function(l){a.d.hide();l.halt()});C.on(document,"click",a.hide,a);C.on(b.document,"click",a.hide,a);d.on("click",function(){a._insert()})},hide:function(a){var b=this;q._4e_ascendant(a.target,function(g){return g[0]===b.content[0]||g[0]===b.el.el[0]})||this.d.hide()},_real:function(){this.d.show()},_insert:function(){var a=
this.get("editor"),b=this.musicUrl.val();if(b){b=r.replace(v,b);var g=new A(b,null,a.document);b=a.createFakeElement?a.createFakeElement(g,"ke_music","music",true,b):g;a.insertElement(b);this.selectedFlash&&a.getSelection().selectElement(b);this.d.hide()}},_dblclick:function(a){var b=new A(a.target);if(b._4e_name()==="img"&&b.hasClass("ke_music")){this.selectedFlash=b;this.show();a.halt()}},show:function(){this._prepare();if(this.selectedFlash){var a=this.get("editor").restoreRealElement(this.selectedFlash);
this.musicUrl.val(y(k(a)))}else this.musicUrl.val("")}});s.Utils.lazyRun(m.prototype,"_prepareTip","_realTip");s.MusicInserter=m;var t={"\u7f16\u8f91\u97f3\u4e50":function(a){var b=a.getSelection();if(b=(b=b&&b.getStartElement())&&b._4e_ascendant("img",true))if(b.hasClass("ke_music")){a=a._toolbars.music;a.selectedFlash=b;a.show()}}}}();w.addPlugin(function(){new s.MusicInserter({editor:w});var m=q._4e_getWin(w.document);C.on(m,"scroll",function(){s.MusicInserter.tipwin&&s.MusicInserter.tipwin.hide()})})});
KISSY.Editor.add("preview",function(w){var p=KISSY.Editor,A=KISSY,q=p.TripleButton;p.Preview||function(){function s(C){this.editor=C;this._init()}A.augment(s,{_init:function(){this.el=new q({container:this.editor.toolBarDiv,cls:"ke-tool-editor-source",title:"\u9884\u89c8",contentCls:"ke-toolbar-preview"});this.el.on("offClick",this._show,this)},_show:function(){var C=this.editor,m=640,y=420,j=80;try{var e=window.screen;m=Math.round(e.width*0.8);y=Math.round(e.height*0.7);j=Math.round(e.width*0.1)}catch(i){}C=
C._prepareIFrameHtml().replace(/<body[^>]+>.+<\/body>/,"<body>\n"+C.getData()+"\n</body>");m=window.open("",null,"toolbar=yes,location=no,status=yes,menubar=yes,scrollbars=yes,resizable=yes,width="+m+",height="+y+",left="+j);m.document.open();m.document.write(C);m.document.close()}});p.Preview=s}();w.addPlugin(function(){new p.Preview(w)})});
KISSY.Editor.add("removeformat",function(w){function p(k){this.editor=k;this._init()}function A(k,r){for(var v=0;v<r.length;v++)k.removeAttr(r[v])}var q=KISSY.Editor,s=KISSY,C=q.RANGE,m=q.ElementPath,y=q.NODE,j=q.TripleButton,e="b,big,code,del,dfn,em,font,i,ins,kbd,q,samp,small,span,strike,strong,sub,sup,tt,u,var,s",i="class,style,lang,width,height,align,hspace,valign".split(",");e=new RegExp("^(?:"+e.replace(/,/g,"|")+")$","i");s.augment(p,{_init:function(){this.el=new j({title:"\u6e05\u9664\u683c\u5f0f",
contentCls:"ke-toolbar-removeformat",container:this.editor.toolBarDiv});this.el.on("offClick",this._remove,this)},_remove:function(){var k=this.editor,r=e;r.lastIndex=0;k.focus();var v=k.getSelection().getRanges();k.fire("save");for(var o=0,t;t=v[o];o++)if(!t.collapsed){t.enlarge(C.ENLARGE_ELEMENT);var a=t.createBookmark(),b=a.startNode,g=a.endNode,h=function(d){for(var l=new m(d),c=l.elements,f=1,n;n=c[f];f++){if(n._4e_equals(l.block)||n._4e_equals(l.blockLimit))break;r.test(n.getName())&&d.breakParent(n)}};
h(b);h(g);for(b=b._4e_nextSourceNode(true,y.NODE_ELEMENT);b;){if(b._4e_equals(g))break;h=b._4e_nextSourceNode(false,y.NODE_ELEMENT);b._4e_name()=="img"&&b.attr("_cke_realelement")||(r.test(b._4e_name())?b._4e_remove(true):A(b,i));b=h}t.moveToBookmark(a)}k.getSelection().selectRanges(v);k.fire("save")}});w.addPlugin(function(){new p(w)})});
KISSY.Editor.add("smiley",function(w){var p=KISSY.Editor,A=KISSY,q=A.DOM,s=A.Event,C=A.Node,m=p.SimpleOverlay,y=p.TripleButton;p.Smiley||function(){function j(k){this.editor=k;this._init()}for(var e="<div class='ke-popup-wrap'><div class='ke-smiley-sprite'>",i=0;i<=98;i++)e+="<a href='#' data-icon='http://a.tbcdn.cn/sys/wangwang/smiley/48x48/"+i+".gif'></a>";e+="</div></div>";A.augment(j,{_init:function(){this.el=new y({contentCls:"ke-toolbar-smiley",title:"\u63d2\u5165\u8868\u60c5",container:this.editor.toolBarDiv});
this.el.on("offClick",this._show,this);p.Utils.lazyRun(this,"_prepare","_real")},_hidePanel:function(k){var r=this;q._4e_ascendant(k.target,function(v){return v[0]===r.el.el[0]})||this.smileyWin.hide()},_selectSmiley:function(k){k.halt();var r=this.editor;k=k.target;var v;if(q._4e_name(k)=="a"&&(v=q.attr(k,"data-icon"))){v=new C("<img src='"+v+"'/>",null,r.document);r.insertElement(v);r.focus();this.smileyWin.hide()}},_prepare:function(){var k=this.editor;this.smileyPanel=new C(e);this.smileyWin=
new m({el:this.smileyPanel,mask:false});document.body.appendChild(this.smileyPanel[0]);this.smileyPanel.on("click",this._selectSmiley,this);s.on(document,"click",this._hidePanel,this);s.on(k.document,"click",this._hidePanel,this)},_real:function(){var k=this.el.el.offset();k.top+=this.el.el.height()+5;if(k.left+this.smileyPanel.width()>q.viewportWidth()-60)k.left=q.viewportWidth()-this.smileyPanel.width()-60;this.smileyWin.show(k)},_show:function(k){this._prepare(k)}});p.Smiley=j}();w.addPlugin(function(){new p.Smiley(w)})});
KISSY.Editor.add("sourcearea",function(w){var p=KISSY.Editor,A=KISSY,q=A.UA,s=p.TripleButton;p.SourceArea||function(){function C(m){this.editor=m;this._init()}A.augment(C,{_init:function(){var m=this.editor;this.el=new s({container:m.toolBarDiv,cls:"ke-tool-editor-source",title:"\u6e90\u7801",contentCls:"ke-toolbar-source"});this.el.on("offClick",this._show,this);this.el.on("onClick",this._hide,this);m.textarea.on("mousedown",function(y){y.stopPropagation()})},_show:function(){var m=this.editor,y=
this.el;m.textarea.val(m.getData());m._showSource();y.set("state",s.ON)},_hide:function(){var m=this.editor,y=m.textarea,j=this.el;m._hideSource();m.setData(y.val());if(q.gecko&&m.iframeFocus){j.el[0].focus();m.focus()}j.set("state",s.OFF)}});p.SourceArea=C}();w.addPlugin(function(){new p.SourceArea(w)})});
KISSY.Editor.add("table",function(w,p){var A=KISSY.Editor,q=KISSY,s=q.Node,C=q.DOM,m=A.Walker,y=q.UA,j=A.NODE,e=A.TripleButton,i=A.SimpleOverlay,k=A.ContextMenu,r=["tr","th","td","tbody","table"],v=q.trim,o;o=(y.ie===6?["table.%2,","table.%2 td, table.%2 th,","{","border : #d3d3d3 1px dotted","}"]:[" table.%2,"," table.%2 > tr > td,  table.%2 > tr > th,"," table.%2 > tbody > tr > td,  table.%2 > tbody > tr > th,"," table.%2 > thead > tr > td,  table.%2 > thead > tr > th,"," table.%2 > tfoot > tr > td,  table.%2 > tfoot > tr > th",
"{","border : #d3d3d3 1px dotted","}"]).join("").replace(/%2/g,"ke_show_border");A.TableUI||function(){function t(x){this.editor=x;this.selectedTable=null;x._toolbars=x._toolbars||{};x._toolbars.table=this;this._init()}function a(x){return v(x).length!=0}function b(x){function B($){if(!(N.length>0))if($[0].nodeType==j.NODE_ELEMENT&&D.test($._4e_name())&&!$._4e_getData("selected_cell")){$._4e_setMarker(M,"selected_cell",true);N.push($)}}for(var H=x.createBookmarks(),J=x.getRanges(),N=[],M={},Q=0;Q<
J.length;Q++){var R=J[Q];if(R.collapsed){R=R.getCommonAncestor();(R=R._4e_ascendant("td",true)||R._4e_ascendant("th",true))&&N.push(R)}else{R=new m(R);var W;for(R.guard=B;W=R.next();)if((W=W.parent())&&D.test(W._4e_name())&&!W._4e_getData("selected_cell")){W._4e_setMarker(M,"selected_cell",true);N.push(W)}}}A.Utils.clearAllMarkers(M);x.selectBookmarks(H);return N}function g(x){x=x.cells;for(var B=0;B<x.length;B++){x[B].innerHTML="";y.ie||(new s(x[B]))._4e_appendBogus()}}function h(x,B){if(x=x.getStartElement()._4e_ascendant("tr")){var H=
x._4e_clone(true);H.insertBefore(x);g(B?H[0]:x[0])}}function d(x){if(x instanceof A.Selection){var B=b(x),H=B.length;x=[];for(var J,N,M=0;M<H;M++){var Q=B[M].parent(),R=Q[0].rowIndex;!M&&(J=R-1);x[R]=Q;M==H-1&&(N=R+1)}M=Q._4e_ascendant("table");J=new s(N<M[0].rows.length&&M[0].rows[N]||J>0&&M[0].rows[J]||M[0].parentNode);for(M=x.length;M>=0;M--)x[M]&&d(x[M]);return J}else if(x instanceof s){M=x._4e_ascendant("table");M[0].rows.length==1?M._4e_remove():x._4e_remove()}return 0}function l(x,B){x=x.getStartElement();
if(x=x._4e_ascendant("td",true)||x._4e_ascendant("th",true))for(var H=x._4e_ascendant("table"),J=x[0].cellIndex,N=0;N<H[0].rows.length;N++){var M=H[0].rows[N];if(!(M.cells.length<J+1)){x=new s(M.cells[J].cloneNode(false));y.ie||x._4e_appendBogus();M=new s(M.cells[J]);B?x.insertBefore(M):x.insertAfter(M)}}}function c(x){var B=[],H=x[0]&&x[0]._4e_ascendant("table"),J,N,M,Q;J=0;for(N=x.length;J<N;J++)B.push(x[J][0].cellIndex);B.sort();J=1;for(N=B.length;J<N;J++)if(B[J]-B[J-1]>1){M=B[J-1]+1;break}M||
(M=B[0]>0?B[0]-1:B[B.length-1]+1);x=H[0].rows;J=0;for(N=x.length;J<N;J++)if(Q=x[J].cells[M])break;return Q?new s(Q):H._4e_previous()}function f(x){if(x instanceof A.Selection){var B=b(x),H=c(B);for(x=B.length-1;x>=0;x--)B[x]&&f(B[x]);return H}else if(x instanceof s){B=x._4e_ascendant("table");if(!B)return null;H=x[0].cellIndex;for(x=B[0].rows.length-1;x>=0;x--){var J=new s(B[0].rows[x]);if(!H&&J[0].cells.length==1)d(J);else J[0].cells[H]&&J[0].removeChild(J[0].cells[H])}}return null}function n(x,
B){var H=new A.Range(x[0].ownerDocument);if(!H.moveToElementEditablePosition(x,B?true:p)){H.selectNodeContents(x);H.collapse(B?false:true)}H.select(true)}var z=A.HtmlDataProcessor,u=z&&z.dataFilter;z=z&&z.htmlFilter;u&&u.addRules({elements:{table:function(x){x=x.attributes;var B=x["class"],H=parseInt(x.border,10);if(!H||H<=0)x["class"]=(B||"")+" ke_show_border"}}});z&&z.addRules({elements:{table:function(x){x=x.attributes;var B=x["class"];if(B)x["class"]=q.trim(B.replace("ke_show_border","").replace(/\s{2}/,
" "))}}});q.augment(t,{_init:function(){var x=this.editor,B={};this.el=new e({contentCls:"ke-toolbar-table",title:"\u8868\u683c",container:x.toolBarDiv});this.el.on("offClick",this._tableShow,this);for(var H in I)(function(J){B[J]=function(){x.fire("save");x.focus();I[J](x);x.fire("save")}})(H);k.register(x.document,{rules:r,width:"120px",funcs:B});A.Utils.lazyRun(this,"_prepareTableShow","_realTableShow")},_tableInit:function(){var x=this,B=new i({width:"350px",mask:true,title:"\u7f16\u8f91\u8868\u683c"});
B.body.html("<table class='ke-table-config'><tr><td><label>\u884c\u6570\uff1a <input value='2' class='ke-table-rows ke-table-create-only' size='8'/></label></td><td><label>\u5bbd\u5ea6\uff1a <input value='200' class='ke-table-width' size='8'/></label> <select class='ke-table-width-unit'><option value='px'>\u50cf\u7d20</option><option value='%'>\u767e\u5206\u6bd4</option></select></td></tr><tr><td><label>\u5217\u6570\uff1a <input class='ke-table-cols ke-table-create-only' value='3' size='8'/></label></td><td><label>\u9ad8\u5ea6\uff1a <input value='' class='ke-table-height' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td><label>\u5bf9\u9f50\uff1a <select class='ke-table-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option><option value='center'>\u4e2d\u95f4\u5bf9\u9f50</option></select></label></td><td><label>\u95f4\u8ddd\uff1a <input value='1' class='ke-table-cellspacing' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td><label>\u6807\u9898\u683c\uff1a <select class='ke-table-head ke-table-create-only'><option value=''>\u65e0</option><option value='1'>\u6709</option></select></td><td><label>\u8fb9\u8ddd\uff1a <input value='1' class='ke-table-cellpadding' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td></td><td><label>\u8fb9\u6846\uff1a <input value='1' class='ke-table-border' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td colspan='2'><label>\u6807\u9898\uff1a<input class='ke-table-caption' style='width:270px'></label></td></tr></table>");
B.foot.html("<button class='ke-table-ok'>\u786e\u5b9a</button> <button class='ke-table-cancel'>\u53d6\u6d88</button>");B.twidth=B.body.one(".ke-table-width");B.theight=B.body.one(".ke-table-height");B.tcellspacing=B.body.one(".ke-table-cellspacing");B.tcellpadding=B.body.one(".ke-table-cellpadding");B.tborder=B.body.one(".ke-table-border");B.tcaption=B.body.one(".ke-table-caption");B.talign=B.body.one(".ke-table-align");B.trows=B.body.one(".ke-table-rows");B.tcols=B.body.one(".ke-table-cols");B.thead=
B.body.one(".ke-table-head");var H=B.foot.one(".ke-table-ok"),J=B.foot.one(".ke-table-cancel");B.twidthunit=B.body.one(".ke-table-width-unit");x.tableDialog=B;H.on("click",x._tableOk,x);B.on("hide",function(){x.selectedTable=null});J.on("click",function(){B.hide()})},_tableOk:function(){this.selectedTable?this._modifyTable():this._genTable()},_modifyTable:function(){var x=this.tableDialog,B=this.selectedTable,H=B.one("caption");a(x.talign.val())&&B.attr("align",v(x.talign.val()));a(x.tcellspacing.val())&&
B.attr("cellspacing",v(x.tcellspacing.val()));a(x.tcellpadding.val())&&B.attr("cellpadding",v(x.tcellpadding.val()));a(x.tborder.val())&&B.attr("border",v(x.tborder.val()));!a(x.tborder.val())||x.tborder.val()=="0"?B.addClass("ke_show_border"):B.removeClass("ke_show_border");a(x.twidth.val())&&B.css("width",v(x.twidth.val())+x.twidthunit.val());a(x.theight.val())&&B.css("height",v(x.theight.val()));if(a(x.tcaption.val()))H&&H[0]?H.html(v(x.tcaption.val())):(new s("<caption><span>"+v(x.tcaption.val())+
"</span></caption>")).insertBefore(B[0].firstChild);else H&&H._4e_remove();x.hide()},_genTable:function(){var x=this.tableDialog,B="<table ",H,J=parseInt(x.tcols.val()),N=parseInt(x.trows.val()),M=y.ie?"":"<br/>",Q=this.editor;if(q.trim(x.talign.val()).length!=0)B+="align='"+q.trim(x.talign.val())+"' ";if(q.trim(x.tcellspacing.val()).length!=0)B+="cellspacing='"+q.trim(x.tcellspacing.val())+"' ";if(q.trim(x.tcellpadding.val()).length!=0)B+="cellpadding='"+q.trim(x.tcellpadding.val())+"' ";if(q.trim(x.tborder.val()).length!=
0)B+="border='"+q.trim(x.tborder.val())+"' ";if(q.trim(x.twidth.val()).length!=0||q.trim(x.theight.val()).length!=0){B+="style='";if(q.trim(x.twidth.val()).length!=0)B+="width:"+q.trim(x.twidth.val())+x.twidthunit.val()+";";if(q.trim(x.theight.val()).length!=0)B+="height:"+q.trim(x.theight.val())+"px;";B+="' "}if(q.trim(x.tborder.val()).length==0||q.trim(x.tborder.val())=="0")B+="class='ke_show_border' ";B+=">";if(q.trim(x.tcaption.val()))B+="<caption><span>"+q.trim(x.tcaption.val())+"</span></caption>";
if(x.thead.val()){B+="<thead>";B+="<tr>";for(H=0;H<J;H++)B+="<th>"+M+"</th>";B+="</tr>";B+="</thead>"}B+="<tbody>";for(var R=0;R<N;R++){B+="<tr>";for(H=0;H<J;H++)B+="<td>"+M+"</td>";B+="</tr>"}B+="</tbody>";B+="</table>";B=new s(B,null,Q.document);Q.insertElement(B);x.hide()},_fillTableDialog:function(){var x=this.tableDialog,B=this.selectedTable,H=B.one("caption");x.talign.val(B.attr("align")||"");x.tcellspacing.val(B.attr("cellspacing")||"");x.tcellpadding.val(B.attr("cellpadding")||"");x.tborder.val(B.attr("border")|
"");var J=B._4e_style("width")||"";x.twidth.val(J.replace(/px|%/i,""));J.indexOf("%")!=-1?x.twidthunit.val("%"):x.twidthunit.val("px");x.theight.val((B._4e_style("height")||"").replace(/px|%/i,""));J="";if(H)J=H.text();x.tcaption.val(J);x.trows.val(B.one("tbody").children().length);x.tcols.val(B.one("tr").children().length);x.thead.val(B._4e_first(function(N){return N._4e_name()=="thead"})?"1":"")},_realTableShow:function(){if(this.selectedTable){this._fillTableDialog();this.tableDialog.body.all(".ke-table-create-only").attr("disabled",
"disabled")}else this.tableDialog.body.all(".ke-table-create-only").removeAttr("disabled");this.tableDialog.show()},_prepareTableShow:function(){this._tableInit()},_tableShow:function(){this._prepareTableShow()}});var D=/^(?:td|th)$/,I={"\u8868\u683c\u5c5e\u6027":function(x){var B=x.getSelection();if(B=(B=B&&B.getStartElement())&&B._4e_ascendant("table",true)){x=x._toolbars.table;x.selectedTable=B;x._tableShow()}},"\u5220\u9664\u8868\u683c":function(x){var B=(x=x.getSelection())&&x.getStartElement();
if(B=B&&B._4e_ascendant("table",true)){x.selectElement(B);var H=x.getRanges()[0];H.collapse();x.selectRanges([H]);x=B.parent();x[0].childNodes.length==1&&x._4e_name()!="body"?x._4e_remove():B._4e_remove()}},"\u5220\u9664\u884c ":function(x){x=x.getSelection();n(d(x),p)},"\u5220\u9664\u5217 ":function(x){x=x.getSelection();(x=f(x))&&n(x,true)},"\u5728\u4e0a\u65b9\u63d2\u5165\u884c":function(x){x=x.getSelection();h(x,true)},"\u5728\u4e0b\u65b9\u63d2\u5165\u884c":function(x){x=x.getSelection();h(x,p)},
"\u5728\u5de6\u4fa7\u63d2\u5165\u5217":function(x){x=x.getSelection();l(x,true)},"\u5728\u53f3\u4fa7\u63d2\u5165\u5217":function(x){x=x.getSelection();l(x,p)}};A.TableUI=t}();w.addPlugin(function(){var t=w.document;new A.TableUI(w);var a=C.create("<style>",null,t);t.getElementsByTagName("head")[0].appendChild(a);if(a.styleSheet)a.styleSheet.cssText=o;else a.appendChild(t.createTextNode(o))})});
KISSY.Editor.add("templates",function(w){var p=KISSY.Editor,A=KISSY,q=A.Node,s=p.TripleButton,C=p.SimpleOverlay;p.TplUI||function(){function m(y){this.editor=y;this._init()}A.augment(m,{_init:function(){(new s({container:this.editor.toolBarDiv,contentCls:"ke-toolbar-template",title:"\u6a21\u677f"})).on("click",this._show,this);p.Utils.lazyRun(this,"_prepare","_real")},_prepare:function(){for(var y=this.editor,j=y.cfg.pluginConfig.templates,e="<div class='ke-tpl'>",i=0;i<j.length;i++)e+="<a href='javascript:void(0)' class='ke-tpl-list' tabIndex='-1'>"+
j[i].demo+"</a>";e+="</div>";this._initDialogOk=true;var k=new C({mask:true,title:"\u5185\u5bb9\u6a21\u677f"});k.body.html(e);k.body.all(".ke-tpl-list").on("click",function(r){r.halt();r=(new q(r.target))._4e_index();r!=-1&&y.insertHtml(j[r].html);k.hide()});this.ui=k},_real:function(){this.ui.show()},_show:function(){this._prepare()}});p.TplUI=m}();w.addPlugin(function(){new p.TplUI(w)})});
KISSY.Editor.add("undo",function(w){var p=KISSY.Editor,A=KISSY,q=p.Utils.arrayCompare,s=A.UA,C=A.Event;p.UndoManager||function(){function m(o){var t=o._getRawData();o=t&&o.getSelection();this.contents=t;this.bookmarks=o&&o.createBookmarks2(true)}function y(o,t,a){this.s=o;this.fn=t;this.scope=a||window;this.bufferTimer=null}function j(o){this.history=[];this.index=0;this.editor=o;this.bufferTimer=new y(500,this.save,this);this._init()}function e(o,t,a,b){this.editor=o;this.title=a;this.text=t;this.contentCls=
b;this._init()}A.augment(m,{equals:function(o){if(this.contents!=o.contents)return false;var t=this.bookmarks;o=o.bookmarks;if(t||o){if(!t||!o||t.length!=o.length)return false;for(var a=0;a<t.length;a++){var b=t[a],g=o[a];if(b.startOffset!=g.startOffset||b.endOffset!=g.endOffset||!q(b.start,g.start)||!q(b.end,g.end))return false}}return true}});A.augment(y,{run:function(){if(this.bufferTimer){clearTimeout(this.bufferTimer);this.bufferTimer=null}var o=this;this.bufferTimer=setTimeout(function(){o.fn.call(o.scope)},
this.s)}});var i={16:1,17:1,18:1},k={37:1,38:1,39:1,40:1};A.augment(j,{_keyMonitor:function(){var o=this.editor;C.on(o.document,"keydown",function(t){var a=t.keyCode;if(!(a in k||a in i))if(a===90&&(t.ctrlKey||t.metaKey)){o.fire("restore",{d:-1});t.halt()}else if(a===89&&(t.ctrlKey||t.metaKey)){o.fire("restore",{d:1});t.halt()}else o.fire("save",{buffer:1})})},_init:function(){var o=this,t=o.editor;t.on("save",function(a){a.buffer?o.bufferTimer.run():o.save()});t.on("restore",this.restore,this);o._keyMonitor()},
save:function(){this.history.length>this.index+1&&this.history.splice(this.index+1,this.history.length-this.index-1);var o=this.editor,t=this.history.length>0?this.history[this.history.length-1]:null,a=new m(this.editor);if(!t||!t.equals(a)){this.history.length===30&&this.history.shift();this.history.push(a);this.index=this.history.length-1;o.fire("afterSave",{history:this.history,index:this.index})}},restore:function(o){o=o.d;var t=this.editor,a=this.history.length>0?this.history[this.index+o]:null;
if(a){t._setRawData(a.contents);if(a.bookmarks)this.editor.getSelection().selectBookmarks(a.bookmarks);else if(s.ie){a=this.editor.document.body.createTextRange();a.collapse(true);a.select()}this.index+=o;t.fire("afterRestore",{history:this.history,index:this.index});t.notifySelectionChange()}}});var r=p.TripleButton,v={redo:1,undo:-1};A.augment(e,{_init:function(){var o=this,t=o.editor;o.el=new r({contentCls:o.contentCls,title:o.title,container:t.toolBarDiv});this.el.set("state",r.DISABLED);t.on("afterSave",
this._respond,this);t.on("afterRestore",this._respond,this);o.el.on("offClick",function(){t.fire("restore",{d:v[o.text]})})},_respond:function(o){this.updateUI(o.history,o.index)},updateUI:function(o,t){if(this.text=="undo")t>0&&o.length>0?this.el.set("state",r.OFF):this.el.set("state",r.DISABLED);else if(this.text=="redo")t<o.length-1?this.el.set("state",r.OFF):this.el.set("state",r.DISABLED)}});p.UndoManager=j;p.RestoreUI=e}();w.addPlugin(function(){new p.UndoManager(w);new p.RestoreUI(w,"undo",
"\u64a4\u9500","ke-toolbar-undo");new p.RestoreUI(w,"redo","\u91cd\u505a","ke-toolbar-redo")})});
