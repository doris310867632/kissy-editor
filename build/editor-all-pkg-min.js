KISSY.add("editor",function(x,q){function A(s,a){var c=this;if(!(c instanceof A))return new A(s,a);if(x.isString(s))s=x.one(s);s[0]||(s=new Node(s));c.cfg=a;x.app(c,x.EventTarget);c.use=function(h){x.use.call(c,h,function(){c.on("dataReady",function(){c.setData(s.val())})},{order:true,global:A})};c.init(s);return q}function r(s){if(!v)return"build/"+s.replace(/\.(js|css)/i,"-min.$1");if(v==="dev")return s;return"build/"+s}x.app(A,x.EventTarget);A.Config.base=x.Config.base+"editor/";var v=x.Config.debug,
B={htmlparser:{attach:false,path:r("plugins/htmldataprocessor/htmlparser/htmlparser.js")}},n=["utils","focusmanager","definition","dtd","dom","elementpath","walker","range","domiterator","selection","styles"],t=["clipboard",{name:"color",useCss:true},{name:"elementpaths",useCss:true},"enterkey","fakeobjects",{name:"flash",requires:["contextmenu","fakeobjects","overlay"]},"font","format",{name:"htmldataprocessor",requires:["htmlparser-text"]},{name:"image",requires:["overlay"]},"indent","justify",
"link","list","maximize","music","preview","removeformat",{name:"smiley",useCss:true},"sourcearea",{name:"table",useCss:true,requires:["overlay","contextmenu"]},{name:"templates",requires:["overlay"],useCss:true},"undo"],i=[{name:"htmlparser-basicwriter",requires:["htmlparser"]},{name:"htmlparser-element",requires:["htmlparser-fragment"]},{name:"htmlparser-filter",requires:["htmlparser-element"]},{name:"htmlparser-fragment",requires:["htmlparser-htmlwriter"]},{name:"htmlparser-htmlwriter",requires:["htmlparser-basicwriter"]},
{name:"htmlparser-text",requires:["htmlparser-filter"]}],e=[{name:"button"},{name:"overlay",useCss:true},{name:"contextmenu",requires:["overlay"],useCss:true}],j,l,w,m,k;j=0;for(l=e.length;j<l;j++){m=w=e[j];k=q;if(!x.isString(w)){k=w.requires;m=w.name}B[m]={attach:false,requires:k,path:r("ui/"+m+".js"),csspath:w.useCss?r("ui/"+m+".css"):""}}j=0;for(l=t.length;j<l;j++){m=w=t[j];k=["button"];if(!x.isString(w)){w.requires&&(k=k.concat(w.requires));m=w.name}B[m]={attach:false,requires:k,csspath:w.useCss?
r("plugins/"+m+"/plugin.css"):q,path:r("plugins/"+m+"/plugin.js")}}j=0;for(l=i.length;j<l;j++){w=i[j];k=q;if(!x.isString(w)){k=w.requires;w=w.name}B[w]={attach:false,requires:k,path:r("plugins/htmldataprocessor/htmlparser/"+w.substring(11)+".js")}}A.add(B);B={};j=0;for(l=n.length;j<l;j++){w=n[j];B[w]={host:"editor",requires:j>0?n[j-1]:[]}}A.add(B);x.Editor=A});
KISSY.Editor.add("utils",function(x){var q=KISSY,A=q.Node,r=q.DOM,v=q.Config.debug,B=q.UA;x.Utils={debugUrl:function(n){if(!v)return"build/"+n.replace(/\.(js|css)/i,"-min.$1");if(v==="dev")return n;return"build/"+n},lazyRun:function(n,t,i){var e=n[t],j=n[i];n[t]=function(){e.apply(this,arguments);n[t]=n[i];return j.apply(this,arguments)}},getXY:function(n,t,i,e){i=i.defaultView||i.parentWindow;n-=r.scrollLeft(i);t-=r.scrollTop(i);if(e)if(i!=(e.defaultView||e.parentWindow)&&i.frameElement){e=r._4e_getOffset(i.frameElement,
e);n+=e.left;t+=e.top}return{left:n,top:t}},tryThese:function(){for(var n,t=0,i=arguments.length;t<i;t++){var e=arguments[t];try{n=e();break}catch(j){}}return n},arrayCompare:function(n,t){if(!n&&!t)return true;if(!n||!t||n.length!=t.length)return false;for(var i=0;i<n.length;i++)if(n[i]!==t[i])return false;return true},getByAddress:function(n,t,i){n=n.documentElement;for(var e=0;n&&e<t.length;e++){var j=t[e];if(i)for(var l=-1,w=0;w<n.childNodes.length;w++){var m=n.childNodes[w];if(!(i===true&&m.nodeType==
3&&m.previousSibling&&m.previousSibling.nodeType==3)){l++;if(l==j){n=m;break}}}else n=n.childNodes[j]}return n?new A(n):null},clearAllMarkers:function(n){for(var t in n)n[t]._4e_clearMarkers(n,true)},htmlEncodeAttr:function(n){return n.replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/,"&gt;")},ltrim:function(n){return n.replace(/^\s+/,"")},rtrim:function(n){return n.replace(/\s+$/,"")},trim:function(n){return this.ltrim(this.rtrim(n))},mix:function(){for(var n={},t=0;t<arguments.length;t++)n=
q.mix(n,arguments[t]);return n},isCustomDomain:function(){if(!B.ie)return false;var n=document.domain,t=window.location.hostname;return n!=t&&n!="["+t+"]"}}});
KISSY.Editor.add("focusmanager",function(x){function q(){this.iframeFocus=true;t=this}function A(){this.iframeFocus=false;t=null}var r=KISSY,v=r.DOM,B=r.Event;r={};var n={},t;r={refreshAll:function(){for(var i in n){var e=n[i];e.document.designMode="off";e.document.designMode="on"}},currentInstance:function(){return t},getInstance:function(i){return n[i]},add:function(i){var e=v._4e_getWin(i.document);B.on(e,"focus",q,i);B.on(e,"blur",A,i)},register:function(i){n[i._UUID]=i},remove:function(i){delete n[i._UUID];
var e=v._4e_getWin(i.document);B.remove(e,"focus",q,i);B.remove(e,"blur",A,i)}};x.focusManager=r});
KISSY.Editor.add("definition",function(x){function q(k){return e+"<html><head><title>kissy-editor</title><link href='"+x.Config.base+j+"' rel='stylesheet'/></head><body class='ke-editor'>&nbsp;</body><html>"+(k?'<script id="ke_actscrpt" type="text/javascript">'+(x.Utils.isCustomDomain()?'document.domain="'+document.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+k+'");<\/script>':"")}var A=KISSY,r=A.UA,v=A.DOM,B=A.Node,n=A.Event,t=x.focusManager,i=x.Utils.tryThese,e="<!doctype html>",j=
x.Utils.debugUrl("assets/editor-iframe.css"),l=1,w="document.open();"+(x.Utils.isCustomDomain()?'document.domain="'+document.domain+'";':"")+"document.close();",m="<div  class='ke-editor-wrap'  > <div class='"+".ke-editor-tools".substring(1)+"'></div><div class='"+".ke-textarea-wrap".substring(1)+'\'><iframe  style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor"  src="'+(r.ie?"javascript:void(function(){"+encodeURIComponent(w)+"}())":"")+'"  tabIndex="'+
(r.webkit?-1:"$(tabIndex)")+'"  allowTransparency="true" ></iframe></div><div class=\''+".ke-editor-status".substring(1)+"'></div></div>";A.augment(x,{init:function(k){var s=this,a=new B(m.replace(/\$\(tabIndex\)/,k.attr("tabIndex")));a.on("mousedown",function(d){if(r.webkit){var g=v._4e_name(d.target);if(g=="select"||g=="option")return true}d.halt()});s.editorWrap=a;s._UUID=l++;t.register(s);s.wrap=a.one(".ke-textarea-wrap");s.iframe=s.wrap.one("iframe");s.toolBarDiv=a.one(".ke-editor-tools");s.textarea=
k;s.statusDiv=a.one(".ke-editor-status");s.toolBarDiv._4e_unselectable();s._commands={};s._plugins={};var c=k._4e_style("width"),h=k._4e_style("height");if(c){a.css("width",c);k.css("width","100%")}s.textarea.css("display","none");a.insertAfter(k);s.wrap[0].appendChild(k[0]);if(h){s.wrap.css("height",h);k.css("height","100%")}k=s.iframe;s.on("dataReady",function(){s.ready=true;x.fire("instanceCreated",{editor:s})});r.gecko?k.on("load",s._setUpIFrame,s):s._setUpIFrame()},addCommand:function(k,s){this._commands[k]=
s},execCommand:function(k){this.fire("save");this._commands[k].exec(this);this.fire("save")},getData:function(){if(x.HtmlDataProcessor)return x.HtmlDataProcessor.toHtml(this.document.body.innerHTML,"p");return this.document.body.innerHTML},setData:function(k){if(x.HtmlDataProcessor)k=x.HtmlDataProcessor.toDataFormat(k,"p");this.document.body.innerHTML=k},sync:function(){this.textarea.val(this.getData())},_getRawData:function(){return this.document.body.innerHTML},_setRawData:function(k){this.document.body.innerHTML=
k},_hideSource:function(){this.iframe.css("display","");this.textarea.css("display","none");this.toolBarDiv.children().css("visibility","");this.statusDiv.children().css("visibility","")},_showSource:function(){this.textarea.css("display","");this.iframe.css("display","none");this.toolBarDiv.children().css("visibility","hidden");this.toolBarDiv.all(".ke-tool-editor-source").css("visibility","");this.statusDiv.children().css("visibility","hidden");r.ie<8&&this.textarea.css("height",this.wrap.css("height"))},
_prepareIFrameHtml:q,getSelection:function(){var k=new x.Selection(this.document);return!k||k.isInvalid?null:k},focus:function(){var k=v._4e_getWin(this.document);r.webkit&&k&&k.parent&&k.parent.focus();k&&k.focus();this.document&&this.document.body.focus();this.notifySelectionChange()},blur:function(){v._4e_getWin(this.document).blur();this.document&&this.document.body.blur()},_setUpIFrame:function(){function k(){d=h.document;s.document=d;a.detach();d.open("text/html","replace");d.write(c);d.close()}
var s=this,a=s.iframe,c=q(s._UUID),h=a[0].contentWindow,d;try{d=h.document}catch(g){a[0].src=a[0].src;if(r.ie&&r.ie<7){setTimeout(k,10);return}}k()},addPlugin:function(k){this.ready?k():this.on("dataReady",k)},_monitor:function(){var k=this;k._monitorId&&clearTimeout(k._monitorId);k._monitorId=setTimeout(function(){var s=k.getSelection();if(s&&!s.isInvalid){s=s.getStartElement();var a=new x.ElementPath(s);if(!k.previousPath||!k.previousPath.compare(a)){k.previousPath=a;k.fire("selectionChange",{selection:k,
path:a,element:s})}}},200)},notifySelectionChange:function(){this.previousPath=null;this._monitor()},insertElement:function(k){var s=this;s.focus();var a=k._4e_name(),c=x.XHTML_DTD,h=x.RANGE,d=x.NODE,g=c.$block[a],p=s.getSelection(),b=p.getRanges(),f,o,z,u,C;s.fire("save");for(var I=b.length-1;I>=0;I--){f=b[I];f.deleteContents();o=!I&&k||k._4e_clone(true);if(g)for(;(u=f.getCommonAncestor(false,true))&&(C=c[u._4e_name()])&&!(C&&C[a]);)if(u._4e_name()in c.span)f.splitElement(u);else if(f.checkStartOfBlock()&&
f.checkEndOfBlock()){f.setStartBefore(u);f.collapse(true);u._4e_remove()}else f.splitBlock();f.insertNode(o);z||(z=o)}f.moveToPosition(z,h.POSITION_AFTER_END);(k=z._4e_nextSourceNode(true))&&k.type==d.NODE_ELEMENT&&f.moveToElementEditablePosition(k);p.selectRanges([f]);s.focus();o&&o._4e_scrollIntoView();setTimeout(function(){s.fire("save")},10)},insertHtml:function(k){if(x.HtmlDataProcessor)k=x.HtmlDataProcessor.toDataFormat(k);if(r.webkit){k=v.create(k,null,this.document);k=k.nodeType==11?A.makeArray(k.childNodes):
[k];for(var s=0;s<k.length;s++)this.insertElement(new B(k[s]))}else{var a=this;a.focus();a.fire("save");s=a.getSelection();if(r.ie){s=s.getNative();s.type=="Control"&&s.clear();s.createRange().pasteHTML(k)}else a.document.execCommand("inserthtml",false,k);a.focus();setTimeout(function(){a.fire("save")},10)}}});x._initIFrame=function(k){function s(u){i(function(){h.designMode="on";setTimeout(function(){h.designMode="off";g.focus();if(!arguments.callee.retry)arguments.callee.retry=true},50)},function(){h.designMode=
"off";v.attr(g,"contentEditable",false);v.attr(g,"contentEditable",true);!u&&s(1)})}var a=t.getInstance(k);k=a.textarea[0];var c=a.iframe[0].contentWindow,h=a.document,d=h.getElementById("ke_actscrpt");d.parentNode.removeChild(d);var g=h.body;if(r.ie){g.hideFocus=true;g.disabled=true;g.contentEditable=true;g.removeAttribute("disabled")}else setTimeout(function(){if(r.gecko||r.opera)g.contentEditable=true;else if(r.webkit)g.parentNode.contentEditable=true;else h.designMode="on"},0);try{h.execCommand("enableObjectResizing",
false,true)}catch(p){}try{h.execCommand("enableInlineTableEditing",false,true)}catch(b){}r.webkit&&n.on(h,"mousedown",function(u){u=new B(u.target);A.inArray(u._4e_name(),["img","hr","input","textarea","select"])&&a.getSelection().selectElement(u)});if(r.webkit){n.on(h,"click",function(u){var C=new B(u.target);A.inArray(C._4e_name(),["input","select"])&&u.preventDefault()});n.on(h,"mouseup",function(u){var C=new B(u.target);A.inArray(C._4e_name(),["input","textarea"])&&u.preventDefault()})}if(r.gecko||
r.ie||r.opera){var f;f=new B(v.insertAfter((new B('<span style="position:absolute; left:-10000"></span>'))[0],k));f.on("focus",function(){a.focus()});a.on("destroy",function(){})}if(r.ie&&h.compatMode=="CSS1Compat"||r.gecko||r.opera){var o=new B(h.documentElement);o.on("mousedown",function(u){if(u.target===o[0]){r.gecko&&s(false);f[0].focus()}})}n.on(c,"focus",function(){if(r.gecko)s(false);else r.opera&&g.focus();a.notifySelectionChange()});r.gecko&&n.on(a.document,"mousedown",function(){a.iframeFocus||
s(false)});if(r.ie){n.on(h,"keydown",function(u){if(u.keyCode in{8:1,46:1}){var C=a.getSelection(),I=C.getSelectedElement();if(I){a.fire("save");var y=C.getRanges()[0].createBookmark();I._4e_remove();C.selectBookmarks([y]);a.fire("save");u.preventDefault()}}});if(h.compatMode=="CSS1Compat"){var z={33:1,34:1};n.on(h,"keydown",function(u){u.keyCode in z&&setTimeout(function(){a.getSelection().scrollIntoView()},0)})}}setTimeout(function(){r.ie&&setTimeout(function(){if(h){g.runtimeStyle.marginBottom=
"0px";g.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){a.fire("dataReady")},10);t.add(a)};r.gecko&&function(){var k=document.body;if(k){var s=k.getAttribute("onpageshow");k.setAttribute("onpageshow",(s?s+";":"")+"event.persisted && KISSY.Editor.focusManager.refreshAll();")}else window.addEventListener("load",arguments.callee,false)}()});
KISSY.Editor.add("dtd",function(x){x.XHTML_DTD=function(){var q=function(p){for(var b=arguments.length-1;b>0;)KISSY.mix(p,arguments[b--]);return p},A={isindex:1,fieldset:1},r={input:1,button:1,select:1,textarea:1,label:1},v=q({a:1},r),B=q({iframe:1},v),n={hr:1,ul:1,menu:1,div:1,blockquote:1,noscript:1,table:1,center:1,address:1,dir:1,pre:1,h5:1,dl:1,h4:1,noframes:1,h6:1,ol:1,h1:1,h3:1,h2:1},t={ins:1,del:1,script:1,style:1},i=q({b:1,acronym:1,bdo:1,"var":1,"#":1,abbr:1,code:1,br:1,i:1,cite:1,kbd:1,
u:1,strike:1,s:1,tt:1,strong:1,q:1,samp:1,em:1,dfn:1,span:1},t),e=q({sub:1,img:1,object:1,sup:1,basefont:1,map:1,applet:1,font:1,big:1,small:1},i),j=q({p:1},e);r=q({iframe:1},e,r);e={img:1,noscript:1,br:1,kbd:1,center:1,button:1,basefont:1,h5:1,h4:1,samp:1,h6:1,ol:1,h1:1,h3:1,h2:1,form:1,font:1,"#":1,select:1,menu:1,ins:1,abbr:1,label:1,code:1,table:1,script:1,cite:1,input:1,iframe:1,strong:1,textarea:1,noframes:1,big:1,small:1,span:1,hr:1,sub:1,bdo:1,"var":1,div:1,object:1,sup:1,strike:1,dir:1,map:1,
dl:1,applet:1,del:1,isindex:1,fieldset:1,ul:1,b:1,acronym:1,a:1,blockquote:1,i:1,u:1,s:1,tt:1,address:1,q:1,pre:1,p:1,em:1,dfn:1};var l=q({a:1},r),w={tr:1},m={"#":1},k=q({param:1},e),s=q({form:1},A,B,n,j),a={li:1},c={base:1,link:1,meta:1,title:1},h=q(c,{style:1,script:1}),d={head:1,body:1},g={address:1,blockquote:1,center:1,dir:1,div:1,dl:1,fieldset:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,isindex:1,menu:1,noframes:1,ol:1,p:1,pre:1,table:1,ul:1};return{$nonBodyContent:q({html:1},d,c),$block:g,
$blockLimit:{body:1,div:1,td:1,th:1,caption:1,form:1},$inline:l,$body:q({script:1,style:1},g),$cdata:{script:1,style:1},$empty:{area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},$listItem:{dd:1,dt:1,li:1},$list:{ul:1,ol:1,dl:1},$nonEditable:{applet:1,button:1,embed:1,iframe:1,map:1,object:1,option:1,script:1,textarea:1,param:1},$removeEmpty:{abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},$tabIndex:{a:1,area:1,button:1,input:1,object:1,select:1,textarea:1},$tableContent:{caption:1,col:1,colgroup:1,tbody:1,td:1,tfoot:1,th:1,thead:1,tr:1},html:d,head:h,style:m,body:s,base:{},link:{},meta:{},title:m,col:{},tr:{td:1,th:1},img:{},colgroup:{col:1},noscript:s,td:s,br:{},th:s,center:s,kbd:l,button:q(j,n),basefont:{},h5:l,h4:l,samp:l,h6:l,ol:a,h1:l,h3:l,option:m,h2:l,form:q(A,B,n,j),select:{optgroup:1,option:1},font:l,ins:l,menu:a,abbr:l,label:l,table:{thead:1,
col:1,tbody:1,tr:1,colgroup:1,caption:1,tfoot:1},code:l,script:m,tfoot:w,cite:l,li:s,input:{},iframe:s,strong:l,textarea:m,noframes:s,big:l,small:l,span:l,hr:{},dt:l,sub:l,optgroup:{option:1},param:{},bdo:l,"var":l,div:s,object:k,sup:l,dd:s,strike:l,area:{},dir:a,map:q({area:1,form:1,p:1},A,t,n),applet:k,dl:{dt:1,dd:1},del:l,isindex:{},fieldset:q({legend:1},e),thead:w,ul:a,acronym:l,b:l,a:r,blockquote:s,caption:l,i:l,u:l,tbody:w,s:l,address:q(B,j),tt:l,legend:l,q:l,pre:q(i,v),p:l,em:l,dfn:l}}()});
KISSY.Editor.add("dom",function(x){function q(a){return a.replace(/-(\w)/g,function(c,h){return h.toUpperCase()})}var A=KISSY,r=A.DOM,v=A.UA,B=A.Node,n=x.Utils,t={abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};x.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_DOCUMENT_FRAGMENT:11};x.POSITION={};var i=x.NODE,e=x.POSITION;e.POSITION_IDENTICAL=0;e.POSITION_DISCONNECTED=1;e.POSITION_FOLLOWING=
2;e.POSITION_PRECEDING=4;e.POSITION_IS_CONTAINED=8;e.POSITION_CONTAINS=16;var j={},l={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},w={hr:1},m=function(a){return a[0]||a},k=function(a){if(!a[0])return new B(a);return a},s={_4e_equals:function(a,c){if(!a&&!c)return true;if(!a||!c)return false;a=m(a);c=m(c);return a===c},_4e_isBlockBoundary:function(a,c){a=k(a);c=
A.mix(A.mix({},w),c||{});return l[a.css("display")]||c[a._4e_name()]},_4e_getWin:function(a){return a&&"scrollTo"in a&&a.document?a:a&&a.nodeType===9?a.defaultView||a.parentWindow:false},_4e_index:function(a){a=m(a);for(var c=a.parentNode.childNodes,h=0;h<c.length;h++)if(c[h]===a)return h;return-1},_4e_first:function(a,c){a=m(a);if((a=(a=a.firstChild)&&new B(a))&&c&&!c(a))a=a._4e_next(c);return a},_4e_move:function(a,c,h){a._4e_remove();a=m(a);c=m(c);h?c.insertBefore(a,c.firstChild):c.appendChild(a)},
_4e_name:function(a){a=m(a);var c=a.nodeName.toLowerCase();if(v.ie)if((a=a.scopeName)&&a!="HTML")c=a.toLowerCase()+":"+c;return c},_4e_isIdentical:function(a,c){if(a._4e_name()!=c._4e_name())return false;var h=a[0].attributes,d=c[0].attributes,g=h.length,p=d.length;if(!v.ie&&g!=p)return false;for(var b=0;b<g;b++){var f=h[b];if((!v.ie||f.specified&&f.nodeName!="_ke_expando")&&f.nodeValue!=c.attr(f.nodeName))return false}if(v.ie)for(b=0;b<p;b++){f=d[b];if(f.specified&&f.nodeName!="_ke_expando"&&f.nodeValue!=
a.attr(f.nodeName))return false}return true},_4e_isEmptyInlineRemoveable:function(a){a=m(a).childNodes;for(var c=0,h=a.length;c<h;c++){var d=a[c],g=d.nodeType;if(!(g==i.NODE_ELEMENT&&d.getAttribute("_ke_bookmark")))if(g==i.NODE_ELEMENT&&!s._4e_isEmptyInlineRemoveable(d)||g==i.NODE_TEXT&&A.trim(d.nodeValue))return false}return true},_4e_moveChildren:function(a,c,h){a=m(a);c=c[0]||c;if(a!=c)if(h)for(;h=a.lastChild;)c.insertBefore(a.removeChild(h),c.firstChild);else for(;h=a.firstChild;)c.appendChild(a.removeChild(h))},
_4e_mergeSiblings:function(){function a(c,h,d){if(h[0]&&h[0].nodeType==i.NODE_ELEMENT){for(var g=[];h.attr("_ke_bookmark")||h._4e_isEmptyInlineRemoveable();){g.push(h);h=d?new B(h[0].nextSibling):new B(h[0].previousSibling);if(!h[0]||h[0].nodeType!=i.NODE_ELEMENT)return}if(c._4e_isIdentical(h)){for(var p=d?c[0].lastChild:c[0].firstChild;g.length;)g.shift()._4e_move(c,!d);h._4e_moveChildren(c,!d);h._4e_remove();p[0]&&p[0].nodeType==i.NODE_ELEMENT&&p._4e_mergeSiblings()}}}return function(c){if(c[0])if(t[c._4e_name()]||
c._4e_name()=="a"){a(c,new B(c[0].nextSibling),true);a(c,new B(c[0].previousSibling))}}}(),_4e_unselectable:v.gecko?function(a){a=m(a);a.style.MozUserSelect="none"}:v.webkit?function(a){a=m(a);a.style.KhtmlUserSelect="none"}:function(a){a=m(a);if(v.ie||v.opera){var c,h=0;for(a.unselectable="on";c=a.all[h++];)switch(c.tagName.toLowerCase()){case "iframe":case "textarea":case "input":case "select":break;default:c.unselectable="on"}}},_4e_getOffset:function(a,c){a=m(a);var h,d=0;h=0;var g=a.ownerDocument.defaultView||
a.ownerDocument.parentWindow,p=a.ownerDocument,b=p.documentElement;if(a.getBoundingClientRect){if(a!==p.body&&b!==a){h=a.getBoundingClientRect();d=h.left+r.scrollLeft(g);h=h.top+r.scrollTop(g)}if(c)if(g!=(c.defaultView||c.parentWindow)&&g.frameElement){c=s._4e_getOffset(g.frameElement,c);d+=c.left;h+=c.top}}return{left:d,top:h}},_4e_getFrameDocument:function(a){return(a=m(a))&&a.contentWindow.document},_4e_splitText:function(a,c){a=m(a);var h=a.ownerDocument;if(!(!a||a.nodeType!=i.NODE_TEXT)){if(v.ie&&
c==a.nodeValue.length){h=h.createTextNode("");r.insertAfter(h,a);return h}a=new B(a.splitText(c));if(v.ie==8){h=h.createTextNode("");r.insertAfter(h,a[0]);h.parentNode.removeChild(h)}return a}},_4e_parents:function(a,c){a=k(a);var h=[];do h[c?"push":"unshift"](a);while(a=a.parent());return h},_4e_clone:function(a,c,h){a=m(a);a=a.cloneNode(c);if(!h){var d=function(g){if(g.nodeType==i.NODE_ELEMENT){g.removeAttribute("id",false);g.removeAttribute("_ke_expando",false);g=g.childNodes;for(var p=0;p<g.length;p++)d(g[p])}};
d(a)}return new B(a)},_4e_nextSourceNode:function(a,c,h,d){a=m(a);if(d&&!d.call){var g=d[0]||d;d=function(b){b=b[0]||b;return b!==g}}c=!c&&a.firstChild;var p=new B(a);if(!c){if(a.nodeType==i.NODE_ELEMENT&&d&&d(this,true)===false)return null;c=a.nextSibling}for(;!c&&(p=p.parent());){if(d&&d(p,true)===false)return null;c=p[0].nextSibling}if(!c)return null;c=new B(c);if(d&&d(c)===false)return null;if(h&&h!=c[0].nodeType)return c._4e_nextSourceNode(false,h,d);return c},_4e_previousSourceNode:function(a,
c,h,d){a=m(a);if(d&&!d.call){var g=d[0]||d;d=function(b){b=b[0]||b;return b!==g}}c=!c&&a.lastChild;var p=new B(a);if(!c){if(a.nodeType==i.NODE_ELEMENT&&d&&d(a,true)===false)return null;c=a.previousSibling}for(;!c&&(p=p.parent());){if(d&&d(p,true)===false)return null;c=p[0].previousSibling}if(!c)return null;c=new B(c);if(d&&d(c)===false)return null;if(h&&c[0].nodeType!=h)return c._4e_previousSourceNode(false,h,d);return c},_4e_contains:v.ie||v.webkit?function(a,c){a=m(a);c=m(c);return c.nodeType!=
i.NODE_ELEMENT?a.contains(c.parentNode):a!=c&&a.contains(c)}:function(a,c){a=m(a);c=m(c);return!!(a.compareDocumentPosition(c)&16)},_4e_commonAncestor:function(a,c){if(a._4e_equals(c))return a;if(c[0].nodeType!=i.NODE_TEXT&&c._4e_contains(a))return c;a=a[0].nodeType==i.NODE_TEXT?a.parent():a;do if(a[0].nodeType!=i.NODE_TEXT&&a._4e_contains(c))return a;while(a=a.parent());return null},_4e_ascendant:function(a,c,h){a=m(a);if(!h)a=a.parentNode;if(c&&!A.isFunction(c)){var d=c;c=function(g){return g._4e_name()==
d}}for(;a&&a.nodeType!=9;){if(!c||c(new B(a))===true)return new B(a);a=a.parentNode}return null},_4e_hasAttribute:function(a,c){a=m(a);a=a.attributes.getNamedItem(c);return!!(a&&a.specified)},_4e_hasAttributes:v.ie?function(a){a=m(a);for(var c=a.attributes,h=0;h<c.length;h++){var d=c[h];switch(d.nodeName){case "class":if(a.getAttribute("class"))return true;break;case "_ke_expando":continue;default:if(d.specified)return true}}return false}:function(a){a=m(a);v.gecko&&a.removeAttribute("_moz_dirty");
a=a.attributes;return a.length>1||a.length==1&&a[0].nodeName!="_ke_expando"},_4e_position:function(a,c){var h=m(a),d=m(c);if(h.compareDocumentPosition)return h.compareDocumentPosition(d);if(h==d)return e.POSITION_IDENTICAL;if(h.nodeType==i.NODE_ELEMENT&&d.nodeType==i.NODE_ELEMENT){if(h.contains){if(h.contains(d))return e.POSITION_CONTAINS+e.POSITION_PRECEDING;if(d.contains(h))return e.POSITION_IS_CONTAINED+e.POSITION_FOLLOWING}if("sourceIndex"in h)return h.sourceIndex<0||d.sourceIndex<0?e.POSITION_DISCONNECTED:
h.sourceIndex<d.sourceIndex?e.POSITION_PRECEDING:e.POSITION_FOLLOWING}a=a._4e_address();c=c._4e_address();h=Math.min(a.length,c.length);for(d=0;d<=h-1;d++)if(a[d]!=c[d]){if(d<h)return a[d]<c[d]?e.POSITION_PRECEDING:e.POSITION_FOLLOWING;break}return a.length<c.length?e.POSITION_CONTAINS+e.POSITION_PRECEDING:e.POSITION_IS_CONTAINED+e.POSITION_FOLLOWING},_4e_address:function(a,c){a=m(a);var h=[],d=a.ownerDocument.documentElement;for(a=a;a&&a!=d;){var g=a.parentNode,p=-1;if(g){for(var b=0;b<g.childNodes.length;b++){var f=
g.childNodes[b];if(!(c&&f.nodeType==3&&f.previousSibling&&f.previousSibling.nodeType==3)){p++;if(f==a)break}}h.unshift(p)}a=g}return h},_4e_breakParent:function(a,c){var h=new x.Range(a[0].ownerDocument);h.setStartAfter(a);h.setEndAfter(c);c=h.extractContents();h.insertNode(a._4e_remove());a[0].parentNode.insertBefore(c,a[0].nextSibling)},_4e_style:function(a,c,h){if(h!==undefined)return a.css(c,h);a=a[0]||a;return a.style[q(c)]},_4e_remove:function(a,c){var h=m(a),d=h.parentNode;if(d){if(c)for(;c=
h.firstChild;)d.insertBefore(h.removeChild(c),h);d.removeChild(h)}return a},_4e_trim:function(a){r._4e_ltrim(a);r._4e_rtrim(a)},_4e_ltrim:function(a){a=m(a);for(var c;c=a.firstChild;){if(c.nodeType==i.NODE_TEXT){var h=n.ltrim(c.nodeValue),d=c.nodeValue.length;if(h){if(h.length<d){(new B(c))._4e_splitText(d-h.length);a.removeChild(a.firstChild)}}else{a.removeChild(c);continue}}break}},_4e_rtrim:function(a){a=m(a);for(var c;c=a.lastChild;){if(c.type==i.NODE_TEXT){var h=n.rtrim(c.nodeValue),d=c.nodeValue.length;
if(h){if(h.length<d){(new B(c))._4e_splitText(h.length);a.removeChild(a.lastChild)}}else{a.removeChild(c);continue}}break}if(!v.ie&&!v.opera)(c=a.lastChild)&&c.nodeType==1&&c.nodeName.toLowerCase()=="br"&&c.parentNode.removeChild(c)},_4e_appendBogus:function(a){a=m(a);for(var c=a.lastChild;c&&c.nodeType==i.NODE_TEXT&&!A.trim(c.nodeValue);)c=c.previousSibling;if(!c||c.nodeType==i.NODE_TEXT||r._4e_name(c)!=="br"){c=v.opera?a.ownerDocument.createTextNode(""):a.ownerDocument.createElement("br");v.gecko&&
c.setAttribute("type","_moz");a.appendChild(c)}},_4e_previous:function(a,c){a=m(a);var h;do h=(a=a.previousSibling)&&new B(a);while(h&&c&&!c(h));return h},_4e_last:function(a,c){if((a=(a=a[0].lastChild)&&new B(a))&&c&&!c(a))a=a._4e_previous(c);return a},_4e_next:function(a,c){a=m(a);var h;do h=(a=a.nextSibling)&&new B(a);while(h&&c&&!c(h));return h},_4e_outerHtml:function(a){a=m(a);if(a.outerHTML)return a.outerHTML.replace(/<\?[^>]*>/,"");var c=a.ownerDocument.createElement("div");c.appendChild(a.cloneNode(true));
return c.innerHTML},_4e_setMarker:function(a,c,h,d){a[0]||(a=new B(a));var g=a._4e_getData("list_marker_id")||a._4e_setData("list_marker_id",A.guid())._4e_getData("list_marker_id"),p=a._4e_getData("list_marker_names")||a._4e_setData("list_marker_names",{})._4e_getData("list_marker_names");c[g]=a;p[h]=1;return a._4e_setData(h,d)},_4e_clearMarkers:function(a,c,h){a=k(a);var d=a._4e_getData("list_marker_names"),g=a._4e_getData("list_marker_id");for(var p in d)a._4e_removeData(p);a._4e_removeData("list_marker_names");
if(h){a._4e_removeData("list_marker_id");delete c[g]}},_4e_setData:function(a,c,h){var d=r._4e_getUniqueId(a);(j[d]||(j[d]={}))[c]=h;return a},_4e_getData:function(a,c){a=m(a);return(a=(a=a.getAttribute("_ke_expando"))&&j[a])&&a[c]},_4e_removeData:function(a,c){a=m(a);var h=a.getAttribute("_ke_expando");var d=(h=h&&j[h])&&h[c];typeof d!="undefined"&&h&&delete h[c];A.isEmptyObject(h)&&r._4e_clearData(a);return d||null},_4e_clearData:function(a){a=m(a);var c=a.getAttribute("_ke_expando");c&&delete j[c];
c&&a.removeAttribute("_ke_expando")},_4e_getUniqueId:function(a){a=m(a);var c=a.getAttribute("_ke_expando");if(c)return c;c=A.guid();a.setAttribute("_ke_expando",c);return c},_4e_copyAttributes:function(a,c,h){a=m(a);var d=a.attributes;h=h||{};for(var g=0;g<d.length;g++){var p=d[g],b=p.nodeName.toLowerCase(),f;if(!(b in h))if(b=="checked"&&(f=r.attr(a,b)))c.attr(b,f);else if(p.specified||v.ie&&p.nodeValue&&b=="value"){f=r.attr(a,b);if(f===null)f=p.nodeValue;c.attr(b,f)}}if(a.style.cssText!=="")c[0].style.cssText=
a.style.cssText},_4e_isEditable:function(a){a=r._4e_name(a);var c=x.XHTML_DTD;return(a=!c.$nonEditable[a]&&(c[a]||c.span))&&a["#"]},_4e_scrollIntoView:function(a){a=k(a);var c=a[0].ownerDocument,h=r.scrollLeft(c),d=r.scrollTop(c),g=a.offset(),p=g.left;g=g.top;if(r.viewportHeight(c)+d<g||g<d||r.viewportWidth(c)+h<p||p<h)a.scrollIntoView(c)},_4e_getElementsByTagName:function(a,c,h){a=m(a);if(!v.ie&&h)c=h+":"+c;h=[];a=a.getElementsByTagName(c);for(c=0;c<a.length;c++)h.push(new B(a[c]));return h}};A.DOM._4e_inject=
function(a){A.mix(r,a);for(var c in a)a.hasOwnProperty(c)&&function(h){B.prototype[h]=function(){var d=[].slice.call(arguments,0);d.unshift(this);return a[h].apply(null,d)}}(c)};A.DOM._4e_inject(s)});
KISSY.Editor.add("elementpath",function(x){function q(j){var l=null,w=null,m=[];for(j=j;j&&j[0];){if(j[0].nodeType==B.NODE_ELEMENT){if(!this.lastElement)this.lastElement=j;var k=j._4e_name();if(n.ie&&j[0].scopeName!="HTML")k=j[0].scopeName.toLowerCase()+":"+k;if(!w){if(!l&&t[k])l=j;if(i[k])if(!l&&k=="div"&&!e(j))l=j;else w=j}m.push(j);if(k=="body")break}j=j.parent()}this.block=l;this.blockLimit=w;this.elements=m}var A=KISSY,r=A.DOM,v=x.XHTML_DTD,B=x.NODE,n=A.UA,t={address:1,blockquote:1,dl:1,h1:1,
h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},i={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1},e=function(j){j=j[0]||j;j=j.childNodes;for(var l=0,w=j.length;l<w;l++){var m=j[l];if(m.nodeType==B.NODE_ELEMENT&&v.$block[m.nodeName.toLowerCase()])return true}return false};q.prototype={compare:function(j){var l=this.elements;j=j&&j.elements;if(!j||l.length!=j.length)return false;for(var w=0;w<l.length;w++)if(!r._4e_equals(l[w],j[w]))return false;return true},contains:function(j){for(var l=
this.elements,w=0;w<l.length;w++)if(l[w]._4e_name()in j)return l[w];return null}};x.ElementPath=q});
KISSY.Editor.add("walker",function(x){function q(i,e){if(this._.end)return null;var j=this.range,l,w=this.guard,m=this.type,k=i?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start){this._.start=1;j.trim();if(j.collapsed){this.end();return null}}if(!i&&!this._.guardLTR){var s=j.endContainer,a=new t(s[0].childNodes[j.endOffset]);this._.guardLTR=function(g,p){return(!p||!n._4e_equals(s,g))&&(!a[0]||g[0]!==a[0])&&(g[0].nodeType!=B.NODE_ELEMENT||!p||g._4e_name()!="body")}}if(i&&!this._.guardRTL){var c=
j.startContainer,h=j.startOffset>0&&new t(c[0].childNodes[j.startOffset-1]);this._.guardRTL=function(g,p){return g&&g[0]&&(!p||c[0]!==g[0])&&(!h[0]||g[0]!==h[0])&&(g[0].nodeType!=B.NODE_ELEMENT||!p||g._4e_name()!="body")}}var d=i?this._.guardRTL:this._.guardLTR;l=w?function(g,p){if(d(g,p)===false)return false;return w(g,p)}:d;if(this.current)i=this.current[k](false,m,l);else if(i){i=j.endContainer;if(j.endOffset>0){i=new t(i[0].childNodes[j.endOffset-1]);if(l(i)===false)i=null}else i=l(i,true)===
false?null:i._4e_previousSourceNode(true,m,l)}else{i=j.startContainer;if((i=new t(i[0].childNodes[j.startOffset]))&&i[0]){if(l(i)===false)i=null}else i=l(j.startContainer,true)===false?null:j.startContainer._4e_nextSourceNode(true,m,l)}for(;i&&i[0]&&!this._.end;){this.current=i;if(!this.evaluator||this.evaluator(i)!==false){if(!e)return i}else if(e&&this.evaluator)return false;i=i[k](false,m,l)}this.end();return this.current=null}function A(i){for(var e,j=null;e=q.call(this,i);)j=e;return j}function r(i){this.range=
i;this._={}}var v=KISSY,B=x.NODE,n=v.DOM,t=v.Node;v.augment(r,{end:function(){this._.end=1},next:function(){return q.call(this)},previous:function(){return q.call(this,true)},checkForward:function(){return q.call(this,false,true)!==false},checkBackward:function(){return q.call(this,true,true)!==false},lastForward:function(){return A.call(this)},lastBackward:function(){return A.call(this,true)},reset:function(){delete this.current;this._={}}});r.blockBoundary=function(i){return function(e){e[0]||(e=
new t(e));return!(e[0].nodeType==B.NODE_ELEMENT&&e._4e_isBlockBoundary(i))}};r.listItemBoundary=function(){return this.blockBoundary({br:1})};r.bookmark=function(i,e){function j(l){return l&&l[0]&&l._4e_name()=="span"&&l.attr("_ke_bookmark")}return function(l){var w,m;w=l&&l[0]&&l[0].nodeType==B.NODE_TEXT&&(m=l.parent())&&j(m);w=i?w:w||j(l);return e^w}};r.whitespaces=function(i){return function(e){e=(e=e[0]||e)&&e.nodeType==B.NODE_TEXT&&!v.trim(e.nodeValue);return i^e}};r.invisible=function(i){var e=
r.whitespaces();return function(j){j=e(j)||j[0].nodeType==B.NODE_ELEMENT&&!j[0].offsetHeight;return i^j}};x.Walker=r});
KISSY.Editor.add("range",function(x){function q(b){this.endOffset=this.endContainer=this.startOffset=this.startContainer=null;this.collapsed=true;this.document=b}function A(b){var f=b[0].nodeType!=i.NODE_TEXT&&b._4e_name()in s.$removeEmpty,o=!t.trim(b[0].nodeValue);b=!!b.parent().attr("_ke_bookmark");return f||o||b}function r(b){return!g(b)&&!p(b)}function v(b){var f=false,o=l.bookmark(true);return function(z){if(o(z))return true;if(z[0].nodeType==i.NODE_TEXT){if(t.trim(z[0].nodeValue).length)return false}else if(z[0].nodeType==
i.NODE_ELEMENT)if(!d[z._4e_name()])if(!b&&!k.ie&&z._4e_name()=="br"&&!f)f=true;else return false;return true}}function B(b,f){function o(z){return z&&z.nodeName=="span"&&z.getAttribute("_ke_bookmark")}return function(z){var u,C;u=z&&!z.nodeName&&(C=z.parentNode)&&o(C);u=b?u:u||o(z);return f^u}}function n(b){return function(f){f=(f=f[0]||f)&&f.nodeType==i.NODE_TEXT&&!t.trim(f.nodeValue);return b^f}}x.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,
ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,STARTEND:3,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var t=KISSY,i=x.NODE,e=x.RANGE,j=x.POSITION,l=x.Walker,w=t.DOM,m=x.Utils.getByAddress,k=t.UA,s=x.XHTML_DTD,a=x.ElementPath,c=t.Node,h={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1};q.prototype.toString=function(){var b=[];b.push((this.startContainer[0].id||this.startContainer[0].nodeName)+":"+this.startOffset);b.push((this.endContainer[0].id||this.endContainer[0].nodeName)+
":"+this.endOffset);return b.join("<br/>")};t.augment(q,{updateCollapsed:function(){this.collapsed=this.startContainer&&this.endContainer&&w._4e_equals(this.startContainer,this.endContainer)&&this.startOffset==this.endOffset},optimize:function(){var b=this.startContainer,f=this.startOffset;if(b[0].nodeType!=i.NODE_ELEMENT)if(f)f>=b[0].nodeValue.length&&this.setStartAfter(b);else this.setStartBefore(b);b=this.endContainer;f=this.endOffset;if(b[0].nodeType!=i.NODE_ELEMENT)if(f)f>=b[0].nodeValue.length&&
this.setEndAfter(b);else this.setEndBefore(b)},setStartAfter:function(b){this.setStart(b.parent(),b._4e_index()+1)},setStartBefore:function(b){this.setStart(b.parent(),b._4e_index())},setEndAfter:function(b){this.setEnd(b.parent(),b._4e_index()+1)},setEndBefore:function(b){this.setEnd(b.parent(),b._4e_index())},optimizeBookmark:function(){var b=this.startContainer,f=this.endContainer;b&&b._4e_name()=="span"&&b.attr("_ke_bookmark")&&this.setStartAt(b,e.POSITION_BEFORE_START);f&&f._4e_name()=="span"&&
f.attr("_ke_bookmark")&&this.setEndAt(f,e.POSITION_AFTER_END)},setStart:function(b,f){if(b[0].nodeType==i.NODE_ELEMENT&&h[b._4e_name()]){b=b.parent();f=b._4e_index()}this.startContainer=b;this.startOffset=f;if(!this.endContainer){this.endContainer=b;this.endOffset=f}this.updateCollapsed()},setEnd:function(b,f){if(b[0].nodeType==i.NODE_ELEMENT&&h[b._4e_name()]){b=b.parent();f=b._4e_index()+1}this.endContainer=b;this.endOffset=f;if(!this.startContainer){this.startContainer=b;this.startOffset=f}this.updateCollapsed()},
setStartAt:function(b,f){switch(f){case e.POSITION_AFTER_START:this.setStart(b,0);break;case e.POSITION_BEFORE_END:b[0].nodeType==i.NODE_TEXT?this.setStart(b,b[0].nodeValue.length):this.setStart(b,b[0].childNodes.length);break;case e.POSITION_BEFORE_START:this.setStartBefore(b);break;case e.POSITION_AFTER_END:this.setStartAfter(b)}this.updateCollapsed()},setEndAt:function(b,f){switch(f){case e.POSITION_AFTER_START:this.setEnd(b,0);break;case e.POSITION_BEFORE_END:b[0].nodeType==i.NODE_TEXT?this.setEnd(b,
b[0].nodeValue.length):this.setEnd(b,b[0].childNodes.length);break;case e.POSITION_BEFORE_START:this.setEndBefore(b);break;case e.POSITION_AFTER_END:this.setEndAfter(b)}this.updateCollapsed()},execContentsAction:function(b,f){var o=this.startContainer,z=this.endContainer,u=this.startOffset,C=this.endOffset,I,y;this.optimizeBookmark();if(z[0].nodeType==i.NODE_TEXT)z=z._4e_splitText(C);else if(z[0].childNodes.length>0)if(C>=z[0].childNodes.length){z=new c(z[0].appendChild(this.document.createTextNode("")));
y=true}else z=new c(z[0].childNodes[C]);if(o[0].nodeType==i.NODE_TEXT){o._4e_splitText(u);if(w._4e_equals(o,z))z=new c(o[0].nextSibling)}else if(u)if(u>=o[0].childNodes.length){I=new c(this.document.createTextNode(""));o[0].appendChild(I[0]);o=I;I=true}else o=new c(o[0].childNodes[u].previousSibling);else{I=new c(this.document.createTextNode(""));w.insertBefore(I[0],o[0].firstChild);o=I;I=true}u=o._4e_parents();C=z._4e_parents();var D,G,J;for(D=0;D<u.length;D++){G=u[D];J=C[D];if(G[0]!==J[0])break}for(var N=
f,M,Q,R,W=D;W<u.length;W++){M=u[W];if(N&&M[0]!==o[0])Q=N.appendChild(M._4e_clone()[0]);for(M=M[0].nextSibling;M;){if(C[W]&&M==C[W][0]||M==z[0])break;R=M.nextSibling;if(b==2)N.appendChild(M.cloneNode(true));else{M.parentNode.removeChild(M);b==1&&N.appendChild(M)}M=R}if(Q)N=Q}N=f;for(f=D;f<C.length;f++){M=C[f];if(b>0&&M[0]!==z[0])Q=N.appendChild(M._4e_clone()[0]);if(!u[f]||M[0].parentNode!==u[f][0].parentNode)for(M=M[0].previousSibling;M;){if(u[f]&&M==u[f][0]||M===o[0])break;R=M.previousSibling;if(b==
2)N.insertBefore(M.cloneNode(true),N.firstChild);else{M.parentNode.removeChild(M);b==1&&N.insertBefore(M,N.firstChild)}M=R}if(Q)N=Q}if(b==2){J=this.startContainer[0];if(J.nodeType==i.NODE_TEXT&&J.nextSibling&&J.nextSibling.nodeType==i.NODE_TEXT){J.data+=J.nextSibling.data;J.parentNode.removeChild(J.nextSibling)}J=this.endContainer[0];if(J.nodeType==i.NODE_TEXT&&J.nextSibling&&J.nextSibling.nodeType==i.NODE_TEXT){J.data+=J.nextSibling.data;J.parentNode.removeChild(J.nextSibling)}}else{if(G&&J&&(o[0].parentNode!=
G[0].parentNode||z[0].parentNode!=J[0].parentNode)){b=J._4e_index();I&&J[0].parentNode==o[0].parentNode&&b--;this.setStart(J.parent(),b)}this.collapse(true)}I&&o._4e_remove();y&&z[0].parentNode&&z._4e_remove()},collapse:function(b){if(b){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=this.endOffset}this.collapsed=true},clone:function(){var b=new q(this.document);b.startContainer=this.startContainer;b.startOffset=this.startOffset;
b.endContainer=this.endContainer;b.endOffset=this.endOffset;b.collapsed=this.collapsed;return b},getEnclosedNode:function(){var b=this.clone();b.optimize();if(b.startContainer[0].nodeType!=i.NODE_ELEMENT||b.endContainer[0].nodeType!=i.NODE_ELEMENT)return null;b=b.startContainer[0].childNodes[b.startOffset];for(var f=B(true,undefined),o=n(true),z=function(u){return o(u)&&f(u)};b&&z(b);)b=(new c(b))._4e_nextSourceNode()[0];return new c(b)},shrink:function(b,f){if(!this.collapsed){b=b||e.SHRINK_TEXT;
var o=this.clone(),z=this.startContainer,u=this.endContainer,C=this.startOffset,I=this.endOffset,y=1,D=1;if(z&&z[0].nodeType==i.NODE_TEXT)if(C)if(C>=z[0].nodeValue.length)o.setStartAfter(z);else{o.setStartBefore(z);y=0}else o.setStartBefore(z);if(u&&u[0].nodeType==i.NODE_TEXT)if(I)if(I>=u[0].nodeValue.length)o.setEndAfter(u);else{o.setEndAfter(u);D=0}else o.setEndBefore(u);o=new l(o);o.evaluator=function(J){J=J[0]||J;return J.nodeType==(b==e.SHRINK_ELEMENT?i.NODE_ELEMENT:i.NODE_TEXT)};var G;o.guard=
function(J,N){J=J[0]||J;if(b==e.SHRINK_ELEMENT&&J.nodeType==i.NODE_TEXT)return false;if(N&&J==G)return false;if(!N&&J.nodeType==i.NODE_ELEMENT)G=J;return true};if(y)(z=o[b==e.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(z,f?e.POSITION_AFTER_START:e.POSITION_BEFORE_START);if(D){o.reset();(o=o[b==e.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(o,f?e.POSITION_BEFORE_END:e.POSITION_AFTER_END)}return!!(y||D)}},getTouchedStartNode:function(){var b=this.startContainer;if(this.collapsed||
b[0].nodeType!=i.NODE_ELEMENT)return b;return b.childNodes[this.startOffset]||b},createBookmark2:function(b){var f=this.startContainer,o=this.endContainer,z=this.startOffset,u=this.endOffset,C,I;if(!f||!o)return{start:0,end:0};if(b){if(f[0].nodeType==i.NODE_ELEMENT)if((C=new c(f[0].childNodes[z]))&&C[0]&&C[0].nodeType==i.NODE_TEXT&&z>0&&C[0].previousSibling.nodeType==i.NODE_TEXT){f=C;z=0}for(;f[0].nodeType==i.NODE_TEXT&&(I=f._4e_previous())&&I[0].nodeType==i.NODE_TEXT;){f=I;z+=I[0].nodeValue.length}if(!this.collapsed){if(o[0].nodeType==
i.NODE_ELEMENT)if((C=new c(o[0].childNodes[u]))&&C[0]&&C[0].nodeType==i.NODE_TEXT&&u>0&&C[0].previousSibling.nodeType==i.NODE_TEXT){o=C;u=0}for(;o[0].nodeType==i.NODE_TEXT&&(I=o._4e_previous())&&I[0].nodeType==i.NODE_TEXT;){o=I;u+=I[0].nodeValue.length}}}return{start:f._4e_address(b),end:this.collapsed?null:o._4e_address(b),startOffset:z,endOffset:u,normalized:b,is2:true}},createBookmark:function(b){var f,o,z,u;f=new c("<span></span>",null,this.document);f.attr("_ke_bookmark",1);f.css("display","none");
f.html("&nbsp;");if(b){z=t.guid("ke_bm_");f.attr("id",z+"S")}if(!this.collapsed){o=f._4e_clone();o.html("&nbsp;");b&&o.attr("id",z+"E");u=this.clone();u.collapse();u.insertNode(o)}u=this.clone();u.collapse(true);u.insertNode(f);if(o){this.setStartAfter(f);this.setEndBefore(o)}else this.moveToPosition(f,e.POSITION_AFTER_END);return{startNode:b?z+"S":f,endNode:b?z+"E":o,serializable:b}},moveToPosition:function(b,f){this.setStartAt(b,f);this.collapse(true)},trim:function(b,f){var o=this.startContainer,
z=this.startOffset,u=this.collapsed;if((!b||u)&&o[0]&&o[0].nodeType==i.NODE_TEXT){if(z)if(z>=o[0].nodeValue.length){z=o._4e_index()+1;o=o.parent()}else{b=o._4e_splitText(z);z=o._4e_index()+1;o=o.parent();if(w._4e_equals(this.startContainer,this.endContainer))this.setEnd(b,this.endOffset-this.startOffset);else if(w._4e_equals(o,this.endContainer))this.endOffset+=1}else{z=o._4e_index();o=o.parent()}this.setStart(o,z);if(u){this.collapse(true);return}}o=this.endContainer;z=this.endOffset;if(!(f||u)&&
o[0]&&o[0].nodeType==i.NODE_TEXT){if(z){z>=o.nodeValue.length||o._4e_splitText(z);z=o._4e_index()+1}else z=o._4e_index();o=o.parent();this.setEnd(o,z)}},insertNode:function(b){this.optimizeBookmark();this.trim(false,true);var f=this.startContainer,o=f[0].childNodes[this.startOffset];this.optimizeBookmark();this.trim(false,true);o?w.insertBefore(b[0]||b,o):f[0].appendChild(b[0]||b);w._4e_equals(b.parent(),this.endContainer)&&this.endOffset++;this.setStartBefore(b)},moveToBookmark:function(b){if(b.is2){var f=
m(this.document,b.start,b.normalized),o=b.startOffset,z=b.end&&m(this.document,b.end,b.normalized);b=b.endOffset;this.setStart(f,o);z?this.setEnd(z,b):this.collapse(true)}else{f=(o=b.serializable)?t.one("#"+b.startNode,this.document):b.startNode;b=o?t.one("#"+b.endNode,this.document):b.endNode;this.setStartBefore(f);f._4e_remove();if(b&&b[0]){this.setEndBefore(b);b._4e_remove()}else this.collapse(true)}},getCommonAncestor:function(b,f){var o=this.startContainer,z=this.endContainer;b=w._4e_equals(o,
z)?b&&o[0].nodeType==i.NODE_ELEMENT&&this.startOffset==this.endOffset-1?new c(o[0].childNodes[this.startOffset]):o:o._4e_commonAncestor(z);return f&&b[0].nodeType==i.NODE_TEXT?b.parent():b},enlarge:function(b){switch(b){case e.ENLARGE_ELEMENT:if(this.collapsed)return;b=this.getCommonAncestor();var f=new c(this.document.body),o,z,u,C,I,y=false,D,G;D=this.startContainer;G=this.startOffset;if(D[0].nodeType==i.NODE_TEXT){if(G){D=!t.trim(D[0].nodeValue.substring(0,G)).length&&D;y=!!D}if(D)if(!(C=D[0].previousSibling))u=
D.parent()}else{if(G)C=D[0].childNodes[G-1]||D[0].lastChild;C||(u=D)}for(;u||C;){if(u&&!C){if(!I&&w._4e_equals(u,b))I=true;if(!f._4e_contains(u))break;if(!y||u.css("display")!="inline"){y=false;if(I)o=u;else this.setStartBefore(u)}C=u[0].previousSibling}for(;C;){D=false;if(C.nodeType==i.NODE_TEXT){G=C.nodeValue;if(/[^\s\ufeff]/.test(G))C=null;D=/[\s\ufeff]$/.test(G)}else if(C.offsetWidth>0&&!C.getAttribute("_ke_bookmark"))if(y&&s.$removeEmpty[C.nodeName.toLowerCase()]){G=w.text(C);if(/[^\s\ufeff]/.test(G))C=
null;else for(var J=C.all||C.getElementsByTagName("*"),N=0,M;M=J[N++];)if(!s.$removeEmpty[M.nodeName.toLowerCase()]){C=null;break}if(C)D=!!G.length}else C=null;if(D)if(y)if(I)o=u;else u&&this.setStartBefore(u);else y=true;if(C){D=C.previousSibling;if(!u&&!D){u=new c(C);C=null;break}C=D}else u=null}if(u)u=u.parent()}D=this.endContainer;G=this.endOffset;u=C=null;I=y=false;if(D[0].nodeType==i.NODE_TEXT){D=!t.trim(D[0].nodeValue.substring(G)).length&&D;y=!(D&&D[0].nodeValue.length);if(D)if(!(C=D[0].nextSibling))u=
D.parent()}else(C=D[0].childNodes[G])||(u=D);for(;u||C;){if(u&&!C){if(!I&&w._4e_equals(u,b))I=true;if(!f._4e_contains(u))break;if(!y||u.css("display")!="inline"){y=false;if(I)z=u;else u&&this.setEndAfter(u)}C=u[0].nextSibling}for(;C;){D=false;if(C.nodeType==i.NODE_TEXT){G=C.nodeValue;if(/[^\s\ufeff]/.test(G))C=null;D=/^[\s\ufeff]/.test(G)}else if(C.offsetWidth>0&&!C.getAttribute("_ke_bookmark"))if(y&&s.$removeEmpty[C.nodeName.toLowerCase()]){G=w.text(C);if(/[^\s\ufeff]/.test(G))C=null;else{J=C.all||
C.getElementsByTagName("*");for(N=0;M=J[N++];)if(!s.$removeEmpty[M.nodeName.toLowerCase()]){C=null;break}}if(C)D=!!G.length}else C=null;if(D)if(y)if(I)z=u;else this.setEndAfter(u);if(C){D=C.nextSibling;if(!u&&!D){u=new c(C);C=null;break}C=D}else u=null}if(u)u=u.parent()}if(o&&z){b=o._4e_contains(z)?z:o;this.setStartBefore(b);this.setEndAfter(b)}break;case e.ENLARGE_BLOCK_CONTENTS:case e.ENLARGE_LIST_ITEM_CONTENTS:u=new q(this.document);f=new c(this.document.body);u.setStartAt(f,e.POSITION_AFTER_START);
u.setEnd(this.startContainer,this.startOffset);u=new l(u);var Q,R,W=l.blockBoundary(b==e.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:null),$=function(aa){var E=W(aa);E||(Q=aa);return E};o=function(aa){var E=$(aa);if(!E&&aa[0]&&aa._4e_name()=="br")R=aa;return E};u.guard=$;u=u.lastBackward();Q=Q||f;this.setStartAt(Q,Q._4e_name()!="br"&&(!u&&this.checkStartOfBlock()||u&&Q._4e_contains(u))?e.POSITION_AFTER_START:e.POSITION_AFTER_END);u=this.clone();u.collapse();u.setEndAt(f,e.POSITION_BEFORE_END);u=new l(u);u.guard=
b==e.ENLARGE_LIST_ITEM_CONTENTS?o:$;Q=null;u=u.lastForward();Q=Q||f;this.setEndAt(Q,!u&&this.checkEndOfBlock()||u&&Q._4e_contains(u)?e.POSITION_BEFORE_END:e.POSITION_BEFORE_START);R&&this.setEndAfter(R)}},checkStartOfBlock:function(){var b=this.startContainer,f=this.startOffset;if(f&&b[0].nodeType==i.NODE_TEXT)if(t.trim(b[0].nodeValue.substring(0,f)).length)return false;this.trim();b=new a(this.startContainer);f=this.clone();f.collapse(true);f.setStartAt(b.block||b.blockLimit,e.POSITION_AFTER_START);
b=new l(f);b.evaluator=v(true);return b.checkBackward()},checkEndOfBlock:function(){var b=this.endContainer,f=this.endOffset;if(b[0].nodeType==i.NODE_TEXT)if(t.trim(b[0].nodeValue.substring(f)).length)return false;this.trim();b=new a(this.endContainer);f=this.clone();f.collapse(false);f.setEndAt(b.block||b.blockLimit,e.POSITION_BEFORE_END);b=new l(f);b.evaluator=v(false);return b.checkForward()},deleteContents:function(){this.collapsed||this.execContentsAction(0)},extractContents:function(){var b=
this.document.createDocumentFragment();this.collapsed||this.execContentsAction(1,b);return b},checkBoundaryOfElement:function(b,f){var o=this.clone();o[f==e.START?"setStartAt":"setEndAt"](b,f==e.START?e.POSITION_AFTER_START:e.POSITION_BEFORE_END);b=new l(o);b.evaluator=A;return b[f==e.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var b=this.startContainer,f=this.endContainer,o=this.startOffset,z=this.endOffset,u;if(b[0].nodeType==i.NODE_ELEMENT){u=b[0].childNodes.length;if(u>
o)b=new c(b[0].childNodes[o]);else if(u<1)b=b._4e_previousSourceNode();else{for(b=b[0];b.lastChild;)b=b.lastChild;b=new c(b);b=b._4e_nextSourceNode()||b}}if(f[0].nodeType==i.NODE_ELEMENT){u=f[0].childNodes.length;if(u>z)f=(new c(f[0].childNodes[z]))._4e_previousSourceNode(true);else if(u<1)f=f._4e_previousSourceNode();else{for(f=f[0];f.lastChild;)f=f.lastChild;f=new c(f)}}if(b._4e_position(f)&j.POSITION_FOLLOWING)b=f;return{startNode:b,endNode:f}},fixBlock:function(b,f){var o=this.createBookmark();
f=new c(this.document.createElement(f));this.collapse(b);this.enlarge(e.ENLARGE_BLOCK_CONTENTS);f[0].appendChild(this.extractContents());f._4e_trim();k.ie||f._4e_appendBogus();this.insertNode(f);this.moveToBookmark(o);return f},splitBlock:function(b){var f=new a(this.startContainer),o=new a(this.endContainer),z=f.block,u=o.block,C=null;if(f.blockLimit[0]!==o.blockLimit[0])return null;if(b!="br"){if(!z){z=this.fixBlock(true,b);u=(new a(this.endContainer)).block}u||(u=this.fixBlock(false,b))}b=z&&this.checkStartOfBlock();
f=u&&this.checkEndOfBlock();this.deleteContents();if(z&&w._4e_equals(z,u))if(f){C=new a(this.startContainer);this.moveToPosition(u,e.POSITION_AFTER_END);u=null}else if(b){C=new a(this.startContainer);this.moveToPosition(z,e.POSITION_BEFORE_START);z=null}else{u=this.splitElement(z);!k.ie&&!t.inArray(z._4e_name(),["ul","ol"])&&z._4e_appendBogus()}return{previousBlock:z,nextBlock:u,wasStartOfBlock:b,wasEndOfBlock:f,elementPath:C}},splitElement:function(b){if(!this.collapsed)return null;this.setEndAt(b,
e.POSITION_BEFORE_END);var f=this.extractContents(),o=b._4e_clone(false);o[0].appendChild(f);o.insertAfter(b);this.moveToPosition(b,e.POSITION_AFTER_END);return o},moveToElementEditablePosition:function(b,f){var o,z=x.XHTML_DTD;if(z.$empty[b._4e_name()])return false;for(;b&&b[0].nodeType==i.NODE_ELEMENT;){if(o=b._4e_isEditable())this.moveToPosition(b,f?e.POSITION_BEFORE_END:e.POSITION_AFTER_START);else if(z.$inline[b._4e_name()]){this.moveToPosition(b,f?e.POSITION_AFTER_END:e.POSITION_BEFORE_START);
return true}if((b=z.$empty[b._4e_name()]?b[f?"_4e_previous":"_4e_next"](r):b[f?"_4e_last":"_4e_first"](r))&&b[0].nodeType==i.NODE_TEXT){this.moveToPosition(b,f?e.POSITION_AFTER_END:e.POSITION_BEFORE_START);return true}}return o},selectNodeContents:function(b){this.setStart(b,0);this.setEnd(b,b[0].nodeType==i.NODE_TEXT?b[0].nodeValue.length:b[0].childNodes.length)}});var d={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},g=new l.whitespaces,p=new l.bookmark;x.Range=q});
KISSY.Editor.add("domiterator",function(x){function q(m){if(!(arguments.length<1)){this.range=m;this.forceBrBreak=false;this.enlargeBr=true;this.enforceRealBlocks=false;this._||(this._={})}}var A=KISSY,r=A.UA,v=x.Walker,B=x.Range,n=x.RANGE,t=x.NODE,i=x.ElementPath,e=A.Node,j=A.DOM,l=/^[\r\n\t ]*$/,w=v.bookmark();A.augment(q,{getNextParagraph:function(m){var k,s,a,c,h;if(!this._.lastNode){s=this.range.clone();s.enlarge(this.forceBrBreak||!this.enlargeBr?n.ENLARGE_LIST_ITEM_CONTENTS:n.ENLARGE_BLOCK_CONTENTS);
var d=new v(s),g=v.bookmark(true,true);d.evaluator=g;this._.nextNode=d.next();d=new v(s);d.evaluator=g;d=d.previous();this._.lastNode=d._4e_nextSourceNode(true);if(this._.lastNode&&this._.lastNode[0].nodeType==t.NODE_TEXT&&!A.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()){g=new B(s.document);g.moveToPosition(this._.lastNode,n.POSITION_AFTER_END);if(g.checkEndOfBlock()){g=new i(g.endContainer);this._.lastNode=(g.block||g.blockLimit)._4e_nextSourceNode(true)}}if(!this._.lastNode){this._.lastNode=
this._.docEndMarker=new e(s.document.createTextNode(""));j.insertAfter(this._.lastNode[0],d[0])}s=null}g=this._.nextNode;d=this._.lastNode;for(this._.nextNode=null;g;){var p=false,b=g[0].nodeType!=t.NODE_ELEMENT,f=false;if(b){if(g[0].nodeType==t.NODE_TEXT)if(l.test(g[0].nodeValue))b=false}else{var o=g._4e_name();if(g._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if(o=="br")b=true;else if(!s&&!g[0].childNodes.length&&o!="hr"){k=g;a=g._4e_equals(d);break}if(s){s.setEndAt(g,n.POSITION_BEFORE_START);
if(o!="br")this._.nextNode=g}p=true}else{if(g[0].firstChild){if(!s){s=new B(this.range.document);s.setStartAt(g,n.POSITION_BEFORE_START)}g=new e(g[0].firstChild);continue}b=true}}if(b&&!s){s=new B(this.range.document);s.setStartAt(g,n.POSITION_BEFORE_START)}a=(!p||b)&&g._4e_equals(d);if(s&&!p)for(;!g[0].nextSibling&&!a;){o=g.parent();if(o._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){p=true;a||o._4e_equals(d);break}g=o;b=true;a=g._4e_equals(d);f=true}b&&s.setEndAt(g,n.POSITION_AFTER_END);g=g._4e_nextSourceNode(f,
null,d);a=!g;if((p||a)&&s){b=s.getBoundaryNodes();p=new i(s.startContainer);if(b.startNode.parent()._4e_equals(p.blockLimit)&&w(b.startNode)&&w(b.endNode)){s=null;this._.nextNode=null}else break}if(a)break}if(!k){if(!s){this._.docEndMarker&&this._.docEndMarker._4e_remove();return this._.nextNode=null}p=new i(s.startContainer);g=p.blockLimit;b={div:1,th:1,td:1};k=p.block;if((!k||!k[0])&&!this.enforceRealBlocks&&b[g._4e_name()]&&s.checkStartOfBlock()&&s.checkEndOfBlock())k=g;else if(!k||this.enforceRealBlocks&&
k._4e_name()=="li"){k=new e(this.range.document.createElement(m||"p"));k[0].appendChild(s.extractContents());k._4e_trim();s.insertNode(k);c=h=true}else if(k._4e_name()!="li"){if(!s.checkStartOfBlock()||!s.checkEndOfBlock()){k=k._4e_clone(false);k[0].appendChild(s.extractContents());k._4e_trim();h=s.splitBlock();c=!h.wasStartOfBlock;h=!h.wasEndOfBlock;s.insertNode(k)}}else if(!a)this._.nextNode=k._4e_equals(d)?null:s.getBoundaryNodes().endNode._4e_nextSourceNode(true,null,d)}if(c){s=new e(k[0].previousSibling);
if(s[0]&&s[0].nodeType==t.NODE_ELEMENT)if(s._4e_name()=="br")s._4e_remove();else s[0].lastChild&&s[0].lastChild.nodeName.toLowerCase()=="br"&&j._4e_remove(s[0].lastChild)}if(h){s=v.bookmark(false,true);c=new e(k[0].lastChild);if(c[0]&&c[0].nodeType==t.NODE_ELEMENT&&c._4e_name()=="br")if(r.ie||c._4e_previous(s)||c._4e_next(s))c._4e_remove()}if(!this._.nextNode)this._.nextNode=a||k._4e_equals(d)?null:k._4e_nextSourceNode(true,null,d);return k}});B.prototype.createIterator=function(){return new q(this)}});
KISSY.Editor.add("selection",function(x){function q(d){this.document=d;this._={cache:{}};if(B.ie){var g=this.getNative().createRange();if(!g||g.item&&g.item(0).ownerDocument!=d||g.parentElement&&g.parentElement().ownerDocument!=d)this.isInvalid=true}}function A(d){d=new q(d);return!d||d.isInvalid?null:d}function r(d){var g=d.document,p=new e(g.body),b=new e(g.documentElement);if(B.ie){if(B.ie<8||document.documentMode==7)b.on("click",function(C){n._4e_name(C.target)==="html"&&d.getSelection().getRanges()[0].select()});
var f,o;p.on("focusin",function(C){if(C.target.nodeName.toUpperCase()=="BODY")if(f){try{f.select()}catch(I){}f=null}});p.on("focus",function(){o=true;u()});p.on("beforedeactivate",function(C){C.relatedTarget||(o=false)});B.ie<8&&t.on(n._4e_getWin(g),"blur",function(){g.selection.empty()});p.on("mousedown",z);p.on("mouseup",function(){o=true;setTimeout(function(){u(true)},0)});p.on("keydown",z);p.on("keyup",function(){o=true;u()});t.on(g,"selectionchange",u);var z=function(){o=false},u=function(C){if(o){var I=
d.document,y=d.getSelection(),D=y&&y.getNative();if(C&&D&&D.type=="None")if(!I.queryCommandEnabled("InsertImage")){setTimeout(function(){u(true)},50);return}var G;if(!(D&&D.type=="Text"&&(G=D.createRange().parentElement().nodeName.toLowerCase())&&G in{input:1,textarea:1})){f=D&&y.getRanges()[0];d._monitor()}}}}else{t.on(g,"mouseup",d._monitor,d);t.on(g,"keyup",d._monitor,d)}}x.SELECTION={};var v=KISSY,B=v.UA,n=v.DOM,t=v.Event,i=x.Utils.tryThese,e=v.Node,j=x.SELECTION,l=x.RANGE,w=x.NODE,m=x.Walker,
k=x.Range;j.SELECTION_NONE=1;j.SELECTION_TEXT=2;j.SELECTION_ELEMENT=3;var s={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};v.augment(q,{getNative:B.ie?function(){return this._.cache.nativeSel||(this._.cache.nativeSel=this.document.selection)}:function(){return this._.cache.nativeSel||(this._.cache.nativeSel=n._4e_getWin(this.document).getSelection())},getType:B.ie?function(){var d=this._.cache;if(d.type)return d.type;
var g=j.SELECTION_NONE;try{var p=this.getNative(),b=p.type;if(b=="Text")g=j.SELECTION_TEXT;if(b=="Control")g=j.SELECTION_ELEMENT;if(p.createRange().parentElement)g=j.SELECTION_TEXT}catch(f){}return d.type=g}:function(){var d=this._.cache;if(d.type)return d.type;var g=j.SELECTION_TEXT,p=this.getNative();if(p){if(p.rangeCount==1){p=p.getRangeAt(0);var b=p.startContainer;if(b==p.endContainer&&b.nodeType==w.NODE_ELEMENT&&p.endOffset-p.startOffset===1&&s[b.childNodes[p.startOffset].nodeName.toLowerCase()])g=
j.SELECTION_ELEMENT}}else g=j.SELECTION_NONE;return d.type=g},getRanges:B.ie?function(){var d=function(g,p){g=g.duplicate();g.collapse(p);p=g.parentElement();for(var b=p.childNodes,f,o=0;o<b.length;o++){var z=b[o];if(z.nodeType==w.NODE_ELEMENT){f=g.duplicate();f.moveToElementText(z);z=f.compareEndPoints("StartToStart",g);var u=f.compareEndPoints("EndToStart",g);f.collapse();if(z>0)break;else if(!z||u==1&&z==-1)return{container:p,offset:o};else if(!u)return{container:p,offset:o+1};f=null}}if(!f){f=
g.duplicate();f.moveToElementText(p);f.collapse(false)}f.setEndPoint("StartToStart",g);g=f.text.replace(/(\r\n|\r)/g,"\n").length;try{for(;g>0;)g-=b[--o].nodeValue.length}catch(C){g=0}return g===0?{container:p,offset:o}:{container:b[o],offset:-g}};return function(){var g=this._.cache;if(g.ranges)return g.ranges;var p=this.getNative(),b=p&&p.createRange(),f=this.getType();if(!p)return[];if(f==j.SELECTION_TEXT){p=new k(this.document);f=d(b,true);p.setStart(new e(f.container),f.offset);f=d(b);p.setEnd(new e(f.container),
f.offset);return g.ranges=[p]}else if(f==j.SELECTION_ELEMENT){g=this._.cache.ranges=[];for(f=0;f<b.length;f++){var o=b.item(f),z=o.parentNode,u=0;for(p=new k(this.document);u<z.childNodes.length&&z.childNodes[u]!=o;u++);p.setStart(new e(z),u);p.setEnd(new e(z),u+1);g.push(p)}return g}return g.ranges=[]}}():function(){var d=this._.cache;if(d.ranges)return d.ranges;var g=[],p=this.getNative();if(!p)return[];for(var b=0;b<p.rangeCount;b++){var f=p.getRangeAt(b),o=new k(this.document);o.setStart(new e(f.startContainer),
f.startOffset);o.setEnd(new e(f.endContainer),f.endOffset);g.push(o)}return d.ranges=g},getStartElement:function(){var d=this._.cache;if(d.startElement!==undefined)return d.startElement;var g,p=this.getNative();switch(this.getType()){case j.SELECTION_ELEMENT:return this.getSelectedElement();case j.SELECTION_TEXT:var b=this.getRanges()[0];if(b)if(!b.collapsed){for(b.optimize();;){g=b.startContainer;if(b.startOffset==(g[0].childNodes?g[0].childNodes.length:g[0].nodeValue.length)&&!g._4e_isBlockBoundary())b.setStartAfter(g);
else break}g=b.startContainer;if(g[0].nodeType!=w.NODE_ELEMENT)return g.parent();g=new e(g[0].childNodes[b.startOffset]);if(!g[0]||g[0].nodeType!=w.NODE_ELEMENT)return b.startContainer;for(b=g[0].firstChild;b&&b.nodeType==w.NODE_ELEMENT;){g=new e(b);b=b.firstChild}return g}if(B.ie){b=p.createRange();b.collapse(true);g=b.parentElement()}else if((g=p.anchorNode)&&g.nodeType!=w.NODE_ELEMENT)g=g.parentNode}return d.startElement=g?new e(g):null},getSelectedElement:function(){var d=this._.cache;if(d.selectedElement!==
undefined)return d.selectedElement;var g=this,p=i(function(){return g.getNative().createRange().item(0)},function(){for(var b=g.getRanges()[0],f,o,z=2;z&&!((f=b.getEnclosedNode())&&f[0].nodeType==w.NODE_ELEMENT&&s[f._4e_name()]&&(o=f));z--)b.shrink(l.SHRINK_ELEMENT);return o[0]});return d.selectedElement=p?new e(p):null},reset:function(){this._.cache={}},selectElement:function(d){var g;if(B.ie){this.getNative().empty();try{g=this.document.body.createControlRange();g.addElement(d[0]);g.select()}catch(p){g=
this.document.body.createTextRange();g.moveToElementText(d[0]);g.select()}finally{}}else{g=this.document.createRange();g.selectNode(d[0]);d=this.getNative();d.removeAllRanges();d.addRange(g)}this.reset()},selectRanges:function(d){if(B.ie)d[0]&&d[0].select();else{var g=this.getNative();if(!g)return;g.removeAllRanges();for(var p=0;p<d.length;p++){var b=d[p],f=this.document.createRange(),o=b.startContainer;b.collapsed&&B.gecko&&B.gecko<1.09&&o[0].nodeType==w.NODE_ELEMENT&&!o[0].childNodes.length&&o[0].appendChild(this.document.createTextNode(""));
f.setStart(o[0],b.startOffset);f.setEnd(b.endContainer[0],b.endOffset);g.addRange(f)}}this.reset()},createBookmarks2:function(d){for(var g=[],p=this.getRanges(),b=0;b<p.length;b++)g.push(p[b].createBookmark2(d));return g},createBookmarks:function(d){for(var g=[],p=this.getRanges(),b=p.length,f,o=0;o<b;o++){g.push(f=p[o].createBookmark(d,true));var z=(d=f.serializable)?v.one("#"+f.startNode):f.startNode;f=d?v.one("#"+f.endNode):f.endNode;for(var u=o+1;u<b;u++){var C=p[u],I=C.startContainer,y=C.endContainer;
n._4e_equals(I,z.parent())&&C.startOffset++;n._4e_equals(I,f.parent())&&C.startOffset++;n._4e_equals(y,z.parent())&&C.endOffset++;n._4e_equals(y,f.parent())&&C.endOffset++}}return g},selectBookmarks:function(d){for(var g=[],p=0;p<d.length;p++){var b=new k(this.document);b.moveToBookmark(d[p]);g.push(b)}this.selectRanges(g);return this},getCommonAncestor:function(){var d=this.getRanges();return d[0].startContainer._4e_commonAncestor(d[d.length-1].endContainer)},scrollIntoView:function(){this.getStartElement()._4e_scrollIntoView()}});
x.Selection=q;var a={table:1,tbody:1,tr:1},c=m.whitespaces(true),h=/\ufeff|\u00a0/;k.prototype.select=B.ie?function(d){var g=this.collapsed,p,b;if(this.startContainer[0].nodeType==w.NODE_ELEMENT&&this.startContainer._4e_name()in a||this.endContainer[0].nodeType==w.NODE_ELEMENT&&this.endContainer._4e_name()in a)this.shrink(w.NODE_ELEMENT,true);var f=this.createBookmark(),o=f.startNode,z;if(!g)z=f.endNode;f=this.document.body.createTextRange();f.moveToElementText(o[0]);f.moveStart("character",1);if(z){d=
this.document.body.createTextRange();d.moveToElementText(z[0]);f.setEndPoint("EndToEnd",d);f.moveEnd("character",-1)}else{for(p=o[0].nextSibling;p&&!c(p);)p=p.nextSibling;p=!(p&&p.nodeValue&&p.nodeValue.match(h))&&(d||!o[0].previousSibling||o[0].previousSibling&&n._4e_name(o[0].previousSibling)=="br");b=this.document.createElement("span");b.innerHTML="&#65279;";b=new e(b);n.insertBefore(b[0],o[0]);p&&n.insertBefore(this.document.createTextNode("\ufeff"),o[0])}this.setStartBefore(o);o._4e_remove();
if(g){if(p){f.moveStart("character",-1);f.select();this.document.selection.clear()}else f.select();if(b){this.moveToPosition(b,l.POSITION_BEFORE_START);b._4e_remove()}}else{this.setEndBefore(z);z._4e_remove();f.select()}}:function(){var d=this.startContainer;this.collapsed&&d[0].nodeType==w.NODE_ELEMENT&&!d[0].childNodes.length&&d[0].appendChild(this.document.createTextNode(""));var g=this.document.createRange();g.setStart(d[0],this.startOffset);try{g.setEnd(this.endContainer[0],this.endOffset)}catch(p){if(p.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=
0){this.collapse(true);g.setEnd(this.endContainer[0],this.endOffset)}else throw p;}d=A(this.document).getNative();d.removeAllRanges();d.addRange(g)};x.on("instanceCreated",function(d){r(d.editor)})});
KISSY.Editor.add("styles",function(x){function q(E,F){for(var H in E)E[H]=E[H].replace(aa,function(K,L){return F[L]})}function A(E,F){if(F){E=z.clone(E);q(E.attributes,F);q(E.styles,F)}F=this.element=(E.element||"*").toLowerCase();this.type=F=="#"||R[F]?C.STYLE_BLOCK:W[F]?C.STYLE_OBJECT:C.STYLE_INLINE;this._={definition:E}}function r(E,F){F=F?this.removeFromRange:this.applyToRange;E.body.focus();E=new y(E);for(var H=E.getRanges(),K=0;K<H.length;K++)F.call(this,H[K]);E.selectRanges(H)}function v(E,
F){var H=E.element;if(H=="*")H="span";F=new N(F.createElement(H));return B(F,E)}function B(E,F){var H=F._.definition;F=H.attributes;H=A.getStyleText(H);if(F)for(var K in F)E.attr(K,F[K]);if(H)E[0].style.cssText=H;return E}function n(E){var F=E.createBookmark(true),H=E.createIterator();H.enforceRealBlocks=true;H.enlargeBr=true;for(var K,L=E.document;K=H.getNextParagraph();){var O=v(this,L);j(K,O)}E.moveToBookmark(F)}function t(E,F,H){var K="",L="";E=E.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,
function(O,P,S){P&&(K=P);S&&(L=S);return""});return K+E.replace(F,H)+L}function i(E,F){var H=E.html();H=t(H,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,"");H=H.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1");H=H.replace(/([ \t\n\r]+|&nbsp;)/g," ");H=H.replace(/<br\b[^>]*>/gi,"\n");if(M.ie){E=E[0].ownerDocument.createElement("div");E.appendChild(F[0]);F[0].outerHTML="<pre>"+H+"</pre>";F=new N(E.firstChild);F._4e_remove()}else F.html(H);return F}function e(E){var F=[];t(E._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,
function(H,K,L){return K+"</pre>"+L+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(H,K){F.push(K)});return F}function j(E,F){var H=F._4e_name=="pre",K=E._4e_name=="pre",L=!H&&K;if(H&&!K)F=i(E,F);else if(L)F=w(e(E),F);else E._4e_moveChildren(F);E[0].parentNode.replaceChild(F[0],E[0]);H&&l(F)}function l(E){var F;if((F=E._4e_previousSourceNode(true,D.NODE_ELEMENT))&&F._4e_name()=="pre"){var H=t(F.html(),/\n$/,"")+"\n\n"+t(E.html(),/^\n/,"");if(M.ie)E[0].outerHTML="<pre>"+H+"</pre>";else E.html(H);
F._4e_remove()}}function w(E,F){for(var H=F[0].ownerDocument.createDocumentFragment(),K=0;K<E.length;K++){var L=E[K];L=L.replace(/(\r\n|\r)/g,"\n");L=t(L,/^[ \t]*\n/,"");L=t(L,/\n$/,"");L=t(L,/^[ \t]+|[ \t]+$/g,function(P,S){return P.length==1?"&nbsp;":S?" "+(new Array(P.length)).join("&nbsp;"):(new Array(P.length)).join("&nbsp;")+" "});L=L.replace(/\n/g,"<br>");L=L.replace(/[ \t]{2,}/g,function(P){return(new Array(P.length)).join("&nbsp;")+" "});var O=F._4e_clone();O.html(L);H.appendChild(O[0])}return H}
function m(E){var F=E.document;if(E.collapsed){F=v(this,F);E.insertNode(F);E.moveToPosition(F,I.POSITION_BEFORE_END)}else{var H=this.element,K=this._.definition,L,O=x.XHTML_DTD[H]||(L=true,x.XHTML_DTD.span),P=E.createBookmark();E.enlarge(I.ENLARGE_ELEMENT);E.trim();var S=E.createBookmark(),da=S.startNode;S=S.endNode;for(var U=da,X;U&&U[0];){var T=false;if(u._4e_equals(U,S)){U=null;T=true}else{var V=U[0].nodeType,ba=V==D.NODE_ELEMENT?U._4e_name():null;if(ba&&U.attr("_ke_bookmark")){U=U._4e_nextSourceNode(true);
continue}if(!ba||O[ba]&&(U._4e_position(S)|G.POSITION_PRECEDING|G.POSITION_IDENTICAL|G.POSITION_IS_CONTAINED)==G.POSITION_PRECEDING+G.POSITION_IDENTICAL+G.POSITION_IS_CONTAINED&&(!K.childRule||K.childRule(U))){var ca=U.parent();if(ca&&ca[0]&&((x.XHTML_DTD[ca._4e_name()]||x.XHTML_DTD.span)[H]||L)&&(!K.parentRule||K.parentRule(ca))){if(!X&&(!ba||!x.XHTML_DTD.$removeEmpty[ba]||(U._4e_position(S)|G.POSITION_PRECEDING|G.POSITION_IDENTICAL|G.POSITION_IS_CONTAINED)==G.POSITION_PRECEDING+G.POSITION_IDENTICAL+
G.POSITION_IS_CONTAINED)){X=new J(F);X.setStartBefore(U)}if(V==D.NODE_TEXT||V==D.NODE_ELEMENT&&!U[0].childNodes.length){V=U;for(var Y;!V[0].nextSibling&&(Y=V.parent(),O[Y._4e_name()])&&(Y._4e_position(da)|G.POSITION_FOLLOWING|G.POSITION_IDENTICAL|G.POSITION_IS_CONTAINED)==G.POSITION_FOLLOWING+G.POSITION_IDENTICAL+G.POSITION_IS_CONTAINED&&(!K.childRule||K.childRule(Y));)V=Y;X.setEndAfter(V);V[0].nextSibling||(T=true)}}else T=true}else T=true;U=U._4e_nextSourceNode()}if(T&&X&&!X.collapsed){T=v(this,
F);for(V=X.getCommonAncestor();T&&V&&T[0]&&V[0];){if(V._4e_name()==H){for(var Z in K.attributes)T.attr(Z)==V.attr(Z)&&T[0].removeAttribute(Z);for(var ea in K.styles)T._4e_style(ea)==V._4e_style(ea)&&T._4e_style(ea,"");if(!T._4e_hasAttributes()){T=null;break}}V=V.parent()}if(T){T[0].appendChild(X.extractContents());b(this,T);X.insertNode(T);T._4e_mergeSiblings();M.ie||T[0].normalize()}X=null}}da._4e_remove();S._4e_remove();E.moveToBookmark(P);E.shrink(I.SHRINK_TEXT)}}function k(E){E.enlarge(I.ENLARGE_ELEMENT);
var F=E.createBookmark(),H=F.startNode;if(E.collapsed){for(var K=new Q(H.parent()),L,O=0,P;O<K.elements.length&&(P=K.elements[O]);O++){if(P==K.block||P==K.blockLimit)break;if(this.checkElementRemovable(P)){var S=E.checkBoundaryOfElement(P,I.END),da=!S&&E.checkBoundaryOfElement(P,I.START);if(da||S){L=P;L.match=da?"start":"end"}else{P._4e_mergeSiblings();g(this,P)}}}if(L&&L[0]){P=H;for(O=0;;O++){S=K.elements[O];if(u._4e_equals(S,L))break;else if(S.match)continue;else S=S._4e_clone();S[0].appendChild(P[0]);
P=S}u[L.match=="start"?"insertBefore":"insertAfter"](P[0],L[0])}}else{var U=F.endNode,X=this;K=function(){for(var T=new Q(H.parent()),V=new Q(U.parent()),ba=null,ca=null,Y=0;Y<T.elements.length;Y++){var Z=T.elements[Y];if(Z==T.block||Z==T.blockLimit)break;if(X.checkElementRemovable(Z))ba=Z}for(Y=0;Y<V.elements.length;Y++){Z=V.elements[Y];if(Z==V.block||Z==V.blockLimit)break;if(X.checkElementRemovable(Z))ca=Z}ca&&U._4e_breakParent(ca);ba&&H._4e_breakParent(ba)};K();for(L=new N(H[0].nextSibling);L[0]!==
U[0];){O=L._4e_nextSourceNode();if(L[0].nodeType==D.NODE_ELEMENT&&this.checkElementRemovable(L)){L._4e_name()==this.element?g(this,L):f(L,d(this)[L._4e_name()]);if(O[0].nodeType==D.NODE_ELEMENT&&O._4e_contains(H)){K();O=new N(H[0].nextSibling)}}L=O}}E.moveToBookmark(F)}function s(E){var F={};E.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(H,K,L){F[K]=L});return F}function a(E,F){typeof E=="string"&&(E=s(E));typeof F=="string"&&(F=s(F));for(var H in E)if(!(H in F&&
(F[H]==E[H]||E[H]=="inherit"||F[H]=="inherit")))return false;return true}function c(E,F){if(F!==false){F=document.createElement("span");F.style.cssText=E;E=F.style.cssText||""}else E=E;return E.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function h(E){var F=E._AC;if(F)return F;F={};var H=0,K=E.attributes;if(K)for(var L in K){H++;F[L]=K[L]}if(K=A.getStyleText(E)){F.style||H++;F.style=K}F._length=H;return E._AC=F}function d(E){if(E._.overrides)return E._.overrides;
var F=E._.overrides={},H=E._.definition.overrides;if(H){z.isArray(H)||(H=[H]);for(var K=0;K<H.length;K++){var L=H[K],O,P;if(typeof L=="string")O=L.toLowerCase();else{O=L.element?L.element.toLowerCase():E.element;P=L.attributes}L=F[O]||(F[O]={});if(P){L=L.attributes=L.attributes||[];for(var S in P)L.push([S.toLowerCase(),P[S]])}}}return F}function g(E,F){var H=E._.definition,K=z.mix(z.mix({},H.attributes),d(E)[F._4e_name()]);H=H.styles;var L=z.isEmptyObject(K)&&z.isEmptyObject(H);for(var O in K)if(!((O==
"class"||E._.definition.fullMatch)&&F.attr(O)!=p(O,K[O]))){L=L||!!F._4e_hasAttribute(O);F.removeAttr(O)}for(var P in H)if(!(E._.definition.fullMatch&&F._4e_style(P)!=p(P,H[P],true))){L=L||!!F._4e_style(P);F._4e_style(P,"")}L&&o(F)}function p(E,F,H){var K=new N("<span></span>");K[H?"_4e_style":"attr"](E,F);return K[H?"_4e_style":"attr"](E)}function b(E,F){for(var H=d(E),K=F.all(E.element),L=K.length;--L>=0;)g(E,new N(K[L]));for(var O in H)if(O!=E.element){K=F.all(O);for(L=K.length-1;L>=0;L--){var P=
new N(K[L]);f(P,H[O])}}}function f(E,F){if(F=F&&F.attributes)for(var H=0;H<F.length;H++){var K=F[H][0],L;if(L=E.attr(K)){var O=F[H][1];if(O===null||O.test&&O.test(L)||typeof O=="string"&&L==O)E[0].removeAttribute(K)}}o(E)}function o(E){if(!E._4e_hasAttributes()){var F=E[0].firstChild,H=E[0].lastChild;E._4e_remove(true);if(F){F.nodeType==D.NODE_ELEMENT&&u._4e_mergeSiblings(F);H&&!F===H&&H.nodeType==D.NODE_ELEMENT&&u._4e_mergeSiblings(H)}}}var z=KISSY,u=z.DOM,C=x.STYLE={},I=x.RANGE,y=x.Selection,D=
x.NODE,G=x.POSITION,J=x.Range,N=z.Node,M=z.UA,Q=x.ElementPath,R={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},W={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},$=/\s*(?:;\s*|$)/,aa=/#\((.+?)\)/g;C.STYLE_BLOCK=1;C.STYLE_INLINE=2;C.STYLE_OBJECT=3;A.prototype={apply:function(E){r.call(this,E,false)},remove:function(E){r.call(this,E,true)},applyToRange:function(E){return(this.applyToRange=this.type==C.STYLE_INLINE?m:this.type==C.STYLE_BLOCK?n:this.type==
C.STYLE_OBJECT?null:null).call(this,E)},removeFromRange:function(E){return(this.removeFromRange=this.type==C.STYLE_INLINE?k:null).call(this,E)},applyToObject:function(E){B(E,this)},checkElementRemovable:function(E,F){if(!E)return false;var H=this._.definition;if(E._4e_name()==this.element){if(!F&&!E._4e_hasAttributes())return true;H=h(H);if(H._length){for(var K in H)if(K!="_length"){var L=E.attr(K)||"";if(K=="style"?a(H[K],c(L,false)):H[K]==L){if(!F)return true}else if(F)return false}if(F)return true}else return true}if(H=
d(this)[E._4e_name()]){if(!(H=H.attributes))return true;for(F=0;F<H.length;F++){K=H[F][0];if(K=E.attr(K)){L=H[F][1];if(L===null||typeof L=="string"&&K==L||L.test(K))return true}}}return false},checkActive:function(E){switch(this.type){case C.STYLE_BLOCK:return this.checkElementRemovable(E.block||E.blockLimit,true);case C.STYLE_OBJECT:case C.STYLE_INLINE:for(var F=E.elements,H=0,K;H<F.length;H++){K=F[H];if(!(this.type==C.STYLE_INLINE&&(u._4e_equals(K,E.block)||u._4e_equals(K,E.blockLimit))))if(!(this.type==
C.STYLE_OBJECT&&!(K._4e_name()in W)))if(this.checkElementRemovable(K,true))return true}}return false}};A.getStyleText=function(E){var F=E._ST;if(F)return F;F=E.styles;var H=E.attributes&&E.attributes.style||"",K="";if(H.length)H=H.replace($,";");for(var L in F){var O=F[L],P=(L+":"+O).replace($,";");if(O=="inherit")K+=P;else H+=P}if(H.length)H=c(H);H+=K;return E._ST=H};x.Style=A});
KISSY.Editor.add("button",function(){function x(v){x.superclass.constructor.call(this,v);this._init()}var q=KISSY.Editor,A=KISSY,r=A.Node;x.ON="on";x.OFF="off";x.DISABLED="disabled";x.ON_CLASS="ke-triplebutton-on";x.OFF_CLASS="ke-triplebutton-off";x.DISABLED_CLASS="ke-triplebutton-disabled";x.ATTRS={state:{value:"off"},container:{},text:{},contentCls:{},cls:{}};A.extend(x,A.Base,{_init:function(){var v=this.get("container")[0]||this.get("container");this.el=new r("<a class='ke-triplebutton ke-triplebutton-off' href='#' role=\"button\"></a>");
this.el._4e_unselectable();this._attachCls();if(this.get("text"))this.el.html(this.get("text"));else if(this.get("contentCls")){this.el.html("<span class='ke-toolbar-item "+this.get("contentCls")+"'></span>");this.el.one("span")._4e_unselectable()}this.get("title")&&this.el.attr("title",this.get("title"));v.appendChild(this.el[0]);this.el.on("click",this._action,this);this.on("afterStateChange",this._stateChange,this)},_attachCls:function(){var v=this.get("cls");v&&this.el.addClass(v)},_stateChange:function(v){this["_"+
v.newVal]();this._attachCls()},_action:function(v){this.fire(this.get("state")+"Click",v);this.fire("click",v);v.preventDefault()},_on:function(){this.el[0].className="ke-triplebutton ke-triplebutton-on"},_off:function(){this.el[0].className="ke-triplebutton ke-triplebutton-off"},_disabled:function(){this.el[0].className="ke-triplebutton ke-triplebutton-disabled"}});q.TripleButton=x});
KISSY.Editor.add("contextmenu",function(){function x(e){this.cfg=r.clone(e);A.Utils.lazyRun(this,"_prepareShow","_realShow")}function q(e,j){for(var l=0;l<j.length;l++)if(B.test(e,j[l]))return true;return false}var A=KISSY.Editor,r=KISSY,v=r.Node,B=r.DOM,n=r.Event,t=[];x.register=function(e,j){var l=new x(j);t.push({doc:e,rules:j.rules,instance:l});if(!e.ke_contextmenu){e.ke_contextmenu=1;n.on(e,"mousedown",x.hide);n.on(e,"contextmenu",function(w){x.hide.call(this);for(var m=new v(w.target);m;){var k=
false;if(m._4e_name()=="body")break;for(var s=0;s<t.length;s++){var a=t[s].instance,c=t[s].rules;if(e===t[s].doc&&q(m[0],c)){w.preventDefault();k=true;a.show(A.Utils.getXY(w.pageX,w.pageY,e,document));break}}if(k)break;m=m.parent()}})}return l};x.hide=function(){for(var e=0;e<t.length;e++){var j=t[e].instance;this===t[e].doc&&j.hide()}};var i=A.SimpleOverlay;r.augment(x,{_init:function(){var e=this,j=e.cfg,l=j.funcs;e.elDom=new v("<div class='ke-contextmenu'></div>");var w=e.elDom;w.css("width",j.width);
document.body.appendChild(w[0]);e.el=new i({el:w});for(var m in l){j=new v("<a href='#'>"+m+"</a>");w[0].appendChild(j[0]);(function(k,s){k.on("click",function(a){s();e.hide();a.halt()})})(j,l[m])}},hide:function(){this.el&&this.el.hide()},_realShow:function(e){this.el.show(e)},_prepareShow:function(){this._init()},show:function(e){this._prepareShow(e)}});A.ContextMenu=x});
KISSY.Editor.add("overlay",function(){function x(){var e=this;x.superclass.constructor.apply(e,arguments);e._init();if(A.UA.ie===6){e.on("show",function(){var j=e.get("el"),l=parseInt(j.css("width"));j=j[0].offsetHeight;i&&i.css({width:l+"px",height:j+"px"});i&&i.offset(e.get("el").offset())});e.on("hide",function(){i&&i.offset({left:-999,top:-999})})}if(e.get("mask")){e.on("show",function(){n&&n.css({left:"0px",top:"0px"});t&&t.css({left:"0px",top:"0px"})});e.on("hide",function(){n&&n.css({left:"-9999px",
top:"-9999px"});t&&t.css({left:"-9999px",top:"-9999px"})})}e.hide()}var q=KISSY.Editor,A=KISSY,r=q.focusManager,v=A.Node,B=A.DOM,n,t,i;x.init=function(){var e=document.body;n=new v('<div class="ke-mask">&nbsp;</div>');n.css({left:"-9999px",top:"-9999px"});n.css({width:"100%",height:B.docHeight()+"px",opacity:0.4});n.appendTo(e);if(A.UA.ie==6){i=new v("<iframe class='ke-dialog-iframe'></iframe>");e.appendChild(i[0]);t=new v("<iframe class='ke-mask'></iframe>");t.css({left:"-9999px",top:"-9999px"});
t.css({width:"100%",height:B.docHeight()+"px",opacity:0.4});t.appendTo(e)}x.init=null};x.ATTRS={title:{value:""},width:{value:"450px"},visible:{value:true},focusMgr:{value:true},mask:{value:false}};A.extend(x,A.Base,{_init:function(){var e=this,j=e.get("el");e.on("afterVisibleChange",function(l){if(l=l.newVal){typeof l=="boolean"?e.center():j.offset(l);e.fire("show")}else{j.css({left:"-9999px",top:"-9999px"});e.fire("hide")}});e.get("focusMgr")&&e.on("beforeVisibleChange",e._editorFocusMg,e);if(j){j[0].appendChild((new v("<a href='#' class='ke-focus' style='width:0;height:0;outline:none;font-size:0;'></a>"))[0]);
e.el=j}else{j=new v("<div class='ke-dialog' style='width:"+e.get("width")+"'><div class='ke-hd'><span class='ke-hd-title'>"+e.get("title")+"</span><span class='ke-hd-x'><a class='ke-close' href='#'>X</a></span></div><div class='ke-bd'></div><div class='ke-ft'></div><a href='#' class='ke-focus'></a></div>");document.body.appendChild(j[0]);e.set("el",j);e.el=j;e.body=j.one(".ke-bd");e.foot=j.one(".ke-ft");e._close=j.one(".ke-close");e._title=j.one(".ke-hd-title").one("h1");e._close.on("click",function(l){l.preventDefault();
e.hide()})}},center:function(){var e=this.get("el"),j=parseInt(e.css("width")),l=e[0].offsetHeight,w=B.viewportWidth(),m=B.viewportHeight();j=(w-j)/2+B.scrollLeft();l=(m-l)/2+B.scrollTop();if(l-B.scrollTop()>200)l-=150;e.css({left:j+"px",top:l+"px"})},_prepareShow:function(){x.init()},_getFocusEl:function(){if(this._focusEl)return this._focusEl;return this._focusEl=this.el.one(".ke-focus")[0]},_editorFocusMg:function(e){if(e.newVal){this._focusEditor=r.currentInstance();this._getFocusEl().focus()}else this._focusEditor&&
this._focusEditor.focus()},_realShow:function(e){this.get("el");this.set("visible",e||true)},show:function(e){this._prepareShow(e)},hide:function(){this.get("el");this.set("visible",false)}});q.Utils.lazyRun(x.prototype,"_prepareShow","_realShow");q.SimpleOverlay=x});
KISSY.Editor.add("clipboard",function(x){var q=KISSY.Editor,A=KISSY,r=A.Node,v=A.UA,B=q.Range,n=q.RANGE,t=A.Event;q.Paste||function(){function i(e){this.editor=e;this._init()}A.augment(i,{_init:function(){var e=this.editor;v.ie?t.on(e.document,"keydown",this._paste,this):t.on(e.document,"paste",this._paste,this)},_paste:function(e){if(!(e.type==="keydown"&&!(e.keyCode===86&&(e.ctrlKey||e.metaKey)))){var j=this.editor;e=j.document;var l=j.getSelection(),w=new B(e),m=new r(v.webkit?"<body></body>":
"<div></div>",null,e);v.webkit&&m[0].appendChild(e.createTextNode("\u00a0"));e.body.appendChild(m[0]);m.css({position:"absolute",top:l.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});m.css("left","-1000px");var k=l.createBookmarks();w.setStartAt(m,n.POSITION_AFTER_START);w.setEndAt(m,n.POSITION_BEFORE_END);w.select(true);setTimeout(function(){m._4e_remove();var s;m=v.webkit&&(s=m._4e_first())&&s[0]&&s.hasClass("Apple-style-span")?s:m;l.selectBookmarks(k);j.insertHtml(m.html())},
0)}}});q.Paste=i}();x.addPlugin(function(){new q.Paste(x)})});
KISSY.Editor.add("color",function(x){function q(g){return("0"+g).slice(g.length-1,g.length+1)}function A(g){g=v.trim(g);if(g.charAt(0)=="#")g=g.substring(1);g=g.replace(/\s+/g,"");var p="";if(/^[0-9a-f]{3,3}$/i.test(g))p=g.replace(/[0-9a-f]/ig,function(f){return f+f});else{var b=g.match(j);if(b&&b[0])for(g=1;g<4;g++)p+=q(parseInt(b[g]).toString(16));else p=g}return"#"+p.toLowerCase()}for(var r=KISSY.Editor,v=KISSY,B=v.Node,n=v.Event,t=r.SimpleOverlay,i=r.Style,e=v.DOM,j=/^rgb\((\d+),(\d+),(\d+)\)$/i,
l="000,800000,8B4513,2F4F4F,008080,000080,4B0082,696969,B22222,A52A2A,DAA520,006400,40E0D0,0000CD,800080,808080,F00,FF8C00,FFD700,008000,0FF,00F,EE82EE,A9A9A9,FFA07A,FFA500,FFFF00,00FF00,AFEEEE,ADD8E6,DDA0DD,D3D3D3,FFF0F5,FAEBD7,FFFFE0,F0FFF0,F0FFFF,F0F8FF,E6E6FA,FFF".split(/,/),w={element:"span",styles:{color:"#(color)"},overrides:[{element:"font",attributes:{color:null}}]},m={element:"span",styles:{"background-color":"#(color)"}},k="<div class='ke-popup-wrap ke-color-wrap'><a class='ke-color-remove' href=\"javascript:void('\u6e05\u9664');\"><span>\u6e05\u9664</span></a><table>",
s={},a={},c=0;c<5;c++){k+="<tr>";for(var h=0;h<8;h++){var d=A(l[8*c+h]);k+="<td>";k+="<a href='javascript:void(0);' class='ke-color-a'><span style='background-color:"+d+"'></span></a>";k+="</td>";s[d]=new i(m,{color:d});a[d]=new i(w,{color:d})}k+="</tr>"}s.inherit=new i(m,{color:"inherit"});a.inherit=new i(w,{color:"inherit"});k+="</table></div>";r.ColorSupport||function(){function g(b){g.superclass.constructor.call(this,b);this._init()}var p=r.TripleButton;g.ATTRS={editor:{},styles:{},contentCls:{},
text:{}};v.extend(g,v.Base,{_init:function(){var b=this.get("editor").toolBarDiv;b=new p({container:b,title:this.get("title"),contentCls:this.get("contentCls")});b.on("offClick",this._showColors,this);this.el=b;r.Utils.lazyRun(this,"_prepare","_real")},_hidePanel:function(b){var f=this;e._4e_ascendant(b.target,function(o){return o[0]===f.el.el[0]},true)||this.colorWin.hide()},_selectColor:function(b){b.halt();var f=this.get("editor");b=b.target;if(e._4e_name(b)=="span"||e._4e_name(b)=="a"){b=new B(b);
if(b._4e_name()=="a")b=b.one("span");var o=this.get("styles");f.fire("save");b._4e_style("background-color")?o[A(b._4e_style("background-color"))].apply(f.document):o.inherit.remove(f.document);f.fire("save");f.focus();this.colorWin.hide()}},_prepare:function(){this.colorPanel=new B(k);this.colorWin=new t({el:this.colorPanel,mask:false,focusMgr:false});document.body.appendChild(this.colorPanel[0]);this.colorPanel.on("click",this._selectColor,this);n.on(document,"click",this._hidePanel,this);n.on(x.document,
"click",this._hidePanel,this)},_real:function(){var b=this.el.el.offset();b.top+=this.el.el.height()+5;if(b.left+this.colorPanel.width()>e.viewportWidth()-60)b.left=e.viewportWidth()-this.colorPanel.width()-60;this.colorWin.show(b)},_showColors:function(b){this._prepare(b)}});r.ColorSupport=g}();x.addPlugin(function(){new r.ColorSupport({editor:x,styles:s,title:"\u80cc\u666f\u989c\u8272",contentCls:"ke-toolbar-bgcolor",text:"bgcolor"});new r.ColorSupport({editor:x,styles:a,title:"\u6587\u672c\u989c\u8272",
contentCls:"ke-toolbar-color",text:"color"})})});
KISSY.Editor.add("elementpaths",function(x){var q=KISSY.Editor,A=KISSY,r=A.Node,v=A.DOM;q.ElementPaths||function(){function B(n){this.cfg=n;this._cache=[];this._init()}A.augment(B,{_init:function(){var n=this.cfg.editor;this.holder=new r("<div>");this.holder.appendTo(n.statusDiv);n.on("selectionChange",this._selectionChange,this)},_selectionChange:function(n){var t=this.cfg.editor,i=this.holder;i=i[0]||i;n=n.path.elements;var e,j;e=this._cache;for(j=0;j<e.length;j++){e[j].detach("click");e[j]._4e_remove()}this._cache=
[];for(j=0;j<n.length;j++){e=n[j];var l=new r("<a href='#' class='elementpath'>"+(e.attr("_ke_real_element_type")||e._4e_name())+"</a>");this._cache.push(l);(function(w){l.on("click",function(m){m.halt();t.focus();setTimeout(function(){t.getSelection().selectElement(w)},50)})})(e);i.firstChild?v.insertBefore(l[0],i.firstChild):i.appendChild(l[0])}}});q.ElementPaths=B}();x.addPlugin(function(){new q.ElementPaths({editor:x})})});
KISSY.Editor.add("enterkey",function(x){var q=KISSY.Editor,A=KISSY,r=A.UA,v=/^h[1-6]$/,B=q.XHTML_DTD,n=A.Node,t=A.Event,i=q.Walker,e=q.ElementPath;q.enterBlock||function(){function j(m){m=m.getSelection().getRanges();for(var k=m.length-1;k>0;k--)m[k].deleteContents();return m[0]}function l(m){var k=j(m),s=k.document;if(k.checkStartOfBlock()&&k.checkEndOfBlock()){var a=(new e(k.startContainer)).block;if(a&&(a._4e_name()=="li"||a.parent()._4e_name()=="li")){m.execCommand("outdent");return}}var c=k.splitBlock("p");
if(c){m=c.previousBlock;a=c.nextBlock;var h=c.wasStartOfBlock,d=c.wasEndOfBlock,g;if(a){g=a.parent();if(g._4e_name()=="li"){a._4e_breakParent(g);a._4e_move(a._4e_next(),true)}}else if(m&&(g=m.parent())&&g._4e_name()=="li"){m._4e_breakParent(g);k.moveToElementEditablePosition(m._4e_next());m._4e_move(m._4e_previous())}if(!h&&!d){if(a._4e_name()=="li"&&(g=a._4e_first(i.invisible(true)))&&A.inArray(g._4e_name(),["ul","ol"]))(r.ie?new n(s.createTextNode("\u00a0")):new n(s.createElement("br"))).insertBefore(g);
a&&k.moveToElementEditablePosition(a)}else{var p;if(m){if(m._4e_name()=="li"||!v.test(m._4e_name()))p=m._4e_clone()}else if(a)p=a._4e_clone();p||(p=new n("p",null,s));if(g=c.elementPath){c=0;for(var b=g.elements.length;c<b;c++){var f=g.elements[c];if(f._4e_equals(g.block)||f._4e_equals(g.blockLimit))break;if(B.$removeEmpty[f._4e_name()]){f=f._4e_clone();p._4e_moveChildren(f);p.append(f)}}}r.ie||p._4e_appendBogus();k.insertNode(p);if(r.ie&&h&&(!d||!m[0].childNodes.length)){k.moveToElementEditablePosition(d?
m:p);k.select()}k.moveToElementEditablePosition(h&&!d?a:p)}if(!r.ie)if(a){s=new n(s.createElement("span"));s.html("&nbsp;");k.insertNode(s);s._4e_scrollIntoView();k.deleteContents()}else p._4e_scrollIntoView();k.select()}}function w(m){t.on(m.document,"keydown",function(k){if(k.keyCode===13)if(!k.shiftKey){m.execCommand("enterBlock");k.preventDefault()}})}w.enterBlock=l;q.EnterKey=w}();x.addPlugin(function(){x.addCommand("enterBlock",{exec:q.EnterKey.enterBlock});q.EnterKey(x)})});
KISSY.Editor.add("fakeobjects",function(){var x=KISSY.Editor,q=KISSY,A=q.Node,r=x.NODE,v=x.HtmlParser,B=q.Editor,n=x.HtmlDataProcessor,t=n&&n.htmlFilter;x.FakeObjects||function(){var i={elements:{$:function(e){var j=e.attributes;if((j=(j=(j=j&&j._ke_realelement)&&new v.Fragment.FromHtml(decodeURIComponent(j)))&&j.children[0])&&e.attributes._ke_resizable){var l=e.attributes.style;if(l){var w=/(?:^|\s)width\s*:\s*(\d+)/i.exec(l);e=w&&w[1];l=(w=/(?:^|\s)height\s*:\s*(\d+)/i.exec(l))&&w[1];if(e)j.attributes.width=
e;if(l)j.attributes.height=l}}return j}}};t&&t.addRules(i);n&&q.mix(n,{createFakeParserElement:function(e,j,l,w){var m;m=new v.BasicWriter;e.writeHtml(m);m=m.getHtml();var k=e.attributes.style;if(e.attributes.width)k="width:"+e.attributes.width+"px;"+k;if(e.attributes.height)k="height:"+e.attributes.height+"px;"+k;e={"class":j,src:x.Config.base+"assets/spacer.gif",_ke_realelement:encodeURIComponent(m),_ke_real_node_type:e.type,style:k,align:e.attributes.align||""};if(l)e._ke_real_element_type=l;if(w)e._ke_resizable=
w;return new v.Element("img",e)}});x.FakeObjects=1}();q.augment(B,{createFakeElement:function(i,e,j,l,w){var m=i.attr("style")||"";if(i.attr("width"))m="width:"+i.attr("width")+"px;"+m;if(i.attr("height"))m="height:"+i.attr("height")+"px;"+m;i={"class":e,src:x.Config.base+"assets/spacer.gif",_ke_realelement:encodeURIComponent(w||i._4e_outerHtml()),_ke_real_node_type:i[0].nodeType,align:i.attr("align")||"",style:m};if(j)i._ke_real_element_type=j;if(l)i._ke_resizable=l;return new A("<img/>",i,this.document)},
restoreRealElement:function(i){if(i.attr("_ke_real_node_type")!=r.NODE_ELEMENT)return null;i=decodeURIComponent(i.attr("_ke_realelement"));var e=new A("<div>",null,this.document);e.html(i);return e._4e_first(function(j){return j[0].nodeType==r.NODE_ELEMENT})._4e_remove()}})});
KISSY.Editor.add("flash",function(x){var q=KISSY.Editor,A=KISSY,r=A.DOM,v=A.Event,B=q.ContextMenu,n=A.Node,t=q.NODE,i=q.TripleButton,e=q.SimpleOverlay,j=/\.swf(?:$|\?)/i,l=q.HtmlDataProcessor,w="niftyplayer.swf",m=l&&l.dataFilter,k=["img.ke_flash"];q.Flash||function(){function a(d){d=d.attributes;return d.type=="application/x-shockwave-flash"||j.test(d.src||"")}function c(d){return d.indexOf(w)!=-1}function h(d){this.editor=d;d._toolbars=d._toolbars||{};d._toolbars.flash=this;this._init()}m&&m.addRules({elements:{object:function(d){var g=
d.attributes,p="ke_flash",b="flash";if(!(g.classid&&String(g.classid).toLowerCase())){for(g=0;g<d.children.length;g++)if(d.children[g].name=="embed"){if(!a(d.children[g]))return null;if(c(d.children[g].attributes.src)){p="ke_music";b="music"}return l.createFakeParserElement(d,p,b,true)}return null}for(g=0;g<d.children.length;g++){var f=d.children[g];if(f.name=="param"&&f.attributes.name=="movie")if(c(f.attributes.value)){p="ke_music";b="music";break}}return l.createFakeParserElement(d,p,b,true)},
embed:function(d){if(!a(d))return null;var g="ke_flash",p="flash";if(c(d.attributes.src)){g="ke_music";p="music"}return l.createFakeParserElement(d,g,p,true)}}},5);A.augment(h,{_init:function(){var d=this.editor,g={};this.el=new i({container:d.toolBarDiv,contentCls:"ke-toolbar-flash",title:"Flash"});this.el.on("click",this._showConfig,this);v.on(d.document,"dblclick",this._dbclick,this);for(var p in s)(function(b){g[b]=function(){d.fire("save");d.focus();s[b](d);d.fire("save")}})(p);B.register(d.document,
{rules:k,width:"120px",funcs:g});q.Utils.lazyRun(this,"_prepareShow","_realShow")},_dbclick:function(d){var g=new n(d.target);if(g._4e_name()==="img"&&g.hasClass("ke_flash")){this.selectedFlash=g;this._showConfig();d.halt()}},_prepareShow:function(){var d=this;d.d=new e({title:"\u7f16\u8f91flash",width:"350px",mask:true});d.d.on("hide",function(){d.selectedFlash=null;x.focus()});d.d.body.html("<div><p><label>\u5730\u5740\uff1a<input class='ke-flash-url' style='width:280px' /></label></p><p style='margin:5px 0'><label>\u5bbd\u5ea6\uff1a<input class='ke-flash-width' style='width:110px' /></label>&nbsp;&nbsp;<label>\u9ad8\u5ea6\uff1a<input class='ke-flash-height' style='width:110px' /></label></p>");
d.d.foot.html("<button class='ke-flash-ok'>\u786e\u5b9a</button> <button class='ke-flash-cancel'>\u53d6\u6d88</button></div>");d._initD()},_realShow:function(){this.d.show()},_showConfig:function(){var d=this.editor,g=this.selectedFlash;this._prepareShow();if(g){d=d.restoreRealElement(g);d.attr("width")&&this.dWidth.val(parseInt(d.attr("width")));d.attr("height")&&this.dHeight.val(parseInt(d.attr("height")));if(d._4e_name()=="object"){d=d[0].childNodes;for(g=0;g<d.length;g++)if(d[g].nodeType==t.NODE_ELEMENT)if((r.attr(d[g],
"name")||"").toLowerCase()=="movie")this.dUrl.val(r.attr(d[g],"value"));else if(r._4e_name(d[g])=="embed")this.dUrl.val(r.attr(d[g],"src"));else r._4e_name(d[g])=="object"&&this.dUrl.val(r.attr(d[g],"data"))}else d._4e_name()=="embed"&&this.dUrl.val(d.attr("src"))}},_initD:function(){var d=this,g=d.d;d.dHeight=g.el.one(".ke-flash-height");d.dWidth=g.el.one(".ke-flash-width");d.dUrl=g.el.one(".ke-flash-url");var p=g.el.one(".ke-flash-ok");g=g.el.one(".ke-flash-cancel");p.on("click",d._gen,d);g.on("click",
function(){d.d.hide()})},_gen:function(){var d=this.editor,g=this.dUrl.val();if(g){g="<object "+(parseInt(this.dWidth.val())?" width='"+parseInt(this.dWidth.val())+"' ":" ")+(parseInt(this.dHeight.val())?" height='"+parseInt(this.dHeight.val())+"' ":" ")+' classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"  codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,0,0"><param name="quality" value="high" /><param name="movie" value="'+g+'" /><embed '+(parseInt(this.dWidth.val())?
" width='"+parseInt(this.dWidth.val())+"' ":" ")+(parseInt(this.dHeight.val())?" height='"+parseInt(this.dHeight.val())+"' ":" ")+'pluginspage="http://www.macromedia.com/go/getflashplayer" quality="high"  src="'+g+'"  type="application/x-shockwave-flash"/></object>';var p=new n(g,null,d.document);g=d.createFakeElement?d.createFakeElement(p,"ke_flash","flash",true,g):p;d.insertElement(g);this.d.hide()}}});q.Flash=h}();var s={"\u7f16\u8f91Flash":function(a){var c=a.getSelection();if(c=(c=c&&c.getStartElement())&&
c._4e_ascendant("img",true))if(c.hasClass("ke_flash")){a=a._toolbars.flash;a.selectedFlash=c;a._showConfig()}}};x.addPlugin(function(){new q.Flash(x)})});
KISSY.Editor.add("font",function(x){var q=KISSY.Editor,A=KISSY,r=q.Style,v=q.TripleButton,B=A.Node,n=["8px","10px","12px","14px","18px","24px","36px","48px","60px","72px","84px","96px","108px"],t={},i="<select title='\u5927\u5c0f' style='width:110px;height:21px;'><option value=''>\u5927\u5c0f / \u6e05\u9664</option>",e={element:"span",styles:{"font-size":"#(size)"},overrides:[{element:"font",attributes:{size:null}}]},j=["\u5b8b\u4f53","\u9ed1\u4f53","\u96b6\u4e66","\u6977\u4f53_GB2312","\u5fae\u8f6f\u96c5\u9ed1",
"Georgia","Times New Roman","Impact","Courier New","Arial","Verdana","Tahoma"],l={},w="<select title='\u5b57\u4f53' ><option value=''>\u5b57\u4f53 / \u6e05\u9664</option>",m={element:"span",styles:{"font-family":"#(family)"},overrides:[{element:"font",attributes:{face:null}}]},k;for(k=0;k<n.length;k++){var s=n[k];t[s]=new r(e,{size:s});i+="<option value='"+s+"'>"+s+"</option>"}i+="</select>";for(k=0;k<j.length;k++){n=j[k];l[n]=new r(m,{family:n});w+="<option style='font-family:"+n+"'  value='"+n+
"'>"+n+"</option>"}w+="</select>";q.Font||function(){function a(h){a.superclass.constructor.call(this,h);this._init()}function c(h){c.superclass.constructor.call(this,h);this._init()}a.ATTRS={v:{value:""},html:{},styles:{},editor:{}};A.extend(a,A.Base,{_init:function(){var h=this.get("editor"),d=h.toolBarDiv,g=this.get("html");this.el=new B(g);d[0].appendChild(this.el[0]);this.el.on("change",this._change,this);h.on("selectionChange",this._selectionChange,this);this.on("afterVChange",this._vChange,
this)},_vChange:function(h){var d=this.get("editor"),g=h.newVal;h=h.preVal;var p=this.get("styles");d.focus();d.fire("save");if(g)p[g].apply(d.document);else{g=h;p[g].remove(d.document)}d.fire("save")},_change:function(){this.set("v",this.el.val())},_selectionChange:function(h){this.get("editor");var d=this.get("v");h=h.path.elements;for(var g=this.get("styles"),p=0,b;p<h.length;p++){b=h[p];for(var f in g)if(g[f].checkElementRemovable(b,true)){if(f!=d){this._set("v",f);this.el.val(f)}return}}if(d!=
""){this._set("v","");this.el.val("")}}});c.ATTRS={editor:{},text:{},contentCls:{},title:{},style:{}};A.extend(c,A.Base,{_init:function(){var h=this.get("editor"),d=this.get("text");this.get("style");var g=this.get("title");this.el=new v({text:d,title:g,contentCls:this.get("contentCls"),container:h.toolBarDiv});this.el.on("offClick",this._on,this);this.el.on("onClick",this._off,this);h.on("selectionChange",this._selectionChange,this)},_on:function(){var h=this.get("editor");this.get("text");var d=
this.get("style");this.get("title");d.apply(h.document);h.notifySelectionChange();h.focus()},_off:function(){var h=this.get("editor");this.get("text");var d=this.get("style");this.get("title");d.remove(h.document);h.notifySelectionChange();h.focus()},_selectionChange:function(h){this.get("editor");this.get("text");var d=this.get("style");this.get("title");d.checkActive(h.path)?this.el.set("state",v.ON):this.el.set("state",v.OFF)}});a.SingleFont=c;q.Font=a}();x.addPlugin(function(){new q.Font({editor:x,
styles:t,html:i});new q.Font({editor:x,styles:l,html:w});new q.Font.SingleFont({contentCls:"ke-toolbar-bold",title:"\u7c97\u4f53",editor:x,style:new r({element:"strong"})});new q.Font.SingleFont({contentCls:"ke-toolbar-italic",title:"\u659c\u4f53",editor:x,style:new r({element:"em"})});new q.Font.SingleFont({contentCls:"ke-toolbar-underline",title:"\u4e0b\u5212\u7ebf",editor:x,style:new r({element:"u"})});new q.Font.SingleFont({contentCls:"ke-toolbar-strikeThrough",title:"\u5220\u9664\u7ebf",editor:x,
style:new r({element:"del"})})})});
KISSY.Editor.add("format",function(x){var q=KISSY.Editor,A=KISSY,r=A.Node;q.Format||function(){function v(l){v.superclass.constructor.call(this,l);this.el=new r(B);this._init()}var B="<select style='height:21px' title='\u683c\u5f0f'>",n={"\u6807\u9898 / \u6e05\u9664":"p","\u6807\u98981":"h1","\u6807\u98982":"h2","\u6807\u98983":"h3","\u6807\u98984":"h4","\u6807\u98985":"h5","\u6807\u98986":"h6"},t={h1:"2em",h2:"1.5em",h3:"1.17em",h4:"1em",h5:"0.83em",h6:"0.67em"},i={},e=q.Style;for(var j in n)if(n[j]){i[n[j]]=
new e({element:n[j]});B+="<option style='font-size:"+t[n[j]]+"'value='"+n[j]+"'>"+j+"</option>"}B+="</select>";v.ATTRS={v:{value:"p"},editor:{}};A.extend(v,A.Base,{_init:function(){var l=this.get("editor"),w=this.el;l.toolBarDiv[0].appendChild(this.el[0]);w.on("change",this._change,this);l.on("selectionChange",this._selectionChange,this);this.on("afterVChange",this._vChange,this)},_vChange:function(l){var w=this.get("editor");l=l.newVal;w.focus();w.fire("save");i[l].apply(w.document);w.fire("save");
w.fire("formatChange",this.get("v"))},_change:function(){this.set("v",this.el.val())},_selectionChange:function(l){this.get("editor");var w=this.get("v");l=l.path;for(var m in i)if(i[m].checkActive(l)){if(m!=w){this._set("v",m);this.el.val(m)}return}this._set("v","p");this.el.val("p")}});q.Format=v}();x.addPlugin(function(){new q.Format({editor:x})})});
KISSY.Editor.add("htmlparser-basicwriter",function(){function x(){this._={output:[]}}var q=KISSY.Editor,A=q.Utils;if(!q.HtmlParser.BasicWriter){KISSY.augment(x,{openTag:function(r){this._.output.push("<",r)},openTagClose:function(r,v){v?this._.output.push(" />"):this._.output.push(">")},attribute:function(r,v){if(typeof v=="string")v=A.htmlEncodeAttr(v);this._.output.push(" ",r,'="',v,'"')},closeTag:function(r){this._.output.push("</",r,">")},text:function(r){this._.output.push(r)},comment:function(r){this._.output.push("<!--",
r,"--\>")},write:function(r){this._.output.push(r)},reset:function(){this._.output=[];this._.indent=false},getHtml:function(r){var v=this._.output.join("");r&&this.reset();return v}});q.HtmlParser.BasicWriter=x}});
KISSY.Editor.add("htmlparser-element",function(){function x(v,B){this.name=v;this.attributes=B||(B={});this.children=[];var n=B._ke_real_element_type||v;B=q.XHTML_DTD;n=!!(B.$nonBodyContent[n]||B.$block[n]||B.$listItem[n]||B.$tableContent[n]||B.$nonEditable[n]||n=="br");var t=!!B.$empty[v];this.isEmpty=t;this.isUnknown=!B[v];this._={isBlockLike:n,hasInlineStarted:t||!n}}var q=KISSY.Editor;if(!q.HtmlParser.Element){var A=q.NODE,r=function(v,B){v=v[0];B=B[0];return v<B?-1:v>B?1:0};KISSY.augment(x,{type:A.NODE_ELEMENT,
add:q.HtmlParser.Fragment.prototype.add,clone:function(){return new x(this.name,this.attributes)},writeHtml:function(v,B){var n=this.attributes,t=this,i=t.name,e,j,l,w;t.filterChildren=function(){if(!w){var s=new q.HtmlParser.BasicWriter;q.HtmlParser.Fragment.prototype.writeChildrenHtml.call(t,s,B);t.children=(new q.HtmlParser.Fragment.fromHtml(s.getHtml())).children;w=1}};if(B){for(;;){if(!(i=B.onElementName(i)))return;t.name=i;if(!(t=B.onElement(t)))return;t.parent=this.parent;if(t.name==i)break;
if(t.type!=A.NODE_ELEMENT){t.writeHtml(v,B);return}i=t.name;if(!i){this.writeChildrenHtml.call(t,v,w?null:B);return}}n=t.attributes}v.openTag(i,n);for(var m=[],k=0;k<2;k++)for(e in n){j=e;l=n[e];if(k==1)m.push([e,l]);else if(B){for(;;)if(j=B.onAttributeName(e))if(j!=e){delete n[e];e=j}else break;else{delete n[e];break}if(j)if((l=B.onAttribute(t,j,l))===false)delete n[j];else n[j]=l}}v.sortAttributes&&m.sort(r);n=m.length;for(k=0;k<n;k++){e=m[k];v.attribute(e[0],e[1])}v.openTagClose(i,t.isEmpty);if(!t.isEmpty){this.writeChildrenHtml.call(t,
v,w?null:B);v.closeTag(i)}},writeChildrenHtml:function(){q.HtmlParser.Fragment.prototype.writeChildrenHtml.apply(this,arguments)}});q.HtmlParser.Element=x}});
KISSY.Editor.add("htmlparser-filter",function(){function x(i){this._={elementNames:[],attributeNames:[],elements:{$length:0},attributes:{$length:0}};i&&this.addRules(i,10)}function q(i,e){for(var j=0;i&&j<e.length;j++){var l=e[j];i=i.replace(l[0],l[1])}return i}function A(i,e,j){if(typeof e=="function")e=[e];var l,w;w=i.length;var m=e&&e.length;if(m){for(l=0;l<w&&i[l].pri<j;l++);for(w=m-1;w>=0;w--)if(m=e[w]){m.pri=j;i.splice(l,0,m)}}}function r(i,e,j){if(e)for(var l in e){var w=i[l];i[l]=v(w,e[l],
j);w||i.$length++}}function v(i,e,j){if(e){e.pri=j;if(i){if(i.splice)A(i,e,j);else{i=i.pri>j?[e,i]:[i,e];i.filter=B}return i}else return e.filter=e}}function B(i){for(var e=i.type||i instanceof n.HtmlParser.Fragment,j=0;j<this.length;j++){if(e)var l=i.type,w=i.name;var m=this[j].apply(window,arguments);if(m===false)return m;if(e){if(m&&(m.name!=w||m.type!=l))return m}else if(typeof m!="string")return m;m!=undefined&&(i=m)}return i}var n=KISSY.Editor,t=n.NODE;if(!n.HtmlParser.Filter){KISSY.augment(x,
{addRules:function(i,e){if(typeof e!="number")e=10;A(this._.elementNames,i.elementNames,e);A(this._.attributeNames,i.attributeNames,e);r(this._.elements,i.elements,e);r(this._.attributes,i.attributes,e);this._.text=v(this._.text,i.text,e)||this._.text;this._.comment=v(this._.comment,i.comment,e)||this._.comment;this._.root=v(this._.root,i.root,e)||this._.root},onElementName:function(i){return q(i,this._.elementNames)},onAttributeName:function(i){return q(i,this._.attributeNames)},onText:function(i){var e=
this._.text;return e?e.filter(i):i},onComment:function(i,e){var j=this._.comment;return j?j.filter(i,e):i},onFragment:function(i){var e=this._.root;return e?e.filter(i):i},onElement:function(i){for(var e=[this._.elements["^"],this._.elements[i.name],this._.elements.$],j,l=0;l<3;l++)if(j=e[l]){j=j.filter(i,this);if(j===false)return null;if(j&&j!=i)return this.onNode(j);if(i.parent&&!i.name)break}return i},onNode:function(i){var e=i.type;return e==t.NODE_ELEMENT?this.onElement(i):e==t.NODE_TEXT?new n.HtmlParser.Text(this.onText(i.value)):
null},onAttribute:function(i,e,j){if(e=this._.attributes[e]){i=e.filter(j,i,this);if(i===false)return false;if(typeof i!="undefined")return i}return j}});n.HtmlParser.Filter=x}});
KISSY.Editor.add("htmlparser-fragment",function(){function x(){this.children=[];this.parent=null;this._={isBlockLike:true,hasInlineStarted:false}}var q=KISSY.Editor;if(!q.HtmlParser.Fragment){var A={colgroup:1,dd:1,dt:1,li:1,option:1,p:1,td:1,tfoot:1,th:1,thead:1,tr:1},r=KISSY,v=q.Utils,B=q.NODE,n=q.XHTML_DTD,t=v.mix({table:1,ul:1,ol:1,dl:1},n.table,n.ul,n.ol,n.dl),i=n.$list,e=n.$listItem;x.FromHtml=function(j,l){function w(f){var o;if(c.length>0)for(var z=0;z<c.length;z++){var u=c[z],C=u.name,I=
n[C],y=d.name&&n[d.name];if((!y||y[C])&&(!f||!I||I[f]||!n[f])){if(!o){m();o=1}u=u.clone();u.parent=d;d=u;c.splice(z,1);z--}}}function m(){for(;h.length;)d.add(h.shift())}function k(f,o,z){o=o||d||a;if(l&&!o.type){var u,C;if((u=f.attributes&&(C=f.attributes._ke_real_element_type)?C:f.name)&&!(u in n.$body)&&!(u in n.$nonBodyContent)){u=d;d=o;s.onTagOpen(l,{});o=d;if(z)d=u}}if(f._.isBlockLike&&f.name!="pre"){z=f.children.length;if((u=f.children[z-1])&&u.type==B.NODE_TEXT)if(C=v.rtrim(u.value))u.value=
C;else f.children.length=z-1}o.add(f);if(f.returnPoint){d=f.returnPoint;delete f.returnPoint}}var s=new q.HtmlParser,a=new x,c=[],h=[],d=a,g=false,p;s.onTagOpen=function(f,o,z){var u=new q.HtmlParser.Element(f,o);if(u.isUnknown&&z)u.isEmpty=true;if(n.$removeEmpty[f])c.push(u);else{if(f=="pre")g=true;else if(f=="br"&&g){d.add(new q.HtmlParser.Text("\n"));return}if(f=="br")h.push(u);else{var C=d.name,I=C&&(n[C]||(d._.isBlockLike?n.div:n.span));if(I&&!u.isUnknown&&!d.isUnknown&&!I[f]){I=false;var y;
if(f in i&&C in i){C=d.children;(C=C[C.length-1])&&C.name in e||k(C=new q.HtmlParser.Element("li"),d);p=d;y=C}else if(f==C)k(d,d.parent);else{if(t[C])p||(p=d);else{k(d,d.parent,true);A[C]||c.unshift(d)}I=true}d=y?y:d.returnPoint||d.parent;if(I){s.onTagOpen.apply(this,arguments);return}}w(f);m();u.parent=d;u.returnPoint=p;p=0;if(u.isEmpty)k(u);else d=u}}};s.onTagClose=function(f){for(var o=c.length-1;o>=0;o--)if(f==c[o].name){c.splice(o,1);return}for(var z=[],u=[],C=d;C.type&&C.name!=f;){C._.isBlockLike||
u.unshift(C);z.push(C);C=C.parent}if(C.type){for(o=0;o<z.length;o++){var I=z[o];k(I,I.parent)}d=C;if(d.name=="pre")g=false;C._.isBlockLike&&m();k(C,C.parent);if(C==d)d=d.parent;c=c.concat(u)}if(f=="body")l=false};s.onText=function(f){if(!d._.hasInlineStarted&&!g){f=v.ltrim(f);if(f.length===0)return}m();w();if(l&&(!d.type||d.name=="body")&&v.trim(f))this.onTagOpen(l,{});g||(f=f.replace(/[\t\r\n ]{2,}|[\t\r\n]/g," "));d.add(new q.HtmlParser.Text(f))};s.onCDATA=function(){};s.onComment=function(){};
s.parse(j);for(m();d.type;){j=d.parent;var b=d;if(l&&(!j.type||j.name=="body")&&!n.$body[b.name]){d=j;s.onTagOpen(l,{});j=d}j.add(b);d=j}return a};r.augment(x,{add:function(j){var l=this.children.length;if(l=l>0&&this.children[l-1]||null){if(j._.isBlockLike&&l.type==B.NODE_TEXT){l.value=v.rtrim(l.value);if(l.value.length===0){this.children.pop();this.add(j);return}}l.next=j}j.previous=l;j.parent=this;this.children.push(j);this._.hasInlineStarted=j.type==B.NODE_TEXT||j.type==B.NODE_ELEMENT&&!j._.isBlockLike},
writeHtml:function(j,l){var w;this.filterChildren=function(){var m=new q.HtmlParser.BasicWriter;this.writeChildrenHtml.call(this,m,l,true);m=m.getHtml();this.children=(new x.FromHtml(m)).children;w=1};!this.name&&l&&l.onFragment(this);this.writeChildrenHtml(j,w?null:l)},writeChildrenHtml:function(j,l){for(var w=0;w<this.children.length;w++)this.children[w].writeHtml(j,l)}});q.HtmlParser.Fragment=x}});
KISSY.Editor.add("htmlparser",function(){function x(){this._={htmlPartsRegex:new RegExp("<(?:(?:\\/([^>]+)>)|(?:!--([\\S|\\s]*?)--\>)|(?:([^\\s>]+)\\s*((?:(?:[^\"'>]+)|(?:\"[^\"]*\")|(?:'[^']*'))*)\\/?>))","g")}}var q=KISSY.Editor;if(!q.HtmlParser){var A=/([\w\-:.]+)(?:(?:\s*=\s*(?:(?:"([^"]*)")|(?:'([^']*)')|([^\s>]+)))|(?=\s|$))/g,r={checked:1,compact:1,declare:1,defer:1,disabled:1,ismap:1,multiple:1,nohref:1,noresize:1,noshade:1,nowrap:1,readonly:1,selected:1},v=q.XHTML_DTD;KISSY.augment(x,{onTagOpen:function(){},
onTagClose:function(){},onText:function(){},onCDATA:function(){},onComment:function(){},parse:function(B){for(var n,t,i=0,e;n=this._.htmlPartsRegex.exec(B);){t=n.index;if(t>i){i=B.substring(i,t);e?e.push(i):this.onText(i)}i=this._.htmlPartsRegex.lastIndex;if(t=n[1]){t=t.toLowerCase();if(e&&v.$cdata[t]){this.onCDATA(e.join(""));e=null}if(!e){this.onTagClose(t);continue}}if(e)e.push(n[0]);else if(t=n[3]){t=t.toLowerCase();var j={},l;n=n[4];var w=!!(n&&n.charAt(n.length-1)=="/");if(n)for(;l=A.exec(n);){var m=
l[1].toLowerCase();l=l[2]||l[3]||l[4]||"";j[m]=!l&&r[m]?m:l}this.onTagOpen(t,j,w);if(!e&&v.$cdata[t])e=[]}else if(t=n[2])this.onComment(t)}B.length>i&&this.onText(B.substring(i,B.length))}});q.HtmlParser=x}});
KISSY.Editor.add("htmlparser-htmlwriter",function(){function x(){x.superclass.constructor.call(this);this.indentationChars="\t";this.selfClosingEnd=" />";this.lineBreakChars="\n";this.forceSimpleAmpersand=false;this.sortAttributes=true;this._.indent=false;this._.indentation="";this._.rules={};var r=q.XHTML_DTD;for(var v in A.mix({},r.$nonBodyContent,r.$block,r.$listItem,r.$tableContent))this.setRules(v,{indent:true,breakBeforeOpen:true,breakAfterOpen:true,breakBeforeClose:!r[v]["#"],breakAfterClose:true});
this.setRules("br",{breakAfterOpen:true});this.setRules("title",{indent:false,breakAfterOpen:false});this.setRules("style",{indent:false,breakBeforeClose:true});this.setRules("pre",{indent:false})}var q=KISSY.Editor,A=q.Utils;if(!q.HtmlParser.HtmlWriter){KISSY.extend(x,q.HtmlParser.BasicWriter,{openTag:function(r){var v=this._.rules[r];if(this._.indent)this.indentation();else if(v&&v.breakBeforeOpen){this.lineBreak();this.indentation()}this._.output.push("<",r)},openTagClose:function(r,v){r=this._.rules[r];
if(v)this._.output.push(this.selfClosingEnd);else{this._.output.push(">");if(r&&r.indent)this._.indentation+=this.indentationChars}r&&r.breakAfterOpen&&this.lineBreak()},attribute:function(r,v){if(typeof v=="string"){this.forceSimpleAmpersand&&(v=v.replace(/&amp;/g,"&"));v=A.htmlEncodeAttr(v)}this._.output.push(" ",r,'="',v,'"')},closeTag:function(r){var v=this._.rules[r];if(v&&v.indent)this._.indentation=this._.indentation.substr(this.indentationChars.length);if(this._.indent)this.indentation();
else if(v&&v.breakBeforeClose){this.lineBreak();this.indentation()}this._.output.push("</",r,">");v&&v.breakAfterClose&&this.lineBreak()},text:function(r){if(this._.indent){this.indentation();r=A.ltrim(r)}this._.output.push(r)},comment:function(r){this._.indent&&this.indentation();this._.output.push("<!--",r,"--\>")},lineBreak:function(){this._.output.length>0&&this._.output.push(this.lineBreakChars);this._.indent=true},indentation:function(){this._.output.push(this._.indentation);this._.indent=false},
setRules:function(r,v){var B=this._.rules[r];if(B)A.mix(B,v);else this._.rules[r]=v}});q.HtmlParser.HtmlWriter=x}});KISSY.Editor.add("htmlparser-text",function(){function x(A){this.value=A;this._={isBlockLike:false}}var q=KISSY.Editor;if(!q.HtmlParser.Text){KISSY.augment(x,{type:q.NODE.NODE_TEXT,writeHtml:function(A,r){var v=this.value;r&&!(v=r.onText(v,this))||A.text(v)}});q.HtmlParser.Text=x}});
KISSY.Editor.add("htmldataprocessor",function(){var x=KISSY.Editor;if(!x.HtmlDataProcessor){var q=KISSY.UA,A=x.HtmlParser,r=new A.Filter,v=new A.Filter,B={elementNames:[[/^script$/,""],[/^iframe$/,""],[/^style$/,""],[/^link$/,""],[/^meta$/,""]],elements:{},attributes:{"class":function(t){if(/ke_/.test(t))return t;return false}},attributeNames:[[/^on/,"ck_on"]]},n={elementNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],elements:{embed:function(t){var i=t.parent;if(i&&i.name=="object"){var e=i.attributes.width;
i=i.attributes.height;e&&(t.attributes.width=e);i&&(t.attributes.height=i)}},param:function(t){t.children=[];t.isEmpty=true;return t},a:function(t){if(!(t.children.length||t.attributes.name))return false}},attributes:{},attributeNames:[[/^ck_on/,"on"]]};if(q.ie)n.attributes.style=function(t){return t.toLowerCase()};r.addRules(n);v.addRules(B);x.HtmlDataProcessor={htmlFilter:r,dataFilter:v,toHtml:function(t,i){var e=new A.HtmlWriter;A.Fragment.FromHtml(t,i).writeHtml(e,r);return e.getHtml(true)},toDataFormat:function(t,
i){var e=new A.HtmlWriter;t=A.Fragment.FromHtml(t,i);e.reset();t.writeHtml(e,v);return e.getHtml(true)}}}});
KISSY.Editor.add("image",function(x){var q=KISSY.Editor,A=KISSY,r=A.Node,v=A.DOM,B=A.Event,n=q.SimpleOverlay;q.ImageInserter||function(){function t(e){t.superclass.constructor.call(this,e);this._init()}var i=q.TripleButton;t.ATTRS={editor:{}};A.extend(t,A.Base,{_init:function(){var e=this.get("editor").toolBarDiv;this.el=new i({contentCls:"ke-toolbar-image",title:"\u56fe\u50cf",container:e});this.el.on("offClick",this.show,this);q.Utils.lazyRun(this,"_prepare","_real")},_prepare:function(){var e=
this,j=e.get("editor");e.d=new n({title:"\u63d2\u5165\u56fe\u7247",mask:true,width:"350px"});var l=e.d;l.body.html("<div><p><label><span style='color:#0066CC;font-weight:bold;'>\u56fe\u7247\u7f51\u5740\uff1a</span><input class='ke-img-url' style='width:230px' value='http://'/></label></p></div>");l.foot.html("<button class='ke-img-insert'>\u63d2\u5165</button> <button class='ke-img-cancel'>\u53d6\u6d88</button>");e.content=l.el;l=e.content;var w=l.one(".ke-img-cancel"),m=l.one(".ke-img-insert");e.imgUrl=
l.one(".ke-img-url");w.on("click",function(k){e.d.hide();k.halt()});B.on(document,"click",e.hide,e);B.on(j.document,"click",e.hide,e);m.on("click",function(){e._insert()})},hide:function(e){var j=this;v._4e_ascendant(e.target,function(l){return l[0]===j.content[0]||l[0]===j.el.el[0]},true)||this.d.hide()},_real:function(){this.d.show()},_insert:function(){var e=this.get("editor"),j=this.imgUrl.val();if(j){j=new r("<img src='"+j+"'/>",null,e.document);e.insertElement(j);this.d.hide()}},show:function(){this._prepare()}});
q.ImageInserter=t}();x.addPlugin(function(){new q.ImageInserter({editor:x})})});
KISSY.Editor.add("indent",function(x){var q=KISSY.Editor,A={ol:1,ul:1},r=KISSY,v=q.Walker,B=r.DOM,n=r.Node,t=r.UA,i=q.NODE;q.Indent||function(){function e(h){this.type=h;this.indentCssProperty="margin-left";this.indentOffset=40;this.indentUnit="px"}function j(h){return h.type=CKEDITOR.NODE_ELEMENT&&h.is("li")}function l(h,d,g){var p=d.startContainer;for(h=d.endContainer;p&&p.parent()[0]!==g[0];)p=p.parent();for(;h&&h.parent()[0]!==g[0];)h=h.parent();if(p&&h){var b=p;p=[];for(var f=false;!f;){if(b[0]===
h[0])f=true;p.push(b);b=b.next()}if(!(p.length<1)){b=g._4e_parents(true);for(h=0;h<b.length;h++)if(A[b[h]._4e_name()]){g=b[h];break}b=this.type=="indent"?1:-1;h=p[0];f=p[p.length-1];p={};var o=q.ListUtils.listToArray(g,p),z=o[f._4e_getData("listarray_index")].indent;for(h=h._4e_getData("listarray_index");h<=f._4e_getData("listarray_index");h++){o[h].indent+=b;var u=o[h].parent;o[h].parent=new n(u[0].ownerDocument.createElement(u._4e_name()))}for(h=f._4e_getData("listarray_index")+1;h<o.length&&o[h].indent>
z;h++)o[h].indent+=b;f=q.ListUtils.arrayToList(o,p,null,"p",0);b=[];if(this.type=="outdent"){var C;if((C=g.parent())&&C._4e_name()=="li"){o=f.listNode.childNodes;var I;for(h=o.length-1;h>=0;h--)if((I=new n(o[h]))&&I._4e_name()=="li")b.push(I)}}if(f){B.insertBefore(f.listNode,g[0]);g._4e_remove()}if(b&&b.length)for(h=0;h<b.length;h++){for(I=g=b[h];(I=I.next())&&I._4e_name()in A;){t.ie&&!g._4e_first(function(y){return s(y)&&a(y)})&&g[0].appendChild(d.document.createTextNode("\u00a0"));g[0].appendChild(I[0])}B.insertAfter(g[0],
C[0])}for(h in p)p[h]._4e_clearMarkers(p,true)}}}function w(h,d){d=d.createIterator();d.enforceRealBlocks=true;d.enlargeBr=true;for(var g;g=d.getNextParagraph();)m.call(this,h,g)}function m(h,d){h=parseInt(d._4e_style(this.indentCssProperty),10);if(isNaN(h))h=0;h+=(this.type=="indent"?1:-1)*this.indentOffset;if(h<0)return false;h=Math.max(h,0);h=Math.ceil(h/this.indentOffset)*this.indentOffset;d.css(this.indentCssProperty,h?h+this.indentUnit:"");d[0].style.cssText===""&&d[0].removeAttribute("style");
return true}function k(h){k.superclass.constructor.call(this,h);h=this.get("editor").toolBarDiv;this.el=new c({container:h,contentCls:this.get("contentCls"),title:this.get("title")});this.indentCommand=new e(this.get("type"));this._init()}var s=v.whitespaces(true),a=v.bookmark(false,true);r.augment(e,{exec:function(h){h.focus();for(var d=h.getSelection(),g=d&&d.getRanges()[0],p=g.startContainer,b=g.endContainer,f=g.getCommonAncestor();f&&!(f[0].nodeType==i.NODE_ELEMENT&&A[f._4e_name()]);)f=f.parent();
if(f&&p[0].nodeType==i.NODE_ELEMENT&&p._4e_name()in A){p=new v(g);p.evaluator=j;g.startContainer=p.next()}if(f&&b[0].nodeType==i.NODE_ELEMENT&&b._4e_name()in A){p=new v(g);p.evaluator=j;g.endContainer=p.previous()}b=d.createBookmarks(true);if(f){for(p=f._4e_first();p&&p[0]&&p._4e_name()!="li";)p=p.next();var o=g.startContainer;(p[0]==o[0]||p._4e_contains(o))&&m.call(this,h,f)||l.call(this,h,g,f)}else w.call(this,h,g);h.focus();d.selectBookmarks(b)}});var c=q.TripleButton;k.ATTRS={type:{},contentCls:{},
editor:{}};r.extend(k,r.Base,{_init:function(){var h=this.get("editor"),d=this.el;d.on("offClick",this.exec,this);this.get("type")=="outdent"?h.on("selectionChange",this._selectionChange,this):d.set("state",c.OFF)},exec:function(){var h=this.get("editor"),d=this;h.focus();h.fire("save");setTimeout(function(){d.indentCommand.exec(h);h.fire("save");h.notifySelectionChange()},10)},_selectionChange:function(h){this.get("editor");this.get("type");var d=h.path,g=d.blockLimit;h=this.el;if(d.contains(A))h.set("state",
c.OFF);else(d=d.block||g)&&d._4e_style(this.indentCommand.indentCssProperty)?h.set("state",c.OFF):h.set("state",c.DISABLED)}});q.Indent=k}();x.addPlugin(function(){x.addCommand("outdent",new q.Indent({editor:x,title:"\u51cf\u5c11\u7f29\u8fdb\u91cf",contentCls:"ke-toolbar-outdent",type:"outdent"}));x.addCommand("indent",new q.Indent({editor:x,title:"\u589e\u52a0\u7f29\u8fdb\u91cf",contentCls:"ke-toolbar-indent",type:"indent"}))})});
KISSY.Editor.add("justify",function(x){var q=KISSY.Editor,A=KISSY,r=q.TripleButton;q.Justify||function(){function v(n,t,i,e){this.editor=n;this.v=t;this.contentCls=e;this.title=i;this._init()}var B=/(-moz-|-webkit-|start|auto)/i;A.augment(v,{_init:function(){var n=this.editor;this.el=new r({contentCls:this.contentCls,title:this.title,container:n.toolBarDiv});n.on("selectionChange",this._selectionChange,this);this.el.on("click",this._effect,this)},_effect:function(){var n=this.editor,t=n.getSelection(),
i=this.el.get("state");if(t){var e=t.createBookmarks(),j=t.getRanges(),l,w;n.fire("save");for(var m=j.length-1;m>=0;m--){l=j[m].createIterator();for(l.enlargeBr=true;w=l.getNextParagraph();){w.removeAttr("align");i==r.OFF?w.css("text-align",this.v):w.css("text-align","")}}n.focus();n.notifySelectionChange();t.selectBookmarks(e);n.fire("save")}},_selectionChange:function(n){var t=this.el;n=n.path;if(n=n.block||n.blockLimit){n=n.css("text-align").replace(B,"");n==this.v||!n&&this.v=="left"?t.set("state",
r.ON):t.set("state",r.OFF)}}});q.Justify=v}();x.addPlugin(function(){new q.Justify(x,"left","\u5de6\u5bf9\u9f50","ke-toolbar-alignleft");new q.Justify(x,"center","\u5c45\u4e2d\u5bf9\u9f50","ke-toolbar-aligncenter");new q.Justify(x,"right","\u53f3\u5bf9\u9f50","ke-toolbar-alignright")})});
KISSY.Editor.add("link",function(x){var q=KISSY.Editor,A=KISSY,r=A.DOM,v=A.Event,B=q.TripleButton,n=q.Style,t=A.Node,i=q.Range,e=q.SimpleOverlay,j=q.HtmlDataProcessor,l=j&&j.dataFilter;q.Link||function(){function w(a){this.editor=a;this._init()}l&&l.addRules({elements:{a:function(a){for(var c in a.attributes)c=="href"||c=="target"||delete a.attributes[c]}}});var m={element:"a",attributes:{href:"#(href)",target:"#(target)"}};w.init=function(){var a=this;a.d=new e({title:"\u4fee\u6539\u94fe\u63a5",
mask:true,width:"300px"});a.d.body.html(k);a.d.foot.html(s);a.urlEl=a.d.body.one(".ke-link-url");a.targetEl=a.d.body.one(".ke-link-blank");var c=a.d.foot.one(".ke-link-cancel");a.ok=a.d.foot.one(".ke-link-ok");w.ok.on("click",function(h){w.d.link._link();h.halt()},this);c.on("click",function(h){a.d.hide();h.halt()},a);w.init=null};w.tip=function(){var a=new t('<div class="ke-bubbleview-bubble" onmousedown="return false;">\u524d\u5f80\u94fe\u63a5\uff1a  <a href=""  target="_blank" class="ke-bubbleview-url"></a> -     <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -     <span class="ke-bubbleview-link ke-bubbleview-remove">\u53bb\u9664</span></div>');
a._4e_unselectable();this.tipwin=new e({el:a,focusMgr:false});document.body.appendChild(a[0]);this.tipurl=a.one(".ke-bubbleview-url");var c=a.one(".ke-bubbleview-change");a=a.one(".ke-bubbleview-remove");c.on("click",function(h){w.tipwin.link.show();h.halt()});a.on("click",function(h){w.tipwin.link._removeLink();h.halt()});w.tip=null};var k="<div><p><label><span style='color:#0066CC;font-weight:bold;'>\u7f51\u5740\uff1a</span><input class='ke-link-url' style='width:230px' value='http://'/></label></p><p style='margin-top: 5px;padding-left:45px'><label><input class='ke-link-blank' type='checkbox'/> &nbsp; \u5728\u65b0\u7a97\u53e3\u6253\u5f00\u94fe\u63a5</label></p></div>",
s="<button class='ke-link-ok'>\u786e\u5b9a</button> <button class='ke-link-cancel'>\u53d6\u6d88</button>";A.augment(w,{_init:function(){var a=this.editor;this.el=new B({container:a.toolBarDiv,contentCls:"ke-toolbar-link",title:"\u63d2\u5165\u7f16\u8f91\u8d85\u94fe\u63a5"});this.el.on("click",this.show,this);a.on("selectionChange",this._selectionChange,this)},_prepareTip:function(){w.tip&&w.tip()},_realTip:function(a){var c=a._4e_getOffset(document);c.top+=a.height()+5;w.tipwin.show(c);this._a=a;w.tipwin.link=
this;w.tipurl.html(a.attr("href"));w.tipurl.attr("href",a.attr("href"))},_showTip:function(a){this._prepareTip(a)},_hideTip:function(){w.tipwin&&w.tipwin.hide()},_removeLink:function(){var a=this._a,c=this.editor;c.focus();var h={href:a.attr("href")};if(a._4e_hasAttribute("target"))h.target=a.attr("target");a=new n(m,h);c.fire("save");a.remove(c.document);c.fire("save");this._hideTip();c.focus();c.notifySelectionChange()},_selectionChange:function(a){a=a.path;var c=a.elements;if(a&&c)if(a=a.lastElement)(a=
a._4e_ascendant(function(h){return h._4e_name()==="a"&&!!h.attr("href")},true))?this._showTip(a):this._hideTip()},hide:function(){w.d.hide()},_getSelectedLink:function(){var a=this.editor;if(w.tipwin&&w.tipwin.get("visible")){(a=a.getSelection().getRanges()[0].getCommonAncestor())&&(a=a._4e_ascendant(function(c){return c._4e_name()=="a"&&!!c.attr("href")},true));if(a&&a[0]==w.tipwin.link._a[0])return a}},_link:function(){var a=this.editor,c=w.urlEl.val();a.focus();if(A.trim(c)){var h=this._getSelectedLink();
if(h){var d=new i(a.document);d.selectNodeContents(h);a.getSelection().selectRanges([d]);this._removeLink()}c={href:c};c.target=w.targetEl[0].checked?"_blank":"_self";c=new n(m,c);a.fire("save");c.apply(a.document);a.fire("save");this.hide();a.focus();a.notifySelectionChange()}},_prepare:function(){w.init&&w.init()},_real:function(){w.d.link=this;var a=this._getSelectedLink();if(a){w.urlEl.val(a.attr("href"));w.targetEl[0].checked=a.attr("target")=="_blank"}w.d.show()},show:function(){this._prepare()}});
q.Utils.lazyRun(w.prototype,"_prepare","_real");q.Utils.lazyRun(w.prototype,"_prepareTip","_realTip");q.Link=w}();x.addPlugin(function(){new q.Link(x);var w=r._4e_getWin(x.document);v.on(w,"scroll",function(){q.Link.tipwin&&q.Link.tipwin.hide()})})});
KISSY.Editor.add("list",function(x){var q=KISSY.Editor,A={ol:1,ul:1},r=["ol","ul"],v=KISSY,B=q.RANGE,n=q.ElementPath,t=q.Walker,i=q.NODE,e=v.UA,j=v.Node,l=v.DOM;q.List||function(){function w(c){this.type=c}function m(c){m.superclass.constructor.call(this,c);c=this.get("editor").toolBarDiv;this.el=new a({contentCls:this.get("contentCls"),title:this.get("title"),container:c});this.listCommand=new w(this.get("type"));this.listCommand.state=this.get("status");this._init()}var k={listToArray:function(c,
h,d,g,p){if(!A[c._4e_name()])return[];g||(g=0);d||(d=[]);for(var b=0,f=c[0].childNodes.length;b<f;b++){var o=new j(c[0].childNodes[b]);if(o._4e_name()=="li"){var z={parent:c,indent:g,element:o,contents:[]};if(p)z.grandparent=p;else{z.grandparent=c.parent();if(z.grandparent&&z.grandparent._4e_name()=="li")z.grandparent=z.grandparent.parent()}h&&o._4e_setMarker(h,"listarray_index",d.length);d.push(z);for(var u=0,C=o[0].childNodes.length,I;u<C;u++){I=new j(o[0].childNodes[u]);I[0].nodeType==i.NODE_ELEMENT&&
A[I._4e_name()]?k.listToArray(I,h,d,g+1,z.grandparent):z.contents.push(I)}}}return d},arrayToList:function(c,h,d,g){d||(d=0);if(!c||c.length<d+1)return null;for(var p=c[d].parent[0].ownerDocument,b=p.createDocumentFragment(),f=null,o=d,z=Math.max(c[d].indent,0),u=null;;){var C=c[o];if(C.indent==z){if(!f||c[o].parent._4e_name()!=f._4e_name()){f=c[o].parent._4e_clone(false,true);b.appendChild(f[0])}u=f[0].appendChild(C.element._4e_clone(false,true)[0]);for(var I=0;I<C.contents.length;I++)u.appendChild(C.contents[I]._4e_clone(true,
true)[0]);o++}else if(C.indent==Math.max(z,0)+1){o=k.arrayToList(c,null,o,g);u.appendChild(o.listNode);o=o.nextIndex}else if(C.indent==-1&&!d&&C.grandparent){u=A[C.grandparent._4e_name()]?C.element._4e_clone(false,true)[0]:C.grandparent._4e_name()!="td"?p.createElement(g):p.createDocumentFragment();for(I=0;I<C.contents.length;I++)u.appendChild(C.contents[I]._4e_clone(true,true)[0]);if(u.nodeType==i.NODE_DOCUMENT_FRAGMENT&&o!=c.length-1){u.lastChild&&u.lastChild.nodeType==i.NODE_ELEMENT&&u.lastChild.getAttribute("type")==
"_moz"&&l._4e_remove(u.lastChild);l._4e_appendBogus(u)}if(u.nodeType==i.NODE_ELEMENT&&l._4e_name(u)==g&&u.firstChild){l._4e_trim(u);f=u.firstChild;if(f.nodeType==i.NODE_ELEMENT&&l._4e_isBlockBoundary(f)){f=p.createDocumentFragment();l._4e_moveChildren(u,f);u=f}}f=l._4e_name(u);if(!e.ie&&(f=="div"||f=="p"))l._4e_appendBogus(u);b.appendChild(u);f=null;o++}else return null;if(c.length<=o||Math.max(c[o].indent,0)<z)break}if(h)for(c=new j(b.firstChild);c&&c[0];){c[0].nodeType==i.NODE_ELEMENT&&c._4e_clearMarkers(h,
true);c=c._4e_nextSourceNode()}return{listNode:b,nextIndex:o}}},s=/^h[1-6]$/;w.prototype={changeListType:function(c,h,d,g){var p=k.listToArray(h.root,d),b=[];for(c=0;c<h.contents.length;c++){var f=h.contents[c];f=f._4e_ascendant("li",true);if(!(!f||!f[0]||f._4e_getData("list_item_processed"))){b.push(f);f._4e_setMarker(d,"list_item_processed",true)}}f=new j(h.root[0].ownerDocument.createElement(this.type));for(c=0;c<b.length;c++){var o=b[c]._4e_getData("listarray_index");p[o].parent=f}d=k.arrayToList(p,
d,null,"p");var z;p=d.listNode.childNodes.length;for(c=0;c<p&&(z=new j(d.listNode.childNodes[c]));c++)z._4e_name()==this.type&&g.push(z);l.insertBefore(d.listNode,h.root[0]);h.root._4e_remove()},createList:function(c,h,d){var g=h.contents;c=h.root[0].ownerDocument;var p=[];if(g.length==1&&g[0][0]===h.root[0]){var b=new j(c.createElement("div"));g[0][0].nodeType!=i.NODE_TEXT&&g[0]._4e_moveChildren(b);g[0][0].appendChild(b[0]);g[0]=b}h=h.contents[0].parent();for(b=0;b<g.length;b++)h=h._4e_commonAncestor(g[b].parent());
for(b=0;b<g.length;b++)for(var f=g[b],o;o=f.parent();){if(o[0]===h[0]){p.push(f);break}f=o}if(!(p.length<1)){g=new j(p[p.length-1][0].nextSibling);b=new j(c.createElement(this.type));for(d.push(b);p.length;){d=p.shift();f=new j(c.createElement("li"));if(s.test(d._4e_name()))f[0].appendChild(d[0]);else{d._4e_copyAttributes(f);d._4e_moveChildren(f);d._4e_remove()}b[0].appendChild(f[0]);e.ie||f._4e_appendBogus()}g[0]?l.insertBefore(b[0],g[0]):h[0].appendChild(b[0])}},removeList:function(c,h,d){function g(I){if((u=
new j(z[I?"firstChild":"lastChild"]))&&!(u[0].nodeType==i.NODE_ELEMENT&&u._4e_isBlockBoundary())&&(C=h.root[I?"_4e_previous":"_4e_next"](t.whitespaces(true)))&&!(u[0].nodeType==i.NODE_ELEMENT&&C._4e_isBlockBoundary({br:1})))l[I?"insertBefore":"insertAfter"](c.document.createElement("br"),u[0])}for(var p=k.listToArray(h.root,d),b=[],f=0;f<h.contents.length;f++){var o=h.contents[f];o=o._4e_ascendant("li",true);if(!(!o||o._4e_getData("list_item_processed"))){b.push(o);o._4e_setMarker(d,"list_item_processed",
true)}}o=null;for(f=0;f<b.length;f++){o=b[f]._4e_getData("listarray_index");p[o].indent=-1;o=o}for(f=o+1;f<p.length;f++)if(p[f].indent>Math.max(p[f-1].indent,0)){b=p[f-1].indent+1-p[f].indent;for(o=p[f].indent;p[f]&&p[f].indent>=o;){p[f].indent+=b;f++}f--}var z=k.arrayToList(p,d,null,"p").listNode,u,C;g(true);g();l.insertBefore(z,h.root);h.root._4e_remove()},exec:function(c){c.focus();var h=c.getSelection(),d=h&&h.getRanges();if(!(!d||d.length<1)){for(var g=h.createBookmarks(true),p=[],b={};d.length>
0;){var f=d.shift(),o=f.getBoundaryNodes(),z=o.startNode,u=o.endNode;z[0].nodeType==i.NODE_ELEMENT&&z._4e_name()=="td"&&f.setStartAt(o.startNode,B.POSITION_AFTER_START);u[0].nodeType==i.NODE_ELEMENT&&u._4e_name()=="td"&&f.setEndAt(o.endNode,B.POSITION_BEFORE_END);f=f.createIterator();for(f.forceBrBreak=false;o=f.getNextParagraph();){z=new n(o);u=z.elements;var C=null,I=false,y=z.blockLimit,D;for(z=u.length-1;z>=0&&(D=u[z]);z--)if(A[D._4e_name()]&&y.contains(D)){y._4e_removeData("list_group_object");
if(z=D._4e_getData("list_group_object"))z.contents.push(o);else{z={root:D,contents:[o]};p.push(z);D._4e_setMarker(b,"list_group_object",z)}I=true;break}if(!I)if(y._4e_getData("list_group_object"))y._4e_getData("list_group_object").contents.push(o);else{z={root:y,contents:[o]};y._4e_setMarker(b,"list_group_object",z);p.push(z)}}}for(d=[];p.length>0;){z=p.shift();if(this.state=="off")A[z.root._4e_name()]?this.changeListType(c,z,b,d):this.createList(c,z,d);else this.state=="on"&&A[z.root._4e_name()]&&
this.removeList(c,z,b)}for(z=0;z<d.length;z++){C=d[z];var G=this;(p=function(J){var N=C[J?"_4e_previous":"_4e_next"](t.whitespaces(true));if(N&&N[0]&&N._4e_name()==G.type){N._4e_remove();N._4e_moveChildren(C,J?true:false)}})();p(true)}q.Utils.clearAllMarkers(b);h.selectBookmarks(g);c.focus()}}};var a=q.TripleButton;m.ATTRS={editor:{},type:{},contentCls:{}};v.extend(m,v.Base,{_init:function(){var c=this.get("editor");this.el.on("click",this._change,this);c.on("selectionChange",this._selectionChange,
this)},_change:function(){var c=this.get("editor"),h=this.get("type"),d=this.el,g=this;c.focus();c.fire("save");setTimeout(function(){g.listCommand.state=d.get("state");g.listCommand.exec(c);c.fire("save");c.fire(h+"Change")},10)},_selectionChange:function(c){this.get("editor");var h=this.get("type"),d=c.path,g;c=this.el;var p=d.blockLimit;if(d=d.elements)for(var b=0;b<d.length&&(g=d[b])&&g[0]!==p[0];b++){var f=v.indexOf(d[b]._4e_name(),r);if(f!==-1)if(r[f]===h){c.set("state",a.ON);return}else break}c.set("state",
a.OFF)}});q.ListUtils=k;q.List=m}();x.addPlugin(function(){new q.List({editor:x,title:"\u9879\u76ee\u5217\u8868",contentCls:"ke-toolbar-ul",type:"ul"});new q.List({editor:x,title:"\u7f16\u53f7\u5217\u8868",contentCls:"ke-toolbar-ol",type:"ol"})})});
KISSY.Editor.add("maximize",function(x){var q=KISSY.Editor,A=KISSY,r=A.UA,v=A.Node,B=A.Event,n=q.TripleButton,t=A.DOM,i;q.Maximize||function(){function e(j){this.editor=j;this._init()}e.init=function(){i=new v("<iframe style='position:absolute;top:-9999px;left:-9999px;' frameborder='0'></iframe>");document.body.appendChild(i[0]);e.init=null};A.augment(e,{_init:function(){this.el=new n({container:this.editor.toolBarDiv,cls:"ke-tool-editor-source",title:"\u5168\u5c4f",contentCls:"ke-toolbar-maximize"});
this.el.on("offClick",this.maximize,this);this.el.on("onClick",this.restore,this);q.Utils.lazyRun(this,"_prepare","_real")},restore:function(){var j=this,l=j.editor;B.remove(window,"resize",j._maximize,j);this._saveEditorStatus();l.wrap.css({height:j.iframeHeight});(new v(document.body)).css({width:"",height:"",overflow:""});document.documentElement.style.overflow="";l.editorWrap.css({position:"static",width:j.editorWrapWidth});i.css({left:"-99999px",top:"-99999px"});window.scrollTo(j.scrollLeft,
j.scrollTop);j.el.set("state",n.OFF);setTimeout(function(){j._restoreEditorStatus()},30)},_saveSate:function(){var j=this.editor;this.iframeHeight=j.wrap._4e_style("height");this.editorWrapWidth=j.editorWrap._4e_style("width");this.scrollLeft=t.scrollLeft();this.scrollTop=t.scrollTop();window.scrollTo(0,0)},_saveEditorStatus:function(){var j=this.editor;if(r.gecko&&j.iframeFocus)this.savedRanges=(j=j.getSelection())&&j.getRanges()},_restoreEditorStatus:function(){var j=this.editor,l=j.getSelection();
if(r.gecko&&j.iframeFocus){this.el.el[0].focus();j.focus();this.savedRanges&&l&&l.selectRanges(this.savedRanges)}if(j.iframeFocus&&l)(j=l.getStartElement())&&j[0]&&j._4e_scrollIntoView()},_maximize:function(){var j=this.editor,l=t.viewportHeight(),w=t.viewportWidth(),m=j.statusDiv?j.statusDiv.height():0,k=j.toolBarDiv.height();if(r.ie){document.documentElement.style.overflow="hidden";document.body.style.overflow="hidden"}else(new v(document.body)).css({width:0,height:0,overflow:"hidden"});j.editorWrap.css({position:"absolute",
zIndex:9999,width:w+"px"});i.css({zIndex:9998,height:l+"px",width:w+"px"});j.editorWrap.offset({left:0,top:0});i.css({left:0,top:0});j.wrap.css({height:l-m-k-14+"px"})},_real:function(){var j=this;this._saveEditorStatus();this._saveSate();this._maximize();this._maximize();B.on(window,"resize",j._maximize,j);this.el.set("state",n.ON);setTimeout(function(){j._restoreEditorStatus()},30)},_prepare:function(){e.init&&e.init()},maximize:function(){this._prepare()}});q.Maximize=e}();x.addPlugin(function(){new q.Maximize(x)})});
KISSY.Editor.add("music",function(x){var q=KISSY.Editor,A=q.NODE;q.MusicInserter||function(){function r(m){r.superclass.constructor.call(this,m);m=this.get("editor");m._toolbars=m._toolbars||{};m._toolbars.music=this;this._init()}function v(m){return m.replace(/^.+niftyplayer\.swf\?file=/,"")}var B=KISSY,n=B.Node,t=B.DOM,i=q.ContextMenu,e=B.Event,j=q.SimpleOverlay,l=q.TripleButton;MUSIC_MARKUP='<object  width="165" height="37" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,0,0" classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"><param value="'+
(q.Config.base+'plugins/music/niftyplayer.swf?file=#(music)&amp;as=0"')+' name="movie"/><param value="high" name="quality"/><param value="#FFFFFF" name="bgcolor"/><embed width="165" height="37" type="application/x-shockwave-flash" swliveconnect="true" src="'+(q.Config.base+'plugins/music/niftyplayer.swf?file=#(music)&amp;as=0"')+'quality="high" pluginspage="http://www.macromedia.com/go/getflashplayer" bgcolor="#FFFFFF" /></object>';music_reg=/#\(music\)/g;flashRules=["img.ke_music"];r.ATTRS={editor:{}};
B.extend(r,B.Base,{_init:function(){var m=this.get("editor"),k={};this.el=new l({contentCls:"ke-toolbar-music",title:"\u5206\u4eab\u97f3\u4e50",container:m.toolBarDiv});e.on(m.document,"dblclick",this._dblclick,this);for(var s in w)(function(a){k[a]=function(){m.fire("save");m.focus();w[a](m);m.fire("save")}})(s);i.register(m.document,{rules:flashRules,width:"120px",funcs:k});this.el.on("offClick",this.show,this);q.Utils.lazyRun(this,"_prepare","_real")},_prepare:function(){var m=this,k=m.get("editor");
m.d=new j({title:"\u63d2\u5165\u97f3\u4e50",mask:true,width:"350px"});var s=m.d;s.body.html("<div><p><label><span style='color:#0066CC;font-weight:bold;'>\u97f3\u4e50\u7f51\u5740\uff1a</span><input class='ke-music-url' style='width:230px' value='http://'/></label></p></div>");s.foot.html("<button class='ke-music-insert'>\u63d2\u5165</button> <button class='ke-music-cancel'>\u53d6\u6d88</button>");m.content=s.el;var a=m.content;s.on("hide",function(){m.selectedFlash=null;k.focus()});s=a.one(".ke-music-cancel");
var c=a.one(".ke-music-insert");m.musicUrl=a.one(".ke-music-url");s.on("click",function(h){m.d.hide();h.halt()});e.on(document,"click",m.hide,m);e.on(k.document,"click",m.hide,m);c.on("click",function(){m._insert()})},hide:function(m){var k=this;t._4e_ascendant(m.target,function(s){return s[0]===k.content[0]||s[0]===k.el.el[0]})||this.d.hide()},_real:function(){this.d.show()},_insert:function(){var m=this.get("editor"),k=this.musicUrl.val();if(k){k=MUSIC_MARKUP.replace(music_reg,k);var s=new n(k,
null,m.document);k=m.createFakeElement?m.createFakeElement(s,"ke_music","music",true,k):s;m.insertElement(k);this.d.hide()}},_dblclick:function(m){var k=new n(m.target);if(k._4e_name()==="img"&&k.hasClass("ke_music")){this.selectedFlash=k;this.show();m.halt()}},show:function(){this._prepare();if(this.selectedFlash){var m=this.get("editor").restoreRealElement(this.selectedFlash);if(m._4e_name()=="object"){m=m[0].childNodes;for(var k=0;k<m.length;k++)if(m[k].nodeType==A.NODE_ELEMENT)if((t.attr(m[k],
"name")||"").toLowerCase()=="movie")this.musicUrl.val(v(t.attr(m[k],"value")));else if(t._4e_name(m[k])=="embed")this.musicUrl.val(v(t.attr(m[k],"src")));else t._4e_name(m[k])=="object"&&this.musicUrl.val(v(t.attr(m[k],"data")))}else m._4e_name()=="embed"&&this.musicUrl.val(v(m.attr("src")))}}});q.MusicInserter=r;var w={"\u7f16\u8f91\u97f3\u4e50":function(m){var k=m.getSelection();if(k=(k=k&&k.getStartElement())&&k._4e_ascendant("img",true))if(k.hasClass("ke_music")){m=m._toolbars.music;m.selectedFlash=
k;m.show()}}}}();x.addPlugin(function(){new q.MusicInserter({editor:x})})});
KISSY.Editor.add("preview",function(x){var q=KISSY.Editor,A=KISSY,r=q.TripleButton;q.Preview||function(){function v(B){this.editor=B;this._init()}A.augment(v,{_init:function(){this.el=new r({container:this.editor.toolBarDiv,cls:"ke-tool-editor-source",title:"\u9884\u89c8",contentCls:"ke-toolbar-preview"});this.el.on("offClick",this._show,this)},_show:function(){var B=this.editor,n=640,t=420,i=80;try{var e=window.screen;n=Math.round(e.width*0.8);t=Math.round(e.height*0.7);i=Math.round(e.width*0.1)}catch(j){}B=
B._prepareIFrameHtml().replace(/<body[^>]+>.+<\/body>/,"<body>\n"+B.getData()+"\n</body>");n=window.open("",null,"toolbar=yes,location=no,status=yes,menubar=yes,scrollbars=yes,resizable=yes,width="+n+",height="+t+",left="+i);n.document.open();n.document.write(B);n.document.close()}});q.Preview=v}();x.addPlugin(function(){new q.Preview(x)})});
KISSY.Editor.add("removeformat",function(x){function q(j){this.editor=j;this._init()}function A(j,l){for(var w=0;w<l.length;w++)j.removeAttr(l[w])}var r=KISSY.Editor,v=KISSY,B=r.RANGE,n=r.ElementPath,t=r.NODE,i=r.TripleButton,e="b,big,code,del,dfn,em,font,i,ins,kbd,q,samp,small,span,strike,strong,sub,sup,tt,u,var";removeFormatAttributes="class,style,lang,width,height,align,hspace,valign".split(",");e=new RegExp("^(?:"+e.replace(/,/g,"|")+")$","i");v.augment(q,{_init:function(){this.el=new i({title:"\u6e05\u9664\u683c\u5f0f",
contentCls:"ke-toolbar-removeformat",container:this.editor.toolBarDiv});this.el.on("offClick",this._remove,this)},_remove:function(){var j=this.editor,l=e,w=removeFormatAttributes;l.lastIndex=0;j.focus();var m=j.getSelection().getRanges();j.fire("save");for(var k=0,s;s=m[k];k++)if(!s.collapsed){s.enlarge(B.ENLARGE_ELEMENT);var a=s.createBookmark(),c=a.startNode,h=a.endNode,d=function(g){for(var p=new n(g),b=p.elements,f=1,o;o=b[f];f++){if(o._4e_equals(p.block)||o._4e_equals(p.blockLimit))break;l.test(o.getName())&&
g.breakParent(o)}};d(c);d(h);for(c=c._4e_nextSourceNode(true,t.NODE_ELEMENT);c;){if(c._4e_equals(h))break;d=c._4e_nextSourceNode(false,t.NODE_ELEMENT);c._4e_name()=="img"&&c.attr("_cke_realelement")||(l.test(c._4e_name())?c._4e_remove(true):A(c,w));c=d}s.moveToBookmark(a)}j.getSelection().selectRanges(m);j.fire("save")}});x.addPlugin(function(){new q(x)})});
KISSY.Editor.add("smiley",function(x){var q=KISSY.Editor,A=KISSY,r=A.DOM,v=A.Event,B=A.Node,n=q.SimpleOverlay,t=q.TripleButton;q.Smiley||function(){function i(l){this.editor=l;this._init()}for(var e="<div class='ke-popup-wrap'><div class='ke-smiley-sprite'>",j=0;j<=98;j++)e+="<a href='#' data-icon='http://a.tbcdn.cn/sys/wangwang/smiley/48x48/"+j+".gif'></a>";e+="</div></div>";A.augment(i,{_init:function(){this.el=new t({contentCls:"ke-toolbar-smiley",title:"\u63d2\u5165\u8868\u60c5",container:this.editor.toolBarDiv});
this.el.on("offClick",this._show,this);q.Utils.lazyRun(this,"_prepare","_real")},_hidePanel:function(l){var w=this;r._4e_ascendant(l.target,function(m){return m[0]===w.el.el[0]})||this.smileyWin.hide()},_selectSmiley:function(l){l.halt();var w=this.editor;l=l.target;var m;if(r._4e_name(l)=="a"&&(m=r.attr(l,"data-icon"))){m=new B("<img src='"+m+"'/>",null,w.document);w.insertElement(m);w.focus();this.smileyWin.hide()}},_prepare:function(){var l=this.editor;this.smileyPanel=new B(e);this.smileyWin=
new n({el:this.smileyPanel,mask:false});document.body.appendChild(this.smileyPanel[0]);this.smileyPanel.on("click",this._selectSmiley,this);v.on(document,"click",this._hidePanel,this);v.on(l.document,"click",this._hidePanel,this)},_real:function(){var l=this.el.el.offset();l.top+=this.el.el.height()+5;if(l.left+this.smileyPanel.width()>r.viewportWidth()-60)l.left=r.viewportWidth()-this.smileyPanel.width()-60;this.smileyWin.show(l)},_show:function(l){this._prepare(l)}});q.Smiley=i}();x.addPlugin(function(){new q.Smiley(x)})});
KISSY.Editor.add("sourcearea",function(x){var q=KISSY.Editor,A=KISSY,r=A.UA,v=q.TripleButton;q.SourceArea||function(){function B(n){this.editor=n;this._init()}A.augment(B,{_init:function(){var n=this.editor;this.el=new v({container:n.toolBarDiv,cls:"ke-tool-editor-source",title:"\u6e90\u7801",contentCls:"ke-toolbar-source"});this.el.on("offClick",this._show,this);this.el.on("onClick",this._hide,this);n.textarea.on("mousedown",function(t){t.stopPropagation()})},_show:function(){var n=this.editor,t=
this.el;n.textarea.val(n.getData());n._showSource();t.set("state",v.ON)},_hide:function(){var n=this.editor,t=n.textarea,i=this.el;n._hideSource();n.setData(t.val());if(r.gecko&&n.iframeFocus){i.el[0].focus();n.focus()}i.set("state",v.OFF)}});q.SourceArea=B}();x.addPlugin(function(){new q.SourceArea(x)})});
KISSY.Editor.add("table",function(x,q){var A=KISSY.Editor,r=KISSY,v=r.Node,B=r.DOM,n=A.Walker,t=r.UA,i=A.NODE,e=A.TripleButton,j=A.SimpleOverlay,l=A.ContextMenu,w=["tr","th","td","tbody","table"],m=r.trim,k;k=(t.ie===6?["table.%2,","table.%2 td, table.%2 th,","{","border : #d3d3d3 1px dotted","}"]:[" table.%2,"," table.%2 > tr > td,  table.%2 > tr > th,"," table.%2 > tbody > tr > td,  table.%2 > tbody > tr > th,"," table.%2 > thead > tr > td,  table.%2 > thead > tr > th,"," table.%2 > tfoot > tr > td,  table.%2 > tfoot > tr > th",
"{","border : #d3d3d3 1px dotted","}"]).join("").replace(/%2/g,"ke_show_border");A.TableUI||function(){function s(y){this.editor=y;this.selectedTable=null;y._toolbars=y._toolbars||{};y._toolbars.table=this;this._init()}function a(y){return m(y).length!=0}function c(y){function D($){if(!(N.length>0))if($[0].nodeType==i.NODE_ELEMENT&&C.test($._4e_name())&&!$._4e_getData("selected_cell")){$._4e_setMarker(M,"selected_cell",true);N.push($)}}for(var G=y.createBookmarks(),J=y.getRanges(),N=[],M={},Q=0;Q<
J.length;Q++){var R=J[Q];if(R.collapsed){R=R.getCommonAncestor();(R=R._4e_ascendant("td",true)||R._4e_ascendant("th",true))&&N.push(R)}else{R=new n(R);var W;for(R.guard=D;W=R.next();)if((W=W.parent())&&C.test(W._4e_name())&&!W._4e_getData("selected_cell")){W._4e_setMarker(M,"selected_cell",true);N.push(W)}}}A.Utils.clearAllMarkers(M);y.selectBookmarks(G);return N}function h(y){y=y.cells;for(var D=0;D<y.length;D++){y[D].innerHTML="";t.ie||(new v(y[D]))._4e_appendBogus()}}function d(y,D){if(y=y.getStartElement()._4e_ascendant("tr")){var G=
y._4e_clone(true);G.insertBefore(y);h(D?G[0]:y[0])}}function g(y){if(y instanceof A.Selection){var D=c(y),G=D.length;y=[];for(var J,N,M=0;M<G;M++){var Q=D[M].parent(),R=Q[0].rowIndex;!M&&(J=R-1);y[R]=Q;M==G-1&&(N=R+1)}M=Q._4e_ascendant("table");J=new v(N<M[0].rows.length&&M[0].rows[N]||J>0&&M[0].rows[J]||M[0].parentNode);for(M=y.length;M>=0;M--)y[M]&&g(y[M]);return J}else if(y instanceof v){M=y._4e_ascendant("table");M[0].rows.length==1?M._4e_remove():y._4e_remove()}return 0}function p(y,D){y=y.getStartElement();
if(y=y._4e_ascendant("td",true)||y._4e_ascendant("th",true))for(var G=y._4e_ascendant("table"),J=y[0].cellIndex,N=0;N<G[0].rows.length;N++){var M=G[0].rows[N];if(!(M.cells.length<J+1)){y=new v(M.cells[J].cloneNode(false));t.ie||y._4e_appendBogus();M=new v(M.cells[J]);D?y.insertBefore(M):y.insertAfter(M)}}}function b(y){var D=[],G=y[0]&&y[0]._4e_ascendant("table"),J,N,M,Q;J=0;for(N=y.length;J<N;J++)D.push(y[J][0].cellIndex);D.sort();J=1;for(N=D.length;J<N;J++)if(D[J]-D[J-1]>1){M=D[J-1]+1;break}M||
(M=D[0]>0?D[0]-1:D[D.length-1]+1);y=G[0].rows;J=0;for(N=y.length;J<N;J++)if(Q=y[J].cells[M])break;return Q?new v(Q):G.previous()}function f(y){if(y instanceof A.Selection){var D=c(y),G=b(D);for(y=D.length-1;y>=0;y--)D[y]&&f(D[y]);return G}else if(y instanceof v){D=y._4e_ascendant("table");if(!D)return null;G=y[0].cellIndex;for(y=D[0].rows.length-1;y>=0;y--){var J=new v(D[0].rows[y]);if(!G&&J[0].cells.length==1)g(J);else J[0].cells[G]&&J[0].removeChild(J[0].cells[G])}}return null}function o(y,D){var G=
new A.Range(y[0].ownerDocument);if(!G.moveToElementEditablePosition(y,D?true:q)){G.selectNodeContents(y);G.collapse(D?false:true)}G.select(true)}var z=A.HtmlDataProcessor,u=z&&z.dataFilter;z=z&&z.htmlFilter;u&&u.addRules({elements:{table:function(y){y=y.attributes;var D=y["class"],G=parseInt(y.border,10);if(!G||G<=0)y["class"]=(D||"")+" ke_show_border"}}});z&&z.addRules({elements:{table:function(y){y=y.attributes;var D=y["class"];if(D)y["class"]=r.trim(D.replace("ke_show_border","").replace(/\s{2}/,
" "))}}});r.augment(s,{_init:function(){var y=this.editor,D={};this.el=new e({contentCls:"ke-toolbar-table",title:"\u8868\u683c",container:y.toolBarDiv});this.el.on("offClick",this._tableShow,this);for(var G in I)(function(J){D[J]=function(){y.fire("save");y.focus();I[J](y);y.fire("save")}})(G);l.register(y.document,{rules:w,width:"120px",funcs:D});A.Utils.lazyRun(this,"_prepareTableShow","_realTableShow")},_tableInit:function(){var y=this,D=y.editor,G=new j({width:"350px",mask:true,title:"\u7f16\u8f91\u8868\u683c"});
G.body.html("<table class='ke-table-config'><tr><td><label>\u884c\u6570\uff1a <input value='2' class='ke-table-rows ke-table-create-only' size='8'/></label></td><td><label>\u5bbd\u5ea6\uff1a <input value='200' class='ke-table-width' size='8'/></label> <select class='ke-table-width-unit'><option value='px'>\u50cf\u7d20</option><option value='%'>\u767e\u5206\u6bd4</option></select></td></tr><tr><td><label>\u5217\u6570\uff1a <input class='ke-table-cols ke-table-create-only' value='3' size='8'/></label></td><td><label>\u9ad8\u5ea6\uff1a <input value='' class='ke-table-height' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td><label>\u5bf9\u9f50\uff1a <select class='ke-table-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option><option value='center'>\u4e2d\u95f4\u5bf9\u9f50</option></select></label></td><td><label>\u95f4\u8ddd\uff1a <input value='1' class='ke-table-cellspacing' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td><label>\u6807\u9898\u683c\uff1a <select class='ke-table-head ke-table-create-only'><option value=''>\u65e0</option><option value='1'>\u6709</option></select></td><td><label>\u8fb9\u8ddd\uff1a <input value='1' class='ke-table-cellpadding' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td></td><td><label>\u8fb9\u6846\uff1a <input value='1' class='ke-table-border' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td colspan='2'><label>\u6807\u9898\uff1a<input class='ke-table-caption' style='width:270px'></label></td></tr></table>");
G.foot.html("<button class='ke-table-ok'>\u786e\u5b9a</button> <button class='ke-table-cancel'>\u53d6\u6d88</button>");G.twidth=G.body.one(".ke-table-width");G.theight=G.body.one(".ke-table-height");G.tcellspacing=G.body.one(".ke-table-cellspacing");G.tcellpadding=G.body.one(".ke-table-cellpadding");G.tborder=G.body.one(".ke-table-border");G.tcaption=G.body.one(".ke-table-caption");G.talign=G.body.one(".ke-table-align");G.trows=G.body.one(".ke-table-rows");G.tcols=G.body.one(".ke-table-cols");G.thead=
G.body.one(".ke-table-head");var J=G.foot.one(".ke-table-ok"),N=G.foot.one(".ke-table-cancel");G.twidthunit=G.body.one(".ke-table-width-unit");y.tableDialog=G;J.on("click",y._tableOk,y);G.on("hide",function(){y.selectedTable=null;D.focus()});N.on("click",function(){G.hide()})},_tableOk:function(){this.selectedTable?this._modifyTable():this._genTable()},_modifyTable:function(){var y=this.tableDialog,D=this.selectedTable,G=D.one("caption");a(y.talign.val())&&D.attr("align",m(y.talign.val()));a(y.tcellspacing.val())&&
D.attr("cellspacing",m(y.tcellspacing.val()));a(y.tcellpadding.val())&&D.attr("cellpadding",m(y.tcellpadding.val()));a(y.tborder.val())&&D.attr("border",m(y.tborder.val()));!a(y.tborder.val())||y.tborder.val()=="0"?D.addClass("ke_show_border"):D.removeClass("ke_show_border");a(y.twidth.val())&&D.css("width",m(y.twidth.val())+y.twidthunit.val());a(y.theight.val())&&D.css("height",m(y.theight.val()));if(a(y.tcaption.val()))G&&G[0]?G.html(m(y.tcaption.val())):(new v("<caption><span>"+m(y.tcaption.val())+
"</span></caption>")).insertBefore(D[0].firstChild);else G&&G._4e_remove();y.hide()},_genTable:function(){var y=this.tableDialog,D="<table ",G,J=parseInt(y.tcols.val()),N=parseInt(y.trows.val()),M=t.ie?"":"<br/>",Q=this.editor;if(r.trim(y.talign.val()).length!=0)D+="align='"+r.trim(y.talign.val())+"' ";if(r.trim(y.tcellspacing.val()).length!=0)D+="cellspacing='"+r.trim(y.tcellspacing.val())+"' ";if(r.trim(y.tcellpadding.val()).length!=0)D+="cellpadding='"+r.trim(y.tcellpadding.val())+"' ";if(r.trim(y.tborder.val()).length!=
0)D+="border='"+r.trim(y.tborder.val())+"' ";if(r.trim(y.twidth.val()).length!=0||r.trim(y.theight.val()).length!=0){D+="style='";if(r.trim(y.twidth.val()).length!=0)D+="width:"+r.trim(y.twidth.val())+y.twidthunit.val()+";";if(r.trim(y.theight.val()).length!=0)D+="height:"+r.trim(y.theight.val())+"px;";D+="' "}if(r.trim(y.tborder.val()).length==0||r.trim(y.tborder.val())=="0")D+="class='ke_show_border' ";D+=">";if(r.trim(y.tcaption.val()))D+="<caption><span>"+r.trim(y.tcaption.val())+"</span></caption>";
if(y.thead.val()){D+="<thead>";D+="<tr>";for(G=0;G<J;G++)D+="<th>"+M+"</th>";D+="</tr>";D+="</thead>"}D+="<tbody>";for(var R=0;R<N;R++){D+="<tr>";for(G=0;G<J;G++)D+="<td>"+M+"</td>";D+="</tr>"}D+="</tbody>";D+="</table>";D=new v(D,null,Q.document);Q.insertElement(D);y.hide()},_fillTableDialog:function(){var y=this.tableDialog,D=this.selectedTable,G=D.one("caption");y.talign.val(D.attr("align")||"");y.tcellspacing.val(D.attr("cellspacing")||"");y.tcellpadding.val(D.attr("cellpadding")||"");y.tborder.val(D.attr("border")|
"");var J=D._4e_style("width")||"";y.twidth.val(J.replace(/px|%/i,""));J.indexOf("%")!=-1?y.twidthunit.val("%"):y.twidthunit.val("px");y.theight.val((D._4e_style("height")||"").replace(/px|%/i,""));J="";if(G)J=G.text();y.tcaption.val(J);y.trows.val(D.one("tbody").children().length);y.tcols.val(D.one("tr").children().length);y.thead.val(D._4e_first(function(N){return N._4e_name()=="thead"})?"1":"")},_realTableShow:function(){if(this.selectedTable){this._fillTableDialog();this.tableDialog.body.all(".ke-table-create-only").attr("disabled",
"disabled")}else this.tableDialog.body.all(".ke-table-create-only").removeAttr("disabled");this.tableDialog.show()},_prepareTableShow:function(){this._tableInit()},_tableShow:function(){this._prepareTableShow()}});var C=/^(?:td|th)$/,I={"\u8868\u683c\u5c5e\u6027":function(y){var D=y.getSelection();if(D=(D=D&&D.getStartElement())&&D._4e_ascendant("table",true)){y=y._toolbars.table;y.selectedTable=D;y._tableShow()}},"\u5220\u9664\u8868\u683c":function(y){var D=(y=y.getSelection())&&y.getStartElement();
if(D=D&&D._4e_ascendant("table",true)){y.selectElement(D);var G=y.getRanges()[0];G.collapse();y.selectRanges([G]);y=D.parent();y[0].childNodes.length==1&&y._4e_name()!="body"?y._4e_remove():D._4e_remove()}},"\u5220\u9664\u884c":function(y){y=y.getSelection();o(g(y),q)},"\u5220\u9664\u5217":function(y){y=y.getSelection();(y=f(y))&&o(y,true)},"\u5728\u4e0a\u65b9\u63d2\u5165\u884c":function(y){y=y.getSelection();d(y,true)},"\u5728\u4e0b\u65b9\u63d2\u5165\u884c":function(y){y=y.getSelection();d(y,q)},
"\u5728\u5de6\u4fa7\u63d2\u5165\u5217":function(y){y=y.getSelection();p(y,true)},"\u5728\u53f3\u4fa7\u63d2\u5165\u5217":function(y){y=y.getSelection();p(y,q)}};A.TableUI=s}();x.addPlugin(function(){var s=x.document;new A.TableUI(x);var a=B.create("<style>",null,s);s.getElementsByTagName("head")[0].appendChild(a);if(a.styleSheet)a.styleSheet.cssText=k;else a.appendChild(s.createTextNode(k))})});
KISSY.Editor.add("templates",function(x){var q=KISSY.Editor,A=KISSY,r=A.Node,v=q.TripleButton,B=q.SimpleOverlay;q.TplUI||function(){function n(t){this.editor=t;this._init()}A.augment(n,{_init:function(){(new v({container:this.editor.toolBarDiv,contentCls:"ke-toolbar-template",title:"\u6a21\u677f"})).on("click",this._show,this);q.Utils.lazyRun(this,"_prepare","_real")},_prepare:function(){for(var t=this.editor,i=t.cfg.pluginConfig.templates,e="<div class='ke-tpl'>",j=0;j<i.length;j++)e+="<a href='javascript:void(0)' class='ke-tpl-list' tabIndex='-1'>"+
i[j].demo+"</a>";e+="</div>";this._initDialogOk=true;var l=new B({mask:true,title:"\u5185\u5bb9\u6a21\u677f"});l.body.html(e);e=l.body.all(".ke-tpl-list");l.on("hide",function(){t.focus()});e.on("click",function(w){w.halt();w=(new r(w.target))._4e_index();w!=-1&&t.insertHtml(i[w].html);l.hide()});this.ui=l},_real:function(){this.ui.show()},_show:function(){this._prepare()}});q.TplUI=n}();x.addPlugin(function(){new q.TplUI(x)})});
KISSY.Editor.add("undo",function(x){var q=KISSY.Editor,A=KISSY,r=q.Utils.arrayCompare,v=A.UA,B=A.Event;q.UndoManager||function(){function n(k){var s=k._getRawData();k=s&&k.getSelection();this.contents=s;this.bookmarks=k&&k.createBookmarks2(true)}function t(k,s,a){this.s=k;this.fn=s;this.scope=a||window;this.bufferTimer=null}function i(k){this.history=[];this.index=0;this.editor=k;this.bufferTimer=new t(500,this.save,this);this._init()}function e(k,s,a,c){this.editor=k;this.title=a;this.text=s;this.contentCls=
c;this._init()}A.augment(n,{equals:function(k){if(this.contents!=k.contents)return false;var s=this.bookmarks;k=k.bookmarks;if(s||k){if(!s||!k||s.length!=k.length)return false;for(var a=0;a<s.length;a++){var c=s[a],h=k[a];if(c.startOffset!=h.startOffset||c.endOffset!=h.endOffset||!r(c.start,h.start)||!r(c.end,h.end))return false}}return true}});A.augment(t,{run:function(){if(this.bufferTimer){clearTimeout(this.bufferTimer);this.bufferTimer=null}var k=this;this.bufferTimer=setTimeout(function(){k.fn.call(k.scope)},
this.s)}});var j={16:1,17:1,18:1},l={37:1,38:1,39:1,40:1};A.augment(i,{_keyMonitor:function(){var k=this.editor;B.on(k.document,"keydown",function(s){var a=s.keyCode;if(!(a in l||a in j))if(a===90&&(s.ctrlKey||s.metaKey)){k.fire("restore",{d:-1});s.halt()}else if(a===89&&(s.ctrlKey||s.metaKey)){k.fire("restore",{d:1});s.halt()}else k.fire("save",{buffer:1})})},_init:function(){var k=this,s=k.editor;s.on("save",function(a){a.buffer?k.bufferTimer.run():k.save()});s.on("restore",this.restore,this);k._keyMonitor()},
save:function(){this.history.length>this.index+1&&this.history.splice(this.index+1,this.history.length-this.index-1);var k=this.editor,s=this.history.length>0?this.history[this.history.length-1]:null,a=new n(this.editor);if(!s||!s.equals(a)){this.history.length===30&&this.history.shift();this.history.push(a);this.index=this.history.length-1;k.fire("afterSave",{history:this.history,index:this.index})}},restore:function(k){k=k.d;var s=this.editor,a=this.history.length>0?this.history[this.index+k]:null;
if(a){s._setRawData(a.contents);if(a.bookmarks)this.editor.getSelection().selectBookmarks(a.bookmarks);else if(v.ie){a=this.editor.document.body.createTextRange();a.collapse(true);a.select()}this.index+=k;s.fire("afterRestore",{history:this.history,index:this.index})}}});var w=q.TripleButton,m={redo:1,undo:-1};A.augment(e,{_init:function(){var k=this,s=k.editor;k.el=new w({contentCls:k.contentCls,title:k.title,container:s.toolBarDiv});this.el.set("state",w.DISABLED);s.on("afterSave",this._respond,
this);s.on("afterRestore",this._respond,this);k.el.on("offClick",function(){s.fire("restore",{d:m[k.text]})})},_respond:function(k){this.updateUI(k.history,k.index)},updateUI:function(k,s){if(this.text=="undo")s>0&&k.length>0?this.el.set("state",w.OFF):this.el.set("state",w.DISABLED);else if(this.text=="redo")s<k.length-1?this.el.set("state",w.OFF):this.el.set("state",w.DISABLED)}});q.UndoManager=i;q.RestoreUI=e}();x.addPlugin(function(){new q.UndoManager(x);new q.RestoreUI(x,"undo","\u64a4\u9500",
"ke-toolbar-undo");new q.RestoreUI(x,"redo","\u91cd\u505a","ke-toolbar-redo")})});
