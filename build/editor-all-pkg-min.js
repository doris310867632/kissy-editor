KISSY.add("editor",function(y,q){function B(j,a){var b=this;if(!(b instanceof B))return new B(j,a);if(y.isString(j))j=y.one(j);j[0]||(j=new Node(j));b.cfg=a;y.app(b,y.EventTarget);b.use=function(g){y.use.call(b,g,function(){b.on("dataReady",function(){b.setData(j.val())})},{order:true,global:B})};b.init(j);return q}function r(j){if(!t)return"build/"+j.replace(/\.(js|css)/i,"-min.$1");if(t==="dev")return j;return"build/"+j}y.app(B,y.EventTarget);B.Config.base=y.Config.base+"editor/";var t=y.Config.debug,
v={htmlparser:{attach:false,path:r("plugins/htmldataprocessor/htmlparser/htmlparser.js")}},s=["utils","focusmanager","definition","dtd","dom","elementpath","walker","range","domiterator","selection","styles"],z=["clipboard",{name:"color",useCss:true},{name:"elementpaths",useCss:true},"enterkey","fakeobjects",{name:"flash",requires:["contextmenu","fakeobjects","overlay"]},"font","format",{name:"htmldataprocessor",requires:["htmlparser-text"]},{name:"image",requires:["overlay"]},"indent","justify",
"link","list","maximize","music","preview","removeformat",{name:"smiley",useCss:true},"sourcearea",{name:"table",useCss:true,requires:["overlay","contextmenu"]},{name:"templates",requires:["overlay"],useCss:true},"undo"],f=[{name:"htmlparser-basicwriter",requires:["htmlparser"]},{name:"htmlparser-element",requires:["htmlparser-fragment"]},{name:"htmlparser-filter",requires:["htmlparser-element"]},{name:"htmlparser-fragment",requires:["htmlparser-htmlwriter"]},{name:"htmlparser-htmlwriter",requires:["htmlparser-basicwriter"]},
{name:"htmlparser-text",requires:["htmlparser-filter"]}],h=[{name:"button"},{name:"overlay",useCss:true},{name:"contextmenu",requires:["overlay"],useCss:true}],k,l,u,m,o;k=0;for(l=h.length;k<l;k++){m=u=h[k];o=q;if(!y.isString(u)){o=u.requires;m=u.name}v[m]={attach:false,requires:o,path:r("ui/"+m+".js"),csspath:u.useCss?r("ui/"+m+".css"):""}}k=0;for(l=z.length;k<l;k++){m=u=z[k];o=["button"];if(!y.isString(u)){u.requires&&(o=o.concat(u.requires));m=u.name}v[m]={attach:false,requires:o,csspath:u.useCss?
r("plugins/"+m+"/plugin.css"):q,path:r("plugins/"+m+"/plugin.js")}}k=0;for(l=f.length;k<l;k++){u=f[k];o=q;if(!y.isString(u)){o=u.requires;u=u.name}v[u]={attach:false,requires:o,path:r("plugins/htmldataprocessor/htmlparser/"+u.substring(11)+".js")}}B.add(v);v={};k=0;for(l=s.length;k<l;k++){u=s[k];v[u]={host:"editor",requires:k>0?s[k-1]:[]}}B.add(v);y.Editor=B});
KISSY.Editor.add("utils",function(y){var q=KISSY,B=q.Node,r=q.DOM,t=q.Config.debug;y.Utils={debugUrl:function(v){if(!t)return"build/"+v.replace(/\.(js|css)/i,"-min.$1");if(t==="dev")return v;return"build/"+v},lazyRun:function(v,s,z){var f=v[s],h=v[z];v[s]=function(){f.apply(this,arguments);v[s]=v[z];return h.apply(this,arguments)}},getXY:function(v,s,z,f){z=z.defaultView||z.parentWindow;v-=r.scrollLeft(z);s-=r.scrollTop(z);if(f)if(z!=(f.defaultView||f.parentWindow)&&z.frameElement){f=r._4e_getOffset(z.frameElement,
f);v+=f.left;s+=f.top}return{left:v,top:s}},tryThese:function(){for(var v,s=0,z=arguments.length;s<z;s++){var f=arguments[s];try{v=f();break}catch(h){}}return v},arrayCompare:function(v,s){if(!v&&!s)return true;if(!v||!s||v.length!=s.length)return false;for(var z=0;z<v.length;z++)if(v[z]!==s[z])return false;return true},getByAddress:function(v,s,z){v=v.documentElement;for(var f=0;v&&f<s.length;f++){var h=s[f];if(z)for(var k=-1,l=0;l<v.childNodes.length;l++){var u=v.childNodes[l];if(!(z===true&&u.nodeType==
3&&u.previousSibling&&u.previousSibling.nodeType==3)){k++;if(k==h){v=u;break}}}else v=v.childNodes[h]}return v?new B(v):null},clearAllMarkers:function(v){for(var s in v)v[s]._4e_clearMarkers(v,true)},htmlEncodeAttr:function(v){return v.replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/,"&gt;")},ltrim:function(v){return v.replace(/^\s+/,"")},rtrim:function(v){return v.replace(/\s+$/,"")},trim:function(v){return this.ltrim(this.rtrim(v))},mix:function(){for(var v={},s=0;s<arguments.length;s++)v=
q.mix(v,arguments[s]);return v}}});KISSY.Editor.add("focusmanager",function(y){function q(){this.iframeFocus=true}function B(){this.iframeFocus=false}var r=KISSY,t=r.DOM,v=r.Event;r={};var s={};r.add=function(z){s[z._UUID]=z;var f=t._4e_getWin(z.document);v.on(f,"focus",q,z);v.on(f,"blur",B,z)};r.remove=function(z){delete s[z._UUID];var f=t._4e_getWin(z.document);v.remove(f,"focus",q,z);v.remove(f,"blur",B,z)};y.focusManager=r});
KISSY.Editor.add("definition",function(y){function q(){return h+"<html><head><title>kissy-editor</title><link href='"+y.Config.base+k+"' rel='stylesheet'/></head><body class='ke-editor'>&nbsp;</body><html>"}var B=KISSY,r=B.UA,t=B.DOM,v=B.Node,s=B.Event,z=y.focusManager,f=y.Utils.tryThese,h="<!doctype html>",k=y.Utils.debugUrl("assets/editor-iframe.css"),l=1,u="<div  class='ke-editor-wrap'  onmousedown='if((event.target||event.srcElement).nodeName.toLowerCase()!=\"select\")return false;'  > <div class='"+
".ke-editor-tools".substring(1)+"'></div><div class='"+".ke-textarea-wrap".substring(1)+'\'><iframe  style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor"  src="'+(r.ie?"javascript:void(function(){"+encodeURIComponent("document.open();document.close();")+"}())":"")+'"  tabIndex="'+(r.webkit?-1:"$(tabIndex)")+'"  allowTransparency="true" ></iframe></div><div class=\''+".ke-editor-status".substring(1)+"'></div></div>";B.augment(y,{init:function(m){var o=
this,j=new v(u.replace(/\$\(tabIndex\)/,m.attr("tabIndex")));o.editorWrap=j;o._UUID=l++;o.wrap=j.one(".ke-textarea-wrap");o.iframe=o.wrap.one("iframe");o.toolBarDiv=j.one(".ke-editor-tools");o.textarea=m;o.statusDiv=j.one(".ke-editor-status");o.toolBarDiv._4e_unselectable();o._commands={};o._plugins={};var a=m._4e_style("width"),b=m._4e_style("height");if(a){j.css("width",a);m.css("width","100%")}o.textarea.css("display","none");j.insertAfter(m);o.wrap[0].appendChild(m[0]);if(b){o.wrap.css("height",
b);m.css("height","100%")}m=o.iframe;o.on("dataReady",function(){o.ready=true;y.fire("instanceCreated",{editor:o})});r.gecko?m.on("load",o._initIFrame,o):o._initIFrame()},addCommand:function(m,o){this._commands[m]=o},execCommand:function(m){this.fire("save");this._commands[m].exec(this);this.fire("save")},getData:function(){if(y.HtmlDataProcessor)return y.HtmlDataProcessor.toHtml(this.document.body.innerHTML,"p");return this.document.body.innerHTML},setData:function(m){if(y.HtmlDataProcessor)m=y.HtmlDataProcessor.toDataFormat(m,
"p");this.document.body.innerHTML=m},sync:function(){this.textarea.val(this.getData())},_getRawData:function(){return this.document.body.innerHTML},_setRawData:function(m){this.document.body.innerHTML=m},_hideSource:function(){this.iframe.css("display","");this.textarea.css("display","none");this.toolBarDiv.children().css("visibility","");this.statusDiv.children().css("visibility","")},_showSource:function(){this.textarea.css("display","");this.iframe.css("display","none");this.toolBarDiv.children().css("visibility",
"hidden");this.toolBarDiv.all(".ke-tool-editor-source").css("visibility","");this.statusDiv.children().css("visibility","hidden");r.ie<8&&this.textarea.css("height",this.wrap.css("height"))},_prepareIFrameHtml:q,getSelection:function(){var m=new y.Selection(this.document);return!m||m.isInvalid?null:m},focus:function(){var m=t._4e_getWin(this.document);r.webkit&&m&&m.parent&&m.parent.focus();m&&m.focus();this.document&&this.document.body.focus();this.notifySelectionChange()},blur:function(){t._4e_getWin(this.document).blur();
this.document&&this.document.body.blur()},_initIFrame:function(){function m(w){f(function(){d.designMode="on";setTimeout(function(){d.designMode="off";i.focus();if(!arguments.callee.retry)arguments.callee.retry=true},50)},function(){d.designMode="off";t.attr(i,"contentEditable",false);t.attr(i,"contentEditable",true);!w&&m(1)})}var o=this,j=o.iframe,a=o.textarea[0],b=q(),g=j[0].contentWindow,d=g.document;o.document=d;j.detach();d.open("text/html","replace");d.write(b);d.close();var i=d.body;if(r.ie){i.hideFocus=
true;i.disabled=true;i.contentEditable=true;i.removeAttribute("disabled")}else setTimeout(function(){if(r.gecko||r.opera)i.contentEditable=true;else if(r.webkit)i.parentNode.contentEditable=true;else d.designMode="on"},0);try{d.execCommand("enableObjectResizing",false,true)}catch(p){}try{d.execCommand("enableInlineTableEditing",false,true)}catch(c){}r.webkit&&s.on(d,"mousedown",function(w){w=new v(w.target);B.inArray(w._4e_name(),["img","hr","input","textarea","select"])&&o.getSelection().selectElement(w)});
if(r.webkit){s.on(d,"click",function(w){var C=new v(w.target);B.inArray(C._4e_name(),["input","select"])&&w.preventDefault()});s.on(d,"mouseup",function(w){var C=new v(w.target);B.inArray(C._4e_name(),["input","textarea"])&&w.preventDefault()})}if(r.gecko||r.ie||r.opera){var e;e=new v(t.insertAfter((new v('<span style="position:absolute; left:-10000"></span>'))[0],a));e.on("focus",function(){o.focus()});o.on("destroy",function(){})}if(r.ie&&d.compatMode=="CSS1Compat"||r.gecko||r.opera){var n=new v(d.documentElement);
n.on("mousedown",function(w){if(w.target===n[0]){r.gecko&&m(false);e[0].focus()}})}s.on(g,"focus",function(){if(r.gecko)m(false);else r.opera&&i.focus();o.notifySelectionChange()});r.gecko&&s.on(o.document,"mousedown",function(){o.iframeFocus||m(false)});if(r.ie){s.on(d,"keydown",function(w){if(w.keyCode in{8:1,46:1}){var C=o.getSelection(),I=C.getSelectedElement();if(I){o.fire("save");var x=C.getRanges()[0].createBookmark();I.remove();C.selectBookmarks([x]);o.fire("save");w.preventDefault()}}});
if(d.compatMode=="CSS1Compat"){var A={33:1,34:1};s.on(d,"keydown",function(w){w.keyCode in A&&setTimeout(function(){o.getSelection().scrollIntoView()},0)})}}setTimeout(function(){r.ie&&setTimeout(function(){if(d){i.runtimeStyle.marginBottom="0px";i.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){o.fire("dataReady")},10);z.add(o)},addPlugin:function(m){this.ready?m():this.on("dataReady",m)},_monitor:function(){var m=this;m._monitorId&&clearTimeout(m._monitorId);m._monitorId=setTimeout(function(){var o=
m.getSelection();if(o&&!o.isInvalid){o=o.getStartElement();var j=new y.ElementPath(o);if(!m.previousPath||!m.previousPath.compare(j)){m.previousPath=j;m.fire("selectionChange",{selection:m,path:j,element:o})}}},200)},notifySelectionChange:function(){this.previousPath=null;this._monitor()},insertElement:function(m){var o=this;o.focus();var j=m._4e_name(),a=y.XHTML_DTD,b=y.RANGE,g=y.NODE,d=a.$block[j],i=o.getSelection(),p=i.getRanges(),c,e,n,A,w;o.fire("save");for(var C=p.length-1;C>=0;C--){c=p[C];
c.deleteContents();e=!C&&m||m._4e_clone(true);if(d)for(;(A=c.getCommonAncestor(false,true))&&(w=a[A._4e_name()])&&!(w&&w[j]);)if(A._4e_name()in a.span)c.splitElement(A);else if(c.checkStartOfBlock()&&c.checkEndOfBlock()){c.setStartBefore(A);c.collapse(true);A.remove()}else c.splitBlock();c.insertNode(e);n||(n=e)}c.moveToPosition(n,b.POSITION_AFTER_END);(m=n._4e_nextSourceNode(true))&&m.type==g.NODE_ELEMENT&&c.moveToElementEditablePosition(m);i.selectRanges([c]);o.focus();e&&e._4e_scrollIntoView();
setTimeout(function(){o.fire("save")},10)},insertHtml:function(m){if(y.HtmlDataProcessor)m=y.HtmlDataProcessor.toDataFormat(m);if(r.webkit){m=t.create(m,null,this.document);m=m.nodeType==11?B.makeArray(m.childNodes):[m];for(var o=0;o<m.length;o++)this.insertElement(new v(m[o]))}else{var j=this;j.focus();j.fire("save");o=j.getSelection();if(r.ie){o=o.getNative();o.type=="Control"&&o.clear();o.createRange().pasteHTML(m)}else j.document.execCommand("inserthtml",false,m);j.focus();setTimeout(function(){j.fire("save")},
10)}}})});
KISSY.Editor.add("dtd",function(y){y.XHTML_DTD=function(){var q=function(p){for(var c=arguments.length-1;c>0;)KISSY.mix(p,arguments[c--]);return p},B={isindex:1,fieldset:1},r={input:1,button:1,select:1,textarea:1,label:1},t=q({a:1},r),v=q({iframe:1},t),s={hr:1,ul:1,menu:1,div:1,blockquote:1,noscript:1,table:1,center:1,address:1,dir:1,pre:1,h5:1,dl:1,h4:1,noframes:1,h6:1,ol:1,h1:1,h3:1,h2:1},z={ins:1,del:1,script:1,style:1},f=q({b:1,acronym:1,bdo:1,"var":1,"#":1,abbr:1,code:1,br:1,i:1,cite:1,kbd:1,
u:1,strike:1,s:1,tt:1,strong:1,q:1,samp:1,em:1,dfn:1,span:1},z),h=q({sub:1,img:1,object:1,sup:1,basefont:1,map:1,applet:1,font:1,big:1,small:1},f),k=q({p:1},h);r=q({iframe:1},h,r);h={img:1,noscript:1,br:1,kbd:1,center:1,button:1,basefont:1,h5:1,h4:1,samp:1,h6:1,ol:1,h1:1,h3:1,h2:1,form:1,font:1,"#":1,select:1,menu:1,ins:1,abbr:1,label:1,code:1,table:1,script:1,cite:1,input:1,iframe:1,strong:1,textarea:1,noframes:1,big:1,small:1,span:1,hr:1,sub:1,bdo:1,"var":1,div:1,object:1,sup:1,strike:1,dir:1,map:1,
dl:1,applet:1,del:1,isindex:1,fieldset:1,ul:1,b:1,acronym:1,a:1,blockquote:1,i:1,u:1,s:1,tt:1,address:1,q:1,pre:1,p:1,em:1,dfn:1};var l=q({a:1},r),u={tr:1},m={"#":1},o=q({param:1},h),j=q({form:1},B,v,s,k),a={li:1},b={base:1,link:1,meta:1,title:1},g=q(b,{style:1,script:1}),d={head:1,body:1},i={address:1,blockquote:1,center:1,dir:1,div:1,dl:1,fieldset:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,isindex:1,menu:1,noframes:1,ol:1,p:1,pre:1,table:1,ul:1};return{$nonBodyContent:q({html:1},d,b),$block:i,
$blockLimit:{body:1,div:1,td:1,th:1,caption:1,form:1},$inline:l,$body:q({script:1,style:1},i),$cdata:{script:1,style:1},$empty:{area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},$listItem:{dd:1,dt:1,li:1},$list:{ul:1,ol:1,dl:1},$nonEditable:{applet:1,button:1,embed:1,iframe:1,map:1,object:1,option:1,script:1,textarea:1,param:1},$removeEmpty:{abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},$tabIndex:{a:1,area:1,button:1,input:1,object:1,select:1,textarea:1},$tableContent:{caption:1,col:1,colgroup:1,tbody:1,td:1,tfoot:1,th:1,thead:1,tr:1},html:d,head:g,style:m,body:j,base:{},link:{},meta:{},title:m,col:{},tr:{td:1,th:1},img:{},colgroup:{col:1},noscript:j,td:j,br:{},th:j,center:j,kbd:l,button:q(k,s),basefont:{},h5:l,h4:l,samp:l,h6:l,ol:a,h1:l,h3:l,option:m,h2:l,form:q(B,v,s,k),select:{optgroup:1,option:1},font:l,ins:l,menu:a,abbr:l,label:l,table:{thead:1,
col:1,tbody:1,tr:1,colgroup:1,caption:1,tfoot:1},code:l,script:m,tfoot:u,cite:l,li:j,input:{},iframe:j,strong:l,textarea:m,noframes:j,big:l,small:l,span:l,hr:{},dt:l,sub:l,optgroup:{option:1},param:{},bdo:l,"var":l,div:j,object:o,sup:l,dd:j,strike:l,area:{},dir:a,map:q({area:1,form:1,p:1},B,z,s),applet:o,dl:{dt:1,dd:1},del:l,isindex:{},fieldset:q({legend:1},h),thead:u,ul:a,acronym:l,b:l,a:r,blockquote:j,caption:l,i:l,u:l,tbody:u,s:l,address:q(v,k),tt:l,legend:l,q:l,pre:q(f,t),p:l,em:l,dfn:l}}()});
KISSY.Editor.add("dom",function(y){function q(a){return a.replace(/-(\w)/g,function(b,g){return g.toUpperCase()})}var B=KISSY,r=B.DOM,t=B.UA,v=B.Node,s=y.Utils,z={abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};y.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_DOCUMENT_FRAGMENT:11};y.POSITION={};var f=y.NODE,h=y.POSITION;h.POSITION_IDENTICAL=0;h.POSITION_DISCONNECTED=1;h.POSITION_FOLLOWING=
2;h.POSITION_PRECEDING=4;h.POSITION_IS_CONTAINED=8;h.POSITION_CONTAINS=16;var k={},l={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},u={hr:1},m=function(a){return a[0]||a},o=function(a){if(!a[0])return new v(a);return a},j={_4e_equals:function(a,b){if(!a&&!b)return true;if(!a||!b)return false;a=m(a);b=m(b);return a===b},_4e_isBlockBoundary:function(a,b){a=o(a);b=
B.mix(B.mix({},u),b||{});return l[a.css("display")]||b[a._4e_name()]},_4e_getWin:function(a){return a&&"scrollTo"in a&&a.document?a:a&&a.nodeType===9?a.defaultView||a.parentWindow:false},_4e_index:function(a){a=m(a);for(var b=a.parentNode.childNodes,g=0;g<b.length;g++)if(b[g]===a)return g;return-1},_4e_first:function(a,b){a=m(a);if((a=(a=a.firstChild)&&new v(a))&&b&&!b(a))a=a._4e_next(b);return a},_4e_move:function(a,b,g){a.remove();a=m(a);b=m(b);g?b.insertBefore(a,b.firstChild):b.appendChild(a)},
_4e_name:function(a){a=m(a);var b=a.nodeName.toLowerCase();if(t.ie)if((a=a.scopeName)&&a!="HTML")b=a.toLowerCase()+":"+b;return b},_4e_isIdentical:function(a,b){if(a._4e_name()!=b._4e_name())return false;var g=a[0].attributes,d=b[0].attributes,i=g.length,p=d.length;if(!t.ie&&i!=p)return false;for(var c=0;c<i;c++){var e=g[c];if((!t.ie||e.specified&&e.nodeName!="_ke_expando")&&e.nodeValue!=b.attr(e.nodeName))return false}if(t.ie)for(c=0;c<p;c++){e=d[c];if(e.specified&&e.nodeName!="_ke_expando"&&e.nodeValue!=
a.attr(e.nodeName))return false}return true},_4e_isEmptyInlineRemoveable:function(a){a=m(a).childNodes;for(var b=0,g=a.length;b<g;b++){var d=a[b],i=d.nodeType;if(!(i==f.NODE_ELEMENT&&d.getAttribute("_ke_bookmark")))if(i==f.NODE_ELEMENT&&!j._4e_isEmptyInlineRemoveable(d)||i==f.NODE_TEXT&&B.trim(d.nodeValue))return false}return true},_4e_moveChildren:function(a,b,g){a=m(a);b=b[0]||b;if(a!=b)if(g)for(;g=a.lastChild;)b.insertBefore(a.removeChild(g),b.firstChild);else for(;g=a.firstChild;)b.appendChild(a.removeChild(g))},
_4e_mergeSiblings:function(){function a(b,g,d){if(g[0]&&g[0].nodeType==f.NODE_ELEMENT){for(var i=[];g.attr("_ke_bookmark")||g._4e_isEmptyInlineRemoveable();){i.push(g);g=d?new v(g[0].nextSibling):new v(g[0].previousSibling);if(!g[0]||g[0].nodeType!=f.NODE_ELEMENT)return}if(b._4e_isIdentical(g)){for(var p=d?b[0].lastChild:b[0].firstChild;i.length;)i.shift()._4e_move(b,!d);g._4e_moveChildren(b,!d);g.remove();p[0]&&p[0].nodeType==f.NODE_ELEMENT&&p._4e_mergeSiblings()}}}return function(b){if(b[0])if(z[b._4e_name()]||
b._4e_name()=="a"){a(b,new v(b[0].nextSibling),true);a(b,new v(b[0].previousSibling))}}}(),_4e_unselectable:t.gecko?function(a){a=m(a);a.style.MozUserSelect="none"}:t.webkit?function(a){a=m(a);a.style.KhtmlUserSelect="none"}:function(a){a=m(a);if(t.ie||t.opera){var b,g=0;for(a.unselectable="on";b=a.all[g++];)switch(b.tagName.toLowerCase()){case "iframe":case "textarea":case "input":case "select":break;default:b.unselectable="on"}}},_4e_getOffset:function(a,b){a=m(a);var g,d=0;g=0;var i=a.ownerDocument.defaultView||
a.ownerDocument.parentWindow,p=a.ownerDocument,c=p.documentElement;if(a.getBoundingClientRect){if(a!==p.body&&c!==a){g=a.getBoundingClientRect();d=g.left+r.scrollLeft(i);g=g.top+r.scrollTop(i)}if(b)if(i!=(b.defaultView||b.parentWindow)&&i.frameElement){b=j._4e_getOffset(i.frameElement,b);d+=b.left;g+=b.top}}return{left:d,top:g}},_4e_getFrameDocument:function(a){return(a=m(a))&&a.contentWindow.document},_4e_splitText:function(a,b){a=m(a);var g=a.ownerDocument;if(!(!a||a.nodeType!=f.NODE_TEXT)){if(t.ie&&
b==a.nodeValue.length){g=g.createTextNode("");r.insertAfter(g,a);return g}a=new v(a.splitText(b));if(t.ie==8){g=g.createTextNode("");r.insertAfter(g,a[0]);g.parentNode.removeChild(g)}return a}},_4e_parents:function(a,b){a=o(a);var g=[];do g[b?"push":"unshift"](a);while(a=a.parent());return g},_4e_clone:function(a,b,g){a=m(a);a=a.cloneNode(b);if(!g){var d=function(i){if(i.nodeType==f.NODE_ELEMENT){i.removeAttribute("id",false);i.removeAttribute("_ke_expando",false);i=i.childNodes;for(var p=0;p<i.length;p++)d(i[p])}};
d(a)}return new v(a)},_4e_nextSourceNode:function(a,b,g,d){a=m(a);if(d&&!d.call){var i=d[0]||d;d=function(c){c=c[0]||c;return c!==i}}b=!b&&a.firstChild;var p=new v(a);if(!b){if(a.nodeType==f.NODE_ELEMENT&&d&&d(this,true)===false)return null;b=a.nextSibling}for(;!b&&(p=p.parent());){if(d&&d(p,true)===false)return null;b=p[0].nextSibling}if(!b)return null;b=new v(b);if(d&&d(b)===false)return null;if(g&&g!=b[0].nodeType)return b._4e_nextSourceNode(false,g,d);return b},_4e_previousSourceNode:function(a,
b,g,d){a=m(a);if(d&&!d.call){var i=d[0]||d;d=function(c){c=c[0]||c;return c!==i}}b=!b&&a.lastChild;var p=new v(a);if(!b){if(a.nodeType==f.NODE_ELEMENT&&d&&d(a,true)===false)return null;b=a.previousSibling}for(;!b&&(p=p.parent());){if(d&&d(p,true)===false)return null;b=p[0].previousSibling}if(!b)return null;b=new v(b);if(d&&d(b)===false)return null;if(g&&b[0].nodeType!=g)return b._4e_previousSourceNode(false,g,d);return b},_4e_contains:t.ie||t.webkit?function(a,b){a=m(a);b=m(b);return b.nodeType!=
f.NODE_ELEMENT?a.contains(b.parentNode):a!=b&&a.contains(b)}:function(a,b){a=m(a);b=m(b);return!!(a.compareDocumentPosition(b)&16)},_4e_commonAncestor:function(a,b){if(a._4e_equals(b))return a;if(b[0].nodeType!=f.NODE_TEXT&&b._4e_contains(a))return b;a=a[0].nodeType==f.NODE_TEXT?a.parent():a;do if(a[0].nodeType!=f.NODE_TEXT&&a._4e_contains(b))return a;while(a=a.parent());return null},_4e_ascendant:function(a,b,g){a=m(a);if(!g)a=a.parentNode;if(b&&!B.isFunction(b)){var d=b;b=function(i){return i._4e_name()==
d}}for(;a&&a.nodeType!=9;){if(!b||b(new v(a))===true)return new v(a);a=a.parentNode}return null},_4e_hasAttribute:function(a,b){a=m(a);a=a.attributes.getNamedItem(b);return!!(a&&a.specified)},_4e_hasAttributes:t.ie?function(a){a=m(a);for(var b=a.attributes,g=0;g<b.length;g++){var d=b[g];switch(d.nodeName){case "class":if(a.getAttribute("class"))return true;break;case "_ke_expando":continue;default:if(d.specified)return true}}return false}:function(a){a=m(a);t.gecko&&a.removeAttribute("_moz_dirty");
a=a.attributes;return a.length>1||a.length==1&&a[0].nodeName!="_ke_expando"},_4e_position:function(a,b){var g=m(a),d=m(b);if(g.compareDocumentPosition)return g.compareDocumentPosition(d);if(g==d)return h.POSITION_IDENTICAL;if(g.nodeType==f.NODE_ELEMENT&&d.nodeType==f.NODE_ELEMENT){if(g.contains){if(g.contains(d))return h.POSITION_CONTAINS+h.POSITION_PRECEDING;if(d.contains(g))return h.POSITION_IS_CONTAINED+h.POSITION_FOLLOWING}if("sourceIndex"in g)return g.sourceIndex<0||d.sourceIndex<0?h.POSITION_DISCONNECTED:
g.sourceIndex<d.sourceIndex?h.POSITION_PRECEDING:h.POSITION_FOLLOWING}a=a._4e_address();b=b._4e_address();g=Math.min(a.length,b.length);for(d=0;d<=g-1;d++)if(a[d]!=b[d]){if(d<g)return a[d]<b[d]?h.POSITION_PRECEDING:h.POSITION_FOLLOWING;break}return a.length<b.length?h.POSITION_CONTAINS+h.POSITION_PRECEDING:h.POSITION_IS_CONTAINED+h.POSITION_FOLLOWING},_4e_address:function(a,b){a=m(a);var g=[],d=a.ownerDocument.documentElement;for(a=a;a&&a!=d;){var i=a.parentNode,p=-1;if(i){for(var c=0;c<i.childNodes.length;c++){var e=
i.childNodes[c];if(!(b&&e.nodeType==3&&e.previousSibling&&e.previousSibling.nodeType==3)){p++;if(e==a)break}}g.unshift(p)}a=i}return g},_4e_breakParent:function(a,b){var g=new y.Range(a[0].ownerDocument);g.setStartAfter(a);g.setEndAfter(b);b=g.extractContents();g.insertNode(a.remove());a[0].parentNode.insertBefore(b,a[0].nextSibling)},_4e_style:function(a,b,g){if(g!==undefined)return a.css(b,g);a=a[0]||a;return a.style[q(b)]},_4e_remove:function(a,b){var g=m(a),d=g.parentNode;if(d){if(b)for(;b=g.firstChild;)d.insertBefore(g.removeChild(b),
g);d.removeChild(g)}return a},_4e_trim:function(a){r._4e_ltrim(a);r._4e_rtrim(a)},_4e_ltrim:function(a){a=m(a);for(var b;b=a.firstChild;){if(b.nodeType==f.NODE_TEXT){var g=s.ltrim(b.nodeValue),d=b.nodeValue.length;if(g){if(g.length<d){(new v(b))._4e_splitText(d-g.length);a.removeChild(a.firstChild)}}else{a.removeChild(b);continue}}break}},_4e_rtrim:function(a){a=m(a);for(var b;b=a.lastChild;){if(b.type==f.NODE_TEXT){var g=s.rtrim(b.nodeValue),d=b.nodeValue.length;if(g){if(g.length<d){(new v(b))._4e_splitText(g.length);
a.removeChild(a.lastChild)}}else{a.removeChild(b);continue}}break}if(!t.ie&&!t.opera)(b=a.lastChild)&&b.nodeType==1&&b.nodeName.toLowerCase()=="br"&&b.parentNode.removeChild(b)},_4e_appendBogus:function(a){a=m(a);for(var b=a.lastChild;b&&b.nodeType==f.NODE_TEXT&&!B.trim(b.nodeValue);)b=b.previousSibling;if(!b||b.nodeType==f.NODE_TEXT||r._4e_name(b)!=="br"){b=t.opera?a.ownerDocument.createTextNode(""):a.ownerDocument.createElement("br");t.gecko&&b.setAttribute("type","_moz");a.appendChild(b)}},_4e_previous:function(a,
b){a=m(a);var g;do g=(a=a.previousSibling)&&new v(a);while(g&&b&&!b(g));return g},_4e_last:function(a,b){if((a=(a=a[0].lastChild)&&new v(a))&&b&&!b(a))a=a._4e_previous(b);return a},_4e_next:function(a,b){a=m(a);var g;do g=(a=a.nextSibling)&&new v(a);while(g&&b&&!b(g));return g},_4e_outerHtml:function(a){a=m(a);if(a.outerHTML)return a.outerHTML.replace(/<\?[^>]*>/,"");var b=a.ownerDocument.createElement("div");b.appendChild(a.cloneNode(true));return b.innerHTML},_4e_setMarker:function(a,b,g,d){a[0]||
(a=new v(a));var i=a._4e_getData("list_marker_id")||a._4e_setData("list_marker_id",B.guid())._4e_getData("list_marker_id"),p=a._4e_getData("list_marker_names")||a._4e_setData("list_marker_names",{})._4e_getData("list_marker_names");b[i]=a;p[g]=1;return a._4e_setData(g,d)},_4e_clearMarkers:function(a,b,g){a=o(a);var d=a._4e_getData("list_marker_names"),i=a._4e_getData("list_marker_id");for(var p in d)a._4e_removeData(p);a._4e_removeData("list_marker_names");if(g){a._4e_removeData("list_marker_id");
delete b[i]}},_4e_setData:function(a,b,g){var d=r._4e_getUniqueId(a);(k[d]||(k[d]={}))[b]=g;return a},_4e_getData:function(a,b){a=m(a);return(a=(a=a.getAttribute("_ke_expando"))&&k[a])&&a[b]},_4e_removeData:function(a,b){a=m(a);var g=a.getAttribute("_ke_expando");var d=(g=g&&k[g])&&g[b];typeof d!="undefined"&&g&&delete g[b];B.isEmptyObject(g)&&r._4e_clearData(a);return d||null},_4e_clearData:function(a){a=m(a);var b=a.getAttribute("_ke_expando");b&&delete k[b];b&&a.removeAttribute("_ke_expando")},
_4e_getUniqueId:function(a){a=m(a);var b=a.getAttribute("_ke_expando");if(b)return b;b=B.guid();a.setAttribute("_ke_expando",b);return b},_4e_copyAttributes:function(a,b,g){a=m(a);var d=a.attributes;g=g||{};for(var i=0;i<d.length;i++){var p=d[i],c=p.nodeName.toLowerCase(),e;if(!(c in g))if(c=="checked"&&(e=r.attr(a,c)))b.attr(c,e);else if(p.specified||t.ie&&p.nodeValue&&c=="value"){e=r.attr(a,c);if(e===null)e=p.nodeValue;b.attr(c,e)}}if(a.style.cssText!=="")b[0].style.cssText=a.style.cssText},_4e_isEditable:function(a){a=
r._4e_name(a);var b=y.XHTML_DTD;return(a=!b.$nonEditable[a]&&(b[a]||b.span))&&a["#"]},_4e_scrollIntoView:function(a){a=o(a);var b=a[0].ownerDocument,g=r.scrollLeft(b),d=r.scrollTop(b),i=a.offset(),p=i.left;i=i.top;if(r.viewportHeight(b)+d<i||i<d||r.viewportWidth(b)+g<p||p<g)a.scrollIntoView(b)},_4e_getElementsByTagName:function(a,b,g){a=m(a);if(!t.ie&&g)b=g+":"+b;g=[];a=a.getElementsByTagName(b);for(b=0;b<a.length;b++)g.push(new v(a[b]));return g}};B.DOM._4e_inject=function(a){B.mix(r,a);for(var b in a)a.hasOwnProperty(b)&&
function(g){v.prototype[g]=function(){var d=[].slice.call(arguments,0);d.unshift(this);return a[g].apply(null,d)}}(b)};B.DOM._4e_inject(j)});
KISSY.Editor.add("elementpath",function(y){function q(k){var l=null,u=null,m=[];for(k=k;k&&k[0];){if(k[0].nodeType==v.NODE_ELEMENT){if(!this.lastElement)this.lastElement=k;var o=k._4e_name();if(s.ie&&k[0].scopeName!="HTML")o=k[0].scopeName.toLowerCase()+":"+o;if(!u){if(!l&&z[o])l=k;if(f[o])if(!l&&o=="div"&&!h(k))l=k;else u=k}m.push(k);if(o=="body")break}k=k.parent()}this.block=l;this.blockLimit=u;this.elements=m}var B=KISSY,r=B.DOM,t=y.XHTML_DTD,v=y.NODE,s=B.UA,z={address:1,blockquote:1,dl:1,h1:1,
h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},f={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1},h=function(k){k=k[0]||k;k=k.childNodes;for(var l=0,u=k.length;l<u;l++){var m=k[l];if(m.nodeType==v.NODE_ELEMENT&&t.$block[m.nodeName.toLowerCase()])return true}return false};q.prototype={compare:function(k){var l=this.elements;k=k&&k.elements;if(!k||l.length!=k.length)return false;for(var u=0;u<l.length;u++)if(!r._4e_equals(l[u],k[u]))return false;return true},contains:function(k){for(var l=
this.elements,u=0;u<l.length;u++)if(l[u]._4e_name()in k)return l[u];return null}};y.ElementPath=q});
KISSY.Editor.add("walker",function(y){function q(f,h){if(this._.end)return null;var k=this.range,l,u=this.guard,m=this.type,o=f?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start){this._.start=1;k.trim();if(k.collapsed){this.end();return null}}if(!f&&!this._.guardLTR){var j=k.endContainer,a=new z(j[0].childNodes[k.endOffset]);this._.guardLTR=function(i,p){return(!p||!s._4e_equals(j,i))&&(!a[0]||i[0]!==a[0])&&(i[0].nodeType!=v.NODE_ELEMENT||!p||i._4e_name()!="body")}}if(f&&!this._.guardRTL){var b=
k.startContainer,g=k.startOffset>0&&new z(b[0].childNodes[k.startOffset-1]);this._.guardRTL=function(i,p){return i&&i[0]&&(!p||b[0]!==i[0])&&(!g[0]||i[0]!==g[0])&&(i[0].nodeType!=v.NODE_ELEMENT||!p||i._4e_name()!="body")}}var d=f?this._.guardRTL:this._.guardLTR;l=u?function(i,p){if(d(i,p)===false)return false;return u(i,p)}:d;if(this.current)f=this.current[o](false,m,l);else if(f){f=k.endContainer;if(k.endOffset>0){f=new z(f[0].childNodes[k.endOffset-1]);if(l(f)===false)f=null}else f=l(f,true)===
false?null:f._4e_previousSourceNode(true,m,l)}else{f=k.startContainer;if((f=new z(f[0].childNodes[k.startOffset]))&&f[0]){if(l(f)===false)f=null}else f=l(k.startContainer,true)===false?null:k.startContainer._4e_nextSourceNode(true,m,l)}for(;f&&f[0]&&!this._.end;){this.current=f;if(!this.evaluator||this.evaluator(f)!==false){if(!h)return f}else if(h&&this.evaluator)return false;f=f[o](false,m,l)}this.end();return this.current=null}function B(f){for(var h,k=null;h=q.call(this,f);)k=h;return k}function r(f){this.range=
f;this._={}}var t=KISSY,v=y.NODE,s=t.DOM,z=t.Node;t.augment(r,{end:function(){this._.end=1},next:function(){return q.call(this)},previous:function(){return q.call(this,true)},checkForward:function(){return q.call(this,false,true)!==false},checkBackward:function(){return q.call(this,true,true)!==false},lastForward:function(){return B.call(this)},lastBackward:function(){return B.call(this,true)},reset:function(){delete this.current;this._={}}});r.blockBoundary=function(f){return function(h){h[0]||(h=
new z(h));return!(h[0].nodeType==v.NODE_ELEMENT&&h._4e_isBlockBoundary(f))}};r.listItemBoundary=function(){return this.blockBoundary({br:1})};r.bookmark=function(f,h){function k(l){return l&&l[0]&&l._4e_name()=="span"&&l.attr("_ke_bookmark")}return function(l){var u,m;u=l&&l[0]&&l[0].nodeType==v.NODE_TEXT&&(m=l.parent())&&k(m);u=f?u:u||k(l);return h^u}};r.whitespaces=function(f){return function(h){h=(h=h[0]||h)&&h.nodeType==v.NODE_TEXT&&!t.trim(h.nodeValue);return f^h}};r.invisible=function(f){var h=
r.whitespaces();return function(k){k=h(k)||k[0].nodeType==v.NODE_ELEMENT&&!k[0].offsetHeight;return f^k}};y.Walker=r});
KISSY.Editor.add("range",function(y){function q(c){this.endOffset=this.endContainer=this.startOffset=this.startContainer=null;this.collapsed=true;this.document=c}function B(c){var e=c[0].nodeType!=f.NODE_TEXT&&c._4e_name()in j.$removeEmpty,n=!z.trim(c[0].nodeValue);c=!!c.parent().attr("_ke_bookmark");return e||n||c}function r(c){return!i(c)&&!p(c)}function t(c){var e=false,n=l.bookmark(true);return function(A){if(n(A))return true;if(A[0].nodeType==f.NODE_TEXT){if(z.trim(A[0].nodeValue).length)return false}else if(A[0].nodeType==
f.NODE_ELEMENT)if(!d[A._4e_name()])if(!c&&!o.ie&&A._4e_name()=="br"&&!e)e=true;else return false;return true}}function v(c,e){function n(A){return A&&A.nodeName=="span"&&A.getAttribute("_ke_bookmark")}return function(A){var w,C;w=A&&!A.nodeName&&(C=A.parentNode)&&n(C);w=c?w:w||n(A);return e^w}}function s(c){return function(e){e=(e=e[0]||e)&&e.nodeType==f.NODE_TEXT&&!z.trim(e.nodeValue);return c^e}}y.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,
ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,STARTEND:3,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var z=KISSY,f=y.NODE,h=y.RANGE,k=y.POSITION,l=y.Walker,u=z.DOM,m=y.Utils.getByAddress,o=z.UA,j=y.XHTML_DTD,a=y.ElementPath,b=z.Node,g={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1};q.prototype.toString=function(){var c=[];c.push((this.startContainer[0].id||this.startContainer[0].nodeName)+":"+this.startOffset);c.push((this.endContainer[0].id||this.endContainer[0].nodeName)+
":"+this.endOffset);return c.join("<br/>")};z.augment(q,{updateCollapsed:function(){this.collapsed=this.startContainer&&this.endContainer&&u._4e_equals(this.startContainer,this.endContainer)&&this.startOffset==this.endOffset},optimize:function(){var c=this.startContainer,e=this.startOffset;if(c[0].nodeType!=f.NODE_ELEMENT)if(e)e>=c[0].nodeValue.length&&this.setStartAfter(c);else this.setStartBefore(c);c=this.endContainer;e=this.endOffset;if(c[0].nodeType!=f.NODE_ELEMENT)if(e)e>=c[0].nodeValue.length&&
this.setEndAfter(c);else this.setEndBefore(c)},setStartAfter:function(c){this.setStart(c.parent(),c._4e_index()+1)},setStartBefore:function(c){this.setStart(c.parent(),c._4e_index())},setEndAfter:function(c){this.setEnd(c.parent(),c._4e_index()+1)},setEndBefore:function(c){this.setEnd(c.parent(),c._4e_index())},optimizeBookmark:function(){var c=this.startContainer,e=this.endContainer;c&&c._4e_name()=="span"&&c.attr("_ke_bookmark")&&this.setStartAt(c,h.POSITION_BEFORE_START);e&&e._4e_name()=="span"&&
e.attr("_ke_bookmark")&&this.setEndAt(e,h.POSITION_AFTER_END)},setStart:function(c,e){if(c[0].nodeType==f.NODE_ELEMENT&&g[c._4e_name()]){c=c.parent();e=c._4e_index()}this.startContainer=c;this.startOffset=e;if(!this.endContainer){this.endContainer=c;this.endOffset=e}this.updateCollapsed()},setEnd:function(c,e){if(c[0].nodeType==f.NODE_ELEMENT&&g[c._4e_name()]){c=c.parent();e=c._4e_index()+1}this.endContainer=c;this.endOffset=e;if(!this.startContainer){this.startContainer=c;this.startOffset=e}this.updateCollapsed()},
setStartAt:function(c,e){switch(e){case h.POSITION_AFTER_START:this.setStart(c,0);break;case h.POSITION_BEFORE_END:c[0].nodeType==f.NODE_TEXT?this.setStart(c,c[0].nodeValue.length):this.setStart(c,c[0].childNodes.length);break;case h.POSITION_BEFORE_START:this.setStartBefore(c);break;case h.POSITION_AFTER_END:this.setStartAfter(c)}this.updateCollapsed()},setEndAt:function(c,e){switch(e){case h.POSITION_AFTER_START:this.setEnd(c,0);break;case h.POSITION_BEFORE_END:c[0].nodeType==f.NODE_TEXT?this.setEnd(c,
c[0].nodeValue.length):this.setEnd(c,c[0].childNodes.length);break;case h.POSITION_BEFORE_START:this.setEndBefore(c);break;case h.POSITION_AFTER_END:this.setEndAfter(c)}this.updateCollapsed()},execContentsAction:function(c,e){var n=this.startContainer,A=this.endContainer,w=this.startOffset,C=this.endOffset,I,x;this.optimizeBookmark();if(A[0].nodeType==f.NODE_TEXT)A=A._4e_splitText(C);else if(A[0].childNodes.length>0)if(C>=A[0].childNodes.length){A=new b(A[0].appendChild(this.document.createTextNode("")));
x=true}else A=new b(A[0].childNodes[C]);if(n[0].nodeType==f.NODE_TEXT){n._4e_splitText(w);if(u._4e_equals(n,A))A=new b(n[0].nextSibling)}else if(w)if(w>=n[0].childNodes.length){I=new b(this.document.createTextNode(""));n[0].appendChild(I[0]);n=I;I=true}else n=new b(n[0].childNodes[w].previousSibling);else{I=new b(this.document.createTextNode(""));u.insertBefore(I[0],n[0].firstChild);n=I;I=true}w=n._4e_parents();C=A._4e_parents();var D,G,J;for(D=0;D<w.length;D++){G=w[D];J=C[D];if(G[0]!==J[0])break}for(var N=
e,M,Q,R,W=D;W<w.length;W++){M=w[W];if(N&&M[0]!==n[0])Q=N.appendChild(M._4e_clone()[0]);for(M=M[0].nextSibling;M;){if(C[W]&&M==C[W][0]||M==A[0])break;R=M.nextSibling;if(c==2)N.appendChild(M.cloneNode(true));else{M.parentNode.removeChild(M);c==1&&N.appendChild(M)}M=R}if(Q)N=Q}N=e;for(e=D;e<C.length;e++){M=C[e];if(c>0&&M[0]!==A[0])Q=N.appendChild(M._4e_clone()[0]);if(!w[e]||M[0].parentNode!==w[e][0].parentNode)for(M=M[0].previousSibling;M;){if(w[e]&&M==w[e][0]||M===n[0])break;R=M.previousSibling;if(c==
2)N.insertBefore(M.cloneNode(true),N.firstChild);else{M.parentNode.removeChild(M);c==1&&N.insertBefore(M,N.firstChild)}M=R}if(Q)N=Q}if(c==2){J=this.startContainer[0];if(J.nodeType==f.NODE_TEXT&&J.nextSibling&&J.nextSibling.nodeType==f.NODE_TEXT){J.data+=J.nextSibling.data;J.parentNode.removeChild(J.nextSibling)}J=this.endContainer[0];if(J.nodeType==f.NODE_TEXT&&J.nextSibling&&J.nextSibling.nodeType==f.NODE_TEXT){J.data+=J.nextSibling.data;J.parentNode.removeChild(J.nextSibling)}}else{if(G&&J&&(n[0].parentNode!=
G[0].parentNode||A[0].parentNode!=J[0].parentNode)){c=J._4e_index();I&&J[0].parentNode==n[0].parentNode&&c--;this.setStart(J.parent(),c)}this.collapse(true)}I&&n.remove();x&&A[0].parentNode&&A.remove()},collapse:function(c){if(c){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=this.endOffset}this.collapsed=true},clone:function(){var c=new q(this.document);c.startContainer=this.startContainer;c.startOffset=this.startOffset;
c.endContainer=this.endContainer;c.endOffset=this.endOffset;c.collapsed=this.collapsed;return c},getEnclosedNode:function(){var c=this.clone();c.optimize();if(c.startContainer[0].nodeType!=f.NODE_ELEMENT||c.endContainer[0].nodeType!=f.NODE_ELEMENT)return null;c=c.startContainer[0].childNodes[c.startOffset];for(var e=v(true,undefined),n=s(true),A=function(w){return n(w)&&e(w)};c&&A(c);)c=(new b(c))._4e_nextSourceNode()[0];return new b(c)},shrink:function(c,e){if(!this.collapsed){c=c||h.SHRINK_TEXT;
var n=this.clone(),A=this.startContainer,w=this.endContainer,C=this.startOffset,I=this.endOffset,x=1,D=1;if(A&&A[0].nodeType==f.NODE_TEXT)if(C)if(C>=A[0].nodeValue.length)n.setStartAfter(A);else{n.setStartBefore(A);x=0}else n.setStartBefore(A);if(w&&w[0].nodeType==f.NODE_TEXT)if(I)if(I>=w[0].nodeValue.length)n.setEndAfter(w);else{n.setEndAfter(w);D=0}else n.setEndBefore(w);n=new l(n);n.evaluator=function(J){J=J[0]||J;return J.nodeType==(c==h.SHRINK_ELEMENT?f.NODE_ELEMENT:f.NODE_TEXT)};var G;n.guard=
function(J,N){J=J[0]||J;if(c==h.SHRINK_ELEMENT&&J.nodeType==f.NODE_TEXT)return false;if(N&&J==G)return false;if(!N&&J.nodeType==f.NODE_ELEMENT)G=J;return true};if(x)(A=n[c==h.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(A,e?h.POSITION_AFTER_START:h.POSITION_BEFORE_START);if(D){n.reset();(n=n[c==h.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(n,e?h.POSITION_BEFORE_END:h.POSITION_AFTER_END)}return!!(x||D)}},getTouchedStartNode:function(){var c=this.startContainer;if(this.collapsed||
c[0].nodeType!=f.NODE_ELEMENT)return c;return c.childNodes[this.startOffset]||c},createBookmark2:function(c){var e=this.startContainer,n=this.endContainer,A=this.startOffset,w=this.endOffset,C,I;if(!e||!n)return{start:0,end:0};if(c){if(e[0].nodeType==f.NODE_ELEMENT)if((C=new b(e[0].childNodes[A]))&&C[0]&&C[0].nodeType==f.NODE_TEXT&&A>0&&C[0].previousSibling.nodeType==f.NODE_TEXT){e=C;A=0}for(;e[0].nodeType==f.NODE_TEXT&&(I=e._4e_previous())&&I[0].nodeType==f.NODE_TEXT;){e=I;A+=I[0].nodeValue.length}if(!this.collapsed){if(n[0].nodeType==
f.NODE_ELEMENT)if((C=new b(n[0].childNodes[w]))&&C[0]&&C[0].nodeType==f.NODE_TEXT&&w>0&&C[0].previousSibling.nodeType==f.NODE_TEXT){n=C;w=0}for(;n[0].nodeType==f.NODE_TEXT&&(I=n._4e_previous())&&I[0].nodeType==f.NODE_TEXT;){n=I;w+=I[0].nodeValue.length}}}return{start:e._4e_address(c),end:this.collapsed?null:n._4e_address(c),startOffset:A,endOffset:w,normalized:c,is2:true}},createBookmark:function(c){var e,n,A,w;e=new b("<span></span>",null,this.document);e.attr("_ke_bookmark",1);e.css("display","none");
e.html("&nbsp;");if(c){A=z.guid("ke_bm_");e.attr("id",A+"S")}if(!this.collapsed){n=e._4e_clone();n.html("&nbsp;");c&&n.attr("id",A+"E");w=this.clone();w.collapse();w.insertNode(n)}w=this.clone();w.collapse(true);w.insertNode(e);if(n){this.setStartAfter(e);this.setEndBefore(n)}else this.moveToPosition(e,h.POSITION_AFTER_END);return{startNode:c?A+"S":e,endNode:c?A+"E":n,serializable:c}},moveToPosition:function(c,e){this.setStartAt(c,e);this.collapse(true)},trim:function(c,e){var n=this.startContainer,
A=this.startOffset,w=this.collapsed;if((!c||w)&&n[0]&&n[0].nodeType==f.NODE_TEXT){if(A)if(A>=n[0].nodeValue.length){A=n._4e_index()+1;n=n.parent()}else{c=n._4e_splitText(A);A=n._4e_index()+1;n=n.parent();if(u._4e_equals(this.startContainer,this.endContainer))this.setEnd(c,this.endOffset-this.startOffset);else if(u._4e_equals(n,this.endContainer))this.endOffset+=1}else{A=n._4e_index();n=n.parent()}this.setStart(n,A);if(w){this.collapse(true);return}}n=this.endContainer;A=this.endOffset;if(!(e||w)&&
n[0]&&n[0].nodeType==f.NODE_TEXT){if(A){A>=n.nodeValue.length||n._4e_splitText(A);A=n._4e_index()+1}else A=n._4e_index();n=n.parent();this.setEnd(n,A)}},insertNode:function(c){this.optimizeBookmark();this.trim(false,true);var e=this.startContainer,n=e[0].childNodes[this.startOffset];this.optimizeBookmark();this.trim(false,true);n?u.insertBefore(c[0]||c,n):e[0].appendChild(c[0]||c);u._4e_equals(c.parent(),this.endContainer)&&this.endOffset++;this.setStartBefore(c)},moveToBookmark:function(c){if(c.is2){var e=
m(this.document,c.start,c.normalized),n=c.startOffset,A=c.end&&m(this.document,c.end,c.normalized);c=c.endOffset;this.setStart(e,n);A?this.setEnd(A,c):this.collapse(true)}else{e=(n=c.serializable)?z.one("#"+c.startNode,this.document):c.startNode;c=n?z.one("#"+c.endNode,this.document):c.endNode;this.setStartBefore(e);e.remove();if(c&&c[0]){this.setEndBefore(c);c.remove()}else this.collapse(true)}},getCommonAncestor:function(c,e){var n=this.startContainer,A=this.endContainer;c=u._4e_equals(n,A)?c&&
n[0].nodeType==f.NODE_ELEMENT&&this.startOffset==this.endOffset-1?new b(n[0].childNodes[this.startOffset]):n:n._4e_commonAncestor(A);return e&&c[0].nodeType==f.NODE_TEXT?c.parent():c},enlarge:function(c){switch(c){case h.ENLARGE_ELEMENT:if(this.collapsed)return;c=this.getCommonAncestor();var e=new b(this.document.body),n,A,w,C,I,x=false,D,G;D=this.startContainer;G=this.startOffset;if(D[0].nodeType==f.NODE_TEXT){if(G){D=!z.trim(D[0].nodeValue.substring(0,G)).length&&D;x=!!D}if(D)if(!(C=D[0].previousSibling))w=
D.parent()}else{if(G)C=D[0].childNodes[G-1]||D[0].lastChild;C||(w=D)}for(;w||C;){if(w&&!C){if(!I&&u._4e_equals(w,c))I=true;if(!e._4e_contains(w))break;if(!x||w.css("display")!="inline"){x=false;if(I)n=w;else this.setStartBefore(w)}C=w[0].previousSibling}for(;C;){D=false;if(C.nodeType==f.NODE_TEXT){G=C.nodeValue;if(/[^\s\ufeff]/.test(G))C=null;D=/[\s\ufeff]$/.test(G)}else if(C.offsetWidth>0&&!C.getAttribute("_ke_bookmark"))if(x&&j.$removeEmpty[C.nodeName.toLowerCase()]){G=u.text(C);if(/[^\s\ufeff]/.test(G))C=
null;else for(var J=C.all||C.getElementsByTagName("*"),N=0,M;M=J[N++];)if(!j.$removeEmpty[M.nodeName.toLowerCase()]){C=null;break}if(C)D=!!G.length}else C=null;if(D)if(x)if(I)n=w;else w&&this.setStartBefore(w);else x=true;if(C){D=C.previousSibling;if(!w&&!D){w=new b(C);C=null;break}C=D}else w=null}if(w)w=w.parent()}D=this.endContainer;G=this.endOffset;w=C=null;I=x=false;if(D[0].nodeType==f.NODE_TEXT){D=!z.trim(D[0].nodeValue.substring(G)).length&&D;x=!(D&&D[0].nodeValue.length);if(D)if(!(C=D[0].nextSibling))w=
D.parent()}else(C=D[0].childNodes[G])||(w=D);for(;w||C;){if(w&&!C){if(!I&&u._4e_equals(w,c))I=true;if(!e._4e_contains(w))break;if(!x||w.css("display")!="inline"){x=false;if(I)A=w;else w&&this.setEndAfter(w)}C=w[0].nextSibling}for(;C;){D=false;if(C.nodeType==f.NODE_TEXT){G=C.nodeValue;if(/[^\s\ufeff]/.test(G))C=null;D=/^[\s\ufeff]/.test(G)}else if(C.offsetWidth>0&&!C.getAttribute("_ke_bookmark"))if(x&&j.$removeEmpty[C.nodeName.toLowerCase()]){G=u.text(C);if(/[^\s\ufeff]/.test(G))C=null;else{J=C.all||
C.getElementsByTagName("*");for(N=0;M=J[N++];)if(!j.$removeEmpty[M.nodeName.toLowerCase()]){C=null;break}}if(C)D=!!G.length}else C=null;if(D)if(x)if(I)A=w;else this.setEndAfter(w);if(C){D=C.nextSibling;if(!w&&!D){w=new b(C);C=null;break}C=D}else w=null}if(w)w=w.parent()}if(n&&A){c=n._4e_contains(A)?A:n;this.setStartBefore(c);this.setEndAfter(c)}break;case h.ENLARGE_BLOCK_CONTENTS:case h.ENLARGE_LIST_ITEM_CONTENTS:w=new q(this.document);e=new b(this.document.body);w.setStartAt(e,h.POSITION_AFTER_START);
w.setEnd(this.startContainer,this.startOffset);w=new l(w);var Q,R,W=l.blockBoundary(c==h.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:null),$=function(aa){var E=W(aa);E||(Q=aa);return E};n=function(aa){var E=$(aa);if(!E&&aa[0]&&aa._4e_name()=="br")R=aa;return E};w.guard=$;w=w.lastBackward();Q=Q||e;this.setStartAt(Q,Q._4e_name()!="br"&&(!w&&this.checkStartOfBlock()||w&&Q._4e_contains(w))?h.POSITION_AFTER_START:h.POSITION_AFTER_END);w=this.clone();w.collapse();w.setEndAt(e,h.POSITION_BEFORE_END);w=new l(w);w.guard=
c==h.ENLARGE_LIST_ITEM_CONTENTS?n:$;Q=null;w=w.lastForward();Q=Q||e;this.setEndAt(Q,!w&&this.checkEndOfBlock()||w&&Q._4e_contains(w)?h.POSITION_BEFORE_END:h.POSITION_BEFORE_START);R&&this.setEndAfter(R)}},checkStartOfBlock:function(){var c=this.startContainer,e=this.startOffset;if(e&&c[0].nodeType==f.NODE_TEXT)if(z.trim(c[0].nodeValue.substring(0,e)).length)return false;this.trim();c=new a(this.startContainer);e=this.clone();e.collapse(true);e.setStartAt(c.block||c.blockLimit,h.POSITION_AFTER_START);
c=new l(e);c.evaluator=t(true);return c.checkBackward()},checkEndOfBlock:function(){var c=this.endContainer,e=this.endOffset;if(c[0].nodeType==f.NODE_TEXT)if(z.trim(c[0].nodeValue.substring(e)).length)return false;this.trim();c=new a(this.endContainer);e=this.clone();e.collapse(false);e.setEndAt(c.block||c.blockLimit,h.POSITION_BEFORE_END);c=new l(e);c.evaluator=t(false);return c.checkForward()},deleteContents:function(){this.collapsed||this.execContentsAction(0)},extractContents:function(){var c=
this.document.createDocumentFragment();this.collapsed||this.execContentsAction(1,c);return c},checkBoundaryOfElement:function(c,e){var n=this.clone();n[e==h.START?"setStartAt":"setEndAt"](c,e==h.START?h.POSITION_AFTER_START:h.POSITION_BEFORE_END);c=new l(n);c.evaluator=B;return c[e==h.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var c=this.startContainer,e=this.endContainer,n=this.startOffset,A=this.endOffset,w;if(c[0].nodeType==f.NODE_ELEMENT){w=c[0].childNodes.length;if(w>
n)c=new b(c[0].childNodes[n]);else if(w<1)c=c._4e_previousSourceNode();else{for(c=c[0];c.lastChild;)c=c.lastChild;c=new b(c);c=c._4e_nextSourceNode()||c}}if(e[0].nodeType==f.NODE_ELEMENT){w=e[0].childNodes.length;if(w>A)e=(new b(e[0].childNodes[A]))._4e_previousSourceNode(true);else if(w<1)e=e._4e_previousSourceNode();else{for(e=e[0];e.lastChild;)e=e.lastChild;e=new b(e)}}if(c._4e_position(e)&k.POSITION_FOLLOWING)c=e;return{startNode:c,endNode:e}},fixBlock:function(c,e){var n=this.createBookmark();
e=new b(this.document.createElement(e));this.collapse(c);this.enlarge(h.ENLARGE_BLOCK_CONTENTS);e[0].appendChild(this.extractContents());e._4e_trim();o.ie||e._4e_appendBogus();this.insertNode(e);this.moveToBookmark(n);return e},splitBlock:function(c){var e=new a(this.startContainer),n=new a(this.endContainer),A=e.block,w=n.block,C=null;if(e.blockLimit[0]!==n.blockLimit[0])return null;if(c!="br"){if(!A){A=this.fixBlock(true,c);w=(new a(this.endContainer)).block}w||(w=this.fixBlock(false,c))}c=A&&this.checkStartOfBlock();
e=w&&this.checkEndOfBlock();this.deleteContents();if(A&&u._4e_equals(A,w))if(e){C=new a(this.startContainer);this.moveToPosition(w,h.POSITION_AFTER_END);w=null}else if(c){C=new a(this.startContainer);this.moveToPosition(A,h.POSITION_BEFORE_START);A=null}else{w=this.splitElement(A);!o.ie&&!z.inArray(A._4e_name(),["ul","ol"])&&A._4e_appendBogus()}return{previousBlock:A,nextBlock:w,wasStartOfBlock:c,wasEndOfBlock:e,elementPath:C}},splitElement:function(c){if(!this.collapsed)return null;this.setEndAt(c,
h.POSITION_BEFORE_END);var e=this.extractContents(),n=c._4e_clone(false);n[0].appendChild(e);n.insertAfter(c);this.moveToPosition(c,h.POSITION_AFTER_END);return n},moveToElementEditablePosition:function(c,e){var n,A=y.XHTML_DTD;if(A.$empty[c._4e_name()])return false;for(;c&&c[0].nodeType==f.NODE_ELEMENT;){if(n=c._4e_isEditable())this.moveToPosition(c,e?h.POSITION_BEFORE_END:h.POSITION_AFTER_START);else if(A.$inline[c._4e_name()]){this.moveToPosition(c,e?h.POSITION_AFTER_END:h.POSITION_BEFORE_START);
return true}if((c=A.$empty[c._4e_name()]?c[e?"_4e_previous":"_4e_next"](r):c[e?"_4e_last":"_4e_first"](r))&&c[0].nodeType==f.NODE_TEXT){this.moveToPosition(c,e?h.POSITION_AFTER_END:h.POSITION_BEFORE_START);return true}}return n},selectNodeContents:function(c){this.setStart(c,0);this.setEnd(c,c[0].nodeType==f.NODE_TEXT?c[0].nodeValue.length:c[0].childNodes.length)}});var d={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},i=new l.whitespaces,p=new l.bookmark;y.Range=q});
KISSY.Editor.add("domiterator",function(y){function q(m){if(!(arguments.length<1)){this.range=m;this.forceBrBreak=false;this.enlargeBr=true;this.enforceRealBlocks=false;this._||(this._={})}}var B=KISSY,r=B.UA,t=y.Walker,v=y.Range,s=y.RANGE,z=y.NODE,f=y.ElementPath,h=B.Node,k=B.DOM,l=/^[\r\n\t ]*$/,u=t.bookmark();B.augment(q,{getNextParagraph:function(m){var o,j,a,b,g;if(!this._.lastNode){j=this.range.clone();j.enlarge(this.forceBrBreak||!this.enlargeBr?s.ENLARGE_LIST_ITEM_CONTENTS:s.ENLARGE_BLOCK_CONTENTS);
var d=new t(j),i=t.bookmark(true,true);d.evaluator=i;this._.nextNode=d.next();d=new t(j);d.evaluator=i;d=d.previous();this._.lastNode=d._4e_nextSourceNode(true);if(this._.lastNode&&this._.lastNode[0].nodeType==z.NODE_TEXT&&!B.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()){i=new v(j.document);i.moveToPosition(this._.lastNode,s.POSITION_AFTER_END);if(i.checkEndOfBlock()){i=new f(i.endContainer);this._.lastNode=(i.block||i.blockLimit)._4e_nextSourceNode(true)}}if(!this._.lastNode){this._.lastNode=
this._.docEndMarker=new h(j.document.createTextNode(""));k.insertAfter(this._.lastNode[0],d[0])}j=null}i=this._.nextNode;d=this._.lastNode;for(this._.nextNode=null;i;){var p=false,c=i[0].nodeType!=z.NODE_ELEMENT,e=false;if(c){if(i[0].nodeType==z.NODE_TEXT)if(l.test(i[0].nodeValue))c=false}else{var n=i._4e_name();if(i._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if(n=="br")c=true;else if(!j&&!i[0].childNodes.length&&n!="hr"){o=i;a=i._4e_equals(d);break}if(j){j.setEndAt(i,s.POSITION_BEFORE_START);
if(n!="br")this._.nextNode=i}p=true}else{if(i[0].firstChild){if(!j){j=new v(this.range.document);j.setStartAt(i,s.POSITION_BEFORE_START)}i=new h(i[0].firstChild);continue}c=true}}if(c&&!j){j=new v(this.range.document);j.setStartAt(i,s.POSITION_BEFORE_START)}a=(!p||c)&&i._4e_equals(d);if(j&&!p)for(;!i[0].nextSibling&&!a;){n=i.parent();if(n._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){p=true;a||n._4e_equals(d);break}i=n;c=true;a=i._4e_equals(d);e=true}c&&j.setEndAt(i,s.POSITION_AFTER_END);i=i._4e_nextSourceNode(e,
null,d);a=!i;if((p||a)&&j){c=j.getBoundaryNodes();p=new f(j.startContainer);if(c.startNode.parent()._4e_equals(p.blockLimit)&&u(c.startNode)&&u(c.endNode)){j=null;this._.nextNode=null}else break}if(a)break}if(!o){if(!j){this._.docEndMarker&&this._.docEndMarker.remove();return this._.nextNode=null}p=new f(j.startContainer);i=p.blockLimit;c={div:1,th:1,td:1};o=p.block;if((!o||!o[0])&&!this.enforceRealBlocks&&c[i._4e_name()]&&j.checkStartOfBlock()&&j.checkEndOfBlock())o=i;else if(!o||this.enforceRealBlocks&&
o._4e_name()=="li"){o=new h(this.range.document.createElement(m||"p"));o[0].appendChild(j.extractContents());o._4e_trim();j.insertNode(o);b=g=true}else if(o._4e_name()!="li"){if(!j.checkStartOfBlock()||!j.checkEndOfBlock()){o=o._4e_clone(false);o[0].appendChild(j.extractContents());o._4e_trim();g=j.splitBlock();b=!g.wasStartOfBlock;g=!g.wasEndOfBlock;j.insertNode(o)}}else if(!a)this._.nextNode=o._4e_equals(d)?null:j.getBoundaryNodes().endNode._4e_nextSourceNode(true,null,d)}if(b){j=new h(o[0].previousSibling);
if(j[0]&&j[0].nodeType==z.NODE_ELEMENT)if(j._4e_name()=="br")j._4e_remove();else j[0].lastChild&&j[0].lastChild.nodeName.toLowerCase()=="br"&&k._4e_remove(j[0].lastChild)}if(g){j=t.bookmark(false,true);b=new h(o[0].lastChild);if(b[0]&&b[0].nodeType==z.NODE_ELEMENT&&b._4e_name()=="br")if(r.ie||b._4e_previous(j)||b._4e_next(j))b._4e_remove()}if(!this._.nextNode)this._.nextNode=a||o._4e_equals(d)?null:o._4e_nextSourceNode(true,null,d);return o}});v.prototype.createIterator=function(){return new q(this)}});
KISSY.Editor.add("selection",function(y){function q(d){this.document=d;this._={cache:{}};if(v.ie){var i=this.getNative().createRange();if(!i||i.item&&i.item(0).ownerDocument!=d||i.parentElement&&i.parentElement().ownerDocument!=d)this.isInvalid=true}}function B(d){d=new q(d);return!d||d.isInvalid?null:d}function r(d){var i=d.document,p=new h(i.body),c=new h(i.documentElement);if(v.ie){if(v.ie<8||document.documentMode==7)c.on("click",function(C){s._4e_name(C.target)==="html"&&d.getSelection().getRanges()[0].select()});
var e,n;p.on("focusin",function(C){if(C.target.nodeName.toUpperCase()=="BODY")if(e){try{e.select()}catch(I){}e=null}});p.on("focus",function(){n=true;w()});p.on("beforedeactivate",function(C){C.relatedTarget||(n=false)});v.ie<8&&z.on(s._4e_getWin(i),"blur",function(){i.selection.empty()});p.on("mousedown",A);p.on("mouseup",function(){n=true;setTimeout(function(){w(true)},0)});p.on("keydown",A);p.on("keyup",function(){n=true;w()});z.on(i,"selectionchange",w);var A=function(){n=false},w=function(C){if(n){var I=
d.document,x=d.getSelection(),D=x&&x.getNative();if(C&&D&&D.type=="None")if(!I.queryCommandEnabled("InsertImage")){setTimeout(function(){w(true)},50);return}var G;if(!(D&&D.type=="Text"&&(G=D.createRange().parentElement().nodeName.toLowerCase())&&G in{input:1,textarea:1})){e=D&&x.getRanges()[0];d._monitor()}}}}else{z.on(i,"mouseup",d._monitor,d);z.on(i,"keyup",d._monitor,d)}}y.SELECTION={};var t=KISSY,v=t.UA,s=t.DOM,z=t.Event,f=y.Utils.tryThese,h=t.Node,k=y.SELECTION,l=y.RANGE,u=y.NODE,m=y.Walker,
o=y.Range;k.SELECTION_NONE=1;k.SELECTION_TEXT=2;k.SELECTION_ELEMENT=3;var j={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};t.augment(q,{getNative:v.ie?function(){return this._.cache.nativeSel||(this._.cache.nativeSel=this.document.selection)}:function(){return this._.cache.nativeSel||(this._.cache.nativeSel=s._4e_getWin(this.document).getSelection())},getType:v.ie?function(){var d=this._.cache;if(d.type)return d.type;
var i=k.SELECTION_NONE;try{var p=this.getNative(),c=p.type;if(c=="Text")i=k.SELECTION_TEXT;if(c=="Control")i=k.SELECTION_ELEMENT;if(p.createRange().parentElement)i=k.SELECTION_TEXT}catch(e){}return d.type=i}:function(){var d=this._.cache;if(d.type)return d.type;var i=k.SELECTION_TEXT,p=this.getNative();if(p){if(p.rangeCount==1){p=p.getRangeAt(0);var c=p.startContainer;if(c==p.endContainer&&c.nodeType==u.NODE_ELEMENT&&p.endOffset-p.startOffset===1&&j[c.childNodes[p.startOffset].nodeName.toLowerCase()])i=
k.SELECTION_ELEMENT}}else i=k.SELECTION_NONE;return d.type=i},getRanges:v.ie?function(){var d=function(i,p){i=i.duplicate();i.collapse(p);p=i.parentElement();for(var c=p.childNodes,e,n=0;n<c.length;n++){var A=c[n];if(A.nodeType==u.NODE_ELEMENT){e=i.duplicate();e.moveToElementText(A);A=e.compareEndPoints("StartToStart",i);var w=e.compareEndPoints("EndToStart",i);e.collapse();if(A>0)break;else if(!A||w==1&&A==-1)return{container:p,offset:n};else if(!w)return{container:p,offset:n+1};e=null}}if(!e){e=
i.duplicate();e.moveToElementText(p);e.collapse(false)}e.setEndPoint("StartToStart",i);i=e.text.replace(/(\r\n|\r)/g,"\n").length;try{for(;i>0;)i-=c[--n].nodeValue.length}catch(C){i=0}return i===0?{container:p,offset:n}:{container:c[n],offset:-i}};return function(){var i=this._.cache;if(i.ranges)return i.ranges;var p=this.getNative(),c=p&&p.createRange(),e=this.getType();if(!p)return[];if(e==k.SELECTION_TEXT){p=new o(this.document);e=d(c,true);p.setStart(new h(e.container),e.offset);e=d(c);p.setEnd(new h(e.container),
e.offset);return i.ranges=[p]}else if(e==k.SELECTION_ELEMENT){i=this._.cache.ranges=[];for(e=0;e<c.length;e++){var n=c.item(e),A=n.parentNode,w=0;for(p=new o(this.document);w<A.childNodes.length&&A.childNodes[w]!=n;w++);p.setStart(new h(A),w);p.setEnd(new h(A),w+1);i.push(p)}return i}return i.ranges=[]}}():function(){var d=this._.cache;if(d.ranges)return d.ranges;var i=[],p=this.getNative();if(!p)return[];for(var c=0;c<p.rangeCount;c++){var e=p.getRangeAt(c),n=new o(this.document);n.setStart(new h(e.startContainer),
e.startOffset);n.setEnd(new h(e.endContainer),e.endOffset);i.push(n)}return d.ranges=i},getStartElement:function(){var d=this._.cache;if(d.startElement!==undefined)return d.startElement;var i,p=this.getNative();switch(this.getType()){case k.SELECTION_ELEMENT:return this.getSelectedElement();case k.SELECTION_TEXT:var c=this.getRanges()[0];if(c)if(!c.collapsed){for(c.optimize();;){i=c.startContainer;if(c.startOffset==(i[0].childNodes?i[0].childNodes.length:i[0].nodeValue.length)&&!i._4e_isBlockBoundary())c.setStartAfter(i);
else break}i=c.startContainer;if(i[0].nodeType!=u.NODE_ELEMENT)return i.parent();i=new h(i[0].childNodes[c.startOffset]);if(!i[0]||i[0].nodeType!=u.NODE_ELEMENT)return c.startContainer;for(c=i[0].firstChild;c&&c.nodeType==u.NODE_ELEMENT;){i=new h(c);c=c.firstChild}return i}if(v.ie){c=p.createRange();c.collapse(true);i=c.parentElement()}else if((i=p.anchorNode)&&i.nodeType!=u.NODE_ELEMENT)i=i.parentNode}return d.startElement=i?new h(i):null},getSelectedElement:function(){var d=this._.cache;if(d.selectedElement!==
undefined)return d.selectedElement;var i=this,p=f(function(){return i.getNative().createRange().item(0)},function(){for(var c=i.getRanges()[0],e,n,A=2;A&&!((e=c.getEnclosedNode())&&e[0].nodeType==u.NODE_ELEMENT&&j[e._4e_name()]&&(n=e));A--)c.shrink(l.SHRINK_ELEMENT);return n[0]});return d.selectedElement=p?new h(p):null},reset:function(){this._.cache={}},selectElement:function(d){var i;if(v.ie){this.getNative().empty();try{i=this.document.body.createControlRange();i.addElement(d[0]);i.select()}catch(p){i=
this.document.body.createTextRange();i.moveToElementText(d[0]);i.select()}finally{}}else{i=this.document.createRange();i.selectNode(d[0]);d=this.getNative();d.removeAllRanges();d.addRange(i)}this.reset()},selectRanges:function(d){if(v.ie)d[0]&&d[0].select();else{var i=this.getNative();if(!i)return;i.removeAllRanges();for(var p=0;p<d.length;p++){var c=d[p],e=this.document.createRange(),n=c.startContainer;c.collapsed&&v.gecko&&v.gecko<1.09&&n[0].nodeType==u.NODE_ELEMENT&&!n[0].childNodes.length&&n[0].appendChild(this.document.createTextNode(""));
e.setStart(n[0],c.startOffset);e.setEnd(c.endContainer[0],c.endOffset);i.addRange(e)}}this.reset()},createBookmarks2:function(d){for(var i=[],p=this.getRanges(),c=0;c<p.length;c++)i.push(p[c].createBookmark2(d));return i},createBookmarks:function(d){for(var i=[],p=this.getRanges(),c=p.length,e,n=0;n<c;n++){i.push(e=p[n].createBookmark(d,true));var A=(d=e.serializable)?t.one("#"+e.startNode):e.startNode;e=d?t.one("#"+e.endNode):e.endNode;for(var w=n+1;w<c;w++){var C=p[w],I=C.startContainer,x=C.endContainer;
s._4e_equals(I,A.parent())&&C.startOffset++;s._4e_equals(I,e.parent())&&C.startOffset++;s._4e_equals(x,A.parent())&&C.endOffset++;s._4e_equals(x,e.parent())&&C.endOffset++}}return i},selectBookmarks:function(d){for(var i=[],p=0;p<d.length;p++){var c=new o(this.document);c.moveToBookmark(d[p]);i.push(c)}this.selectRanges(i);return this},getCommonAncestor:function(){var d=this.getRanges();return d[0].startContainer._4e_commonAncestor(d[d.length-1].endContainer)},scrollIntoView:function(){this.getStartElement().scrollIntoView()}});
y.Selection=q;var a={table:1,tbody:1,tr:1},b=m.whitespaces(true),g=/\ufeff|\u00a0/;o.prototype.select=v.ie?function(d){var i=this.collapsed,p,c;if(this.startContainer[0].nodeType==u.NODE_ELEMENT&&this.startContainer._4e_name()in a||this.endContainer[0].nodeType==u.NODE_ELEMENT&&this.endContainer._4e_name()in a)this.shrink(u.NODE_ELEMENT,true);var e=this.createBookmark(),n=e.startNode,A;if(!i)A=e.endNode;e=this.document.body.createTextRange();e.moveToElementText(n[0]);e.moveStart("character",1);if(A){d=
this.document.body.createTextRange();d.moveToElementText(A[0]);e.setEndPoint("EndToEnd",d);e.moveEnd("character",-1)}else{for(p=n[0].nextSibling;p&&!b(p);)p=p.nextSibling;p=!(p&&p.nodeValue&&p.nodeValue.match(g))&&(d||!n[0].previousSibling||n[0].previousSibling&&s._4e_name(n[0].previousSibling)=="br");c=this.document.createElement("span");c.innerHTML="&#65279;";c=new h(c);s.insertBefore(c[0],n[0]);p&&s.insertBefore(this.document.createTextNode("\ufeff"),n[0])}this.setStartBefore(n);n._4e_remove();
if(i){if(p){e.moveStart("character",-1);e.select();this.document.selection.clear()}else e.select();if(c){this.moveToPosition(c,l.POSITION_BEFORE_START);c._4e_remove()}}else{this.setEndBefore(A);A.remove();e.select()}}:function(){var d=this.startContainer;this.collapsed&&d[0].nodeType==u.NODE_ELEMENT&&!d[0].childNodes.length&&d[0].appendChild(this.document.createTextNode(""));var i=this.document.createRange();i.setStart(d[0],this.startOffset);try{i.setEnd(this.endContainer[0],this.endOffset)}catch(p){if(p.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=
0){this.collapse(true);i.setEnd(this.endContainer[0],this.endOffset)}else throw p;}d=B(this.document).getNative();d.removeAllRanges();d.addRange(i)};y.on("instanceCreated",function(d){r(d.editor)})});
KISSY.Editor.add("styles",function(y){function q(E,F){for(var H in E)E[H]=E[H].replace(aa,function(K,L){return F[L]})}function B(E,F){if(F){E=A.clone(E);q(E.attributes,F);q(E.styles,F)}F=this.element=(E.element||"*").toLowerCase();this.type=F=="#"||R[F]?C.STYLE_BLOCK:W[F]?C.STYLE_OBJECT:C.STYLE_INLINE;this._={definition:E}}function r(E,F){F=F?this.removeFromRange:this.applyToRange;E.body.focus();E=new x(E);for(var H=E.getRanges(),K=0;K<H.length;K++)F.call(this,H[K]);E.selectRanges(H)}function t(E,
F){var H=E.element;if(H=="*")H="span";F=new N(F.createElement(H));return v(F,E)}function v(E,F){var H=F._.definition;F=H.attributes;H=B.getStyleText(H);if(F)for(var K in F)E.attr(K,F[K]);if(H)E[0].style.cssText=H;return E}function s(E){var F=E.createBookmark(true),H=E.createIterator();H.enforceRealBlocks=true;H.enlargeBr=true;for(var K,L=E.document;K=H.getNextParagraph();){var O=t(this,L);k(K,O)}E.moveToBookmark(F)}function z(E,F,H){var K="",L="";E=E.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,
function(O,P,S){P&&(K=P);S&&(L=S);return""});return K+E.replace(F,H)+L}function f(E,F){var H=E.html();H=z(H,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,"");H=H.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1");H=H.replace(/([ \t\n\r]+|&nbsp;)/g," ");H=H.replace(/<br\b[^>]*>/gi,"\n");if(M.ie){E=E[0].ownerDocument.createElement("div");E.appendChild(F[0]);F[0].outerHTML="<pre>"+H+"</pre>";F=new N(E.firstChild);F.remove()}else F.html(H);return F}function h(E){var F=[];z(E._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,
function(H,K,L){return K+"</pre>"+L+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(H,K){F.push(K)});return F}function k(E,F){var H=F._4e_name=="pre",K=E._4e_name=="pre",L=!H&&K;if(H&&!K)F=f(E,F);else if(L)F=u(h(E),F);else E._4e_moveChildren(F);E[0].parentNode.replaceChild(F[0],E[0]);H&&l(F)}function l(E){var F;if((F=E._4e_previousSourceNode(true,D.NODE_ELEMENT))&&F._4e_name()=="pre"){var H=z(F.html(),/\n$/,"")+"\n\n"+z(E.html(),/^\n/,"");if(M.ie)E[0].outerHTML="<pre>"+H+"</pre>";else E.html(H);
F.remove()}}function u(E,F){for(var H=F[0].ownerDocument.createDocumentFragment(),K=0;K<E.length;K++){var L=E[K];L=L.replace(/(\r\n|\r)/g,"\n");L=z(L,/^[ \t]*\n/,"");L=z(L,/\n$/,"");L=z(L,/^[ \t]+|[ \t]+$/g,function(P,S){return P.length==1?"&nbsp;":S?" "+(new Array(P.length)).join("&nbsp;"):(new Array(P.length)).join("&nbsp;")+" "});L=L.replace(/\n/g,"<br>");L=L.replace(/[ \t]{2,}/g,function(P){return(new Array(P.length)).join("&nbsp;")+" "});var O=F._4e_clone();O.html(L);H.appendChild(O[0])}return H}
function m(E){var F=E.document;if(E.collapsed){F=t(this,F);E.insertNode(F);E.moveToPosition(F,I.POSITION_BEFORE_END)}else{var H=this.element,K=this._.definition,L,O=y.XHTML_DTD[H]||(L=true,y.XHTML_DTD.span),P=E.createBookmark();E.enlarge(I.ENLARGE_ELEMENT);E.trim();var S=E.createBookmark(),da=S.startNode;S=S.endNode;for(var U=da,X;U&&U[0];){var T=false;if(w._4e_equals(U,S)){U=null;T=true}else{var V=U[0].nodeType,ba=V==D.NODE_ELEMENT?U._4e_name():null;if(ba&&U.attr("_ke_bookmark")){U=U._4e_nextSourceNode(true);
continue}if(!ba||O[ba]&&(U._4e_position(S)|G.POSITION_PRECEDING|G.POSITION_IDENTICAL|G.POSITION_IS_CONTAINED)==G.POSITION_PRECEDING+G.POSITION_IDENTICAL+G.POSITION_IS_CONTAINED&&(!K.childRule||K.childRule(U))){var ca=U.parent();if(ca&&ca[0]&&((y.XHTML_DTD[ca._4e_name()]||y.XHTML_DTD.span)[H]||L)&&(!K.parentRule||K.parentRule(ca))){if(!X&&(!ba||!y.XHTML_DTD.$removeEmpty[ba]||(U._4e_position(S)|G.POSITION_PRECEDING|G.POSITION_IDENTICAL|G.POSITION_IS_CONTAINED)==G.POSITION_PRECEDING+G.POSITION_IDENTICAL+
G.POSITION_IS_CONTAINED)){X=new J(F);X.setStartBefore(U)}if(V==D.NODE_TEXT||V==D.NODE_ELEMENT&&!U[0].childNodes.length){V=U;for(var Y;!V[0].nextSibling&&(Y=V.parent(),O[Y._4e_name()])&&(Y._4e_position(da)|G.POSITION_FOLLOWING|G.POSITION_IDENTICAL|G.POSITION_IS_CONTAINED)==G.POSITION_FOLLOWING+G.POSITION_IDENTICAL+G.POSITION_IS_CONTAINED&&(!K.childRule||K.childRule(Y));)V=Y;X.setEndAfter(V);V[0].nextSibling||(T=true)}}else T=true}else T=true;U=U._4e_nextSourceNode()}if(T&&X&&!X.collapsed){T=t(this,
F);for(V=X.getCommonAncestor();T&&V&&T[0]&&V[0];){if(V._4e_name()==H){for(var Z in K.attributes)T.attr(Z)==V.attr(Z)&&T[0].removeAttribute(Z);for(var ea in K.styles)T._4e_style(ea)==V._4e_style(ea)&&T._4e_style(ea,"");if(!T._4e_hasAttributes()){T=null;break}}V=V.parent()}if(T){T[0].appendChild(X.extractContents());c(this,T);X.insertNode(T);T._4e_mergeSiblings();M.ie||T[0].normalize()}X=null}}da.remove();S.remove();E.moveToBookmark(P);E.shrink(I.SHRINK_TEXT)}}function o(E){E.enlarge(I.ENLARGE_ELEMENT);
var F=E.createBookmark(),H=F.startNode;if(E.collapsed){for(var K=new Q(H.parent()),L,O=0,P;O<K.elements.length&&(P=K.elements[O]);O++){if(P==K.block||P==K.blockLimit)break;if(this.checkElementRemovable(P)){var S=E.checkBoundaryOfElement(P,I.END),da=!S&&E.checkBoundaryOfElement(P,I.START);if(da||S){L=P;L.match=da?"start":"end"}else{P._4e_mergeSiblings();i(this,P)}}}if(L&&L[0]){P=H;for(O=0;;O++){S=K.elements[O];if(w._4e_equals(S,L))break;else if(S.match)continue;else S=S._4e_clone();S[0].appendChild(P[0]);
P=S}w[L.match=="start"?"insertBefore":"insertAfter"](P[0],L[0])}}else{var U=F.endNode,X=this;K=function(){for(var T=new Q(H.parent()),V=new Q(U.parent()),ba=null,ca=null,Y=0;Y<T.elements.length;Y++){var Z=T.elements[Y];if(Z==T.block||Z==T.blockLimit)break;if(X.checkElementRemovable(Z))ba=Z}for(Y=0;Y<V.elements.length;Y++){Z=V.elements[Y];if(Z==V.block||Z==V.blockLimit)break;if(X.checkElementRemovable(Z))ca=Z}ca&&U._4e_breakParent(ca);ba&&H._4e_breakParent(ba)};K();for(L=new N(H[0].nextSibling);L[0]!==
U[0];){O=L._4e_nextSourceNode();if(L[0].nodeType==D.NODE_ELEMENT&&this.checkElementRemovable(L)){L._4e_name()==this.element?i(this,L):e(L,d(this)[L._4e_name()]);if(O[0].nodeType==D.NODE_ELEMENT&&O._4e_contains(H)){K();O=new N(H[0].nextSibling)}}L=O}}E.moveToBookmark(F)}function j(E){var F={};E.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(H,K,L){F[K]=L});return F}function a(E,F){typeof E=="string"&&(E=j(E));typeof F=="string"&&(F=j(F));for(var H in E)if(!(H in F&&
(F[H]==E[H]||E[H]=="inherit"||F[H]=="inherit")))return false;return true}function b(E,F){if(F!==false){F=document.createElement("span");F.style.cssText=E;E=F.style.cssText||""}else E=E;return E.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function g(E){var F=E._AC;if(F)return F;F={};var H=0,K=E.attributes;if(K)for(var L in K){H++;F[L]=K[L]}if(K=B.getStyleText(E)){F.style||H++;F.style=K}F._length=H;return E._AC=F}function d(E){if(E._.overrides)return E._.overrides;
var F=E._.overrides={},H=E._.definition.overrides;if(H){A.isArray(H)||(H=[H]);for(var K=0;K<H.length;K++){var L=H[K],O,P;if(typeof L=="string")O=L.toLowerCase();else{O=L.element?L.element.toLowerCase():E.element;P=L.attributes}L=F[O]||(F[O]={});if(P){L=L.attributes=L.attributes||[];for(var S in P)L.push([S.toLowerCase(),P[S]])}}}return F}function i(E,F){var H=E._.definition,K=A.mix(A.mix({},H.attributes),d(E)[F._4e_name()]);H=H.styles;var L=A.isEmptyObject(K)&&A.isEmptyObject(H);for(var O in K)if(!((O==
"class"||E._.definition.fullMatch)&&F.attr(O)!=p(O,K[O]))){L=L||!!F._4e_hasAttribute(O);F.removeAttr(O)}for(var P in H)if(!(E._.definition.fullMatch&&F._4e_style(P)!=p(P,H[P],true))){L=L||!!F._4e_style(P);F._4e_style(P,"")}L&&n(F)}function p(E,F,H){var K=new N("<span></span>");K[H?"_4e_style":"attr"](E,F);return K[H?"_4e_style":"attr"](E)}function c(E,F){for(var H=d(E),K=F.all(E.element),L=K.length;--L>=0;)i(E,new N(K[L]));for(var O in H)if(O!=E.element){K=F.all(O);for(L=K.length-1;L>=0;L--){var P=
new N(K[L]);e(P,H[O])}}}function e(E,F){if(F=F&&F.attributes)for(var H=0;H<F.length;H++){var K=F[H][0],L;if(L=E.attr(K)){var O=F[H][1];if(O===null||O.test&&O.test(L)||typeof O=="string"&&L==O)E[0].removeAttribute(K)}}n(E)}function n(E){if(!E._4e_hasAttributes()){var F=E[0].firstChild,H=E[0].lastChild;E._4e_remove(true);if(F){F.nodeType==D.NODE_ELEMENT&&w._4e_mergeSiblings(F);H&&!F===H&&H.nodeType==D.NODE_ELEMENT&&w._4e_mergeSiblings(H)}}}var A=KISSY,w=A.DOM,C=y.STYLE={},I=y.RANGE,x=y.Selection,D=
y.NODE,G=y.POSITION,J=y.Range,N=A.Node,M=A.UA,Q=y.ElementPath,R={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},W={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},$=/\s*(?:;\s*|$)/,aa=/#\((.+?)\)/g;C.STYLE_BLOCK=1;C.STYLE_INLINE=2;C.STYLE_OBJECT=3;B.prototype={apply:function(E){r.call(this,E,false)},remove:function(E){r.call(this,E,true)},applyToRange:function(E){return(this.applyToRange=this.type==C.STYLE_INLINE?m:this.type==C.STYLE_BLOCK?s:this.type==
C.STYLE_OBJECT?null:null).call(this,E)},removeFromRange:function(E){return(this.removeFromRange=this.type==C.STYLE_INLINE?o:null).call(this,E)},applyToObject:function(E){v(E,this)},checkElementRemovable:function(E,F){if(!E)return false;var H=this._.definition;if(E._4e_name()==this.element){if(!F&&!E._4e_hasAttributes())return true;H=g(H);if(H._length){for(var K in H)if(K!="_length"){var L=E.attr(K)||"";if(K=="style"?a(H[K],b(L,false)):H[K]==L){if(!F)return true}else if(F)return false}if(F)return true}else return true}if(H=
d(this)[E._4e_name()]){if(!(H=H.attributes))return true;for(F=0;F<H.length;F++){K=H[F][0];if(K=E.attr(K)){L=H[F][1];if(L===null||typeof L=="string"&&K==L||L.test(K))return true}}}return false},checkActive:function(E){switch(this.type){case C.STYLE_BLOCK:return this.checkElementRemovable(E.block||E.blockLimit,true);case C.STYLE_OBJECT:case C.STYLE_INLINE:for(var F=E.elements,H=0,K;H<F.length;H++){K=F[H];if(!(this.type==C.STYLE_INLINE&&(w._4e_equals(K,E.block)||w._4e_equals(K,E.blockLimit))))if(!(this.type==
C.STYLE_OBJECT&&!(K._4e_name()in W)))if(this.checkElementRemovable(K,true))return true}}return false}};B.getStyleText=function(E){var F=E._ST;if(F)return F;F=E.styles;var H=E.attributes&&E.attributes.style||"",K="";if(H.length)H=H.replace($,";");for(var L in F){var O=F[L],P=(L+":"+O).replace($,";");if(O=="inherit")K+=P;else H+=P}if(H.length)H=b(H);H+=K;return E._ST=H};y.Style=B});
KISSY.Editor.add("button",function(){function y(t){y.superclass.constructor.call(this,t);this._init()}var q=KISSY.Editor,B=KISSY,r=B.Node;y.ON="on";y.OFF="off";y.DISABLED="disabled";y.ON_CLASS="ke-triplebutton-on";y.OFF_CLASS="ke-triplebutton-off";y.DISABLED_CLASS="ke-triplebutton-disabled";y.ATTRS={state:{value:"off"},container:{},text:{},contentCls:{},cls:{}};B.extend(y,B.Base,{_init:function(){var t=this.get("container")[0]||this.get("container");this.el=new r("<a class='ke-triplebutton ke-triplebutton-off' href='#' role=\"button\"></a>");
this.el._4e_unselectable();this._attachCls();if(this.get("text"))this.el.html(this.get("text"));else if(this.get("contentCls")){this.el.html("<span class='ke-toolbar-item "+this.get("contentCls")+"'></span>");this.el.one("span")._4e_unselectable()}this.get("title")&&this.el.attr("title",this.get("title"));t.appendChild(this.el[0]);this.el.on("click",this._action,this);this.on("afterStateChange",this._stateChange,this)},_attachCls:function(){var t=this.get("cls");t&&this.el.addClass(t)},_stateChange:function(t){this["_"+
t.newVal]();this._attachCls()},_action:function(t){this.fire(this.get("state")+"Click",t);this.fire("click",t);t.preventDefault()},_on:function(){this.el[0].className="ke-triplebutton ke-triplebutton-on"},_off:function(){this.el[0].className="ke-triplebutton ke-triplebutton-off"},_disabled:function(){this.el[0].className="ke-triplebutton ke-triplebutton-disabled"}});q.TripleButton=y});
KISSY.Editor.add("contextmenu",function(){function y(h){this.cfg=r.clone(h);B.Utils.lazyRun(this,"_prepareShow","_realShow")}function q(h,k){for(var l=0;l<k.length;l++)if(v.test(h,k[l]))return true;return false}var B=KISSY.Editor,r=KISSY,t=r.Node,v=r.DOM,s=r.Event,z=[];y.register=function(h,k){var l=new y(k);z.push({doc:h,rules:k.rules,instance:l});if(!h.ke_contextmenu){h.ke_contextmenu=1;s.on(h,"mousedown",y.hide);s.on(h,"contextmenu",function(u){y.hide.call(this);for(var m=new t(u.target);m;){var o=
false;if(m._4e_name()=="body")break;for(var j=0;j<z.length;j++){var a=z[j].instance,b=z[j].rules;if(h===z[j].doc&&q(m[0],b)){u.preventDefault();o=true;a.show(B.Utils.getXY(u.pageX,u.pageY,h,document));break}}if(o)break;m=m.parent()}})}return l};y.hide=function(){for(var h=0;h<z.length;h++){var k=z[h].instance;this===z[h].doc&&k.hide()}};var f=B.SimpleOverlay;r.augment(y,{_init:function(){var h=this,k=h.cfg,l=k.funcs;h.elDom=new t("<div class='ke-contextmenu'></div>");var u=h.elDom;u.css("width",k.width);
document.body.appendChild(u[0]);h.el=new f({el:u});for(var m in l){k=new t("<a href='#'>"+m+"</a>");u[0].appendChild(k[0]);(function(o,j){o.on("click",function(a){j();h.hide();a.halt()})})(k,l[m])}},hide:function(){this.el&&this.el.hide()},_realShow:function(h){this.el.show(h)},_prepareShow:function(){this._init()},show:function(h){this._prepareShow(h)}});B.ContextMenu=y});
KISSY.Editor.add("overlay",function(){function y(){var f=this;y.superclass.constructor.apply(f,arguments);f._init();if(B.UA.ie===6){f.on("show",function(){var h=f.get("el"),k=parseInt(h.css("width"));h=h[0].offsetHeight;z&&z.css({width:k+"px",height:h+"px"});z&&z.offset(f.get("el").offset())});f.on("hide",function(){z&&z.offset({left:-999,top:-999})})}if(f.get("mask")){f.on("show",function(){v&&v.css({left:"0px",top:"0px"});s&&s.css({left:"0px",top:"0px"})});f.on("hide",function(){v&&v.css({left:"-9999px",
top:"-9999px"});s&&s.css({left:"-9999px",top:"-9999px"})})}f.hide()}var q=KISSY.Editor,B=KISSY,r=B.Node,t=B.DOM,v,s,z;y.init=function(){var f=document.body;v=new r('<div class="ke-mask">&nbsp;</div>');v.css({left:"-9999px",top:"-9999px"});v.css({width:"100%",height:t.docHeight()+"px",opacity:0.4});v.appendTo(f);if(B.UA.ie==6){z=new r("<iframe class='ke-dialog-iframe'></iframe>");f.appendChild(z[0]);s=new r("<iframe class='ke-mask'></iframe>");s.css({left:"-9999px",top:"-9999px"});s.css({width:"100%",
height:t.docHeight()+"px",opacity:0.4});s.appendTo(f)}y.init=null};y.ATTRS={title:{value:""},width:{value:"450px"},visible:{value:true},mask:{value:false}};B.extend(y,B.Base,{_init:function(){var f=this,h=f.get("el");f.on("afterVisibleChange",function(k){if(k=k.newVal){typeof k=="boolean"?f.center():h.offset(k);f.fire("show")}else{h.css({left:"-9999px",top:"-9999px"});f.fire("hide")}});if(!h){h=new r("<div class='ke-dialog' style='width:"+f.get("width")+"'><div class='ke-hd clearfix'><div class='ke-hd-title'><h1>"+
f.get("title")+"</h1></div><div class='ke-hd-x'><a class='ke-close' href='#'>X</a></div></div><div class='ke-bd'></div><div class='ke-ft'><a href='#' class='ke-focus'></a></div></div>");document.body.appendChild(h[0]);f.set("el",h);f.el=h;f.body=h.one(".ke-bd");f._close=h.one(".ke-close");f._title=h.one(".ke-hd-title").one("h1");f.on("titleChange",function(k){f._title.html(k.newVal)});f.on("widthChange",function(k){f.el.css("width",k.newVal)});f._close.on("click",function(k){k.preventDefault();f.hide()})}},
center:function(){var f=this.get("el"),h=parseInt(f.css("width")),k=f[0].offsetHeight,l=t.viewportWidth(),u=t.viewportHeight();h=(l-h)/2+t.scrollLeft();k=(u-k)/2+t.scrollTop();f.css({left:h+"px",top:k+"px"})},_prepareShow:function(){y.init()},_realShow:function(f){this.get("el");this.set("visible",f||true)},show:function(f){this._prepareShow(f)},hide:function(){this.get("el");this.set("visible",false)}});q.Utils.lazyRun(y.prototype,"_prepareShow","_realShow");q.SimpleOverlay=y});
KISSY.Editor.add("clipboard",function(y){var q=KISSY.Editor,B=KISSY,r=B.Node,t=B.UA,v=q.Range,s=q.RANGE,z=B.Event;q.Paste||function(){function f(h){this.editor=h;this._init()}B.augment(f,{_init:function(){var h=this.editor;t.ie?z.on(h.document,"keydown",this._paste,this):z.on(h.document,"paste",this._paste,this)},_paste:function(h){if(!(h.type==="keydown"&&!(h.keyCode===86&&(h.ctrlKey||h.metaKey)))){var k=this.editor;h=k.document;var l=k.getSelection(),u=new v(h),m=new r(t.webkit?"<body></body>":
"<div></div>",null,h);t.webkit&&m[0].appendChild(h.createTextNode("\u00a0"));h.body.appendChild(m[0]);m.css({position:"absolute",top:l.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});m.css("left","-1000px");var o=l.createBookmarks();u.setStartAt(m,s.POSITION_AFTER_START);u.setEndAt(m,s.POSITION_BEFORE_END);u.select(true);setTimeout(function(){m.remove();var j;m=t.webkit&&(j=m._4e_first())&&j[0]&&j.hasClass("Apple-style-span")?j:m;l.selectBookmarks(o);k.insertHtml(m.html())},
0)}}});q.Paste=f}();y.addPlugin(function(){new q.Paste(y)})});
KISSY.Editor.add("color",function(y){function q(i){return("0"+i).slice(i.length-1,i.length+1)}function B(i){i=t.trim(i);if(i.charAt(0)=="#")i=i.substring(1);i=i.replace(/\s+/g,"");var p="";if(/^[0-9a-f]{3,3}$/i.test(i))p=i.replace(/[0-9a-f]/ig,function(e){return e+e});else{var c=i.match(k);if(c&&c[0])for(i=1;i<4;i++)p+=q(parseInt(c[i]).toString(16));else p=i}return"#"+p.toLowerCase()}for(var r=KISSY.Editor,t=KISSY,v=t.Node,s=t.Event,z=r.SimpleOverlay,f=r.Style,h=t.DOM,k=/^rgb\((\d+),(\d+),(\d+)\)$/i,
l="000,800000,8B4513,2F4F4F,008080,000080,4B0082,696969,B22222,A52A2A,DAA520,006400,40E0D0,0000CD,800080,808080,F00,FF8C00,FFD700,008000,0FF,00F,EE82EE,A9A9A9,FFA07A,FFA500,FFFF00,00FF00,AFEEEE,ADD8E6,DDA0DD,D3D3D3,FFF0F5,FAEBD7,FFFFE0,F0FFF0,F0FFFF,F0F8FF,E6E6FA,FFF".split(/,/),u={element:"span",styles:{color:"#(color)"},overrides:[{element:"font",attributes:{color:null}}]},m={element:"span",styles:{"background-color":"#(color)"}},o="<div class='ke-popup-wrap ke-color-wrap'><a class='ke-color-remove' href=\"javascript:void('\u6e05\u9664');\"><span>\u6e05\u9664</span></a><table>",
j={},a={},b=0;b<5;b++){o+="<tr>";for(var g=0;g<8;g++){var d=B(l[8*b+g]);o+="<td>";o+="<a href='javascript:void(0);' class='ke-color-a'><span style='background-color:"+d+"'></span></a>";o+="</td>";j[d]=new f(m,{color:d});a[d]=new f(u,{color:d})}o+="</tr>"}j.inherit=new f(m,{color:"inherit"});a.inherit=new f(u,{color:"inherit"});o+="</table></div>";r.ColorSupport||function(){function i(c){i.superclass.constructor.call(this,c);this._init()}var p=r.TripleButton;i.ATTRS={editor:{},styles:{},contentCls:{},
text:{}};t.extend(i,t.Base,{_init:function(){var c=this.get("editor").toolBarDiv;c=new p({container:c,title:this.get("title"),contentCls:this.get("contentCls")});c.on("offClick",this._showColors,this);this.el=c;r.Utils.lazyRun(this,"_prepare","_real")},_hidePanel:function(c){var e=this;h._4e_ascendant(c.target,function(n){return n[0]===e.el.el[0]},true)||this.colorWin.hide()},_selectColor:function(c){c.halt();var e=this.get("editor");c=c.target;if(h._4e_name(c)=="span"||h._4e_name(c)=="a"){c=new v(c);
if(c._4e_name()=="a")c=c.one("span");var n=this.get("styles");e.fire("save");c._4e_style("background-color")?n[B(c._4e_style("background-color"))].apply(e.document):n.inherit.remove(e.document);e.fire("save");e.focus();this.colorWin.hide()}},_prepare:function(){this.colorPanel=new v(o);this.colorWin=new z({el:this.colorPanel,mask:false});document.body.appendChild(this.colorPanel[0]);this.colorPanel.on("click",this._selectColor,this);s.on(document,"click",this._hidePanel,this);s.on(y.document,"click",
this._hidePanel,this)},_real:function(){var c=this.el.el.offset();c.top+=this.el.el.height()+5;if(c.left+this.colorPanel.width()>h.viewportWidth()-60)c.left=h.viewportWidth()-this.colorPanel.width()-60;this.colorWin.show(c)},_showColors:function(c){this._prepare(c)}});r.ColorSupport=i}();y.addPlugin(function(){new r.ColorSupport({editor:y,styles:j,title:"\u80cc\u666f\u989c\u8272",contentCls:"ke-toolbar-bgcolor",text:"bgcolor"});new r.ColorSupport({editor:y,styles:a,title:"\u6587\u672c\u989c\u8272",
contentCls:"ke-toolbar-color",text:"color"})})});
KISSY.Editor.add("elementpaths",function(y){var q=KISSY.Editor,B=KISSY,r=B.Node,t=B.DOM;q.ElementPaths||function(){function v(s){this.cfg=s;this._cache=[];this._init()}B.augment(v,{_init:function(){var s=this.cfg.editor;this.holder=new r("<div>");this.holder.appendTo(s.statusDiv);s.on("selectionChange",this._selectionChange,this)},_selectionChange:function(s){var z=this.cfg.editor,f=this.holder;f=f[0]||f;s=s.path.elements;var h,k;h=this._cache;for(k=0;k<h.length;k++){h[k].detach("click");h[k].remove()}this._cache=
[];for(k=0;k<s.length;k++){h=s[k];var l=new r("<a href='#' class='elementpath'>"+(h.attr("_ke_real_element_type")||h._4e_name())+"</a>");this._cache.push(l);(function(u){l.on("click",function(m){m.halt();z.focus();setTimeout(function(){z.getSelection().selectElement(u)},50)})})(h);f.firstChild?t.insertBefore(l[0],f.firstChild):f.appendChild(l[0])}}});q.ElementPaths=v}();y.addPlugin(function(){new q.ElementPaths({editor:y})})});
KISSY.Editor.add("enterkey",function(y){var q=KISSY.Editor,B=KISSY,r=B.UA,t=/^h[1-6]$/,v=q.XHTML_DTD,s=B.Node,z=B.Event,f=q.Walker,h=q.ElementPath;q.enterBlock||function(){function k(m){m=m.getSelection().getRanges();for(var o=m.length-1;o>0;o--)m[o].deleteContents();return m[0]}function l(m){var o=k(m),j=o.document;if(o.checkStartOfBlock()&&o.checkEndOfBlock()){var a=(new h(o.startContainer)).block;if(a&&(a._4e_name()=="li"||a.parent()._4e_name()=="li")){m.execCommand("outdent");return}}var b=o.splitBlock("p");
if(b){m=b.previousBlock;a=b.nextBlock;var g=b.wasStartOfBlock,d=b.wasEndOfBlock,i;if(a){i=a.parent();if(i._4e_name()=="li"){a._4e_breakParent(i);a._4e_move(a._4e_next(),true)}}else if(m&&(i=m.parent())&&i._4e_name()=="li"){m._4e_breakParent(i);o.moveToElementEditablePosition(m._4e_next());m._4e_move(m._4e_previous())}if(!g&&!d){if(a._4e_name()=="li"&&(i=a._4e_first(f.invisible(true)))&&B.inArray(i._4e_name(),["ul","ol"]))(r.ie?new s(j.createTextNode("\u00a0")):new s(j.createElement("br"))).insertBefore(i);
a&&o.moveToElementEditablePosition(a)}else{var p;if(m){if(m._4e_name()=="li"||!t.test(m._4e_name()))p=m._4e_clone()}else if(a)p=a._4e_clone();p||(p=new s("p",null,j));if(i=b.elementPath){b=0;for(var c=i.elements.length;b<c;b++){var e=i.elements[b];if(e._4e_equals(i.block)||e._4e_equals(i.blockLimit))break;if(v.$removeEmpty[e.getName()]){e=e._4e_clone();p._4e_moveChildren(e);p.append(e)}}}r.ie||p._4e_appendBogus();o.insertNode(p);if(r.ie&&g&&(!d||!m[0].childNodes.length)){o.moveToElementEditablePosition(d?
m:p);o.select()}o.moveToElementEditablePosition(g&&!d?a:p)}if(!r.ie)if(a){j=new s(j.createElement("span"));j.html("&nbsp;");o.insertNode(j);j._4e_scrollIntoView();o.deleteContents()}else p._4e_scrollIntoView();o.select()}}function u(m){z.on(m.document,"keydown",function(o){if(o.keyCode===13)if(!o.shiftKey){m.execCommand("enterBlock");o.preventDefault()}})}u.enterBlock=l;q.EnterKey=u}();y.addPlugin(function(){y.addCommand("enterBlock",{exec:q.EnterKey.enterBlock});q.EnterKey(y)})});
KISSY.Editor.add("fakeobjects",function(){var y=KISSY.Editor,q=KISSY,B=q.Node,r=y.NODE,t=y.HtmlParser,v=q.Editor,s=y.HtmlDataProcessor,z=s&&s.htmlFilter;y.FakeObjects||function(){var f={elements:{$:function(h){var k=h.attributes;if((k=(k=(k=k&&k._ke_realelement)&&new t.Fragment.FromHtml(decodeURIComponent(k)))&&k.children[0])&&h.attributes._ke_resizable){var l=h.attributes.style;if(l){var u=/(?:^|\s)width\s*:\s*(\d+)/i.exec(l);h=u&&u[1];l=(u=/(?:^|\s)height\s*:\s*(\d+)/i.exec(l))&&u[1];if(h)k.attributes.width=
h;if(l)k.attributes.height=l}}return k}}};z&&z.addRules(f);s&&q.mix(s,{createFakeParserElement:function(h,k,l,u){var m;m=new t.BasicWriter;h.writeHtml(m);m=m.getHtml();var o=h.attributes.style;if(h.attributes.width)o="width:"+h.attributes.width+"px;"+o;if(h.attributes.height)o="height:"+h.attributes.height+"px;"+o;h={"class":k,src:y.Config.base+"assets/spacer.gif",_ke_realelement:encodeURIComponent(m),_ke_real_node_type:h.type,style:o,align:h.attributes.align||""};if(l)h._ke_real_element_type=l;if(u)h._ke_resizable=
u;return new t.Element("img",h)}});y.FakeObjects=1}();q.augment(v,{createFakeElement:function(f,h,k,l){var u=f.attr("style")||"";if(f.attr("width"))u="width:"+f.attr("width")+"px;"+u;if(f.attr("height"))u="height:"+f.attr("height")+"px;"+u;f={"class":h,src:y.Config.base+"assets/spacer.gif",_ke_realelement:encodeURIComponent(f._4e_outerHtml()),_ke_real_node_type:f[0].nodeType,align:f.attr("align")||"",style:u};if(k)f._ke_real_element_type=k;if(l)f._ke_resizable=l;return new B("<img/>",f,this.document)},
restoreRealElement:function(f){if(f.attr("_ke_real_node_type")!=r.NODE_ELEMENT)return null;f=decodeURIComponent(f.attr("_ke_realelement"));var h=new B("<div>",null,this.document);h.html(f);return h._4e_first(function(k){return k[0].nodeType==r.NODE_ELEMENT})._4e_remove()}})});
KISSY.Editor.add("flash",function(y){var q=KISSY.Editor,B=KISSY,r=B.Event,t=q.ContextMenu,v=B.Node,s=q.TripleButton,z=q.SimpleOverlay,f=/\.swf(?:$|\?)/i,h=q.HtmlDataProcessor,k="niftyplayer.swf",l=h&&h.dataFilter,u=["img.ke_flash"];q.Flash||function(){function o(b){b=b.attributes;return b.type=="application/x-shockwave-flash"||f.test(b.src||"")}function j(b){return b.indexOf(k)!=-1}function a(b){this.editor=b;b._toolbars=b._toolbars||{};b._toolbars.flash=this;this._init()}l&&l.addRules({elements:{"ke:object":function(b){var g=
b.attributes,d="ke_flash",i="flash";if(!(g.classid&&String(g.classid).toLowerCase())){for(g=0;g<b.children.length;g++)if(b.children[g].name=="ke:embed"){if(!o(b.children[g]))return null;if(j(b.children[g].attributes.src)){d="ke_music";i="music"}return h.createFakeParserElement(b,d,i,true)}return null}for(g=0;g<b.children.length;g++){var p=b.children[g];if(p.name=="ke:param"&&p.attributes.name=="movie")if(j(p.attributes.value)){d="ke_music";i="music";break}}return h.createFakeParserElement(b,d,i,true)},
"ke:embed":function(b){if(!o(b))return null;var g="ke_flash",d="flash";if(j(b.attributes.src)){g="ke_music";d="music"}return h.createFakeParserElement(b,g,d,true)}}},5);B.augment(a,{_init:function(){var b=this.editor,g={};this.el=new s({container:b.toolBarDiv,contentCls:"ke-toolbar-flash",title:"Flash"});this.el.on("click",this._showConfig,this);r.on(b.document,"dblclick",this._dbclick,this);for(var d in m)(function(i){g[i]=function(){b.fire("save");b.focus();m[i](b);b.fire("save")}})(d);t.register(b.document,
{rules:u,width:"120px",funcs:g});q.Utils.lazyRun(this,"_prepareShow","_realShow")},_dbclick:function(b){var g=new v(b.target);if(g._4e_name()==="img"&&g.hasClass("ke_flash")){this.selectedFlash=g;this._showConfig();b.halt()}},_prepareShow:function(){var b=this;b.d=new z({title:"\u7f16\u8f91flash",width:"350px",mask:true});b.d.on("hide",function(){b.selectedFlash=null;y.focus()});b.d.body.html("<div style='margin:10px;'><p><label>\u5730\u5740\uff1a<input class='ke-flash-url' style='width:280px' /></label></p><p style='margin:5px 0'><label>\u5bbd\u5ea6\uff1a<input class='ke-flash-width' style='width:120px' /></label>&nbsp;&nbsp;<label>\u9ad8\u5ea6\uff1a<input class='ke-flash-height' style='width:110px' /></label></p><p style='margin:5px 0;text-align:right;'><button>\u786e\u5b9a</button></p></div>");
b._initD()},_realShow:function(){this.d.show()},_showConfig:function(){var b=this.editor,g=this.selectedFlash;this._prepareShow();if(g){g=b.restoreRealElement(g);g.attr("width")&&this.dWidth.val(parseInt(g.attr("width")));g.attr("height")&&this.dHeight.val(parseInt(g.attr("height")));if(g._4e_name()=="ke:object"){var d=g._4e_getElementsByTagName("param","ke");for(b=0;b<d.length;b++)if((d[b].attr("name")||"").toLowerCase()=="movie")this.dUrl.val(d[b].attr("value"));d=g._4e_getElementsByTagName("embed",
"ke");for(b=0;b<d.length;b++)this.dUrl.val(d[b].attr("src"));g=g._4e_getElementsByTagName("object","ke");for(b=0;b<g.length;b++)this.dUrl.val(g[b].attr("data"))}else g._4e_name()=="ke:embed"&&this.dUrl.val(g.attr("src"))}},_initD:function(){var b=this.d;this.dHeight=b.el.one(".ke-flash-height");this.dWidth=b.el.one(".ke-flash-width");this.dUrl=b.el.one(".ke-flash-url");b.el.one("button").on("click",this._gen,this)},_gen:function(){var b=this.editor,g=this.dUrl.val();if(g){g=new v("<ke:object "+(parseInt(this.dWidth.val())?
" width='"+parseInt(this.dWidth.val())+"' ":" ")+(parseInt(this.dHeight.val())?" height='"+parseInt(this.dHeight.val())+"' ":" ")+'classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0"><ke:param name="quality" value="high" ></ke:param><ke:param name="movie" value="'+g+'" ></ke:param><ke:embed '+(parseInt(this.dWidth.val())?" width='"+parseInt(this.dWidth.val())+"' ":" ")+(parseInt(this.dHeight.val())?" height='"+
parseInt(this.dHeight.val())+"' ":" ")+'pluginspage="http://www.macromedia.com/go/getflashplayer" quality="high" src="'+g+'" type="application/x-shockwave-flash"></ke:embed></ke:object>',null,b.document);g=b.createFakeElement?b.createFakeElement(g,"ke_flash","flash",true):g;b.insertElement(g);this.d.hide()}}});q.Flash=a}();var m={"\u7f16\u8f91Flash":function(o){var j=o.getSelection();if(j=(j=j&&j.getStartElement())&&j._4e_ascendant("img",true))if(j.hasClass("ke_flash")){o=o._toolbars.flash;o.selectedFlash=
j;o._showConfig()}}};y.addPlugin(function(){new q.Flash(y)})});
KISSY.Editor.add("font",function(y){var q=KISSY.Editor,B=KISSY,r=q.Style,t=q.TripleButton,v=B.Node,s=["8px","10px","12px","14px","18px","24px","36px","48px","60px","72px","84px","96px","108px"],z={},f="<select title='\u5927\u5c0f' style='width:110px;height:21px;'><option value=''>\u5927\u5c0f / \u6e05\u9664</option>",h={element:"span",styles:{"font-size":"#(size)"},overrides:[{element:"font",attributes:{size:null}}]},k=["\u5b8b\u4f53","\u9ed1\u4f53","\u96b6\u4e66","\u6977\u4f53_GB2312","\u5fae\u8f6f\u96c5\u9ed1",
"Georgia","Times New Roman","Impact","Courier New","Arial","Verdana","Tahoma"],l={},u="<select title='\u5b57\u4f53' ><option value=''>\u5b57\u4f53 / \u6e05\u9664</option>",m={element:"span",styles:{"font-family":"#(family)"},overrides:[{element:"font",attributes:{face:null}}]},o;for(o=0;o<s.length;o++){var j=s[o];z[j]=new r(h,{size:j});f+="<option style='font-size:"+j+"' value='"+j+"'>"+j+"</option>"}f+="</select>";for(o=0;o<k.length;o++){s=k[o];l[s]=new r(m,{family:s});u+="<option style='font-family:"+
s+"'  value='"+s+"'>"+s+"</option>"}u+="</select>";q.Font||function(){function a(g){a.superclass.constructor.call(this,g);this._init()}function b(g){b.superclass.constructor.call(this,g);this._init()}a.ATTRS={v:{value:""},html:{},styles:{},editor:{}};B.extend(a,B.Base,{_init:function(){var g=this.get("editor"),d=g.toolBarDiv,i=this.get("html");this.el=new v(i);d[0].appendChild(this.el[0]);this.el.on("change",this._change,this);g.on("selectionChange",this._selectionChange,this);this.on("afterVChange",
this._vChange,this)},_vChange:function(g){var d=this.get("editor"),i=g.newVal;g=g.preVal;var p=this.get("styles");d.focus();d.fire("save");if(i)p[i].apply(d.document);else{i=g;p[i].remove(d.document)}d.fire("save")},_change:function(){this.set("v",this.el.val())},_selectionChange:function(g){this.get("editor");var d=this.get("v");g=g.path.elements;for(var i=this.get("styles"),p=0,c;p<g.length;p++){c=g[p];for(var e in i)if(i[e].checkElementRemovable(c,true)){if(e!=d){this._set("v",e);this.el.val(e)}return}}if(d!=
""){this._set("v","");this.el.val("")}}});b.ATTRS={editor:{},text:{},contentCls:{},title:{},style:{}};B.extend(b,B.Base,{_init:function(){var g=this.get("editor"),d=this.get("text");this.get("style");var i=this.get("title");this.el=new t({text:d,title:i,contentCls:this.get("contentCls"),container:g.toolBarDiv});this.el.on("offClick",this._on,this);this.el.on("onClick",this._off,this);g.on("selectionChange",this._selectionChange,this)},_on:function(){var g=this.get("editor");this.get("text");var d=
this.get("style");this.get("title");d.apply(g.document);g.notifySelectionChange();g.focus()},_off:function(){var g=this.get("editor");this.get("text");var d=this.get("style");this.get("title");d.remove(g.document);g.notifySelectionChange();g.focus()},_selectionChange:function(g){this.get("editor");this.get("text");var d=this.get("style");this.get("title");d.checkActive(g.path)?this.el.set("state",t.ON):this.el.set("state",t.OFF)}});a.SingleFont=b;q.Font=a}();y.addPlugin(function(){new q.Font({editor:y,
styles:z,html:f});new q.Font({editor:y,styles:l,html:u});new q.Font.SingleFont({contentCls:"ke-toolbar-bold",title:"\u7c97\u4f53",editor:y,style:new r({element:"strong"})});new q.Font.SingleFont({contentCls:"ke-toolbar-italic",title:"\u659c\u4f53",editor:y,style:new r({element:"em"})});new q.Font.SingleFont({contentCls:"ke-toolbar-underline",title:"\u4e0b\u5212\u7ebf",editor:y,style:new r({element:"u"})});new q.Font.SingleFont({contentCls:"ke-toolbar-strikeThrough",title:"\u5220\u9664\u7ebf",editor:y,
style:new r({element:"del"})})})});
KISSY.Editor.add("format",function(y){var q=KISSY.Editor,B=KISSY,r=B.Node;q.Format||function(){function t(l){t.superclass.constructor.call(this,l);this.el=new r(v);this._init()}var v="<select style='height:21px' title='\u683c\u5f0f'>",s={"\u6807\u9898 / \u6e05\u9664":"p","\u6807\u98981":"h1","\u6807\u98982":"h2","\u6807\u98983":"h3","\u6807\u98984":"h4","\u6807\u98985":"h5","\u6807\u98986":"h6"},z={h1:"2em",h2:"1.5em",h3:"1.17em",h4:"1em",h5:"0.83em",h6:"0.67em"},f={},h=q.Style;for(var k in s)if(s[k]){f[s[k]]=
new h({element:s[k]});v+="<option style='font-size:"+z[s[k]]+"'value='"+s[k]+"'>"+k+"</option>"}v+="</select>";t.ATTRS={v:{value:"p"},editor:{}};B.extend(t,B.Base,{_init:function(){var l=this.get("editor"),u=this.el;l.toolBarDiv[0].appendChild(this.el[0]);u.on("change",this._change,this);l.on("selectionChange",this._selectionChange,this);this.on("afterVChange",this._vChange,this)},_vChange:function(l){var u=this.get("editor");l=l.newVal;u.focus();u.fire("save");f[l].apply(u.document);u.fire("save");
u.fire("formatChange",this.get("v"))},_change:function(){this.set("v",this.el.val())},_selectionChange:function(l){this.get("editor");var u=this.get("v");l=l.path;for(var m in f)if(f[m].checkActive(l)){if(m!=u){this._set("v",m);this.el.val(m)}return}this._set("v","p");this.el.val("p")}});q.Format=t}();y.addPlugin(function(){new q.Format({editor:y})})});
KISSY.Editor.add("htmlparser-basicwriter",function(){function y(){this._={output:[]}}var q=KISSY.Editor,B=q.Utils;if(!q.HtmlParser.BasicWriter){KISSY.augment(y,{openTag:function(r){this._.output.push("<",r)},openTagClose:function(r,t){t?this._.output.push(" />"):this._.output.push(">")},attribute:function(r,t){if(typeof t=="string")t=B.htmlEncodeAttr(t);this._.output.push(" ",r,'="',t,'"')},closeTag:function(r){this._.output.push("</",r,">")},text:function(r){this._.output.push(r)},comment:function(r){this._.output.push("<!--",
r,"--\>")},write:function(r){this._.output.push(r)},reset:function(){this._.output=[];this._.indent=false},getHtml:function(r){var t=this._.output.join("");r&&this.reset();return t}});q.HtmlParser.BasicWriter=y}});
KISSY.Editor.add("htmlparser-element",function(){function y(t,v){this.name=t;this.attributes=v||(v={});this.children=[];var s=v._ke_real_element_type||t;v=q.XHTML_DTD;s=!!(v.$nonBodyContent[s]||v.$block[s]||v.$listItem[s]||v.$tableContent[s]||v.$nonEditable[s]||s=="br");var z=!!v.$empty[t];this.isEmpty=z;this.isUnknown=!v[t];this._={isBlockLike:s,hasInlineStarted:z||!s}}var q=KISSY.Editor;if(!q.HtmlParser.Element){var B=q.NODE,r=function(t,v){t=t[0];v=v[0];return t<v?-1:t>v?1:0};KISSY.augment(y,{type:B.NODE_ELEMENT,
add:q.HtmlParser.Fragment.prototype.add,clone:function(){return new y(this.name,this.attributes)},writeHtml:function(t,v){var s=this.attributes,z=this,f=z.name,h,k,l,u;z.filterChildren=function(){if(!u){var j=new q.HtmlParser.BasicWriter;q.HtmlParser.Fragment.prototype.writeChildrenHtml.call(z,j,v);z.children=(new q.HtmlParser.Fragment.fromHtml(j.getHtml())).children;u=1}};if(v){for(;;){if(!(f=v.onElementName(f)))return;z.name=f;if(!(z=v.onElement(z)))return;z.parent=this.parent;if(z.name==f)break;
if(z.type!=B.NODE_ELEMENT){z.writeHtml(t,v);return}f=z.name;if(!f){this.writeChildrenHtml.call(z,t,u?null:v);return}}s=z.attributes}t.openTag(f,s);for(var m=[],o=0;o<2;o++)for(h in s){k=h;l=s[h];if(o==1)m.push([h,l]);else if(v){for(;;)if(k=v.onAttributeName(h))if(k!=h){delete s[h];h=k}else break;else{delete s[h];break}if(k)if((l=v.onAttribute(z,k,l))===false)delete s[k];else s[k]=l}}t.sortAttributes&&m.sort(r);s=m.length;for(o=0;o<s;o++){h=m[o];t.attribute(h[0],h[1])}t.openTagClose(f,z.isEmpty);if(!z.isEmpty){this.writeChildrenHtml.call(z,
t,u?null:v);t.closeTag(f)}},writeChildrenHtml:function(){q.HtmlParser.Fragment.prototype.writeChildrenHtml.apply(this,arguments)}});q.HtmlParser.Element=y}});
KISSY.Editor.add("htmlparser-filter",function(){function y(f){this._={elementNames:[],attributeNames:[],elements:{$length:0},attributes:{$length:0}};f&&this.addRules(f,10)}function q(f,h){for(var k=0;f&&k<h.length;k++){var l=h[k];f=f.replace(l[0],l[1])}return f}function B(f,h,k){if(typeof h=="function")h=[h];var l,u;u=f.length;var m=h&&h.length;if(m){for(l=0;l<u&&f[l].pri<k;l++);for(u=m-1;u>=0;u--)if(m=h[u]){m.pri=k;f.splice(l,0,m)}}}function r(f,h,k){if(h)for(var l in h){var u=f[l];f[l]=t(u,h[l],
k);u||f.$length++}}function t(f,h,k){if(h){h.pri=k;if(f){if(f.splice)B(f,h,k);else{f=f.pri>k?[h,f]:[f,h];f.filter=v}return f}else return h.filter=h}}function v(f){for(var h=f.type||f instanceof s.HtmlParser.Fragment,k=0;k<this.length;k++){if(h)var l=f.type,u=f.name;var m=this[k].apply(window,arguments);if(m===false)return m;if(h){if(m&&(m.name!=u||m.type!=l))return m}else if(typeof m!="string")return m;m!=undefined&&(f=m)}return f}var s=KISSY.Editor,z=s.NODE;if(!s.HtmlParser.Filter){KISSY.augment(y,
{addRules:function(f,h){if(typeof h!="number")h=10;B(this._.elementNames,f.elementNames,h);B(this._.attributeNames,f.attributeNames,h);r(this._.elements,f.elements,h);r(this._.attributes,f.attributes,h);this._.text=t(this._.text,f.text,h)||this._.text;this._.comment=t(this._.comment,f.comment,h)||this._.comment;this._.root=t(this._.root,f.root,h)||this._.root},onElementName:function(f){return q(f,this._.elementNames)},onAttributeName:function(f){return q(f,this._.attributeNames)},onText:function(f){var h=
this._.text;return h?h.filter(f):f},onComment:function(f,h){var k=this._.comment;return k?k.filter(f,h):f},onFragment:function(f){var h=this._.root;return h?h.filter(f):f},onElement:function(f){for(var h=[this._.elements["^"],this._.elements[f.name],this._.elements.$],k,l=0;l<3;l++)if(k=h[l]){k=k.filter(f,this);if(k===false)return null;if(k&&k!=f)return this.onNode(k);if(f.parent&&!f.name)break}return f},onNode:function(f){var h=f.type;return h==z.NODE_ELEMENT?this.onElement(f):h==z.NODE_TEXT?new s.HtmlParser.Text(this.onText(f.value)):
null},onAttribute:function(f,h,k){if(h=this._.attributes[h]){f=h.filter(k,f,this);if(f===false)return false;if(typeof f!="undefined")return f}return k}});s.HtmlParser.Filter=y}});
KISSY.Editor.add("htmlparser-fragment",function(){function y(){this.children=[];this.parent=null;this._={isBlockLike:true,hasInlineStarted:false}}var q=KISSY.Editor;if(!q.HtmlParser.Fragment){var B={colgroup:1,dd:1,dt:1,li:1,option:1,p:1,td:1,tfoot:1,th:1,thead:1,tr:1},r=KISSY,t=q.Utils,v=q.NODE,s=q.XHTML_DTD,z=t.mix({table:1,ul:1,ol:1,dl:1},s.table,s.ul,s.ol,s.dl),f=s.$list,h=s.$listItem;y.FromHtml=function(k,l){function u(e){var n;if(b.length>0)for(var A=0;A<b.length;A++){var w=b[A],C=w.name,I=
s[C],x=d.name&&s[d.name];if((!x||x[C])&&(!e||!I||I[e]||!s[e])){if(!n){m();n=1}w=w.clone();w.parent=d;d=w;b.splice(A,1);A--}}}function m(){for(;g.length;)d.add(g.shift())}function o(e,n,A){n=n||d||a;if(l&&!n.type){var w,C;if((w=e.attributes&&(C=e.attributes._ke_real_element_type)?C:e.name)&&!(w in s.$body)&&!(w in s.$nonBodyContent)){w=d;d=n;j.onTagOpen(l,{});n=d;if(A)d=w}}if(e._.isBlockLike&&e.name!="pre"){A=e.children.length;if((w=e.children[A-1])&&w.type==v.NODE_TEXT)if(C=t.rtrim(w.value))w.value=
C;else e.children.length=A-1}n.add(e);if(e.returnPoint){d=e.returnPoint;delete e.returnPoint}}var j=new q.HtmlParser,a=new y,b=[],g=[],d=a,i=false,p;j.onTagOpen=function(e,n,A){var w=new q.HtmlParser.Element(e,n);if(w.isUnknown&&A)w.isEmpty=true;if(s.$removeEmpty[e])b.push(w);else{if(e=="pre")i=true;else if(e=="br"&&i){d.add(new q.HtmlParser.Text("\n"));return}if(e=="br")g.push(w);else{var C=d.name,I=C&&(s[C]||(d._.isBlockLike?s.div:s.span));if(I&&!w.isUnknown&&!d.isUnknown&&!I[e]){I=false;var x;
if(e in f&&C in f){C=d.children;(C=C[C.length-1])&&C.name in h||o(C=new q.HtmlParser.Element("li"),d);p=d;x=C}else if(e==C)o(d,d.parent);else{if(z[C])p||(p=d);else{o(d,d.parent,true);B[C]||b.unshift(d)}I=true}d=x?x:d.returnPoint||d.parent;if(I){j.onTagOpen.apply(this,arguments);return}}u(e);m();w.parent=d;w.returnPoint=p;p=0;if(w.isEmpty)o(w);else d=w}}};j.onTagClose=function(e){for(var n=b.length-1;n>=0;n--)if(e==b[n].name){b.splice(n,1);return}for(var A=[],w=[],C=d;C.type&&C.name!=e;){C._.isBlockLike||
w.unshift(C);A.push(C);C=C.parent}if(C.type){for(n=0;n<A.length;n++){var I=A[n];o(I,I.parent)}d=C;if(d.name=="pre")i=false;C._.isBlockLike&&m();o(C,C.parent);if(C==d)d=d.parent;b=b.concat(w)}if(e=="body")l=false};j.onText=function(e){if(!d._.hasInlineStarted&&!i){e=t.ltrim(e);if(e.length===0)return}m();u();if(l&&(!d.type||d.name=="body")&&t.trim(e))this.onTagOpen(l,{});i||(e=e.replace(/[\t\r\n ]{2,}|[\t\r\n]/g," "));d.add(new q.HtmlParser.Text(e))};j.onCDATA=function(){};j.onComment=function(){};
j.parse(k);for(m();d.type;){k=d.parent;var c=d;if(l&&(!k.type||k.name=="body")&&!s.$body[c.name]){d=k;j.onTagOpen(l,{});k=d}k.add(c);d=k}return a};r.augment(y,{add:function(k){var l=this.children.length;if(l=l>0&&this.children[l-1]||null){if(k._.isBlockLike&&l.type==v.NODE_TEXT){l.value=t.rtrim(l.value);if(l.value.length===0){this.children.pop();this.add(k);return}}l.next=k}k.previous=l;k.parent=this;this.children.push(k);this._.hasInlineStarted=k.type==v.NODE_TEXT||k.type==v.NODE_ELEMENT&&!k._.isBlockLike},
writeHtml:function(k,l){var u;this.filterChildren=function(){var m=new q.HtmlParser.BasicWriter;this.writeChildrenHtml.call(this,m,l,true);m=m.getHtml();this.children=(new y.FromHtml(m)).children;u=1};!this.name&&l&&l.onFragment(this);this.writeChildrenHtml(k,u?null:l)},writeChildrenHtml:function(k,l){for(var u=0;u<this.children.length;u++)this.children[u].writeHtml(k,l)}});q.HtmlParser.Fragment=y}});
KISSY.Editor.add("htmlparser",function(){function y(){this._={htmlPartsRegex:new RegExp("<(?:(?:\\/([^>]+)>)|(?:!--([\\S|\\s]*?)--\>)|(?:([^\\s>]+)\\s*((?:(?:[^\"'>]+)|(?:\"[^\"]*\")|(?:'[^']*'))*)\\/?>))","g")}}var q=KISSY.Editor;if(!q.HtmlParser){var B=/([\w\-:.]+)(?:(?:\s*=\s*(?:(?:"([^"]*)")|(?:'([^']*)')|([^\s>]+)))|(?=\s|$))/g,r={checked:1,compact:1,declare:1,defer:1,disabled:1,ismap:1,multiple:1,nohref:1,noresize:1,noshade:1,nowrap:1,readonly:1,selected:1},t=q.XHTML_DTD;KISSY.augment(y,{onTagOpen:function(){},
onTagClose:function(){},onText:function(){},onCDATA:function(){},onComment:function(){},parse:function(v){for(var s,z,f=0,h;s=this._.htmlPartsRegex.exec(v);){z=s.index;if(z>f){f=v.substring(f,z);h?h.push(f):this.onText(f)}f=this._.htmlPartsRegex.lastIndex;if(z=s[1]){z=z.toLowerCase();if(h&&t.$cdata[z]){this.onCDATA(h.join(""));h=null}if(!h){this.onTagClose(z);continue}}if(h)h.push(s[0]);else if(z=s[3]){z=z.toLowerCase();var k={},l;s=s[4];var u=!!(s&&s.charAt(s.length-1)=="/");if(s)for(;l=B.exec(s);){var m=
l[1].toLowerCase();l=l[2]||l[3]||l[4]||"";k[m]=!l&&r[m]?m:l}this.onTagOpen(z,k,u);if(!h&&t.$cdata[z])h=[]}else if(z=s[2])this.onComment(z)}v.length>f&&this.onText(v.substring(f,v.length))}});q.HtmlParser=y}});
KISSY.Editor.add("htmlparser-htmlwriter",function(){function y(){y.superclass.constructor.call(this);this.indentationChars="\t";this.selfClosingEnd=" />";this.lineBreakChars="\n";this.forceSimpleAmpersand=false;this.sortAttributes=true;this._.indent=false;this._.indentation="";this._.rules={};var r=q.XHTML_DTD;for(var t in B.mix({},r.$nonBodyContent,r.$block,r.$listItem,r.$tableContent))this.setRules(t,{indent:true,breakBeforeOpen:true,breakAfterOpen:true,breakBeforeClose:!r[t]["#"],breakAfterClose:true});
this.setRules("br",{breakAfterOpen:true});this.setRules("title",{indent:false,breakAfterOpen:false});this.setRules("style",{indent:false,breakBeforeClose:true});this.setRules("pre",{indent:false})}var q=KISSY.Editor,B=q.Utils;if(!q.HtmlParser.HtmlWriter){KISSY.extend(y,q.HtmlParser.BasicWriter,{openTag:function(r){var t=this._.rules[r];if(this._.indent)this.indentation();else if(t&&t.breakBeforeOpen){this.lineBreak();this.indentation()}this._.output.push("<",r)},openTagClose:function(r,t){r=this._.rules[r];
if(t)this._.output.push(this.selfClosingEnd);else{this._.output.push(">");if(r&&r.indent)this._.indentation+=this.indentationChars}r&&r.breakAfterOpen&&this.lineBreak()},attribute:function(r,t){if(typeof t=="string"){this.forceSimpleAmpersand&&(t=t.replace(/&amp;/g,"&"));t=B.htmlEncodeAttr(t)}this._.output.push(" ",r,'="',t,'"')},closeTag:function(r){var t=this._.rules[r];if(t&&t.indent)this._.indentation=this._.indentation.substr(this.indentationChars.length);if(this._.indent)this.indentation();
else if(t&&t.breakBeforeClose){this.lineBreak();this.indentation()}this._.output.push("</",r,">");t&&t.breakAfterClose&&this.lineBreak()},text:function(r){if(this._.indent){this.indentation();r=B.ltrim(r)}this._.output.push(r)},comment:function(r){this._.indent&&this.indentation();this._.output.push("<!--",r,"--\>")},lineBreak:function(){this._.output.length>0&&this._.output.push(this.lineBreakChars);this._.indent=true},indentation:function(){this._.output.push(this._.indentation);this._.indent=false},
setRules:function(r,t){var v=this._.rules[r];if(v)B.mix(v,t);else this._.rules[r]=t}});q.HtmlParser.HtmlWriter=y}});KISSY.Editor.add("htmlparser-text",function(){function y(B){this.value=B;this._={isBlockLike:false}}var q=KISSY.Editor;if(!q.HtmlParser.Text){KISSY.augment(y,{type:q.NODE.NODE_TEXT,writeHtml:function(B,r){var t=this.value;r&&!(t=r.onText(t,this))||B.text(t)}});q.HtmlParser.Text=y}});
KISSY.Editor.add("htmldataprocessor",function(){var y=KISSY.Editor;if(!y.HtmlDataProcessor){var q=KISSY.UA,B=y.HtmlParser,r=new B.Filter,t=new B.Filter,v={elementNames:[[/^script$/,""],[/^iframe$/,""],[/^style$/,""],[/^link$/,""],[/^meta$/,""]],elements:{},attributes:{"class":function(f){if(/ke_/.test(f))return f;return false}},attributeNames:[[/^on/,"ck_on"]]},s={elementNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],elements:{embed:function(f){var h=f.parent;if(h&&h.name=="object"){var k=h.attributes.width;
h=h.attributes.height;k&&(f.attributes.width=k);h&&(f.attributes.height=h)}},param:function(f){f.children=[];f.isEmpty=true;return f},a:function(f){if(!(f.children.length||f.attributes.name))return false}},attributes:{},attributeNames:[[/^ck_on/,"on"]]},z=/(<\/?)((?:object|embed|param|html|body|head|title)[^>]*>)/gi;if(q.ie)s.attributes.style=function(f){return f.toLowerCase()};r.addRules(s);t.addRules(v);y.HtmlDataProcessor={htmlFilter:r,dataFilter:t,toHtml:function(f,h){var k=new B.HtmlWriter;B.Fragment.FromHtml(f,
h).writeHtml(k,r);return k.getHtml(true)},toDataFormat:function(f,h){f=f.replace(z,"$1ke:$2");var k=new B.HtmlWriter;f=B.Fragment.FromHtml(f,h);k.reset();f.writeHtml(k,t);return k.getHtml(true)}}}});
KISSY.Editor.add("image",function(y){var q=KISSY.Editor,B=KISSY,r=B.Node,t=B.DOM,v=B.Event,s=q.SimpleOverlay;q.ImageInserter||function(){function z(h){z.superclass.constructor.call(this,h);this._init()}var f=q.TripleButton;z.ATTRS={editor:{}};B.extend(z,B.Base,{_init:function(){var h=this.get("editor").toolBarDiv;this.el=new f({contentCls:"ke-toolbar-image",title:"\u56fe\u50cf",container:h});this.el.on("offClick",this.show,this);q.Utils.lazyRun(this,"_prepare","_real")},_prepare:function(){var h=
this,k=this.get("editor");this.content=new r("<div class='ke-popup-wrap' style='width:250px;padding:10px;'><p style='margin:0 0 10px'><label>\u8bf7\u8f93\u5165\u56fe\u7247\u5730\u5740\uff1a<br/><input value='http://' style='width: 250px;' class='ke-img-url'/></label></p><p><button class='ke-img-insert'>\u63d2\u5165</button>&nbsp;<a href='#' class='ke-img-cancel'>\u53d6\u6d88</a></p></div>");this.d=new s({el:this.content});document.body.appendChild(this.content[0]);var l=this.content.one(".ke-img-cancel"),
u=this.content.one(".ke-img-insert");this.imgUrl=this.content.one(".ke-img-url");l.on("click",function(m){this.d.hide();m.halt()},this);v.on(document,"click",this.hide,this);v.on(k.document,"click",this.hide,this);u.on("click",function(){h._insert()})},hide:function(h){var k=this;t._4e_ascendant(h.target,function(l){return l[0]===k.content[0]||l[0]===k.el.el[0]},true)||this.d.hide()},_real:function(){var h=this.el.el.offset();h.top+=this.el.el.height()+5;if(h.left+this.content.width()>t.viewportWidth()-
60)h.left=t.viewportWidth()-this.content.width()-60;this.d.show(h)},_insert:function(){var h=this.get("editor"),k=this.imgUrl.val();if(k){k=new r("<img src='"+k+"'/>",null,h.document);h.insertElement(k);this.d.hide()}},show:function(){this._prepare()}});q.ImageInserter=z}();y.addPlugin(function(){new q.ImageInserter({editor:y})})});
KISSY.Editor.add("indent",function(y){var q=KISSY.Editor,B={ol:1,ul:1},r=KISSY,t=q.Walker,v=r.DOM,s=r.Node,z=r.UA,f=q.NODE;q.Indent||function(){function h(g){this.type=g;this.indentCssProperty="margin-left";this.indentOffset=40;this.indentUnit="px"}function k(g){return g.type=CKEDITOR.NODE_ELEMENT&&g.is("li")}function l(g,d,i){var p=d.startContainer;for(g=d.endContainer;p&&p.parent()[0]!==i[0];)p=p.parent();for(;g&&g.parent()[0]!==i[0];)g=g.parent();if(p&&g){var c=p;p=[];for(var e=false;!e;){if(c[0]===
g[0])e=true;p.push(c);c=c.next()}if(!(p.length<1)){c=i._4e_parents(true);for(g=0;g<c.length;g++)if(B[c[g]._4e_name()]){i=c[g];break}c=this.type=="indent"?1:-1;g=p[0];e=p[p.length-1];p={};var n=q.ListUtils.listToArray(i,p),A=n[e._4e_getData("listarray_index")].indent;for(g=g._4e_getData("listarray_index");g<=e._4e_getData("listarray_index");g++){n[g].indent+=c;var w=n[g].parent;n[g].parent=new s(w[0].ownerDocument.createElement(w._4e_name()))}for(g=e._4e_getData("listarray_index")+1;g<n.length&&n[g].indent>
A;g++)n[g].indent+=c;e=q.ListUtils.arrayToList(n,p,null,"p",0);c=[];if(this.type=="outdent"){var C;if((C=i.parent())&&C._4e_name()=="li"){n=e.listNode.childNodes;var I;for(g=n.length-1;g>=0;g--)if((I=new s(n[g]))&&I._4e_name()=="li")c.push(I)}}if(e){v.insertBefore(e.listNode,i[0]);i._4e_remove()}if(c&&c.length)for(g=0;g<c.length;g++){for(I=i=c[g];(I=I.next())&&I._4e_name()in B;){z.ie&&!i._4e_first(function(x){return j(x)&&a(x)})&&i[0].appendChild(d.document.createTextNode("\u00a0"));i[0].appendChild(I[0])}v.insertAfter(i[0],
C[0])}for(g in p)p[g]._4e_clearMarkers(p,true)}}}function u(g,d){d=d.createIterator();d.enforceRealBlocks=true;d.enlargeBr=true;for(var i;i=d.getNextParagraph();)m.call(this,g,i)}function m(g,d){g=parseInt(d._4e_style(this.indentCssProperty),10);if(isNaN(g))g=0;g+=(this.type=="indent"?1:-1)*this.indentOffset;if(g<0)return false;g=Math.max(g,0);g=Math.ceil(g/this.indentOffset)*this.indentOffset;d.css(this.indentCssProperty,g?g+this.indentUnit:"");d[0].style.cssText===""&&d[0].removeAttribute("style");
return true}function o(g){o.superclass.constructor.call(this,g);g=this.get("editor").toolBarDiv;this.el=new b({container:g,contentCls:this.get("contentCls"),title:this.get("title")});this.indentCommand=new h(this.get("type"));this._init()}var j=t.whitespaces(true),a=t.bookmark(false,true);r.augment(h,{exec:function(g){g.focus();for(var d=g.getSelection(),i=d&&d.getRanges()[0],p=i.startContainer,c=i.endContainer,e=i.getCommonAncestor();e&&!(e[0].nodeType==f.NODE_ELEMENT&&B[e._4e_name()]);)e=e.parent();
if(e&&p[0].nodeType==f.NODE_ELEMENT&&p._4e_name()in B){p=new t(i);p.evaluator=k;i.startContainer=p.next()}if(e&&c[0].nodeType==f.NODE_ELEMENT&&c._4e_name()in B){p=new t(i);p.evaluator=k;i.endContainer=p.previous()}c=d.createBookmarks(true);if(e){for(p=e._4e_first();p&&p[0]&&p._4e_name()!="li";)p=p.next();var n=i.startContainer;(p[0]==n[0]||p._4e_contains(n))&&m.call(this,g,e)||l.call(this,g,i,e)}else u.call(this,g,i);g.focus();d.selectBookmarks(c)}});var b=q.TripleButton;o.ATTRS={type:{},contentCls:{},
editor:{}};r.extend(o,r.Base,{_init:function(){var g=this.get("editor"),d=this.el;d.on("offClick",this.exec,this);this.get("type")=="outdent"?g.on("selectionChange",this._selectionChange,this):d.set("state",b.OFF)},exec:function(){var g=this.get("editor"),d=this;g.focus();g.fire("save");setTimeout(function(){d.indentCommand.exec(g);g.fire("save");g.notifySelectionChange()},10)},_selectionChange:function(g){this.get("editor");this.get("type");var d=g.path,i=d.blockLimit;g=this.el;if(d.contains(B))g.set("state",
b.OFF);else(d=d.block||i)&&d._4e_style(this.indentCommand.indentCssProperty)?g.set("state",b.OFF):g.set("state",b.DISABLED)}});q.Indent=o}();y.addPlugin(function(){y.addCommand("outdent",new q.Indent({editor:y,title:"\u51cf\u5c11\u7f29\u8fdb\u91cf",contentCls:"ke-toolbar-outdent",type:"outdent"}));y.addCommand("indent",new q.Indent({editor:y,title:"\u589e\u52a0\u7f29\u8fdb\u91cf",contentCls:"ke-toolbar-indent",type:"indent"}))})});
KISSY.Editor.add("justify",function(y){var q=KISSY.Editor,B=KISSY,r=q.TripleButton;q.Justify||function(){function t(s,z,f,h){this.editor=s;this.v=z;this.contentCls=h;this.title=f;this._init()}var v=/(-moz-|-webkit-|start|auto)/i;B.augment(t,{_init:function(){var s=this.editor;this.el=new r({contentCls:this.contentCls,title:this.title,container:s.toolBarDiv});s.on("selectionChange",this._selectionChange,this);this.el.on("click",this._effect,this)},_effect:function(){var s=this.editor,z=s.getSelection(),
f=this.el.get("state");if(z){var h=z.createBookmarks(),k=z.getRanges(),l,u;s.fire("save");for(var m=k.length-1;m>=0;m--){l=k[m].createIterator();for(l.enlargeBr=true;u=l.getNextParagraph();){u.removeAttr("align");f==r.OFF?u.css("text-align",this.v):u.css("text-align","")}}s.focus();s.notifySelectionChange();z.selectBookmarks(h);s.fire("save")}},_selectionChange:function(s){var z=this.el;s=s.path;if(s=s.block||s.blockLimit){s=s.css("text-align").replace(v,"");s==this.v||!s&&this.v=="left"?z.set("state",
r.ON):z.set("state",r.OFF)}}});q.Justify=t}();y.addPlugin(function(){new q.Justify(y,"left","\u5de6\u5bf9\u9f50","ke-toolbar-alignleft");new q.Justify(y,"center","\u5c45\u4e2d\u5bf9\u9f50","ke-toolbar-aligncenter");new q.Justify(y,"right","\u53f3\u5bf9\u9f50","ke-toolbar-alignright")})});
KISSY.Editor.add("link",function(y){var q=KISSY.Editor,B=KISSY,r=B.DOM,t=B.Event,v=q.TripleButton,s=q.Style,z=B.Node,f=q.Range,h=q.SimpleOverlay,k=q.HtmlDataProcessor,l=k&&k.dataFilter;q.Link||function(){function u(j){this.editor=j;this._init()}l&&l.addRules({elements:{a:function(j){for(var a in j.attributes)a=="href"||a=="target"||delete j.attributes[a]}}});var m={element:"a",attributes:{href:"#(href)",target:"#(target)"}};u.init=function(){var j=this;j.d=new h({title:"\u7f16\u8f91\u8d85\u94fe\u63a5",
mask:true,width:"300px"});j.d.body.html(o);j.urlEl=j.d.body.one(".ke-link-url");j.targetEl=j.d.body.one(".ke-link-blank");var a=j.d.body.one(".ke-link-cancel");j.ok=j.d.body.one(".ke-link-ok");u.ok.on("click",function(b){u.d.link._link();b.halt()},this);a.on("click",function(b){j.d.hide();b.halt()},j);u.init=null};u.tip=function(){var j=new z('<div class="ke-bubbleview-bubble" onmousedown="return false;">\u524d\u5f80\u94fe\u63a5\uff1a  <a href=""  target="_blank" class="ke-bubbleview-url"></a> -     <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -     <span class="ke-bubbleview-link ke-bubbleview-remove">\u53bb\u9664</span></div>');
j._4e_unselectable();this.tipwin=new h({el:j});document.body.appendChild(j[0]);this.tipurl=j.one(".ke-bubbleview-url");var a=j.one(".ke-bubbleview-change");j=j.one(".ke-bubbleview-remove");a.on("click",function(b){u.tipwin.link.show();b.halt()});j.on("click",function(b){u.tipwin.link._removeLink();b.halt()});u.tip=null};var o="<div style='padding: 10px;'><p><label>URL\uff1a<input class='ke-link-url' style='width:230px' value='http://'/></label></p><p style='margin-top: 5px;padding-left:35px'><label><input class='ke-link-blank' type='checkbox'/> &nbsp; \u5728\u65b0\u7a97\u53e3\u6253\u5f00\u94fe\u63a5</label></p><p style='margin-top: 5px;'><label><button class='ke-link-ok'>\u786e\u5b9a</button>&nbsp;<a href='#' class='ke-link-cancel'>\u53d6\u6d88</a></label></p></div>";
B.augment(u,{_init:function(){var j=this.editor;this.el=new v({container:j.toolBarDiv,contentCls:"ke-toolbar-link",title:"\u63d2\u5165\u7f16\u8f91\u8d85\u94fe\u63a5"});this.el.on("click",this.show,this);j.on("selectionChange",this._selectionChange,this)},_prepareTip:function(){u.tip&&u.tip()},_realTip:function(j){var a=j._4e_getOffset(document);a.top+=j.height()+5;u.tipwin.show(a);this._a=j;u.tipwin.link=this;u.tipurl.html(j.attr("href"));u.tipurl.attr("href",j.attr("href"))},_showTip:function(j){this._prepareTip(j)},
_hideTip:function(){u.tipwin&&u.tipwin.hide()},_removeLink:function(){var j=this._a,a=this.editor;a.focus();var b={href:j.attr("href")};if(j._4e_hasAttribute("target"))b.target=j.attr("target");j=new s(m,b);a.fire("save");j.remove(a.document);a.fire("save");this._hideTip();a.focus();a.notifySelectionChange()},_selectionChange:function(j){j=j.path;var a=j.elements;if(j&&a)if(j=j.lastElement)(j=j._4e_ascendant(function(b){return b._4e_name()==="a"&&!!b.attr("href")},true))?this._showTip(j):this._hideTip()},
hide:function(){u.d.hide()},_getSelectedLink:function(){var j=this.editor;if(u.tipwin&&u.tipwin.get("visible")){(j=j.getSelection().getRanges()[0].getCommonAncestor())&&(j=j._4e_ascendant(function(a){return a._4e_name()=="a"&&!!a.attr("href")},true));if(j&&j[0]==u.tipwin.link._a[0])return j}},_link:function(){var j=this.editor,a=u.urlEl.val();j.focus();if(B.trim(a)){var b=this._getSelectedLink();if(b){var g=new f(j.document);g.selectNodeContents(b);j.getSelection().selectRanges([g]);this._removeLink()}a=
{href:a};a.target=u.targetEl[0].checked?"_blank":"_self";a=new s(m,a);j.fire("save");a.apply(j.document);j.fire("save");this.hide();j.focus();j.notifySelectionChange()}},_prepare:function(){u.init&&u.init()},_real:function(){u.d.link=this;var j=this._getSelectedLink();if(j){u.urlEl.val(j.attr("href"));u.targetEl[0].checked=j.attr("target")=="_blank"}u.d.show()},show:function(){this._prepare()}});q.Utils.lazyRun(u.prototype,"_prepare","_real");q.Utils.lazyRun(u.prototype,"_prepareTip","_realTip");
q.Link=u}();y.addPlugin(function(){new q.Link(y);var u=r._4e_getWin(y.document);t.on(u,"scroll",function(){q.Link.tipwin&&q.Link.tipwin.hide()})})});
KISSY.Editor.add("list",function(y){var q=KISSY.Editor,B={ol:1,ul:1},r=["ol","ul"],t=KISSY,v=q.RANGE,s=q.ElementPath,z=q.Walker,f=q.NODE,h=t.UA,k=t.Node,l=t.DOM;q.List||function(){function u(b){this.type=b}function m(b){m.superclass.constructor.call(this,b);b=this.get("editor").toolBarDiv;this.el=new a({contentCls:this.get("contentCls"),title:this.get("title"),container:b});this.listCommand=new u(this.get("type"));this.listCommand.state=this.get("status");this._init()}var o={listToArray:function(b,
g,d,i,p){if(!B[b._4e_name()])return[];i||(i=0);d||(d=[]);for(var c=0,e=b[0].childNodes.length;c<e;c++){var n=new k(b[0].childNodes[c]);if(n._4e_name()=="li"){var A={parent:b,indent:i,element:n,contents:[]};if(p)A.grandparent=p;else{A.grandparent=b.parent();if(A.grandparent&&A.grandparent._4e_name()=="li")A.grandparent=A.grandparent.parent()}g&&n._4e_setMarker(g,"listarray_index",d.length);d.push(A);for(var w=0,C=n[0].childNodes.length,I;w<C;w++){I=new k(n[0].childNodes[w]);I[0].nodeType==f.NODE_ELEMENT&&
B[I._4e_name()]?o.listToArray(I,g,d,i+1,A.grandparent):A.contents.push(I)}}}return d},arrayToList:function(b,g,d,i){d||(d=0);if(!b||b.length<d+1)return null;for(var p=b[d].parent[0].ownerDocument,c=p.createDocumentFragment(),e=null,n=d,A=Math.max(b[d].indent,0),w=null;;){var C=b[n];if(C.indent==A){if(!e||b[n].parent._4e_name()!=e._4e_name()){e=b[n].parent._4e_clone(false,true);c.appendChild(e[0])}w=e[0].appendChild(C.element._4e_clone(false,true)[0]);for(var I=0;I<C.contents.length;I++)w.appendChild(C.contents[I]._4e_clone(true,
true)[0]);n++}else if(C.indent==Math.max(A,0)+1){n=o.arrayToList(b,null,n,i);w.appendChild(n.listNode);n=n.nextIndex}else if(C.indent==-1&&!d&&C.grandparent){w=B[C.grandparent._4e_name()]?C.element._4e_clone(false,true)[0]:C.grandparent._4e_name()!="td"?p.createElement(i):p.createDocumentFragment();for(I=0;I<C.contents.length;I++)w.appendChild(C.contents[I]._4e_clone(true,true)[0]);if(w.nodeType==f.NODE_DOCUMENT_FRAGMENT&&n!=b.length-1){w.lastChild&&w.lastChild.nodeType==f.NODE_ELEMENT&&w.lastChild.getAttribute("type")==
"_moz"&&l._4e_remove(w.lastChild);l._4e_appendBogus(w)}if(w.nodeType==f.NODE_ELEMENT&&l._4e_name(w)==i&&w.firstChild){l._4e_trim(w);e=w.firstChild;if(e.nodeType==f.NODE_ELEMENT&&l._4e_isBlockBoundary(e)){e=p.createDocumentFragment();l._4e_moveChildren(w,e);w=e}}e=l._4e_name(w);if(!h.ie&&(e=="div"||e=="p"))l._4e_appendBogus(w);c.appendChild(w);e=null;n++}else return null;if(b.length<=n||Math.max(b[n].indent,0)<A)break}if(g)for(b=new k(c.firstChild);b&&b[0];){b[0].nodeType==f.NODE_ELEMENT&&b._4e_clearMarkers(g,
true);b=b._4e_nextSourceNode()}return{listNode:c,nextIndex:n}}},j=/^h[1-6]$/;u.prototype={changeListType:function(b,g,d,i){var p=o.listToArray(g.root,d),c=[];for(b=0;b<g.contents.length;b++){var e=g.contents[b];e=e._4e_ascendant("li",true);if(!(!e||!e[0]||e._4e_getData("list_item_processed"))){c.push(e);e._4e_setMarker(d,"list_item_processed",true)}}e=new k(g.root[0].ownerDocument.createElement(this.type));for(b=0;b<c.length;b++){var n=c[b]._4e_getData("listarray_index");p[n].parent=e}d=o.arrayToList(p,
d,null,"p");var A;p=d.listNode.childNodes.length;for(b=0;b<p&&(A=new k(d.listNode.childNodes[b]));b++)A._4e_name()==this.type&&i.push(A);l.insertBefore(d.listNode,g.root[0]);g.root._4e_remove()},createList:function(b,g,d){var i=g.contents;b=g.root[0].ownerDocument;var p=[];if(i.length==1&&i[0][0]===g.root[0]){var c=new k(b.createElement("div"));i[0][0].nodeType!=f.NODE_TEXT&&i[0]._4e_moveChildren(c);i[0][0].appendChild(c[0]);i[0]=c}g=g.contents[0].parent();for(c=0;c<i.length;c++)g=g._4e_commonAncestor(i[c].parent());
for(c=0;c<i.length;c++)for(var e=i[c],n;n=e.parent();){if(n[0]===g[0]){p.push(e);break}e=n}if(!(p.length<1)){i=new k(p[p.length-1][0].nextSibling);c=new k(b.createElement(this.type));for(d.push(c);p.length;){d=p.shift();e=new k(b.createElement("li"));if(j.test(d._4e_name()))e[0].appendChild(d[0]);else{d._4e_copyAttributes(e);d._4e_moveChildren(e);d._4e_remove()}c[0].appendChild(e[0]);h.ie||e._4e_appendBogus()}i[0]?l.insertBefore(c[0],i[0]):g[0].appendChild(c[0])}},removeList:function(b,g,d){function i(I){if((w=
new k(A[I?"firstChild":"lastChild"]))&&!(w[0].nodeType==f.NODE_ELEMENT&&w._4e_isBlockBoundary())&&(C=g.root[I?"_4e_previous":"_4e_next"](z.whitespaces(true)))&&!(w[0].nodeType==f.NODE_ELEMENT&&C._4e_isBlockBoundary({br:1})))l[I?"insertBefore":"insertAfter"](b.document.createElement("br"),w[0])}for(var p=o.listToArray(g.root,d),c=[],e=0;e<g.contents.length;e++){var n=g.contents[e];n=n._4e_ascendant("li",true);if(!(!n||n._4e_getData("list_item_processed"))){c.push(n);n._4e_setMarker(d,"list_item_processed",
true)}}n=null;for(e=0;e<c.length;e++){n=c[e]._4e_getData("listarray_index");p[n].indent=-1;n=n}for(e=n+1;e<p.length;e++)if(p[e].indent>Math.max(p[e-1].indent,0)){c=p[e-1].indent+1-p[e].indent;for(n=p[e].indent;p[e]&&p[e].indent>=n;){p[e].indent+=c;e++}e--}var A=o.arrayToList(p,d,null,"p").listNode,w,C;i(true);i();l.insertBefore(A,g.root);g.root._4e_remove()},exec:function(b){b.focus();var g=b.getSelection(),d=g&&g.getRanges();if(!(!d||d.length<1)){for(var i=g.createBookmarks(true),p=[],c={};d.length>
0;){var e=d.shift(),n=e.getBoundaryNodes(),A=n.startNode,w=n.endNode;A[0].nodeType==f.NODE_ELEMENT&&A._4e_name()=="td"&&e.setStartAt(n.startNode,v.POSITION_AFTER_START);w[0].nodeType==f.NODE_ELEMENT&&w._4e_name()=="td"&&e.setEndAt(n.endNode,v.POSITION_BEFORE_END);e=e.createIterator();for(e.forceBrBreak=false;n=e.getNextParagraph();){A=new s(n);w=A.elements;var C=null,I=false,x=A.blockLimit,D;for(A=w.length-1;A>=0&&(D=w[A]);A--)if(B[D._4e_name()]&&x.contains(D)){x._4e_removeData("list_group_object");
if(A=D._4e_getData("list_group_object"))A.contents.push(n);else{A={root:D,contents:[n]};p.push(A);D._4e_setMarker(c,"list_group_object",A)}I=true;break}if(!I)if(x._4e_getData("list_group_object"))x._4e_getData("list_group_object").contents.push(n);else{A={root:x,contents:[n]};x._4e_setMarker(c,"list_group_object",A);p.push(A)}}}for(d=[];p.length>0;){A=p.shift();if(this.state=="off")B[A.root._4e_name()]?this.changeListType(b,A,c,d):this.createList(b,A,d);else this.state=="on"&&B[A.root._4e_name()]&&
this.removeList(b,A,c)}for(A=0;A<d.length;A++){C=d[A];var G=this;(p=function(J){var N=C[J?"_4e_previous":"_4e_next"](z.whitespaces(true));if(N&&N[0]&&N._4e_name()==G.type){N._4e_remove();N._4e_moveChildren(C,J?true:false)}})();p(true)}q.Utils.clearAllMarkers(c);g.selectBookmarks(i);b.focus()}}};var a=q.TripleButton;m.ATTRS={editor:{},type:{},contentCls:{}};t.extend(m,t.Base,{_init:function(){var b=this.get("editor");this.el.on("click",this._change,this);b.on("selectionChange",this._selectionChange,
this)},_change:function(){var b=this.get("editor"),g=this.get("type"),d=this.el,i=this;b.focus();b.fire("save");setTimeout(function(){i.listCommand.state=d.get("state");i.listCommand.exec(b);b.fire("save");b.fire(g+"Change")},10)},_selectionChange:function(b){this.get("editor");var g=this.get("type"),d=b.path,i;b=this.el;var p=d.blockLimit;if(d=d.elements)for(var c=0;c<d.length&&(i=d[c])&&i[0]!==p[0];c++){var e=t.indexOf(d[c]._4e_name(),r);if(e!==-1)if(r[e]===g){b.set("state",a.ON);return}else break}b.set("state",
a.OFF)}});q.ListUtils=o;q.List=m}();y.addPlugin(function(){new q.List({editor:y,title:"\u9879\u76ee\u5217\u8868",contentCls:"ke-toolbar-ul",type:"ul"});new q.List({editor:y,title:"\u7f16\u53f7\u5217\u8868",contentCls:"ke-toolbar-ol",type:"ol"})})});
KISSY.Editor.add("maximize",function(y){var q=KISSY.Editor,B=KISSY,r=B.UA,t=B.Node,v=B.Event,s=q.TripleButton,z=B.DOM,f;q.Maximize||function(){function h(k){this.editor=k;this._init()}h.init=function(){f=new t("<iframe style='position:absolute;top:-9999px;left:-9999px;' frameborder='0'></iframe>");document.body.appendChild(f[0]);h.init=null};B.augment(h,{_init:function(){this.el=new s({container:this.editor.toolBarDiv,cls:"ke-tool-editor-source",title:"\u5168\u5c4f",contentCls:"ke-toolbar-maximize"});
this.el.on("offClick",this.maximize,this);this.el.on("onClick",this.restore,this);q.Utils.lazyRun(this,"_prepare","_real")},restore:function(){var k=this,l=k.editor;v.remove(window,"resize",k._maximize,k);this._saveEditorStatus();l.wrap.css({height:k.iframeHeight});(new t(document.body)).css({width:"",height:"",overflow:""});l.editorWrap.css({position:"static",width:k.editorWrapWidth});f.css({left:"-99999px",top:"-99999px"});window.scrollTo(k.scrollLeft,k.scrollTop);k.el.set("state",s.OFF);setTimeout(function(){k._restoreEditorStatus()},
30)},_saveSate:function(){var k=this.editor;this.iframeHeight=k.wrap._4e_style("height");this.editorWrapWidth=k.editorWrap._4e_style("width");this.scrollLeft=z.scrollLeft();this.scrollTop=z.scrollTop();window.scrollTo(0,0)},_saveEditorStatus:function(){var k=this.editor;if(r.gecko&&k.iframeFocus)this.savedRanges=(k=k.getSelection())&&k.getRanges()},_restoreEditorStatus:function(){var k=this.editor,l;if(r.gecko&&k.iframeFocus){l=k.getSelection();this.el.el[0].focus();k.focus();this.savedRanges&&l&&
l.selectRanges(this.savedRanges)}if(k.iframeFocus&&l)(l=l.getStartElement())&&l[0]&&l.scrollIntoView(k.document,false)},_maximize:function(){var k=this.editor,l=z.viewportHeight(),u=z.viewportWidth(),m=k.statusDiv?k.statusDiv.height():0,o=k.toolBarDiv.height();if(r.ie)document.body.style.overflow="hidden";else(new t(document.body)).css({width:0,height:0,overflow:"hidden"});k.editorWrap.css({position:"absolute",zIndex:9999,width:u+"px"});f.css({zIndex:9998,height:l+"px",width:u+"px"});k.editorWrap.offset({left:0,
top:0});f.css({left:0,top:0});k.wrap.css({height:l-m-o-14+"px"})},_real:function(){var k=this;this._saveEditorStatus();this._saveSate();this._maximize();this._maximize();v.on(window,"resize",k._maximize,k);this.el.set("state",s.ON);setTimeout(function(){k._restoreEditorStatus()},30)},_prepare:function(){h.init&&h.init()},maximize:function(){this._prepare()}});q.Maximize=h}();y.addPlugin(function(){new q.Maximize(y)})});
KISSY.Editor.add("music",function(y){var q=KISSY.Editor;q.MusicInserter||function(){function B(j){B.superclass.constructor.call(this,j);j=this.get("editor");j._toolbars=j._toolbars||{};j._toolbars.music=this;this._init()}function r(j){return j.replace(/^.+niftyplayer\.swf\?file=/,"")}var t=KISSY,v=t.Node,s=t.DOM,z=q.ContextMenu,f=t.Event,h=q.SimpleOverlay,k=q.TripleButton,l='<ke:object  width="165" height="37" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,0,0" classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"><ke:param value="'+
(q.Config.base+'plugins/music/niftyplayer.swf?file=#(music)&amp;as=0"')+' name="movie"></ke:param><ke:param value="high" name="quality"></ke:param><ke:param value="#FFFFFF" name="bgcolor"></ke:param><ke:embed width="165" height="37" type="application/x-shockwave-flash" swliveconnect="true" src="'+(q.Config.base+'plugins/music/niftyplayer.swf?file=#(music)&amp;as=0"')+'quality="high" pluginspage="http://www.macromedia.com/go/getflashplayer" bgcolor="#FFFFFF"></ke:embed></ke:object>',u=/#\(music\)/g,
m=["img.ke_music"];B.ATTRS={editor:{}};t.extend(B,t.Base,{_init:function(){var j=this.get("editor"),a={};this.el=new k({contentCls:"ke-toolbar-music",title:"\u5206\u4eab\u97f3\u4e50",container:j.toolBarDiv});f.on(j.document,"dblclick",this._dblclick,this);for(var b in o)(function(g){a[g]=function(){j.fire("save");j.focus();o[g](j);j.fire("save")}})(b);z.register(j.document,{rules:m,width:"120px",funcs:a});this.el.on("offClick",this.show,this);q.Utils.lazyRun(this,"_prepare","_real")},_prepare:function(){var j=
this,a=j.get("editor");j.content=new v("<div class='ke-popup-wrap' style='width:250px;padding:10px;'><p style='margin:0 0 10px'><label>\u8bf7\u8f93\u5165\u97f3\u4e50\u5730\u5740\uff1a<br/><input value='http://' style='width: 250px;' class='ke-music-url'/></label></p><p><button class='ke-music-insert'>\u63d2\u5165</button>&nbsp;<a href='#' class='ke-music-cancel'>\u53d6\u6d88</a></p></div>");j.d=new h({el:j.content});j.d.on("hide",function(){j.selectedFlash=null;a.focus()});document.body.appendChild(j.content[0]);
var b=j.content.one(".ke-music-cancel"),g=j.content.one(".ke-music-insert");j.musicUrl=j.content.one(".ke-music-url");b.on("click",function(d){j.d.hide();d.halt()},j);f.on(document,"click",j.hide,j);f.on(a.document,"click",j.hide,j);g.on("click",function(){j._insert()})},hide:function(j){var a=this;s._4e_ascendant(j.target,function(b){return b[0]===a.content[0]||b[0]===a.el.el[0]})||this.d.hide()},_real:function(){var j=this.el.el.offset();j.top+=this.el.el.height()+5;if(j.left+this.content.width()>
s.viewportWidth()-60)j.left=s.viewportWidth()-this.content.width()-60;this.d.show(j)},_insert:function(){var j=this.get("editor"),a=this.musicUrl.val();if(a){a=new v(l.replace(u,a),null,j.document);a=j.createFakeElement?j.createFakeElement(a,"ke_music","music",true):a;j.insertElement(a);this.d.hide()}},_dblclick:function(j){var a=new v(j.target);if(a._4e_name()==="img"&&a.hasClass("ke_music")){this.selectedFlash=a;this.show();j.halt()}},show:function(){this._prepare();if(this.selectedFlash){var j=
this.get("editor").restoreRealElement(this.selectedFlash);if(j._4e_name()=="ke:object"){for(var a=j._4e_getElementsByTagName("param","ke"),b=0;b<a.length;b++)if((a[b].attr("name")||"").toLowerCase()=="movie")this.musicUrl.val(r(a[b].attr("value")));a=j._4e_getElementsByTagName("embed","ke");for(b=0;b<a.length;b++)this.musicUrl.val(r(a[b].attr("src")));j=j._4e_getElementsByTagName("object","ke");for(b=0;b<j.length;b++)this.musicUrl.val(r(j[b].attr("data")))}else j._4e_name()=="ke:embed"&&this.musicUrl.val(r(j.attr("src")))}}});
q.MusicInserter=B;var o={"\u7f16\u8f91\u97f3\u4e50":function(j){var a=j.getSelection();if(a=(a=a&&a.getStartElement())&&a._4e_ascendant("img",true))if(a.hasClass("ke_music")){j=j._toolbars.music;j.selectedFlash=a;j.show()}}}}();y.addPlugin(function(){new q.MusicInserter({editor:y})})});
KISSY.Editor.add("preview",function(y){var q=KISSY.Editor,B=KISSY,r=q.TripleButton;q.Preview||function(){function t(v){this.editor=v;this._init()}B.augment(t,{_init:function(){this.el=new r({container:this.editor.toolBarDiv,cls:"ke-tool-editor-source",title:"\u9884\u89c8",contentCls:"ke-toolbar-preview"});this.el.on("offClick",this._show,this)},_show:function(){var v=this.editor,s=640,z=420,f=80;try{var h=window.screen;s=Math.round(h.width*0.8);z=Math.round(h.height*0.7);f=Math.round(h.width*0.1)}catch(k){}v=
v._prepareIFrameHtml().replace(/<body[^>]+>.+<\/body>/,"<body>\n"+v.getData()+"\n</body>");s=window.open("",null,"toolbar=yes,location=no,status=yes,menubar=yes,scrollbars=yes,resizable=yes,width="+s+",height="+z+",left="+f);s.document.open();s.document.write(v);s.document.close()}});q.Preview=t}();y.addPlugin(function(){new q.Preview(y)})});
KISSY.Editor.add("removeformat",function(y){function q(k){this.editor=k;this._init()}function B(k,l){for(var u=0;u<l.length;u++)k.removeAttr(l[u])}var r=KISSY.Editor,t=KISSY,v=r.RANGE,s=r.ElementPath,z=r.NODE,f=r.TripleButton,h="b,big,code,del,dfn,em,font,i,ins,kbd,q,samp,small,span,strike,strong,sub,sup,tt,u,var";removeFormatAttributes="class,style,lang,width,height,align,hspace,valign".split(",");h=new RegExp("^(?:"+h.replace(/,/g,"|")+")$","i");t.augment(q,{_init:function(){this.el=new f({title:"\u6e05\u9664\u683c\u5f0f",
contentCls:"ke-toolbar-removeformat",container:this.editor.toolBarDiv});this.el.on("offClick",this._remove,this)},_remove:function(){var k=this.editor,l=h,u=removeFormatAttributes;l.lastIndex=0;k.focus();var m=k.getSelection().getRanges();k.fire("save");for(var o=0,j;j=m[o];o++)if(!j.collapsed){j.enlarge(v.ENLARGE_ELEMENT);var a=j.createBookmark(),b=a.startNode,g=a.endNode,d=function(i){for(var p=new s(i),c=p.elements,e=1,n;n=c[e];e++){if(n._4e_equals(p.block)||n._4e_equals(p.blockLimit))break;l.test(n.getName())&&
i.breakParent(n)}};d(b);d(g);for(b=b._4e_nextSourceNode(true,z.NODE_ELEMENT);b;){if(b._4e_equals(g))break;d=b._4e_nextSourceNode(false,z.NODE_ELEMENT);b._4e_name()=="img"&&b.attr("_cke_realelement")||(l.test(b._4e_name())?b._4e_remove(true):B(b,u));b=d}j.moveToBookmark(a)}k.getSelection().selectRanges(m);k.fire("save")}});y.addPlugin(function(){new q(y)})});
KISSY.Editor.add("smiley",function(y){var q=KISSY.Editor,B=KISSY,r=B.DOM,t=B.Event,v=B.Node,s=q.SimpleOverlay,z=q.TripleButton;q.Smiley||function(){function f(l){this.editor=l;this._init()}for(var h="<div class='ke-popup-wrap'><div class='ke-smiley-sprite'>",k=0;k<=98;k++)h+="<a href='#' data-icon='http://a.tbcdn.cn/sys/wangwang/smiley/48x48/"+k+".gif'></a>";h+="</div></div>";B.augment(f,{_init:function(){this.el=new z({contentCls:"ke-toolbar-smiley",title:"\u63d2\u5165\u8868\u60c5",container:this.editor.toolBarDiv});
this.el.on("offClick",this._show,this);q.Utils.lazyRun(this,"_prepare","_real")},_hidePanel:function(l){var u=this;r._4e_ascendant(l.target,function(m){return m[0]===u.el.el[0]})||this.smileyWin.hide()},_selectSmiley:function(l){l.halt();var u=this.editor;l=l.target;var m;if(r._4e_name(l)=="a"&&(m=r.attr(l,"data-icon"))){m=new v("<img src='"+m+"'/>",null,u.document);u.insertElement(m);u.focus();this.smileyWin.hide()}},_prepare:function(){var l=this.editor;this.smileyPanel=new v(h);this.smileyWin=
new s({el:this.smileyPanel,mask:false});document.body.appendChild(this.smileyPanel[0]);this.smileyPanel.on("click",this._selectSmiley,this);t.on(document,"click",this._hidePanel,this);t.on(l.document,"click",this._hidePanel,this)},_real:function(){var l=this.el.el.offset();l.top+=this.el.el.height()+5;if(l.left+this.smileyPanel.width()>r.viewportWidth()-60)l.left=r.viewportWidth()-this.smileyPanel.width()-60;this.smileyWin.show(l)},_show:function(l){this._prepare(l)}});q.Smiley=f}();y.addPlugin(function(){new q.Smiley(y)})});
KISSY.Editor.add("sourcearea",function(y){var q=KISSY.Editor,B=KISSY,r=B.UA,t=q.TripleButton;q.SourceArea||function(){function v(s){this.editor=s;this._init()}B.augment(v,{_init:function(){var s=this.editor;this.el=new t({container:s.toolBarDiv,cls:"ke-tool-editor-source",title:"\u6e90\u7801",contentCls:"ke-toolbar-source"});this.el.on("offClick",this._show,this);this.el.on("onClick",this._hide,this);s.textarea.on("mousedown",function(z){z.stopPropagation()})},_show:function(){var s=this.editor,z=
this.el;s.textarea.val(s.getData());s._showSource();z.set("state",t.ON)},_hide:function(){var s=this.editor,z=s.textarea,f=this.el;s._hideSource();s.setData(z.val());if(r.gecko&&s.iframeFocus){f.el[0].focus();s.focus()}f.set("state",t.OFF)}});q.SourceArea=v}();y.addPlugin(function(){new q.SourceArea(y)})});
KISSY.Editor.add("table",function(y,q){var B=KISSY.Editor,r=KISSY,t=r.Node,v=r.DOM,s=B.Walker,z=r.UA,f=B.NODE,h=B.TripleButton,k=B.SimpleOverlay,l=B.ContextMenu,u=["tr","th","td","tbody","table"],m=r.trim,o;o=(z.ie===6?["table.%2,","table.%2 td, table.%2 th,","{","border : #d3d3d3 1px dotted","}"]:[" table.%2,"," table.%2 > tr > td,  table.%2 > tr > th,"," table.%2 > tbody > tr > td,  table.%2 > tbody > tr > th,"," table.%2 > thead > tr > td,  table.%2 > thead > tr > th,"," table.%2 > tfoot > tr > td,  table.%2 > tfoot > tr > th",
"{","border : #d3d3d3 1px dotted","}"]).join("").replace(/%2/g,"ke_show_border");B.TableUI||function(){function j(x){this.editor=x;this.selectedTable=null;x._toolbars=x._toolbars||{};x._toolbars.table=this;this._init()}function a(x){return m(x).length!=0}function b(x){function D($){if(!(N.length>0))if($[0].nodeType==f.NODE_ELEMENT&&C.test($._4e_name())&&!$._4e_getData("selected_cell")){$._4e_setMarker(M,"selected_cell",true);N.push($)}}for(var G=x.createBookmarks(),J=x.getRanges(),N=[],M={},Q=0;Q<
J.length;Q++){var R=J[Q];if(R.collapsed){R=R.getCommonAncestor();(R=R._4e_ascendant("td",true)||R._4e_ascendant("th",true))&&N.push(R)}else{R=new s(R);var W;for(R.guard=D;W=R.next();)if((W=W.parent())&&C.test(W._4e_name())&&!W._4e_getData("selected_cell")){W._4e_setMarker(M,"selected_cell",true);N.push(W)}}}B.Utils.clearAllMarkers(M);x.selectBookmarks(G);return N}function g(x){x=x.cells;for(var D=0;D<x.length;D++){x[D].innerHTML="";z.ie||(new t(x[D]))._4e_appendBogus()}}function d(x,D){if(x=x.getStartElement()._4e_ascendant("tr")){var G=
x._4e_clone(true);G.insertBefore(x);g(D?G[0]:x[0])}}function i(x){if(x instanceof B.Selection){var D=b(x),G=D.length;x=[];for(var J,N,M=0;M<G;M++){var Q=D[M].parent(),R=Q[0].rowIndex;!M&&(J=R-1);x[R]=Q;M==G-1&&(N=R+1)}M=Q._4e_ascendant("table");J=new t(N<M[0].rows.length&&M[0].rows[N]||J>0&&M[0].rows[J]||M[0].parentNode);for(M=x.length;M>=0;M--)x[M]&&i(x[M]);return J}else if(x instanceof t){M=x._4e_ascendant("table");M[0].rows.length==1?M._4e_remove():x._4e_remove()}return 0}function p(x,D){x=x.getStartElement();
if(x=x._4e_ascendant("td",true)||x._4e_ascendant("th",true))for(var G=x._4e_ascendant("table"),J=x[0].cellIndex,N=0;N<G[0].rows.length;N++){var M=G[0].rows[N];if(!(M.cells.length<J+1)){x=new t(M.cells[J].cloneNode(false));z.ie||x._4e_appendBogus();M=new t(M.cells[J]);D?x.insertBefore(M):x.insertAfter(M)}}}function c(x){var D=[],G=x[0]&&x[0]._4e_ascendant("table"),J,N,M,Q;J=0;for(N=x.length;J<N;J++)D.push(x[J][0].cellIndex);D.sort();J=1;for(N=D.length;J<N;J++)if(D[J]-D[J-1]>1){M=D[J-1]+1;break}M||
(M=D[0]>0?D[0]-1:D[D.length-1]+1);x=G[0].rows;J=0;for(N=x.length;J<N;J++)if(Q=x[J].cells[M])break;return Q?new t(Q):G.previous()}function e(x){if(x instanceof B.Selection){var D=b(x),G=c(D);for(x=D.length-1;x>=0;x--)D[x]&&e(D[x]);return G}else if(x instanceof t){D=x._4e_ascendant("table");if(!D)return null;G=x[0].cellIndex;for(x=D[0].rows.length-1;x>=0;x--){var J=new t(D[0].rows[x]);if(!G&&J[0].cells.length==1)i(J);else J[0].cells[G]&&J[0].removeChild(J[0].cells[G])}}return null}function n(x,D){var G=
new B.Range(x[0].ownerDocument);if(!G.moveToElementEditablePosition(x,D?true:q)){G.selectNodeContents(x);G.collapse(D?false:true)}G.select(true)}var A=B.HtmlDataProcessor,w=A&&A.dataFilter;A=A&&A.htmlFilter;w&&w.addRules({elements:{table:function(x){x=x.attributes;var D=x["class"],G=parseInt(x.border,10);if(!G||G<=0)x["class"]=(D||"")+" ke_show_border"}}});A&&A.addRules({elements:{table:function(x){x=x.attributes;var D=x["class"];if(D)x["class"]=r.trim(D.replace("ke_show_border","").replace(/\s{2}/,
" "))}}});r.augment(j,{_init:function(){var x=this.editor,D={};this.el=new h({contentCls:"ke-toolbar-table",title:"\u8868\u683c",container:x.toolBarDiv});this.el.on("offClick",this._tableShow,this);for(var G in I)(function(J){D[J]=function(){x.fire("save");x.focus();I[J](x);x.fire("save")}})(G);l.register(x.document,{rules:u,width:"120px",funcs:D});B.Utils.lazyRun(this,"_prepareTableShow","_realTableShow")},_tableInit:function(){var x=this,D=x.editor,G=new k({width:"350px",mask:true,title:"\u7f16\u8f91\u8868\u683c"});
G.body.html("<table class='ke-table-config'><tr><td><label>\u884c\u6570\uff1a <input value='2' class='ke-table-rows ke-table-create-only' size='8'/></label></td><td><label>\u5bbd\u5ea6\uff1a <input value='200' class='ke-table-width' size='8'/></label> <select class='ke-table-width-unit'><option value='px'>\u50cf\u7d20</option><option value='%'>\u767e\u5206\u6bd4</option></select></td></tr><tr><td><label>\u5217\u6570\uff1a <input class='ke-table-cols ke-table-create-only' value='3' size='8'/></label></td><td><label>\u9ad8\u5ea6\uff1a <input value='200' class='ke-table-height' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td><label>\u6807\u9898\u683c\uff1a <select class='ke-table-head ke-table-create-only'><option value=''>\u65e0</option><option value='1'>\u6709</option></select></td><td><label>\u95f4\u8ddd\uff1a <input value='1' class='ke-table-cellspacing' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td><label>\u5bf9\u9f50\uff1a <select class='ke-table-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option><option value='center'>\u4e2d\u95f4\u5bf9\u9f50</option></select></label></td><td><label>\u8fb9\u8ddd\uff1a <input value='1' class='ke-table-cellpadding' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td></td><td><label>\u8fb9\u6846\uff1a <input value='1' class='ke-table-border' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td colspan='2'><label>\u6807\u9898\uff1a<input class='ke-table-caption' style='width:270px'></label></td></tr><tr><td colspan='2' style='text-align:center'><button class='ke-table-ok'>\u786e\u5b9a</button></td></tr></table>");
G.twidth=G.body.one(".ke-table-width");G.theight=G.body.one(".ke-table-height");G.tcellspacing=G.body.one(".ke-table-cellspacing");G.tcellpadding=G.body.one(".ke-table-cellpadding");G.tborder=G.body.one(".ke-table-border");G.tcaption=G.body.one(".ke-table-caption");G.talign=G.body.one(".ke-table-align");G.trows=G.body.one(".ke-table-rows");G.tcols=G.body.one(".ke-table-cols");G.thead=G.body.one(".ke-table-head");G.tok=G.body.one(".ke-table-ok");G.tclose=G.body.one(".ke-table-close");G.twidthunit=
G.body.one(".ke-table-width-unit");x.tableDialog=G;G.tok.on("click",x._tableOk,x);G.on("hide",function(){x.selectedTable=null;D.focus()})},_tableOk:function(){this.selectedTable?this._modifyTable():this._genTable()},_modifyTable:function(){var x=this.tableDialog,D=this.selectedTable,G=D.one("caption");a(x.talign.val())&&D.attr("align",m(x.talign.val()));a(x.tcellspacing.val())&&D.attr("cellspacing",m(x.tcellspacing.val()));a(x.tcellpadding.val())&&D.attr("cellpadding",m(x.tcellpadding.val()));a(x.tborder.val())&&
D.attr("border",m(x.tborder.val()));!a(x.tborder.val())||x.tborder.val()=="0"?D.addClass("ke_show_border"):D.remoevClass("ke_show_border");a(x.twidth.val())&&D.css("width",m(x.twidth.val())+x.twidthunit.val());a(x.theight.val())&&D.css("height",m(x.theight.val()));if(a(x.tcaption.val()))G&&G[0]?G.html(m(x.tcaption.val())):(new t("<caption><span>"+m(x.tcaption.val())+"</span></caption>")).insertBefore(D[0].firstChild);else G&&G._4e_remove();x.hide()},_genTable:function(){var x=this.tableDialog,D="<table ",
G,J=parseInt(x.tcols.val()),N=parseInt(x.trows.val()),M=z.ie?"":"<br/>",Q=this.editor;if(r.trim(x.talign.val()).length!=0)D+="align='"+r.trim(x.talign.val())+"' ";if(r.trim(x.tcellspacing.val()).length!=0)D+="cellspacing='"+r.trim(x.tcellspacing.val())+"' ";if(r.trim(x.tcellpadding.val()).length!=0)D+="cellpadding='"+r.trim(x.tcellpadding.val())+"' ";if(r.trim(x.tborder.val()).length!=0)D+="border='"+r.trim(x.tborder.val())+"' ";if(r.trim(x.twidth.val()).length!=0||r.trim(x.theight.val()).length!=
0){D+="style='";if(r.trim(x.twidth.val()).length!=0)D+="width:"+r.trim(x.twidth.val())+x.twidthunit.val()+";";if(r.trim(x.theight.val()).length!=0)D+="height:"+r.trim(x.theight.val())+"px;";D+="' "}if(r.trim(x.tborder.val()).length==0||r.trim(x.tborder.val())=="0")D+="class='ke_show_border' ";D+=">";if(r.trim(x.tcaption.val()))D+="<caption><span>"+r.trim(x.tcaption.val())+"</span></caption>";if(x.thead.val()){D+="<thead>";D+="<tr>";for(G=0;G<J;G++)D+="<th>"+M+"</th>";D+="</tr>";D+="</thead>"}D+="<tbody>";
for(var R=0;R<N;R++){D+="<tr>";for(G=0;G<J;G++)D+="<td>"+M+"</td>";D+="</tr>"}D+="</tbody>";D+="</table>";D=new t(D,null,Q.document);Q.insertElement(D);x.hide()},_fillTableDialog:function(){var x=this.tableDialog,D=this.selectedTable,G=D.one("caption");x.talign.val(D.attr("align")||"");x.tcellspacing.val(D.attr("cellspacing")||"");x.tcellpadding.val(D.attr("cellpadding")||"");x.tborder.val(D.attr("border")|"");var J=D._4e_style("width")||"";x.twidth.val(J.replace(/px|%/i,""));J.indexOf("%")!=-1?x.twidthunit.val("%"):
x.twidthunit.val("px");x.theight.val((D._4e_style("height")||"").replace(/px|%/i,""));J="";if(G)J=G.text();x.tcaption.val(J);x.trows.val(D.one("tbody").children().length);x.tcols.val(D.one("tr").children().length);x.thead.val(D._4e_first(function(N){return N._4e_name()=="thead"})?"1":"")},_realTableShow:function(){if(this.selectedTable){this._fillTableDialog();this.tableDialog.body.all(".ke-table-create-only").attr("disabled","disabled")}else this.tableDialog.body.all(".ke-table-create-only").removeAttr("disabled");
this.tableDialog.show()},_prepareTableShow:function(){this._tableInit()},_tableShow:function(){this._prepareTableShow()}});var C=/^(?:td|th)$/,I={"\u8868\u683c\u5c5e\u6027":function(x){var D=x.getSelection();if(D=(D=D&&D.getStartElement())&&D._4e_ascendant("table",true)){x=x._toolbars.table;x.selectedTable=D;x._tableShow()}},"\u5220\u9664\u8868\u683c":function(x){var D=(x=x.getSelection())&&x.getStartElement();if(D=D&&D._4e_ascendant("table",true)){x.selectElement(D);var G=x.getRanges()[0];G.collapse();
x.selectRanges([G]);x=D.parent();x[0].childNodes.length==1&&x._4e_name()!="body"?x._4e_remove():D._4e_remove()}},"\u5220\u9664\u884c":function(x){x=x.getSelection();n(i(x),q)},"\u5220\u9664\u5217":function(x){x=x.getSelection();(x=e(x))&&n(x,true)},"\u5728\u4e0a\u65b9\u63d2\u5165\u884c":function(x){x=x.getSelection();d(x,true)},"\u5728\u4e0b\u65b9\u63d2\u5165\u884c":function(x){x=x.getSelection();d(x,q)},"\u5728\u5de6\u4fa7\u63d2\u5165\u5217":function(x){x=x.getSelection();p(x,true)},"\u5728\u53f3\u4fa7\u63d2\u5165\u5217":function(x){x=
x.getSelection();p(x,q)}};B.TableUI=j}();y.addPlugin(function(){var j=y.document;new B.TableUI(y);var a=v.create("<style>",null,j);j.getElementsByTagName("head")[0].appendChild(a);if(a.styleSheet)a.styleSheet.cssText=o;else a.appendChild(j.createTextNode(o))})});
KISSY.Editor.add("templates",function(y){var q=KISSY.Editor,B=KISSY,r=B.Node,t=q.TripleButton,v=q.SimpleOverlay;q.TplUI||function(){function s(z){this.editor=z;this._init()}B.augment(s,{_init:function(){(new t({container:this.editor.toolBarDiv,contentCls:"ke-toolbar-template",title:"\u6a21\u677f"})).on("click",this._show,this);q.Utils.lazyRun(this,"_prepare","_real")},_prepare:function(){for(var z=this.editor,f=z.cfg.pluginConfig.templates,h="<div class='ke-tpl'>",k=0;k<f.length;k++)h+="<a href='javascript:void(0)' class='ke-tpl-list' tabIndex='-1'>"+
f[k].demo+"</a>";h+="</div>";this._initDialogOk=true;var l=new v({mask:true,title:"\u5185\u5bb9\u6a21\u677f"});l.body.html(h);h=l.body.all(".ke-tpl-list");l.on("hide",function(){z.focus()});h.on("click",function(u){u.halt();u=(new r(u.target))._4e_index();u!=-1&&z.insertHtml(f[u].html);l.hide()});this.ui=l},_real:function(){this.ui.show()},_show:function(){this._prepare()}});q.TplUI=s}();y.addPlugin(function(){new q.TplUI(y)})});
KISSY.Editor.add("undo",function(y){var q=KISSY.Editor,B=KISSY,r=q.Utils.arrayCompare,t=B.UA,v=B.Event;q.UndoManager||function(){function s(o){var j=o._getRawData();o=j&&o.getSelection();this.contents=j;this.bookmarks=o&&o.createBookmarks2(true)}function z(o,j,a){this.s=o;this.fn=j;this.scope=a||window;this.bufferTimer=null}function f(o){this.history=[];this.index=0;this.editor=o;this.bufferTimer=new z(500,this.save,this);this._init()}function h(o,j,a,b){this.editor=o;this.title=a;this.text=j;this.contentCls=
b;this._init()}B.augment(s,{equals:function(o){if(this.contents!=o.contents)return false;var j=this.bookmarks;o=o.bookmarks;if(j||o){if(!j||!o||j.length!=o.length)return false;for(var a=0;a<j.length;a++){var b=j[a],g=o[a];if(b.startOffset!=g.startOffset||b.endOffset!=g.endOffset||!r(b.start,g.start)||!r(b.end,g.end))return false}}return true}});B.augment(z,{run:function(){if(this.bufferTimer){clearTimeout(this.bufferTimer);this.bufferTimer=null}var o=this;this.bufferTimer=setTimeout(function(){o.fn.call(o.scope)},
this.s)}});var k={16:1,17:1,18:1},l={37:1,38:1,39:1,40:1};B.augment(f,{_keyMonitor:function(){var o=this.editor;v.on(o.document,"keydown",function(j){var a=j.keyCode;if(!(a in l||a in k))if(a===90&&(j.ctrlKey||j.metaKey)){o.fire("restore",{d:-1});j.halt()}else if(a===89&&(j.ctrlKey||j.metaKey)){o.fire("restore",{d:1});j.halt()}else o.fire("save",{buffer:1})})},_init:function(){var o=this,j=o.editor;j.on("save",function(a){a.buffer?o.bufferTimer.run():o.save()});j.on("restore",this.restore,this);o._keyMonitor()},
save:function(){this.history.length>this.index+1&&this.history.splice(this.index+1,this.history.length-this.index-1);var o=this.editor,j=this.history.length>0?this.history[this.history.length-1]:null,a=new s(this.editor);if(!j||!j.equals(a)){this.history.length===30&&this.history.shift();this.history.push(a);this.index=this.history.length-1;o.fire("afterSave",{history:this.history,index:this.index})}},restore:function(o){o=o.d;var j=this.editor,a=this.history.length>0?this.history[this.index+o]:null;
if(a){j._setRawData(a.contents);if(a.bookmarks)this.editor.getSelection().selectBookmarks(a.bookmarks);else if(t.ie){a=this.editor.document.body.createTextRange();a.collapse(true);a.select()}this.index+=o;j.fire("afterRestore",{history:this.history,index:this.index})}}});var u=q.TripleButton,m={redo:1,undo:-1};B.augment(h,{_init:function(){var o=this,j=o.editor;o.el=new u({contentCls:o.contentCls,title:o.title,container:j.toolBarDiv});this.el.set("state",u.DISABLED);j.on("afterSave",this._respond,
this);j.on("afterRestore",this._respond,this);o.el.on("offClick",function(){j.fire("restore",{d:m[o.text]})})},_respond:function(o){this.updateUI(o.history,o.index)},updateUI:function(o,j){if(this.text=="undo")j>0&&o.length>0?this.el.set("state",u.OFF):this.el.set("state",u.DISABLED);else if(this.text=="redo")j<o.length-1?this.el.set("state",u.OFF):this.el.set("state",u.DISABLED)}});q.UndoManager=f;q.RestoreUI=h}();y.addPlugin(function(){new q.UndoManager(y);new q.RestoreUI(y,"undo","\u64a4\u9500",
"ke-toolbar-undo");new q.RestoreUI(y,"redo","\u91cd\u505a","ke-toolbar-redo")})});
