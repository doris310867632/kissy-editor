KISSY.add("editor",function(w,s){function B(p,a){var d=this;if(!(d instanceof B))return new B(p,a);if(w.isString(p))p=w.one(p);p[0]||(p=new Node(p));d.cfg=a||{pluginConfig:{}};w.app(d,w.EventTarget);d.use=function(h){w.use.call(d,h,function(){d.on("dataReady",function(){d.setData(p.val())})},{order:true,global:B})};d.init(p);return s}function q(p){if(!t)return"build/"+p.replace(/\.(js|css)/i,"-min.$1");if(t==="dev")return p;return"build/"+p}w.app(B,w.EventTarget);B.Config.base=w.Config.base+"editor/";
var t=w.Config.debug,A={htmlparser:{attach:false,path:q("plugins/htmldataprocessor/htmlparser/htmlparser.js")}},n=["utils","focusmanager","definition","dtd","dom","elementpath","walker","range","domiterator","selection","styles"],u=["clipboard",{name:"color"},{name:"elementpaths"},"enterkey","fakeobjects",{name:"flash",requires:["contextmenu","fakeobjects","overlay"]},{name:"font",requires:["select"]},"format",{name:"htmldataprocessor",requires:["htmlparser-text"]},{name:"image",requires:["overlay"]},
"indent","justify","link","list","maximize","music","preview","removeformat",{name:"smiley"},"sourcearea",{name:"table",requires:["overlay","contextmenu"]},{name:"templates",requires:["overlay"]},"undo"],k=[{name:"htmlparser-basicwriter",requires:["htmlparser"]},{name:"htmlparser-element",requires:["htmlparser-fragment"]},{name:"htmlparser-filter",requires:["htmlparser-element"]},{name:"htmlparser-fragment",requires:["htmlparser-htmlwriter"]},{name:"htmlparser-htmlwriter",requires:["htmlparser-basicwriter"]},
{name:"htmlparser-text",requires:["htmlparser-comment"]},{name:"htmlparser-comment",requires:["htmlparser-filter"]}],f=[{name:"button"},{name:"overlay"},{name:"contextmenu",requires:["overlay"]},{name:"select",requires:["overlay"]}],g,m,z,v,l;g=0;for(m=f.length;g<m;g++){v=z=f[g];l=s;if(!w.isString(z)){l=z.requires;v=z.name}A[v]={attach:false,requires:l,path:q("ui/"+v+".js"),csspath:z.useCss?q("ui/"+v+".css"):""}}g=0;for(m=u.length;g<m;g++){v=z=u[g];l=["button"];if(!w.isString(z)){z.requires&&(l=l.concat(z.requires));
v=z.name}A[v]={attach:false,requires:l,csspath:z.useCss?q("plugins/"+v+"/plugin.css"):s,path:q("plugins/"+v+"/plugin.js")}}g=0;for(m=k.length;g<m;g++){z=k[g];l=s;if(!w.isString(z)){l=z.requires;z=z.name}A[z]={attach:false,requires:l,path:q("plugins/htmldataprocessor/htmlparser/"+z.substring(11)+".js")}}B.add(A);A={};g=0;for(m=n.length;g<m;g++){z=n[g];A[z]={host:"editor",requires:g>0?n[g-1]:[]}}B.add(A);w.Editor=B});
KISSY.Editor.add("utils",function(w){var s=KISSY,B=s.Node,q=s.DOM,t=s.Config.debug,A=s.UA;w.Utils={getFlashUrl:function(n){var u="",k=w.NODE;if(n._4e_name()=="object"){n=n[0].childNodes;for(var f=0;f<n.length;f++)if(n[f].nodeType==k.NODE_ELEMENT)if((q.attr(n[f],"name")||"").toLowerCase()=="movie")u=q.attr(n[f],"value");else if(q._4e_name(n[f])=="embed")u=q.attr(n[f],"src");else q._4e_name(n[f])=="object"&&q.attr(n[f],"data")}else if(n._4e_name()=="embed")u=n.attr("src");return u},debugUrl:function(n){if(!t)return"build/"+
n.replace(/\.(js|css)/i,"-min.$1");if(t==="dev")return n;return"build/"+n},lazyRun:function(n,u,k){var f=n[u],g=n[k];n[u]=function(){f.apply(this,arguments);n[u]=n[k];return g.apply(this,arguments)}},getXY:function(n,u,k,f){k=k.defaultView||k.parentWindow;n-=q.scrollLeft(k);u-=q.scrollTop(k);if(f)if(k!=(f.defaultView||f.parentWindow)&&k.frameElement){f=q._4e_getOffset(k.frameElement,f);n+=f.left;u+=f.top}return{left:n,top:u}},tryThese:function(){for(var n,u=0,k=arguments.length;u<k;u++){var f=arguments[u];
try{n=f();break}catch(g){}}return n},arrayCompare:function(n,u){if(!n&&!u)return true;if(!n||!u||n.length!=u.length)return false;for(var k=0;k<n.length;k++)if(n[k]!==u[k])return false;return true},getByAddress:function(n,u,k){n=n.documentElement;for(var f=0;n&&f<u.length;f++){var g=u[f];if(k)for(var m=-1,z=0;z<n.childNodes.length;z++){var v=n.childNodes[z];if(!(k===true&&v.nodeType==3&&v.previousSibling&&v.previousSibling.nodeType==3)){m++;if(m==g){n=v;break}}}else n=n.childNodes[g]}return n?new B(n):
null},clearAllMarkers:function(n){for(var u in n)n[u]._4e_clearMarkers(n,true)},htmlEncodeAttr:function(n){return n.replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/,"&gt;")},ltrim:function(n){return n.replace(/^\s+/,"")},rtrim:function(n){return n.replace(/\s+$/,"")},trim:function(n){return this.ltrim(this.rtrim(n))},mix:function(){for(var n={},u=0;u<arguments.length;u++)n=s.mix(n,arguments[u]);return n},isCustomDomain:function(){if(!A.ie)return false;var n=document.domain,u=window.location.hostname;
return n!=u&&n!="["+u+"]"}}});
KISSY.Editor.add("focusmanager",function(w){function s(){this.iframeFocus=true;u=this}function B(){this.iframeFocus=false;u=null}var q=KISSY,t=q.DOM,A=q.Event;q={};var n={},u;q={refreshAll:function(){for(var k in n){var f=n[k];f.document.designMode="off";f.document.designMode="on"}},currentInstance:function(){return u},getInstance:function(k){return n[k]},add:function(k){var f=t._4e_getWin(k.document);A.on(f,"focus",s,k);A.on(f,"blur",B,k)},register:function(k){n[k._UUID]=k},remove:function(k){delete n[k._UUID];
var f=t._4e_getWin(k.document);A.remove(f,"focus",s,k);A.remove(f,"blur",B,k)}};w.focusManager=q});
KISSY.Editor.add("definition",function(w){function s(l){return f+"<html><head><title>kissy-editor</title><link href='"+w.Config.base+g+"' rel='stylesheet'/></head><body class='ke-editor'>&nbsp;</body><html>"+(l?'<script id="ke_actscrpt" type="text/javascript">'+(w.Utils.isCustomDomain()?'document.domain="'+document.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+l+'");<\/script>':"")}var B=KISSY,q=B.UA,t=B.DOM,A=B.Node,n=B.Event,u=w.focusManager,k=w.Utils.tryThese,f="<!doctype html>",g=
w.Utils.debugUrl("assets/editor-iframe.css"),m=1,z="document.open();"+(w.Utils.isCustomDomain()?'document.domain="'+document.domain+'";':"")+"document.close();",v="<div  class='ke-editor-wrap'  > <div class='"+".ke-editor-tools".substring(1)+"'></div><div class='"+".ke-textarea-wrap".substring(1)+'\'><iframe  style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor"  src="'+(q.ie?"javascript:void(function(){"+encodeURIComponent(z)+"}())":"")+'"  tabIndex="'+
(q.webkit?-1:"$(tabIndex)")+'"  allowTransparency="true" ></iframe></div><div class=\''+".ke-editor-status".substring(1)+"'></div></div>";B.augment(w,{init:function(l){var p=this,a=new A(v.replace(/\$\(tabIndex\)/,l.attr("tabIndex")));a.on("mousedown",function(i){if(q.webkit){var c=t._4e_name(i.target);if(c=="select"||c=="option")return true}i.halt()});p.editorWrap=a;p._UUID=m++;u.register(p);p.wrap=a.one(".ke-textarea-wrap");p.iframe=p.wrap.one("iframe");p.toolBarDiv=a.one(".ke-editor-tools");p.textarea=
l;p.statusDiv=a.one(".ke-editor-status");p.toolBarDiv._4e_unselectable();p._commands={};p._plugins={};var d=l._4e_style("width"),h=l._4e_style("height");if(d){a.css("width",d);l.css("width","100%")}p.textarea.css("display","none");a.insertAfter(l);p.wrap[0].appendChild(l[0]);if(h){p.wrap.css("height",h);l.css("height","100%")}l=p.iframe;p.on("dataReady",function(){p.ready=true;w.fire("instanceCreated",{editor:p})});q.gecko?l.on("load",p._setUpIFrame,p):p._setUpIFrame()},addCommand:function(l,p){this._commands[l]=
p},execCommand:function(l){this.fire("save");this._commands[l].exec(this);this.fire("save")},getData:function(){if(this.htmlDataProcessor)return this.htmlDataProcessor.toHtml(this.document.body.innerHTML,"p");return this.document.body.innerHTML},setData:function(l){if(this.htmlDataProcessor)l=this.htmlDataProcessor.toDataFormat(l,"p");this.document.body.innerHTML=l},sync:function(){this.textarea.val(this.getData())},_getRawData:function(){return this.document.body.innerHTML},_setRawData:function(l){this.document.body.innerHTML=
l},_hideSource:function(){this.iframe.css("display","");this.textarea.css("display","none");this.toolBarDiv.children().css("visibility","");this.statusDiv.children().css("visibility","")},_showSource:function(){this.textarea.css("display","");this.iframe.css("display","none");this.toolBarDiv.children().css("visibility","hidden");this.toolBarDiv.all(".ke-tool-editor-source").css("visibility","");this.statusDiv.children().css("visibility","hidden");q.ie<8&&this.textarea.css("height",this.wrap.css("height"))},
_prepareIFrameHtml:s,getSelection:function(){var l=new w.Selection(this.document);return!l||l.isInvalid?null:l},focus:function(){var l=t._4e_getWin(this.document);q.webkit&&l&&l.parent&&l.parent.focus();l&&l.focus();this.document&&this.document.body.focus();this.notifySelectionChange()},blur:function(){t._4e_getWin(this.document).blur();this.document&&this.document.body.blur()},_setUpIFrame:function(){function l(){i=h.document;p.document=i;a.detach();i.open("text/html","replace");i.write(d);i.close()}
var p=this,a=p.iframe,d=s(p._UUID),h=a[0].contentWindow,i;try{i=h.document}catch(c){a[0].src=a[0].src;if(q.ie&&q.ie<7){setTimeout(l,10);return}}l()},addPlugin:function(l){this.ready?l():this.on("dataReady",l)},_monitor:function(){var l=this;l._monitorId&&clearTimeout(l._monitorId);l._monitorId=setTimeout(function(){var p=l.getSelection();if(p&&!p.isInvalid){p=p.getStartElement();var a=new w.ElementPath(p);if(!l.previousPath||!l.previousPath.compare(a)){l.previousPath=a;l.fire("selectionChange",{selection:l,
path:a,element:p})}}},200)},notifySelectionChange:function(){this.previousPath=null;this._monitor()},insertElement:function(l){var p=this;p.focus();var a=l._4e_name(),d=w.XHTML_DTD,h=w.RANGE,i=w.NODE,c=d.$block[a],j=p.getSelection(),b=j.getRanges(),e,o,y,r,D;p.fire("save");for(var H=b.length-1;H>=0;H--){e=b[H];e.deleteContents();o=!H&&l||l._4e_clone(true);if(c)for(;(r=e.getCommonAncestor(false,true))&&(D=d[r._4e_name()])&&!(D&&D[a]);)if(r._4e_name()in d.span)e.splitElement(r);else if(e.checkStartOfBlock()&&
e.checkEndOfBlock()){e.setStartBefore(r);e.collapse(true);r._4e_remove()}else e.splitBlock();e.insertNode(o);y||(y=o)}e.moveToPosition(y,h.POSITION_AFTER_END);(l=y._4e_nextSourceNode(true))&&l.type==i.NODE_ELEMENT&&e.moveToElementEditablePosition(l);j.selectRanges([e]);p.focus();o&&o._4e_scrollIntoView();setTimeout(function(){p.fire("save")},10)},insertHtml:function(l){var p=this;if(p.htmlDataProcessor)l=p.htmlDataProcessor.toDataFormat(l);if(q.webkit){l=t.create(l,null,this.document);l=l.nodeType==
11?B.makeArray(l.childNodes):[l];for(var a=0;a<l.length;a++)p.insertElement(new A(l[a]))}else{p.focus();p.fire("save");a=p.getSelection();if(q.ie){a=a.getNative();a.type=="Control"&&a.clear();a.createRange().pasteHTML(l)}else p.document.execCommand("inserthtml",false,l);p.focus();setTimeout(function(){p.fire("save")},10)}}});w._initIFrame=function(l){function p(r){k(function(){h.designMode="on";setTimeout(function(){h.designMode="off";c.focus();if(!arguments.callee.retry)arguments.callee.retry=true},
10)},function(){h.designMode="off";t.attr(c,"contentEditable",false);t.attr(c,"contentEditable",true);!r&&p(1)})}var a=u.getInstance(l);l=a.textarea[0];var d=a.iframe[0].contentWindow,h=a.document,i=h.getElementById("ke_actscrpt");i.parentNode.removeChild(i);var c=h.body;if(q.ie){c.hideFocus=true;c.disabled=true;c.contentEditable=true;c.removeAttribute("disabled")}else setTimeout(function(){if(q.gecko||q.opera)c.contentEditable=true;else if(q.webkit)c.parentNode.contentEditable=true;else h.designMode=
"on"},0);try{h.execCommand("enableObjectResizing",false,true)}catch(j){}try{h.execCommand("enableInlineTableEditing",false,true)}catch(b){}q.webkit&&n.on(h,"mousedown",function(r){r=new A(r.target);B.inArray(r._4e_name(),["img","hr","input","textarea","select"])&&a.getSelection().selectElement(r)});if(q.webkit){n.on(h,"click",function(r){var D=new A(r.target);B.inArray(D._4e_name(),["input","select"])&&r.preventDefault()});n.on(h,"mouseup",function(r){var D=new A(r.target);B.inArray(D._4e_name(),
["input","textarea"])&&r.preventDefault()})}if(q.gecko||q.ie||q.opera){var e;e=new A(t.insertAfter((new A('<span style="position:absolute; left:-10000"></span>'))[0],l));e.on("focus",function(){a.focus()});a.on("destroy",function(){})}if(q.ie&&h.compatMode=="CSS1Compat"||q.gecko||q.opera){var o=new A(h.documentElement);o.on("mousedown",function(r){if(r.target===o[0]){q.gecko&&p(false);e[0].focus()}})}n.on(d,"focus",function(){if(q.gecko)p(false);else q.opera&&c.focus();a.notifySelectionChange()});
q.gecko&&n.on(a.document,"mousedown",function(){a.iframeFocus||p(false)});if(q.ie){n.on(h,"keydown",function(r){if(r.keyCode in{8:1,46:1}){var D=a.getSelection(),H=D.getSelectedElement();if(H){a.fire("save");var x=D.getRanges()[0].createBookmark();H._4e_remove();D.selectBookmarks([x]);a.fire("save");r.preventDefault()}}});if(h.compatMode=="CSS1Compat"){var y={33:1,34:1};n.on(h,"keydown",function(r){r.keyCode in y&&setTimeout(function(){a.getSelection().scrollIntoView()},0)})}}setTimeout(function(){q.ie&&
setTimeout(function(){if(h){c.runtimeStyle.marginBottom="0px";c.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){a.fire("dataReady")},10);u.add(a)};q.gecko&&function(){var l=document.body;if(l){var p=l.getAttribute("onpageshow");l.setAttribute("onpageshow",(p?p+";":"")+"event.persisted && KISSY.Editor.focusManager.refreshAll();")}else window.addEventListener("load",arguments.callee,false)}()});
KISSY.Editor.add("dtd",function(w){w.XHTML_DTD=function(){var s=function(j){for(var b=arguments.length-1;b>0;)KISSY.mix(j,arguments[b--]);return j},B={isindex:1,fieldset:1},q={input:1,button:1,select:1,textarea:1,label:1},t=s({a:1},q),A=s({iframe:1},t),n={hr:1,ul:1,menu:1,div:1,blockquote:1,noscript:1,table:1,center:1,address:1,dir:1,pre:1,h5:1,dl:1,h4:1,noframes:1,h6:1,ol:1,h1:1,h3:1,h2:1},u={ins:1,del:1,script:1,style:1},k=s({b:1,acronym:1,bdo:1,"var":1,"#":1,abbr:1,code:1,br:1,i:1,cite:1,kbd:1,
u:1,strike:1,s:1,tt:1,strong:1,q:1,samp:1,em:1,dfn:1,span:1},u),f=s({sub:1,img:1,object:1,sup:1,basefont:1,map:1,applet:1,font:1,big:1,small:1},k),g=s({p:1},f);q=s({iframe:1},f,q);f={img:1,noscript:1,br:1,kbd:1,center:1,button:1,basefont:1,h5:1,h4:1,samp:1,h6:1,ol:1,h1:1,h3:1,h2:1,form:1,font:1,"#":1,select:1,menu:1,ins:1,abbr:1,label:1,code:1,table:1,script:1,cite:1,input:1,iframe:1,strong:1,textarea:1,noframes:1,big:1,small:1,span:1,hr:1,sub:1,bdo:1,"var":1,div:1,object:1,sup:1,strike:1,dir:1,map:1,
dl:1,applet:1,del:1,isindex:1,fieldset:1,ul:1,b:1,acronym:1,a:1,blockquote:1,i:1,u:1,s:1,tt:1,address:1,q:1,pre:1,p:1,em:1,dfn:1};var m=s({a:1},q),z={tr:1},v={"#":1},l=s({param:1},f),p=s({form:1},B,A,n,g),a={li:1},d={base:1,link:1,meta:1,title:1},h=s(d,{style:1,script:1}),i={head:1,body:1},c={address:1,blockquote:1,center:1,dir:1,div:1,dl:1,fieldset:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,isindex:1,menu:1,noframes:1,ol:1,p:1,pre:1,table:1,ul:1};return{$nonBodyContent:s({html:1},i,d),$block:c,
$blockLimit:{body:1,div:1,td:1,th:1,caption:1,form:1},$inline:m,$body:s({script:1,style:1},c),$cdata:{script:1,style:1},$empty:{area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},$listItem:{dd:1,dt:1,li:1},$list:{ul:1,ol:1,dl:1},$nonEditable:{applet:1,button:1,embed:1,iframe:1,map:1,object:1,option:1,script:1,textarea:1,param:1},$removeEmpty:{abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},$tabIndex:{a:1,area:1,button:1,input:1,object:1,select:1,textarea:1},$tableContent:{caption:1,col:1,colgroup:1,tbody:1,td:1,tfoot:1,th:1,thead:1,tr:1},html:i,head:h,style:v,body:p,base:{},link:{},meta:{},title:v,col:{},tr:{td:1,th:1},img:{},colgroup:{col:1},noscript:p,td:p,br:{},th:p,center:p,kbd:m,button:s(g,n),basefont:{},h5:m,h4:m,samp:m,h6:m,ol:a,h1:m,h3:m,option:v,h2:m,form:s(B,A,n,g),select:{optgroup:1,option:1},font:m,ins:m,menu:a,abbr:m,label:m,table:{thead:1,
col:1,tbody:1,tr:1,colgroup:1,caption:1,tfoot:1},code:m,script:v,tfoot:z,cite:m,li:p,input:{},iframe:p,strong:m,textarea:v,noframes:p,big:m,small:m,span:m,hr:{},dt:m,sub:m,optgroup:{option:1},param:{},bdo:m,"var":m,div:p,object:l,sup:m,dd:p,strike:m,area:{},dir:a,map:s({area:1,form:1,p:1},B,u,n),applet:l,dl:{dt:1,dd:1},del:m,isindex:{},fieldset:s({legend:1},f),thead:z,ul:a,acronym:m,b:m,a:q,blockquote:p,caption:m,i:m,u:m,tbody:z,s:m,address:s(A,g),tt:m,legend:m,q:m,pre:s(k,t),p:m,em:m,dfn:m}}()});
KISSY.Editor.add("dom",function(w){function s(a){return a.replace(/-(\w)/g,function(d,h){return h.toUpperCase()})}var B=KISSY,q=B.DOM,t=B.UA,A=B.Node,n=w.Utils,u={abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};w.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_COMMENT:8,NODE_DOCUMENT_FRAGMENT:11};w.POSITION={};var k=w.NODE,f=w.POSITION;f.POSITION_IDENTICAL=0;f.POSITION_DISCONNECTED=
1;f.POSITION_FOLLOWING=2;f.POSITION_PRECEDING=4;f.POSITION_IS_CONTAINED=8;f.POSITION_CONTAINS=16;var g={},m={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},z={hr:1},v=function(a){return a[0]||a},l=function(a){if(!a[0])return new A(a);return a},p={_4e_equals:function(a,d){if(!a&&!d)return true;if(!a||!d)return false;a=v(a);d=v(d);return a===d},_4e_isBlockBoundary:function(a,
d){a=l(a);d=B.mix(B.mix({},z),d||{});return m[a.css("display")]||d[a._4e_name()]},_4e_getWin:function(a){return a&&"scrollTo"in a&&a.document?a:a&&a.nodeType===9?a.defaultView||a.parentWindow:false},_4e_index:function(a){a=v(a);for(var d=a.parentNode.childNodes,h=0;h<d.length;h++)if(d[h]===a)return h;return-1},_4e_first:function(a,d){a=v(a);if((a=(a=a.firstChild)&&new A(a))&&d&&!d(a))a=a._4e_next(d);return a},_4e_move:function(a,d,h){a._4e_remove();a=v(a);d=v(d);h?d.insertBefore(a,d.firstChild):d.appendChild(a)},
_4e_name:function(a){a=v(a);var d=a.nodeName.toLowerCase();if(t.ie)if((a=a.scopeName)&&a!="HTML")d=a.toLowerCase()+":"+d;return d},_4e_isIdentical:function(a,d){if(a._4e_name()!=d._4e_name())return false;var h=a[0].attributes,i=d[0].attributes,c=h.length,j=i.length;if(!t.ie&&c!=j)return false;for(var b=0;b<c;b++){var e=h[b];if((!t.ie||e.specified&&e.nodeName!="_ke_expando")&&e.nodeValue!=d.attr(e.nodeName))return false}if(t.ie)for(b=0;b<j;b++){e=i[b];if(e.specified&&e.nodeName!="_ke_expando"&&e.nodeValue!=
a.attr(e.nodeName))return false}return true},_4e_isEmptyInlineRemoveable:function(a){a=v(a).childNodes;for(var d=0,h=a.length;d<h;d++){var i=a[d],c=i.nodeType;if(!(c==k.NODE_ELEMENT&&i.getAttribute("_ke_bookmark")))if(c==k.NODE_ELEMENT&&!p._4e_isEmptyInlineRemoveable(i)||c==k.NODE_TEXT&&B.trim(i.nodeValue))return false}return true},_4e_moveChildren:function(a,d,h){a=v(a);d=d[0]||d;if(a!=d)if(h)for(;h=a.lastChild;)d.insertBefore(a.removeChild(h),d.firstChild);else for(;h=a.firstChild;)d.appendChild(a.removeChild(h))},
_4e_mergeSiblings:function(){function a(d,h,i){if(h[0]&&h[0].nodeType==k.NODE_ELEMENT){for(var c=[];h.attr("_ke_bookmark")||h._4e_isEmptyInlineRemoveable();){c.push(h);h=i?new A(h[0].nextSibling):new A(h[0].previousSibling);if(!h[0]||h[0].nodeType!=k.NODE_ELEMENT)return}if(d._4e_isIdentical(h)){for(var j=i?d[0].lastChild:d[0].firstChild;c.length;)c.shift()._4e_move(d,!i);h._4e_moveChildren(d,!i);h._4e_remove();j[0]&&j[0].nodeType==k.NODE_ELEMENT&&j._4e_mergeSiblings()}}}return function(d){if(d[0])if(u[d._4e_name()]||
d._4e_name()=="a"){a(d,new A(d[0].nextSibling),true);a(d,new A(d[0].previousSibling))}}}(),_4e_unselectable:t.gecko?function(a){a=v(a);a.style.MozUserSelect="none"}:t.webkit?function(a){a=v(a);a.style.KhtmlUserSelect="none"}:function(a){a=v(a);if(t.ie||t.opera){var d,h=0;for(a.unselectable="on";d=a.all[h++];)switch(d.tagName.toLowerCase()){case "iframe":case "textarea":case "input":case "select":break;default:d.unselectable="on"}}},_4e_getOffset:function(a,d){a=v(a);var h,i=0;h=0;var c=a.ownerDocument.defaultView||
a.ownerDocument.parentWindow,j=a.ownerDocument,b=j.documentElement;d=d||j;if(a.getBoundingClientRect){if(a!==j.body&&b!==a){h=a.getBoundingClientRect();i=h.left+(d===j?q.scrollLeft(c):0);h=h.top+(d===j?q.scrollTop(c):0)}if(d)if(c!=(d.defaultView||d.parentWindow)&&c.frameElement){d=p._4e_getOffset(c.frameElement,d);i+=d.left;h+=d.top}}return{left:i,top:h}},_4e_getFrameDocument:function(a){return(a=v(a))&&a.contentWindow.document},_4e_splitText:function(a,d){a=v(a);var h=a.ownerDocument;if(!(!a||a.nodeType!=
k.NODE_TEXT)){if(t.ie&&d==a.nodeValue.length){h=h.createTextNode("");q.insertAfter(h,a);return h}a=new A(a.splitText(d));if(t.ie==8){h=h.createTextNode("");q.insertAfter(h,a[0]);h.parentNode.removeChild(h)}return a}},_4e_parents:function(a,d){a=l(a);var h=[];do h[d?"push":"unshift"](a);while(a=a.parent());return h},_4e_clone:function(a,d,h){a=v(a);a=a.cloneNode(d);if(!h){var i=function(c){if(c.nodeType==k.NODE_ELEMENT){c.removeAttribute("id",false);c.removeAttribute("_ke_expando",false);c=c.childNodes;
for(var j=0;j<c.length;j++)i(c[j])}};i(a)}return new A(a)},_4e_nextSourceNode:function(a,d,h,i){a=v(a);if(i&&!i.call){var c=i[0]||i;i=function(b){b=b[0]||b;return b!==c}}d=!d&&a.firstChild;var j=new A(a);if(!d){if(a.nodeType==k.NODE_ELEMENT&&i&&i(this,true)===false)return null;d=a.nextSibling}for(;!d&&(j=j.parent());){if(i&&i(j,true)===false)return null;d=j[0].nextSibling}if(!d)return null;d=new A(d);if(i&&i(d)===false)return null;if(h&&h!=d[0].nodeType)return d._4e_nextSourceNode(false,h,i);return d},
_4e_previousSourceNode:function(a,d,h,i){a=v(a);if(i&&!i.call){var c=i[0]||i;i=function(b){b=b[0]||b;return b!==c}}d=!d&&a.lastChild;var j=new A(a);if(!d){if(a.nodeType==k.NODE_ELEMENT&&i&&i(a,true)===false)return null;d=a.previousSibling}for(;!d&&(j=j.parent());){if(i&&i(j,true)===false)return null;d=j[0].previousSibling}if(!d)return null;d=new A(d);if(i&&i(d)===false)return null;if(h&&d[0].nodeType!=h)return d._4e_previousSourceNode(false,h,i);return d},_4e_contains:t.ie||t.webkit?function(a,d){a=
v(a);d=v(d);return d.nodeType!=k.NODE_ELEMENT?a.contains(d.parentNode):a!=d&&a.contains(d)}:function(a,d){a=v(a);d=v(d);return!!(a.compareDocumentPosition(d)&16)},_4e_commonAncestor:function(a,d){if(a._4e_equals(d))return a;if(d[0].nodeType!=k.NODE_TEXT&&d._4e_contains(a))return d;a=a[0].nodeType==k.NODE_TEXT?a.parent():a;do if(a[0].nodeType!=k.NODE_TEXT&&a._4e_contains(d))return a;while(a=a.parent());return null},_4e_ascendant:function(a,d,h){a=v(a);if(!h)a=a.parentNode;if(d&&!B.isFunction(d)){var i=
d;d=function(c){return c._4e_name()==i}}for(;a&&a.nodeType!=9;){if(!d||d(new A(a))===true)return new A(a);a=a.parentNode}return null},_4e_hasAttribute:function(a,d){a=v(a);a=a.attributes.getNamedItem(d);return!!(a&&a.specified)},_4e_hasAttributes:t.ie?function(a){a=v(a);for(var d=a.attributes,h=0;h<d.length;h++){var i=d[h];switch(i.nodeName){case "class":if(a.getAttribute("class"))return true;break;case "_ke_expando":continue;default:if(i.specified)return true}}return false}:function(a){a=v(a);t.gecko&&
a.removeAttribute("_moz_dirty");a=a.attributes;return a.length>1||a.length==1&&a[0].nodeName!="_ke_expando"},_4e_position:function(a,d){var h=v(a),i=v(d);if(h.compareDocumentPosition)return h.compareDocumentPosition(i);if(h==i)return f.POSITION_IDENTICAL;if(h.nodeType==k.NODE_ELEMENT&&i.nodeType==k.NODE_ELEMENT){if(h.contains){if(h.contains(i))return f.POSITION_CONTAINS+f.POSITION_PRECEDING;if(i.contains(h))return f.POSITION_IS_CONTAINED+f.POSITION_FOLLOWING}if("sourceIndex"in h)return h.sourceIndex<
0||i.sourceIndex<0?f.POSITION_DISCONNECTED:h.sourceIndex<i.sourceIndex?f.POSITION_PRECEDING:f.POSITION_FOLLOWING}a=a._4e_address();d=d._4e_address();h=Math.min(a.length,d.length);for(i=0;i<=h-1;i++)if(a[i]!=d[i]){if(i<h)return a[i]<d[i]?f.POSITION_PRECEDING:f.POSITION_FOLLOWING;break}return a.length<d.length?f.POSITION_CONTAINS+f.POSITION_PRECEDING:f.POSITION_IS_CONTAINED+f.POSITION_FOLLOWING},_4e_address:function(a,d){a=v(a);var h=[],i=a.ownerDocument.documentElement;for(a=a;a&&a!=i;){var c=a.parentNode,
j=-1;if(c){for(var b=0;b<c.childNodes.length;b++){var e=c.childNodes[b];if(!(d&&e.nodeType==3&&e.previousSibling&&e.previousSibling.nodeType==3)){j++;if(e==a)break}}h.unshift(j)}a=c}return h},_4e_breakParent:function(a,d){var h=new w.Range(a[0].ownerDocument);h.setStartAfter(a);h.setEndAfter(d);d=h.extractContents();h.insertNode(a._4e_remove());a[0].parentNode.insertBefore(d,a[0].nextSibling)},_4e_style:function(a,d,h){if(h!==undefined)return a.css(d,h);a=a[0]||a;return a.style[s(d)]},_4e_remove:function(a,
d){var h=v(a),i=h.parentNode;if(i){if(d)for(;d=h.firstChild;)i.insertBefore(h.removeChild(d),h);i.removeChild(h)}return a},_4e_trim:function(a){q._4e_ltrim(a);q._4e_rtrim(a)},_4e_ltrim:function(a){a=v(a);for(var d;d=a.firstChild;){if(d.nodeType==k.NODE_TEXT){var h=n.ltrim(d.nodeValue),i=d.nodeValue.length;if(h){if(h.length<i){(new A(d))._4e_splitText(i-h.length);a.removeChild(a.firstChild)}}else{a.removeChild(d);continue}}break}},_4e_rtrim:function(a){a=v(a);for(var d;d=a.lastChild;){if(d.type==k.NODE_TEXT){var h=
n.rtrim(d.nodeValue),i=d.nodeValue.length;if(h){if(h.length<i){(new A(d))._4e_splitText(h.length);a.removeChild(a.lastChild)}}else{a.removeChild(d);continue}}break}if(!t.ie&&!t.opera)(d=a.lastChild)&&d.nodeType==1&&d.nodeName.toLowerCase()=="br"&&d.parentNode.removeChild(d)},_4e_appendBogus:function(a){a=v(a);for(var d=a.lastChild;d&&d.nodeType==k.NODE_TEXT&&!B.trim(d.nodeValue);)d=d.previousSibling;if(!d||d.nodeType==k.NODE_TEXT||q._4e_name(d)!=="br"){d=t.opera?a.ownerDocument.createTextNode(""):
a.ownerDocument.createElement("br");t.gecko&&d.setAttribute("type","_moz");a.appendChild(d)}},_4e_previous:function(a,d){a=v(a);var h;do h=(a=a.previousSibling)&&new A(a);while(h&&d&&!d(h));return h},_4e_last:function(a,d){if((a=(a=a[0].lastChild)&&new A(a))&&d&&!d(a))a=a._4e_previous(d);return a},_4e_next:function(a,d){a=v(a);var h;do h=(a=a.nextSibling)&&new A(a);while(h&&d&&!d(h));return h},_4e_outerHtml:function(a){a=v(a);if(a.outerHTML)return a.outerHTML.replace(/<\?[^>]*>/,"");var d=a.ownerDocument.createElement("div");
d.appendChild(a.cloneNode(true));return d.innerHTML},_4e_setMarker:function(a,d,h,i){a[0]||(a=new A(a));var c=a._4e_getData("list_marker_id")||a._4e_setData("list_marker_id",B.guid())._4e_getData("list_marker_id"),j=a._4e_getData("list_marker_names")||a._4e_setData("list_marker_names",{})._4e_getData("list_marker_names");d[c]=a;j[h]=1;return a._4e_setData(h,i)},_4e_clearMarkers:function(a,d,h){a=l(a);var i=a._4e_getData("list_marker_names"),c=a._4e_getData("list_marker_id");for(var j in i)a._4e_removeData(j);
a._4e_removeData("list_marker_names");if(h){a._4e_removeData("list_marker_id");delete d[c]}},_4e_setData:function(a,d,h){var i=q._4e_getUniqueId(a);(g[i]||(g[i]={}))[d]=h;return a},_4e_getData:function(a,d){a=v(a);return(a=(a=a.getAttribute("_ke_expando"))&&g[a])&&a[d]},_4e_removeData:function(a,d){a=v(a);var h=a.getAttribute("_ke_expando");var i=(h=h&&g[h])&&h[d];typeof i!="undefined"&&h&&delete h[d];B.isEmptyObject(h)&&q._4e_clearData(a);return i||null},_4e_clearData:function(a){a=v(a);var d=a.getAttribute("_ke_expando");
d&&delete g[d];d&&a.removeAttribute("_ke_expando")},_4e_getUniqueId:function(a){a=v(a);var d=a.getAttribute("_ke_expando");if(d)return d;d=B.guid();a.setAttribute("_ke_expando",d);return d},_4e_copyAttributes:function(a,d,h){a=v(a);var i=a.attributes;h=h||{};for(var c=0;c<i.length;c++){var j=i[c],b=j.nodeName.toLowerCase(),e;if(!(b in h))if(b=="checked"&&(e=q.attr(a,b)))d.attr(b,e);else if(j.specified||t.ie&&j.nodeValue&&b=="value"){e=q.attr(a,b);if(e===null)e=j.nodeValue;d.attr(b,e)}}if(a.style.cssText!==
"")d[0].style.cssText=a.style.cssText},_4e_isEditable:function(a){a=q._4e_name(a);var d=w.XHTML_DTD;return(a=!d.$nonEditable[a]&&(d[a]||d.span))&&a["#"]},_4e_scrollIntoView:function(a){a=l(a);var d=a[0].ownerDocument,h=q.scrollLeft(d),i=q.scrollTop(d),c=a.offset(),j=c.left;c=c.top;if(q.viewportHeight(d)+i<c||c<i||q.viewportWidth(d)+h<j||j<h)a.scrollIntoView(d)},_4e_getElementsByTagName:function(a,d,h){a=v(a);if(!t.ie&&h)d=h+":"+d;h=[];a=a.getElementsByTagName(d);for(d=0;d<a.length;d++)h.push(new A(a[d]));
return h}};B.DOM._4e_inject=function(a){B.mix(q,a);for(var d in a)a.hasOwnProperty(d)&&function(h){A.prototype[h]=function(){var i=[].slice.call(arguments,0);i.unshift(this);return a[h].apply(null,i)}}(d)};B.DOM._4e_inject(p)});
KISSY.Editor.add("elementpath",function(w){function s(g){var m=null,z=null,v=[];for(g=g;g&&g[0];){if(g[0].nodeType==A.NODE_ELEMENT){if(!this.lastElement)this.lastElement=g;var l=g._4e_name();if(n.ie&&g[0].scopeName!="HTML")l=g[0].scopeName.toLowerCase()+":"+l;if(!z){if(!m&&u[l])m=g;if(k[l])if(!m&&l=="div"&&!f(g))m=g;else z=g}v.push(g);if(l=="body")break}g=g.parent()}this.block=m;this.blockLimit=z;this.elements=v}var B=KISSY,q=B.DOM,t=w.XHTML_DTD,A=w.NODE,n=B.UA,u={address:1,blockquote:1,dl:1,h1:1,
h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},k={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1},f=function(g){g=g[0]||g;g=g.childNodes;for(var m=0,z=g.length;m<z;m++){var v=g[m];if(v.nodeType==A.NODE_ELEMENT&&t.$block[v.nodeName.toLowerCase()])return true}return false};s.prototype={compare:function(g){var m=this.elements;g=g&&g.elements;if(!g||m.length!=g.length)return false;for(var z=0;z<m.length;z++)if(!q._4e_equals(m[z],g[z]))return false;return true},contains:function(g){for(var m=
this.elements,z=0;z<m.length;z++)if(m[z]._4e_name()in g)return m[z];return null}};w.ElementPath=s});
KISSY.Editor.add("walker",function(w){function s(k,f){if(this._.end)return null;var g=this.range,m,z=this.guard,v=this.type,l=k?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start){this._.start=1;g.trim();if(g.collapsed){this.end();return null}}if(!k&&!this._.guardLTR){var p=g.endContainer,a=new u(p[0].childNodes[g.endOffset]);this._.guardLTR=function(c,j){return(!j||!n._4e_equals(p,c))&&(!a[0]||c[0]!==a[0])&&(c[0].nodeType!=A.NODE_ELEMENT||!j||c._4e_name()!="body")}}if(k&&!this._.guardRTL){var d=
g.startContainer,h=g.startOffset>0&&new u(d[0].childNodes[g.startOffset-1]);this._.guardRTL=function(c,j){return c&&c[0]&&(!j||d[0]!==c[0])&&(!h[0]||c[0]!==h[0])&&(c[0].nodeType!=A.NODE_ELEMENT||!j||c._4e_name()!="body")}}var i=k?this._.guardRTL:this._.guardLTR;m=z?function(c,j){if(i(c,j)===false)return false;return z(c,j)}:i;if(this.current)k=this.current[l](false,v,m);else if(k){k=g.endContainer;if(g.endOffset>0){k=new u(k[0].childNodes[g.endOffset-1]);if(m(k)===false)k=null}else k=m(k,true)===
false?null:k._4e_previousSourceNode(true,v,m)}else{k=g.startContainer;if((k=new u(k[0].childNodes[g.startOffset]))&&k[0]){if(m(k)===false)k=null}else k=m(g.startContainer,true)===false?null:g.startContainer._4e_nextSourceNode(true,v,m)}for(;k&&k[0]&&!this._.end;){this.current=k;if(!this.evaluator||this.evaluator(k)!==false){if(!f)return k}else if(f&&this.evaluator)return false;k=k[l](false,v,m)}this.end();return this.current=null}function B(k){for(var f,g=null;f=s.call(this,k);)g=f;return g}function q(k){this.range=
k;this._={}}var t=KISSY,A=w.NODE,n=t.DOM,u=t.Node;t.augment(q,{end:function(){this._.end=1},next:function(){return s.call(this)},previous:function(){return s.call(this,true)},checkForward:function(){return s.call(this,false,true)!==false},checkBackward:function(){return s.call(this,true,true)!==false},lastForward:function(){return B.call(this)},lastBackward:function(){return B.call(this,true)},reset:function(){delete this.current;this._={}}});q.blockBoundary=function(k){return function(f){f[0]||(f=
new u(f));return!(f[0].nodeType==A.NODE_ELEMENT&&f._4e_isBlockBoundary(k))}};q.listItemBoundary=function(){return this.blockBoundary({br:1})};q.bookmark=function(k,f){function g(m){return m&&m[0]&&m._4e_name()=="span"&&m.attr("_ke_bookmark")}return function(m){var z,v;z=m&&m[0]&&m[0].nodeType==A.NODE_TEXT&&(v=m.parent())&&g(v);z=k?z:z||g(m);return f^z}};q.whitespaces=function(k){return function(f){f=(f=f[0]||f)&&f.nodeType==A.NODE_TEXT&&!t.trim(f.nodeValue);return k^f}};q.invisible=function(k){var f=
q.whitespaces();return function(g){g=f(g)||g[0].nodeType==A.NODE_ELEMENT&&!g[0].offsetHeight;return k^g}};w.Walker=q});
KISSY.Editor.add("range",function(w){function s(b){this.endOffset=this.endContainer=this.startOffset=this.startContainer=null;this.collapsed=true;this.document=b}function B(b){var e=b[0].nodeType!=k.NODE_TEXT&&b._4e_name()in p.$removeEmpty,o=!u.trim(b[0].nodeValue);b=!!b.parent().attr("_ke_bookmark");return e||o||b}function q(b){return!c(b)&&!j(b)}function t(b){var e=false,o=m.bookmark(true);return function(y){if(o(y))return true;if(y[0].nodeType==k.NODE_TEXT){if(u.trim(y[0].nodeValue).length)return false}else if(y[0].nodeType==
k.NODE_ELEMENT)if(!i[y._4e_name()])if(!b&&!l.ie&&y._4e_name()=="br"&&!e)e=true;else return false;return true}}function A(b,e){function o(y){return y&&y.nodeName=="span"&&y.getAttribute("_ke_bookmark")}return function(y){var r,D;r=y&&!y.nodeName&&(D=y.parentNode)&&o(D);r=b?r:r||o(y);return e^r}}function n(b){return function(e){e=(e=e[0]||e)&&e.nodeType==k.NODE_TEXT&&!u.trim(e.nodeValue);return b^e}}w.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,
ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,STARTEND:3,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var u=KISSY,k=w.NODE,f=w.RANGE,g=w.POSITION,m=w.Walker,z=u.DOM,v=w.Utils.getByAddress,l=u.UA,p=w.XHTML_DTD,a=w.ElementPath,d=u.Node,h={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1};s.prototype.toString=function(){var b=[];b.push((this.startContainer[0].id||this.startContainer[0].nodeName)+":"+this.startOffset);b.push((this.endContainer[0].id||this.endContainer[0].nodeName)+
":"+this.endOffset);return b.join("<br/>")};u.augment(s,{updateCollapsed:function(){this.collapsed=this.startContainer&&this.endContainer&&z._4e_equals(this.startContainer,this.endContainer)&&this.startOffset==this.endOffset},optimize:function(){var b=this.startContainer,e=this.startOffset;if(b[0].nodeType!=k.NODE_ELEMENT)if(e)e>=b[0].nodeValue.length&&this.setStartAfter(b);else this.setStartBefore(b);b=this.endContainer;e=this.endOffset;if(b[0].nodeType!=k.NODE_ELEMENT)if(e)e>=b[0].nodeValue.length&&
this.setEndAfter(b);else this.setEndBefore(b)},setStartAfter:function(b){this.setStart(b.parent(),b._4e_index()+1)},setStartBefore:function(b){this.setStart(b.parent(),b._4e_index())},setEndAfter:function(b){this.setEnd(b.parent(),b._4e_index()+1)},setEndBefore:function(b){this.setEnd(b.parent(),b._4e_index())},optimizeBookmark:function(){var b=this.startContainer,e=this.endContainer;b&&b._4e_name()=="span"&&b.attr("_ke_bookmark")&&this.setStartAt(b,f.POSITION_BEFORE_START);e&&e._4e_name()=="span"&&
e.attr("_ke_bookmark")&&this.setEndAt(e,f.POSITION_AFTER_END)},setStart:function(b,e){if(b[0].nodeType==k.NODE_ELEMENT&&h[b._4e_name()]){b=b.parent();e=b._4e_index()}this.startContainer=b;this.startOffset=e;if(!this.endContainer){this.endContainer=b;this.endOffset=e}this.updateCollapsed()},setEnd:function(b,e){if(b[0].nodeType==k.NODE_ELEMENT&&h[b._4e_name()]){b=b.parent();e=b._4e_index()+1}this.endContainer=b;this.endOffset=e;if(!this.startContainer){this.startContainer=b;this.startOffset=e}this.updateCollapsed()},
setStartAt:function(b,e){switch(e){case f.POSITION_AFTER_START:this.setStart(b,0);break;case f.POSITION_BEFORE_END:b[0].nodeType==k.NODE_TEXT?this.setStart(b,b[0].nodeValue.length):this.setStart(b,b[0].childNodes.length);break;case f.POSITION_BEFORE_START:this.setStartBefore(b);break;case f.POSITION_AFTER_END:this.setStartAfter(b)}this.updateCollapsed()},setEndAt:function(b,e){switch(e){case f.POSITION_AFTER_START:this.setEnd(b,0);break;case f.POSITION_BEFORE_END:b[0].nodeType==k.NODE_TEXT?this.setEnd(b,
b[0].nodeValue.length):this.setEnd(b,b[0].childNodes.length);break;case f.POSITION_BEFORE_START:this.setEndBefore(b);break;case f.POSITION_AFTER_END:this.setEndAfter(b)}this.updateCollapsed()},execContentsAction:function(b,e){var o=this.startContainer,y=this.endContainer,r=this.startOffset,D=this.endOffset,H,x;this.optimizeBookmark();if(y[0].nodeType==k.NODE_TEXT)y=y._4e_splitText(D);else if(y[0].childNodes.length>0)if(D>=y[0].childNodes.length){y=new d(y[0].appendChild(this.document.createTextNode("")));
x=true}else y=new d(y[0].childNodes[D]);if(o[0].nodeType==k.NODE_TEXT){o._4e_splitText(r);if(z._4e_equals(o,y))y=new d(o[0].nextSibling)}else if(r)if(r>=o[0].childNodes.length){H=new d(this.document.createTextNode(""));o[0].appendChild(H[0]);o=H;H=true}else o=new d(o[0].childNodes[r].previousSibling);else{H=new d(this.document.createTextNode(""));z.insertBefore(H[0],o[0].firstChild);o=H;H=true}r=o._4e_parents();D=y._4e_parents();var C,I,J;for(C=0;C<r.length;C++){I=r[C];J=D[C];if(I[0]!==J[0])break}for(var N=
e,M,Q,R,W=C;W<r.length;W++){M=r[W];if(N&&M[0]!==o[0])Q=N.appendChild(M._4e_clone()[0]);for(M=M[0].nextSibling;M;){if(D[W]&&M==D[W][0]||M==y[0])break;R=M.nextSibling;if(b==2)N.appendChild(M.cloneNode(true));else{M.parentNode.removeChild(M);b==1&&N.appendChild(M)}M=R}if(Q)N=Q}N=e;for(e=C;e<D.length;e++){M=D[e];if(b>0&&M[0]!==y[0])Q=N.appendChild(M._4e_clone()[0]);if(!r[e]||M[0].parentNode!==r[e][0].parentNode)for(M=M[0].previousSibling;M;){if(r[e]&&M==r[e][0]||M===o[0])break;R=M.previousSibling;if(b==
2)N.insertBefore(M.cloneNode(true),N.firstChild);else{M.parentNode.removeChild(M);b==1&&N.insertBefore(M,N.firstChild)}M=R}if(Q)N=Q}if(b==2){J=this.startContainer[0];if(J.nodeType==k.NODE_TEXT&&J.nextSibling&&J.nextSibling.nodeType==k.NODE_TEXT){J.data+=J.nextSibling.data;J.parentNode.removeChild(J.nextSibling)}J=this.endContainer[0];if(J.nodeType==k.NODE_TEXT&&J.nextSibling&&J.nextSibling.nodeType==k.NODE_TEXT){J.data+=J.nextSibling.data;J.parentNode.removeChild(J.nextSibling)}}else{if(I&&J&&(o[0].parentNode!=
I[0].parentNode||y[0].parentNode!=J[0].parentNode)){b=J._4e_index();H&&J[0].parentNode==o[0].parentNode&&b--;this.setStart(J.parent(),b)}this.collapse(true)}H&&o._4e_remove();x&&y[0].parentNode&&y._4e_remove()},collapse:function(b){if(b){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=this.endOffset}this.collapsed=true},clone:function(){var b=new s(this.document);b.startContainer=this.startContainer;b.startOffset=this.startOffset;
b.endContainer=this.endContainer;b.endOffset=this.endOffset;b.collapsed=this.collapsed;return b},getEnclosedNode:function(){var b=this.clone();b.optimize();if(b.startContainer[0].nodeType!=k.NODE_ELEMENT||b.endContainer[0].nodeType!=k.NODE_ELEMENT)return null;b=b.startContainer[0].childNodes[b.startOffset];for(var e=A(true,undefined),o=n(true),y=function(r){return o(r)&&e(r)};b&&y(b);)b=(new d(b))._4e_nextSourceNode()[0];return new d(b)},shrink:function(b,e){if(!this.collapsed){b=b||f.SHRINK_TEXT;
var o=this.clone(),y=this.startContainer,r=this.endContainer,D=this.startOffset,H=this.endOffset,x=1,C=1;if(y&&y[0].nodeType==k.NODE_TEXT)if(D)if(D>=y[0].nodeValue.length)o.setStartAfter(y);else{o.setStartBefore(y);x=0}else o.setStartBefore(y);if(r&&r[0].nodeType==k.NODE_TEXT)if(H)if(H>=r[0].nodeValue.length)o.setEndAfter(r);else{o.setEndAfter(r);C=0}else o.setEndBefore(r);o=new m(o);o.evaluator=function(J){J=J[0]||J;return J.nodeType==(b==f.SHRINK_ELEMENT?k.NODE_ELEMENT:k.NODE_TEXT)};var I;o.guard=
function(J,N){J=J[0]||J;if(b==f.SHRINK_ELEMENT&&J.nodeType==k.NODE_TEXT)return false;if(N&&J==I)return false;if(!N&&J.nodeType==k.NODE_ELEMENT)I=J;return true};if(x)(y=o[b==f.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(y,e?f.POSITION_AFTER_START:f.POSITION_BEFORE_START);if(C){o.reset();(o=o[b==f.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(o,e?f.POSITION_BEFORE_END:f.POSITION_AFTER_END)}return!!(x||C)}},getTouchedStartNode:function(){var b=this.startContainer;if(this.collapsed||
b[0].nodeType!=k.NODE_ELEMENT)return b;return b.childNodes[this.startOffset]||b},createBookmark2:function(b){var e=this.startContainer,o=this.endContainer,y=this.startOffset,r=this.endOffset,D,H;if(!e||!o)return{start:0,end:0};if(b){if(e[0].nodeType==k.NODE_ELEMENT)if((D=new d(e[0].childNodes[y]))&&D[0]&&D[0].nodeType==k.NODE_TEXT&&y>0&&D[0].previousSibling.nodeType==k.NODE_TEXT){e=D;y=0}for(;e[0].nodeType==k.NODE_TEXT&&(H=e._4e_previous())&&H[0].nodeType==k.NODE_TEXT;){e=H;y+=H[0].nodeValue.length}if(!this.collapsed){if(o[0].nodeType==
k.NODE_ELEMENT)if((D=new d(o[0].childNodes[r]))&&D[0]&&D[0].nodeType==k.NODE_TEXT&&r>0&&D[0].previousSibling.nodeType==k.NODE_TEXT){o=D;r=0}for(;o[0].nodeType==k.NODE_TEXT&&(H=o._4e_previous())&&H[0].nodeType==k.NODE_TEXT;){o=H;r+=H[0].nodeValue.length}}}return{start:e._4e_address(b),end:this.collapsed?null:o._4e_address(b),startOffset:y,endOffset:r,normalized:b,is2:true}},createBookmark:function(b){var e,o,y,r;e=new d("<span></span>",null,this.document);e.attr("_ke_bookmark",1);e.css("display","none");
e.html("&nbsp;");if(b){y=u.guid("ke_bm_");e.attr("id",y+"S")}if(!this.collapsed){o=e._4e_clone();o.html("&nbsp;");b&&o.attr("id",y+"E");r=this.clone();r.collapse();r.insertNode(o)}r=this.clone();r.collapse(true);r.insertNode(e);if(o){this.setStartAfter(e);this.setEndBefore(o)}else this.moveToPosition(e,f.POSITION_AFTER_END);return{startNode:b?y+"S":e,endNode:b?y+"E":o,serializable:b}},moveToPosition:function(b,e){this.setStartAt(b,e);this.collapse(true)},trim:function(b,e){var o=this.startContainer,
y=this.startOffset,r=this.collapsed;if((!b||r)&&o[0]&&o[0].nodeType==k.NODE_TEXT){if(y)if(y>=o[0].nodeValue.length){y=o._4e_index()+1;o=o.parent()}else{b=o._4e_splitText(y);y=o._4e_index()+1;o=o.parent();if(z._4e_equals(this.startContainer,this.endContainer))this.setEnd(b,this.endOffset-this.startOffset);else if(z._4e_equals(o,this.endContainer))this.endOffset+=1}else{y=o._4e_index();o=o.parent()}this.setStart(o,y);if(r){this.collapse(true);return}}o=this.endContainer;y=this.endOffset;if(!(e||r)&&
o[0]&&o[0].nodeType==k.NODE_TEXT){if(y){y>=o.nodeValue.length||o._4e_splitText(y);y=o._4e_index()+1}else y=o._4e_index();o=o.parent();this.setEnd(o,y)}},insertNode:function(b){this.optimizeBookmark();this.trim(false,true);var e=this.startContainer,o=e[0].childNodes[this.startOffset];this.optimizeBookmark();this.trim(false,true);o?z.insertBefore(b[0]||b,o):e[0].appendChild(b[0]||b);z._4e_equals(b.parent(),this.endContainer)&&this.endOffset++;this.setStartBefore(b)},moveToBookmark:function(b){if(b.is2){var e=
v(this.document,b.start,b.normalized),o=b.startOffset,y=b.end&&v(this.document,b.end,b.normalized);b=b.endOffset;this.setStart(e,o);y?this.setEnd(y,b):this.collapse(true)}else{e=(o=b.serializable)?u.one("#"+b.startNode,this.document):b.startNode;b=o?u.one("#"+b.endNode,this.document):b.endNode;this.setStartBefore(e);e._4e_remove();if(b&&b[0]){this.setEndBefore(b);b._4e_remove()}else this.collapse(true)}},getCommonAncestor:function(b,e){var o=this.startContainer,y=this.endContainer;b=z._4e_equals(o,
y)?b&&o[0].nodeType==k.NODE_ELEMENT&&this.startOffset==this.endOffset-1?new d(o[0].childNodes[this.startOffset]):o:o._4e_commonAncestor(y);return e&&b[0].nodeType==k.NODE_TEXT?b.parent():b},enlarge:function(b){switch(b){case f.ENLARGE_ELEMENT:if(this.collapsed)return;b=this.getCommonAncestor();var e=new d(this.document.body),o,y,r,D,H,x=false,C,I;C=this.startContainer;I=this.startOffset;if(C[0].nodeType==k.NODE_TEXT){if(I){C=!u.trim(C[0].nodeValue.substring(0,I)).length&&C;x=!!C}if(C)if(!(D=C[0].previousSibling))r=
C.parent()}else{if(I)D=C[0].childNodes[I-1]||C[0].lastChild;D||(r=C)}for(;r||D;){if(r&&!D){if(!H&&z._4e_equals(r,b))H=true;if(!e._4e_contains(r))break;if(!x||r.css("display")!="inline"){x=false;if(H)o=r;else this.setStartBefore(r)}D=r[0].previousSibling}for(;D;){C=false;if(D.nodeType==k.NODE_TEXT){I=D.nodeValue;if(/[^\s\ufeff]/.test(I))D=null;C=/[\s\ufeff]$/.test(I)}else if(D.offsetWidth>0&&!D.getAttribute("_ke_bookmark"))if(x&&p.$removeEmpty[D.nodeName.toLowerCase()]){I=z.text(D);if(/[^\s\ufeff]/.test(I))D=
null;else for(var J=D.all||D.getElementsByTagName("*"),N=0,M;M=J[N++];)if(!p.$removeEmpty[M.nodeName.toLowerCase()]){D=null;break}if(D)C=!!I.length}else D=null;if(C)if(x)if(H)o=r;else r&&this.setStartBefore(r);else x=true;if(D){C=D.previousSibling;if(!r&&!C){r=new d(D);D=null;break}D=C}else r=null}if(r)r=r.parent()}C=this.endContainer;I=this.endOffset;r=D=null;H=x=false;if(C[0].nodeType==k.NODE_TEXT){C=!u.trim(C[0].nodeValue.substring(I)).length&&C;x=!(C&&C[0].nodeValue.length);if(C)if(!(D=C[0].nextSibling))r=
C.parent()}else(D=C[0].childNodes[I])||(r=C);for(;r||D;){if(r&&!D){if(!H&&z._4e_equals(r,b))H=true;if(!e._4e_contains(r))break;if(!x||r.css("display")!="inline"){x=false;if(H)y=r;else r&&this.setEndAfter(r)}D=r[0].nextSibling}for(;D;){C=false;if(D.nodeType==k.NODE_TEXT){I=D.nodeValue;if(/[^\s\ufeff]/.test(I))D=null;C=/^[\s\ufeff]/.test(I)}else if(D.offsetWidth>0&&!D.getAttribute("_ke_bookmark"))if(x&&p.$removeEmpty[D.nodeName.toLowerCase()]){I=z.text(D);if(/[^\s\ufeff]/.test(I))D=null;else{J=D.all||
D.getElementsByTagName("*");for(N=0;M=J[N++];)if(!p.$removeEmpty[M.nodeName.toLowerCase()]){D=null;break}}if(D)C=!!I.length}else D=null;if(C)if(x)if(H)y=r;else this.setEndAfter(r);if(D){C=D.nextSibling;if(!r&&!C){r=new d(D);D=null;break}D=C}else r=null}if(r)r=r.parent()}if(o&&y){b=o._4e_contains(y)?y:o;this.setStartBefore(b);this.setEndAfter(b)}break;case f.ENLARGE_BLOCK_CONTENTS:case f.ENLARGE_LIST_ITEM_CONTENTS:r=new s(this.document);e=new d(this.document.body);r.setStartAt(e,f.POSITION_AFTER_START);
r.setEnd(this.startContainer,this.startOffset);r=new m(r);var Q,R,W=m.blockBoundary(b==f.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:null),$=function(aa){var E=W(aa);E||(Q=aa);return E};o=function(aa){var E=$(aa);if(!E&&aa[0]&&aa._4e_name()=="br")R=aa;return E};r.guard=$;r=r.lastBackward();Q=Q||e;this.setStartAt(Q,Q._4e_name()!="br"&&(!r&&this.checkStartOfBlock()||r&&Q._4e_contains(r))?f.POSITION_AFTER_START:f.POSITION_AFTER_END);r=this.clone();r.collapse();r.setEndAt(e,f.POSITION_BEFORE_END);r=new m(r);r.guard=
b==f.ENLARGE_LIST_ITEM_CONTENTS?o:$;Q=null;r=r.lastForward();Q=Q||e;this.setEndAt(Q,!r&&this.checkEndOfBlock()||r&&Q._4e_contains(r)?f.POSITION_BEFORE_END:f.POSITION_BEFORE_START);R&&this.setEndAfter(R)}},checkStartOfBlock:function(){var b=this.startContainer,e=this.startOffset;if(e&&b[0].nodeType==k.NODE_TEXT)if(u.trim(b[0].nodeValue.substring(0,e)).length)return false;this.trim();b=new a(this.startContainer);e=this.clone();e.collapse(true);e.setStartAt(b.block||b.blockLimit,f.POSITION_AFTER_START);
b=new m(e);b.evaluator=t(true);return b.checkBackward()},checkEndOfBlock:function(){var b=this.endContainer,e=this.endOffset;if(b[0].nodeType==k.NODE_TEXT)if(u.trim(b[0].nodeValue.substring(e)).length)return false;this.trim();b=new a(this.endContainer);e=this.clone();e.collapse(false);e.setEndAt(b.block||b.blockLimit,f.POSITION_BEFORE_END);b=new m(e);b.evaluator=t(false);return b.checkForward()},deleteContents:function(){this.collapsed||this.execContentsAction(0)},extractContents:function(){var b=
this.document.createDocumentFragment();this.collapsed||this.execContentsAction(1,b);return b},checkBoundaryOfElement:function(b,e){var o=this.clone();o[e==f.START?"setStartAt":"setEndAt"](b,e==f.START?f.POSITION_AFTER_START:f.POSITION_BEFORE_END);b=new m(o);b.evaluator=B;return b[e==f.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var b=this.startContainer,e=this.endContainer,o=this.startOffset,y=this.endOffset,r;if(b[0].nodeType==k.NODE_ELEMENT){r=b[0].childNodes.length;if(r>
o)b=new d(b[0].childNodes[o]);else if(r<1)b=b._4e_previousSourceNode();else{for(b=b[0];b.lastChild;)b=b.lastChild;b=new d(b);b=b._4e_nextSourceNode()||b}}if(e[0].nodeType==k.NODE_ELEMENT){r=e[0].childNodes.length;if(r>y)e=(new d(e[0].childNodes[y]))._4e_previousSourceNode(true);else if(r<1)e=e._4e_previousSourceNode();else{for(e=e[0];e.lastChild;)e=e.lastChild;e=new d(e)}}if(b._4e_position(e)&g.POSITION_FOLLOWING)b=e;return{startNode:b,endNode:e}},fixBlock:function(b,e){var o=this.createBookmark();
e=new d(this.document.createElement(e));this.collapse(b);this.enlarge(f.ENLARGE_BLOCK_CONTENTS);e[0].appendChild(this.extractContents());e._4e_trim();l.ie||e._4e_appendBogus();this.insertNode(e);this.moveToBookmark(o);return e},splitBlock:function(b){var e=new a(this.startContainer),o=new a(this.endContainer),y=e.block,r=o.block,D=null;if(e.blockLimit[0]!==o.blockLimit[0])return null;if(b!="br"){if(!y){y=this.fixBlock(true,b);r=(new a(this.endContainer)).block}r||(r=this.fixBlock(false,b))}b=y&&this.checkStartOfBlock();
e=r&&this.checkEndOfBlock();this.deleteContents();if(y&&z._4e_equals(y,r))if(e){D=new a(this.startContainer);this.moveToPosition(r,f.POSITION_AFTER_END);r=null}else if(b){D=new a(this.startContainer);this.moveToPosition(y,f.POSITION_BEFORE_START);y=null}else{r=this.splitElement(y);!l.ie&&!u.inArray(y._4e_name(),["ul","ol"])&&y._4e_appendBogus()}return{previousBlock:y,nextBlock:r,wasStartOfBlock:b,wasEndOfBlock:e,elementPath:D}},splitElement:function(b){if(!this.collapsed)return null;this.setEndAt(b,
f.POSITION_BEFORE_END);var e=this.extractContents(),o=b._4e_clone(false);o[0].appendChild(e);o.insertAfter(b);this.moveToPosition(b,f.POSITION_AFTER_END);return o},moveToElementEditablePosition:function(b,e){var o,y=w.XHTML_DTD;if(y.$empty[b._4e_name()])return false;for(;b&&b[0].nodeType==k.NODE_ELEMENT;){if(o=b._4e_isEditable())this.moveToPosition(b,e?f.POSITION_BEFORE_END:f.POSITION_AFTER_START);else if(y.$inline[b._4e_name()]){this.moveToPosition(b,e?f.POSITION_AFTER_END:f.POSITION_BEFORE_START);
return true}if((b=y.$empty[b._4e_name()]?b[e?"_4e_previous":"_4e_next"](q):b[e?"_4e_last":"_4e_first"](q))&&b[0].nodeType==k.NODE_TEXT){this.moveToPosition(b,e?f.POSITION_AFTER_END:f.POSITION_BEFORE_START);return true}}return o},selectNodeContents:function(b){this.setStart(b,0);this.setEnd(b,b[0].nodeType==k.NODE_TEXT?b[0].nodeValue.length:b[0].childNodes.length)}});var i={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},c=new m.whitespaces,j=new m.bookmark;w.Range=s});
KISSY.Editor.add("domiterator",function(w){function s(v){if(!(arguments.length<1)){this.range=v;this.forceBrBreak=false;this.enlargeBr=true;this.enforceRealBlocks=false;this._||(this._={})}}var B=KISSY,q=B.UA,t=w.Walker,A=w.Range,n=w.RANGE,u=w.NODE,k=w.ElementPath,f=B.Node,g=B.DOM,m=/^[\r\n\t ]*$/,z=t.bookmark();B.augment(s,{getNextParagraph:function(v){var l,p,a,d,h;if(!this._.lastNode){p=this.range.clone();p.enlarge(this.forceBrBreak||!this.enlargeBr?n.ENLARGE_LIST_ITEM_CONTENTS:n.ENLARGE_BLOCK_CONTENTS);
var i=new t(p),c=t.bookmark(true,true);i.evaluator=c;this._.nextNode=i.next();i=new t(p);i.evaluator=c;i=i.previous();this._.lastNode=i._4e_nextSourceNode(true);if(this._.lastNode&&this._.lastNode[0].nodeType==u.NODE_TEXT&&!B.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()){c=new A(p.document);c.moveToPosition(this._.lastNode,n.POSITION_AFTER_END);if(c.checkEndOfBlock()){c=new k(c.endContainer);this._.lastNode=(c.block||c.blockLimit)._4e_nextSourceNode(true)}}if(!this._.lastNode){this._.lastNode=
this._.docEndMarker=new f(p.document.createTextNode(""));g.insertAfter(this._.lastNode[0],i[0])}p=null}c=this._.nextNode;i=this._.lastNode;for(this._.nextNode=null;c;){var j=false,b=c[0].nodeType!=u.NODE_ELEMENT,e=false;if(b){if(c[0].nodeType==u.NODE_TEXT)if(m.test(c[0].nodeValue))b=false}else{var o=c._4e_name();if(c._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if(o=="br")b=true;else if(!p&&!c[0].childNodes.length&&o!="hr"){l=c;a=c._4e_equals(i);break}if(p){p.setEndAt(c,n.POSITION_BEFORE_START);
if(o!="br")this._.nextNode=c}j=true}else{if(c[0].firstChild){if(!p){p=new A(this.range.document);p.setStartAt(c,n.POSITION_BEFORE_START)}c=new f(c[0].firstChild);continue}b=true}}if(b&&!p){p=new A(this.range.document);p.setStartAt(c,n.POSITION_BEFORE_START)}a=(!j||b)&&c._4e_equals(i);if(p&&!j)for(;!c[0].nextSibling&&!a;){o=c.parent();if(o._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){j=true;a||o._4e_equals(i);break}c=o;b=true;a=c._4e_equals(i);e=true}b&&p.setEndAt(c,n.POSITION_AFTER_END);c=c._4e_nextSourceNode(e,
null,i);a=!c;if((j||a)&&p){b=p.getBoundaryNodes();j=new k(p.startContainer);if(b.startNode.parent()._4e_equals(j.blockLimit)&&z(b.startNode)&&z(b.endNode)){p=null;this._.nextNode=null}else break}if(a)break}if(!l){if(!p){this._.docEndMarker&&this._.docEndMarker._4e_remove();return this._.nextNode=null}j=new k(p.startContainer);c=j.blockLimit;b={div:1,th:1,td:1};l=j.block;if((!l||!l[0])&&!this.enforceRealBlocks&&b[c._4e_name()]&&p.checkStartOfBlock()&&p.checkEndOfBlock())l=c;else if(!l||this.enforceRealBlocks&&
l._4e_name()=="li"){l=new f(this.range.document.createElement(v||"p"));l[0].appendChild(p.extractContents());l._4e_trim();p.insertNode(l);d=h=true}else if(l._4e_name()!="li"){if(!p.checkStartOfBlock()||!p.checkEndOfBlock()){l=l._4e_clone(false);l[0].appendChild(p.extractContents());l._4e_trim();h=p.splitBlock();d=!h.wasStartOfBlock;h=!h.wasEndOfBlock;p.insertNode(l)}}else if(!a)this._.nextNode=l._4e_equals(i)?null:p.getBoundaryNodes().endNode._4e_nextSourceNode(true,null,i)}if(d){p=new f(l[0].previousSibling);
if(p[0]&&p[0].nodeType==u.NODE_ELEMENT)if(p._4e_name()=="br")p._4e_remove();else p[0].lastChild&&p[0].lastChild.nodeName.toLowerCase()=="br"&&g._4e_remove(p[0].lastChild)}if(h){p=t.bookmark(false,true);d=new f(l[0].lastChild);if(d[0]&&d[0].nodeType==u.NODE_ELEMENT&&d._4e_name()=="br")if(q.ie||d._4e_previous(p)||d._4e_next(p))d._4e_remove()}if(!this._.nextNode)this._.nextNode=a||l._4e_equals(i)?null:l._4e_nextSourceNode(true,null,i);return l}});A.prototype.createIterator=function(){return new s(this)}});
KISSY.Editor.add("selection",function(w){function s(i){this.document=i;this._={cache:{}};if(A.ie){var c=this.getNative().createRange();if(!c||c.item&&c.item(0).ownerDocument!=i||c.parentElement&&c.parentElement().ownerDocument!=i)this.isInvalid=true}}function B(i){i=new s(i);return!i||i.isInvalid?null:i}function q(i){var c=i.document,j=new f(c.body),b=new f(c.documentElement);if(A.ie){if(A.ie<8||document.documentMode==7)b.on("click",function(D){n._4e_name(D.target)==="html"&&i.getSelection().getRanges()[0].select()});
var e,o;j.on("focusin",function(D){if(D.target.nodeName.toUpperCase()=="BODY")if(e){try{e.select()}catch(H){}e=null}});j.on("focus",function(){o=true;r()});j.on("beforedeactivate",function(D){D.relatedTarget||(o=false)});A.ie<8&&u.on(n._4e_getWin(c),"blur",function(){c.selection.empty()});j.on("mousedown",y);j.on("mouseup",function(){o=true;setTimeout(function(){r(true)},0)});j.on("keydown",y);j.on("keyup",function(){o=true;r()});u.on(c,"selectionchange",r);var y=function(){o=false},r=function(D){if(o){var H=
i.document,x=i.getSelection(),C=x&&x.getNative();if(D&&C&&C.type=="None")if(!H.queryCommandEnabled("InsertImage")){setTimeout(function(){r(true)},50);return}var I;if(!(C&&C.type=="Text"&&(I=C.createRange().parentElement().nodeName.toLowerCase())&&I in{input:1,textarea:1})){e=C&&x.getRanges()[0];i._monitor()}}}}else{u.on(c,"mouseup",i._monitor,i);u.on(c,"keyup",i._monitor,i)}}w.SELECTION={};var t=KISSY,A=t.UA,n=t.DOM,u=t.Event,k=w.Utils.tryThese,f=t.Node,g=w.SELECTION,m=w.RANGE,z=w.NODE,v=w.Walker,
l=w.Range;g.SELECTION_NONE=1;g.SELECTION_TEXT=2;g.SELECTION_ELEMENT=3;var p={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};t.augment(s,{getNative:A.ie?function(){return this._.cache.nativeSel||(this._.cache.nativeSel=this.document.selection)}:function(){return this._.cache.nativeSel||(this._.cache.nativeSel=n._4e_getWin(this.document).getSelection())},getType:A.ie?function(){var i=this._.cache;if(i.type)return i.type;
var c=g.SELECTION_NONE;try{var j=this.getNative(),b=j.type;if(b=="Text")c=g.SELECTION_TEXT;if(b=="Control")c=g.SELECTION_ELEMENT;if(j.createRange().parentElement)c=g.SELECTION_TEXT}catch(e){}return i.type=c}:function(){var i=this._.cache;if(i.type)return i.type;var c=g.SELECTION_TEXT,j=this.getNative();if(j){if(j.rangeCount==1){j=j.getRangeAt(0);var b=j.startContainer;if(b==j.endContainer&&b.nodeType==z.NODE_ELEMENT&&j.endOffset-j.startOffset===1&&p[b.childNodes[j.startOffset].nodeName.toLowerCase()])c=
g.SELECTION_ELEMENT}}else c=g.SELECTION_NONE;return i.type=c},getRanges:A.ie?function(){var i=function(c,j){c=c.duplicate();c.collapse(j);j=c.parentElement();for(var b=j.childNodes,e,o=0;o<b.length;o++){var y=b[o];if(y.nodeType==z.NODE_ELEMENT){e=c.duplicate();e.moveToElementText(y);y=e.compareEndPoints("StartToStart",c);var r=e.compareEndPoints("EndToStart",c);e.collapse();if(y>0)break;else if(!y||r==1&&y==-1)return{container:j,offset:o};else if(!r)return{container:j,offset:o+1};e=null}}if(!e){e=
c.duplicate();e.moveToElementText(j);e.collapse(false)}e.setEndPoint("StartToStart",c);c=e.text.replace(/(\r\n|\r)/g,"\n").length;try{for(;c>0;)c-=b[--o].nodeValue.length}catch(D){c=0}return c===0?{container:j,offset:o}:{container:b[o],offset:-c}};return function(){var c=this._.cache;if(c.ranges)return c.ranges;var j=this.getNative(),b=j&&j.createRange(),e=this.getType();if(!j)return[];if(e==g.SELECTION_TEXT){j=new l(this.document);e=i(b,true);j.setStart(new f(e.container),e.offset);e=i(b);j.setEnd(new f(e.container),
e.offset);return c.ranges=[j]}else if(e==g.SELECTION_ELEMENT){c=this._.cache.ranges=[];for(e=0;e<b.length;e++){var o=b.item(e),y=o.parentNode,r=0;for(j=new l(this.document);r<y.childNodes.length&&y.childNodes[r]!=o;r++);j.setStart(new f(y),r);j.setEnd(new f(y),r+1);c.push(j)}return c}return c.ranges=[]}}():function(){var i=this._.cache;if(i.ranges)return i.ranges;var c=[],j=this.getNative();if(!j)return[];for(var b=0;b<j.rangeCount;b++){var e=j.getRangeAt(b),o=new l(this.document);o.setStart(new f(e.startContainer),
e.startOffset);o.setEnd(new f(e.endContainer),e.endOffset);c.push(o)}return i.ranges=c},getStartElement:function(){var i=this._.cache;if(i.startElement!==undefined)return i.startElement;var c,j=this.getNative();switch(this.getType()){case g.SELECTION_ELEMENT:return this.getSelectedElement();case g.SELECTION_TEXT:var b=this.getRanges()[0];if(b)if(!b.collapsed){for(b.optimize();;){c=b.startContainer;if(b.startOffset==(c[0].nodeType===z.NODE_ELEMENT?c[0].childNodes.length:c[0].nodeValue.length)&&!c._4e_isBlockBoundary())b.setStartAfter(c);
else break}c=b.startContainer;if(c[0].nodeType!=z.NODE_ELEMENT)return c.parent();c=new f(c[0].childNodes[b.startOffset]);if(!c[0]||c[0].nodeType!=z.NODE_ELEMENT)return b.startContainer;for(b=c[0].firstChild;b&&b.nodeType==z.NODE_ELEMENT;){c=new f(b);b=b.firstChild}return c}if(A.ie){b=j.createRange();b.collapse(true);c=b.parentElement()}else if((c=j.anchorNode)&&c.nodeType!=z.NODE_ELEMENT)c=c.parentNode}return i.startElement=c?new f(c):null},getSelectedElement:function(){var i=this._.cache;if(i.selectedElement!==
undefined)return i.selectedElement;var c=this,j=k(function(){return c.getNative().createRange().item(0)},function(){for(var b=c.getRanges()[0],e,o,y=2;y&&!((e=b.getEnclosedNode())&&e[0].nodeType==z.NODE_ELEMENT&&p[e._4e_name()]&&(o=e));y--)b.shrink(m.SHRINK_ELEMENT);return o[0]});return i.selectedElement=j?new f(j):null},reset:function(){this._.cache={}},selectElement:function(i){var c;if(A.ie)try{c=this.document.body.createControlRange();c.addElement(i[0]);c.select()}catch(j){c=this.document.body.createTextRange();
c.moveToElementText(i[0]);c.select()}finally{}else{c=this.document.createRange();c.selectNode(i[0]);i=this.getNative();i.removeAllRanges();i.addRange(c)}this.reset()},selectRanges:function(i){if(A.ie)i[0]&&i[0].select();else{var c=this.getNative();if(!c)return;c.removeAllRanges();for(var j=0;j<i.length;j++){var b=i[j],e=this.document.createRange(),o=b.startContainer;b.collapsed&&A.gecko&&A.gecko<1.09&&o[0].nodeType==z.NODE_ELEMENT&&!o[0].childNodes.length&&o[0].appendChild(this.document.createTextNode(""));
e.setStart(o[0],b.startOffset);e.setEnd(b.endContainer[0],b.endOffset);c.addRange(e)}}this.reset()},createBookmarks2:function(i){for(var c=[],j=this.getRanges(),b=0;b<j.length;b++)c.push(j[b].createBookmark2(i));return c},createBookmarks:function(i){for(var c=[],j=this.getRanges(),b=j.length,e,o=0;o<b;o++){c.push(e=j[o].createBookmark(i,true));var y=(i=e.serializable)?t.one("#"+e.startNode):e.startNode;e=i?t.one("#"+e.endNode):e.endNode;for(var r=o+1;r<b;r++){var D=j[r],H=D.startContainer,x=D.endContainer;
n._4e_equals(H,y.parent())&&D.startOffset++;n._4e_equals(H,e.parent())&&D.startOffset++;n._4e_equals(x,y.parent())&&D.endOffset++;n._4e_equals(x,e.parent())&&D.endOffset++}}return c},selectBookmarks:function(i){for(var c=[],j=0;j<i.length;j++){var b=new l(this.document);b.moveToBookmark(i[j]);c.push(b)}this.selectRanges(c);return this},getCommonAncestor:function(){var i=this.getRanges();return i[0].startContainer._4e_commonAncestor(i[i.length-1].endContainer)},scrollIntoView:function(){this.getStartElement()._4e_scrollIntoView()}});
w.Selection=s;var a={table:1,tbody:1,tr:1},d=v.whitespaces(true),h=/\ufeff|\u00a0/;l.prototype.select=A.ie?function(i){var c=this.collapsed,j,b;if(this.startContainer[0]===this.endContainer[0]&&this.endOffset-this.startOffset==1){var e=this.startContainer[0].childNodes[this.startOffset];if(e.nodeType==z.NODE_ELEMENT){(new s(this.document)).selectElement(new f(e));return}}if(this.startContainer[0].nodeType==z.NODE_ELEMENT&&this.startContainer._4e_name()in a||this.endContainer[0].nodeType==z.NODE_ELEMENT&&
this.endContainer._4e_name()in a)this.shrink(z.NODE_ELEMENT,true);var o=this.createBookmark();e=o.startNode;var y;if(!c)y=o.endNode;o=this.document.body.createTextRange();o.moveToElementText(e[0]);o.moveStart("character",1);if(y){i=this.document.body.createTextRange();i.moveToElementText(y[0]);o.setEndPoint("EndToEnd",i);o.moveEnd("character",-1)}else{for(j=e[0].nextSibling;j&&!d(j);)j=j.nextSibling;j=!(j&&j.nodeValue&&j.nodeValue.match(h))&&(i||!e[0].previousSibling||e[0].previousSibling&&n._4e_name(e[0].previousSibling)==
"br");b=this.document.createElement("span");b.innerHTML="&#65279;";b=new f(b);n.insertBefore(b[0],e[0]);j&&n.insertBefore(this.document.createTextNode("\ufeff"),e[0])}this.setStartBefore(e);e._4e_remove();if(c){if(j){o.moveStart("character",-1);o.select();this.document.selection.clear()}else o.select();if(b){this.moveToPosition(b,m.POSITION_BEFORE_START);b._4e_remove()}}else{this.setEndBefore(y);y._4e_remove();o.select()}}:function(){var i=this.startContainer;this.collapsed&&i[0].nodeType==z.NODE_ELEMENT&&
!i[0].childNodes.length&&i[0].appendChild(this.document.createTextNode(""));var c=this.document.createRange();c.setStart(i[0],this.startOffset);try{c.setEnd(this.endContainer[0],this.endOffset)}catch(j){if(j.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=0){this.collapse(true);c.setEnd(this.endContainer[0],this.endOffset)}else throw j;}i=B(this.document).getNative();i.removeAllRanges();i.addRange(c)};w.on("instanceCreated",function(i){q(i.editor)})});
KISSY.Editor.add("styles",function(w){function s(E,F){for(var G in E)E[G]=E[G].replace(aa,function(L,K){return F[K]})}function B(E,F){if(F){E=y.clone(E);s(E.attributes,F);s(E.styles,F)}F=this.element=(E.element||"*").toLowerCase();this.type=F=="#"||R[F]?D.STYLE_BLOCK:W[F]?D.STYLE_OBJECT:D.STYLE_INLINE;this._={definition:E}}function q(E,F){F=F?this.removeFromRange:this.applyToRange;E.body.focus();E=new x(E);for(var G=E.getRanges(),L=0;L<G.length;L++)F.call(this,G[L]);E.selectRanges(G)}function t(E,
F){var G=E.element;if(G=="*")G="span";F=new N(F.createElement(G));return A(F,E)}function A(E,F){var G=F._.definition;F=G.attributes;G=B.getStyleText(G);if(F)for(var L in F)E.attr(L,F[L]);if(G)E[0].style.cssText=G;return E}function n(E){var F=E.createBookmark(true),G=E.createIterator();G.enforceRealBlocks=true;G.enlargeBr=true;for(var L,K=E.document;L=G.getNextParagraph();){var O=t(this,K);g(L,O)}E.moveToBookmark(F)}function u(E,F,G){var L="",K="";E=E.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,
function(O,P,S){P&&(L=P);S&&(K=S);return""});return L+E.replace(F,G)+K}function k(E,F){var G=E.html();G=u(G,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,"");G=G.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1");G=G.replace(/([ \t\n\r]+|&nbsp;)/g," ");G=G.replace(/<br\b[^>]*>/gi,"\n");if(M.ie){E=E[0].ownerDocument.createElement("div");E.appendChild(F[0]);F[0].outerHTML="<pre>"+G+"</pre>";F=new N(E.firstChild);F._4e_remove()}else F.html(G);return F}function f(E){var F=[];u(E._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,
function(G,L,K){return L+"</pre>"+K+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(G,L){F.push(L)});return F}function g(E,F){var G=F._4e_name=="pre",L=E._4e_name=="pre",K=!G&&L;if(G&&!L)F=k(E,F);else if(K)F=z(f(E),F);else E._4e_moveChildren(F);E[0].parentNode.replaceChild(F[0],E[0]);G&&m(F)}function m(E){var F;if((F=E._4e_previousSourceNode(true,C.NODE_ELEMENT))&&F._4e_name()=="pre"){var G=u(F.html(),/\n$/,"")+"\n\n"+u(E.html(),/^\n/,"");if(M.ie)E[0].outerHTML="<pre>"+G+"</pre>";else E.html(G);
F._4e_remove()}}function z(E,F){for(var G=F[0].ownerDocument.createDocumentFragment(),L=0;L<E.length;L++){var K=E[L];K=K.replace(/(\r\n|\r)/g,"\n");K=u(K,/^[ \t]*\n/,"");K=u(K,/\n$/,"");K=u(K,/^[ \t]+|[ \t]+$/g,function(P,S){return P.length==1?"&nbsp;":S?" "+(new Array(P.length)).join("&nbsp;"):(new Array(P.length)).join("&nbsp;")+" "});K=K.replace(/\n/g,"<br>");K=K.replace(/[ \t]{2,}/g,function(P){return(new Array(P.length)).join("&nbsp;")+" "});var O=F._4e_clone();O.html(K);G.appendChild(O[0])}return G}
function v(E){var F=E.document;if(E.collapsed){F=t(this,F);E.insertNode(F);E.moveToPosition(F,H.POSITION_BEFORE_END)}else{var G=this.element,L=this._.definition,K,O=w.XHTML_DTD[G]||(K=true,w.XHTML_DTD.span),P=E.createBookmark();E.enlarge(H.ENLARGE_ELEMENT);E.trim();var S=E.createBookmark(),da=S.startNode;S=S.endNode;for(var U=da,X;U&&U[0];){var T=false;if(r._4e_equals(U,S)){U=null;T=true}else{var V=U[0].nodeType,ba=V==C.NODE_ELEMENT?U._4e_name():null;if(ba&&U.attr("_ke_bookmark")){U=U._4e_nextSourceNode(true);
continue}if(!ba||O[ba]&&(U._4e_position(S)|I.POSITION_PRECEDING|I.POSITION_IDENTICAL|I.POSITION_IS_CONTAINED)==I.POSITION_PRECEDING+I.POSITION_IDENTICAL+I.POSITION_IS_CONTAINED&&(!L.childRule||L.childRule(U))){var ca=U.parent();if(ca&&ca[0]&&((w.XHTML_DTD[ca._4e_name()]||w.XHTML_DTD.span)[G]||K)&&(!L.parentRule||L.parentRule(ca))){if(!X&&(!ba||!w.XHTML_DTD.$removeEmpty[ba]||(U._4e_position(S)|I.POSITION_PRECEDING|I.POSITION_IDENTICAL|I.POSITION_IS_CONTAINED)==I.POSITION_PRECEDING+I.POSITION_IDENTICAL+
I.POSITION_IS_CONTAINED)){X=new J(F);X.setStartBefore(U)}if(V==C.NODE_TEXT||V==C.NODE_ELEMENT&&!U[0].childNodes.length){V=U;for(var Y;!V[0].nextSibling&&(Y=V.parent(),O[Y._4e_name()])&&(Y._4e_position(da)|I.POSITION_FOLLOWING|I.POSITION_IDENTICAL|I.POSITION_IS_CONTAINED)==I.POSITION_FOLLOWING+I.POSITION_IDENTICAL+I.POSITION_IS_CONTAINED&&(!L.childRule||L.childRule(Y));)V=Y;X.setEndAfter(V);V[0].nextSibling||(T=true)}}else T=true}else T=true;U=U._4e_nextSourceNode()}if(T&&X&&!X.collapsed){T=t(this,
F);for(V=X.getCommonAncestor();T&&V&&T[0]&&V[0];){if(V._4e_name()==G){for(var Z in L.attributes)T.attr(Z)==V.attr(Z)&&T[0].removeAttribute(Z);for(var ea in L.styles)T._4e_style(ea)==V._4e_style(ea)&&T._4e_style(ea,"");if(!T._4e_hasAttributes()){T=null;break}}V=V.parent()}if(T){T[0].appendChild(X.extractContents());b(this,T);X.insertNode(T);T._4e_mergeSiblings();M.ie||T[0].normalize()}X=null}}da._4e_remove();S._4e_remove();E.moveToBookmark(P);E.shrink(H.SHRINK_TEXT)}}function l(E){E.enlarge(H.ENLARGE_ELEMENT);
var F=E.createBookmark(),G=F.startNode;if(E.collapsed){for(var L=new Q(G.parent()),K,O=0,P;O<L.elements.length&&(P=L.elements[O]);O++){if(P==L.block||P==L.blockLimit)break;if(this.checkElementRemovable(P)){var S=E.checkBoundaryOfElement(P,H.END),da=!S&&E.checkBoundaryOfElement(P,H.START);if(da||S){K=P;K.match=da?"start":"end"}else{P._4e_mergeSiblings();P._4e_name()==this.element?c(this,P):e(P,i(this)[P._4e_name()])}}}if(K&&K[0]){P=G;for(O=0;;O++){S=L.elements[O];if(r._4e_equals(S,K))break;else if(S.match)continue;
else S=S._4e_clone();S[0].appendChild(P[0]);P=S}r[K.match=="start"?"insertBefore":"insertAfter"](P[0],K[0])}}else{var U=F.endNode,X=this;L=function(){for(var T=new Q(G.parent()),V=new Q(U.parent()),ba=null,ca=null,Y=0;Y<T.elements.length;Y++){var Z=T.elements[Y];if(Z==T.block||Z==T.blockLimit)break;if(X.checkElementRemovable(Z))ba=Z}for(Y=0;Y<V.elements.length;Y++){Z=V.elements[Y];if(Z==V.block||Z==V.blockLimit)break;if(X.checkElementRemovable(Z))ca=Z}ca&&U._4e_breakParent(ca);ba&&G._4e_breakParent(ba)};
L();for(K=new N(G[0].nextSibling);K[0]!==U[0];){O=K._4e_nextSourceNode();if(K[0]&&K[0].nodeType==C.NODE_ELEMENT&&this.checkElementRemovable(K)){K._4e_name()==this.element?c(this,K):e(K,i(this)[K._4e_name()]);if(O[0].nodeType==C.NODE_ELEMENT&&O._4e_contains(G)){L();O=new N(G[0].nextSibling)}}K=O}}E.moveToBookmark(F)}function p(E){var F={};E.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(G,L,K){F[L]=K});return F}function a(E,F){typeof E=="string"&&(E=p(E));typeof F==
"string"&&(F=p(F));for(var G in E)if(!(G in F&&(F[G]==E[G]||E[G]=="inherit"||F[G]=="inherit")))return false;return true}function d(E,F){if(F!==false){F=document.createElement("span");F.style.cssText=E;E=F.style.cssText||""}else E=E;return E.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function h(E){var F=E._AC;if(F)return F;F={};var G=0,L=E.attributes;if(L)for(var K in L){G++;F[K]=L[K]}if(L=B.getStyleText(E)){F.style||G++;F.style=L}F._length=G;return E._AC=
F}function i(E){if(E._.overrides)return E._.overrides;var F=E._.overrides={},G=E._.definition.overrides;if(G){y.isArray(G)||(G=[G]);for(var L=0;L<G.length;L++){var K=G[L],O,P;if(typeof K=="string")O=K.toLowerCase();else{O=K.element?K.element.toLowerCase():E.element;P=K.attributes}K=F[O]||(F[O]={});if(P){K=K.attributes=K.attributes||[];for(var S in P)K.push([S.toLowerCase(),P[S]])}}}return F}function c(E,F){var G=E._.definition,L=y.mix(y.mix({},G.attributes),i(E)[F._4e_name()]);G=G.styles;var K=y.isEmptyObject(L)&&
y.isEmptyObject(G);for(var O in L)if(!((O=="class"||E._.definition.fullMatch)&&F.attr(O)!=j(O,L[O]))){K=K||!!F._4e_hasAttribute(O);F.removeAttr(O)}for(var P in G)if(!(E._.definition.fullMatch&&F._4e_style(P)!=j(P,G[P],true))){K=K||!!F._4e_style(P);F._4e_style(P,"")}K&&o(F)}function j(E,F,G){var L=new N("<span></span>");L[G?"_4e_style":"attr"](E,F);return L[G?"_4e_style":"attr"](E)}function b(E,F){for(var G=i(E),L=F.all(E.element),K=L.length;--K>=0;)c(E,new N(L[K]));for(var O in G)if(O!=E.element){L=
F.all(O);for(K=L.length-1;K>=0;K--){var P=new N(L[K]);e(P,G[O])}}}function e(E,F){if(F=F&&F.attributes)for(var G=0;G<F.length;G++){var L=F[G][0],K;if(K=E.attr(L)){var O=F[G][1];if(O===null||O.test&&O.test(K)||typeof O=="string"&&K==O)E[0].removeAttribute(L)}}o(E)}function o(E){if(!E._4e_hasAttributes()){var F=E[0].firstChild,G=E[0].lastChild;E._4e_remove(true);if(F){F.nodeType==C.NODE_ELEMENT&&r._4e_mergeSiblings(F);G&&!F===G&&G.nodeType==C.NODE_ELEMENT&&r._4e_mergeSiblings(G)}}}var y=KISSY,r=y.DOM,
D=w.STYLE={},H=w.RANGE,x=w.Selection,C=w.NODE,I=w.POSITION,J=w.Range,N=y.Node,M=y.UA,Q=w.ElementPath,R={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},W={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},$=/\s*(?:;\s*|$)/,aa=/#\((.+?)\)/g;D.STYLE_BLOCK=1;D.STYLE_INLINE=2;D.STYLE_OBJECT=3;B.prototype={apply:function(E){q.call(this,E,false)},remove:function(E){q.call(this,E,true)},applyToRange:function(E){return(this.applyToRange=this.type==D.STYLE_INLINE?
v:this.type==D.STYLE_BLOCK?n:this.type==D.STYLE_OBJECT?null:null).call(this,E)},removeFromRange:function(E){return(this.removeFromRange=this.type==D.STYLE_INLINE?l:null).call(this,E)},applyToObject:function(E){A(E,this)},checkElementRemovable:function(E,F){if(!E)return false;var G=this._.definition;if(E._4e_name()==this.element){if(!F&&!E._4e_hasAttributes())return true;G=h(G);if(G._length){for(var L in G)if(L!="_length"){var K=E.attr(L)||"";if(L=="style"?a(G[L],d(K,false)):G[L]==K){if(!F)return true}else if(F)return false}if(F)return true}else return true}if(G=
i(this)[E._4e_name()]){if(!(G=G.attributes))return true;for(F=0;F<G.length;F++){L=G[F][0];if(L=E.attr(L)){K=G[F][1];if(K===null||typeof K=="string"&&L==K||K.test&&K.test(L))return true}}}return false},checkActive:function(E){switch(this.type){case D.STYLE_BLOCK:return this.checkElementRemovable(E.block||E.blockLimit,true);case D.STYLE_OBJECT:case D.STYLE_INLINE:for(var F=E.elements,G=0,L;G<F.length;G++){L=F[G];if(!(this.type==D.STYLE_INLINE&&(r._4e_equals(L,E.block)||r._4e_equals(L,E.blockLimit))))if(!(this.type==
D.STYLE_OBJECT&&!(L._4e_name()in W)))if(this.checkElementRemovable(L,true))return true}}return false}};B.getStyleText=function(E){var F=E._ST;if(F)return F;F=E.styles;var G=E.attributes&&E.attributes.style||"",L="";if(G.length)G=G.replace($,";");for(var K in F){var O=F[K],P=(K+":"+O).replace($,";");if(O=="inherit")L+=P;else G+=P}if(G.length)G=d(G);G+=L;return E._ST=G};w.Style=B});
KISSY.Editor.add("button",function(){function w(t){w.superclass.constructor.call(this,t);this._init()}var s=KISSY.Editor,B=KISSY,q=B.Node;w.ON="on";w.OFF="off";w.DISABLED="disabled";w.ON_CLASS="ke-triplebutton-on";w.OFF_CLASS="ke-triplebutton-off";w.DISABLED_CLASS="ke-triplebutton-disabled";w.ATTRS={state:{value:"off"},container:{},text:{},contentCls:{},cls:{}};B.extend(w,B.Base,{_init:function(){var t=this.get("container")[0]||this.get("container");this.el=new q("<a class='ke-triplebutton ke-triplebutton-off' href='#' role=\"button\"></a>");
this.el._4e_unselectable();this._attachCls();if(this.get("text"))this.el.html(this.get("text"));else if(this.get("contentCls")){this.el.html("<span class='ke-toolbar-item "+this.get("contentCls")+"'></span>");this.el.one("span")._4e_unselectable()}this.get("title")&&this.el.attr("title",this.get("title"));t.appendChild(this.el[0]);this.el.on("click",this._action,this);this.on("afterStateChange",this._stateChange,this)},_attachCls:function(){var t=this.get("cls");t&&this.el.addClass(t)},_stateChange:function(t){this["_"+
t.newVal]();this._attachCls()},_action:function(t){this.fire(this.get("state")+"Click",t);this.fire("click",t);t.preventDefault()},_on:function(){this.el[0].className="ke-triplebutton ke-triplebutton-on"},_off:function(){this.el[0].className="ke-triplebutton ke-triplebutton-off"},_disabled:function(){this.el[0].className="ke-triplebutton ke-triplebutton-disabled"}});s.TripleButton=w});
KISSY.Editor.add("contextmenu",function(){function w(f){this.cfg=q.clone(f);B.Utils.lazyRun(this,"_prepareShow","_realShow")}function s(f,g){for(var m=0;m<g.length;m++)if(A.test(f,g[m]))return true;return false}var B=KISSY.Editor,q=KISSY,t=q.Node,A=q.DOM,n=q.Event,u=[];w.register=function(f,g){var m=new w(g);u.push({doc:f,rules:g.rules,instance:m});if(!f.ke_contextmenu){f.ke_contextmenu=1;n.on(f,"mousedown",w.hide);n.on(f,"contextmenu",function(z){w.hide.call(this);for(var v=new t(z.target);v;){var l=
false;if(v._4e_name()=="body")break;for(var p=0;p<u.length;p++){var a=u[p].instance,d=u[p].rules;if(f===u[p].doc&&s(v[0],d)){z.preventDefault();l=true;setTimeout(function(){a.show(B.Utils.getXY(z.pageX,z.pageY,f,document))},30);break}}if(l)break;v=v.parent()}})}return m};w.hide=function(){for(var f=0;f<u.length;f++){var g=u[f].instance;this===u[f].doc&&g.hide()}};var k=B.SimpleOverlay;q.augment(w,{_init:function(){var f=this,g=f.cfg,m=g.funcs;f.elDom=new t("<div class='ke-menu' onmousedown='return false;'></div>");
var z=f.elDom;z.css("width",g.width);document.body.appendChild(z[0]);f.el=new k({el:z});for(var v in m){g=new t("<a href='#'>"+v+"</a>");z[0].appendChild(g[0]);(function(l,p){l._4e_unselectable();l.on("click",function(a){f.hide();a.halt();setTimeout(p,30)})})(g,m[v])}},hide:function(){this.el&&this.el.hide()},_realShow:function(f){this.el.show(f)},_prepareShow:function(){this._init()},show:function(f){this._prepareShow(f)}});B.ContextMenu=w});
KISSY.Editor.add("overlay",function(){function w(){var g=this;w.superclass.constructor.apply(g,arguments);g._init();if(B.UA.ie===6){g.on("show",function(){var m=g.get("el"),z=parseInt(m.css("width"));m=m[0].offsetHeight;f&&f.css({width:z+"px",height:m+"px"});f&&f.offset(g.get("el").offset())});g.on("hide",function(){f&&f.offset({left:-999,top:-999})})}if(g.get("mask")){g.on("show",function(){u&&u.css({left:"0px",top:"0px"});k&&k.css({left:"0px",top:"0px"})});g.on("hide",function(){u&&u.css({left:"-9999px",
top:"-9999px"});k&&k.css({left:"-9999px",top:"-9999px"})})}g.hide()}var s=KISSY.Editor,B=KISSY,q=B.UA,t=s.focusManager,A=B.Node,n=B.DOM,u,k,f;w.init=function(){var g=document.body;u=new A('<div class="ke-mask">&nbsp;</div>');u.css({left:"-9999px",top:"-9999px"});u.css({width:"100%",height:n.docHeight()+"px",opacity:0.4});u.appendTo(g);if(B.UA.ie==6){f=new A("<iframe class='ke-dialog-iframe'></iframe>");g.appendChild(f[0]);k=new A("<iframe class='ke-mask'></iframe>");k.css({left:"-9999px",top:"-9999px"});
k.css({width:"100%",height:n.docHeight()+"px",opacity:0.4});k.appendTo(g)}w.init=null};w.ATTRS={title:{value:""},width:{value:"450px"},visible:{value:false},focusMgr:{value:true},mask:{value:false}};B.extend(w,B.Base,{_init:function(){var g=this,m=g.get("el");g.on("afterVisibleChange",function(z){if(z=z.newVal){typeof z=="boolean"?g.center():m.offset(z);g.fire("show")}else{m.css({left:"-9999px",top:"-9999px"});g.fire("hide")}});if(m){m[0].appendChild((new A("<a href='#' class='ke-focus' style='width:0;height:0;margin:0;padding:0;overflow:hidden;outline:none;font-size:0;'></a>"))[0]);
g.el=m}else{m=new A("<div class='ke-dialog' style='width:"+g.get("width")+"'><div class='ke-hd'><span class='ke-hd-title'>"+g.get("title")+"</span><span class='ke-hd-x'><a class='ke-close' href='#'>X</a></span></div><div class='ke-bd'></div><div class='ke-ft'></div><a href='#' tabindex='-1' class='ke-focus'></a></div>");document.body.appendChild(m[0]);g.set("el",m);g.el=m;g.body=m.one(".ke-bd");g.foot=m.one(".ke-ft");g._close=m.one(".ke-close");g._title=m.one(".ke-hd-title").one("h1");g._close.on("click",
function(z){z.preventDefault();g.hide()})}if(g.get("focusMgr")){g.on("beforeVisibleChange",g._editorFocusMg,g);g._initFocusNotice()}m.css({left:"-9999px",top:"-9999px"})},center:function(){var g=this.get("el"),m=parseInt(g.css("width")),z=g[0].offsetHeight,v=n.viewportWidth(),l=n.viewportHeight();m=(v-m)/2+n.scrollLeft();z=(l-z)/2+n.scrollTop();if(z-n.scrollTop()>200)z-=150;g.css({left:m+"px",top:z+"px"})},_prepareShow:function(){w.init()},_getFocusEl:function(){if(this._focusEl)return this._focusEl;
return this._focusEl=this.el.one(".ke-focus")},_initFocusNotice:function(){var g=this,m=g._getFocusEl();m.on("focus",function(){g.fire("focus")});m.on("blur",function(){g.fire("blur")})},_editorFocusMg:function(g){var m=this._focusEditor;if(g.newVal){m=this._focusEditor=t.currentInstance();this._getFocusEl()[0].focus();var z=this.el.one("input");if(z)setTimeout(function(){try{z[0].focus();z[0].select()}catch(v){}},0);else if(q.ie&&m)if(g=m.document.selection.createRange())if(g.item&&g.item(0).ownerDocument==
m.document){m=document.body.createTextRange();m.moveToElementText(this.el._4e_first()[0]);m.collapse(true);m.select()}}else m&&m.focus()},_realShow:function(g){this.get("el");this.set("visible",g||true)},show:function(g){this._prepareShow(g)},hide:function(){this.get("el");this.set("visible",false)}});s.Utils.lazyRun(w.prototype,"_prepareShow","_realShow");s.SimpleOverlay=w});
KISSY.Editor.add("select",function(){function w(n){w.superclass.constructor.call(this,n);this._init()}var s=KISSY,B=s.Node,q=s.Event,t=s.DOM,A=s.Editor;w.ATTRS={container:{},doc:{},value:{},width:{},title:{},items:{}};s.extend(w,s.Base,{_init:function(){var n=this.get("container"),u=new B("<a href='#' class='ke-select'><span class='ke-select-text'></span><span class='ke-select-drop'></span></a>"),k=this.get("title"),f=u.one(".ke-select-text");u.one(".ke-select-drop");f.html(k);f.css("width",this.get("width"));
u._4e_unselectable();u.attr("title",k);u.appendTo(n);u.on("click",this._click,this);this.el=u;this.title=f;A.Utils.lazyRun(this,"_prepare","_real");this.on("afterValueChange",this._valueChange,this)},_valueChange:function(n){n=n.newVal;for(var u=this.get("title"),k=this.get("items"),f=0;f<k.length;f++){var g=k[f];if(g.value==n){u=g.name;break}}this.title.html(u)},_prepare:function(){var n=this.el,u=new B("<div class='ke-menu' onmousedown='return false;'></div>"),k=new A.SimpleOverlay({el:u,focusMgr:false}),
f=this.get("items");this.get("title")&&(new B("<div class='ke-menu-title ke-select-menu-item' style='margin-top:-6px;' >"+this.get("title")+"</div>")).appendTo(u);for(var g=0;g<f.length;g++){var m=f[g];m=new B("<a class='ke-select-menu-item' href='#' data-value='"+m.value+"'>"+m.name+"</a>",m.attrs);m._4e_unselectable();m.appendTo(u)}this.get("popUpWidth")&&u.css("width",this.get("popUpWidth"));u.appendTo(document.body);this.menu=k;k.on("show",function(){n.addClass("ke-select-active")});k.on("hide",
function(){n.removeClass("ke-select-active")});q.on([document,this.get("doc")],"click",function(v){n._4e_contains(v.target)||k.hide()});u.on("click",this._select,this);var z=this.as=u.all("a");q.on(u[0],"mouseenter",function(){z.removeClass("ke-menu-selected")})},_select:function(n){n.halt();var u=this.menu,k=u.el;if(n=(new B(n.target))._4e_ascendant(function(m){return k._4e_contains(m)&&m._4e_name()=="a"},true)){var f=this.get("value"),g=n.attr("data-value");this.set("value",g);this.fire("click",
{newVal:g,preVal:f,name:n.html()});u.hide()}},_real:function(){var n=this.el.offset();n.top+=this.el.height()+8;n.left+=1;if(n.left+this.menu.el.width()>t.viewportWidth()-60)n.left=t.viewportWidth()-this.menu.el.width()-60;this.menu.show(n)},_click:function(n){n.preventDefault();var u=this.get("value");this._prepare();u&&this.menu&&this.as.each(function(k){k.attr("data-value")==u?k.addClass("ke-menu-selected"):k.removeClass("ke-menu-selected")})}});A.Select=w});
KISSY.Editor.add("clipboard",function(w){var s=KISSY.Editor,B=KISSY,q=B.Node,t=B.UA,A=s.Range,n=s.RANGE,u=B.Event;s.Paste||function(){function k(f){this.editor=f;this._init()}B.augment(k,{_init:function(){var f=this.editor;t.ie?u.on(f.document,"keydown",this._paste,this):u.on(f.document,"paste",this._paste,this)},_paste:function(f){if(!(f.type==="keydown"&&!(f.keyCode===86&&(f.ctrlKey||f.metaKey)))){var g=this.editor;f=g.document;var m=g.getSelection(),z=new A(f),v=new q(t.webkit?"<body></body>":
"<div></div>",null,f);t.webkit&&v[0].appendChild(f.createTextNode("\u00a0"));f.body.appendChild(v[0]);v.css({position:"absolute",top:m.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});v.css("left","-1000px");var l=m.createBookmarks();z.setStartAt(v,n.POSITION_AFTER_START);z.setEndAt(v,n.POSITION_BEFORE_END);z.select(true);setTimeout(function(){v._4e_remove();var p;v=t.webkit&&(p=v._4e_first())&&p[0]&&p.hasClass("Apple-style-span")?p:v;m.selectBookmarks(l);g.insertHtml(v.html())},
0)}}});s.Paste=k}();w.addPlugin(function(){new s.Paste(w)})});
KISSY.Editor.add("color",function(w){function s(c){return("0"+c).slice(c.length-1,c.length+1)}function B(c){c=t.trim(c);if(c.charAt(0)=="#")c=c.substring(1);c=c.replace(/\s+/g,"");var j="";if(/^[0-9a-f]{3,3}$/i.test(c))j=c.replace(/[0-9a-f]/ig,function(e){return e+e});else{var b=c.match(g);if(b&&b[0])for(c=1;c<4;c++)j+=s(parseInt(b[c]).toString(16));else j=c}return"#"+j.toLowerCase()}for(var q=KISSY.Editor,t=KISSY,A=t.Node,n=t.Event,u=q.SimpleOverlay,k=q.Style,f=t.DOM,g=/^rgb\((\d+),(\d+),(\d+)\)$/i,
m="000,800000,8B4513,2F4F4F,008080,000080,4B0082,696969,B22222,A52A2A,DAA520,006400,40E0D0,0000CD,800080,808080,F00,FF8C00,FFD700,008000,0FF,00F,EE82EE,A9A9A9,FFA07A,FFA500,FFFF00,00FF00,AFEEEE,ADD8E6,DDA0DD,D3D3D3,FFF0F5,FAEBD7,FFFFE0,F0FFF0,F0FFFF,F0F8FF,E6E6FA,FFF".split(/,/),z={element:"span",styles:{color:"#(color)"},overrides:[{element:"font",attributes:{color:null}}]},v={element:"span",styles:{"background-color":"#(color)"}},l="<div class='ke-popup-wrap ke-color-wrap'><a class='ke-color-remove' href=\"javascript:void('\u6e05\u9664');\"><span>\u6e05\u9664</span></a><table>",
p={},a={},d=0;d<5;d++){l+="<tr>";for(var h=0;h<8;h++){var i=B(m[8*d+h]);l+="<td>";l+="<a href='javascript:void(0);' class='ke-color-a'><span style='background-color:"+i+"'></span></a>";l+="</td>";p[i]=new k(v,{color:i});a[i]=new k(z,{color:i})}l+="</tr>"}p.inherit=new k(v,{color:"inherit"});a.inherit=new k(z,{color:"inherit"});l+="</table></div>";q.ColorSupport||function(){function c(b){c.superclass.constructor.call(this,b);this._init()}var j=q.TripleButton;c.ATTRS={editor:{},styles:{},contentCls:{},
text:{}};t.extend(c,t.Base,{_init:function(){var b=this.get("editor").toolBarDiv;b=new j({container:b,title:this.get("title"),contentCls:this.get("contentCls")});b.on("offClick",this._showColors,this);this.el=b;q.Utils.lazyRun(this,"_prepare","_real")},_hidePanel:function(b){var e=this;f._4e_ascendant(b.target,function(o){return o[0]===e.el.el[0]},true)||this.colorWin.hide()},_selectColor:function(b){b.halt();var e=this.get("editor");b=b.target;if(f._4e_name(b)=="span"||f._4e_name(b)=="a"){b=new A(b);
if(b._4e_name()=="a")b=b.one("span");var o=this.get("styles");e.fire("save");b._4e_style("background-color")?o[B(b._4e_style("background-color"))].apply(e.document):o.inherit.remove(e.document);e.fire("save");this.colorWin.hide()}},_prepare:function(){this.colorPanel=new A(l);this.colorWin=new u({el:this.colorPanel,mask:false,focusMgr:false});document.body.appendChild(this.colorPanel[0]);this.colorPanel.on("click",this._selectColor,this);n.on(document,"click",this._hidePanel,this);n.on(w.document,
"click",this._hidePanel,this)},_real:function(){var b=this.el.el.offset();b.top+=this.el.el.height()+5;if(b.left+this.colorPanel.width()>f.viewportWidth()-60)b.left=f.viewportWidth()-this.colorPanel.width()-60;this.colorWin.show(b)},_showColors:function(b){this._prepare(b)}});q.ColorSupport=c}();w.addPlugin(function(){new q.ColorSupport({editor:w,styles:p,title:"\u80cc\u666f\u989c\u8272",contentCls:"ke-toolbar-bgcolor",text:"bgcolor"});new q.ColorSupport({editor:w,styles:a,title:"\u6587\u672c\u989c\u8272",
contentCls:"ke-toolbar-color",text:"color"})})});
KISSY.Editor.add("elementpaths",function(w){var s=KISSY.Editor,B=KISSY,q=B.Node,t=B.DOM;s.ElementPaths||function(){function A(n){this.cfg=n;this._cache=[];this._init()}B.augment(A,{_init:function(){var n=this.cfg.editor;this.holder=new q("<div>");this.holder.appendTo(n.statusDiv);n.on("selectionChange",this._selectionChange,this)},_selectionChange:function(n){var u=this.cfg.editor,k=this.holder;k=k[0]||k;n=n.path.elements;var f,g;f=this._cache;for(g=0;g<f.length;g++){f[g].detach("click");f[g]._4e_remove()}this._cache=
[];for(g=0;g<n.length;g++){f=n[g];var m=new q("<a href='#' class='elementpath'>"+(f.attr("_ke_real_element_type")||f._4e_name())+"</a>");this._cache.push(m);(function(z){m.on("click",function(v){v.halt();u.focus();setTimeout(function(){u.getSelection().selectElement(z)},50)})})(f);k.firstChild?t.insertBefore(m[0],k.firstChild):k.appendChild(m[0])}}});s.ElementPaths=A}();w.addPlugin(function(){new s.ElementPaths({editor:w})})});
KISSY.Editor.add("enterkey",function(w){var s=KISSY.Editor,B=KISSY,q=B.UA,t=/^h[1-6]$/,A=s.XHTML_DTD,n=B.Node,u=B.Event,k=s.Walker,f=s.ElementPath;s.enterBlock||function(){function g(v){v=v.getSelection().getRanges();for(var l=v.length-1;l>0;l--)v[l].deleteContents();return v[0]}function m(v){var l=g(v),p=l.document;if(l.checkStartOfBlock()&&l.checkEndOfBlock()){var a=(new f(l.startContainer)).block;if(a&&(a._4e_name()=="li"||a.parent()._4e_name()=="li")){v.execCommand("outdent");return}}var d=l.splitBlock("p");
if(d){v=d.previousBlock;a=d.nextBlock;var h=d.wasStartOfBlock,i=d.wasEndOfBlock,c;if(a){c=a.parent();if(c._4e_name()=="li"){a._4e_breakParent(c);a._4e_move(a._4e_next(),true)}}else if(v&&(c=v.parent())&&c._4e_name()=="li"){v._4e_breakParent(c);l.moveToElementEditablePosition(v._4e_next());v._4e_move(v._4e_previous())}if(!h&&!i){if(a._4e_name()=="li"&&(c=a._4e_first(k.invisible(true)))&&B.inArray(c._4e_name(),["ul","ol"]))(q.ie?new n(p.createTextNode("\u00a0")):new n(p.createElement("br"))).insertBefore(c);
a&&l.moveToElementEditablePosition(a)}else{var j;if(v){if(v._4e_name()=="li"||!t.test(v._4e_name()))j=v._4e_clone()}else if(a)j=a._4e_clone();j||(j=new n("p",null,p));if(c=d.elementPath){d=0;for(var b=c.elements.length;d<b;d++){var e=c.elements[d];if(e._4e_equals(c.block)||e._4e_equals(c.blockLimit))break;if(A.$removeEmpty[e._4e_name()]){e=e._4e_clone();j._4e_moveChildren(e);j.append(e)}}}q.ie||j._4e_appendBogus();l.insertNode(j);if(q.ie&&h&&(!i||!v[0].childNodes.length)){l.moveToElementEditablePosition(i?
v:j);l.select()}l.moveToElementEditablePosition(h&&!i?a:j)}if(!q.ie)if(a){p=new n(p.createElement("span"));p.html("&nbsp;");l.insertNode(p);p._4e_scrollIntoView();l.deleteContents()}else j._4e_scrollIntoView();l.select()}}function z(v){u.on(v.document,"keydown",function(l){if(l.keyCode===13)if(!l.shiftKey){v.execCommand("enterBlock");l.preventDefault()}})}z.enterBlock=m;s.EnterKey=z}();w.addPlugin(function(){w.addCommand("enterBlock",{exec:s.EnterKey.enterBlock});s.EnterKey(w)})});
KISSY.Editor.add("fakeobjects",function(w){var s=KISSY.Editor,B=KISSY,q=B.Node,t=s.NODE,A=s.HtmlParser,n=B.Editor,u=(w=w.htmlDataProcessor)&&w.htmlFilter,k={elements:{$:function(f){var g=f.attributes;if((g=(g=(g=g&&g._ke_realelement)&&new A.Fragment.FromHtml(decodeURIComponent(g)))&&g.children[0])&&f.attributes._ke_resizable){var m=f.attributes.style;if(m){var z=/(?:^|\s)width\s*:\s*(\d+)/i.exec(m);f=z&&z[1];m=(z=/(?:^|\s)height\s*:\s*(\d+)/i.exec(m))&&z[1];if(f)g.attributes.width=f;if(m)g.attributes.height=
m}}return g}}};u&&u.addRules(k);w&&B.mix(w,{createFakeParserElement:function(f,g,m,z){var v;v=new A.BasicWriter;f.writeHtml(v);v=v.getHtml();var l=f.attributes.style;if(f.attributes.width)l="width:"+f.attributes.width+"px;"+l;if(f.attributes.height)l="height:"+f.attributes.height+"px;"+l;f={"class":g,src:s.Config.base+"assets/spacer.gif",_ke_realelement:encodeURIComponent(v),_ke_real_node_type:f.type,style:l,align:f.attributes.align||""};if(m)f._ke_real_element_type=m;if(z)f._ke_resizable=z;return new A.Element("img",
f)}});B.augment(n,{createFakeElement:function(f,g,m,z,v){var l=f.attr("style")||"";if(f.attr("width"))l="width:"+f.attr("width")+"px;"+l;if(f.attr("height"))l="height:"+f.attr("height")+"px;"+l;f={"class":g,src:s.Config.base+"assets/spacer.gif",_ke_realelement:encodeURIComponent(v||f._4e_outerHtml()),_ke_real_node_type:f[0].nodeType,align:f.attr("align")||"",style:l};if(m)f._ke_real_element_type=m;if(z)f._ke_resizable=z;return new q("<img/>",f,this.document)},restoreRealElement:function(f){if(f.attr("_ke_real_node_type")!=
t.NODE_ELEMENT)return null;f=decodeURIComponent(f.attr("_ke_realelement"));var g=new q("<div>",null,this.document);g.html(f);return g._4e_first(function(m){return m[0].nodeType==t.NODE_ELEMENT})._4e_remove()}})});
KISSY.Editor.add("flash",function(w){function s(h){h=h.attributes;return h.type=="application/x-shockwave-flash"||z.test(h.src||"")}function B(h){return h.indexOf(l)!=-1}var q=KISSY.Editor,t=KISSY,A=t.DOM,n=t.Event,u=q.ContextMenu,k=t.Node,f=q.NODE,g=q.TripleButton,m=q.SimpleOverlay,z=/\.swf(?:$|\?)/i,v=w.htmlDataProcessor,l="niftyplayer.swf",p=q.Utils.getFlashUrl,a=v&&v.dataFilter,d=["img.ke_flash"];a&&a.addRules({elements:{object:function(h){var i=h.attributes,c="ke_flash",j="flash";if(!(i.classid&&
String(i.classid).toLowerCase())){for(i=0;i<h.children.length;i++)if(h.children[i].name=="embed"){if(!s(h.children[i]))return null;if(B(h.children[i].attributes.src)){c="ke_music";j="music"}return v.createFakeParserElement(h,c,j,true)}return null}for(i=0;i<h.children.length;i++){var b=h.children[i];if(b.name=="param"&&b.attributes.name=="movie")if(B(b.attributes.value)){c="ke_music";j="music";break}}return v.createFakeParserElement(h,c,j,true)},embed:function(h){if(!s(h))return null;var i="ke_flash",
c="flash";if(B(h.attributes.src)){i="ke_music";c="music"}return v.createFakeParserElement(h,i,c,true)}}},5);q.Flash||function(){function h(c){this.editor=c;c._toolbars=c._toolbars||{};c._toolbars.flash=this;this._init()}t.augment(h,{_init:function(){var c=this.editor,j={};this.el=new g({container:c.toolBarDiv,contentCls:"ke-toolbar-flash",title:"Flash"});this.el.on("click",this._showConfig,this);n.on(c.document,"dblclick",this._dbclick,this);for(var b in i)(function(e){j[e]=function(){c.fire("save");
i[e](c);c.fire("save")}})(b);u.register(c.document,{rules:d,width:"120px",funcs:j});q.Utils.lazyRun(this,"_prepareShow","_realShow");c.on("selectionChange",this._selectionChange,this)},_selectionChange:function(c){c=c.path;var j=c.elements;if(c&&j)if(c=c.lastElement)(c=c._4e_ascendant(function(b){return b._4e_name()==="img"&&!!b.hasClass("ke_flash")},true))?this._showTip(c):this._hideTip()},_showTip:function(c){this._prepareTip(c)},_hideTip:function(){h.tipwin&&h.tipwin.hide()},_prepareTip:function(){h.tip&&
h.tip()},_realTip:function(c){var j=this.editor,b=c._4e_getOffset(document);b.top+=c.height()+5;h.tipwin.show(b);this.selectedFlash=c;c=j.restoreRealElement(this.selectedFlash);h.tipwin.flash=this;h.tipurl.html(p(c));h.tipurl.attr("href",p(c))},_dbclick:function(c){var j=new k(c.target);if(j._4e_name()==="img"&&j.hasClass("ke_flash")){this.selectedFlash=j;this._showConfig();c.halt()}},_prepareShow:function(){var c=this;c.d=new m({title:"\u7f16\u8f91flash",width:"350px",mask:true});c.d.on("hide",function(){c.selectedFlash=
null});c.d.body.html("<div><p><label>\u5730\u5740\uff1a <input class='ke-flash-url' style='width:280px' /></label></p><p style='margin:5px 0'><label>\u5bbd\u5ea6\uff1a <input class='ke-flash-width' style='width:110px' /></label>&nbsp;&nbsp;<label>\u9ad8\u5ea6\uff1a<input class='ke-flash-height' style='width:110px' /></label></p>");c.d.foot.html("<button class='ke-flash-ok'>\u786e\u5b9a</button> <button class='ke-flash-cancel'>\u53d6\u6d88</button></div>");c._initD()},_realShow:function(){this.d.show()},
_showConfig:function(){var c=this.editor,j=this.selectedFlash;this._prepareShow();if(j){c=c.restoreRealElement(j);c.attr("width")&&this.dWidth.val(parseInt(c.attr("width")));c.attr("height")&&this.dHeight.val(parseInt(c.attr("height")));if(c._4e_name()=="object"){c=c[0].childNodes;for(j=0;j<c.length;j++)if(c[j].nodeType==f.NODE_ELEMENT)if((A.attr(c[j],"name")||"").toLowerCase()=="movie")this.dUrl.val(A.attr(c[j],"value"));else if(A._4e_name(c[j])=="embed")this.dUrl.val(A.attr(c[j],"src"));else A._4e_name(c[j])==
"object"&&this.dUrl.val(A.attr(c[j],"data"))}else c._4e_name()=="embed"&&this.dUrl.val(c.attr("src"))}else{this.dUrl.val("");this.dWidth.val("");this.dHeight.val("")}},_initD:function(){var c=this,j=c.d;c.dHeight=j.el.one(".ke-flash-height");c.dWidth=j.el.one(".ke-flash-width");c.dUrl=j.el.one(".ke-flash-url");var b=j.el.one(".ke-flash-ok");j=j.el.one(".ke-flash-cancel");b.on("click",c._gen,c);j.on("click",function(){c.d.hide()})},_gen:function(){var c=this.editor,j=this.dUrl.val();if(j){j="<object "+
(parseInt(this.dWidth.val())?" width='"+parseInt(this.dWidth.val())+"' ":" ")+(parseInt(this.dHeight.val())?" height='"+parseInt(this.dHeight.val())+"' ":" ")+' classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"  codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,0,0"><param name="quality" value="high" /><param name="movie" value="'+j+'" /><embed '+(parseInt(this.dWidth.val())?" width='"+parseInt(this.dWidth.val())+"' ":" ")+(parseInt(this.dHeight.val())?" height='"+
parseInt(this.dHeight.val())+"' ":" ")+'pluginspage="http://www.macromedia.com/go/getflashplayer" quality="high"  src="'+j+'"  type="application/x-shockwave-flash"/></object>';var b=new k(j,null,c.document);j=c.createFakeElement?c.createFakeElement(b,"ke_flash","flash",true,j):b;c.insertElement(j);this.selectedFlash&&c.getSelection().selectElement(j);this.d.hide()}}});q.Utils.lazyRun(h.prototype,"_prepareTip","_realTip");q.Flash=h;h.tip=function(){var c=this,j=new k('<div class="ke-bubbleview-bubble" onmousedown="return false;">Flash \u7f51\u5740\uff1a  <a class="ke-bubbleview-url" target="_blank" href="#"></a> -     <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -     <span class="ke-bubbleview-link ke-bubbleview-remove">\u5220\u9664</span></div>'),
b=j.one(".ke-bubbleview-change"),e=j.one(".ke-bubbleview-remove");j._4e_unselectable();c.tipwin=new m({el:j,focusMgr:false});document.body.appendChild(j[0]);c.tipurl=j.one(".ke-bubbleview-url");c.tipwin.on("hide",function(){var o=c.tipwin.flash;o&&!o.d.get("visible")&&(o.selectedFlash=null)});n.on(document,"click",function(){c.tipwin.hide()});b.on("click",function(o){c.tipwin.flash._showConfig();o.halt()});e.on("click",function(o){var y=c.tipwin.flash;y.selectedFlash._4e_remove();y.editor.notifySelectionChange();
y.selectedFlash=null;o.halt()});c.tip=null};var i={"\u7f16\u8f91Flash":function(c){var j=c.getSelection();if(j=(j=j&&j.getStartElement())&&j._4e_ascendant("img",true))if(j.hasClass("ke_flash")){c=c._toolbars.flash;c.selectedFlash=j;c._showConfig()}}}}();w.addPlugin(function(){new q.Flash(w);var h=A._4e_getWin(w.document);n.on(h,"scroll",function(){q.Flash.tipwin&&q.Flash.tipwin.hide()})})});
KISSY.Editor.add("font",function(w){var s=KISSY.Editor,B=KISSY,q=s.Style,t=s.TripleButton,A=w.cfg.pluginConfig["font-size"]||["8px","10px","12px","14px","18px","24px","36px","48px","60px","72px","84px","96px","108px"],n={},u=[],k={element:"span",styles:{"font-size":"#(size)"},overrides:[{element:"font",attributes:{size:null}}]},f=w.cfg.pluginConfig["font-family"]||["\u5b8b\u4f53","\u9ed1\u4f53","\u96b6\u4e66","\u6977\u4f53_GB2312","\u5fae\u8f6f\u96c5\u9ed1","Georgia","Times New Roman","Impact","Courier New",
"Arial","Verdana","Tahoma"],g={},m=[],z={element:"span",styles:{"font-family":"#(family)"},overrides:[{element:"font",attributes:{face:null}}]},v;w.cfg.pluginConfig["font-size"]=A;w.cfg.pluginConfig["font-family"]=f;for(v=0;v<A.length;v++){var l=A[v];n[l]=new q(k,{size:l});u.push({name:l,value:l})}for(v=0;v<f.length;v++){A=f[v];g[A]=new q(z,{family:A});m.push({name:A,value:A,attrs:{style:"font-family:"+A}})}s.Font||function(){function p(d){p.superclass.constructor.call(this,d);this._init()}function a(d){a.superclass.constructor.call(this,
d);this._init()}p.ATTRS={title:{},html:{},styles:{},editor:{}};B.extend(p,B.Base,{_init:function(){var d=this.get("editor"),h=d.toolBarDiv;this.get("html");this.el=new s.Select({container:h,doc:d.document,width:this.get("width"),popUpWidth:this.get("popUpWidth"),title:this.get("title"),items:this.get("html")});this.el.on("click",this._vChange,this);d.on("selectionChange",this._selectionChange,this)},_vChange:function(d){var h=this.get("editor"),i=d.newVal;d=d.preVal;var c=this.get("styles");h.focus();
h.fire("save");if(i==d){c[i].remove(h.document);this.el.set("value","")}else c[i].apply(h.document);h.fire("save")},_selectionChange:function(d){this.get("editor");d=d.path.elements;for(var h=this.get("styles"),i=0,c;i<d.length;i++){c=d[i];for(var j in h)if(h[j].checkElementRemovable(c,true)){this.el.set("value",j);return}}this.el.reset("value")}});a.ATTRS={editor:{},text:{},contentCls:{},title:{},style:{}};B.extend(a,B.Base,{_init:function(){var d=this.get("editor"),h=this.get("text");this.get("style");
var i=this.get("title");this.el=new t({text:h,title:i,contentCls:this.get("contentCls"),container:d.toolBarDiv});this.el.on("offClick",this._on,this);this.el.on("onClick",this._off,this);d.on("selectionChange",this._selectionChange,this)},_on:function(){var d=this.get("editor");this.get("text");var h=this.get("style");this.get("title");d.fire("save");h.apply(d.document);d.fire("save");d.notifySelectionChange();d.focus()},_off:function(){var d=this.get("editor");this.get("text");var h=this.get("style");
this.get("title");d.fire("save");h.remove(d.document);d.fire("save");d.notifySelectionChange();d.focus()},_selectionChange:function(d){this.get("editor");this.get("text");var h=this.get("style");this.get("title");h.checkActive(d.path)?this.el.set("state",t.ON):this.el.set("state",t.OFF)}});p.SingleFont=a;s.Font=p}();w.addPlugin(function(){new s.Font({editor:w,title:"\u5927\u5c0f",width:"30px",popUpWidth:"55px",styles:n,html:u});new s.Font({editor:w,title:"\u5b57\u4f53",width:"110px",popUpWidth:"130px",
styles:g,html:m});new s.Font.SingleFont({contentCls:"ke-toolbar-bold",title:"\u7c97\u4f53 ",editor:w,style:new q({element:"strong",overrides:[{element:"b"},{element:"span",attributes:{style:"font-weight: bold;"}}]})});new s.Font.SingleFont({contentCls:"ke-toolbar-italic",title:"\u659c\u4f53 ",editor:w,style:new q({element:"em",overrides:[{element:"i"},{element:"span",attributes:{style:"font-style: italic;"}}]})});new s.Font.SingleFont({contentCls:"ke-toolbar-underline",title:"\u4e0b\u5212\u7ebf ",
editor:w,style:new q({element:"u",overrides:[{element:"span",attributes:{style:"text-decoration: underline;"}}]})});new s.Font.SingleFont({contentCls:"ke-toolbar-strikeThrough",title:"\u5220\u9664\u7ebf ",editor:w,style:new q({element:"del",overrides:[{element:"span",attributes:{style:"text-decoration: line-through;"}},{element:"s"}]})})})});
KISSY.Editor.add("format",function(w){var s=KISSY.Editor,B=KISSY,q=[],t={"\u666e\u901a\u6587\u672c":"p","\u6807\u98981":"h1","\u6807\u98982":"h2","\u6807\u98983":"h3","\u6807\u98984":"h4","\u6807\u98985":"h5","\u6807\u98986":"h6"},A={p:"1em",h1:"2em",h2:"1.5em",h3:"1.17em",h4:"1em",h5:"0.83em",h6:"0.67em"},n={},u=s.Style;for(var k in t)if(t[k]){n[t[k]]=new u({element:t[k]});q.push({name:k,value:t[k],attrs:{style:"font-size:"+A[t[k]]}})}s.Format||function(){function f(g){f.superclass.constructor.call(this,
g);this._init()}f.ATTRS={editor:{}};B.extend(f,B.Base,{_init:function(){var g=this.get("editor");this.el=new s.Select({container:g.toolBarDiv,value:"",doc:g.document,width:this.get("width"),popUpWidth:this.get("popUpWidth"),title:this.get("title"),items:this.get("html")});this.el.on("click",this._vChange,this);g.on("selectionChange",this._selectionChange,this)},_vChange:function(g){var m=this.get("editor"),z=g.newVal;g=g.preVal;m.fire("save");if(z!=g)n[z].apply(m.document);else{n.p.apply(m.document);
this.el.set("value","p")}m.fire("save")},_selectionChange:function(g){this.get("editor");g=g.path;for(var m in n)if(n[m].checkActive(g)){this.el.set("value",m);return}this.el.reset("value")}});s.Format=f}();w.addPlugin(function(){new s.Format({editor:w,html:q,title:"\u6807\u9898",width:"100px",popUpWidth:"120px"})})});
KISSY.Editor.add("htmlparser-basicwriter",function(){function w(){this._={output:[]}}var s=KISSY.Editor,B=s.Utils;if(!s.HtmlParser.BasicWriter){KISSY.augment(w,{openTag:function(q){this._.output.push("<",q)},openTagClose:function(q,t){t?this._.output.push(" />"):this._.output.push(">")},attribute:function(q,t){if(typeof t=="string")t=B.htmlEncodeAttr(t);this._.output.push(" ",q,'="',t,'"')},closeTag:function(q){this._.output.push("</",q,">")},text:function(q){this._.output.push(q)},comment:function(q){this._.output.push("<!--",
q,"--\>")},write:function(q){this._.output.push(q)},reset:function(){this._.output=[];this._.indent=false},getHtml:function(q){var t=this._.output.join("");q&&this.reset();return t}});s.HtmlParser.BasicWriter=w}});
KISSY.Editor.add("htmlparser-comment",function(){function w(q){this.value=q;this._={isBlockLike:false}}var s=KISSY.Editor,B=s.NODE;if(!s.HtmlParser.Comment){s.HtmlParser.Comment=w;w.prototype={constructor:w,type:B.NODE_COMMENT,writeHtml:function(q,t){var A=this.value;if(t){if(!(A=t.onComment(A,this)))return;if(typeof A!="string"){A.parent=this.parent;A.writeHtml(q,t);return}}q.comment(A)}}}});
KISSY.Editor.add("htmlparser-element",function(){function w(t,A){this.name=t;this.attributes=A||(A={});this.children=[];var n=A._ke_real_element_type||t;A=s.XHTML_DTD;n=!!(A.$nonBodyContent[n]||A.$block[n]||A.$listItem[n]||A.$tableContent[n]||A.$nonEditable[n]||n=="br");var u=!!A.$empty[t];this.isEmpty=u;this.isUnknown=!A[t];this._={isBlockLike:n,hasInlineStarted:u||!n}}var s=KISSY.Editor;if(!s.HtmlParser.Element){var B=s.NODE,q=function(t,A){t=t[0];A=A[0];return t<A?-1:t>A?1:0};KISSY.augment(w,{type:B.NODE_ELEMENT,
add:s.HtmlParser.Fragment.prototype.add,clone:function(){return new w(this.name,this.attributes)},writeHtml:function(t,A){var n=this.attributes,u=this,k=u.name,f,g,m,z;u.filterChildren=function(){if(!z){var p=new s.HtmlParser.BasicWriter;s.HtmlParser.Fragment.prototype.writeChildrenHtml.call(u,p,A);u.children=(new s.HtmlParser.Fragment.FromHtml(p.getHtml())).children;z=1}};if(A){for(;;){if(!(k=A.onElementName(k)))return;u.name=k;if(!(u=A.onElement(u)))return;u.parent=this.parent;if(u.name==k)break;
if(u.type!=B.NODE_ELEMENT){u.writeHtml(t,A);return}k=u.name;if(!k){this.writeChildrenHtml.call(u,t,z?null:A);return}}n=u.attributes}t.openTag(k,n);for(var v=[],l=0;l<2;l++)for(f in n){g=f;m=n[f];if(l==1)v.push([f,m]);else if(A){for(;;)if(g=A.onAttributeName(f))if(g!=f){delete n[f];f=g}else break;else{delete n[f];break}if(g)if((m=A.onAttribute(u,g,m))===false)delete n[g];else n[g]=m}}t.sortAttributes&&v.sort(q);n=v.length;for(l=0;l<n;l++){f=v[l];t.attribute(f[0],f[1])}t.openTagClose(k,u.isEmpty);if(!u.isEmpty){this.writeChildrenHtml.call(u,
t,z?null:A);t.closeTag(k)}},writeChildrenHtml:function(){s.HtmlParser.Fragment.prototype.writeChildrenHtml.apply(this,arguments)}});s.HtmlParser.Element=w}});
KISSY.Editor.add("htmlparser-filter",function(){function w(k){this._={elementNames:[],attributeNames:[],elements:{$length:0},attributes:{$length:0}};k&&this.addRules(k,10)}function s(k,f){for(var g=0;k&&g<f.length;g++){var m=f[g];k=k.replace(m[0],m[1])}return k}function B(k,f,g){if(typeof f=="function")f=[f];var m,z;z=k.length;var v=f&&f.length;if(v){for(m=0;m<z&&k[m].pri<g;m++);for(z=v-1;z>=0;z--)if(v=f[z]){v.pri=g;k.splice(m,0,v)}}}function q(k,f,g){if(f)for(var m in f){var z=k[m];k[m]=t(z,f[m],
g);z||k.$length++}}function t(k,f,g){if(f){f.pri=g;if(k){if(k.splice)B(k,f,g);else{k=k.pri>g?[f,k]:[k,f];k.filter=A}return k}else return f.filter=f}}function A(k){for(var f=k.type||k instanceof n.HtmlParser.Fragment,g=0;g<this.length;g++){if(f)var m=k.type,z=k.name;var v=this[g].apply(window,arguments);if(v===false)return v;if(f){if(v&&(v.name!=z||v.type!=m))return v}else if(typeof v!="string")return v;v!=undefined&&(k=v)}return k}var n=KISSY.Editor,u=n.NODE;if(!n.HtmlParser.Filter){KISSY.augment(w,
{addRules:function(k,f){if(typeof f!="number")f=10;B(this._.elementNames,k.elementNames,f);B(this._.attributeNames,k.attributeNames,f);q(this._.elements,k.elements,f);q(this._.attributes,k.attributes,f);this._.text=t(this._.text,k.text,f)||this._.text;this._.comment=t(this._.comment,k.comment,f)||this._.comment;this._.root=t(this._.root,k.root,f)||this._.root},onElementName:function(k){return s(k,this._.elementNames)},onAttributeName:function(k){return s(k,this._.attributeNames)},onText:function(k){var f=
this._.text;return f?f.filter(k):k},onComment:function(k,f){var g=this._.comment;return g?g.filter(k,f):k},onFragment:function(k){var f=this._.root;return f?f.filter(k):k},onElement:function(k){for(var f=[this._.elements["^"],this._.elements[k.name],this._.elements.$],g,m=0;m<3;m++)if(g=f[m]){g=g.filter(k,this);if(g===false)return null;if(g&&g!=k)return this.onNode(g);if(k.parent&&!k.name)break}return k},onNode:function(k){var f=k.type;return f==u.NODE_ELEMENT?this.onElement(k):f==u.NODE_TEXT?new n.HtmlParser.Text(this.onText(k.value)):
null},onAttribute:function(k,f,g){if(f=this._.attributes[f]){k=f.filter(g,k,this);if(k===false)return false;if(typeof k!="undefined")return k}return g}});n.HtmlParser.Filter=w}});
KISSY.Editor.add("htmlparser-fragment",function(){function w(){this.children=[];this.parent=null;this._={isBlockLike:true,hasInlineStarted:false}}var s=KISSY.Editor;if(!s.HtmlParser.Fragment){var B={colgroup:1,dd:1,dt:1,li:1,option:1,p:1,td:1,tfoot:1,th:1,thead:1,tr:1},q=KISSY,t=s.Utils,A=s.NODE,n=s.XHTML_DTD,u=t.mix({table:1,ul:1,ol:1,dl:1},n.table,n.ul,n.ol,n.dl),k=n.$list,f=n.$listItem;w.FromHtml=function(g,m){function z(e){var o;if(d.length>0)for(var y=0;y<d.length;y++){var r=d[y],D=r.name,H=
n[D],x=i.name&&n[i.name];if((!x||x[D])&&(!e||!H||H[e]||!n[e])){if(!o){v();o=1}r=r.clone();r.parent=i;i=r;d.splice(y,1);y--}}}function v(){for(;h.length;)i.add(h.shift())}function l(e,o,y){o=o||i||a;if(m&&!o.type){var r,D;if((r=e.attributes&&(D=e.attributes._ke_real_element_type)?D:e.name)&&!(r in n.$body)&&!(r in n.$nonBodyContent)){r=i;i=o;p.onTagOpen(m,{});o=i;if(y)i=r}}if(e._.isBlockLike&&e.name!="pre"){y=e.children.length;if((r=e.children[y-1])&&r.type==A.NODE_TEXT)if(D=t.rtrim(r.value))r.value=
D;else e.children.length=y-1}o.add(e);if(e.returnPoint){i=e.returnPoint;delete e.returnPoint}}var p=new s.HtmlParser,a=new w,d=[],h=[],i=a,c=false,j;p.onTagOpen=function(e,o,y){var r=new s.HtmlParser.Element(e,o);if(r.isUnknown&&y)r.isEmpty=true;if(n.$removeEmpty[e])d.push(r);else{if(e=="pre")c=true;else if(e=="br"&&c){i.add(new s.HtmlParser.Text("\n"));return}if(e=="br")h.push(r);else{var D=i.name,H=D&&(n[D]||(i._.isBlockLike?n.div:n.span));if(H&&!r.isUnknown&&!i.isUnknown&&!H[e]){H=false;var x;
if(e in k&&D in k){D=i.children;(D=D[D.length-1])&&D.name in f||l(D=new s.HtmlParser.Element("li"),i);j=i;x=D}else if(e==D)l(i,i.parent);else{if(u[D])j||(j=i);else{l(i,i.parent,true);B[D]||d.unshift(i)}H=true}i=x?x:i.returnPoint||i.parent;if(H){p.onTagOpen.apply(this,arguments);return}}z(e);v();r.parent=i;r.returnPoint=j;j=0;if(r.isEmpty)l(r);else i=r}}};p.onTagClose=function(e){for(var o=d.length-1;o>=0;o--)if(e==d[o].name){d.splice(o,1);return}for(var y=[],r=[],D=i;D.type&&D.name!=e;){D._.isBlockLike||
r.unshift(D);y.push(D);D=D.parent}if(D.type){for(o=0;o<y.length;o++){var H=y[o];l(H,H.parent)}i=D;if(i.name=="pre")c=false;D._.isBlockLike&&v();l(D,D.parent);if(D==i)i=i.parent;d=d.concat(r)}if(e=="body")m=false};p.onText=function(e){if(!i._.hasInlineStarted&&!c){e=t.ltrim(e);if(e.length===0)return}v();z();if(m&&(!i.type||i.name=="body")&&t.trim(e))this.onTagOpen(m,{});c||(e=e.replace(/[\t\r\n ]{2,}|[\t\r\n]/g," "));i.add(new s.HtmlParser.Text(e))};p.onCDATA=function(){};p.onComment=function(e){i.add(new s.HtmlParser.Comment(e))};
p.parse(g);for(v();i.type;){g=i.parent;var b=i;if(m&&(!g.type||g.name=="body")&&!n.$body[b.name]){i=g;p.onTagOpen(m,{});g=i}g.add(b);i=g}return a};q.augment(w,{add:function(g){var m=this.children.length;if(m=m>0&&this.children[m-1]||null){if(g._.isBlockLike&&m.type==A.NODE_TEXT){m.value=t.rtrim(m.value);if(m.value.length===0){this.children.pop();this.add(g);return}}m.next=g}g.previous=m;g.parent=this;this.children.push(g);this._.hasInlineStarted=g.type==A.NODE_TEXT||g.type==A.NODE_ELEMENT&&!g._.isBlockLike},
writeHtml:function(g,m){var z;this.filterChildren=function(){var v=new s.HtmlParser.BasicWriter;this.writeChildrenHtml.call(this,v,m,true);v=v.getHtml();this.children=(new w.FromHtml(v)).children;z=1};!this.name&&m&&m.onFragment(this);this.writeChildrenHtml(g,z?null:m)},writeChildrenHtml:function(g,m){for(var z=0;z<this.children.length;z++)this.children[z].writeHtml(g,m)}});s.HtmlParser.Fragment=w}});
KISSY.Editor.add("htmlparser",function(){function w(){this._={htmlPartsRegex:new RegExp("<(?:(?:\\/([^>]+)>)|(?:!--([\\S|\\s]*?)--\>)|(?:([^\\s>]+)\\s*((?:(?:[^\"'>]+)|(?:\"[^\"]*\")|(?:'[^']*'))*)\\/?>))","g")}}var s=KISSY.Editor;if(!s.HtmlParser){var B=/([\w\-:.]+)(?:(?:\s*=\s*(?:(?:"([^"]*)")|(?:'([^']*)')|([^\s>]+)))|(?=\s|$))/g,q={checked:1,compact:1,declare:1,defer:1,disabled:1,ismap:1,multiple:1,nohref:1,noresize:1,noshade:1,nowrap:1,readonly:1,selected:1},t=s.XHTML_DTD;KISSY.augment(w,{onTagOpen:function(){},
onTagClose:function(){},onText:function(){},onCDATA:function(){},onComment:function(){},parse:function(A){for(var n,u,k=0,f;n=this._.htmlPartsRegex.exec(A);){u=n.index;if(u>k){k=A.substring(k,u);f?f.push(k):this.onText(k)}k=this._.htmlPartsRegex.lastIndex;if(u=n[1]){u=u.toLowerCase();if(f&&t.$cdata[u]){this.onCDATA(f.join(""));f=null}if(!f){this.onTagClose(u);continue}}if(f)f.push(n[0]);else if(u=n[3]){u=u.toLowerCase();var g={},m;n=n[4];var z=!!(n&&n.charAt(n.length-1)=="/");if(n)for(;m=B.exec(n);){var v=
m[1].toLowerCase();m=m[2]||m[3]||m[4]||"";g[v]=!m&&q[v]?v:m}this.onTagOpen(u,g,z);if(!f&&t.$cdata[u])f=[]}else if(u=n[2])this.onComment(u)}A.length>k&&this.onText(A.substring(k,A.length))}});s.HtmlParser=w}});
KISSY.Editor.add("htmlparser-htmlwriter",function(){function w(){w.superclass.constructor.call(this);this.indentationChars="\t";this.selfClosingEnd=" />";this.lineBreakChars="\n";this.forceSimpleAmpersand=false;this.sortAttributes=true;this._.indent=false;this._.indentation="";this._.rules={};var q=s.XHTML_DTD;for(var t in B.mix({},q.$nonBodyContent,q.$block,q.$listItem,q.$tableContent))this.setRules(t,{indent:true,breakBeforeOpen:true,breakAfterOpen:true,breakBeforeClose:!q[t]["#"],breakAfterClose:true});
this.setRules("br",{breakAfterOpen:true});this.setRules("title",{indent:false,breakAfterOpen:false});this.setRules("style",{indent:false,breakBeforeClose:true});this.setRules("pre",{indent:false})}var s=KISSY.Editor,B=s.Utils;if(!s.HtmlParser.HtmlWriter){KISSY.extend(w,s.HtmlParser.BasicWriter,{openTag:function(q){var t=this._.rules[q];if(this._.indent)this.indentation();else if(t&&t.breakBeforeOpen){this.lineBreak();this.indentation()}this._.output.push("<",q)},openTagClose:function(q,t){q=this._.rules[q];
if(t)this._.output.push(this.selfClosingEnd);else{this._.output.push(">");if(q&&q.indent)this._.indentation+=this.indentationChars}q&&q.breakAfterOpen&&this.lineBreak()},attribute:function(q,t){if(typeof t=="string"){this.forceSimpleAmpersand&&(t=t.replace(/&amp;/g,"&"));t=B.htmlEncodeAttr(t)}this._.output.push(" ",q,'="',t,'"')},closeTag:function(q){var t=this._.rules[q];if(t&&t.indent)this._.indentation=this._.indentation.substr(this.indentationChars.length);if(this._.indent)this.indentation();
else if(t&&t.breakBeforeClose){this.lineBreak();this.indentation()}this._.output.push("</",q,">");t&&t.breakAfterClose&&this.lineBreak()},text:function(q){if(this._.indent){this.indentation();q=B.ltrim(q)}this._.output.push(q)},comment:function(q){this._.indent&&this.indentation();this._.output.push("<!--",q,"--\>")},lineBreak:function(){this._.output.length>0&&this._.output.push(this.lineBreakChars);this._.indent=true},indentation:function(){this._.output.push(this._.indentation);this._.indent=false},
setRules:function(q,t){var A=this._.rules[q];if(A)B.mix(A,t);else this._.rules[q]=t}});s.HtmlParser.HtmlWriter=w}});KISSY.Editor.add("htmlparser-text",function(){function w(B){this.value=B;this._={isBlockLike:false}}var s=KISSY.Editor;if(!s.HtmlParser.Text){KISSY.augment(w,{type:s.NODE.NODE_TEXT,writeHtml:function(B,q){var t=this.value;q&&!(t=q.onText(t,this))||B.text(t)}});s.HtmlParser.Text=w}});
KISSY.Editor.add("htmldataprocessor",function(w){function s(c){if(/mso-list\s*:\s*Ignore/i.test(c.attributes&&c.attributes.style))return true;return n}function B(c,j){var b=new u.HtmlParser.Element("ke:listbullet"),e;if(c)if(c[2]){c=isNaN(c[1])?/^[a-z]+$/.test(c[1])?"lower-alpha":/^[A-Z]+$/.test(c[1])?"upper-alpha":"decimal":"decimal";e="ol"}else{c=/[l\u00B7\u2002]/.test(c[1])?"disc":/[\u006F\u00D8]/.test(c[1])?"circle":/[\u006E\u25C6]/.test(c[1])?"square":"disc";e="ul"}else{c="decimal";e="ol"}b.attributes=
{"ke:listtype":e,style:"list-style-type:"+c+";"};b.add(new u.HtmlParser.Text(j));return b}function q(c){var j=c.attributes,b;if((b=c.removeAnyChildWithName("ke:listbullet"))&&b.length&&(b=b[0])){c.name="ke:li";if(j.style)j.style=t([["text-indent"],["line-height"],[/^margin(:?-left)?$/,null,function(e){e=e.split(" ");e=e[3]||e[1]||e[0];e=parseInt(e,10);if(!p&&a&&e>a)p=e-a;j["ke:margin"]=a=e}]],n)(j.style,c)||"";b=b.attributes;c.addStyle(b.style);k.mix(j,b);return true}return false}function t(c,j){return function(b,
e){var o=[];b.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(y,r,D){r=r.toLowerCase();r=="font-family"&&(D=D.replace(/["']/g,""));for(var H,x,C,I=0;I<c.length;I++)if(c[I]){y=c[I][0];H=c[I][1];x=c[I][2];C=c[I][3];if(r.match(y)&&(!H||D.match(H))){r=C||r;j&&(x=x||D);if(typeof x=="function")x=x(D,e,r);if(x&&x.push){r=x[0];x=x[1]}typeof x=="string"&&o.push([r,x]);return}}!j&&o.push([r,D])});for(b=0;b<o.length;b++)o[b]=o[b].join(":");return o.length?o.join(";")+";":false}}
function A(c){c=c.children;for(var j,b,e,o,y,r,D,H=0;H<c.length;H++){j=c[H];if("ke:li"==j.name){j.name="li";b=j.attributes;e=j.attributes["ke:listtype"];o=parseInt(b["ke:indent"],10)||p&&Math.ceil(b["ke:margin"]/p)||1;b.style&&(b.style=t([["list-style-type",e=="ol"?"decimal":"disc"]],n)(b.style)||"");if(r){if(o>D){r=new u.HtmlParser.Element(e);r.add(j);y.add(r)}else{if(o<D){y=D-o;for(var x;y--&&(x=r.parent);)r=x.parent}r.add(j)}c.splice(H--,1)}else{r=new u.HtmlParser.Element(e);r.add(j);c[H]=r}y=
j;D=o}else r=null}p=0}var n=n,u=KISSY.Editor,k=KISSY,f=k.UA,g=u.HtmlParser,m=new g.Filter,z=new g.Filter,v=u.XHTML_DTD;if(!w.htmlDataProcessor){(function(){var c=u.HtmlParser.Fragment.prototype,j=u.HtmlParser.Element.prototype;c.onlyChild=j.onlyChild=function(){var b=this.children;return b.length==1&&b[0]||null};j.removeAnyChildWithName=function(b){for(var e=this.children,o=[],y,r=0;r<e.length;r++){y=e[r];if(y.name){if(y.name==b){o.push(y);e.splice(r--,1)}o=o.concat(y.removeAnyChildWithName(b))}}return o};
j.getAncestor=function(b){for(var e=this.parent;e&&!(e.name&&e.name.match(b));)e=e.parent;return e};c.firstChild=j.firstChild=function(b){for(var e,o=0;o<this.children.length;o++){e=this.children[o];if(b(e))return e;else if(e.name)if(e=e.firstChild(b))return e}return null};j.addStyle=function(b,e,o){var y="";if(typeof e=="string")y+=b+":"+e+";";else{if(typeof b=="object")for(var r in b){if(b.hasOwnProperty(r))y+=r+":"+b[r]+";"}else y+=b;o=e}if(!this.attributes)this.attributes={};b=this.attributes.style||
"";b=(o?[y,b]:[b,y]).join(";");this.attributes.style=b.replace(/^;|;(?=;)/,"")};v.parentOf=function(b){var e={};for(var o in this)if(o.indexOf("$")==-1&&this[o][b])e[o]=1;return e}})();var l=t([[/mso/i],[/font-size/i,"",function(c){for(var j=w.cfg.pluginConfig["font-size"],b=0;b<j.length;b++)if(c.toLowerCase()==j[b])return c;return false},"font-size"],[/font-family/i,"",function(c){for(var j=w.cfg.pluginConfig["font-family"],b=0;b<j.length;b++)if(c.toLowerCase()==j[b].toLowerCase())return c;return false},
"font-family"],[/line-height/i],[/display/i,/none/i]],n),p,a=0,d=v.parentOf("ol"),h={elementNames:[[/^script$/i,""],[/^iframe$/i,""],[/^style$/i,""],[/^link$/i,""],[/^meta$/i,""],[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],root:function(c){c.filterChildren();A(c)},elements:{font:function(c){delete c.name},p:function(c){c.filterChildren();if(q(c))return n},$:function(c){var j=c.name||"";j.indexOf(":")!=-1&&j.indexOf("ke")==-1&&delete c.name;var b=c.attributes.style;if(j=="span"&&(!b||!l(b)))delete c.name;
if(j in d){c.filterChildren();A(c)}},table:function(c){var j=c.attributes.border;if(!j||j=="0")c.attributes["class"]="ke_show_border"},span:function(c){if(!f.gecko&&s(c.parent))return false;if(!f.gecko&&s(c)){c=(c=c.firstChild(function(b){return b.value||b.name=="img"}))&&(c.value||"l.");var j=c.match(/^([^\s]+?)([.)]?)$/);return B(j,c)}}},comment:!f.ie?function(c,j){var b=c.match(/<img.*?>/);if(c=c.match(/^\[if !supportLists\]([\s\S]*?)\[endif\]$/)){b=(j=c[1]||b&&"l.")&&j.match(/>([^\s]+?)([.)]?)</);
return B(b,j)}if(f.gecko&&b){b=u.HtmlParser.Fragment.FromHtml(b[0]).children[0];(j=(j=(j=j.previous)&&j.value.match(/<v:imagedata[^>]*o:href=['"](.*?)['"]/))&&j[1])&&(b.attributes.src=j);return b}return false}:function(){return false},attributes:{"class":function(c){if(/^ke_/.test(c))return c;return false},style:function(c){c=l(c);if(!c)return false;return c}},attributeNames:[[/^on/,"ck_on"],[/^lang$/,""]]},i={elementNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],elements:{embed:function(c){var j=c.parent;
if(j&&j.name=="object"){var b=j.attributes.width;j=j.attributes.height;b&&(c.attributes.width=b);j&&(c.attributes.height=j)}},param:function(c){c.children=[];c.isEmpty=true;return c},a:function(c){if(!(c.children.length||c.attributes.name))return false},span:function(c){if(!c.children.length)return false}},attributes:{style:function(c){if(!k.trim(c))return false}},attributeNames:[[/^ck_on/,"on"],[/^ke:.*$/,""]]};if(f.ie)i.attributes.style=function(c){return c.toLowerCase()};m.addRules(i);z.addRules(h);
w.htmlDataProcessor={htmlFilter:m,dataFilter:z,toHtml:function(c,j){var b=new g.HtmlWriter;g.Fragment.FromHtml(c,j).writeHtml(b,m);return b.getHtml(true)},toDataFormat:function(c,j){if(f.gecko)c=c.replace(/(<!--\[if[^<]*?\])--\>([\S\s]*?)<!--(\[endif\]--\>)/gi,"$1$2$3");var b=new g.BasicWriter;c=g.Fragment.FromHtml(c,j);b.reset();c.writeHtml(b,z);return b.getHtml(true)}}}});
KISSY.Editor.add("image",function(w){var s=KISSY.Editor,B=KISSY,q=B.Node,t=B.DOM,A=B.Event,n=s.SimpleOverlay;s.ImageInserter||function(){function u(f){u.superclass.constructor.call(this,f);this._init()}var k=s.TripleButton;u.ATTRS={editor:{}};B.extend(u,B.Base,{_init:function(){var f=this.get("editor").toolBarDiv;this.el=new k({contentCls:"ke-toolbar-image",title:"\u56fe\u50cf",container:f});this.el.on("offClick",this.show,this);s.Utils.lazyRun(this,"_prepare","_real")},_prepare:function(){var f=
this,g=f.get("editor");f.d=new n({title:"\u63d2\u5165\u56fe\u7247",mask:true,width:"350px"});var m=f.d;m.body.html("<div><p><label><span style='color:#0066CC;font-weight:bold;'>\u56fe\u7247\u7f51\u5740\uff1a</span><input class='ke-img-url' style='width:230px' value='http://'/></label></p></div>");m.foot.html("<button class='ke-img-insert'>\u63d2\u5165</button> <button class='ke-img-cancel'>\u53d6\u6d88</button>");f.content=m.el;m=f.content;var z=m.one(".ke-img-cancel"),v=m.one(".ke-img-insert");f.imgUrl=
m.one(".ke-img-url");z.on("click",function(l){f.d.hide();l.halt()});A.on(document,"click",f.hide,f);A.on(g.document,"click",f.hide,f);v.on("click",function(){f._insert()})},hide:function(f){var g=this;t._4e_ascendant(f.target,function(m){return m[0]===g.content[0]||m[0]===g.el.el[0]},true)||this.d.hide()},_real:function(){this.d.show()},_insert:function(){var f=this.get("editor"),g=this.imgUrl.val();if(g){g=new q("<img src='"+g+"'/>",null,f.document);f.insertElement(g);this.d.hide()}},show:function(){this._prepare()}});
s.ImageInserter=u}();w.addPlugin(function(){new s.ImageInserter({editor:w})})});
KISSY.Editor.add("indent",function(w){var s=KISSY.Editor,B={ol:1,ul:1},q=KISSY,t=s.Walker,A=q.DOM,n=q.Node,u=q.UA,k=s.NODE;s.Indent||function(){function f(h){this.type=h;this.indentCssProperty="margin-left";this.indentOffset=40;this.indentUnit="px"}function g(h){return h.type=CKEDITOR.NODE_ELEMENT&&h.is("li")}function m(h,i,c){var j=i.startContainer;for(h=i.endContainer;j&&j.parent()[0]!==c[0];)j=j.parent();for(;h&&h.parent()[0]!==c[0];)h=h.parent();if(j&&h){var b=j;j=[];for(var e=false;!e;){if(b[0]===
h[0])e=true;j.push(b);b=b.next()}if(!(j.length<1)){b=c._4e_parents(true);for(h=0;h<b.length;h++)if(B[b[h]._4e_name()]){c=b[h];break}b=this.type=="indent"?1:-1;h=j[0];e=j[j.length-1];j={};var o=s.ListUtils.listToArray(c,j),y=o[e._4e_getData("listarray_index")].indent;for(h=h._4e_getData("listarray_index");h<=e._4e_getData("listarray_index");h++){o[h].indent+=b;var r=o[h].parent;o[h].parent=new n(r[0].ownerDocument.createElement(r._4e_name()))}for(h=e._4e_getData("listarray_index")+1;h<o.length&&o[h].indent>
y;h++)o[h].indent+=b;e=s.ListUtils.arrayToList(o,j,null,"p",0);b=[];if(this.type=="outdent"){var D;if((D=c.parent())&&D._4e_name()=="li"){o=e.listNode.childNodes;var H;for(h=o.length-1;h>=0;h--)if((H=new n(o[h]))&&H._4e_name()=="li")b.push(H)}}if(e){A.insertBefore(e.listNode,c[0]);c._4e_remove()}if(b&&b.length)for(h=0;h<b.length;h++){for(H=c=b[h];(H=H.next())&&H._4e_name()in B;){u.ie&&!c._4e_first(function(x){return p(x)&&a(x)})&&c[0].appendChild(i.document.createTextNode("\u00a0"));c[0].appendChild(H[0])}A.insertAfter(c[0],
D[0])}for(h in j)j[h]._4e_clearMarkers(j,true)}}}function z(h,i){i=i.createIterator();i.enforceRealBlocks=true;i.enlargeBr=true;for(var c;c=i.getNextParagraph();)v.call(this,h,c)}function v(h,i){h=parseInt(i._4e_style(this.indentCssProperty),10);if(isNaN(h))h=0;h+=(this.type=="indent"?1:-1)*this.indentOffset;if(h<0)return false;h=Math.max(h,0);h=Math.ceil(h/this.indentOffset)*this.indentOffset;i.css(this.indentCssProperty,h?h+this.indentUnit:"");i[0].style.cssText===""&&i[0].removeAttribute("style");
return true}function l(h){l.superclass.constructor.call(this,h);h=this.get("editor").toolBarDiv;this.el=new d({container:h,contentCls:this.get("contentCls"),title:this.get("title")});this.indentCommand=new f(this.get("type"));this._init()}var p=t.whitespaces(true),a=t.bookmark(false,true);q.augment(f,{exec:function(h){for(var i=h.getSelection(),c=i&&i.getRanges()[0],j=c.startContainer,b=c.endContainer,e=c.getCommonAncestor();e&&!(e[0].nodeType==k.NODE_ELEMENT&&B[e._4e_name()]);)e=e.parent();if(e&&
j[0].nodeType==k.NODE_ELEMENT&&j._4e_name()in B){j=new t(c);j.evaluator=g;c.startContainer=j.next()}if(e&&b[0].nodeType==k.NODE_ELEMENT&&b._4e_name()in B){j=new t(c);j.evaluator=g;c.endContainer=j.previous()}b=i.createBookmarks(true);if(e){for(j=e._4e_first();j&&j[0]&&j._4e_name()!="li";)j=j.next();var o=c.startContainer;(j[0]==o[0]||j._4e_contains(o))&&v.call(this,h,e)||m.call(this,h,c,e)}else z.call(this,h,c);i.selectBookmarks(b)}});var d=s.TripleButton;l.ATTRS={type:{},contentCls:{},editor:{}};
q.extend(l,q.Base,{_init:function(){var h=this.get("editor"),i=this.el;i.on("offClick",this.exec,this);this.get("type")=="outdent"?h.on("selectionChange",this._selectionChange,this):i.set("state",d.OFF)},exec:function(){var h=this.get("editor"),i=this;h.fire("save");setTimeout(function(){i.indentCommand.exec(h);h.fire("save");h.notifySelectionChange()},10)},_selectionChange:function(h){this.get("editor");this.get("type");var i=h.path,c=i.blockLimit;h=this.el;if(i.contains(B))h.set("state",d.OFF);
else(i=i.block||c)&&i._4e_style(this.indentCommand.indentCssProperty)?h.set("state",d.OFF):h.set("state",d.DISABLED)}});s.Indent=l}();w.addPlugin(function(){w.addCommand("outdent",new s.Indent({editor:w,title:"\u51cf\u5c11\u7f29\u8fdb\u91cf ",contentCls:"ke-toolbar-outdent",type:"outdent"}));w.addCommand("indent",new s.Indent({editor:w,title:"\u589e\u52a0\u7f29\u8fdb\u91cf ",contentCls:"ke-toolbar-indent",type:"indent"}))})});
KISSY.Editor.add("justify",function(w){var s=KISSY.Editor,B=KISSY,q=s.TripleButton;s.Justify||function(){function t(n,u,k,f){this.editor=n;this.v=u;this.contentCls=f;this.title=k;this._init()}var A=/(-moz-|-webkit-|start|auto)/i;B.augment(t,{_init:function(){var n=this.editor;this.el=new q({contentCls:this.contentCls,title:this.title,container:n.toolBarDiv});n.on("selectionChange",this._selectionChange,this);this.el.on("click",this._effect,this)},_effect:function(){var n=this.editor,u=n.getSelection(),
k=this.el.get("state");if(u){var f=u.createBookmarks(),g=u.getRanges(),m,z;n.fire("save");for(var v=g.length-1;v>=0;v--){m=g[v].createIterator();for(m.enlargeBr=true;z=m.getNextParagraph();){z.removeAttr("align");k==q.OFF?z.css("text-align",this.v):z.css("text-align","")}}n.notifySelectionChange();u.selectBookmarks(f);n.fire("save")}},_selectionChange:function(n){var u=this.el;n=n.path;if(n=n.block||n.blockLimit){n=n.css("text-align").replace(A,"");n==this.v||!n&&this.v=="left"?u.set("state",q.ON):
u.set("state",q.OFF)}}});s.Justify=t}();w.addPlugin(function(){new s.Justify(w,"left","\u5de6\u5bf9\u9f50 ","ke-toolbar-alignleft");new s.Justify(w,"center","\u5c45\u4e2d\u5bf9\u9f50 ","ke-toolbar-aligncenter");new s.Justify(w,"right","\u53f3\u5bf9\u9f50 ","ke-toolbar-alignright")})});
KISSY.Editor.add("link",function(w){var s=KISSY.Editor,B=KISSY,q=B.DOM,t=B.Event,A=s.TripleButton,n=s.Style,u=B.Node,k=s.Range,f=s.SimpleOverlay;s.Link||function(){function g(l){this.editor=l;this._init()}var m={element:"a",attributes:{href:"#(href)",target:"#(target)"}};g.init=function(){var l=this;l.d=new f({title:"\u4fee\u6539\u94fe\u63a5",mask:true,width:"300px"});l.d.body.html(z);l.d.foot.html(v);l.urlEl=l.d.body.one(".ke-link-url");l.targetEl=l.d.body.one(".ke-link-blank");var p=l.d.foot.one(".ke-link-cancel");
l.ok=l.d.foot.one(".ke-link-ok");g.ok.on("click",function(a){g.d.link._link();a.halt()},this);p.on("click",function(a){l.d.hide();a.halt()},l);g.init=null};g.tip=function(){var l=this,p=new u('<div class="ke-bubbleview-bubble" onmousedown="return false;">\u524d\u5f80\u94fe\u63a5\uff1a  <a href=""  target="_blank" class="ke-bubbleview-url"></a> -     <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -     <span class="ke-bubbleview-link ke-bubbleview-remove">\u53bb\u9664</span></div>');
p._4e_unselectable();l.tipwin=new f({el:p,focusMgr:false});document.body.appendChild(p[0]);l.tipurl=p.one(".ke-bubbleview-url");var a=p.one(".ke-bubbleview-change");p=p.one(".ke-bubbleview-remove");a.on("click",function(d){g.tipwin.link.show();d.halt()});t.on(document,"click",function(){l.tipwin.hide()});p.on("click",function(d){g.tipwin.link._removeLink();d.halt()});g.tip=null};var z="<div><p><label><span style='color:#0066CC;font-weight:bold;'>\u7f51\u5740\uff1a</span><input class='ke-link-url' style='width:230px' value='http://'/></label></p><p style='margin-top: 5px;padding-left:45px'><label><input class='ke-link-blank' type='checkbox'/> &nbsp; \u5728\u65b0\u7a97\u53e3\u6253\u5f00\u94fe\u63a5</label></p></div>",
v="<button class='ke-link-ok'>\u786e\u5b9a</button> <button class='ke-link-cancel'>\u53d6\u6d88</button>";B.augment(g,{_init:function(){var l=this.editor;this.el=new A({container:l.toolBarDiv,contentCls:"ke-toolbar-link",title:"\u7f16\u8f91\u8d85\u94fe\u63a5 "});this.el.on("click",this.show,this);l.on("selectionChange",this._selectionChange,this)},_prepareTip:function(){g.tip&&g.tip()},_realTip:function(l){var p=l._4e_getOffset(document);p.top+=l.height()+5;g.tipwin.show(p);this._a=l;g.tipwin.link=
this;g.tipurl.html(l.attr("href"));g.tipurl.attr("href",l.attr("href"))},_showTip:function(l){this._prepareTip(l)},_hideTip:function(){g.tipwin&&g.tipwin.hide()},_removeLink:function(){var l=this._a,p=this.editor,a={href:l.attr("href")};if(l._4e_hasAttribute("target"))a.target=l.attr("target");l=new n(m,a);p.fire("save");l.remove(p.document);p.fire("save");p.notifySelectionChange()},_selectionChange:function(l){l=l.path;var p=l.elements;if(l&&p)if(l=l.lastElement)(l=l._4e_ascendant(function(a){return a._4e_name()===
"a"&&!!a.attr("href")},true))?this._showTip(l):this._hideTip()},hide:function(){g.d.hide()},_getSelectedLink:function(){var l=this.editor.getSelection().getRanges()[0].getCommonAncestor();l&&(l=l._4e_ascendant(function(p){return p._4e_name()=="a"&&!!p.attr("href")},true));return l},_link:function(){var l,p=this.editor,a=g.urlEl.val();if(B.trim(a)){this.hide();var d=this._getSelectedLink();if(d){l=new k(p.document);l.selectNodeContents(d);p.getSelection().selectRanges([l]);this._removeLink()}d={href:a};
d.target=g.targetEl[0].checked?"_blank":"_self";l=p.getSelection().getRanges()[0];if(l.collapsed){l=new u("<a href='"+a+"' target='"+d.target+"'>"+a+"</a>",null,p.document);p.insertElement(l)}else{p.fire("save");(new n(m,d)).apply(p.document);p.fire("save")}p.notifySelectionChange()}},_prepare:function(){g.init&&g.init()},_real:function(){g.d.link=this;var l=this._getSelectedLink();if(l){g.urlEl.val(l.attr("href"));g.targetEl[0].checked=l.attr("target")=="_blank"}g.d.show()},show:function(){this._prepare()}});
s.Utils.lazyRun(g.prototype,"_prepare","_real");s.Utils.lazyRun(g.prototype,"_prepareTip","_realTip");s.Link=g}();w.addPlugin(function(){new s.Link(w);var g=q._4e_getWin(w.document);t.on(g,"scroll",function(){s.Link.tipwin&&s.Link.tipwin.hide()})})});
KISSY.Editor.add("list",function(w){var s=KISSY.Editor,B={ol:1,ul:1},q=["ol","ul"],t=KISSY,A=s.RANGE,n=s.ElementPath,u=s.Walker,k=s.NODE,f=t.UA,g=t.Node,m=t.DOM;s.List||function(){function z(d){this.type=d}function v(d){v.superclass.constructor.call(this,d);d=this.get("editor").toolBarDiv;this.el=new a({contentCls:this.get("contentCls"),title:this.get("title"),container:d});this.listCommand=new z(this.get("type"));this.listCommand.state=this.get("status");this._init()}var l={listToArray:function(d,
h,i,c,j){if(!B[d._4e_name()])return[];c||(c=0);i||(i=[]);for(var b=0,e=d[0].childNodes.length;b<e;b++){var o=new g(d[0].childNodes[b]);if(o._4e_name()=="li"){var y={parent:d,indent:c,element:o,contents:[]};if(j)y.grandparent=j;else{y.grandparent=d.parent();if(y.grandparent&&y.grandparent._4e_name()=="li")y.grandparent=y.grandparent.parent()}h&&o._4e_setMarker(h,"listarray_index",i.length);i.push(y);for(var r=0,D=o[0].childNodes.length,H;r<D;r++){H=new g(o[0].childNodes[r]);H[0].nodeType==k.NODE_ELEMENT&&
B[H._4e_name()]?l.listToArray(H,h,i,c+1,y.grandparent):y.contents.push(H)}}}return i},arrayToList:function(d,h,i,c){i||(i=0);if(!d||d.length<i+1)return null;for(var j=d[i].parent[0].ownerDocument,b=j.createDocumentFragment(),e=null,o=i,y=Math.max(d[i].indent,0),r=null;;){var D=d[o];if(D.indent==y){if(!e||d[o].parent._4e_name()!=e._4e_name()){e=d[o].parent._4e_clone(false,true);b.appendChild(e[0])}r=e[0].appendChild(D.element._4e_clone(false,true)[0]);for(var H=0;H<D.contents.length;H++)r.appendChild(D.contents[H]._4e_clone(true,
true)[0]);o++}else if(D.indent==Math.max(y,0)+1){o=l.arrayToList(d,null,o,c);r.appendChild(o.listNode);o=o.nextIndex}else if(D.indent==-1&&!i&&D.grandparent){r=B[D.grandparent._4e_name()]?D.element._4e_clone(false,true)[0]:D.grandparent._4e_name()!="td"?j.createElement(c):j.createDocumentFragment();for(H=0;H<D.contents.length;H++)r.appendChild(D.contents[H]._4e_clone(true,true)[0]);if(r.nodeType==k.NODE_DOCUMENT_FRAGMENT&&o!=d.length-1){r.lastChild&&r.lastChild.nodeType==k.NODE_ELEMENT&&r.lastChild.getAttribute("type")==
"_moz"&&m._4e_remove(r.lastChild);m._4e_appendBogus(r)}if(r.nodeType==k.NODE_ELEMENT&&m._4e_name(r)==c&&r.firstChild){m._4e_trim(r);e=r.firstChild;if(e.nodeType==k.NODE_ELEMENT&&m._4e_isBlockBoundary(e)){e=j.createDocumentFragment();m._4e_moveChildren(r,e);r=e}}e=m._4e_name(r);if(!f.ie&&(e=="div"||e=="p"))m._4e_appendBogus(r);b.appendChild(r);e=null;o++}else return null;if(d.length<=o||Math.max(d[o].indent,0)<y)break}if(h)for(d=new g(b.firstChild);d&&d[0];){d[0].nodeType==k.NODE_ELEMENT&&d._4e_clearMarkers(h,
true);d=d._4e_nextSourceNode()}return{listNode:b,nextIndex:o}}},p=/^h[1-6]$/;z.prototype={changeListType:function(d,h,i,c){var j=l.listToArray(h.root,i),b=[];for(d=0;d<h.contents.length;d++){var e=h.contents[d];e=e._4e_ascendant("li",true);if(!(!e||!e[0]||e._4e_getData("list_item_processed"))){b.push(e);e._4e_setMarker(i,"list_item_processed",true)}}e=new g(h.root[0].ownerDocument.createElement(this.type));for(d=0;d<b.length;d++){var o=b[d]._4e_getData("listarray_index");j[o].parent=e}i=l.arrayToList(j,
i,null,"p");var y;j=i.listNode.childNodes.length;for(d=0;d<j&&(y=new g(i.listNode.childNodes[d]));d++)y._4e_name()==this.type&&c.push(y);m.insertBefore(i.listNode,h.root[0]);h.root._4e_remove()},createList:function(d,h,i){var c=h.contents;d=h.root[0].ownerDocument;var j=[];if(c.length==1&&c[0][0]===h.root[0]){var b=new g(d.createElement("div"));c[0][0].nodeType!=k.NODE_TEXT&&c[0]._4e_moveChildren(b);c[0][0].appendChild(b[0]);c[0]=b}h=h.contents[0].parent();for(b=0;b<c.length;b++)h=h._4e_commonAncestor(c[b].parent());
for(b=0;b<c.length;b++)for(var e=c[b],o;o=e.parent();){if(o[0]===h[0]){j.push(e);break}e=o}if(!(j.length<1)){c=new g(j[j.length-1][0].nextSibling);b=new g(d.createElement(this.type));for(i.push(b);j.length;){i=j.shift();e=new g(d.createElement("li"));if(p.test(i._4e_name()))e[0].appendChild(i[0]);else{i._4e_copyAttributes(e);i._4e_moveChildren(e);i._4e_remove()}b[0].appendChild(e[0]);f.ie||e._4e_appendBogus()}c[0]?m.insertBefore(b[0],c[0]):h[0].appendChild(b[0])}},removeList:function(d,h,i){function c(H){if((r=
new g(y[H?"firstChild":"lastChild"]))&&!(r[0].nodeType==k.NODE_ELEMENT&&r._4e_isBlockBoundary())&&(D=h.root[H?"_4e_previous":"_4e_next"](u.whitespaces(true)))&&!(r[0].nodeType==k.NODE_ELEMENT&&D._4e_isBlockBoundary({br:1})))m[H?"insertBefore":"insertAfter"](d.document.createElement("br"),r[0])}for(var j=l.listToArray(h.root,i),b=[],e=0;e<h.contents.length;e++){var o=h.contents[e];o=o._4e_ascendant("li",true);if(!(!o||o._4e_getData("list_item_processed"))){b.push(o);o._4e_setMarker(i,"list_item_processed",
true)}}o=null;for(e=0;e<b.length;e++){o=b[e]._4e_getData("listarray_index");j[o].indent=-1;o=o}for(e=o+1;e<j.length;e++)if(j[e].indent>Math.max(j[e-1].indent,0)){b=j[e-1].indent+1-j[e].indent;for(o=j[e].indent;j[e]&&j[e].indent>=o;){j[e].indent+=b;e++}e--}var y=l.arrayToList(j,i,null,"p").listNode,r,D;c(true);c();m.insertBefore(y,h.root);h.root._4e_remove()},exec:function(d){var h=d.getSelection(),i=h&&h.getRanges();if(!(!i||i.length<1)){for(var c=h.createBookmarks(true),j=[],b={};i.length>0;){var e=
i.shift(),o=e.getBoundaryNodes(),y=o.startNode,r=o.endNode;y[0].nodeType==k.NODE_ELEMENT&&y._4e_name()=="td"&&e.setStartAt(o.startNode,A.POSITION_AFTER_START);r[0].nodeType==k.NODE_ELEMENT&&r._4e_name()=="td"&&e.setEndAt(o.endNode,A.POSITION_BEFORE_END);e=e.createIterator();for(e.forceBrBreak=false;o=e.getNextParagraph();){y=new n(o);r=y.elements;var D=null,H=false,x=y.blockLimit,C;for(y=r.length-1;y>=0&&(C=r[y]);y--)if(B[C._4e_name()]&&x.contains(C)){x._4e_removeData("list_group_object");if(y=C._4e_getData("list_group_object"))y.contents.push(o);
else{y={root:C,contents:[o]};j.push(y);C._4e_setMarker(b,"list_group_object",y)}H=true;break}if(!H)if(x._4e_getData("list_group_object"))x._4e_getData("list_group_object").contents.push(o);else{y={root:x,contents:[o]};x._4e_setMarker(b,"list_group_object",y);j.push(y)}}}for(i=[];j.length>0;){y=j.shift();if(this.state=="off")B[y.root._4e_name()]?this.changeListType(d,y,b,i):this.createList(d,y,i);else this.state=="on"&&B[y.root._4e_name()]&&this.removeList(d,y,b)}for(y=0;y<i.length;y++){D=i[y];var I=
this;(d=function(J){var N=D[J?"_4e_previous":"_4e_next"](u.whitespaces(true));if(N&&N[0]&&N._4e_name()==I.type){N._4e_remove();N._4e_moveChildren(D,J?true:false)}})();d(true)}s.Utils.clearAllMarkers(b);h.selectBookmarks(c)}}};var a=s.TripleButton;v.ATTRS={editor:{},type:{},contentCls:{}};t.extend(v,t.Base,{_init:function(){var d=this,h=d.get("editor"),i=d.el;d=d;i.on("click",d._change,d);h.on("selectionChange",d._selectionChange,d)},_change:function(){var d=this.get("editor");this.get("type");var h=
this.el;d.fire("save");this.listCommand.state=h.get("state");this.listCommand.exec(d);d.fire("save");d.notifySelectionChange()},_selectionChange:function(d){this.get("editor");var h=this.get("type"),i=d.path,c;d=this.el;var j=i.blockLimit;if(i=i.elements)for(var b=0;b<i.length&&(c=i[b])&&c[0]!==j[0];b++){var e=t.indexOf(i[b]._4e_name(),q);if(e!==-1)if(q[e]===h){d.set("state",a.ON);return}else break}d.set("state",a.OFF)}});s.ListUtils=l;s.List=v}();w.addPlugin(function(){new s.List({editor:w,title:"\u9879\u76ee\u5217\u8868",
contentCls:"ke-toolbar-ul",type:"ul"});new s.List({editor:w,title:"\u7f16\u53f7\u5217\u8868",contentCls:"ke-toolbar-ol",type:"ol"})})});
KISSY.Editor.add("maximize",function(w){var s=KISSY.Editor,B=KISSY,q=B.UA,t=B.Node,A=B.Event,n=s.TripleButton,u=B.DOM,k;s.Maximize||function(){function f(g){this.editor=g;this._init()}f.init=function(){k=new t("<iframe style='position:absolute;top:-9999px;left:-9999px;' frameborder='0'></iframe>");document.body.appendChild(k[0]);f.init=null};B.augment(f,{_init:function(){this.el=new n({container:this.editor.toolBarDiv,cls:"ke-tool-editor-source",title:"\u5168\u5c4f",contentCls:"ke-toolbar-maximize"});
this.el.on("offClick",this.maximize,this);this.el.on("onClick",this.restore,this);s.Utils.lazyRun(this,"_prepare","_real")},restore:function(){var g=this,m=g.editor;A.remove(window,"resize",g._maximize,g);this._saveEditorStatus();m.wrap.css({height:g.iframeHeight});(new t(document.body)).css({width:"",height:"",overflow:""});document.documentElement.style.overflow="";m.editorWrap.css({position:"static",width:g.editorWrapWidth});k.css({left:"-99999px",top:"-99999px"});window.scrollTo(g.scrollLeft,
g.scrollTop);g.el.set("state",n.OFF);setTimeout(function(){g._restoreEditorStatus()},30);m.notifySelectionChange()},_saveSate:function(){var g=this.editor;this.iframeHeight=g.wrap._4e_style("height");this.editorWrapWidth=g.editorWrap._4e_style("width");this.scrollLeft=u.scrollLeft();this.scrollTop=u.scrollTop();window.scrollTo(0,0)},_saveEditorStatus:function(){var g=this.editor;if(q.gecko&&g.iframeFocus)this.savedRanges=(g=g.getSelection())&&g.getRanges()},_restoreEditorStatus:function(){var g=this.editor,
m=g.getSelection();if(q.gecko&&g.iframeFocus){this.el.el[0].focus();g.focus();this.savedRanges&&m&&m.selectRanges(this.savedRanges)}if(g.iframeFocus&&m)(g=m.getStartElement())&&g[0]&&g._4e_scrollIntoView()},_maximize:function(){var g=this.editor,m=u.viewportHeight(),z=u.viewportWidth(),v=g.statusDiv?g.statusDiv.height():0,l=g.toolBarDiv.height();if(q.ie){document.documentElement.style.overflow="hidden";document.body.style.overflow="hidden"}else(new t(document.body)).css({width:0,height:0,overflow:"hidden"});
g.editorWrap.css({position:"absolute",zIndex:990,width:z+"px"});k.css({zIndex:985,height:m+"px",width:z+"px"});g.editorWrap.offset({left:0,top:0});k.css({left:0,top:0});g.wrap.css({height:m-v-l-14+"px"});g.notifySelectionChange()},_real:function(){var g=this;this._saveEditorStatus();this._saveSate();this._maximize();this._maximize();A.on(window,"resize",g._maximize,g);this.el.set("state",n.ON);setTimeout(function(){g._restoreEditorStatus()},30)},_prepare:function(){f.init&&f.init()},maximize:function(){this._prepare()}});
s.Maximize=f}();w.addPlugin(function(){new s.Maximize(w)})});
KISSY.Editor.add("music",function(w){var s=KISSY,B=s.Node,q=s.DOM,t=s.Editor,A=s.Event;t.MusicInserter||function(){function n(a){n.superclass.constructor.call(this,a);a=this.get("editor");a._toolbars=a._toolbars||{};a._toolbars.music=this;this._init()}function u(a){return a.replace(/^.+niftyplayer\.swf\?file=/,"")}var k=t.ContextMenu,f=t.SimpleOverlay,g=t.TripleButton,m=t.Utils.getFlashUrl,z='<object  width="165" height="37" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,0,0" classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"><param value="'+(t.Config.base+
'plugins/music/niftyplayer.swf?file=#(music)"')+' name="movie"/><param value="high" name="quality"/><param value="#FFFFFF" name="bgcolor"/><embed width="165" height="37" type="application/x-shockwave-flash" swliveconnect="true" src="'+(t.Config.base+'plugins/music/niftyplayer.swf?file=#(music)"')+'quality="high" pluginspage="http://www.macromedia.com/go/getflashplayer" bgcolor="#FFFFFF" /></object>',v=/#\(music\)/g,l=["img.ke_music"];n.ATTRS={editor:{}};n.tip=function(){var a=this,d=new B('<div class="ke-bubbleview-bubble" onmousedown="return false;">\u97f3\u4e50\u7f51\u5740\uff1a  <a class="ke-bubbleview-url" target="_blank" href="#"></a> -     <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -     <span class="ke-bubbleview-link ke-bubbleview-remove">\u5220\u9664</span></div>');
d._4e_unselectable();a.tipwin=new f({el:d,focusMgr:false});document.body.appendChild(d[0]);a.tipurl=d.one(".ke-bubbleview-url");var h=d.one(".ke-bubbleview-change");d=d.one(".ke-bubbleview-remove");h.on("click",function(i){a.tipwin.music.show();i.halt()});a.tipwin.on("hide",function(){var i=a.tipwin.music;i&&!i.d.get("visible")&&(i.selectedFlash=null)});A.on(document,"click",function(){a.tipwin.hide()});d.on("click",function(i){var c=a.tipwin.music;c.selectedFlash._4e_remove();c.get("editor").notifySelectionChange();
i.halt()});a.tip=null};s.extend(n,s.Base,{_init:function(){var a=this.get("editor"),d={};this.el=new g({contentCls:"ke-toolbar-music",title:"\u5206\u4eab\u97f3\u4e50",container:a.toolBarDiv});A.on(a.document,"dblclick",this._dblclick,this);for(var h in p)(function(i){d[i]=function(){p[i](a)}})(h);k.register(a.document,{rules:l,width:"120px",funcs:d});this.el.on("offClick",this.show,this);t.Utils.lazyRun(this,"_prepare","_real");a.on("selectionChange",this._selectionChange,this)},_selectionChange:function(a){a=
a.path;var d=a.elements;if(a&&d)if(a=a.lastElement)(a=a._4e_ascendant(function(h){return h._4e_name()==="img"&&!!h.hasClass("ke_music")},true))?this._showTip(a):this._hideTip()},_showTip:function(a){this._prepareTip(a)},_hideTip:function(){n.tipwin&&n.tipwin.hide()},_prepareTip:function(){n.tip&&n.tip()},_realTip:function(a){var d=this.get("editor"),h=a._4e_getOffset(document);h.top+=a.height()+5;n.tipwin.show(h);this.selectedFlash=a;a=d.restoreRealElement(this.selectedFlash);n.tipwin.music=this;
n.tipurl.html(u(m(a)));n.tipurl.attr("href",u(m(a)))},_prepare:function(){var a=this,d=a.get("editor");a.d=new f({title:"\u7f16\u8f91\u97f3\u4e50",mask:true,width:"350px"});var h=a.d;h.body.html("<div><p><label><span style='color:#0066CC;font-weight:bold;'>\u97f3\u4e50\u7f51\u5740\uff1a </span><input class='ke-music-url' style='width:230px' value='http://'/></label></p></div>");h.foot.html("<button class='ke-music-insert'>\u786e\u5b9a</button> <button class='ke-music-cancel'>\u53d6\u6d88</button>");
a.content=h.el;var i=a.content;h.on("hide",function(){a.selectedFlash=null});h=i.one(".ke-music-cancel");var c=i.one(".ke-music-insert");a.musicUrl=i.one(".ke-music-url");h.on("click",function(j){a.d.hide();j.halt()});A.on(document,"click",a.hide,a);A.on(d.document,"click",a.hide,a);c.on("click",function(){a._insert()})},hide:function(a){var d=this;q._4e_ascendant(a.target,function(h){return h[0]===d.content[0]||h[0]===d.el.el[0]})||this.d.hide()},_real:function(){this.d.show()},_insert:function(){var a=
this.get("editor"),d=this.musicUrl.val();if(d){d=z.replace(v,d);var h=new B(d,null,a.document);d=a.createFakeElement?a.createFakeElement(h,"ke_music","music",true,d):h;a.insertElement(d);this.selectedFlash&&a.getSelection().selectElement(d);this.d.hide()}},_dblclick:function(a){var d=new B(a.target);if(d._4e_name()==="img"&&d.hasClass("ke_music")){this.selectedFlash=d;this.show();a.halt()}},show:function(){this._prepare();if(this.selectedFlash){var a=this.get("editor").restoreRealElement(this.selectedFlash);
this.musicUrl.val(u(m(a)))}else this.musicUrl.val("")}});t.Utils.lazyRun(n.prototype,"_prepareTip","_realTip");t.MusicInserter=n;var p={"\u7f16\u8f91\u97f3\u4e50":function(a){var d=a.getSelection();if(d=(d=d&&d.getStartElement())&&d._4e_ascendant("img",true))if(d.hasClass("ke_music")){a=a._toolbars.music;a.selectedFlash=d;a.show()}}}}();w.addPlugin(function(){new t.MusicInserter({editor:w});var n=q._4e_getWin(w.document);A.on(n,"scroll",function(){t.MusicInserter.tipwin&&t.MusicInserter.tipwin.hide()})})});
KISSY.Editor.add("preview",function(w){var s=KISSY.Editor,B=KISSY,q=s.TripleButton;s.Preview||function(){function t(A){this.editor=A;this._init()}B.augment(t,{_init:function(){this.el=new q({container:this.editor.toolBarDiv,cls:"ke-tool-editor-source",title:"\u9884\u89c8",contentCls:"ke-toolbar-preview"});this.el.on("offClick",this._show,this)},_show:function(){var A=this.editor,n=640,u=420,k=80;try{var f=window.screen;n=Math.round(f.width*0.8);u=Math.round(f.height*0.7);k=Math.round(f.width*0.1)}catch(g){}A=
A._prepareIFrameHtml().replace(/<body[^>]+>.+<\/body>/,"<body>\n"+A.getData()+"\n</body>");n=window.open("",null,"toolbar=yes,location=no,status=yes,menubar=yes,scrollbars=yes,resizable=yes,width="+n+",height="+u+",left="+k);n.document.open();n.document.write(A);n.document.close()}});s.Preview=t}();w.addPlugin(function(){new s.Preview(w)})});
KISSY.Editor.add("removeformat",function(w){function s(m){this.editor=m;this._init()}function B(m,z){for(var v=0;v<z.length;v++)m.removeAttr(z[v])}var q=KISSY.Editor,t=KISSY,A=q.RANGE,n=q.ElementPath,u=q.NODE,k=q.TripleButton,f="b,big,code,del,dfn,em,font,i,ins,kbd,q,samp,small,span,strike,strong,sub,sup,tt,u,var,s",g="class,style,lang,width,height,align,hspace,valign".split(",");f=new RegExp("^(?:"+f.replace(/,/g,"|")+")$","i");t.augment(s,{_init:function(){this.el=new k({title:"\u6e05\u9664\u683c\u5f0f",
contentCls:"ke-toolbar-removeformat",container:this.editor.toolBarDiv});this.el.on("offClick",this._remove,this)},_remove:function(){var m=this.editor,z=f;z.lastIndex=0;var v=m.getSelection().getRanges();m.fire("save");for(var l=0,p;p=v[l];l++)if(!p.collapsed){p.enlarge(A.ENLARGE_ELEMENT);var a=p.createBookmark(),d=a.startNode,h=a.endNode,i=function(c){for(var j=new n(c),b=j.elements,e=1,o;o=b[e];e++){if(o._4e_equals(j.block)||o._4e_equals(j.blockLimit))break;z.test(o._4e_name())&&c._4e_breakParent(o)}};
i(d);i(h);for(d=d._4e_nextSourceNode(true,u.NODE_ELEMENT);d;){if(d._4e_equals(h))break;i=d._4e_nextSourceNode(false,u.NODE_ELEMENT);d._4e_name()=="img"&&d.attr("_cke_realelement")||(z.test(d._4e_name())?d._4e_remove(true):B(d,g));d=i}p.moveToBookmark(a)}m.getSelection().selectRanges(v);m.fire("save")}});w.addPlugin(function(){new s(w)})});
KISSY.Editor.add("smiley",function(w){var s=KISSY.Editor,B=KISSY,q=B.DOM,t=B.Event,A=B.Node,n=s.SimpleOverlay,u=s.TripleButton;s.Smiley||function(){function k(m){this.editor=m;this._init()}for(var f="<div class='ke-popup-wrap'><div class='ke-smiley-sprite'>",g=0;g<=98;g++)f+="<a href='#' data-icon='http://a.tbcdn.cn/sys/wangwang/smiley/48x48/"+g+".gif'></a>";f+="</div></div>";B.augment(k,{_init:function(){this.el=new u({contentCls:"ke-toolbar-smiley",title:"\u63d2\u5165\u8868\u60c5",container:this.editor.toolBarDiv});
this.el.on("offClick",this._show,this);s.Utils.lazyRun(this,"_prepare","_real")},_hidePanel:function(m){var z=this;q._4e_ascendant(m.target,function(v){return v[0]===z.el.el[0]})||this.smileyWin.hide()},_selectSmiley:function(m){m.halt();var z=this.editor;m=m.target;var v;if(q._4e_name(m)=="a"&&(v=q.attr(m,"data-icon"))){v=new A("<img src='"+v+"'/>",null,z.document);z.insertElement(v);this.smileyWin.hide()}},_prepare:function(){var m=this.editor;this.smileyPanel=new A(f);this.smileyWin=new n({el:this.smileyPanel,
focusMgr:false,mask:false});document.body.appendChild(this.smileyPanel[0]);this.smileyPanel.on("click",this._selectSmiley,this);t.on(document,"click",this._hidePanel,this);t.on(m.document,"click",this._hidePanel,this)},_real:function(){var m=this.el.el.offset();m.top+=this.el.el.height()+5;if(m.left+this.smileyPanel.width()>q.viewportWidth()-60)m.left=q.viewportWidth()-this.smileyPanel.width()-60;this.smileyWin.show(m)},_show:function(m){this._prepare(m)}});s.Smiley=k}();w.addPlugin(function(){new s.Smiley(w)})});
KISSY.Editor.add("sourcearea",function(w){var s=KISSY.Editor,B=KISSY,q=B.UA,t=s.TripleButton;s.SourceArea||function(){function A(n){this.editor=n;this._init()}B.augment(A,{_init:function(){var n=this.editor;this.el=new t({container:n.toolBarDiv,cls:"ke-tool-editor-source",title:"\u6e90\u7801",contentCls:"ke-toolbar-source"});this.el.on("offClick",this._show,this);this.el.on("onClick",this._hide,this);n.textarea.on("mousedown",function(u){u.stopPropagation()})},_show:function(){var n=this.editor,u=
this.el;n.textarea.val(n.getData());n._showSource();u.set("state",t.ON)},_hide:function(){var n=this.editor,u=n.textarea,k=this.el;n._hideSource();n.setData(u.val());if(q.gecko&&n.iframeFocus){k.el[0].focus();n.focus()}k.set("state",t.OFF)}});s.SourceArea=A}();w.addPlugin(function(){new s.SourceArea(w)})});
KISSY.Editor.add("table",function(w,s){var B=KISSY.Editor,q=KISSY,t=q.Node,A=q.DOM,n=B.Walker,u=q.UA,k=B.NODE,f=B.TripleButton,g=B.SimpleOverlay,m=B.ContextMenu,z=["tr","th","td","tbody","table"],v=q.trim,l;l=(u.ie===6?["table.%2,","table.%2 td, table.%2 th,","{","border : #d3d3d3 1px dotted","}"]:[" table.%2,"," table.%2 > tr > td,  table.%2 > tr > th,"," table.%2 > tbody > tr > td,  table.%2 > tbody > tr > th,"," table.%2 > thead > tr > td,  table.%2 > thead > tr > th,"," table.%2 > tfoot > tr > td,  table.%2 > tfoot > tr > th",
"{","border : #d3d3d3 1px dotted","}"]).join("").replace(/%2/g,"ke_show_border");var p=w.htmlDataProcessor,a=p&&p.dataFilter;p=p&&p.htmlFilter;a&&a.addRules({elements:{table:function(d){d=d.attributes;var h=d["class"],i=parseInt(d.border,10);if(!i||i<=0)d["class"]=(h||"")+" ke_show_border"}}});p&&p.addRules({elements:{table:function(d){d=d.attributes;var h=d["class"];if(h)d["class"]=q.trim(h.replace("ke_show_border","").replace(/\s{2}/," "))}}});B.TableUI||function(){function d(x){this.editor=x;this.selectedTable=
null;x._toolbars=x._toolbars||{};x._toolbars.table=this;this._init()}function h(x){return v(x).length!=0}function i(x){function C($){if(!(N.length>0))if($[0].nodeType==k.NODE_ELEMENT&&D.test($._4e_name())&&!$._4e_getData("selected_cell")){$._4e_setMarker(M,"selected_cell",true);N.push($)}}for(var I=x.createBookmarks(),J=x.getRanges(),N=[],M={},Q=0;Q<J.length;Q++){var R=J[Q];if(R.collapsed){R=R.getCommonAncestor();(R=R._4e_ascendant("td",true)||R._4e_ascendant("th",true))&&N.push(R)}else{R=new n(R);
var W;for(R.guard=C;W=R.next();)if((W=W.parent())&&D.test(W._4e_name())&&!W._4e_getData("selected_cell")){W._4e_setMarker(M,"selected_cell",true);N.push(W)}}}B.Utils.clearAllMarkers(M);x.selectBookmarks(I);return N}function c(x){x=x.cells;for(var C=0;C<x.length;C++){x[C].innerHTML="";u.ie||(new t(x[C]))._4e_appendBogus()}}function j(x,C){if(x=x.getStartElement()._4e_ascendant("tr")){var I=x._4e_clone(true);I.insertBefore(x);c(C?I[0]:x[0])}}function b(x){if(x instanceof B.Selection){var C=i(x),I=C.length;
x=[];for(var J,N,M=0;M<I;M++){var Q=C[M].parent(),R=Q[0].rowIndex;!M&&(J=R-1);x[R]=Q;M==I-1&&(N=R+1)}M=Q._4e_ascendant("table");J=new t(N<M[0].rows.length&&M[0].rows[N]||J>0&&M[0].rows[J]||M[0].parentNode);for(M=x.length;M>=0;M--)x[M]&&b(x[M]);return J}else if(x instanceof t){M=x._4e_ascendant("table");M[0].rows.length==1?M._4e_remove():x._4e_remove()}return 0}function e(x,C){x=x.getStartElement();if(x=x._4e_ascendant("td",true)||x._4e_ascendant("th",true))for(var I=x._4e_ascendant("table"),J=x[0].cellIndex,
N=0;N<I[0].rows.length;N++){var M=I[0].rows[N];if(!(M.cells.length<J+1)){x=new t(M.cells[J].cloneNode(false));u.ie||x._4e_appendBogus();M=new t(M.cells[J]);C?x.insertBefore(M):x.insertAfter(M)}}}function o(x){var C=[],I=x[0]&&x[0]._4e_ascendant("table"),J,N,M,Q;J=0;for(N=x.length;J<N;J++)C.push(x[J][0].cellIndex);C.sort();J=1;for(N=C.length;J<N;J++)if(C[J]-C[J-1]>1){M=C[J-1]+1;break}M||(M=C[0]>0?C[0]-1:C[C.length-1]+1);x=I[0].rows;J=0;for(N=x.length;J<N;J++)if(Q=x[J].cells[M])break;return Q?new t(Q):
I._4e_previous()}function y(x){if(x instanceof B.Selection){var C=i(x),I=o(C);for(x=C.length-1;x>=0;x--)C[x]&&y(C[x]);return I}else if(x instanceof t){C=x._4e_ascendant("table");if(!C)return null;I=x[0].cellIndex;for(x=C[0].rows.length-1;x>=0;x--){var J=new t(C[0].rows[x]);if(!I&&J[0].cells.length==1)b(J);else J[0].cells[I]&&J[0].removeChild(J[0].cells[I])}}return null}function r(x,C){var I=new B.Range(x[0].ownerDocument);if(!I.moveToElementEditablePosition(x,C?true:s)){I.selectNodeContents(x);I.collapse(C?
false:true)}I.select(true)}q.augment(d,{_init:function(){var x=this.editor,C={};this.el=new f({contentCls:"ke-toolbar-table",title:"\u8868\u683c",container:x.toolBarDiv});this.el.on("offClick",this._tableShow,this);for(var I in H)(function(J){C[J]=function(){x.fire("save");H[J](x);x.fire("save")}})(I);m.register(x.document,{rules:z,width:"120px",funcs:C});B.Utils.lazyRun(this,"_prepareTableShow","_realTableShow")},_tableInit:function(){var x=this,C=new g({width:"350px",mask:true,title:"\u7f16\u8f91\u8868\u683c"});
C.body.html("<table class='ke-table-config'><tr><td><label>\u884c\u6570\uff1a <input value='2' class='ke-table-rows ke-table-create-only' size='8'/></label></td><td><label>\u5bbd\u5ea6\uff1a <input value='200' class='ke-table-width' size='8'/></label> <select class='ke-table-width-unit'><option value='px'>\u50cf\u7d20</option><option value='%'>\u767e\u5206\u6bd4</option></select></td></tr><tr><td><label>\u5217\u6570\uff1a <input class='ke-table-cols ke-table-create-only' value='3' size='8'/></label></td><td><label>\u9ad8\u5ea6\uff1a <input value='' class='ke-table-height' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td><label>\u5bf9\u9f50\uff1a <select class='ke-table-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option><option value='center'>\u4e2d\u95f4\u5bf9\u9f50</option></select></label></td><td><label>\u95f4\u8ddd\uff1a <input value='1' class='ke-table-cellspacing' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td><label>\u6807\u9898\u683c\uff1a <select class='ke-table-head ke-table-create-only'><option value=''>\u65e0</option><option value='1'>\u6709</option></select></td><td><label>\u8fb9\u8ddd\uff1a <input value='1' class='ke-table-cellpadding' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td></td><td><label>\u8fb9\u6846\uff1a <input value='1' class='ke-table-border' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td colspan='2'><label>\u6807\u9898\uff1a<input class='ke-table-caption' style='width:270px'></label></td></tr></table>");
C.foot.html("<button class='ke-table-ok'>\u786e\u5b9a</button> <button class='ke-table-cancel'>\u53d6\u6d88</button>");C.twidth=C.body.one(".ke-table-width");C.theight=C.body.one(".ke-table-height");C.tcellspacing=C.body.one(".ke-table-cellspacing");C.tcellpadding=C.body.one(".ke-table-cellpadding");C.tborder=C.body.one(".ke-table-border");C.tcaption=C.body.one(".ke-table-caption");C.talign=C.body.one(".ke-table-align");C.trows=C.body.one(".ke-table-rows");C.tcols=C.body.one(".ke-table-cols");C.thead=
C.body.one(".ke-table-head");var I=C.foot.one(".ke-table-ok"),J=C.foot.one(".ke-table-cancel");C.twidthunit=C.body.one(".ke-table-width-unit");x.tableDialog=C;I.on("click",x._tableOk,x);C.on("hide",function(){x.selectedTable=null});J.on("click",function(){C.hide()})},_tableOk:function(){this.selectedTable?this._modifyTable():this._genTable()},_modifyTable:function(){var x=this.tableDialog,C=this.selectedTable,I=C.one("caption");h(x.talign.val())&&C.attr("align",v(x.talign.val()));h(x.tcellspacing.val())&&
C.attr("cellspacing",v(x.tcellspacing.val()));h(x.tcellpadding.val())&&C.attr("cellpadding",v(x.tcellpadding.val()));h(x.tborder.val())&&C.attr("border",v(x.tborder.val()));!h(x.tborder.val())||x.tborder.val()=="0"?C.addClass("ke_show_border"):C.removeClass("ke_show_border");h(x.twidth.val())&&C.css("width",v(x.twidth.val())+x.twidthunit.val());h(x.theight.val())&&C.css("height",v(x.theight.val()));if(h(x.tcaption.val()))I&&I[0]?I.html(v(x.tcaption.val())):(new t("<caption><span>"+v(x.tcaption.val())+
"</span></caption>")).insertBefore(C[0].firstChild);else I&&I._4e_remove();x.hide()},_genTable:function(){var x=this.tableDialog,C="<table ",I,J=parseInt(x.tcols.val()),N=parseInt(x.trows.val()),M=u.ie?"":"<br/>",Q=this.editor;if(q.trim(x.talign.val()).length!=0)C+="align='"+q.trim(x.talign.val())+"' ";if(q.trim(x.tcellspacing.val()).length!=0)C+="cellspacing='"+q.trim(x.tcellspacing.val())+"' ";if(q.trim(x.tcellpadding.val()).length!=0)C+="cellpadding='"+q.trim(x.tcellpadding.val())+"' ";if(q.trim(x.tborder.val()).length!=
0)C+="border='"+q.trim(x.tborder.val())+"' ";if(q.trim(x.twidth.val()).length!=0||q.trim(x.theight.val()).length!=0){C+="style='";if(q.trim(x.twidth.val()).length!=0)C+="width:"+q.trim(x.twidth.val())+x.twidthunit.val()+";";if(q.trim(x.theight.val()).length!=0)C+="height:"+q.trim(x.theight.val())+"px;";C+="' "}if(q.trim(x.tborder.val()).length==0||q.trim(x.tborder.val())=="0")C+="class='ke_show_border' ";C+=">";if(q.trim(x.tcaption.val()))C+="<caption><span>"+q.trim(x.tcaption.val())+"</span></caption>";
if(x.thead.val()){C+="<thead>";C+="<tr>";for(I=0;I<J;I++)C+="<th>"+M+"</th>";C+="</tr>";C+="</thead>"}C+="<tbody>";for(var R=0;R<N;R++){C+="<tr>";for(I=0;I<J;I++)C+="<td>"+M+"</td>";C+="</tr>"}C+="</tbody>";C+="</table>";C=new t(C,null,Q.document);Q.insertElement(C);x.hide()},_fillTableDialog:function(){var x=this.tableDialog,C=this.selectedTable,I=C.one("caption");x.talign.val(C.attr("align")||"");x.tcellspacing.val(C.attr("cellspacing")||"");x.tcellpadding.val(C.attr("cellpadding")||"");x.tborder.val(C.attr("border")|
"");var J=C._4e_style("width")||"";x.twidth.val(J.replace(/px|%/i,""));J.indexOf("%")!=-1?x.twidthunit.val("%"):x.twidthunit.val("px");x.theight.val((C._4e_style("height")||"").replace(/px|%/i,""));J="";if(I)J=I.text();x.tcaption.val(J);x.trows.val(C.one("tbody").children().length);x.tcols.val(C.one("tr").children().length);x.thead.val(C._4e_first(function(N){return N._4e_name()=="thead"})?"1":"")},_realTableShow:function(){if(this.selectedTable){this._fillTableDialog();this.tableDialog.body.all(".ke-table-create-only").attr("disabled",
"disabled")}else this.tableDialog.body.all(".ke-table-create-only").removeAttr("disabled");this.tableDialog.show()},_prepareTableShow:function(){this._tableInit()},_tableShow:function(){this._prepareTableShow()}});var D=/^(?:td|th)$/,H={"\u8868\u683c\u5c5e\u6027":function(x){var C=x.getSelection();if(C=(C=C&&C.getStartElement())&&C._4e_ascendant("table",true)){x=x._toolbars.table;x.selectedTable=C;x._tableShow()}},"\u5220\u9664\u8868\u683c":function(x){var C=(x=x.getSelection())&&x.getStartElement();
if(C=C&&C._4e_ascendant("table",true)){x.selectElement(C);var I=x.getRanges()[0];I.collapse();x.selectRanges([I]);x=C.parent();x[0].childNodes.length==1&&x._4e_name()!="body"?x._4e_remove():C._4e_remove()}},"\u5220\u9664\u884c ":function(x){x=x.getSelection();r(b(x),s)},"\u5220\u9664\u5217 ":function(x){x=x.getSelection();(x=y(x))&&r(x,true)},"\u5728\u4e0a\u65b9\u63d2\u5165\u884c":function(x){x=x.getSelection();j(x,true)},"\u5728\u4e0b\u65b9\u63d2\u5165\u884c":function(x){x=x.getSelection();j(x,s)},
"\u5728\u5de6\u4fa7\u63d2\u5165\u5217":function(x){x=x.getSelection();e(x,true)},"\u5728\u53f3\u4fa7\u63d2\u5165\u5217":function(x){x=x.getSelection();e(x,s)}};B.TableUI=d}();w.addPlugin(function(){var d=w.document;new B.TableUI(w);var h=A.create("<style>",null,d);d.getElementsByTagName("head")[0].appendChild(h);if(h.styleSheet)h.styleSheet.cssText=l;else h.appendChild(d.createTextNode(l))})});
KISSY.Editor.add("templates",function(w){var s=KISSY.Editor,B=KISSY,q=B.Node,t=s.TripleButton,A=s.SimpleOverlay;s.TplUI||function(){function n(u){this.editor=u;this._init()}B.augment(n,{_init:function(){(new t({container:this.editor.toolBarDiv,contentCls:"ke-toolbar-template",title:"\u6a21\u677f"})).on("click",this._show,this);s.Utils.lazyRun(this,"_prepare","_real")},_prepare:function(){for(var u=this.editor,k=u.cfg.pluginConfig.templates,f="<div class='ke-tpl'>",g=0;g<k.length;g++)f+="<a href='javascript:void(0)' class='ke-tpl-list' tabIndex='-1'>"+
k[g].demo+"</a>";f+="</div>";this._initDialogOk=true;var m=new A({mask:true,title:"\u5185\u5bb9\u6a21\u677f"});m.body.html(f);m.body.all(".ke-tpl-list").on("click",function(z){z.halt();z=(new q(z.target))._4e_index();z!=-1&&u.insertHtml(k[z].html);m.hide()});this.ui=m},_real:function(){this.ui.show()},_show:function(){this._prepare()}});s.TplUI=n}();w.addPlugin(function(){new s.TplUI(w)})});
KISSY.Editor.add("undo",function(w){var s=KISSY.Editor,B=KISSY,q=s.Utils.arrayCompare,t=B.UA,A=B.Event;s.UndoManager||function(){function n(l){var p=l._getRawData();l=p&&l.getSelection();this.contents=p;this.bookmarks=l&&l.createBookmarks2(true)}function u(l,p,a){this.s=l;this.fn=p;this.scope=a||window;this.bufferTimer=null}function k(l){this.history=[];this.index=0;this.editor=l;this.bufferTimer=new u(500,this.save,this);this._init()}function f(l,p,a,d){this.editor=l;this.title=a;this.text=p;this.contentCls=
d;this._init()}B.augment(n,{equals:function(l){if(this.contents!=l.contents)return false;var p=this.bookmarks;l=l.bookmarks;if(p||l){if(!p||!l||p.length!=l.length)return false;for(var a=0;a<p.length;a++){var d=p[a],h=l[a];if(d.startOffset!=h.startOffset||d.endOffset!=h.endOffset||!q(d.start,h.start)||!q(d.end,h.end))return false}}return true}});B.augment(u,{run:function(){if(this.bufferTimer){clearTimeout(this.bufferTimer);this.bufferTimer=null}var l=this;this.bufferTimer=setTimeout(function(){l.fn.call(l.scope)},
this.s)}});var g={16:1,17:1,18:1},m={37:1,38:1,39:1,40:1};B.augment(k,{_keyMonitor:function(){var l=this.editor;A.on(l.document,"keydown",function(p){var a=p.keyCode;if(!(a in m||a in g))if(a===90&&(p.ctrlKey||p.metaKey)){l.fire("restore",{d:-1});p.halt()}else if(a===89&&(p.ctrlKey||p.metaKey)){l.fire("restore",{d:1});p.halt()}else l.fire("save",{buffer:1})})},_init:function(){var l=this,p=l.editor;p.on("save",function(a){a.buffer?l.bufferTimer.run():l.save()});p.on("restore",this.restore,this);l._keyMonitor()},
save:function(){this.history.length>this.index+1&&this.history.splice(this.index+1,this.history.length-this.index-1);var l=this.editor,p=this.history.length>0?this.history[this.history.length-1]:null,a=new n(this.editor);if(!p||!p.equals(a)){this.history.length===30&&this.history.shift();this.history.push(a);this.index=this.history.length-1;l.fire("afterSave",{history:this.history,index:this.index})}},restore:function(l){l=l.d;var p=this.editor,a=this.history.length>0?this.history[this.index+l]:null;
if(a){p._setRawData(a.contents);if(a.bookmarks)this.editor.getSelection().selectBookmarks(a.bookmarks);else if(t.ie){a=this.editor.document.body.createTextRange();a.collapse(true);a.select()}this.index+=l;p.fire("afterRestore",{history:this.history,index:this.index});p.notifySelectionChange()}}});var z=s.TripleButton,v={redo:1,undo:-1};B.augment(f,{_init:function(){var l=this,p=l.editor;l.el=new z({contentCls:l.contentCls,title:l.title,container:p.toolBarDiv});this.el.set("state",z.DISABLED);p.on("afterSave",
this._respond,this);p.on("afterRestore",this._respond,this);l.el.on("offClick",function(){p.fire("restore",{d:v[l.text]})})},_respond:function(l){this.updateUI(l.history,l.index)},updateUI:function(l,p){if(this.text=="undo")p>0&&l.length>0?this.el.set("state",z.OFF):this.el.set("state",z.DISABLED);else if(this.text=="redo")p<l.length-1?this.el.set("state",z.OFF):this.el.set("state",z.DISABLED)}});s.UndoManager=k;s.RestoreUI=f}();w.addPlugin(function(){new s.UndoManager(w);new s.RestoreUI(w,"undo",
"\u64a4\u9500","ke-toolbar-undo");new s.RestoreUI(w,"redo","\u91cd\u505a","ke-toolbar-redo")})});
