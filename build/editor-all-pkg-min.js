KISSY.add("editor",function(w,q){function z(s,a){var b=this;if(!(b instanceof z))return new z(s,a);if(w.isString(s))s=w.one(s);s[0]||(s=new Node(s));b.cfg=a;w.app(b,w.EventTarget);b.use=function(h){w.use.call(b,h,function(){b.on("dataReady",function(){b.setData(s.val())})},{order:true,global:z})};b.init(s);return q}function p(s){if(!v)return"build/"+s.replace(/\.(js|css)/i,"-min.$1");if(v==="dev")return s;return"build/"+s}w.app(z,w.EventTarget);z.Config.base=w.Config.base+"editor/";var v=w.Config.debug,
B={htmlparser:{attach:false,path:p("plugins/htmldataprocessor/htmlparser/htmlparser.js")}},l=["utils","focusmanager","definition","dtd","dom","elementpath","walker","range","domiterator","selection","styles"],y=["clipboard",{name:"color",useCss:true},{name:"elementpaths",useCss:true},"enterkey","fakeobjects",{name:"flash",requires:["contextmenu","fakeobjects","overlay"]},"font","format",{name:"htmldataprocessor",requires:["htmlparser-text"]},{name:"image",requires:["overlay"]},"indent","justify",
"link","list","maximize","music","preview","removeformat",{name:"smiley",useCss:true},"sourcearea",{name:"table",useCss:true,requires:["overlay","contextmenu"]},{name:"templates",requires:["overlay"],useCss:true},"undo"],i=[{name:"htmlparser-basicwriter",requires:["htmlparser"]},{name:"htmlparser-element",requires:["htmlparser-fragment"]},{name:"htmlparser-filter",requires:["htmlparser-element"]},{name:"htmlparser-fragment",requires:["htmlparser-htmlwriter"]},{name:"htmlparser-htmlwriter",requires:["htmlparser-basicwriter"]},
{name:"htmlparser-text",requires:["htmlparser-filter"]}],g=[{name:"button"},{name:"overlay",useCss:true},{name:"contextmenu",requires:["overlay"],useCss:true}],j,k,r,u,m;j=0;for(k=g.length;j<k;j++){u=r=g[j];m=q;if(!w.isString(r)){m=r.requires;u=r.name}B[u]={attach:false,requires:m,path:p("ui/"+u+".js"),csspath:r.useCss?p("ui/"+u+".css"):""}}j=0;for(k=y.length;j<k;j++){u=r=y[j];m=["button"];if(!w.isString(r)){r.requires&&(m=m.concat(r.requires));u=r.name}B[u]={attach:false,requires:m,csspath:r.useCss?
p("plugins/"+u+"/plugin.css"):q,path:p("plugins/"+u+"/plugin.js")}}j=0;for(k=i.length;j<k;j++){r=i[j];m=q;if(!w.isString(r)){m=r.requires;r=r.name}B[r]={attach:false,requires:m,path:p("plugins/htmldataprocessor/htmlparser/"+r.substring(11)+".js")}}z.add(B);B={};j=0;for(k=l.length;j<k;j++){r=l[j];B[r]={host:"editor",requires:j>0?l[j-1]:[]}}z.add(B);w.Editor=z});
KISSY.Editor.add("utils",function(w){var q=KISSY,z=q.Node,p=q.DOM,v=q.Config.debug,B=q.UA;w.Utils={getFlashUrl:function(l){var y="",i=w.NODE;if(l._4e_name()=="object"){l=l[0].childNodes;for(var g=0;g<l.length;g++)if(l[g].nodeType==i.NODE_ELEMENT)if((p.attr(l[g],"name")||"").toLowerCase()=="movie")y=p.attr(l[g],"value");else if(p._4e_name(l[g])=="embed")y=p.attr(l[g],"src");else p._4e_name(l[g])=="object"&&p.attr(l[g],"data")}else if(l._4e_name()=="embed")y=l.attr("src");return y},debugUrl:function(l){if(!v)return"build/"+
l.replace(/\.(js|css)/i,"-min.$1");if(v==="dev")return l;return"build/"+l},lazyRun:function(l,y,i){var g=l[y],j=l[i];l[y]=function(){g.apply(this,arguments);l[y]=l[i];return j.apply(this,arguments)}},getXY:function(l,y,i,g){i=i.defaultView||i.parentWindow;l-=p.scrollLeft(i);y-=p.scrollTop(i);if(g)if(i!=(g.defaultView||g.parentWindow)&&i.frameElement){g=p._4e_getOffset(i.frameElement,g);l+=g.left;y+=g.top}return{left:l,top:y}},tryThese:function(){for(var l,y=0,i=arguments.length;y<i;y++){var g=arguments[y];
try{l=g();break}catch(j){}}return l},arrayCompare:function(l,y){if(!l&&!y)return true;if(!l||!y||l.length!=y.length)return false;for(var i=0;i<l.length;i++)if(l[i]!==y[i])return false;return true},getByAddress:function(l,y,i){l=l.documentElement;for(var g=0;l&&g<y.length;g++){var j=y[g];if(i)for(var k=-1,r=0;r<l.childNodes.length;r++){var u=l.childNodes[r];if(!(i===true&&u.nodeType==3&&u.previousSibling&&u.previousSibling.nodeType==3)){k++;if(k==j){l=u;break}}}else l=l.childNodes[j]}return l?new z(l):
null},clearAllMarkers:function(l){for(var y in l)l[y]._4e_clearMarkers(l,true)},htmlEncodeAttr:function(l){return l.replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/,"&gt;")},ltrim:function(l){return l.replace(/^\s+/,"")},rtrim:function(l){return l.replace(/\s+$/,"")},trim:function(l){return this.ltrim(this.rtrim(l))},mix:function(){for(var l={},y=0;y<arguments.length;y++)l=q.mix(l,arguments[y]);return l},isCustomDomain:function(){if(!B.ie)return false;var l=document.domain,y=window.location.hostname;
return l!=y&&l!="["+y+"]"}}});
KISSY.Editor.add("focusmanager",function(w){function q(){this.iframeFocus=true;y=this}function z(){this.iframeFocus=false;y=null}var p=KISSY,v=p.DOM,B=p.Event;p={};var l={},y;p={refreshAll:function(){for(var i in l){var g=l[i];g.document.designMode="off";g.document.designMode="on"}},currentInstance:function(){return y},getInstance:function(i){return l[i]},add:function(i){var g=v._4e_getWin(i.document);B.on(g,"focus",q,i);B.on(g,"blur",z,i)},register:function(i){l[i._UUID]=i},remove:function(i){delete l[i._UUID];
var g=v._4e_getWin(i.document);B.remove(g,"focus",q,i);B.remove(g,"blur",z,i)}};w.focusManager=p});
KISSY.Editor.add("definition",function(w){function q(m){return g+"<html><head><title>kissy-editor</title><link href='"+w.Config.base+j+"' rel='stylesheet'/></head><body class='ke-editor'>&nbsp;</body><html>"+(m?'<script id="ke_actscrpt" type="text/javascript">'+(w.Utils.isCustomDomain()?'document.domain="'+document.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+m+'");<\/script>':"")}var z=KISSY,p=z.UA,v=z.DOM,B=z.Node,l=z.Event,y=w.focusManager,i=w.Utils.tryThese,g="<!doctype html>",j=
w.Utils.debugUrl("assets/editor-iframe.css"),k=1,r="document.open();"+(w.Utils.isCustomDomain()?'document.domain="'+document.domain+'";':"")+"document.close();",u="<div  class='ke-editor-wrap'  > <div class='"+".ke-editor-tools".substring(1)+"'></div><div class='"+".ke-textarea-wrap".substring(1)+'\'><iframe  style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor"  src="'+(p.ie?"javascript:void(function(){"+encodeURIComponent(r)+"}())":"")+'"  tabIndex="'+
(p.webkit?-1:"$(tabIndex)")+'"  allowTransparency="true" ></iframe></div><div class=\''+".ke-editor-status".substring(1)+"'></div></div>";z.augment(w,{init:function(m){var s=this,a=new B(u.replace(/\$\(tabIndex\)/,m.attr("tabIndex")));a.on("mousedown",function(d){if(p.webkit){var f=v._4e_name(d.target);if(f=="select"||f=="option")return true}d.halt()});s.editorWrap=a;s._UUID=k++;y.register(s);s.wrap=a.one(".ke-textarea-wrap");s.iframe=s.wrap.one("iframe");s.toolBarDiv=a.one(".ke-editor-tools");s.textarea=
m;s.statusDiv=a.one(".ke-editor-status");s.toolBarDiv._4e_unselectable();s._commands={};s._plugins={};var b=m._4e_style("width"),h=m._4e_style("height");if(b){a.css("width",b);m.css("width","100%")}s.textarea.css("display","none");a.insertAfter(m);s.wrap[0].appendChild(m[0]);if(h){s.wrap.css("height",h);m.css("height","100%")}m=s.iframe;s.on("dataReady",function(){s.ready=true;w.fire("instanceCreated",{editor:s})});p.gecko?m.on("load",s._setUpIFrame,s):s._setUpIFrame()},addCommand:function(m,s){this._commands[m]=
s},execCommand:function(m){this.fire("save");this._commands[m].exec(this);this.fire("save")},getData:function(){if(w.HtmlDataProcessor)return w.HtmlDataProcessor.toHtml(this.document.body.innerHTML,"p");return this.document.body.innerHTML},setData:function(m){if(w.HtmlDataProcessor)m=w.HtmlDataProcessor.toDataFormat(m,"p");this.document.body.innerHTML=m},sync:function(){this.textarea.val(this.getData())},_getRawData:function(){return this.document.body.innerHTML},_setRawData:function(m){this.document.body.innerHTML=
m},_hideSource:function(){this.iframe.css("display","");this.textarea.css("display","none");this.toolBarDiv.children().css("visibility","");this.statusDiv.children().css("visibility","")},_showSource:function(){this.textarea.css("display","");this.iframe.css("display","none");this.toolBarDiv.children().css("visibility","hidden");this.toolBarDiv.all(".ke-tool-editor-source").css("visibility","");this.statusDiv.children().css("visibility","hidden");p.ie<8&&this.textarea.css("height",this.wrap.css("height"))},
_prepareIFrameHtml:q,getSelection:function(){var m=new w.Selection(this.document);return!m||m.isInvalid?null:m},focus:function(){var m=v._4e_getWin(this.document);p.webkit&&m&&m.parent&&m.parent.focus();m&&m.focus();this.document&&this.document.body.focus();this.notifySelectionChange()},blur:function(){v._4e_getWin(this.document).blur();this.document&&this.document.body.blur()},_setUpIFrame:function(){function m(){d=h.document;s.document=d;a.detach();d.open("text/html","replace");d.write(b);d.close()}
var s=this,a=s.iframe,b=q(s._UUID),h=a[0].contentWindow,d;try{d=h.document}catch(f){a[0].src=a[0].src;if(p.ie&&p.ie<7){setTimeout(m,10);return}}m()},addPlugin:function(m){this.ready?m():this.on("dataReady",m)},_monitor:function(){var m=this;m._monitorId&&clearTimeout(m._monitorId);m._monitorId=setTimeout(function(){var s=m.getSelection();if(s&&!s.isInvalid){s=s.getStartElement();var a=new w.ElementPath(s);if(!m.previousPath||!m.previousPath.compare(a)){m.previousPath=a;m.fire("selectionChange",{selection:m,
path:a,element:s})}}},200)},notifySelectionChange:function(){this.previousPath=null;this._monitor()},insertElement:function(m){var s=this;s.focus();var a=m._4e_name(),b=w.XHTML_DTD,h=w.RANGE,d=w.NODE,f=b.$block[a],o=s.getSelection(),c=o.getRanges(),e,n,A,t,C;s.fire("save");for(var I=c.length-1;I>=0;I--){e=c[I];e.deleteContents();n=!I&&m||m._4e_clone(true);if(f)for(;(t=e.getCommonAncestor(false,true))&&(C=b[t._4e_name()])&&!(C&&C[a]);)if(t._4e_name()in b.span)e.splitElement(t);else if(e.checkStartOfBlock()&&
e.checkEndOfBlock()){e.setStartBefore(t);e.collapse(true);t._4e_remove()}else e.splitBlock();e.insertNode(n);A||(A=n)}e.moveToPosition(A,h.POSITION_AFTER_END);(m=A._4e_nextSourceNode(true))&&m.type==d.NODE_ELEMENT&&e.moveToElementEditablePosition(m);o.selectRanges([e]);s.focus();n&&n._4e_scrollIntoView();setTimeout(function(){s.fire("save")},10)},insertHtml:function(m){if(w.HtmlDataProcessor)m=w.HtmlDataProcessor.toDataFormat(m);if(p.webkit){m=v.create(m,null,this.document);m=m.nodeType==11?z.makeArray(m.childNodes):
[m];for(var s=0;s<m.length;s++)this.insertElement(new B(m[s]))}else{var a=this;a.focus();a.fire("save");s=a.getSelection();if(p.ie){s=s.getNative();s.type=="Control"&&s.clear();s.createRange().pasteHTML(m)}else a.document.execCommand("inserthtml",false,m);a.focus();setTimeout(function(){a.fire("save")},10)}}});w._initIFrame=function(m){function s(t){i(function(){h.designMode="on";setTimeout(function(){h.designMode="off";f.focus();if(!arguments.callee.retry)arguments.callee.retry=true},50)},function(){h.designMode=
"off";v.attr(f,"contentEditable",false);v.attr(f,"contentEditable",true);!t&&s(1)})}var a=y.getInstance(m);m=a.textarea[0];var b=a.iframe[0].contentWindow,h=a.document,d=h.getElementById("ke_actscrpt");d.parentNode.removeChild(d);var f=h.body;if(p.ie){f.hideFocus=true;f.disabled=true;f.contentEditable=true;f.removeAttribute("disabled")}else setTimeout(function(){if(p.gecko||p.opera)f.contentEditable=true;else if(p.webkit)f.parentNode.contentEditable=true;else h.designMode="on"},0);try{h.execCommand("enableObjectResizing",
false,true)}catch(o){}try{h.execCommand("enableInlineTableEditing",false,true)}catch(c){}p.webkit&&l.on(h,"mousedown",function(t){t=new B(t.target);z.inArray(t._4e_name(),["img","hr","input","textarea","select"])&&a.getSelection().selectElement(t)});if(p.webkit){l.on(h,"click",function(t){var C=new B(t.target);z.inArray(C._4e_name(),["input","select"])&&t.preventDefault()});l.on(h,"mouseup",function(t){var C=new B(t.target);z.inArray(C._4e_name(),["input","textarea"])&&t.preventDefault()})}if(p.gecko||
p.ie||p.opera){var e;e=new B(v.insertAfter((new B('<span style="position:absolute; left:-10000"></span>'))[0],m));e.on("focus",function(){a.focus()});a.on("destroy",function(){})}if(p.ie&&h.compatMode=="CSS1Compat"||p.gecko||p.opera){var n=new B(h.documentElement);n.on("mousedown",function(t){if(t.target===n[0]){p.gecko&&s(false);e[0].focus()}})}l.on(b,"focus",function(){if(p.gecko)s(false);else p.opera&&f.focus();a.notifySelectionChange()});p.gecko&&l.on(a.document,"mousedown",function(){a.iframeFocus||
s(false)});if(p.ie){l.on(h,"keydown",function(t){if(t.keyCode in{8:1,46:1}){var C=a.getSelection(),I=C.getSelectedElement();if(I){a.fire("save");var x=C.getRanges()[0].createBookmark();I._4e_remove();C.selectBookmarks([x]);a.fire("save");t.preventDefault()}}});if(h.compatMode=="CSS1Compat"){var A={33:1,34:1};l.on(h,"keydown",function(t){t.keyCode in A&&setTimeout(function(){a.getSelection().scrollIntoView()},0)})}}setTimeout(function(){p.ie&&setTimeout(function(){if(h){f.runtimeStyle.marginBottom=
"0px";f.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){a.fire("dataReady")},10);y.add(a)};p.gecko&&function(){var m=document.body;if(m){var s=m.getAttribute("onpageshow");m.setAttribute("onpageshow",(s?s+";":"")+"event.persisted && KISSY.Editor.focusManager.refreshAll();")}else window.addEventListener("load",arguments.callee,false)}()});
KISSY.Editor.add("dtd",function(w){w.XHTML_DTD=function(){var q=function(o){for(var c=arguments.length-1;c>0;)KISSY.mix(o,arguments[c--]);return o},z={isindex:1,fieldset:1},p={input:1,button:1,select:1,textarea:1,label:1},v=q({a:1},p),B=q({iframe:1},v),l={hr:1,ul:1,menu:1,div:1,blockquote:1,noscript:1,table:1,center:1,address:1,dir:1,pre:1,h5:1,dl:1,h4:1,noframes:1,h6:1,ol:1,h1:1,h3:1,h2:1},y={ins:1,del:1,script:1,style:1},i=q({b:1,acronym:1,bdo:1,"var":1,"#":1,abbr:1,code:1,br:1,i:1,cite:1,kbd:1,
u:1,strike:1,s:1,tt:1,strong:1,q:1,samp:1,em:1,dfn:1,span:1},y),g=q({sub:1,img:1,object:1,sup:1,basefont:1,map:1,applet:1,font:1,big:1,small:1},i),j=q({p:1},g);p=q({iframe:1},g,p);g={img:1,noscript:1,br:1,kbd:1,center:1,button:1,basefont:1,h5:1,h4:1,samp:1,h6:1,ol:1,h1:1,h3:1,h2:1,form:1,font:1,"#":1,select:1,menu:1,ins:1,abbr:1,label:1,code:1,table:1,script:1,cite:1,input:1,iframe:1,strong:1,textarea:1,noframes:1,big:1,small:1,span:1,hr:1,sub:1,bdo:1,"var":1,div:1,object:1,sup:1,strike:1,dir:1,map:1,
dl:1,applet:1,del:1,isindex:1,fieldset:1,ul:1,b:1,acronym:1,a:1,blockquote:1,i:1,u:1,s:1,tt:1,address:1,q:1,pre:1,p:1,em:1,dfn:1};var k=q({a:1},p),r={tr:1},u={"#":1},m=q({param:1},g),s=q({form:1},z,B,l,j),a={li:1},b={base:1,link:1,meta:1,title:1},h=q(b,{style:1,script:1}),d={head:1,body:1},f={address:1,blockquote:1,center:1,dir:1,div:1,dl:1,fieldset:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,isindex:1,menu:1,noframes:1,ol:1,p:1,pre:1,table:1,ul:1};return{$nonBodyContent:q({html:1},d,b),$block:f,
$blockLimit:{body:1,div:1,td:1,th:1,caption:1,form:1},$inline:k,$body:q({script:1,style:1},f),$cdata:{script:1,style:1},$empty:{area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},$listItem:{dd:1,dt:1,li:1},$list:{ul:1,ol:1,dl:1},$nonEditable:{applet:1,button:1,embed:1,iframe:1,map:1,object:1,option:1,script:1,textarea:1,param:1},$removeEmpty:{abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},$tabIndex:{a:1,area:1,button:1,input:1,object:1,select:1,textarea:1},$tableContent:{caption:1,col:1,colgroup:1,tbody:1,td:1,tfoot:1,th:1,thead:1,tr:1},html:d,head:h,style:u,body:s,base:{},link:{},meta:{},title:u,col:{},tr:{td:1,th:1},img:{},colgroup:{col:1},noscript:s,td:s,br:{},th:s,center:s,kbd:k,button:q(j,l),basefont:{},h5:k,h4:k,samp:k,h6:k,ol:a,h1:k,h3:k,option:u,h2:k,form:q(z,B,l,j),select:{optgroup:1,option:1},font:k,ins:k,menu:a,abbr:k,label:k,table:{thead:1,
col:1,tbody:1,tr:1,colgroup:1,caption:1,tfoot:1},code:k,script:u,tfoot:r,cite:k,li:s,input:{},iframe:s,strong:k,textarea:u,noframes:s,big:k,small:k,span:k,hr:{},dt:k,sub:k,optgroup:{option:1},param:{},bdo:k,"var":k,div:s,object:m,sup:k,dd:s,strike:k,area:{},dir:a,map:q({area:1,form:1,p:1},z,y,l),applet:m,dl:{dt:1,dd:1},del:k,isindex:{},fieldset:q({legend:1},g),thead:r,ul:a,acronym:k,b:k,a:p,blockquote:s,caption:k,i:k,u:k,tbody:r,s:k,address:q(B,j),tt:k,legend:k,q:k,pre:q(i,v),p:k,em:k,dfn:k}}()});
KISSY.Editor.add("dom",function(w){function q(a){return a.replace(/-(\w)/g,function(b,h){return h.toUpperCase()})}var z=KISSY,p=z.DOM,v=z.UA,B=z.Node,l=w.Utils,y={abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};w.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_DOCUMENT_FRAGMENT:11};w.POSITION={};var i=w.NODE,g=w.POSITION;g.POSITION_IDENTICAL=0;g.POSITION_DISCONNECTED=1;g.POSITION_FOLLOWING=
2;g.POSITION_PRECEDING=4;g.POSITION_IS_CONTAINED=8;g.POSITION_CONTAINS=16;var j={},k={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},r={hr:1},u=function(a){return a[0]||a},m=function(a){if(!a[0])return new B(a);return a},s={_4e_equals:function(a,b){if(!a&&!b)return true;if(!a||!b)return false;a=u(a);b=u(b);return a===b},_4e_isBlockBoundary:function(a,b){a=m(a);b=
z.mix(z.mix({},r),b||{});return k[a.css("display")]||b[a._4e_name()]},_4e_getWin:function(a){return a&&"scrollTo"in a&&a.document?a:a&&a.nodeType===9?a.defaultView||a.parentWindow:false},_4e_index:function(a){a=u(a);for(var b=a.parentNode.childNodes,h=0;h<b.length;h++)if(b[h]===a)return h;return-1},_4e_first:function(a,b){a=u(a);if((a=(a=a.firstChild)&&new B(a))&&b&&!b(a))a=a._4e_next(b);return a},_4e_move:function(a,b,h){a._4e_remove();a=u(a);b=u(b);h?b.insertBefore(a,b.firstChild):b.appendChild(a)},
_4e_name:function(a){a=u(a);var b=a.nodeName.toLowerCase();if(v.ie)if((a=a.scopeName)&&a!="HTML")b=a.toLowerCase()+":"+b;return b},_4e_isIdentical:function(a,b){if(a._4e_name()!=b._4e_name())return false;var h=a[0].attributes,d=b[0].attributes,f=h.length,o=d.length;if(!v.ie&&f!=o)return false;for(var c=0;c<f;c++){var e=h[c];if((!v.ie||e.specified&&e.nodeName!="_ke_expando")&&e.nodeValue!=b.attr(e.nodeName))return false}if(v.ie)for(c=0;c<o;c++){e=d[c];if(e.specified&&e.nodeName!="_ke_expando"&&e.nodeValue!=
a.attr(e.nodeName))return false}return true},_4e_isEmptyInlineRemoveable:function(a){a=u(a).childNodes;for(var b=0,h=a.length;b<h;b++){var d=a[b],f=d.nodeType;if(!(f==i.NODE_ELEMENT&&d.getAttribute("_ke_bookmark")))if(f==i.NODE_ELEMENT&&!s._4e_isEmptyInlineRemoveable(d)||f==i.NODE_TEXT&&z.trim(d.nodeValue))return false}return true},_4e_moveChildren:function(a,b,h){a=u(a);b=b[0]||b;if(a!=b)if(h)for(;h=a.lastChild;)b.insertBefore(a.removeChild(h),b.firstChild);else for(;h=a.firstChild;)b.appendChild(a.removeChild(h))},
_4e_mergeSiblings:function(){function a(b,h,d){if(h[0]&&h[0].nodeType==i.NODE_ELEMENT){for(var f=[];h.attr("_ke_bookmark")||h._4e_isEmptyInlineRemoveable();){f.push(h);h=d?new B(h[0].nextSibling):new B(h[0].previousSibling);if(!h[0]||h[0].nodeType!=i.NODE_ELEMENT)return}if(b._4e_isIdentical(h)){for(var o=d?b[0].lastChild:b[0].firstChild;f.length;)f.shift()._4e_move(b,!d);h._4e_moveChildren(b,!d);h._4e_remove();o[0]&&o[0].nodeType==i.NODE_ELEMENT&&o._4e_mergeSiblings()}}}return function(b){if(b[0])if(y[b._4e_name()]||
b._4e_name()=="a"){a(b,new B(b[0].nextSibling),true);a(b,new B(b[0].previousSibling))}}}(),_4e_unselectable:v.gecko?function(a){a=u(a);a.style.MozUserSelect="none"}:v.webkit?function(a){a=u(a);a.style.KhtmlUserSelect="none"}:function(a){a=u(a);if(v.ie||v.opera){var b,h=0;for(a.unselectable="on";b=a.all[h++];)switch(b.tagName.toLowerCase()){case "iframe":case "textarea":case "input":case "select":break;default:b.unselectable="on"}}},_4e_getOffset:function(a,b){a=u(a);var h,d=0;h=0;var f=a.ownerDocument.defaultView||
a.ownerDocument.parentWindow,o=a.ownerDocument,c=o.documentElement;if(a.getBoundingClientRect){if(a!==o.body&&c!==a){h=a.getBoundingClientRect();d=h.left+p.scrollLeft(f);h=h.top+p.scrollTop(f)}if(b)if(f!=(b.defaultView||b.parentWindow)&&f.frameElement){b=s._4e_getOffset(f.frameElement,b);d+=b.left;h+=b.top}}return{left:d,top:h}},_4e_getFrameDocument:function(a){return(a=u(a))&&a.contentWindow.document},_4e_splitText:function(a,b){a=u(a);var h=a.ownerDocument;if(!(!a||a.nodeType!=i.NODE_TEXT)){if(v.ie&&
b==a.nodeValue.length){h=h.createTextNode("");p.insertAfter(h,a);return h}a=new B(a.splitText(b));if(v.ie==8){h=h.createTextNode("");p.insertAfter(h,a[0]);h.parentNode.removeChild(h)}return a}},_4e_parents:function(a,b){a=m(a);var h=[];do h[b?"push":"unshift"](a);while(a=a.parent());return h},_4e_clone:function(a,b,h){a=u(a);a=a.cloneNode(b);if(!h){var d=function(f){if(f.nodeType==i.NODE_ELEMENT){f.removeAttribute("id",false);f.removeAttribute("_ke_expando",false);f=f.childNodes;for(var o=0;o<f.length;o++)d(f[o])}};
d(a)}return new B(a)},_4e_nextSourceNode:function(a,b,h,d){a=u(a);if(d&&!d.call){var f=d[0]||d;d=function(c){c=c[0]||c;return c!==f}}b=!b&&a.firstChild;var o=new B(a);if(!b){if(a.nodeType==i.NODE_ELEMENT&&d&&d(this,true)===false)return null;b=a.nextSibling}for(;!b&&(o=o.parent());){if(d&&d(o,true)===false)return null;b=o[0].nextSibling}if(!b)return null;b=new B(b);if(d&&d(b)===false)return null;if(h&&h!=b[0].nodeType)return b._4e_nextSourceNode(false,h,d);return b},_4e_previousSourceNode:function(a,
b,h,d){a=u(a);if(d&&!d.call){var f=d[0]||d;d=function(c){c=c[0]||c;return c!==f}}b=!b&&a.lastChild;var o=new B(a);if(!b){if(a.nodeType==i.NODE_ELEMENT&&d&&d(a,true)===false)return null;b=a.previousSibling}for(;!b&&(o=o.parent());){if(d&&d(o,true)===false)return null;b=o[0].previousSibling}if(!b)return null;b=new B(b);if(d&&d(b)===false)return null;if(h&&b[0].nodeType!=h)return b._4e_previousSourceNode(false,h,d);return b},_4e_contains:v.ie||v.webkit?function(a,b){a=u(a);b=u(b);return b.nodeType!=
i.NODE_ELEMENT?a.contains(b.parentNode):a!=b&&a.contains(b)}:function(a,b){a=u(a);b=u(b);return!!(a.compareDocumentPosition(b)&16)},_4e_commonAncestor:function(a,b){if(a._4e_equals(b))return a;if(b[0].nodeType!=i.NODE_TEXT&&b._4e_contains(a))return b;a=a[0].nodeType==i.NODE_TEXT?a.parent():a;do if(a[0].nodeType!=i.NODE_TEXT&&a._4e_contains(b))return a;while(a=a.parent());return null},_4e_ascendant:function(a,b,h){a=u(a);if(!h)a=a.parentNode;if(b&&!z.isFunction(b)){var d=b;b=function(f){return f._4e_name()==
d}}for(;a&&a.nodeType!=9;){if(!b||b(new B(a))===true)return new B(a);a=a.parentNode}return null},_4e_hasAttribute:function(a,b){a=u(a);a=a.attributes.getNamedItem(b);return!!(a&&a.specified)},_4e_hasAttributes:v.ie?function(a){a=u(a);for(var b=a.attributes,h=0;h<b.length;h++){var d=b[h];switch(d.nodeName){case "class":if(a.getAttribute("class"))return true;break;case "_ke_expando":continue;default:if(d.specified)return true}}return false}:function(a){a=u(a);v.gecko&&a.removeAttribute("_moz_dirty");
a=a.attributes;return a.length>1||a.length==1&&a[0].nodeName!="_ke_expando"},_4e_position:function(a,b){var h=u(a),d=u(b);if(h.compareDocumentPosition)return h.compareDocumentPosition(d);if(h==d)return g.POSITION_IDENTICAL;if(h.nodeType==i.NODE_ELEMENT&&d.nodeType==i.NODE_ELEMENT){if(h.contains){if(h.contains(d))return g.POSITION_CONTAINS+g.POSITION_PRECEDING;if(d.contains(h))return g.POSITION_IS_CONTAINED+g.POSITION_FOLLOWING}if("sourceIndex"in h)return h.sourceIndex<0||d.sourceIndex<0?g.POSITION_DISCONNECTED:
h.sourceIndex<d.sourceIndex?g.POSITION_PRECEDING:g.POSITION_FOLLOWING}a=a._4e_address();b=b._4e_address();h=Math.min(a.length,b.length);for(d=0;d<=h-1;d++)if(a[d]!=b[d]){if(d<h)return a[d]<b[d]?g.POSITION_PRECEDING:g.POSITION_FOLLOWING;break}return a.length<b.length?g.POSITION_CONTAINS+g.POSITION_PRECEDING:g.POSITION_IS_CONTAINED+g.POSITION_FOLLOWING},_4e_address:function(a,b){a=u(a);var h=[],d=a.ownerDocument.documentElement;for(a=a;a&&a!=d;){var f=a.parentNode,o=-1;if(f){for(var c=0;c<f.childNodes.length;c++){var e=
f.childNodes[c];if(!(b&&e.nodeType==3&&e.previousSibling&&e.previousSibling.nodeType==3)){o++;if(e==a)break}}h.unshift(o)}a=f}return h},_4e_breakParent:function(a,b){var h=new w.Range(a[0].ownerDocument);h.setStartAfter(a);h.setEndAfter(b);b=h.extractContents();h.insertNode(a._4e_remove());a[0].parentNode.insertBefore(b,a[0].nextSibling)},_4e_style:function(a,b,h){if(h!==undefined)return a.css(b,h);a=a[0]||a;return a.style[q(b)]},_4e_remove:function(a,b){var h=u(a),d=h.parentNode;if(d){if(b)for(;b=
h.firstChild;)d.insertBefore(h.removeChild(b),h);d.removeChild(h)}return a},_4e_trim:function(a){p._4e_ltrim(a);p._4e_rtrim(a)},_4e_ltrim:function(a){a=u(a);for(var b;b=a.firstChild;){if(b.nodeType==i.NODE_TEXT){var h=l.ltrim(b.nodeValue),d=b.nodeValue.length;if(h){if(h.length<d){(new B(b))._4e_splitText(d-h.length);a.removeChild(a.firstChild)}}else{a.removeChild(b);continue}}break}},_4e_rtrim:function(a){a=u(a);for(var b;b=a.lastChild;){if(b.type==i.NODE_TEXT){var h=l.rtrim(b.nodeValue),d=b.nodeValue.length;
if(h){if(h.length<d){(new B(b))._4e_splitText(h.length);a.removeChild(a.lastChild)}}else{a.removeChild(b);continue}}break}if(!v.ie&&!v.opera)(b=a.lastChild)&&b.nodeType==1&&b.nodeName.toLowerCase()=="br"&&b.parentNode.removeChild(b)},_4e_appendBogus:function(a){a=u(a);for(var b=a.lastChild;b&&b.nodeType==i.NODE_TEXT&&!z.trim(b.nodeValue);)b=b.previousSibling;if(!b||b.nodeType==i.NODE_TEXT||p._4e_name(b)!=="br"){b=v.opera?a.ownerDocument.createTextNode(""):a.ownerDocument.createElement("br");v.gecko&&
b.setAttribute("type","_moz");a.appendChild(b)}},_4e_previous:function(a,b){a=u(a);var h;do h=(a=a.previousSibling)&&new B(a);while(h&&b&&!b(h));return h},_4e_last:function(a,b){if((a=(a=a[0].lastChild)&&new B(a))&&b&&!b(a))a=a._4e_previous(b);return a},_4e_next:function(a,b){a=u(a);var h;do h=(a=a.nextSibling)&&new B(a);while(h&&b&&!b(h));return h},_4e_outerHtml:function(a){a=u(a);if(a.outerHTML)return a.outerHTML.replace(/<\?[^>]*>/,"");var b=a.ownerDocument.createElement("div");b.appendChild(a.cloneNode(true));
return b.innerHTML},_4e_setMarker:function(a,b,h,d){a[0]||(a=new B(a));var f=a._4e_getData("list_marker_id")||a._4e_setData("list_marker_id",z.guid())._4e_getData("list_marker_id"),o=a._4e_getData("list_marker_names")||a._4e_setData("list_marker_names",{})._4e_getData("list_marker_names");b[f]=a;o[h]=1;return a._4e_setData(h,d)},_4e_clearMarkers:function(a,b,h){a=m(a);var d=a._4e_getData("list_marker_names"),f=a._4e_getData("list_marker_id");for(var o in d)a._4e_removeData(o);a._4e_removeData("list_marker_names");
if(h){a._4e_removeData("list_marker_id");delete b[f]}},_4e_setData:function(a,b,h){var d=p._4e_getUniqueId(a);(j[d]||(j[d]={}))[b]=h;return a},_4e_getData:function(a,b){a=u(a);return(a=(a=a.getAttribute("_ke_expando"))&&j[a])&&a[b]},_4e_removeData:function(a,b){a=u(a);var h=a.getAttribute("_ke_expando");var d=(h=h&&j[h])&&h[b];typeof d!="undefined"&&h&&delete h[b];z.isEmptyObject(h)&&p._4e_clearData(a);return d||null},_4e_clearData:function(a){a=u(a);var b=a.getAttribute("_ke_expando");b&&delete j[b];
b&&a.removeAttribute("_ke_expando")},_4e_getUniqueId:function(a){a=u(a);var b=a.getAttribute("_ke_expando");if(b)return b;b=z.guid();a.setAttribute("_ke_expando",b);return b},_4e_copyAttributes:function(a,b,h){a=u(a);var d=a.attributes;h=h||{};for(var f=0;f<d.length;f++){var o=d[f],c=o.nodeName.toLowerCase(),e;if(!(c in h))if(c=="checked"&&(e=p.attr(a,c)))b.attr(c,e);else if(o.specified||v.ie&&o.nodeValue&&c=="value"){e=p.attr(a,c);if(e===null)e=o.nodeValue;b.attr(c,e)}}if(a.style.cssText!=="")b[0].style.cssText=
a.style.cssText},_4e_isEditable:function(a){a=p._4e_name(a);var b=w.XHTML_DTD;return(a=!b.$nonEditable[a]&&(b[a]||b.span))&&a["#"]},_4e_scrollIntoView:function(a){a=m(a);var b=a[0].ownerDocument,h=p.scrollLeft(b),d=p.scrollTop(b),f=a.offset(),o=f.left;f=f.top;if(p.viewportHeight(b)+d<f||f<d||p.viewportWidth(b)+h<o||o<h)a.scrollIntoView(b)},_4e_getElementsByTagName:function(a,b,h){a=u(a);if(!v.ie&&h)b=h+":"+b;h=[];a=a.getElementsByTagName(b);for(b=0;b<a.length;b++)h.push(new B(a[b]));return h}};z.DOM._4e_inject=
function(a){z.mix(p,a);for(var b in a)a.hasOwnProperty(b)&&function(h){B.prototype[h]=function(){var d=[].slice.call(arguments,0);d.unshift(this);return a[h].apply(null,d)}}(b)};z.DOM._4e_inject(s)});
KISSY.Editor.add("elementpath",function(w){function q(j){var k=null,r=null,u=[];for(j=j;j&&j[0];){if(j[0].nodeType==B.NODE_ELEMENT){if(!this.lastElement)this.lastElement=j;var m=j._4e_name();if(l.ie&&j[0].scopeName!="HTML")m=j[0].scopeName.toLowerCase()+":"+m;if(!r){if(!k&&y[m])k=j;if(i[m])if(!k&&m=="div"&&!g(j))k=j;else r=j}u.push(j);if(m=="body")break}j=j.parent()}this.block=k;this.blockLimit=r;this.elements=u}var z=KISSY,p=z.DOM,v=w.XHTML_DTD,B=w.NODE,l=z.UA,y={address:1,blockquote:1,dl:1,h1:1,
h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},i={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1},g=function(j){j=j[0]||j;j=j.childNodes;for(var k=0,r=j.length;k<r;k++){var u=j[k];if(u.nodeType==B.NODE_ELEMENT&&v.$block[u.nodeName.toLowerCase()])return true}return false};q.prototype={compare:function(j){var k=this.elements;j=j&&j.elements;if(!j||k.length!=j.length)return false;for(var r=0;r<k.length;r++)if(!p._4e_equals(k[r],j[r]))return false;return true},contains:function(j){for(var k=
this.elements,r=0;r<k.length;r++)if(k[r]._4e_name()in j)return k[r];return null}};w.ElementPath=q});
KISSY.Editor.add("walker",function(w){function q(i,g){if(this._.end)return null;var j=this.range,k,r=this.guard,u=this.type,m=i?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start){this._.start=1;j.trim();if(j.collapsed){this.end();return null}}if(!i&&!this._.guardLTR){var s=j.endContainer,a=new y(s[0].childNodes[j.endOffset]);this._.guardLTR=function(f,o){return(!o||!l._4e_equals(s,f))&&(!a[0]||f[0]!==a[0])&&(f[0].nodeType!=B.NODE_ELEMENT||!o||f._4e_name()!="body")}}if(i&&!this._.guardRTL){var b=
j.startContainer,h=j.startOffset>0&&new y(b[0].childNodes[j.startOffset-1]);this._.guardRTL=function(f,o){return f&&f[0]&&(!o||b[0]!==f[0])&&(!h[0]||f[0]!==h[0])&&(f[0].nodeType!=B.NODE_ELEMENT||!o||f._4e_name()!="body")}}var d=i?this._.guardRTL:this._.guardLTR;k=r?function(f,o){if(d(f,o)===false)return false;return r(f,o)}:d;if(this.current)i=this.current[m](false,u,k);else if(i){i=j.endContainer;if(j.endOffset>0){i=new y(i[0].childNodes[j.endOffset-1]);if(k(i)===false)i=null}else i=k(i,true)===
false?null:i._4e_previousSourceNode(true,u,k)}else{i=j.startContainer;if((i=new y(i[0].childNodes[j.startOffset]))&&i[0]){if(k(i)===false)i=null}else i=k(j.startContainer,true)===false?null:j.startContainer._4e_nextSourceNode(true,u,k)}for(;i&&i[0]&&!this._.end;){this.current=i;if(!this.evaluator||this.evaluator(i)!==false){if(!g)return i}else if(g&&this.evaluator)return false;i=i[m](false,u,k)}this.end();return this.current=null}function z(i){for(var g,j=null;g=q.call(this,i);)j=g;return j}function p(i){this.range=
i;this._={}}var v=KISSY,B=w.NODE,l=v.DOM,y=v.Node;v.augment(p,{end:function(){this._.end=1},next:function(){return q.call(this)},previous:function(){return q.call(this,true)},checkForward:function(){return q.call(this,false,true)!==false},checkBackward:function(){return q.call(this,true,true)!==false},lastForward:function(){return z.call(this)},lastBackward:function(){return z.call(this,true)},reset:function(){delete this.current;this._={}}});p.blockBoundary=function(i){return function(g){g[0]||(g=
new y(g));return!(g[0].nodeType==B.NODE_ELEMENT&&g._4e_isBlockBoundary(i))}};p.listItemBoundary=function(){return this.blockBoundary({br:1})};p.bookmark=function(i,g){function j(k){return k&&k[0]&&k._4e_name()=="span"&&k.attr("_ke_bookmark")}return function(k){var r,u;r=k&&k[0]&&k[0].nodeType==B.NODE_TEXT&&(u=k.parent())&&j(u);r=i?r:r||j(k);return g^r}};p.whitespaces=function(i){return function(g){g=(g=g[0]||g)&&g.nodeType==B.NODE_TEXT&&!v.trim(g.nodeValue);return i^g}};p.invisible=function(i){var g=
p.whitespaces();return function(j){j=g(j)||j[0].nodeType==B.NODE_ELEMENT&&!j[0].offsetHeight;return i^j}};w.Walker=p});
KISSY.Editor.add("range",function(w){function q(c){this.endOffset=this.endContainer=this.startOffset=this.startContainer=null;this.collapsed=true;this.document=c}function z(c){var e=c[0].nodeType!=i.NODE_TEXT&&c._4e_name()in s.$removeEmpty,n=!y.trim(c[0].nodeValue);c=!!c.parent().attr("_ke_bookmark");return e||n||c}function p(c){return!f(c)&&!o(c)}function v(c){var e=false,n=k.bookmark(true);return function(A){if(n(A))return true;if(A[0].nodeType==i.NODE_TEXT){if(y.trim(A[0].nodeValue).length)return false}else if(A[0].nodeType==
i.NODE_ELEMENT)if(!d[A._4e_name()])if(!c&&!m.ie&&A._4e_name()=="br"&&!e)e=true;else return false;return true}}function B(c,e){function n(A){return A&&A.nodeName=="span"&&A.getAttribute("_ke_bookmark")}return function(A){var t,C;t=A&&!A.nodeName&&(C=A.parentNode)&&n(C);t=c?t:t||n(A);return e^t}}function l(c){return function(e){e=(e=e[0]||e)&&e.nodeType==i.NODE_TEXT&&!y.trim(e.nodeValue);return c^e}}w.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,
ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,STARTEND:3,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var y=KISSY,i=w.NODE,g=w.RANGE,j=w.POSITION,k=w.Walker,r=y.DOM,u=w.Utils.getByAddress,m=y.UA,s=w.XHTML_DTD,a=w.ElementPath,b=y.Node,h={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1};q.prototype.toString=function(){var c=[];c.push((this.startContainer[0].id||this.startContainer[0].nodeName)+":"+this.startOffset);c.push((this.endContainer[0].id||this.endContainer[0].nodeName)+
":"+this.endOffset);return c.join("<br/>")};y.augment(q,{updateCollapsed:function(){this.collapsed=this.startContainer&&this.endContainer&&r._4e_equals(this.startContainer,this.endContainer)&&this.startOffset==this.endOffset},optimize:function(){var c=this.startContainer,e=this.startOffset;if(c[0].nodeType!=i.NODE_ELEMENT)if(e)e>=c[0].nodeValue.length&&this.setStartAfter(c);else this.setStartBefore(c);c=this.endContainer;e=this.endOffset;if(c[0].nodeType!=i.NODE_ELEMENT)if(e)e>=c[0].nodeValue.length&&
this.setEndAfter(c);else this.setEndBefore(c)},setStartAfter:function(c){this.setStart(c.parent(),c._4e_index()+1)},setStartBefore:function(c){this.setStart(c.parent(),c._4e_index())},setEndAfter:function(c){this.setEnd(c.parent(),c._4e_index()+1)},setEndBefore:function(c){this.setEnd(c.parent(),c._4e_index())},optimizeBookmark:function(){var c=this.startContainer,e=this.endContainer;c&&c._4e_name()=="span"&&c.attr("_ke_bookmark")&&this.setStartAt(c,g.POSITION_BEFORE_START);e&&e._4e_name()=="span"&&
e.attr("_ke_bookmark")&&this.setEndAt(e,g.POSITION_AFTER_END)},setStart:function(c,e){if(c[0].nodeType==i.NODE_ELEMENT&&h[c._4e_name()]){c=c.parent();e=c._4e_index()}this.startContainer=c;this.startOffset=e;if(!this.endContainer){this.endContainer=c;this.endOffset=e}this.updateCollapsed()},setEnd:function(c,e){if(c[0].nodeType==i.NODE_ELEMENT&&h[c._4e_name()]){c=c.parent();e=c._4e_index()+1}this.endContainer=c;this.endOffset=e;if(!this.startContainer){this.startContainer=c;this.startOffset=e}this.updateCollapsed()},
setStartAt:function(c,e){switch(e){case g.POSITION_AFTER_START:this.setStart(c,0);break;case g.POSITION_BEFORE_END:c[0].nodeType==i.NODE_TEXT?this.setStart(c,c[0].nodeValue.length):this.setStart(c,c[0].childNodes.length);break;case g.POSITION_BEFORE_START:this.setStartBefore(c);break;case g.POSITION_AFTER_END:this.setStartAfter(c)}this.updateCollapsed()},setEndAt:function(c,e){switch(e){case g.POSITION_AFTER_START:this.setEnd(c,0);break;case g.POSITION_BEFORE_END:c[0].nodeType==i.NODE_TEXT?this.setEnd(c,
c[0].nodeValue.length):this.setEnd(c,c[0].childNodes.length);break;case g.POSITION_BEFORE_START:this.setEndBefore(c);break;case g.POSITION_AFTER_END:this.setEndAfter(c)}this.updateCollapsed()},execContentsAction:function(c,e){var n=this.startContainer,A=this.endContainer,t=this.startOffset,C=this.endOffset,I,x;this.optimizeBookmark();if(A[0].nodeType==i.NODE_TEXT)A=A._4e_splitText(C);else if(A[0].childNodes.length>0)if(C>=A[0].childNodes.length){A=new b(A[0].appendChild(this.document.createTextNode("")));
x=true}else A=new b(A[0].childNodes[C]);if(n[0].nodeType==i.NODE_TEXT){n._4e_splitText(t);if(r._4e_equals(n,A))A=new b(n[0].nextSibling)}else if(t)if(t>=n[0].childNodes.length){I=new b(this.document.createTextNode(""));n[0].appendChild(I[0]);n=I;I=true}else n=new b(n[0].childNodes[t].previousSibling);else{I=new b(this.document.createTextNode(""));r.insertBefore(I[0],n[0].firstChild);n=I;I=true}t=n._4e_parents();C=A._4e_parents();var D,G,J;for(D=0;D<t.length;D++){G=t[D];J=C[D];if(G[0]!==J[0])break}for(var N=
e,M,Q,R,W=D;W<t.length;W++){M=t[W];if(N&&M[0]!==n[0])Q=N.appendChild(M._4e_clone()[0]);for(M=M[0].nextSibling;M;){if(C[W]&&M==C[W][0]||M==A[0])break;R=M.nextSibling;if(c==2)N.appendChild(M.cloneNode(true));else{M.parentNode.removeChild(M);c==1&&N.appendChild(M)}M=R}if(Q)N=Q}N=e;for(e=D;e<C.length;e++){M=C[e];if(c>0&&M[0]!==A[0])Q=N.appendChild(M._4e_clone()[0]);if(!t[e]||M[0].parentNode!==t[e][0].parentNode)for(M=M[0].previousSibling;M;){if(t[e]&&M==t[e][0]||M===n[0])break;R=M.previousSibling;if(c==
2)N.insertBefore(M.cloneNode(true),N.firstChild);else{M.parentNode.removeChild(M);c==1&&N.insertBefore(M,N.firstChild)}M=R}if(Q)N=Q}if(c==2){J=this.startContainer[0];if(J.nodeType==i.NODE_TEXT&&J.nextSibling&&J.nextSibling.nodeType==i.NODE_TEXT){J.data+=J.nextSibling.data;J.parentNode.removeChild(J.nextSibling)}J=this.endContainer[0];if(J.nodeType==i.NODE_TEXT&&J.nextSibling&&J.nextSibling.nodeType==i.NODE_TEXT){J.data+=J.nextSibling.data;J.parentNode.removeChild(J.nextSibling)}}else{if(G&&J&&(n[0].parentNode!=
G[0].parentNode||A[0].parentNode!=J[0].parentNode)){c=J._4e_index();I&&J[0].parentNode==n[0].parentNode&&c--;this.setStart(J.parent(),c)}this.collapse(true)}I&&n._4e_remove();x&&A[0].parentNode&&A._4e_remove()},collapse:function(c){if(c){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=this.endOffset}this.collapsed=true},clone:function(){var c=new q(this.document);c.startContainer=this.startContainer;c.startOffset=this.startOffset;
c.endContainer=this.endContainer;c.endOffset=this.endOffset;c.collapsed=this.collapsed;return c},getEnclosedNode:function(){var c=this.clone();c.optimize();if(c.startContainer[0].nodeType!=i.NODE_ELEMENT||c.endContainer[0].nodeType!=i.NODE_ELEMENT)return null;c=c.startContainer[0].childNodes[c.startOffset];for(var e=B(true,undefined),n=l(true),A=function(t){return n(t)&&e(t)};c&&A(c);)c=(new b(c))._4e_nextSourceNode()[0];return new b(c)},shrink:function(c,e){if(!this.collapsed){c=c||g.SHRINK_TEXT;
var n=this.clone(),A=this.startContainer,t=this.endContainer,C=this.startOffset,I=this.endOffset,x=1,D=1;if(A&&A[0].nodeType==i.NODE_TEXT)if(C)if(C>=A[0].nodeValue.length)n.setStartAfter(A);else{n.setStartBefore(A);x=0}else n.setStartBefore(A);if(t&&t[0].nodeType==i.NODE_TEXT)if(I)if(I>=t[0].nodeValue.length)n.setEndAfter(t);else{n.setEndAfter(t);D=0}else n.setEndBefore(t);n=new k(n);n.evaluator=function(J){J=J[0]||J;return J.nodeType==(c==g.SHRINK_ELEMENT?i.NODE_ELEMENT:i.NODE_TEXT)};var G;n.guard=
function(J,N){J=J[0]||J;if(c==g.SHRINK_ELEMENT&&J.nodeType==i.NODE_TEXT)return false;if(N&&J==G)return false;if(!N&&J.nodeType==i.NODE_ELEMENT)G=J;return true};if(x)(A=n[c==g.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(A,e?g.POSITION_AFTER_START:g.POSITION_BEFORE_START);if(D){n.reset();(n=n[c==g.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(n,e?g.POSITION_BEFORE_END:g.POSITION_AFTER_END)}return!!(x||D)}},getTouchedStartNode:function(){var c=this.startContainer;if(this.collapsed||
c[0].nodeType!=i.NODE_ELEMENT)return c;return c.childNodes[this.startOffset]||c},createBookmark2:function(c){var e=this.startContainer,n=this.endContainer,A=this.startOffset,t=this.endOffset,C,I;if(!e||!n)return{start:0,end:0};if(c){if(e[0].nodeType==i.NODE_ELEMENT)if((C=new b(e[0].childNodes[A]))&&C[0]&&C[0].nodeType==i.NODE_TEXT&&A>0&&C[0].previousSibling.nodeType==i.NODE_TEXT){e=C;A=0}for(;e[0].nodeType==i.NODE_TEXT&&(I=e._4e_previous())&&I[0].nodeType==i.NODE_TEXT;){e=I;A+=I[0].nodeValue.length}if(!this.collapsed){if(n[0].nodeType==
i.NODE_ELEMENT)if((C=new b(n[0].childNodes[t]))&&C[0]&&C[0].nodeType==i.NODE_TEXT&&t>0&&C[0].previousSibling.nodeType==i.NODE_TEXT){n=C;t=0}for(;n[0].nodeType==i.NODE_TEXT&&(I=n._4e_previous())&&I[0].nodeType==i.NODE_TEXT;){n=I;t+=I[0].nodeValue.length}}}return{start:e._4e_address(c),end:this.collapsed?null:n._4e_address(c),startOffset:A,endOffset:t,normalized:c,is2:true}},createBookmark:function(c){var e,n,A,t;e=new b("<span></span>",null,this.document);e.attr("_ke_bookmark",1);e.css("display","none");
e.html("&nbsp;");if(c){A=y.guid("ke_bm_");e.attr("id",A+"S")}if(!this.collapsed){n=e._4e_clone();n.html("&nbsp;");c&&n.attr("id",A+"E");t=this.clone();t.collapse();t.insertNode(n)}t=this.clone();t.collapse(true);t.insertNode(e);if(n){this.setStartAfter(e);this.setEndBefore(n)}else this.moveToPosition(e,g.POSITION_AFTER_END);return{startNode:c?A+"S":e,endNode:c?A+"E":n,serializable:c}},moveToPosition:function(c,e){this.setStartAt(c,e);this.collapse(true)},trim:function(c,e){var n=this.startContainer,
A=this.startOffset,t=this.collapsed;if((!c||t)&&n[0]&&n[0].nodeType==i.NODE_TEXT){if(A)if(A>=n[0].nodeValue.length){A=n._4e_index()+1;n=n.parent()}else{c=n._4e_splitText(A);A=n._4e_index()+1;n=n.parent();if(r._4e_equals(this.startContainer,this.endContainer))this.setEnd(c,this.endOffset-this.startOffset);else if(r._4e_equals(n,this.endContainer))this.endOffset+=1}else{A=n._4e_index();n=n.parent()}this.setStart(n,A);if(t){this.collapse(true);return}}n=this.endContainer;A=this.endOffset;if(!(e||t)&&
n[0]&&n[0].nodeType==i.NODE_TEXT){if(A){A>=n.nodeValue.length||n._4e_splitText(A);A=n._4e_index()+1}else A=n._4e_index();n=n.parent();this.setEnd(n,A)}},insertNode:function(c){this.optimizeBookmark();this.trim(false,true);var e=this.startContainer,n=e[0].childNodes[this.startOffset];this.optimizeBookmark();this.trim(false,true);n?r.insertBefore(c[0]||c,n):e[0].appendChild(c[0]||c);r._4e_equals(c.parent(),this.endContainer)&&this.endOffset++;this.setStartBefore(c)},moveToBookmark:function(c){if(c.is2){var e=
u(this.document,c.start,c.normalized),n=c.startOffset,A=c.end&&u(this.document,c.end,c.normalized);c=c.endOffset;this.setStart(e,n);A?this.setEnd(A,c):this.collapse(true)}else{e=(n=c.serializable)?y.one("#"+c.startNode,this.document):c.startNode;c=n?y.one("#"+c.endNode,this.document):c.endNode;this.setStartBefore(e);e._4e_remove();if(c&&c[0]){this.setEndBefore(c);c._4e_remove()}else this.collapse(true)}},getCommonAncestor:function(c,e){var n=this.startContainer,A=this.endContainer;c=r._4e_equals(n,
A)?c&&n[0].nodeType==i.NODE_ELEMENT&&this.startOffset==this.endOffset-1?new b(n[0].childNodes[this.startOffset]):n:n._4e_commonAncestor(A);return e&&c[0].nodeType==i.NODE_TEXT?c.parent():c},enlarge:function(c){switch(c){case g.ENLARGE_ELEMENT:if(this.collapsed)return;c=this.getCommonAncestor();var e=new b(this.document.body),n,A,t,C,I,x=false,D,G;D=this.startContainer;G=this.startOffset;if(D[0].nodeType==i.NODE_TEXT){if(G){D=!y.trim(D[0].nodeValue.substring(0,G)).length&&D;x=!!D}if(D)if(!(C=D[0].previousSibling))t=
D.parent()}else{if(G)C=D[0].childNodes[G-1]||D[0].lastChild;C||(t=D)}for(;t||C;){if(t&&!C){if(!I&&r._4e_equals(t,c))I=true;if(!e._4e_contains(t))break;if(!x||t.css("display")!="inline"){x=false;if(I)n=t;else this.setStartBefore(t)}C=t[0].previousSibling}for(;C;){D=false;if(C.nodeType==i.NODE_TEXT){G=C.nodeValue;if(/[^\s\ufeff]/.test(G))C=null;D=/[\s\ufeff]$/.test(G)}else if(C.offsetWidth>0&&!C.getAttribute("_ke_bookmark"))if(x&&s.$removeEmpty[C.nodeName.toLowerCase()]){G=r.text(C);if(/[^\s\ufeff]/.test(G))C=
null;else for(var J=C.all||C.getElementsByTagName("*"),N=0,M;M=J[N++];)if(!s.$removeEmpty[M.nodeName.toLowerCase()]){C=null;break}if(C)D=!!G.length}else C=null;if(D)if(x)if(I)n=t;else t&&this.setStartBefore(t);else x=true;if(C){D=C.previousSibling;if(!t&&!D){t=new b(C);C=null;break}C=D}else t=null}if(t)t=t.parent()}D=this.endContainer;G=this.endOffset;t=C=null;I=x=false;if(D[0].nodeType==i.NODE_TEXT){D=!y.trim(D[0].nodeValue.substring(G)).length&&D;x=!(D&&D[0].nodeValue.length);if(D)if(!(C=D[0].nextSibling))t=
D.parent()}else(C=D[0].childNodes[G])||(t=D);for(;t||C;){if(t&&!C){if(!I&&r._4e_equals(t,c))I=true;if(!e._4e_contains(t))break;if(!x||t.css("display")!="inline"){x=false;if(I)A=t;else t&&this.setEndAfter(t)}C=t[0].nextSibling}for(;C;){D=false;if(C.nodeType==i.NODE_TEXT){G=C.nodeValue;if(/[^\s\ufeff]/.test(G))C=null;D=/^[\s\ufeff]/.test(G)}else if(C.offsetWidth>0&&!C.getAttribute("_ke_bookmark"))if(x&&s.$removeEmpty[C.nodeName.toLowerCase()]){G=r.text(C);if(/[^\s\ufeff]/.test(G))C=null;else{J=C.all||
C.getElementsByTagName("*");for(N=0;M=J[N++];)if(!s.$removeEmpty[M.nodeName.toLowerCase()]){C=null;break}}if(C)D=!!G.length}else C=null;if(D)if(x)if(I)A=t;else this.setEndAfter(t);if(C){D=C.nextSibling;if(!t&&!D){t=new b(C);C=null;break}C=D}else t=null}if(t)t=t.parent()}if(n&&A){c=n._4e_contains(A)?A:n;this.setStartBefore(c);this.setEndAfter(c)}break;case g.ENLARGE_BLOCK_CONTENTS:case g.ENLARGE_LIST_ITEM_CONTENTS:t=new q(this.document);e=new b(this.document.body);t.setStartAt(e,g.POSITION_AFTER_START);
t.setEnd(this.startContainer,this.startOffset);t=new k(t);var Q,R,W=k.blockBoundary(c==g.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:null),$=function(aa){var E=W(aa);E||(Q=aa);return E};n=function(aa){var E=$(aa);if(!E&&aa[0]&&aa._4e_name()=="br")R=aa;return E};t.guard=$;t=t.lastBackward();Q=Q||e;this.setStartAt(Q,Q._4e_name()!="br"&&(!t&&this.checkStartOfBlock()||t&&Q._4e_contains(t))?g.POSITION_AFTER_START:g.POSITION_AFTER_END);t=this.clone();t.collapse();t.setEndAt(e,g.POSITION_BEFORE_END);t=new k(t);t.guard=
c==g.ENLARGE_LIST_ITEM_CONTENTS?n:$;Q=null;t=t.lastForward();Q=Q||e;this.setEndAt(Q,!t&&this.checkEndOfBlock()||t&&Q._4e_contains(t)?g.POSITION_BEFORE_END:g.POSITION_BEFORE_START);R&&this.setEndAfter(R)}},checkStartOfBlock:function(){var c=this.startContainer,e=this.startOffset;if(e&&c[0].nodeType==i.NODE_TEXT)if(y.trim(c[0].nodeValue.substring(0,e)).length)return false;this.trim();c=new a(this.startContainer);e=this.clone();e.collapse(true);e.setStartAt(c.block||c.blockLimit,g.POSITION_AFTER_START);
c=new k(e);c.evaluator=v(true);return c.checkBackward()},checkEndOfBlock:function(){var c=this.endContainer,e=this.endOffset;if(c[0].nodeType==i.NODE_TEXT)if(y.trim(c[0].nodeValue.substring(e)).length)return false;this.trim();c=new a(this.endContainer);e=this.clone();e.collapse(false);e.setEndAt(c.block||c.blockLimit,g.POSITION_BEFORE_END);c=new k(e);c.evaluator=v(false);return c.checkForward()},deleteContents:function(){this.collapsed||this.execContentsAction(0)},extractContents:function(){var c=
this.document.createDocumentFragment();this.collapsed||this.execContentsAction(1,c);return c},checkBoundaryOfElement:function(c,e){var n=this.clone();n[e==g.START?"setStartAt":"setEndAt"](c,e==g.START?g.POSITION_AFTER_START:g.POSITION_BEFORE_END);c=new k(n);c.evaluator=z;return c[e==g.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var c=this.startContainer,e=this.endContainer,n=this.startOffset,A=this.endOffset,t;if(c[0].nodeType==i.NODE_ELEMENT){t=c[0].childNodes.length;if(t>
n)c=new b(c[0].childNodes[n]);else if(t<1)c=c._4e_previousSourceNode();else{for(c=c[0];c.lastChild;)c=c.lastChild;c=new b(c);c=c._4e_nextSourceNode()||c}}if(e[0].nodeType==i.NODE_ELEMENT){t=e[0].childNodes.length;if(t>A)e=(new b(e[0].childNodes[A]))._4e_previousSourceNode(true);else if(t<1)e=e._4e_previousSourceNode();else{for(e=e[0];e.lastChild;)e=e.lastChild;e=new b(e)}}if(c._4e_position(e)&j.POSITION_FOLLOWING)c=e;return{startNode:c,endNode:e}},fixBlock:function(c,e){var n=this.createBookmark();
e=new b(this.document.createElement(e));this.collapse(c);this.enlarge(g.ENLARGE_BLOCK_CONTENTS);e[0].appendChild(this.extractContents());e._4e_trim();m.ie||e._4e_appendBogus();this.insertNode(e);this.moveToBookmark(n);return e},splitBlock:function(c){var e=new a(this.startContainer),n=new a(this.endContainer),A=e.block,t=n.block,C=null;if(e.blockLimit[0]!==n.blockLimit[0])return null;if(c!="br"){if(!A){A=this.fixBlock(true,c);t=(new a(this.endContainer)).block}t||(t=this.fixBlock(false,c))}c=A&&this.checkStartOfBlock();
e=t&&this.checkEndOfBlock();this.deleteContents();if(A&&r._4e_equals(A,t))if(e){C=new a(this.startContainer);this.moveToPosition(t,g.POSITION_AFTER_END);t=null}else if(c){C=new a(this.startContainer);this.moveToPosition(A,g.POSITION_BEFORE_START);A=null}else{t=this.splitElement(A);!m.ie&&!y.inArray(A._4e_name(),["ul","ol"])&&A._4e_appendBogus()}return{previousBlock:A,nextBlock:t,wasStartOfBlock:c,wasEndOfBlock:e,elementPath:C}},splitElement:function(c){if(!this.collapsed)return null;this.setEndAt(c,
g.POSITION_BEFORE_END);var e=this.extractContents(),n=c._4e_clone(false);n[0].appendChild(e);n.insertAfter(c);this.moveToPosition(c,g.POSITION_AFTER_END);return n},moveToElementEditablePosition:function(c,e){var n,A=w.XHTML_DTD;if(A.$empty[c._4e_name()])return false;for(;c&&c[0].nodeType==i.NODE_ELEMENT;){if(n=c._4e_isEditable())this.moveToPosition(c,e?g.POSITION_BEFORE_END:g.POSITION_AFTER_START);else if(A.$inline[c._4e_name()]){this.moveToPosition(c,e?g.POSITION_AFTER_END:g.POSITION_BEFORE_START);
return true}if((c=A.$empty[c._4e_name()]?c[e?"_4e_previous":"_4e_next"](p):c[e?"_4e_last":"_4e_first"](p))&&c[0].nodeType==i.NODE_TEXT){this.moveToPosition(c,e?g.POSITION_AFTER_END:g.POSITION_BEFORE_START);return true}}return n},selectNodeContents:function(c){this.setStart(c,0);this.setEnd(c,c[0].nodeType==i.NODE_TEXT?c[0].nodeValue.length:c[0].childNodes.length)}});var d={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},f=new k.whitespaces,o=new k.bookmark;w.Range=q});
KISSY.Editor.add("domiterator",function(w){function q(u){if(!(arguments.length<1)){this.range=u;this.forceBrBreak=false;this.enlargeBr=true;this.enforceRealBlocks=false;this._||(this._={})}}var z=KISSY,p=z.UA,v=w.Walker,B=w.Range,l=w.RANGE,y=w.NODE,i=w.ElementPath,g=z.Node,j=z.DOM,k=/^[\r\n\t ]*$/,r=v.bookmark();z.augment(q,{getNextParagraph:function(u){var m,s,a,b,h;if(!this._.lastNode){s=this.range.clone();s.enlarge(this.forceBrBreak||!this.enlargeBr?l.ENLARGE_LIST_ITEM_CONTENTS:l.ENLARGE_BLOCK_CONTENTS);
var d=new v(s),f=v.bookmark(true,true);d.evaluator=f;this._.nextNode=d.next();d=new v(s);d.evaluator=f;d=d.previous();this._.lastNode=d._4e_nextSourceNode(true);if(this._.lastNode&&this._.lastNode[0].nodeType==y.NODE_TEXT&&!z.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()){f=new B(s.document);f.moveToPosition(this._.lastNode,l.POSITION_AFTER_END);if(f.checkEndOfBlock()){f=new i(f.endContainer);this._.lastNode=(f.block||f.blockLimit)._4e_nextSourceNode(true)}}if(!this._.lastNode){this._.lastNode=
this._.docEndMarker=new g(s.document.createTextNode(""));j.insertAfter(this._.lastNode[0],d[0])}s=null}f=this._.nextNode;d=this._.lastNode;for(this._.nextNode=null;f;){var o=false,c=f[0].nodeType!=y.NODE_ELEMENT,e=false;if(c){if(f[0].nodeType==y.NODE_TEXT)if(k.test(f[0].nodeValue))c=false}else{var n=f._4e_name();if(f._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if(n=="br")c=true;else if(!s&&!f[0].childNodes.length&&n!="hr"){m=f;a=f._4e_equals(d);break}if(s){s.setEndAt(f,l.POSITION_BEFORE_START);
if(n!="br")this._.nextNode=f}o=true}else{if(f[0].firstChild){if(!s){s=new B(this.range.document);s.setStartAt(f,l.POSITION_BEFORE_START)}f=new g(f[0].firstChild);continue}c=true}}if(c&&!s){s=new B(this.range.document);s.setStartAt(f,l.POSITION_BEFORE_START)}a=(!o||c)&&f._4e_equals(d);if(s&&!o)for(;!f[0].nextSibling&&!a;){n=f.parent();if(n._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){o=true;a||n._4e_equals(d);break}f=n;c=true;a=f._4e_equals(d);e=true}c&&s.setEndAt(f,l.POSITION_AFTER_END);f=f._4e_nextSourceNode(e,
null,d);a=!f;if((o||a)&&s){c=s.getBoundaryNodes();o=new i(s.startContainer);if(c.startNode.parent()._4e_equals(o.blockLimit)&&r(c.startNode)&&r(c.endNode)){s=null;this._.nextNode=null}else break}if(a)break}if(!m){if(!s){this._.docEndMarker&&this._.docEndMarker._4e_remove();return this._.nextNode=null}o=new i(s.startContainer);f=o.blockLimit;c={div:1,th:1,td:1};m=o.block;if((!m||!m[0])&&!this.enforceRealBlocks&&c[f._4e_name()]&&s.checkStartOfBlock()&&s.checkEndOfBlock())m=f;else if(!m||this.enforceRealBlocks&&
m._4e_name()=="li"){m=new g(this.range.document.createElement(u||"p"));m[0].appendChild(s.extractContents());m._4e_trim();s.insertNode(m);b=h=true}else if(m._4e_name()!="li"){if(!s.checkStartOfBlock()||!s.checkEndOfBlock()){m=m._4e_clone(false);m[0].appendChild(s.extractContents());m._4e_trim();h=s.splitBlock();b=!h.wasStartOfBlock;h=!h.wasEndOfBlock;s.insertNode(m)}}else if(!a)this._.nextNode=m._4e_equals(d)?null:s.getBoundaryNodes().endNode._4e_nextSourceNode(true,null,d)}if(b){s=new g(m[0].previousSibling);
if(s[0]&&s[0].nodeType==y.NODE_ELEMENT)if(s._4e_name()=="br")s._4e_remove();else s[0].lastChild&&s[0].lastChild.nodeName.toLowerCase()=="br"&&j._4e_remove(s[0].lastChild)}if(h){s=v.bookmark(false,true);b=new g(m[0].lastChild);if(b[0]&&b[0].nodeType==y.NODE_ELEMENT&&b._4e_name()=="br")if(p.ie||b._4e_previous(s)||b._4e_next(s))b._4e_remove()}if(!this._.nextNode)this._.nextNode=a||m._4e_equals(d)?null:m._4e_nextSourceNode(true,null,d);return m}});B.prototype.createIterator=function(){return new q(this)}});
KISSY.Editor.add("selection",function(w){function q(d){this.document=d;this._={cache:{}};if(B.ie){var f=this.getNative().createRange();if(!f||f.item&&f.item(0).ownerDocument!=d||f.parentElement&&f.parentElement().ownerDocument!=d)this.isInvalid=true}}function z(d){d=new q(d);return!d||d.isInvalid?null:d}function p(d){var f=d.document,o=new g(f.body),c=new g(f.documentElement);if(B.ie){if(B.ie<8||document.documentMode==7)c.on("click",function(C){l._4e_name(C.target)==="html"&&d.getSelection().getRanges()[0].select()});
var e,n;o.on("focusin",function(C){if(C.target.nodeName.toUpperCase()=="BODY")if(e){try{e.select()}catch(I){}e=null}});o.on("focus",function(){n=true;t()});o.on("beforedeactivate",function(C){C.relatedTarget||(n=false)});B.ie<8&&y.on(l._4e_getWin(f),"blur",function(){f.selection.empty()});o.on("mousedown",A);o.on("mouseup",function(){n=true;setTimeout(function(){t(true)},0)});o.on("keydown",A);o.on("keyup",function(){n=true;t()});y.on(f,"selectionchange",t);var A=function(){n=false},t=function(C){if(n){var I=
d.document,x=d.getSelection(),D=x&&x.getNative();if(C&&D&&D.type=="None")if(!I.queryCommandEnabled("InsertImage")){setTimeout(function(){t(true)},50);return}var G;if(!(D&&D.type=="Text"&&(G=D.createRange().parentElement().nodeName.toLowerCase())&&G in{input:1,textarea:1})){e=D&&x.getRanges()[0];d._monitor()}}}}else{y.on(f,"mouseup",d._monitor,d);y.on(f,"keyup",d._monitor,d)}}w.SELECTION={};var v=KISSY,B=v.UA,l=v.DOM,y=v.Event,i=w.Utils.tryThese,g=v.Node,j=w.SELECTION,k=w.RANGE,r=w.NODE,u=w.Walker,
m=w.Range;j.SELECTION_NONE=1;j.SELECTION_TEXT=2;j.SELECTION_ELEMENT=3;var s={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};v.augment(q,{getNative:B.ie?function(){return this._.cache.nativeSel||(this._.cache.nativeSel=this.document.selection)}:function(){return this._.cache.nativeSel||(this._.cache.nativeSel=l._4e_getWin(this.document).getSelection())},getType:B.ie?function(){var d=this._.cache;if(d.type)return d.type;
var f=j.SELECTION_NONE;try{var o=this.getNative(),c=o.type;if(c=="Text")f=j.SELECTION_TEXT;if(c=="Control")f=j.SELECTION_ELEMENT;if(o.createRange().parentElement)f=j.SELECTION_TEXT}catch(e){}return d.type=f}:function(){var d=this._.cache;if(d.type)return d.type;var f=j.SELECTION_TEXT,o=this.getNative();if(o){if(o.rangeCount==1){o=o.getRangeAt(0);var c=o.startContainer;if(c==o.endContainer&&c.nodeType==r.NODE_ELEMENT&&o.endOffset-o.startOffset===1&&s[c.childNodes[o.startOffset].nodeName.toLowerCase()])f=
j.SELECTION_ELEMENT}}else f=j.SELECTION_NONE;return d.type=f},getRanges:B.ie?function(){var d=function(f,o){f=f.duplicate();f.collapse(o);o=f.parentElement();for(var c=o.childNodes,e,n=0;n<c.length;n++){var A=c[n];if(A.nodeType==r.NODE_ELEMENT){e=f.duplicate();e.moveToElementText(A);A=e.compareEndPoints("StartToStart",f);var t=e.compareEndPoints("EndToStart",f);e.collapse();if(A>0)break;else if(!A||t==1&&A==-1)return{container:o,offset:n};else if(!t)return{container:o,offset:n+1};e=null}}if(!e){e=
f.duplicate();e.moveToElementText(o);e.collapse(false)}e.setEndPoint("StartToStart",f);f=e.text.replace(/(\r\n|\r)/g,"\n").length;try{for(;f>0;)f-=c[--n].nodeValue.length}catch(C){f=0}return f===0?{container:o,offset:n}:{container:c[n],offset:-f}};return function(){var f=this._.cache;if(f.ranges)return f.ranges;var o=this.getNative(),c=o&&o.createRange(),e=this.getType();if(!o)return[];if(e==j.SELECTION_TEXT){o=new m(this.document);e=d(c,true);o.setStart(new g(e.container),e.offset);e=d(c);o.setEnd(new g(e.container),
e.offset);return f.ranges=[o]}else if(e==j.SELECTION_ELEMENT){f=this._.cache.ranges=[];for(e=0;e<c.length;e++){var n=c.item(e),A=n.parentNode,t=0;for(o=new m(this.document);t<A.childNodes.length&&A.childNodes[t]!=n;t++);o.setStart(new g(A),t);o.setEnd(new g(A),t+1);f.push(o)}return f}return f.ranges=[]}}():function(){var d=this._.cache;if(d.ranges)return d.ranges;var f=[],o=this.getNative();if(!o)return[];for(var c=0;c<o.rangeCount;c++){var e=o.getRangeAt(c),n=new m(this.document);n.setStart(new g(e.startContainer),
e.startOffset);n.setEnd(new g(e.endContainer),e.endOffset);f.push(n)}return d.ranges=f},getStartElement:function(){var d=this._.cache;if(d.startElement!==undefined)return d.startElement;var f,o=this.getNative();switch(this.getType()){case j.SELECTION_ELEMENT:return this.getSelectedElement();case j.SELECTION_TEXT:var c=this.getRanges()[0];if(c)if(!c.collapsed){for(c.optimize();;){f=c.startContainer;if(c.startOffset==(f[0].childNodes?f[0].childNodes.length:f[0].nodeValue.length)&&!f._4e_isBlockBoundary())c.setStartAfter(f);
else break}f=c.startContainer;if(f[0].nodeType!=r.NODE_ELEMENT)return f.parent();f=new g(f[0].childNodes[c.startOffset]);if(!f[0]||f[0].nodeType!=r.NODE_ELEMENT)return c.startContainer;for(c=f[0].firstChild;c&&c.nodeType==r.NODE_ELEMENT;){f=new g(c);c=c.firstChild}return f}if(B.ie){c=o.createRange();c.collapse(true);f=c.parentElement()}else if((f=o.anchorNode)&&f.nodeType!=r.NODE_ELEMENT)f=f.parentNode}return d.startElement=f?new g(f):null},getSelectedElement:function(){var d=this._.cache;if(d.selectedElement!==
undefined)return d.selectedElement;var f=this,o=i(function(){return f.getNative().createRange().item(0)},function(){for(var c=f.getRanges()[0],e,n,A=2;A&&!((e=c.getEnclosedNode())&&e[0].nodeType==r.NODE_ELEMENT&&s[e._4e_name()]&&(n=e));A--)c.shrink(k.SHRINK_ELEMENT);return n[0]});return d.selectedElement=o?new g(o):null},reset:function(){this._.cache={}},selectElement:function(d){var f;if(B.ie){this.getNative().empty();try{f=this.document.body.createControlRange();f.addElement(d[0]);f.select()}catch(o){f=
this.document.body.createTextRange();f.moveToElementText(d[0]);f.select()}finally{}}else{f=this.document.createRange();f.selectNode(d[0]);d=this.getNative();d.removeAllRanges();d.addRange(f)}this.reset()},selectRanges:function(d){if(B.ie)d[0]&&d[0].select();else{var f=this.getNative();if(!f)return;f.removeAllRanges();for(var o=0;o<d.length;o++){var c=d[o],e=this.document.createRange(),n=c.startContainer;c.collapsed&&B.gecko&&B.gecko<1.09&&n[0].nodeType==r.NODE_ELEMENT&&!n[0].childNodes.length&&n[0].appendChild(this.document.createTextNode(""));
e.setStart(n[0],c.startOffset);e.setEnd(c.endContainer[0],c.endOffset);f.addRange(e)}}this.reset()},createBookmarks2:function(d){for(var f=[],o=this.getRanges(),c=0;c<o.length;c++)f.push(o[c].createBookmark2(d));return f},createBookmarks:function(d){for(var f=[],o=this.getRanges(),c=o.length,e,n=0;n<c;n++){f.push(e=o[n].createBookmark(d,true));var A=(d=e.serializable)?v.one("#"+e.startNode):e.startNode;e=d?v.one("#"+e.endNode):e.endNode;for(var t=n+1;t<c;t++){var C=o[t],I=C.startContainer,x=C.endContainer;
l._4e_equals(I,A.parent())&&C.startOffset++;l._4e_equals(I,e.parent())&&C.startOffset++;l._4e_equals(x,A.parent())&&C.endOffset++;l._4e_equals(x,e.parent())&&C.endOffset++}}return f},selectBookmarks:function(d){for(var f=[],o=0;o<d.length;o++){var c=new m(this.document);c.moveToBookmark(d[o]);f.push(c)}this.selectRanges(f);return this},getCommonAncestor:function(){var d=this.getRanges();return d[0].startContainer._4e_commonAncestor(d[d.length-1].endContainer)},scrollIntoView:function(){this.getStartElement()._4e_scrollIntoView()}});
w.Selection=q;var a={table:1,tbody:1,tr:1},b=u.whitespaces(true),h=/\ufeff|\u00a0/;m.prototype.select=B.ie?function(d){var f=this.collapsed,o,c;if(this.startContainer[0]===this.endContainer[0]&&this.endOffset-this.startOffset==1){var e=this.startContainer[0].childNodes[this.startOffset];if(e.nodeType==r.NODE_ELEMENT){(new q(this.document)).selectElement(new g(e));return}}if(this.startContainer[0].nodeType==r.NODE_ELEMENT&&this.startContainer._4e_name()in a||this.endContainer[0].nodeType==r.NODE_ELEMENT&&
this.endContainer._4e_name()in a)this.shrink(r.NODE_ELEMENT,true);var n=this.createBookmark();e=n.startNode;var A;if(!f)A=n.endNode;n=this.document.body.createTextRange();n.moveToElementText(e[0]);n.moveStart("character",1);if(A){d=this.document.body.createTextRange();d.moveToElementText(A[0]);n.setEndPoint("EndToEnd",d);n.moveEnd("character",-1)}else{for(o=e[0].nextSibling;o&&!b(o);)o=o.nextSibling;o=!(o&&o.nodeValue&&o.nodeValue.match(h))&&(d||!e[0].previousSibling||e[0].previousSibling&&l._4e_name(e[0].previousSibling)==
"br");c=this.document.createElement("span");c.innerHTML="&#65279;";c=new g(c);l.insertBefore(c[0],e[0]);o&&l.insertBefore(this.document.createTextNode("\ufeff"),e[0])}this.setStartBefore(e);e._4e_remove();if(f){if(o){n.moveStart("character",-1);n.select();this.document.selection.clear()}else n.select();if(c){this.moveToPosition(c,k.POSITION_BEFORE_START);c._4e_remove()}}else{this.setEndBefore(A);A._4e_remove();n.select()}}:function(){var d=this.startContainer;this.collapsed&&d[0].nodeType==r.NODE_ELEMENT&&
!d[0].childNodes.length&&d[0].appendChild(this.document.createTextNode(""));var f=this.document.createRange();f.setStart(d[0],this.startOffset);try{f.setEnd(this.endContainer[0],this.endOffset)}catch(o){if(o.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=0){this.collapse(true);f.setEnd(this.endContainer[0],this.endOffset)}else throw o;}d=z(this.document).getNative();d.removeAllRanges();d.addRange(f)};w.on("instanceCreated",function(d){p(d.editor)})});
KISSY.Editor.add("styles",function(w){function q(E,F){for(var H in E)E[H]=E[H].replace(aa,function(K,L){return F[L]})}function z(E,F){if(F){E=A.clone(E);q(E.attributes,F);q(E.styles,F)}F=this.element=(E.element||"*").toLowerCase();this.type=F=="#"||R[F]?C.STYLE_BLOCK:W[F]?C.STYLE_OBJECT:C.STYLE_INLINE;this._={definition:E}}function p(E,F){F=F?this.removeFromRange:this.applyToRange;E.body.focus();E=new x(E);for(var H=E.getRanges(),K=0;K<H.length;K++)F.call(this,H[K]);E.selectRanges(H)}function v(E,
F){var H=E.element;if(H=="*")H="span";F=new N(F.createElement(H));return B(F,E)}function B(E,F){var H=F._.definition;F=H.attributes;H=z.getStyleText(H);if(F)for(var K in F)E.attr(K,F[K]);if(H)E[0].style.cssText=H;return E}function l(E){var F=E.createBookmark(true),H=E.createIterator();H.enforceRealBlocks=true;H.enlargeBr=true;for(var K,L=E.document;K=H.getNextParagraph();){var O=v(this,L);j(K,O)}E.moveToBookmark(F)}function y(E,F,H){var K="",L="";E=E.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,
function(O,P,S){P&&(K=P);S&&(L=S);return""});return K+E.replace(F,H)+L}function i(E,F){var H=E.html();H=y(H,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,"");H=H.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1");H=H.replace(/([ \t\n\r]+|&nbsp;)/g," ");H=H.replace(/<br\b[^>]*>/gi,"\n");if(M.ie){E=E[0].ownerDocument.createElement("div");E.appendChild(F[0]);F[0].outerHTML="<pre>"+H+"</pre>";F=new N(E.firstChild);F._4e_remove()}else F.html(H);return F}function g(E){var F=[];y(E._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,
function(H,K,L){return K+"</pre>"+L+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(H,K){F.push(K)});return F}function j(E,F){var H=F._4e_name=="pre",K=E._4e_name=="pre",L=!H&&K;if(H&&!K)F=i(E,F);else if(L)F=r(g(E),F);else E._4e_moveChildren(F);E[0].parentNode.replaceChild(F[0],E[0]);H&&k(F)}function k(E){var F;if((F=E._4e_previousSourceNode(true,D.NODE_ELEMENT))&&F._4e_name()=="pre"){var H=y(F.html(),/\n$/,"")+"\n\n"+y(E.html(),/^\n/,"");if(M.ie)E[0].outerHTML="<pre>"+H+"</pre>";else E.html(H);
F._4e_remove()}}function r(E,F){for(var H=F[0].ownerDocument.createDocumentFragment(),K=0;K<E.length;K++){var L=E[K];L=L.replace(/(\r\n|\r)/g,"\n");L=y(L,/^[ \t]*\n/,"");L=y(L,/\n$/,"");L=y(L,/^[ \t]+|[ \t]+$/g,function(P,S){return P.length==1?"&nbsp;":S?" "+(new Array(P.length)).join("&nbsp;"):(new Array(P.length)).join("&nbsp;")+" "});L=L.replace(/\n/g,"<br>");L=L.replace(/[ \t]{2,}/g,function(P){return(new Array(P.length)).join("&nbsp;")+" "});var O=F._4e_clone();O.html(L);H.appendChild(O[0])}return H}
function u(E){var F=E.document;if(E.collapsed){F=v(this,F);E.insertNode(F);E.moveToPosition(F,I.POSITION_BEFORE_END)}else{var H=this.element,K=this._.definition,L,O=w.XHTML_DTD[H]||(L=true,w.XHTML_DTD.span),P=E.createBookmark();E.enlarge(I.ENLARGE_ELEMENT);E.trim();var S=E.createBookmark(),da=S.startNode;S=S.endNode;for(var U=da,X;U&&U[0];){var T=false;if(t._4e_equals(U,S)){U=null;T=true}else{var V=U[0].nodeType,ba=V==D.NODE_ELEMENT?U._4e_name():null;if(ba&&U.attr("_ke_bookmark")){U=U._4e_nextSourceNode(true);
continue}if(!ba||O[ba]&&(U._4e_position(S)|G.POSITION_PRECEDING|G.POSITION_IDENTICAL|G.POSITION_IS_CONTAINED)==G.POSITION_PRECEDING+G.POSITION_IDENTICAL+G.POSITION_IS_CONTAINED&&(!K.childRule||K.childRule(U))){var ca=U.parent();if(ca&&ca[0]&&((w.XHTML_DTD[ca._4e_name()]||w.XHTML_DTD.span)[H]||L)&&(!K.parentRule||K.parentRule(ca))){if(!X&&(!ba||!w.XHTML_DTD.$removeEmpty[ba]||(U._4e_position(S)|G.POSITION_PRECEDING|G.POSITION_IDENTICAL|G.POSITION_IS_CONTAINED)==G.POSITION_PRECEDING+G.POSITION_IDENTICAL+
G.POSITION_IS_CONTAINED)){X=new J(F);X.setStartBefore(U)}if(V==D.NODE_TEXT||V==D.NODE_ELEMENT&&!U[0].childNodes.length){V=U;for(var Y;!V[0].nextSibling&&(Y=V.parent(),O[Y._4e_name()])&&(Y._4e_position(da)|G.POSITION_FOLLOWING|G.POSITION_IDENTICAL|G.POSITION_IS_CONTAINED)==G.POSITION_FOLLOWING+G.POSITION_IDENTICAL+G.POSITION_IS_CONTAINED&&(!K.childRule||K.childRule(Y));)V=Y;X.setEndAfter(V);V[0].nextSibling||(T=true)}}else T=true}else T=true;U=U._4e_nextSourceNode()}if(T&&X&&!X.collapsed){T=v(this,
F);for(V=X.getCommonAncestor();T&&V&&T[0]&&V[0];){if(V._4e_name()==H){for(var Z in K.attributes)T.attr(Z)==V.attr(Z)&&T[0].removeAttribute(Z);for(var ea in K.styles)T._4e_style(ea)==V._4e_style(ea)&&T._4e_style(ea,"");if(!T._4e_hasAttributes()){T=null;break}}V=V.parent()}if(T){T[0].appendChild(X.extractContents());c(this,T);X.insertNode(T);T._4e_mergeSiblings();M.ie||T[0].normalize()}X=null}}da._4e_remove();S._4e_remove();E.moveToBookmark(P);E.shrink(I.SHRINK_TEXT)}}function m(E){E.enlarge(I.ENLARGE_ELEMENT);
var F=E.createBookmark(),H=F.startNode;if(E.collapsed){for(var K=new Q(H.parent()),L,O=0,P;O<K.elements.length&&(P=K.elements[O]);O++){if(P==K.block||P==K.blockLimit)break;if(this.checkElementRemovable(P)){var S=E.checkBoundaryOfElement(P,I.END),da=!S&&E.checkBoundaryOfElement(P,I.START);if(da||S){L=P;L.match=da?"start":"end"}else{P._4e_mergeSiblings();P._4e_name()==this.element?f(this,P):e(P,d(this)[P._4e_name()])}}}if(L&&L[0]){P=H;for(O=0;;O++){S=K.elements[O];if(t._4e_equals(S,L))break;else if(S.match)continue;
else S=S._4e_clone();S[0].appendChild(P[0]);P=S}t[L.match=="start"?"insertBefore":"insertAfter"](P[0],L[0])}}else{var U=F.endNode,X=this;K=function(){for(var T=new Q(H.parent()),V=new Q(U.parent()),ba=null,ca=null,Y=0;Y<T.elements.length;Y++){var Z=T.elements[Y];if(Z==T.block||Z==T.blockLimit)break;if(X.checkElementRemovable(Z))ba=Z}for(Y=0;Y<V.elements.length;Y++){Z=V.elements[Y];if(Z==V.block||Z==V.blockLimit)break;if(X.checkElementRemovable(Z))ca=Z}ca&&U._4e_breakParent(ca);ba&&H._4e_breakParent(ba)};
K();for(L=new N(H[0].nextSibling);L[0]!==U[0];){O=L._4e_nextSourceNode();if(L[0].nodeType==D.NODE_ELEMENT&&this.checkElementRemovable(L)){L._4e_name()==this.element?f(this,L):e(L,d(this)[L._4e_name()]);if(O[0].nodeType==D.NODE_ELEMENT&&O._4e_contains(H)){K();O=new N(H[0].nextSibling)}}L=O}}E.moveToBookmark(F)}function s(E){var F={};E.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(H,K,L){F[K]=L});return F}function a(E,F){typeof E=="string"&&(E=s(E));typeof F=="string"&&
(F=s(F));for(var H in E)if(!(H in F&&(F[H]==E[H]||E[H]=="inherit"||F[H]=="inherit")))return false;return true}function b(E,F){if(F!==false){F=document.createElement("span");F.style.cssText=E;E=F.style.cssText||""}else E=E;return E.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function h(E){var F=E._AC;if(F)return F;F={};var H=0,K=E.attributes;if(K)for(var L in K){H++;F[L]=K[L]}if(K=z.getStyleText(E)){F.style||H++;F.style=K}F._length=H;return E._AC=F}function d(E){if(E._.overrides)return E._.overrides;
var F=E._.overrides={},H=E._.definition.overrides;if(H){A.isArray(H)||(H=[H]);for(var K=0;K<H.length;K++){var L=H[K],O,P;if(typeof L=="string")O=L.toLowerCase();else{O=L.element?L.element.toLowerCase():E.element;P=L.attributes}L=F[O]||(F[O]={});if(P){L=L.attributes=L.attributes||[];for(var S in P)L.push([S.toLowerCase(),P[S]])}}}return F}function f(E,F){var H=E._.definition,K=A.mix(A.mix({},H.attributes),d(E)[F._4e_name()]);H=H.styles;var L=A.isEmptyObject(K)&&A.isEmptyObject(H);for(var O in K)if(!((O==
"class"||E._.definition.fullMatch)&&F.attr(O)!=o(O,K[O]))){L=L||!!F._4e_hasAttribute(O);F.removeAttr(O)}for(var P in H)if(!(E._.definition.fullMatch&&F._4e_style(P)!=o(P,H[P],true))){L=L||!!F._4e_style(P);F._4e_style(P,"")}L&&n(F)}function o(E,F,H){var K=new N("<span></span>");K[H?"_4e_style":"attr"](E,F);return K[H?"_4e_style":"attr"](E)}function c(E,F){for(var H=d(E),K=F.all(E.element),L=K.length;--L>=0;)f(E,new N(K[L]));for(var O in H)if(O!=E.element){K=F.all(O);for(L=K.length-1;L>=0;L--){var P=
new N(K[L]);e(P,H[O])}}}function e(E,F){if(F=F&&F.attributes)for(var H=0;H<F.length;H++){var K=F[H][0],L;if(L=E.attr(K)){var O=F[H][1];if(O===null||O.test&&O.test(L)||typeof O=="string"&&L==O)E[0].removeAttribute(K)}}n(E)}function n(E){if(!E._4e_hasAttributes()){var F=E[0].firstChild,H=E[0].lastChild;E._4e_remove(true);if(F){F.nodeType==D.NODE_ELEMENT&&t._4e_mergeSiblings(F);H&&!F===H&&H.nodeType==D.NODE_ELEMENT&&t._4e_mergeSiblings(H)}}}var A=KISSY,t=A.DOM,C=w.STYLE={},I=w.RANGE,x=w.Selection,D=
w.NODE,G=w.POSITION,J=w.Range,N=A.Node,M=A.UA,Q=w.ElementPath,R={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},W={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},$=/\s*(?:;\s*|$)/,aa=/#\((.+?)\)/g;C.STYLE_BLOCK=1;C.STYLE_INLINE=2;C.STYLE_OBJECT=3;z.prototype={apply:function(E){p.call(this,E,false)},remove:function(E){p.call(this,E,true)},applyToRange:function(E){return(this.applyToRange=this.type==C.STYLE_INLINE?u:this.type==C.STYLE_BLOCK?l:this.type==
C.STYLE_OBJECT?null:null).call(this,E)},removeFromRange:function(E){return(this.removeFromRange=this.type==C.STYLE_INLINE?m:null).call(this,E)},applyToObject:function(E){B(E,this)},checkElementRemovable:function(E,F){if(!E)return false;var H=this._.definition;if(E._4e_name()==this.element){if(!F&&!E._4e_hasAttributes())return true;H=h(H);if(H._length){for(var K in H)if(K!="_length"){var L=E.attr(K)||"";if(K=="style"?a(H[K],b(L,false)):H[K]==L){if(!F)return true}else if(F)return false}if(F)return true}else return true}if(H=
d(this)[E._4e_name()]){if(!(H=H.attributes))return true;for(F=0;F<H.length;F++){K=H[F][0];if(K=E.attr(K)){L=H[F][1];if(L===null||typeof L=="string"&&K==L||L.test(K))return true}}}return false},checkActive:function(E){switch(this.type){case C.STYLE_BLOCK:return this.checkElementRemovable(E.block||E.blockLimit,true);case C.STYLE_OBJECT:case C.STYLE_INLINE:for(var F=E.elements,H=0,K;H<F.length;H++){K=F[H];if(!(this.type==C.STYLE_INLINE&&(t._4e_equals(K,E.block)||t._4e_equals(K,E.blockLimit))))if(!(this.type==
C.STYLE_OBJECT&&!(K._4e_name()in W)))if(this.checkElementRemovable(K,true))return true}}return false}};z.getStyleText=function(E){var F=E._ST;if(F)return F;F=E.styles;var H=E.attributes&&E.attributes.style||"",K="";if(H.length)H=H.replace($,";");for(var L in F){var O=F[L],P=(L+":"+O).replace($,";");if(O=="inherit")K+=P;else H+=P}if(H.length)H=b(H);H+=K;return E._ST=H};w.Style=z});
KISSY.Editor.add("button",function(){function w(v){w.superclass.constructor.call(this,v);this._init()}var q=KISSY.Editor,z=KISSY,p=z.Node;w.ON="on";w.OFF="off";w.DISABLED="disabled";w.ON_CLASS="ke-triplebutton-on";w.OFF_CLASS="ke-triplebutton-off";w.DISABLED_CLASS="ke-triplebutton-disabled";w.ATTRS={state:{value:"off"},container:{},text:{},contentCls:{},cls:{}};z.extend(w,z.Base,{_init:function(){var v=this.get("container")[0]||this.get("container");this.el=new p("<a class='ke-triplebutton ke-triplebutton-off' href='#' role=\"button\"></a>");
this.el._4e_unselectable();this._attachCls();if(this.get("text"))this.el.html(this.get("text"));else if(this.get("contentCls")){this.el.html("<span class='ke-toolbar-item "+this.get("contentCls")+"'></span>");this.el.one("span")._4e_unselectable()}this.get("title")&&this.el.attr("title",this.get("title"));v.appendChild(this.el[0]);this.el.on("click",this._action,this);this.on("afterStateChange",this._stateChange,this)},_attachCls:function(){var v=this.get("cls");v&&this.el.addClass(v)},_stateChange:function(v){this["_"+
v.newVal]();this._attachCls()},_action:function(v){this.fire(this.get("state")+"Click",v);this.fire("click",v);v.preventDefault()},_on:function(){this.el[0].className="ke-triplebutton ke-triplebutton-on"},_off:function(){this.el[0].className="ke-triplebutton ke-triplebutton-off"},_disabled:function(){this.el[0].className="ke-triplebutton ke-triplebutton-disabled"}});q.TripleButton=w});
KISSY.Editor.add("contextmenu",function(){function w(g){this.cfg=p.clone(g);z.Utils.lazyRun(this,"_prepareShow","_realShow")}function q(g,j){for(var k=0;k<j.length;k++)if(B.test(g,j[k]))return true;return false}var z=KISSY.Editor,p=KISSY,v=p.Node,B=p.DOM,l=p.Event,y=[];w.register=function(g,j){var k=new w(j);y.push({doc:g,rules:j.rules,instance:k});if(!g.ke_contextmenu){g.ke_contextmenu=1;l.on(g,"mousedown",w.hide);l.on(g,"contextmenu",function(r){w.hide.call(this);for(var u=new v(r.target);u;){var m=
false;if(u._4e_name()=="body")break;for(var s=0;s<y.length;s++){var a=y[s].instance,b=y[s].rules;if(g===y[s].doc&&q(u[0],b)){r.preventDefault();m=true;a.show(z.Utils.getXY(r.pageX,r.pageY,g,document));break}}if(m)break;u=u.parent()}})}return k};w.hide=function(){for(var g=0;g<y.length;g++){var j=y[g].instance;this===y[g].doc&&j.hide()}};var i=z.SimpleOverlay;p.augment(w,{_init:function(){var g=this,j=g.cfg,k=j.funcs;g.elDom=new v("<div class='ke-contextmenu'></div>");var r=g.elDom;r.css("width",j.width);
document.body.appendChild(r[0]);g.el=new i({el:r});for(var u in k){j=new v("<a href='#'>"+u+"</a>");r[0].appendChild(j[0]);(function(m,s){m.on("click",function(a){s();g.hide();a.halt()})})(j,k[u])}},hide:function(){this.el&&this.el.hide()},_realShow:function(g){this.el.show(g)},_prepareShow:function(){this._init()},show:function(g){this._prepareShow(g)}});z.ContextMenu=w});
KISSY.Editor.add("overlay",function(){function w(){var j=this;w.superclass.constructor.apply(j,arguments);j._init();if(z.UA.ie===6){j.on("show",function(){var k=j.get("el"),r=parseInt(k.css("width"));k=k[0].offsetHeight;g&&g.css({width:r+"px",height:k+"px"});g&&g.offset(j.get("el").offset())});j.on("hide",function(){g&&g.offset({left:-999,top:-999})})}if(j.get("mask")){j.on("show",function(){y&&y.css({left:"0px",top:"0px"});i&&i.css({left:"0px",top:"0px"})});j.on("hide",function(){y&&y.css({left:"-9999px",
top:"-9999px"});i&&i.css({left:"-9999px",top:"-9999px"})})}j.hide()}var q=KISSY.Editor,z=KISSY,p=z.UA,v=q.focusManager,B=z.Node,l=z.DOM,y,i,g;w.init=function(){var j=document.body;y=new B('<div class="ke-mask">&nbsp;</div>');y.css({left:"-9999px",top:"-9999px"});y.css({width:"100%",height:l.docHeight()+"px",opacity:0.4});y.appendTo(j);if(z.UA.ie==6){g=new B("<iframe class='ke-dialog-iframe'></iframe>");j.appendChild(g[0]);i=new B("<iframe class='ke-mask'></iframe>");i.css({left:"-9999px",top:"-9999px"});
i.css({width:"100%",height:l.docHeight()+"px",opacity:0.4});i.appendTo(j)}w.init=null};w.ATTRS={title:{value:""},width:{value:"450px"},visible:{value:true},focusMgr:{value:true},mask:{value:false}};z.extend(w,z.Base,{_init:function(){var j=this,k=j.get("el");j.on("afterVisibleChange",function(r){if(r=r.newVal){typeof r=="boolean"?j.center():k.offset(r);j.fire("show")}else{k.css({left:"-9999px",top:"-9999px"});j.fire("hide")}});j.get("focusMgr")&&j.on("beforeVisibleChange",j._editorFocusMg,j);if(k){k[0].appendChild((new B("<a href='#' class='ke-focus' style='width:0;height:0;margin:0;padding:0;overflow:hidden;outline:none;font-size:0;'></a>"))[0]);
j.el=k}else{k=new B("<div class='ke-dialog' style='width:"+j.get("width")+"'><div class='ke-hd'><span class='ke-hd-title'>"+j.get("title")+"</span><span class='ke-hd-x'><a class='ke-close' href='#'>X</a></span></div><div class='ke-bd'></div><div class='ke-ft'></div><a href='#' tabindex='-1' class='ke-focus'></a></div>");document.body.appendChild(k[0]);j.set("el",k);j.el=k;j.body=k.one(".ke-bd");j.foot=k.one(".ke-ft");j._close=k.one(".ke-close");j._title=k.one(".ke-hd-title").one("h1");j._close.on("click",
function(r){r.preventDefault();j.hide()})}},center:function(){var j=this.get("el"),k=parseInt(j.css("width")),r=j[0].offsetHeight,u=l.viewportWidth(),m=l.viewportHeight();k=(u-k)/2+l.scrollLeft();r=(m-r)/2+l.scrollTop();if(r-l.scrollTop()>200)r-=150;j.css({left:k+"px",top:r+"px"})},_prepareShow:function(){w.init()},_getFocusEl:function(){if(this._focusEl)return this._focusEl;return this._focusEl=this.el.one(".ke-focus")[0]},_editorFocusMg:function(j){var k=this._focusEditor;if(j.newVal){this._focusEditor=
v.currentInstance();this._getFocusEl().focus();k=this._focusEditor;var r=this.el.one("input");if(r)setTimeout(function(){r[0].focus();r[0].select()},0);else if(p.ie&&k)if(j=k.document.selection.createRange())if(j.item&&j.item(0).ownerDocument==k.document){k=document.body.createTextRange();k.moveToElementText(this.el._4e_first()[0]);k.collapse(true);k.select()}}else k&&k.focus()},_realShow:function(j){this.get("el");this.set("visible",j||true)},show:function(j){this._prepareShow(j)},hide:function(){this.get("el");
this.set("visible",false)}});q.Utils.lazyRun(w.prototype,"_prepareShow","_realShow");q.SimpleOverlay=w});
KISSY.Editor.add("clipboard",function(w){var q=KISSY.Editor,z=KISSY,p=z.Node,v=z.UA,B=q.Range,l=q.RANGE,y=z.Event;q.Paste||function(){function i(g){this.editor=g;this._init()}z.augment(i,{_init:function(){var g=this.editor;v.ie?y.on(g.document,"keydown",this._paste,this):y.on(g.document,"paste",this._paste,this)},_paste:function(g){if(!(g.type==="keydown"&&!(g.keyCode===86&&(g.ctrlKey||g.metaKey)))){var j=this.editor;g=j.document;var k=j.getSelection(),r=new B(g),u=new p(v.webkit?"<body></body>":
"<div></div>",null,g);v.webkit&&u[0].appendChild(g.createTextNode("\u00a0"));g.body.appendChild(u[0]);u.css({position:"absolute",top:k.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});u.css("left","-1000px");var m=k.createBookmarks();r.setStartAt(u,l.POSITION_AFTER_START);r.setEndAt(u,l.POSITION_BEFORE_END);r.select(true);setTimeout(function(){u._4e_remove();var s;u=v.webkit&&(s=u._4e_first())&&s[0]&&s.hasClass("Apple-style-span")?s:u;k.selectBookmarks(m);j.insertHtml(u.html())},
0)}}});q.Paste=i}();w.addPlugin(function(){new q.Paste(w)})});
KISSY.Editor.add("color",function(w){function q(f){return("0"+f).slice(f.length-1,f.length+1)}function z(f){f=v.trim(f);if(f.charAt(0)=="#")f=f.substring(1);f=f.replace(/\s+/g,"");var o="";if(/^[0-9a-f]{3,3}$/i.test(f))o=f.replace(/[0-9a-f]/ig,function(e){return e+e});else{var c=f.match(j);if(c&&c[0])for(f=1;f<4;f++)o+=q(parseInt(c[f]).toString(16));else o=f}return"#"+o.toLowerCase()}for(var p=KISSY.Editor,v=KISSY,B=v.Node,l=v.Event,y=p.SimpleOverlay,i=p.Style,g=v.DOM,j=/^rgb\((\d+),(\d+),(\d+)\)$/i,
k="000,800000,8B4513,2F4F4F,008080,000080,4B0082,696969,B22222,A52A2A,DAA520,006400,40E0D0,0000CD,800080,808080,F00,FF8C00,FFD700,008000,0FF,00F,EE82EE,A9A9A9,FFA07A,FFA500,FFFF00,00FF00,AFEEEE,ADD8E6,DDA0DD,D3D3D3,FFF0F5,FAEBD7,FFFFE0,F0FFF0,F0FFFF,F0F8FF,E6E6FA,FFF".split(/,/),r={element:"span",styles:{color:"#(color)"},overrides:[{element:"font",attributes:{color:null}}]},u={element:"span",styles:{"background-color":"#(color)"}},m="<div class='ke-popup-wrap ke-color-wrap'><a class='ke-color-remove' href=\"javascript:void('\u6e05\u9664');\"><span>\u6e05\u9664</span></a><table>",
s={},a={},b=0;b<5;b++){m+="<tr>";for(var h=0;h<8;h++){var d=z(k[8*b+h]);m+="<td>";m+="<a href='javascript:void(0);' class='ke-color-a'><span style='background-color:"+d+"'></span></a>";m+="</td>";s[d]=new i(u,{color:d});a[d]=new i(r,{color:d})}m+="</tr>"}s.inherit=new i(u,{color:"inherit"});a.inherit=new i(r,{color:"inherit"});m+="</table></div>";p.ColorSupport||function(){function f(c){f.superclass.constructor.call(this,c);this._init()}var o=p.TripleButton;f.ATTRS={editor:{},styles:{},contentCls:{},
text:{}};v.extend(f,v.Base,{_init:function(){var c=this.get("editor").toolBarDiv;c=new o({container:c,title:this.get("title"),contentCls:this.get("contentCls")});c.on("offClick",this._showColors,this);this.el=c;p.Utils.lazyRun(this,"_prepare","_real")},_hidePanel:function(c){var e=this;g._4e_ascendant(c.target,function(n){return n[0]===e.el.el[0]},true)||this.colorWin.hide()},_selectColor:function(c){c.halt();var e=this.get("editor");c=c.target;if(g._4e_name(c)=="span"||g._4e_name(c)=="a"){c=new B(c);
if(c._4e_name()=="a")c=c.one("span");var n=this.get("styles");e.fire("save");c._4e_style("background-color")?n[z(c._4e_style("background-color"))].apply(e.document):n.inherit.remove(e.document);e.fire("save");e.focus();this.colorWin.hide()}},_prepare:function(){this.colorPanel=new B(m);this.colorWin=new y({el:this.colorPanel,mask:false,focusMgr:false});document.body.appendChild(this.colorPanel[0]);this.colorPanel.on("click",this._selectColor,this);l.on(document,"click",this._hidePanel,this);l.on(w.document,
"click",this._hidePanel,this)},_real:function(){var c=this.el.el.offset();c.top+=this.el.el.height()+5;if(c.left+this.colorPanel.width()>g.viewportWidth()-60)c.left=g.viewportWidth()-this.colorPanel.width()-60;this.colorWin.show(c)},_showColors:function(c){this._prepare(c)}});p.ColorSupport=f}();w.addPlugin(function(){new p.ColorSupport({editor:w,styles:s,title:"\u80cc\u666f\u989c\u8272",contentCls:"ke-toolbar-bgcolor",text:"bgcolor"});new p.ColorSupport({editor:w,styles:a,title:"\u6587\u672c\u989c\u8272",
contentCls:"ke-toolbar-color",text:"color"})})});
KISSY.Editor.add("elementpaths",function(w){var q=KISSY.Editor,z=KISSY,p=z.Node,v=z.DOM;q.ElementPaths||function(){function B(l){this.cfg=l;this._cache=[];this._init()}z.augment(B,{_init:function(){var l=this.cfg.editor;this.holder=new p("<div>");this.holder.appendTo(l.statusDiv);l.on("selectionChange",this._selectionChange,this)},_selectionChange:function(l){var y=this.cfg.editor,i=this.holder;i=i[0]||i;l=l.path.elements;var g,j;g=this._cache;for(j=0;j<g.length;j++){g[j].detach("click");g[j]._4e_remove()}this._cache=
[];for(j=0;j<l.length;j++){g=l[j];var k=new p("<a href='#' class='elementpath'>"+(g.attr("_ke_real_element_type")||g._4e_name())+"</a>");this._cache.push(k);(function(r){k.on("click",function(u){u.halt();y.focus();setTimeout(function(){y.getSelection().selectElement(r)},50)})})(g);i.firstChild?v.insertBefore(k[0],i.firstChild):i.appendChild(k[0])}}});q.ElementPaths=B}();w.addPlugin(function(){new q.ElementPaths({editor:w})})});
KISSY.Editor.add("enterkey",function(w){var q=KISSY.Editor,z=KISSY,p=z.UA,v=/^h[1-6]$/,B=q.XHTML_DTD,l=z.Node,y=z.Event,i=q.Walker,g=q.ElementPath;q.enterBlock||function(){function j(u){u=u.getSelection().getRanges();for(var m=u.length-1;m>0;m--)u[m].deleteContents();return u[0]}function k(u){var m=j(u),s=m.document;if(m.checkStartOfBlock()&&m.checkEndOfBlock()){var a=(new g(m.startContainer)).block;if(a&&(a._4e_name()=="li"||a.parent()._4e_name()=="li")){u.execCommand("outdent");return}}var b=m.splitBlock("p");
if(b){u=b.previousBlock;a=b.nextBlock;var h=b.wasStartOfBlock,d=b.wasEndOfBlock,f;if(a){f=a.parent();if(f._4e_name()=="li"){a._4e_breakParent(f);a._4e_move(a._4e_next(),true)}}else if(u&&(f=u.parent())&&f._4e_name()=="li"){u._4e_breakParent(f);m.moveToElementEditablePosition(u._4e_next());u._4e_move(u._4e_previous())}if(!h&&!d){if(a._4e_name()=="li"&&(f=a._4e_first(i.invisible(true)))&&z.inArray(f._4e_name(),["ul","ol"]))(p.ie?new l(s.createTextNode("\u00a0")):new l(s.createElement("br"))).insertBefore(f);
a&&m.moveToElementEditablePosition(a)}else{var o;if(u){if(u._4e_name()=="li"||!v.test(u._4e_name()))o=u._4e_clone()}else if(a)o=a._4e_clone();o||(o=new l("p",null,s));if(f=b.elementPath){b=0;for(var c=f.elements.length;b<c;b++){var e=f.elements[b];if(e._4e_equals(f.block)||e._4e_equals(f.blockLimit))break;if(B.$removeEmpty[e._4e_name()]){e=e._4e_clone();o._4e_moveChildren(e);o.append(e)}}}p.ie||o._4e_appendBogus();m.insertNode(o);if(p.ie&&h&&(!d||!u[0].childNodes.length)){m.moveToElementEditablePosition(d?
u:o);m.select()}m.moveToElementEditablePosition(h&&!d?a:o)}if(!p.ie)if(a){s=new l(s.createElement("span"));s.html("&nbsp;");m.insertNode(s);s._4e_scrollIntoView();m.deleteContents()}else o._4e_scrollIntoView();m.select()}}function r(u){y.on(u.document,"keydown",function(m){if(m.keyCode===13)if(!m.shiftKey){u.execCommand("enterBlock");m.preventDefault()}})}r.enterBlock=k;q.EnterKey=r}();w.addPlugin(function(){w.addCommand("enterBlock",{exec:q.EnterKey.enterBlock});q.EnterKey(w)})});
KISSY.Editor.add("fakeobjects",function(){var w=KISSY.Editor,q=KISSY,z=q.Node,p=w.NODE,v=w.HtmlParser,B=q.Editor,l=w.HtmlDataProcessor,y=l&&l.htmlFilter;w.FakeObjects||function(){var i={elements:{$:function(g){var j=g.attributes;if((j=(j=(j=j&&j._ke_realelement)&&new v.Fragment.FromHtml(decodeURIComponent(j)))&&j.children[0])&&g.attributes._ke_resizable){var k=g.attributes.style;if(k){var r=/(?:^|\s)width\s*:\s*(\d+)/i.exec(k);g=r&&r[1];k=(r=/(?:^|\s)height\s*:\s*(\d+)/i.exec(k))&&r[1];if(g)j.attributes.width=
g;if(k)j.attributes.height=k}}return j}}};y&&y.addRules(i);l&&q.mix(l,{createFakeParserElement:function(g,j,k,r){var u;u=new v.BasicWriter;g.writeHtml(u);u=u.getHtml();var m=g.attributes.style;if(g.attributes.width)m="width:"+g.attributes.width+"px;"+m;if(g.attributes.height)m="height:"+g.attributes.height+"px;"+m;g={"class":j,src:w.Config.base+"assets/spacer.gif",_ke_realelement:encodeURIComponent(u),_ke_real_node_type:g.type,style:m,align:g.attributes.align||""};if(k)g._ke_real_element_type=k;if(r)g._ke_resizable=
r;return new v.Element("img",g)}});w.FakeObjects=1}();q.augment(B,{createFakeElement:function(i,g,j,k,r){var u=i.attr("style")||"";if(i.attr("width"))u="width:"+i.attr("width")+"px;"+u;if(i.attr("height"))u="height:"+i.attr("height")+"px;"+u;i={"class":g,src:w.Config.base+"assets/spacer.gif",_ke_realelement:encodeURIComponent(r||i._4e_outerHtml()),_ke_real_node_type:i[0].nodeType,align:i.attr("align")||"",style:u};if(j)i._ke_real_element_type=j;if(k)i._ke_resizable=k;return new z("<img/>",i,this.document)},
restoreRealElement:function(i){if(i.attr("_ke_real_node_type")!=p.NODE_ELEMENT)return null;i=decodeURIComponent(i.attr("_ke_realelement"));var g=new z("<div>",null,this.document);g.html(i);return g._4e_first(function(j){return j[0].nodeType==p.NODE_ELEMENT})._4e_remove()}})});
KISSY.Editor.add("flash",function(w){var q=KISSY.Editor,z=KISSY,p=z.DOM,v=z.Event,B=q.ContextMenu,l=z.Node,y=q.NODE,i=q.TripleButton,g=q.SimpleOverlay,j=/\.swf(?:$|\?)/i,k=q.HtmlDataProcessor,r="niftyplayer.swf",u=k&&k.dataFilter,m=["img.ke_flash"];q.Flash||function(){function a(d){d=d.attributes;return d.type=="application/x-shockwave-flash"||j.test(d.src||"")}function b(d){return d.indexOf(r)!=-1}function h(d){this.editor=d;d._toolbars=d._toolbars||{};d._toolbars.flash=this;this._init()}u&&u.addRules({elements:{object:function(d){var f=
d.attributes,o="ke_flash",c="flash";if(!(f.classid&&String(f.classid).toLowerCase())){for(f=0;f<d.children.length;f++)if(d.children[f].name=="embed"){if(!a(d.children[f]))return null;if(b(d.children[f].attributes.src)){o="ke_music";c="music"}return k.createFakeParserElement(d,o,c,true)}return null}for(f=0;f<d.children.length;f++){var e=d.children[f];if(e.name=="param"&&e.attributes.name=="movie")if(b(e.attributes.value)){o="ke_music";c="music";break}}return k.createFakeParserElement(d,o,c,true)},
embed:function(d){if(!a(d))return null;var f="ke_flash",o="flash";if(b(d.attributes.src)){f="ke_music";o="music"}return k.createFakeParserElement(d,f,o,true)}}},5);z.augment(h,{_init:function(){var d=this.editor,f={};this.el=new i({container:d.toolBarDiv,contentCls:"ke-toolbar-flash",title:"Flash"});this.el.on("click",this._showConfig,this);v.on(d.document,"dblclick",this._dbclick,this);for(var o in s)(function(c){f[c]=function(){d.fire("save");d.focus();s[c](d);d.fire("save")}})(o);B.register(d.document,
{rules:m,width:"120px",funcs:f});q.Utils.lazyRun(this,"_prepareShow","_realShow")},_dbclick:function(d){var f=new l(d.target);if(f._4e_name()==="img"&&f.hasClass("ke_flash")){this.selectedFlash=f;this._showConfig();d.halt()}},_prepareShow:function(){var d=this;d.d=new g({title:"\u7f16\u8f91flash",width:"350px",mask:true});d.d.on("hide",function(){d.selectedFlash=null;w.focus()});d.d.body.html("<div><p><label>\u5730\u5740\uff1a<input class='ke-flash-url' style='width:280px' /></label></p><p style='margin:5px 0'><label>\u5bbd\u5ea6\uff1a<input class='ke-flash-width' style='width:110px' /></label>&nbsp;&nbsp;<label>\u9ad8\u5ea6\uff1a<input class='ke-flash-height' style='width:110px' /></label></p>");
d.d.foot.html("<button class='ke-flash-ok'>\u786e\u5b9a</button> <button class='ke-flash-cancel'>\u53d6\u6d88</button></div>");d._initD()},_realShow:function(){this.d.show()},_showConfig:function(){var d=this.editor,f=this.selectedFlash;this._prepareShow();if(f){d=d.restoreRealElement(f);d.attr("width")&&this.dWidth.val(parseInt(d.attr("width")));d.attr("height")&&this.dHeight.val(parseInt(d.attr("height")));if(d._4e_name()=="object"){d=d[0].childNodes;for(f=0;f<d.length;f++)if(d[f].nodeType==y.NODE_ELEMENT)if((p.attr(d[f],
"name")||"").toLowerCase()=="movie")this.dUrl.val(p.attr(d[f],"value"));else if(p._4e_name(d[f])=="embed")this.dUrl.val(p.attr(d[f],"src"));else p._4e_name(d[f])=="object"&&this.dUrl.val(p.attr(d[f],"data"))}else d._4e_name()=="embed"&&this.dUrl.val(d.attr("src"))}},_initD:function(){var d=this,f=d.d;d.dHeight=f.el.one(".ke-flash-height");d.dWidth=f.el.one(".ke-flash-width");d.dUrl=f.el.one(".ke-flash-url");var o=f.el.one(".ke-flash-ok");f=f.el.one(".ke-flash-cancel");o.on("click",d._gen,d);f.on("click",
function(){d.d.hide()})},_gen:function(){var d=this.editor,f=this.dUrl.val();if(f){f="<object "+(parseInt(this.dWidth.val())?" width='"+parseInt(this.dWidth.val())+"' ":" ")+(parseInt(this.dHeight.val())?" height='"+parseInt(this.dHeight.val())+"' ":" ")+' classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"  codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,0,0"><param name="quality" value="high" /><param name="movie" value="'+f+'" /><embed '+(parseInt(this.dWidth.val())?
" width='"+parseInt(this.dWidth.val())+"' ":" ")+(parseInt(this.dHeight.val())?" height='"+parseInt(this.dHeight.val())+"' ":" ")+'pluginspage="http://www.macromedia.com/go/getflashplayer" quality="high"  src="'+f+'"  type="application/x-shockwave-flash"/></object>';var o=new l(f,null,d.document);f=d.createFakeElement?d.createFakeElement(o,"ke_flash","flash",true,f):o;d.insertElement(f);this.d.hide()}}});q.Flash=h}();var s={"\u7f16\u8f91Flash":function(a){var b=a.getSelection();if(b=(b=b&&b.getStartElement())&&
b._4e_ascendant("img",true))if(b.hasClass("ke_flash")){a=a._toolbars.flash;a.selectedFlash=b;a._showConfig()}}};w.addPlugin(function(){new q.Flash(w)})});
KISSY.Editor.add("font",function(w){var q=KISSY.Editor,z=KISSY,p=q.Style,v=q.TripleButton,B=z.Node,l=["8px","10px","12px","14px","18px","24px","36px","48px","60px","72px","84px","96px","108px"],y={},i="<select title='\u5927\u5c0f' style='width:110px;height:21px;'><option value=''>\u5927\u5c0f / \u6e05\u9664</option>",g={element:"span",styles:{"font-size":"#(size)"},overrides:[{element:"font",attributes:{size:null}}]},j=["\u5b8b\u4f53","\u9ed1\u4f53","\u96b6\u4e66","\u6977\u4f53_GB2312","\u5fae\u8f6f\u96c5\u9ed1",
"Georgia","Times New Roman","Impact","Courier New","Arial","Verdana","Tahoma"],k={},r="<select title='\u5b57\u4f53' ><option value=''>\u5b57\u4f53 / \u6e05\u9664</option>",u={element:"span",styles:{"font-family":"#(family)"},overrides:[{element:"font",attributes:{face:null}}]},m;for(m=0;m<l.length;m++){var s=l[m];y[s]=new p(g,{size:s});i+="<option value='"+s+"'>"+s+"</option>"}i+="</select>";for(m=0;m<j.length;m++){l=j[m];k[l]=new p(u,{family:l});r+="<option style='font-family:"+l+"'  value='"+l+
"'>"+l+"</option>"}r+="</select>";q.Font||function(){function a(h){a.superclass.constructor.call(this,h);this._init()}function b(h){b.superclass.constructor.call(this,h);this._init()}a.ATTRS={v:{value:""},html:{},styles:{},editor:{}};z.extend(a,z.Base,{_init:function(){var h=this.get("editor"),d=h.toolBarDiv,f=this.get("html");this.el=new B(f);d[0].appendChild(this.el[0]);this.el.on("change",this._change,this);h.on("selectionChange",this._selectionChange,this);this.on("afterVChange",this._vChange,
this)},_vChange:function(h){var d=this.get("editor"),f=h.newVal;h=h.preVal;var o=this.get("styles");d.focus();d.fire("save");if(f)o[f].apply(d.document);else{f=h;o[f].remove(d.document)}d.fire("save");d.notifySelectionChange()},_change:function(){this.set("v",this.el.val())},_selectionChange:function(h){this.get("editor");var d=this.get("v");h=h.path.elements;for(var f=this.get("styles"),o=0,c;o<h.length;o++){c=h[o];for(var e in f)if(f[e].checkElementRemovable(c,true)){if(e!=d){this._set("v",e);this.el.val(e)}return}}if(d!=
""){this._set("v","");this.el.val("")}}});b.ATTRS={editor:{},text:{},contentCls:{},title:{},style:{}};z.extend(b,z.Base,{_init:function(){var h=this.get("editor"),d=this.get("text");this.get("style");var f=this.get("title");this.el=new v({text:d,title:f,contentCls:this.get("contentCls"),container:h.toolBarDiv});this.el.on("offClick",this._on,this);this.el.on("onClick",this._off,this);h.on("selectionChange",this._selectionChange,this)},_on:function(){var h=this.get("editor");this.get("text");var d=
this.get("style");this.get("title");h.fire("save");d.apply(h.document);h.fire("save");h.notifySelectionChange();h.focus()},_off:function(){var h=this.get("editor");this.get("text");var d=this.get("style");this.get("title");h.fire("save");d.remove(h.document);h.fire("save");h.notifySelectionChange();h.focus()},_selectionChange:function(h){this.get("editor");this.get("text");var d=this.get("style");this.get("title");d.checkActive(h.path)?this.el.set("state",v.ON):this.el.set("state",v.OFF)}});a.SingleFont=
b;q.Font=a}();w.addPlugin(function(){new q.Font({editor:w,styles:y,html:i});new q.Font({editor:w,styles:k,html:r});new q.Font.SingleFont({contentCls:"ke-toolbar-bold",title:"\u7c97\u4f53",editor:w,style:new p({element:"span",styles:{"font-weight":"bold"},overrides:[{element:"b"},{strong:"strong"}]})});new q.Font.SingleFont({contentCls:"ke-toolbar-italic",title:"\u659c\u4f53",editor:w,style:new p({element:"span",styles:{"font-style":"italic"},overrides:[{element:"i"},{strong:"em"}]})});new q.Font.SingleFont({contentCls:"ke-toolbar-underline",
title:"\u4e0b\u5212\u7ebf",editor:w,style:new p({element:"span",styles:{"text-decoration":"underline"},overrides:[{element:"u"}]})});new q.Font.SingleFont({contentCls:"ke-toolbar-strikeThrough",title:"\u5220\u9664\u7ebf",editor:w,style:new p({element:"span",styles:{"text-decoration":"line-through"},overrides:[{element:"del"},{element:"s"}]})})})});
KISSY.Editor.add("format",function(w){var q=KISSY.Editor,z=KISSY,p=z.Node;q.Format||function(){function v(k){v.superclass.constructor.call(this,k);this.el=new p(B);this._init()}var B="<select style='height:21px' title='\u683c\u5f0f'>",l={"\u6807\u9898 / \u6e05\u9664":"p","\u6807\u98981":"h1","\u6807\u98982":"h2","\u6807\u98983":"h3","\u6807\u98984":"h4","\u6807\u98985":"h5","\u6807\u98986":"h6"},y={h1:"2em",h2:"1.5em",h3:"1.17em",h4:"1em",h5:"0.83em",h6:"0.67em"},i={},g=q.Style;for(var j in l)if(l[j]){i[l[j]]=
new g({element:l[j]});B+="<option style='font-size:"+y[l[j]]+"'value='"+l[j]+"'>"+j+"</option>"}B+="</select>";v.ATTRS={v:{value:"p"},editor:{}};z.extend(v,z.Base,{_init:function(){var k=this.get("editor"),r=this.el;k.toolBarDiv[0].appendChild(this.el[0]);r.on("change",this._change,this);k.on("selectionChange",this._selectionChange,this);this.on("afterVChange",this._vChange,this)},_vChange:function(k){var r=this.get("editor");k=k.newVal;r.focus();r.fire("save");i[k].apply(r.document);r.fire("save");
r.fire("formatChange",this.get("v"))},_change:function(){this.set("v",this.el.val())},_selectionChange:function(k){this.get("editor");var r=this.get("v");k=k.path;for(var u in i)if(i[u].checkActive(k)){if(u!=r){this._set("v",u);this.el.val(u)}return}this._set("v","p");this.el.val("p")}});q.Format=v}();w.addPlugin(function(){new q.Format({editor:w})})});
KISSY.Editor.add("htmlparser-basicwriter",function(){function w(){this._={output:[]}}var q=KISSY.Editor,z=q.Utils;if(!q.HtmlParser.BasicWriter){KISSY.augment(w,{openTag:function(p){this._.output.push("<",p)},openTagClose:function(p,v){v?this._.output.push(" />"):this._.output.push(">")},attribute:function(p,v){if(typeof v=="string")v=z.htmlEncodeAttr(v);this._.output.push(" ",p,'="',v,'"')},closeTag:function(p){this._.output.push("</",p,">")},text:function(p){this._.output.push(p)},comment:function(p){this._.output.push("<!--",
p,"--\>")},write:function(p){this._.output.push(p)},reset:function(){this._.output=[];this._.indent=false},getHtml:function(p){var v=this._.output.join("");p&&this.reset();return v}});q.HtmlParser.BasicWriter=w}});
KISSY.Editor.add("htmlparser-element",function(){function w(v,B){this.name=v;this.attributes=B||(B={});this.children=[];var l=B._ke_real_element_type||v;B=q.XHTML_DTD;l=!!(B.$nonBodyContent[l]||B.$block[l]||B.$listItem[l]||B.$tableContent[l]||B.$nonEditable[l]||l=="br");var y=!!B.$empty[v];this.isEmpty=y;this.isUnknown=!B[v];this._={isBlockLike:l,hasInlineStarted:y||!l}}var q=KISSY.Editor;if(!q.HtmlParser.Element){var z=q.NODE,p=function(v,B){v=v[0];B=B[0];return v<B?-1:v>B?1:0};KISSY.augment(w,{type:z.NODE_ELEMENT,
add:q.HtmlParser.Fragment.prototype.add,clone:function(){return new w(this.name,this.attributes)},writeHtml:function(v,B){var l=this.attributes,y=this,i=y.name,g,j,k,r;y.filterChildren=function(){if(!r){var s=new q.HtmlParser.BasicWriter;q.HtmlParser.Fragment.prototype.writeChildrenHtml.call(y,s,B);y.children=(new q.HtmlParser.Fragment.fromHtml(s.getHtml())).children;r=1}};if(B){for(;;){if(!(i=B.onElementName(i)))return;y.name=i;if(!(y=B.onElement(y)))return;y.parent=this.parent;if(y.name==i)break;
if(y.type!=z.NODE_ELEMENT){y.writeHtml(v,B);return}i=y.name;if(!i){this.writeChildrenHtml.call(y,v,r?null:B);return}}l=y.attributes}v.openTag(i,l);for(var u=[],m=0;m<2;m++)for(g in l){j=g;k=l[g];if(m==1)u.push([g,k]);else if(B){for(;;)if(j=B.onAttributeName(g))if(j!=g){delete l[g];g=j}else break;else{delete l[g];break}if(j)if((k=B.onAttribute(y,j,k))===false)delete l[j];else l[j]=k}}v.sortAttributes&&u.sort(p);l=u.length;for(m=0;m<l;m++){g=u[m];v.attribute(g[0],g[1])}v.openTagClose(i,y.isEmpty);if(!y.isEmpty){this.writeChildrenHtml.call(y,
v,r?null:B);v.closeTag(i)}},writeChildrenHtml:function(){q.HtmlParser.Fragment.prototype.writeChildrenHtml.apply(this,arguments)}});q.HtmlParser.Element=w}});
KISSY.Editor.add("htmlparser-filter",function(){function w(i){this._={elementNames:[],attributeNames:[],elements:{$length:0},attributes:{$length:0}};i&&this.addRules(i,10)}function q(i,g){for(var j=0;i&&j<g.length;j++){var k=g[j];i=i.replace(k[0],k[1])}return i}function z(i,g,j){if(typeof g=="function")g=[g];var k,r;r=i.length;var u=g&&g.length;if(u){for(k=0;k<r&&i[k].pri<j;k++);for(r=u-1;r>=0;r--)if(u=g[r]){u.pri=j;i.splice(k,0,u)}}}function p(i,g,j){if(g)for(var k in g){var r=i[k];i[k]=v(r,g[k],
j);r||i.$length++}}function v(i,g,j){if(g){g.pri=j;if(i){if(i.splice)z(i,g,j);else{i=i.pri>j?[g,i]:[i,g];i.filter=B}return i}else return g.filter=g}}function B(i){for(var g=i.type||i instanceof l.HtmlParser.Fragment,j=0;j<this.length;j++){if(g)var k=i.type,r=i.name;var u=this[j].apply(window,arguments);if(u===false)return u;if(g){if(u&&(u.name!=r||u.type!=k))return u}else if(typeof u!="string")return u;u!=undefined&&(i=u)}return i}var l=KISSY.Editor,y=l.NODE;if(!l.HtmlParser.Filter){KISSY.augment(w,
{addRules:function(i,g){if(typeof g!="number")g=10;z(this._.elementNames,i.elementNames,g);z(this._.attributeNames,i.attributeNames,g);p(this._.elements,i.elements,g);p(this._.attributes,i.attributes,g);this._.text=v(this._.text,i.text,g)||this._.text;this._.comment=v(this._.comment,i.comment,g)||this._.comment;this._.root=v(this._.root,i.root,g)||this._.root},onElementName:function(i){return q(i,this._.elementNames)},onAttributeName:function(i){return q(i,this._.attributeNames)},onText:function(i){var g=
this._.text;return g?g.filter(i):i},onComment:function(i,g){var j=this._.comment;return j?j.filter(i,g):i},onFragment:function(i){var g=this._.root;return g?g.filter(i):i},onElement:function(i){for(var g=[this._.elements["^"],this._.elements[i.name],this._.elements.$],j,k=0;k<3;k++)if(j=g[k]){j=j.filter(i,this);if(j===false)return null;if(j&&j!=i)return this.onNode(j);if(i.parent&&!i.name)break}return i},onNode:function(i){var g=i.type;return g==y.NODE_ELEMENT?this.onElement(i):g==y.NODE_TEXT?new l.HtmlParser.Text(this.onText(i.value)):
null},onAttribute:function(i,g,j){if(g=this._.attributes[g]){i=g.filter(j,i,this);if(i===false)return false;if(typeof i!="undefined")return i}return j}});l.HtmlParser.Filter=w}});
KISSY.Editor.add("htmlparser-fragment",function(){function w(){this.children=[];this.parent=null;this._={isBlockLike:true,hasInlineStarted:false}}var q=KISSY.Editor;if(!q.HtmlParser.Fragment){var z={colgroup:1,dd:1,dt:1,li:1,option:1,p:1,td:1,tfoot:1,th:1,thead:1,tr:1},p=KISSY,v=q.Utils,B=q.NODE,l=q.XHTML_DTD,y=v.mix({table:1,ul:1,ol:1,dl:1},l.table,l.ul,l.ol,l.dl),i=l.$list,g=l.$listItem;w.FromHtml=function(j,k){function r(e){var n;if(b.length>0)for(var A=0;A<b.length;A++){var t=b[A],C=t.name,I=
l[C],x=d.name&&l[d.name];if((!x||x[C])&&(!e||!I||I[e]||!l[e])){if(!n){u();n=1}t=t.clone();t.parent=d;d=t;b.splice(A,1);A--}}}function u(){for(;h.length;)d.add(h.shift())}function m(e,n,A){n=n||d||a;if(k&&!n.type){var t,C;if((t=e.attributes&&(C=e.attributes._ke_real_element_type)?C:e.name)&&!(t in l.$body)&&!(t in l.$nonBodyContent)){t=d;d=n;s.onTagOpen(k,{});n=d;if(A)d=t}}if(e._.isBlockLike&&e.name!="pre"){A=e.children.length;if((t=e.children[A-1])&&t.type==B.NODE_TEXT)if(C=v.rtrim(t.value))t.value=
C;else e.children.length=A-1}n.add(e);if(e.returnPoint){d=e.returnPoint;delete e.returnPoint}}var s=new q.HtmlParser,a=new w,b=[],h=[],d=a,f=false,o;s.onTagOpen=function(e,n,A){var t=new q.HtmlParser.Element(e,n);if(t.isUnknown&&A)t.isEmpty=true;if(l.$removeEmpty[e])b.push(t);else{if(e=="pre")f=true;else if(e=="br"&&f){d.add(new q.HtmlParser.Text("\n"));return}if(e=="br")h.push(t);else{var C=d.name,I=C&&(l[C]||(d._.isBlockLike?l.div:l.span));if(I&&!t.isUnknown&&!d.isUnknown&&!I[e]){I=false;var x;
if(e in i&&C in i){C=d.children;(C=C[C.length-1])&&C.name in g||m(C=new q.HtmlParser.Element("li"),d);o=d;x=C}else if(e==C)m(d,d.parent);else{if(y[C])o||(o=d);else{m(d,d.parent,true);z[C]||b.unshift(d)}I=true}d=x?x:d.returnPoint||d.parent;if(I){s.onTagOpen.apply(this,arguments);return}}r(e);u();t.parent=d;t.returnPoint=o;o=0;if(t.isEmpty)m(t);else d=t}}};s.onTagClose=function(e){for(var n=b.length-1;n>=0;n--)if(e==b[n].name){b.splice(n,1);return}for(var A=[],t=[],C=d;C.type&&C.name!=e;){C._.isBlockLike||
t.unshift(C);A.push(C);C=C.parent}if(C.type){for(n=0;n<A.length;n++){var I=A[n];m(I,I.parent)}d=C;if(d.name=="pre")f=false;C._.isBlockLike&&u();m(C,C.parent);if(C==d)d=d.parent;b=b.concat(t)}if(e=="body")k=false};s.onText=function(e){if(!d._.hasInlineStarted&&!f){e=v.ltrim(e);if(e.length===0)return}u();r();if(k&&(!d.type||d.name=="body")&&v.trim(e))this.onTagOpen(k,{});f||(e=e.replace(/[\t\r\n ]{2,}|[\t\r\n]/g," "));d.add(new q.HtmlParser.Text(e))};s.onCDATA=function(){};s.onComment=function(){};
s.parse(j);for(u();d.type;){j=d.parent;var c=d;if(k&&(!j.type||j.name=="body")&&!l.$body[c.name]){d=j;s.onTagOpen(k,{});j=d}j.add(c);d=j}return a};p.augment(w,{add:function(j){var k=this.children.length;if(k=k>0&&this.children[k-1]||null){if(j._.isBlockLike&&k.type==B.NODE_TEXT){k.value=v.rtrim(k.value);if(k.value.length===0){this.children.pop();this.add(j);return}}k.next=j}j.previous=k;j.parent=this;this.children.push(j);this._.hasInlineStarted=j.type==B.NODE_TEXT||j.type==B.NODE_ELEMENT&&!j._.isBlockLike},
writeHtml:function(j,k){var r;this.filterChildren=function(){var u=new q.HtmlParser.BasicWriter;this.writeChildrenHtml.call(this,u,k,true);u=u.getHtml();this.children=(new w.FromHtml(u)).children;r=1};!this.name&&k&&k.onFragment(this);this.writeChildrenHtml(j,r?null:k)},writeChildrenHtml:function(j,k){for(var r=0;r<this.children.length;r++)this.children[r].writeHtml(j,k)}});q.HtmlParser.Fragment=w}});
KISSY.Editor.add("htmlparser",function(){function w(){this._={htmlPartsRegex:new RegExp("<(?:(?:\\/([^>]+)>)|(?:!--([\\S|\\s]*?)--\>)|(?:([^\\s>]+)\\s*((?:(?:[^\"'>]+)|(?:\"[^\"]*\")|(?:'[^']*'))*)\\/?>))","g")}}var q=KISSY.Editor;if(!q.HtmlParser){var z=/([\w\-:.]+)(?:(?:\s*=\s*(?:(?:"([^"]*)")|(?:'([^']*)')|([^\s>]+)))|(?=\s|$))/g,p={checked:1,compact:1,declare:1,defer:1,disabled:1,ismap:1,multiple:1,nohref:1,noresize:1,noshade:1,nowrap:1,readonly:1,selected:1},v=q.XHTML_DTD;KISSY.augment(w,{onTagOpen:function(){},
onTagClose:function(){},onText:function(){},onCDATA:function(){},onComment:function(){},parse:function(B){for(var l,y,i=0,g;l=this._.htmlPartsRegex.exec(B);){y=l.index;if(y>i){i=B.substring(i,y);g?g.push(i):this.onText(i)}i=this._.htmlPartsRegex.lastIndex;if(y=l[1]){y=y.toLowerCase();if(g&&v.$cdata[y]){this.onCDATA(g.join(""));g=null}if(!g){this.onTagClose(y);continue}}if(g)g.push(l[0]);else if(y=l[3]){y=y.toLowerCase();var j={},k;l=l[4];var r=!!(l&&l.charAt(l.length-1)=="/");if(l)for(;k=z.exec(l);){var u=
k[1].toLowerCase();k=k[2]||k[3]||k[4]||"";j[u]=!k&&p[u]?u:k}this.onTagOpen(y,j,r);if(!g&&v.$cdata[y])g=[]}else if(y=l[2])this.onComment(y)}B.length>i&&this.onText(B.substring(i,B.length))}});q.HtmlParser=w}});
KISSY.Editor.add("htmlparser-htmlwriter",function(){function w(){w.superclass.constructor.call(this);this.indentationChars="\t";this.selfClosingEnd=" />";this.lineBreakChars="\n";this.forceSimpleAmpersand=false;this.sortAttributes=true;this._.indent=false;this._.indentation="";this._.rules={};var p=q.XHTML_DTD;for(var v in z.mix({},p.$nonBodyContent,p.$block,p.$listItem,p.$tableContent))this.setRules(v,{indent:true,breakBeforeOpen:true,breakAfterOpen:true,breakBeforeClose:!p[v]["#"],breakAfterClose:true});
this.setRules("br",{breakAfterOpen:true});this.setRules("title",{indent:false,breakAfterOpen:false});this.setRules("style",{indent:false,breakBeforeClose:true});this.setRules("pre",{indent:false})}var q=KISSY.Editor,z=q.Utils;if(!q.HtmlParser.HtmlWriter){KISSY.extend(w,q.HtmlParser.BasicWriter,{openTag:function(p){var v=this._.rules[p];if(this._.indent)this.indentation();else if(v&&v.breakBeforeOpen){this.lineBreak();this.indentation()}this._.output.push("<",p)},openTagClose:function(p,v){p=this._.rules[p];
if(v)this._.output.push(this.selfClosingEnd);else{this._.output.push(">");if(p&&p.indent)this._.indentation+=this.indentationChars}p&&p.breakAfterOpen&&this.lineBreak()},attribute:function(p,v){if(typeof v=="string"){this.forceSimpleAmpersand&&(v=v.replace(/&amp;/g,"&"));v=z.htmlEncodeAttr(v)}this._.output.push(" ",p,'="',v,'"')},closeTag:function(p){var v=this._.rules[p];if(v&&v.indent)this._.indentation=this._.indentation.substr(this.indentationChars.length);if(this._.indent)this.indentation();
else if(v&&v.breakBeforeClose){this.lineBreak();this.indentation()}this._.output.push("</",p,">");v&&v.breakAfterClose&&this.lineBreak()},text:function(p){if(this._.indent){this.indentation();p=z.ltrim(p)}this._.output.push(p)},comment:function(p){this._.indent&&this.indentation();this._.output.push("<!--",p,"--\>")},lineBreak:function(){this._.output.length>0&&this._.output.push(this.lineBreakChars);this._.indent=true},indentation:function(){this._.output.push(this._.indentation);this._.indent=false},
setRules:function(p,v){var B=this._.rules[p];if(B)z.mix(B,v);else this._.rules[p]=v}});q.HtmlParser.HtmlWriter=w}});KISSY.Editor.add("htmlparser-text",function(){function w(z){this.value=z;this._={isBlockLike:false}}var q=KISSY.Editor;if(!q.HtmlParser.Text){KISSY.augment(w,{type:q.NODE.NODE_TEXT,writeHtml:function(z,p){var v=this.value;p&&!(v=p.onText(v,this))||z.text(v)}});q.HtmlParser.Text=w}});
KISSY.Editor.add("htmldataprocessor",function(){var w=KISSY.Editor;if(!w.HtmlDataProcessor){var q=KISSY,z=q.UA,p=w.HtmlParser,v=new p.Filter,B=new p.Filter,l={elementNames:[[/^script$/,""],[/^iframe$/,""],[/^style$/,""],[/^link$/,""],[/^meta$/,""]],elements:{},attributes:{"class":function(i){if(/^ke_/.test(i))return i;return false},style:function(i){if(q.trim(i))return q.trim(i).replace(/mso-.+?(;|$)/g,"$1");return false}},attributeNames:[[/^on/,"ck_on"],[/^lang$/,""]]},y={elementNames:[[/^ke:/,""],
[/^\?xml:namespace$/,""]],elements:{embed:function(i){var g=i.parent;if(g&&g.name=="object"){var j=g.attributes.width;g=g.attributes.height;j&&(i.attributes.width=j);g&&(i.attributes.height=g)}},param:function(i){i.children=[];i.isEmpty=true;return i},a:function(i){if(!(i.children.length||i.attributes.name))return false}},attributes:{},attributeNames:[[/^ck_on/,"on"]]};if(z.ie)y.attributes.style=function(i){return i.toLowerCase()};v.addRules(y);B.addRules(l);w.HtmlDataProcessor={htmlFilter:v,dataFilter:B,
toHtml:function(i,g){var j=new p.HtmlWriter;p.Fragment.FromHtml(i,g).writeHtml(j,v);return j.getHtml(true)},toDataFormat:function(i,g){var j=new p.HtmlWriter;i=p.Fragment.FromHtml(i,g);j.reset();i.writeHtml(j,B);return j.getHtml(true)}}}});
KISSY.Editor.add("image",function(w){var q=KISSY.Editor,z=KISSY,p=z.Node,v=z.DOM,B=z.Event,l=q.SimpleOverlay;q.ImageInserter||function(){function y(g){y.superclass.constructor.call(this,g);this._init()}var i=q.TripleButton;y.ATTRS={editor:{}};z.extend(y,z.Base,{_init:function(){var g=this.get("editor").toolBarDiv;this.el=new i({contentCls:"ke-toolbar-image",title:"\u56fe\u50cf",container:g});this.el.on("offClick",this.show,this);q.Utils.lazyRun(this,"_prepare","_real")},_prepare:function(){var g=
this,j=g.get("editor");g.d=new l({title:"\u63d2\u5165\u56fe\u7247",mask:true,width:"350px"});var k=g.d;k.body.html("<div><p><label><span style='color:#0066CC;font-weight:bold;'>\u56fe\u7247\u7f51\u5740\uff1a</span><input class='ke-img-url' style='width:230px' value='http://'/></label></p></div>");k.foot.html("<button class='ke-img-insert'>\u63d2\u5165</button> <button class='ke-img-cancel'>\u53d6\u6d88</button>");g.content=k.el;k=g.content;var r=k.one(".ke-img-cancel"),u=k.one(".ke-img-insert");g.imgUrl=
k.one(".ke-img-url");r.on("click",function(m){g.d.hide();m.halt()});B.on(document,"click",g.hide,g);B.on(j.document,"click",g.hide,g);u.on("click",function(){g._insert()})},hide:function(g){var j=this;v._4e_ascendant(g.target,function(k){return k[0]===j.content[0]||k[0]===j.el.el[0]},true)||this.d.hide()},_real:function(){this.d.show()},_insert:function(){var g=this.get("editor"),j=this.imgUrl.val();if(j){j=new p("<img src='"+j+"'/>",null,g.document);g.insertElement(j);this.d.hide()}},show:function(){this._prepare()}});
q.ImageInserter=y}();w.addPlugin(function(){new q.ImageInserter({editor:w})})});
KISSY.Editor.add("indent",function(w){var q=KISSY.Editor,z={ol:1,ul:1},p=KISSY,v=q.Walker,B=p.DOM,l=p.Node,y=p.UA,i=q.NODE;q.Indent||function(){function g(h){this.type=h;this.indentCssProperty="margin-left";this.indentOffset=40;this.indentUnit="px"}function j(h){return h.type=CKEDITOR.NODE_ELEMENT&&h.is("li")}function k(h,d,f){var o=d.startContainer;for(h=d.endContainer;o&&o.parent()[0]!==f[0];)o=o.parent();for(;h&&h.parent()[0]!==f[0];)h=h.parent();if(o&&h){var c=o;o=[];for(var e=false;!e;){if(c[0]===
h[0])e=true;o.push(c);c=c.next()}if(!(o.length<1)){c=f._4e_parents(true);for(h=0;h<c.length;h++)if(z[c[h]._4e_name()]){f=c[h];break}c=this.type=="indent"?1:-1;h=o[0];e=o[o.length-1];o={};var n=q.ListUtils.listToArray(f,o),A=n[e._4e_getData("listarray_index")].indent;for(h=h._4e_getData("listarray_index");h<=e._4e_getData("listarray_index");h++){n[h].indent+=c;var t=n[h].parent;n[h].parent=new l(t[0].ownerDocument.createElement(t._4e_name()))}for(h=e._4e_getData("listarray_index")+1;h<n.length&&n[h].indent>
A;h++)n[h].indent+=c;e=q.ListUtils.arrayToList(n,o,null,"p",0);c=[];if(this.type=="outdent"){var C;if((C=f.parent())&&C._4e_name()=="li"){n=e.listNode.childNodes;var I;for(h=n.length-1;h>=0;h--)if((I=new l(n[h]))&&I._4e_name()=="li")c.push(I)}}if(e){B.insertBefore(e.listNode,f[0]);f._4e_remove()}if(c&&c.length)for(h=0;h<c.length;h++){for(I=f=c[h];(I=I.next())&&I._4e_name()in z;){y.ie&&!f._4e_first(function(x){return s(x)&&a(x)})&&f[0].appendChild(d.document.createTextNode("\u00a0"));f[0].appendChild(I[0])}B.insertAfter(f[0],
C[0])}for(h in o)o[h]._4e_clearMarkers(o,true)}}}function r(h,d){d=d.createIterator();d.enforceRealBlocks=true;d.enlargeBr=true;for(var f;f=d.getNextParagraph();)u.call(this,h,f)}function u(h,d){h=parseInt(d._4e_style(this.indentCssProperty),10);if(isNaN(h))h=0;h+=(this.type=="indent"?1:-1)*this.indentOffset;if(h<0)return false;h=Math.max(h,0);h=Math.ceil(h/this.indentOffset)*this.indentOffset;d.css(this.indentCssProperty,h?h+this.indentUnit:"");d[0].style.cssText===""&&d[0].removeAttribute("style");
return true}function m(h){m.superclass.constructor.call(this,h);h=this.get("editor").toolBarDiv;this.el=new b({container:h,contentCls:this.get("contentCls"),title:this.get("title")});this.indentCommand=new g(this.get("type"));this._init()}var s=v.whitespaces(true),a=v.bookmark(false,true);p.augment(g,{exec:function(h){h.focus();for(var d=h.getSelection(),f=d&&d.getRanges()[0],o=f.startContainer,c=f.endContainer,e=f.getCommonAncestor();e&&!(e[0].nodeType==i.NODE_ELEMENT&&z[e._4e_name()]);)e=e.parent();
if(e&&o[0].nodeType==i.NODE_ELEMENT&&o._4e_name()in z){o=new v(f);o.evaluator=j;f.startContainer=o.next()}if(e&&c[0].nodeType==i.NODE_ELEMENT&&c._4e_name()in z){o=new v(f);o.evaluator=j;f.endContainer=o.previous()}c=d.createBookmarks(true);if(e){for(o=e._4e_first();o&&o[0]&&o._4e_name()!="li";)o=o.next();var n=f.startContainer;(o[0]==n[0]||o._4e_contains(n))&&u.call(this,h,e)||k.call(this,h,f,e)}else r.call(this,h,f);h.focus();d.selectBookmarks(c)}});var b=q.TripleButton;m.ATTRS={type:{},contentCls:{},
editor:{}};p.extend(m,p.Base,{_init:function(){var h=this.get("editor"),d=this.el;d.on("offClick",this.exec,this);this.get("type")=="outdent"?h.on("selectionChange",this._selectionChange,this):d.set("state",b.OFF)},exec:function(){var h=this.get("editor"),d=this;h.focus();h.fire("save");setTimeout(function(){d.indentCommand.exec(h);h.fire("save");h.notifySelectionChange()},10)},_selectionChange:function(h){this.get("editor");this.get("type");var d=h.path,f=d.blockLimit;h=this.el;if(d.contains(z))h.set("state",
b.OFF);else(d=d.block||f)&&d._4e_style(this.indentCommand.indentCssProperty)?h.set("state",b.OFF):h.set("state",b.DISABLED)}});q.Indent=m}();w.addPlugin(function(){w.addCommand("outdent",new q.Indent({editor:w,title:"\u51cf\u5c11\u7f29\u8fdb\u91cf",contentCls:"ke-toolbar-outdent",type:"outdent"}));w.addCommand("indent",new q.Indent({editor:w,title:"\u589e\u52a0\u7f29\u8fdb\u91cf",contentCls:"ke-toolbar-indent",type:"indent"}))})});
KISSY.Editor.add("justify",function(w){var q=KISSY.Editor,z=KISSY,p=q.TripleButton;q.Justify||function(){function v(l,y,i,g){this.editor=l;this.v=y;this.contentCls=g;this.title=i;this._init()}var B=/(-moz-|-webkit-|start|auto)/i;z.augment(v,{_init:function(){var l=this.editor;this.el=new p({contentCls:this.contentCls,title:this.title,container:l.toolBarDiv});l.on("selectionChange",this._selectionChange,this);this.el.on("click",this._effect,this)},_effect:function(){var l=this.editor,y=l.getSelection(),
i=this.el.get("state");if(y){var g=y.createBookmarks(),j=y.getRanges(),k,r;l.fire("save");for(var u=j.length-1;u>=0;u--){k=j[u].createIterator();for(k.enlargeBr=true;r=k.getNextParagraph();){r.removeAttr("align");i==p.OFF?r.css("text-align",this.v):r.css("text-align","")}}l.focus();l.notifySelectionChange();y.selectBookmarks(g);l.fire("save")}},_selectionChange:function(l){var y=this.el;l=l.path;if(l=l.block||l.blockLimit){l=l.css("text-align").replace(B,"");l==this.v||!l&&this.v=="left"?y.set("state",
p.ON):y.set("state",p.OFF)}}});q.Justify=v}();w.addPlugin(function(){new q.Justify(w,"left","\u5de6\u5bf9\u9f50","ke-toolbar-alignleft");new q.Justify(w,"center","\u5c45\u4e2d\u5bf9\u9f50","ke-toolbar-aligncenter");new q.Justify(w,"right","\u53f3\u5bf9\u9f50","ke-toolbar-alignright")})});
KISSY.Editor.add("link",function(w){var q=KISSY.Editor,z=KISSY,p=z.DOM,v=z.Event,B=q.TripleButton,l=q.Style,y=z.Node,i=q.Range,g=q.SimpleOverlay,j=q.HtmlDataProcessor,k=j&&j.dataFilter;q.Link||function(){function r(a){this.editor=a;this._init()}k&&k.addRules({elements:{a:function(a){for(var b in a.attributes)b=="href"||b=="target"||delete a.attributes[b]}}});var u={element:"a",attributes:{href:"#(href)",target:"#(target)"}};r.init=function(){var a=this;a.d=new g({title:"\u4fee\u6539\u94fe\u63a5",
mask:true,width:"300px"});a.d.body.html(m);a.d.foot.html(s);a.urlEl=a.d.body.one(".ke-link-url");a.targetEl=a.d.body.one(".ke-link-blank");var b=a.d.foot.one(".ke-link-cancel");a.ok=a.d.foot.one(".ke-link-ok");r.ok.on("click",function(h){r.d.link._link();h.halt()},this);b.on("click",function(h){a.d.hide();h.halt()},a);r.init=null};r.tip=function(){var a=new y('<div class="ke-bubbleview-bubble" onmousedown="return false;">\u524d\u5f80\u94fe\u63a5\uff1a  <a href=""  target="_blank" class="ke-bubbleview-url"></a> -     <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -     <span class="ke-bubbleview-link ke-bubbleview-remove">\u53bb\u9664</span></div>');
a._4e_unselectable();this.tipwin=new g({el:a,focusMgr:false});document.body.appendChild(a[0]);this.tipurl=a.one(".ke-bubbleview-url");var b=a.one(".ke-bubbleview-change");a=a.one(".ke-bubbleview-remove");b.on("click",function(h){r.tipwin.link.show();h.halt()});a.on("click",function(h){r.tipwin.link._removeLink();h.halt()});r.tip=null};var m="<div><p><label><span style='color:#0066CC;font-weight:bold;'>\u7f51\u5740\uff1a</span><input class='ke-link-url' style='width:230px' value='http://'/></label></p><p style='margin-top: 5px;padding-left:45px'><label><input class='ke-link-blank' type='checkbox'/> &nbsp; \u5728\u65b0\u7a97\u53e3\u6253\u5f00\u94fe\u63a5</label></p></div>",
s="<button class='ke-link-ok'>\u786e\u5b9a</button> <button class='ke-link-cancel'>\u53d6\u6d88</button>";z.augment(r,{_init:function(){var a=this.editor;this.el=new B({container:a.toolBarDiv,contentCls:"ke-toolbar-link",title:"\u7f16\u8f91\u8d85\u94fe\u63a5 "});this.el.on("click",this.show,this);a.on("selectionChange",this._selectionChange,this)},_prepareTip:function(){r.tip&&r.tip()},_realTip:function(a){var b=a._4e_getOffset(document);b.top+=a.height()+5;r.tipwin.show(b);this._a=a;r.tipwin.link=
this;r.tipurl.html(a.attr("href"));r.tipurl.attr("href",a.attr("href"))},_showTip:function(a){this._prepareTip(a)},_hideTip:function(){r.tipwin&&r.tipwin.hide()},_removeLink:function(){var a=this._a,b=this.editor;b.focus();var h={href:a.attr("href")};if(a._4e_hasAttribute("target"))h.target=a.attr("target");a=new l(u,h);b.fire("save");a.remove(b.document);b.fire("save");this._hideTip();b.focus();b.notifySelectionChange()},_selectionChange:function(a){a=a.path;var b=a.elements;if(a&&b)if(a=a.lastElement)(a=
a._4e_ascendant(function(h){return h._4e_name()==="a"&&!!h.attr("href")},true))?this._showTip(a):this._hideTip()},hide:function(){r.d.hide()},_getSelectedLink:function(){var a=this.editor;if(r.tipwin&&r.tipwin.get("visible")){(a=a.getSelection().getRanges()[0].getCommonAncestor())&&(a=a._4e_ascendant(function(b){return b._4e_name()=="a"&&!!b.attr("href")},true));if(a&&a[0]==r.tipwin.link._a[0])return a}},_link:function(){var a,b=this.editor,h=r.urlEl.val();b.focus();if(z.trim(h)){var d=this._getSelectedLink();
if(d){a=new i(b.document);a.selectNodeContents(d);b.getSelection().selectRanges([a]);this._removeLink()}d={href:h};d.target=r.targetEl[0].checked?"_blank":"_self";a=b.getSelection().getRanges()[0];if(a.collapsed){a=new y("<a href='"+h+"' target='"+d.target+"'>"+h+"</a>",null,b.document);b.insertElement(a)}else{b.fire("save");(new l(u,d)).apply(b.document);b.fire("save")}this.hide();b.focus();b.notifySelectionChange()}},_prepare:function(){r.init&&r.init()},_real:function(){r.d.link=this;var a=this._getSelectedLink();
if(a){r.urlEl.val(a.attr("href"));r.targetEl[0].checked=a.attr("target")=="_blank"}r.d.show()},show:function(){this._prepare()}});q.Utils.lazyRun(r.prototype,"_prepare","_real");q.Utils.lazyRun(r.prototype,"_prepareTip","_realTip");q.Link=r}();w.addPlugin(function(){new q.Link(w);var r=p._4e_getWin(w.document);v.on(r,"scroll",function(){q.Link.tipwin&&q.Link.tipwin.hide()})})});
KISSY.Editor.add("list",function(w){var q=KISSY.Editor,z={ol:1,ul:1},p=["ol","ul"],v=KISSY,B=q.RANGE,l=q.ElementPath,y=q.Walker,i=q.NODE,g=v.UA,j=v.Node,k=v.DOM;q.List||function(){function r(b){this.type=b}function u(b){u.superclass.constructor.call(this,b);b=this.get("editor").toolBarDiv;this.el=new a({contentCls:this.get("contentCls"),title:this.get("title"),container:b});this.listCommand=new r(this.get("type"));this.listCommand.state=this.get("status");this._init()}var m={listToArray:function(b,
h,d,f,o){if(!z[b._4e_name()])return[];f||(f=0);d||(d=[]);for(var c=0,e=b[0].childNodes.length;c<e;c++){var n=new j(b[0].childNodes[c]);if(n._4e_name()=="li"){var A={parent:b,indent:f,element:n,contents:[]};if(o)A.grandparent=o;else{A.grandparent=b.parent();if(A.grandparent&&A.grandparent._4e_name()=="li")A.grandparent=A.grandparent.parent()}h&&n._4e_setMarker(h,"listarray_index",d.length);d.push(A);for(var t=0,C=n[0].childNodes.length,I;t<C;t++){I=new j(n[0].childNodes[t]);I[0].nodeType==i.NODE_ELEMENT&&
z[I._4e_name()]?m.listToArray(I,h,d,f+1,A.grandparent):A.contents.push(I)}}}return d},arrayToList:function(b,h,d,f){d||(d=0);if(!b||b.length<d+1)return null;for(var o=b[d].parent[0].ownerDocument,c=o.createDocumentFragment(),e=null,n=d,A=Math.max(b[d].indent,0),t=null;;){var C=b[n];if(C.indent==A){if(!e||b[n].parent._4e_name()!=e._4e_name()){e=b[n].parent._4e_clone(false,true);c.appendChild(e[0])}t=e[0].appendChild(C.element._4e_clone(false,true)[0]);for(var I=0;I<C.contents.length;I++)t.appendChild(C.contents[I]._4e_clone(true,
true)[0]);n++}else if(C.indent==Math.max(A,0)+1){n=m.arrayToList(b,null,n,f);t.appendChild(n.listNode);n=n.nextIndex}else if(C.indent==-1&&!d&&C.grandparent){t=z[C.grandparent._4e_name()]?C.element._4e_clone(false,true)[0]:C.grandparent._4e_name()!="td"?o.createElement(f):o.createDocumentFragment();for(I=0;I<C.contents.length;I++)t.appendChild(C.contents[I]._4e_clone(true,true)[0]);if(t.nodeType==i.NODE_DOCUMENT_FRAGMENT&&n!=b.length-1){t.lastChild&&t.lastChild.nodeType==i.NODE_ELEMENT&&t.lastChild.getAttribute("type")==
"_moz"&&k._4e_remove(t.lastChild);k._4e_appendBogus(t)}if(t.nodeType==i.NODE_ELEMENT&&k._4e_name(t)==f&&t.firstChild){k._4e_trim(t);e=t.firstChild;if(e.nodeType==i.NODE_ELEMENT&&k._4e_isBlockBoundary(e)){e=o.createDocumentFragment();k._4e_moveChildren(t,e);t=e}}e=k._4e_name(t);if(!g.ie&&(e=="div"||e=="p"))k._4e_appendBogus(t);c.appendChild(t);e=null;n++}else return null;if(b.length<=n||Math.max(b[n].indent,0)<A)break}if(h)for(b=new j(c.firstChild);b&&b[0];){b[0].nodeType==i.NODE_ELEMENT&&b._4e_clearMarkers(h,
true);b=b._4e_nextSourceNode()}return{listNode:c,nextIndex:n}}},s=/^h[1-6]$/;r.prototype={changeListType:function(b,h,d,f){var o=m.listToArray(h.root,d),c=[];for(b=0;b<h.contents.length;b++){var e=h.contents[b];e=e._4e_ascendant("li",true);if(!(!e||!e[0]||e._4e_getData("list_item_processed"))){c.push(e);e._4e_setMarker(d,"list_item_processed",true)}}e=new j(h.root[0].ownerDocument.createElement(this.type));for(b=0;b<c.length;b++){var n=c[b]._4e_getData("listarray_index");o[n].parent=e}d=m.arrayToList(o,
d,null,"p");var A;o=d.listNode.childNodes.length;for(b=0;b<o&&(A=new j(d.listNode.childNodes[b]));b++)A._4e_name()==this.type&&f.push(A);k.insertBefore(d.listNode,h.root[0]);h.root._4e_remove()},createList:function(b,h,d){var f=h.contents;b=h.root[0].ownerDocument;var o=[];if(f.length==1&&f[0][0]===h.root[0]){var c=new j(b.createElement("div"));f[0][0].nodeType!=i.NODE_TEXT&&f[0]._4e_moveChildren(c);f[0][0].appendChild(c[0]);f[0]=c}h=h.contents[0].parent();for(c=0;c<f.length;c++)h=h._4e_commonAncestor(f[c].parent());
for(c=0;c<f.length;c++)for(var e=f[c],n;n=e.parent();){if(n[0]===h[0]){o.push(e);break}e=n}if(!(o.length<1)){f=new j(o[o.length-1][0].nextSibling);c=new j(b.createElement(this.type));for(d.push(c);o.length;){d=o.shift();e=new j(b.createElement("li"));if(s.test(d._4e_name()))e[0].appendChild(d[0]);else{d._4e_copyAttributes(e);d._4e_moveChildren(e);d._4e_remove()}c[0].appendChild(e[0]);g.ie||e._4e_appendBogus()}f[0]?k.insertBefore(c[0],f[0]):h[0].appendChild(c[0])}},removeList:function(b,h,d){function f(I){if((t=
new j(A[I?"firstChild":"lastChild"]))&&!(t[0].nodeType==i.NODE_ELEMENT&&t._4e_isBlockBoundary())&&(C=h.root[I?"_4e_previous":"_4e_next"](y.whitespaces(true)))&&!(t[0].nodeType==i.NODE_ELEMENT&&C._4e_isBlockBoundary({br:1})))k[I?"insertBefore":"insertAfter"](b.document.createElement("br"),t[0])}for(var o=m.listToArray(h.root,d),c=[],e=0;e<h.contents.length;e++){var n=h.contents[e];n=n._4e_ascendant("li",true);if(!(!n||n._4e_getData("list_item_processed"))){c.push(n);n._4e_setMarker(d,"list_item_processed",
true)}}n=null;for(e=0;e<c.length;e++){n=c[e]._4e_getData("listarray_index");o[n].indent=-1;n=n}for(e=n+1;e<o.length;e++)if(o[e].indent>Math.max(o[e-1].indent,0)){c=o[e-1].indent+1-o[e].indent;for(n=o[e].indent;o[e]&&o[e].indent>=n;){o[e].indent+=c;e++}e--}var A=m.arrayToList(o,d,null,"p").listNode,t,C;f(true);f();k.insertBefore(A,h.root);h.root._4e_remove()},exec:function(b){b.focus();var h=b.getSelection(),d=h&&h.getRanges();if(!(!d||d.length<1)){for(var f=h.createBookmarks(true),o=[],c={};d.length>
0;){var e=d.shift(),n=e.getBoundaryNodes(),A=n.startNode,t=n.endNode;A[0].nodeType==i.NODE_ELEMENT&&A._4e_name()=="td"&&e.setStartAt(n.startNode,B.POSITION_AFTER_START);t[0].nodeType==i.NODE_ELEMENT&&t._4e_name()=="td"&&e.setEndAt(n.endNode,B.POSITION_BEFORE_END);e=e.createIterator();for(e.forceBrBreak=false;n=e.getNextParagraph();){A=new l(n);t=A.elements;var C=null,I=false,x=A.blockLimit,D;for(A=t.length-1;A>=0&&(D=t[A]);A--)if(z[D._4e_name()]&&x.contains(D)){x._4e_removeData("list_group_object");
if(A=D._4e_getData("list_group_object"))A.contents.push(n);else{A={root:D,contents:[n]};o.push(A);D._4e_setMarker(c,"list_group_object",A)}I=true;break}if(!I)if(x._4e_getData("list_group_object"))x._4e_getData("list_group_object").contents.push(n);else{A={root:x,contents:[n]};x._4e_setMarker(c,"list_group_object",A);o.push(A)}}}for(d=[];o.length>0;){A=o.shift();if(this.state=="off")z[A.root._4e_name()]?this.changeListType(b,A,c,d):this.createList(b,A,d);else this.state=="on"&&z[A.root._4e_name()]&&
this.removeList(b,A,c)}for(A=0;A<d.length;A++){C=d[A];var G=this;(o=function(J){var N=C[J?"_4e_previous":"_4e_next"](y.whitespaces(true));if(N&&N[0]&&N._4e_name()==G.type){N._4e_remove();N._4e_moveChildren(C,J?true:false)}})();o(true)}q.Utils.clearAllMarkers(c);h.selectBookmarks(f);b.focus()}}};var a=q.TripleButton;u.ATTRS={editor:{},type:{},contentCls:{}};v.extend(u,v.Base,{_init:function(){var b=this.get("editor");this.el.on("click",this._change,this);b.on("selectionChange",this._selectionChange,
this)},_change:function(){var b=this.get("editor"),h=this.get("type"),d=this.el,f=this;b.focus();b.fire("save");setTimeout(function(){f.listCommand.state=d.get("state");f.listCommand.exec(b);b.fire("save");b.fire(h+"Change")},10)},_selectionChange:function(b){this.get("editor");var h=this.get("type"),d=b.path,f;b=this.el;var o=d.blockLimit;if(d=d.elements)for(var c=0;c<d.length&&(f=d[c])&&f[0]!==o[0];c++){var e=v.indexOf(d[c]._4e_name(),p);if(e!==-1)if(p[e]===h){b.set("state",a.ON);return}else break}b.set("state",
a.OFF)}});q.ListUtils=m;q.List=u}();w.addPlugin(function(){new q.List({editor:w,title:"\u9879\u76ee\u5217\u8868",contentCls:"ke-toolbar-ul",type:"ul"});new q.List({editor:w,title:"\u7f16\u53f7\u5217\u8868",contentCls:"ke-toolbar-ol",type:"ol"})})});
KISSY.Editor.add("maximize",function(w){var q=KISSY.Editor,z=KISSY,p=z.UA,v=z.Node,B=z.Event,l=q.TripleButton,y=z.DOM,i;q.Maximize||function(){function g(j){this.editor=j;this._init()}g.init=function(){i=new v("<iframe style='position:absolute;top:-9999px;left:-9999px;' frameborder='0'></iframe>");document.body.appendChild(i[0]);g.init=null};z.augment(g,{_init:function(){this.el=new l({container:this.editor.toolBarDiv,cls:"ke-tool-editor-source",title:"\u5168\u5c4f",contentCls:"ke-toolbar-maximize"});
this.el.on("offClick",this.maximize,this);this.el.on("onClick",this.restore,this);q.Utils.lazyRun(this,"_prepare","_real")},restore:function(){var j=this,k=j.editor;B.remove(window,"resize",j._maximize,j);this._saveEditorStatus();k.wrap.css({height:j.iframeHeight});(new v(document.body)).css({width:"",height:"",overflow:""});document.documentElement.style.overflow="";k.editorWrap.css({position:"static",width:j.editorWrapWidth});i.css({left:"-99999px",top:"-99999px"});window.scrollTo(j.scrollLeft,
j.scrollTop);j.el.set("state",l.OFF);setTimeout(function(){j._restoreEditorStatus()},30)},_saveSate:function(){var j=this.editor;this.iframeHeight=j.wrap._4e_style("height");this.editorWrapWidth=j.editorWrap._4e_style("width");this.scrollLeft=y.scrollLeft();this.scrollTop=y.scrollTop();window.scrollTo(0,0)},_saveEditorStatus:function(){var j=this.editor;if(p.gecko&&j.iframeFocus)this.savedRanges=(j=j.getSelection())&&j.getRanges()},_restoreEditorStatus:function(){var j=this.editor,k=j.getSelection();
if(p.gecko&&j.iframeFocus){this.el.el[0].focus();j.focus();this.savedRanges&&k&&k.selectRanges(this.savedRanges)}if(j.iframeFocus&&k)(j=k.getStartElement())&&j[0]&&j._4e_scrollIntoView()},_maximize:function(){var j=this.editor,k=y.viewportHeight(),r=y.viewportWidth(),u=j.statusDiv?j.statusDiv.height():0,m=j.toolBarDiv.height();if(p.ie){document.documentElement.style.overflow="hidden";document.body.style.overflow="hidden"}else(new v(document.body)).css({width:0,height:0,overflow:"hidden"});j.editorWrap.css({position:"absolute",
zIndex:9999,width:r+"px"});i.css({zIndex:9998,height:k+"px",width:r+"px"});j.editorWrap.offset({left:0,top:0});i.css({left:0,top:0});j.wrap.css({height:k-u-m-14+"px"})},_real:function(){var j=this;this._saveEditorStatus();this._saveSate();this._maximize();this._maximize();B.on(window,"resize",j._maximize,j);this.el.set("state",l.ON);setTimeout(function(){j._restoreEditorStatus()},30)},_prepare:function(){g.init&&g.init()},maximize:function(){this._prepare()}});q.Maximize=g}();w.addPlugin(function(){new q.Maximize(w)})});
KISSY.Editor.add("music",function(w){var q=KISSY.Editor;q.MusicInserter||function(){function z(a){z.superclass.constructor.call(this,a);a=this.get("editor");a._toolbars=a._toolbars||{};a._toolbars.music=this;this._init()}function p(a){return a.replace(/^.+niftyplayer\.swf\?file=/,"")}var v=KISSY,B=v.Node,l=v.DOM,y=q.ContextMenu,i=v.Event,g=q.SimpleOverlay,j=q.TripleButton,k=q.Utils.getFlashUrl,r='<object  width="165" height="37" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,0,0" classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"><param value="'+
(q.Config.base+'plugins/music/niftyplayer.swf?file=#(music)"')+' name="movie"/><param value="high" name="quality"/><param value="#FFFFFF" name="bgcolor"/><embed width="165" height="37" type="application/x-shockwave-flash" swliveconnect="true" src="'+(q.Config.base+'plugins/music/niftyplayer.swf?file=#(music)"')+'quality="high" pluginspage="http://www.macromedia.com/go/getflashplayer" bgcolor="#FFFFFF" /></object>',u=/#\(music\)/g,m=["img.ke_music"];z.ATTRS={editor:{}};z.tip=function(){var a=this,
b=new B('<div class="ke-bubbleview-bubble" onmousedown="return false;">\u97f3\u4e50\u7f51\u5740\uff1a  <a class="ke-bubbleview-url" target="_blank" href="#"></a> -     <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -     <span class="ke-bubbleview-link ke-bubbleview-remove">\u5220\u9664</span></div>');b._4e_unselectable();a.tipwin=new g({el:b,focusMgr:false});document.body.appendChild(b[0]);a.tipurl=b.one(".ke-bubbleview-url");var h=b.one(".ke-bubbleview-change");b=b.one(".ke-bubbleview-remove");
h.on("click",function(d){a.tipwin.music.show();d.halt()});b.on("click",function(d){var f=a.tipwin.music;f.selectedFlash._4e_remove();f.get("editor").notifySelectionChange();d.halt()});a.tip=null};v.extend(z,v.Base,{_init:function(){var a=this.get("editor"),b={};this.el=new j({contentCls:"ke-toolbar-music",title:"\u5206\u4eab\u97f3\u4e50",container:a.toolBarDiv});i.on(a.document,"dblclick",this._dblclick,this);for(var h in s)(function(d){b[d]=function(){a.fire("save");a.focus();s[d](a);a.fire("save")}})(h);
y.register(a.document,{rules:m,width:"120px",funcs:b});this.el.on("offClick",this.show,this);q.Utils.lazyRun(this,"_prepare","_real");a.on("selectionChange",this._selectionChange,this)},_selectionChange:function(a){a=a.path;var b=a.elements;if(a&&b)if(a=a.lastElement)(a=a._4e_ascendant(function(h){return h._4e_name()==="img"&&!!h.hasClass("ke_music")},true))?this._showTip(a):this._hideTip()},_showTip:function(a){this._prepareTip(a)},_hideTip:function(){z.tipwin&&z.tipwin.hide()},_prepareTip:function(){z.tip&&
z.tip()},_realTip:function(a){var b=this.get("editor"),h=a._4e_getOffset(document);h.top+=a.height()+5;z.tipwin.show(h);this.selectedFlash=a;a=b.restoreRealElement(this.selectedFlash);z.tipwin.music=this;z.tipurl.html(p(k(a)));z.tipurl.attr("href",p(k(a)))},_prepare:function(){var a=this,b=a.get("editor");a.d=new g({title:"\u7f16\u8f91\u97f3\u4e50",mask:true,width:"350px"});var h=a.d;h.body.html("<div><p><label><span style='color:#0066CC;font-weight:bold;'>\u97f3\u4e50\u7f51\u5740\uff1a</span><input class='ke-music-url' style='width:230px' value='http://'/></label></p></div>");
h.foot.html("<button class='ke-music-insert'>\u786e\u5b9a</button> <button class='ke-music-cancel'>\u53d6\u6d88</button>");a.content=h.el;var d=a.content;h.on("hide",function(){a.selectedFlash=null;b.focus()});h=d.one(".ke-music-cancel");var f=d.one(".ke-music-insert");a.musicUrl=d.one(".ke-music-url");h.on("click",function(o){a.d.hide();o.halt()});i.on(document,"click",a.hide,a);i.on(b.document,"click",a.hide,a);f.on("click",function(){a._insert()})},hide:function(a){var b=this;l._4e_ascendant(a.target,
function(h){return h[0]===b.content[0]||h[0]===b.el.el[0]})||this.d.hide()},_real:function(){this.d.show()},_insert:function(){var a=this.get("editor"),b=this.musicUrl.val();if(b){b=r.replace(u,b);var h=new B(b,null,a.document);b=a.createFakeElement?a.createFakeElement(h,"ke_music","music",true,b):h;a.insertElement(b);this.d.hide()}},_dblclick:function(a){var b=new B(a.target);if(b._4e_name()==="img"&&b.hasClass("ke_music")){this.selectedFlash=b;this.show();a.halt()}},show:function(){this._prepare();
if(this.selectedFlash){var a=this.get("editor").restoreRealElement(this.selectedFlash);this.musicUrl.val(p(k(a)))}}});q.Utils.lazyRun(z.prototype,"_prepareTip","_realTip");q.MusicInserter=z;var s={"\u7f16\u8f91\u97f3\u4e50":function(a){var b=a.getSelection();if(b=(b=b&&b.getStartElement())&&b._4e_ascendant("img",true))if(b.hasClass("ke_music")){a=a._toolbars.music;a.selectedFlash=b;a.show()}}}}();w.addPlugin(function(){new q.MusicInserter({editor:w})})});
KISSY.Editor.add("preview",function(w){var q=KISSY.Editor,z=KISSY,p=q.TripleButton;q.Preview||function(){function v(B){this.editor=B;this._init()}z.augment(v,{_init:function(){this.el=new p({container:this.editor.toolBarDiv,cls:"ke-tool-editor-source",title:"\u9884\u89c8",contentCls:"ke-toolbar-preview"});this.el.on("offClick",this._show,this)},_show:function(){var B=this.editor,l=640,y=420,i=80;try{var g=window.screen;l=Math.round(g.width*0.8);y=Math.round(g.height*0.7);i=Math.round(g.width*0.1)}catch(j){}B=
B._prepareIFrameHtml().replace(/<body[^>]+>.+<\/body>/,"<body>\n"+B.getData()+"\n</body>");l=window.open("",null,"toolbar=yes,location=no,status=yes,menubar=yes,scrollbars=yes,resizable=yes,width="+l+",height="+y+",left="+i);l.document.open();l.document.write(B);l.document.close()}});q.Preview=v}();w.addPlugin(function(){new q.Preview(w)})});
KISSY.Editor.add("removeformat",function(w){function q(k){this.editor=k;this._init()}function z(k,r){for(var u=0;u<r.length;u++)k.removeAttr(r[u])}var p=KISSY.Editor,v=KISSY,B=p.RANGE,l=p.ElementPath,y=p.NODE,i=p.TripleButton,g="b,big,code,del,dfn,em,font,i,ins,kbd,q,samp,small,span,strike,strong,sub,sup,tt,u,var",j="class,style,lang,width,height,align,hspace,valign".split(",");g=new RegExp("^(?:"+g.replace(/,/g,"|")+")$","i");v.augment(q,{_init:function(){this.el=new i({title:"\u6e05\u9664\u683c\u5f0f",
contentCls:"ke-toolbar-removeformat",container:this.editor.toolBarDiv});this.el.on("offClick",this._remove,this)},_remove:function(){var k=this.editor,r=g;r.lastIndex=0;k.focus();var u=k.getSelection().getRanges();k.fire("save");for(var m=0,s;s=u[m];m++)if(!s.collapsed){s.enlarge(B.ENLARGE_ELEMENT);var a=s.createBookmark(),b=a.startNode,h=a.endNode,d=function(f){for(var o=new l(f),c=o.elements,e=1,n;n=c[e];e++){if(n._4e_equals(o.block)||n._4e_equals(o.blockLimit))break;r.test(n.getName())&&f.breakParent(n)}};
d(b);d(h);for(b=b._4e_nextSourceNode(true,y.NODE_ELEMENT);b;){if(b._4e_equals(h))break;d=b._4e_nextSourceNode(false,y.NODE_ELEMENT);b._4e_name()=="img"&&b.attr("_cke_realelement")||(r.test(b._4e_name())?b._4e_remove(true):z(b,j));b=d}s.moveToBookmark(a)}k.getSelection().selectRanges(u);k.fire("save")}});w.addPlugin(function(){new q(w)})});
KISSY.Editor.add("smiley",function(w){var q=KISSY.Editor,z=KISSY,p=z.DOM,v=z.Event,B=z.Node,l=q.SimpleOverlay,y=q.TripleButton;q.Smiley||function(){function i(k){this.editor=k;this._init()}for(var g="<div class='ke-popup-wrap'><div class='ke-smiley-sprite'>",j=0;j<=98;j++)g+="<a href='#' data-icon='http://a.tbcdn.cn/sys/wangwang/smiley/48x48/"+j+".gif'></a>";g+="</div></div>";z.augment(i,{_init:function(){this.el=new y({contentCls:"ke-toolbar-smiley",title:"\u63d2\u5165\u8868\u60c5",container:this.editor.toolBarDiv});
this.el.on("offClick",this._show,this);q.Utils.lazyRun(this,"_prepare","_real")},_hidePanel:function(k){var r=this;p._4e_ascendant(k.target,function(u){return u[0]===r.el.el[0]})||this.smileyWin.hide()},_selectSmiley:function(k){k.halt();var r=this.editor;k=k.target;var u;if(p._4e_name(k)=="a"&&(u=p.attr(k,"data-icon"))){u=new B("<img src='"+u+"'/>",null,r.document);r.insertElement(u);r.focus();this.smileyWin.hide()}},_prepare:function(){var k=this.editor;this.smileyPanel=new B(g);this.smileyWin=
new l({el:this.smileyPanel,mask:false});document.body.appendChild(this.smileyPanel[0]);this.smileyPanel.on("click",this._selectSmiley,this);v.on(document,"click",this._hidePanel,this);v.on(k.document,"click",this._hidePanel,this)},_real:function(){var k=this.el.el.offset();k.top+=this.el.el.height()+5;if(k.left+this.smileyPanel.width()>p.viewportWidth()-60)k.left=p.viewportWidth()-this.smileyPanel.width()-60;this.smileyWin.show(k)},_show:function(k){this._prepare(k)}});q.Smiley=i}();w.addPlugin(function(){new q.Smiley(w)})});
KISSY.Editor.add("sourcearea",function(w){var q=KISSY.Editor,z=KISSY,p=z.UA,v=q.TripleButton;q.SourceArea||function(){function B(l){this.editor=l;this._init()}z.augment(B,{_init:function(){var l=this.editor;this.el=new v({container:l.toolBarDiv,cls:"ke-tool-editor-source",title:"\u6e90\u7801",contentCls:"ke-toolbar-source"});this.el.on("offClick",this._show,this);this.el.on("onClick",this._hide,this);l.textarea.on("mousedown",function(y){y.stopPropagation()})},_show:function(){var l=this.editor,y=
this.el;l.textarea.val(l.getData());l._showSource();y.set("state",v.ON)},_hide:function(){var l=this.editor,y=l.textarea,i=this.el;l._hideSource();l.setData(y.val());if(p.gecko&&l.iframeFocus){i.el[0].focus();l.focus()}i.set("state",v.OFF)}});q.SourceArea=B}();w.addPlugin(function(){new q.SourceArea(w)})});
KISSY.Editor.add("table",function(w,q){var z=KISSY.Editor,p=KISSY,v=p.Node,B=p.DOM,l=z.Walker,y=p.UA,i=z.NODE,g=z.TripleButton,j=z.SimpleOverlay,k=z.ContextMenu,r=["tr","th","td","tbody","table"],u=p.trim,m;m=(y.ie===6?["table.%2,","table.%2 td, table.%2 th,","{","border : #d3d3d3 1px dotted","}"]:[" table.%2,"," table.%2 > tr > td,  table.%2 > tr > th,"," table.%2 > tbody > tr > td,  table.%2 > tbody > tr > th,"," table.%2 > thead > tr > td,  table.%2 > thead > tr > th,"," table.%2 > tfoot > tr > td,  table.%2 > tfoot > tr > th",
"{","border : #d3d3d3 1px dotted","}"]).join("").replace(/%2/g,"ke_show_border");z.TableUI||function(){function s(x){this.editor=x;this.selectedTable=null;x._toolbars=x._toolbars||{};x._toolbars.table=this;this._init()}function a(x){return u(x).length!=0}function b(x){function D($){if(!(N.length>0))if($[0].nodeType==i.NODE_ELEMENT&&C.test($._4e_name())&&!$._4e_getData("selected_cell")){$._4e_setMarker(M,"selected_cell",true);N.push($)}}for(var G=x.createBookmarks(),J=x.getRanges(),N=[],M={},Q=0;Q<
J.length;Q++){var R=J[Q];if(R.collapsed){R=R.getCommonAncestor();(R=R._4e_ascendant("td",true)||R._4e_ascendant("th",true))&&N.push(R)}else{R=new l(R);var W;for(R.guard=D;W=R.next();)if((W=W.parent())&&C.test(W._4e_name())&&!W._4e_getData("selected_cell")){W._4e_setMarker(M,"selected_cell",true);N.push(W)}}}z.Utils.clearAllMarkers(M);x.selectBookmarks(G);return N}function h(x){x=x.cells;for(var D=0;D<x.length;D++){x[D].innerHTML="";y.ie||(new v(x[D]))._4e_appendBogus()}}function d(x,D){if(x=x.getStartElement()._4e_ascendant("tr")){var G=
x._4e_clone(true);G.insertBefore(x);h(D?G[0]:x[0])}}function f(x){if(x instanceof z.Selection){var D=b(x),G=D.length;x=[];for(var J,N,M=0;M<G;M++){var Q=D[M].parent(),R=Q[0].rowIndex;!M&&(J=R-1);x[R]=Q;M==G-1&&(N=R+1)}M=Q._4e_ascendant("table");J=new v(N<M[0].rows.length&&M[0].rows[N]||J>0&&M[0].rows[J]||M[0].parentNode);for(M=x.length;M>=0;M--)x[M]&&f(x[M]);return J}else if(x instanceof v){M=x._4e_ascendant("table");M[0].rows.length==1?M._4e_remove():x._4e_remove()}return 0}function o(x,D){x=x.getStartElement();
if(x=x._4e_ascendant("td",true)||x._4e_ascendant("th",true))for(var G=x._4e_ascendant("table"),J=x[0].cellIndex,N=0;N<G[0].rows.length;N++){var M=G[0].rows[N];if(!(M.cells.length<J+1)){x=new v(M.cells[J].cloneNode(false));y.ie||x._4e_appendBogus();M=new v(M.cells[J]);D?x.insertBefore(M):x.insertAfter(M)}}}function c(x){var D=[],G=x[0]&&x[0]._4e_ascendant("table"),J,N,M,Q;J=0;for(N=x.length;J<N;J++)D.push(x[J][0].cellIndex);D.sort();J=1;for(N=D.length;J<N;J++)if(D[J]-D[J-1]>1){M=D[J-1]+1;break}M||
(M=D[0]>0?D[0]-1:D[D.length-1]+1);x=G[0].rows;J=0;for(N=x.length;J<N;J++)if(Q=x[J].cells[M])break;return Q?new v(Q):G.previous()}function e(x){if(x instanceof z.Selection){var D=b(x),G=c(D);for(x=D.length-1;x>=0;x--)D[x]&&e(D[x]);return G}else if(x instanceof v){D=x._4e_ascendant("table");if(!D)return null;G=x[0].cellIndex;for(x=D[0].rows.length-1;x>=0;x--){var J=new v(D[0].rows[x]);if(!G&&J[0].cells.length==1)f(J);else J[0].cells[G]&&J[0].removeChild(J[0].cells[G])}}return null}function n(x,D){var G=
new z.Range(x[0].ownerDocument);if(!G.moveToElementEditablePosition(x,D?true:q)){G.selectNodeContents(x);G.collapse(D?false:true)}G.select(true)}var A=z.HtmlDataProcessor,t=A&&A.dataFilter;A=A&&A.htmlFilter;t&&t.addRules({elements:{table:function(x){x=x.attributes;var D=x["class"],G=parseInt(x.border,10);if(!G||G<=0)x["class"]=(D||"")+" ke_show_border"}}});A&&A.addRules({elements:{table:function(x){x=x.attributes;var D=x["class"];if(D)x["class"]=p.trim(D.replace("ke_show_border","").replace(/\s{2}/,
" "))}}});p.augment(s,{_init:function(){var x=this.editor,D={};this.el=new g({contentCls:"ke-toolbar-table",title:"\u8868\u683c",container:x.toolBarDiv});this.el.on("offClick",this._tableShow,this);for(var G in I)(function(J){D[J]=function(){x.fire("save");x.focus();I[J](x);x.fire("save")}})(G);k.register(x.document,{rules:r,width:"120px",funcs:D});z.Utils.lazyRun(this,"_prepareTableShow","_realTableShow")},_tableInit:function(){var x=this,D=x.editor,G=new j({width:"350px",mask:true,title:"\u7f16\u8f91\u8868\u683c"});
G.body.html("<table class='ke-table-config'><tr><td><label>\u884c\u6570\uff1a <input value='2' class='ke-table-rows ke-table-create-only' size='8'/></label></td><td><label>\u5bbd\u5ea6\uff1a <input value='200' class='ke-table-width' size='8'/></label> <select class='ke-table-width-unit'><option value='px'>\u50cf\u7d20</option><option value='%'>\u767e\u5206\u6bd4</option></select></td></tr><tr><td><label>\u5217\u6570\uff1a <input class='ke-table-cols ke-table-create-only' value='3' size='8'/></label></td><td><label>\u9ad8\u5ea6\uff1a <input value='' class='ke-table-height' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td><label>\u5bf9\u9f50\uff1a <select class='ke-table-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option><option value='center'>\u4e2d\u95f4\u5bf9\u9f50</option></select></label></td><td><label>\u95f4\u8ddd\uff1a <input value='1' class='ke-table-cellspacing' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td><label>\u6807\u9898\u683c\uff1a <select class='ke-table-head ke-table-create-only'><option value=''>\u65e0</option><option value='1'>\u6709</option></select></td><td><label>\u8fb9\u8ddd\uff1a <input value='1' class='ke-table-cellpadding' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td></td><td><label>\u8fb9\u6846\uff1a <input value='1' class='ke-table-border' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td colspan='2'><label>\u6807\u9898\uff1a<input class='ke-table-caption' style='width:270px'></label></td></tr></table>");
G.foot.html("<button class='ke-table-ok'>\u786e\u5b9a</button> <button class='ke-table-cancel'>\u53d6\u6d88</button>");G.twidth=G.body.one(".ke-table-width");G.theight=G.body.one(".ke-table-height");G.tcellspacing=G.body.one(".ke-table-cellspacing");G.tcellpadding=G.body.one(".ke-table-cellpadding");G.tborder=G.body.one(".ke-table-border");G.tcaption=G.body.one(".ke-table-caption");G.talign=G.body.one(".ke-table-align");G.trows=G.body.one(".ke-table-rows");G.tcols=G.body.one(".ke-table-cols");G.thead=
G.body.one(".ke-table-head");var J=G.foot.one(".ke-table-ok"),N=G.foot.one(".ke-table-cancel");G.twidthunit=G.body.one(".ke-table-width-unit");x.tableDialog=G;J.on("click",x._tableOk,x);G.on("hide",function(){x.selectedTable=null;D.focus()});N.on("click",function(){G.hide()})},_tableOk:function(){this.selectedTable?this._modifyTable():this._genTable()},_modifyTable:function(){var x=this.tableDialog,D=this.selectedTable,G=D.one("caption");a(x.talign.val())&&D.attr("align",u(x.talign.val()));a(x.tcellspacing.val())&&
D.attr("cellspacing",u(x.tcellspacing.val()));a(x.tcellpadding.val())&&D.attr("cellpadding",u(x.tcellpadding.val()));a(x.tborder.val())&&D.attr("border",u(x.tborder.val()));!a(x.tborder.val())||x.tborder.val()=="0"?D.addClass("ke_show_border"):D.removeClass("ke_show_border");a(x.twidth.val())&&D.css("width",u(x.twidth.val())+x.twidthunit.val());a(x.theight.val())&&D.css("height",u(x.theight.val()));if(a(x.tcaption.val()))G&&G[0]?G.html(u(x.tcaption.val())):(new v("<caption><span>"+u(x.tcaption.val())+
"</span></caption>")).insertBefore(D[0].firstChild);else G&&G._4e_remove();x.hide()},_genTable:function(){var x=this.tableDialog,D="<table ",G,J=parseInt(x.tcols.val()),N=parseInt(x.trows.val()),M=y.ie?"":"<br/>",Q=this.editor;if(p.trim(x.talign.val()).length!=0)D+="align='"+p.trim(x.talign.val())+"' ";if(p.trim(x.tcellspacing.val()).length!=0)D+="cellspacing='"+p.trim(x.tcellspacing.val())+"' ";if(p.trim(x.tcellpadding.val()).length!=0)D+="cellpadding='"+p.trim(x.tcellpadding.val())+"' ";if(p.trim(x.tborder.val()).length!=
0)D+="border='"+p.trim(x.tborder.val())+"' ";if(p.trim(x.twidth.val()).length!=0||p.trim(x.theight.val()).length!=0){D+="style='";if(p.trim(x.twidth.val()).length!=0)D+="width:"+p.trim(x.twidth.val())+x.twidthunit.val()+";";if(p.trim(x.theight.val()).length!=0)D+="height:"+p.trim(x.theight.val())+"px;";D+="' "}if(p.trim(x.tborder.val()).length==0||p.trim(x.tborder.val())=="0")D+="class='ke_show_border' ";D+=">";if(p.trim(x.tcaption.val()))D+="<caption><span>"+p.trim(x.tcaption.val())+"</span></caption>";
if(x.thead.val()){D+="<thead>";D+="<tr>";for(G=0;G<J;G++)D+="<th>"+M+"</th>";D+="</tr>";D+="</thead>"}D+="<tbody>";for(var R=0;R<N;R++){D+="<tr>";for(G=0;G<J;G++)D+="<td>"+M+"</td>";D+="</tr>"}D+="</tbody>";D+="</table>";D=new v(D,null,Q.document);Q.insertElement(D);x.hide()},_fillTableDialog:function(){var x=this.tableDialog,D=this.selectedTable,G=D.one("caption");x.talign.val(D.attr("align")||"");x.tcellspacing.val(D.attr("cellspacing")||"");x.tcellpadding.val(D.attr("cellpadding")||"");x.tborder.val(D.attr("border")|
"");var J=D._4e_style("width")||"";x.twidth.val(J.replace(/px|%/i,""));J.indexOf("%")!=-1?x.twidthunit.val("%"):x.twidthunit.val("px");x.theight.val((D._4e_style("height")||"").replace(/px|%/i,""));J="";if(G)J=G.text();x.tcaption.val(J);x.trows.val(D.one("tbody").children().length);x.tcols.val(D.one("tr").children().length);x.thead.val(D._4e_first(function(N){return N._4e_name()=="thead"})?"1":"")},_realTableShow:function(){if(this.selectedTable){this._fillTableDialog();this.tableDialog.body.all(".ke-table-create-only").attr("disabled",
"disabled")}else this.tableDialog.body.all(".ke-table-create-only").removeAttr("disabled");this.tableDialog.show()},_prepareTableShow:function(){this._tableInit()},_tableShow:function(){this._prepareTableShow()}});var C=/^(?:td|th)$/,I={"\u8868\u683c\u5c5e\u6027":function(x){var D=x.getSelection();if(D=(D=D&&D.getStartElement())&&D._4e_ascendant("table",true)){x=x._toolbars.table;x.selectedTable=D;x._tableShow()}},"\u5220\u9664\u8868\u683c":function(x){var D=(x=x.getSelection())&&x.getStartElement();
if(D=D&&D._4e_ascendant("table",true)){x.selectElement(D);var G=x.getRanges()[0];G.collapse();x.selectRanges([G]);x=D.parent();x[0].childNodes.length==1&&x._4e_name()!="body"?x._4e_remove():D._4e_remove()}},"\u5220\u9664\u884c":function(x){x=x.getSelection();n(f(x),q)},"\u5220\u9664\u5217":function(x){x=x.getSelection();(x=e(x))&&n(x,true)},"\u5728\u4e0a\u65b9\u63d2\u5165\u884c":function(x){x=x.getSelection();d(x,true)},"\u5728\u4e0b\u65b9\u63d2\u5165\u884c":function(x){x=x.getSelection();d(x,q)},
"\u5728\u5de6\u4fa7\u63d2\u5165\u5217":function(x){x=x.getSelection();o(x,true)},"\u5728\u53f3\u4fa7\u63d2\u5165\u5217":function(x){x=x.getSelection();o(x,q)}};z.TableUI=s}();w.addPlugin(function(){var s=w.document;new z.TableUI(w);var a=B.create("<style>",null,s);s.getElementsByTagName("head")[0].appendChild(a);if(a.styleSheet)a.styleSheet.cssText=m;else a.appendChild(s.createTextNode(m))})});
KISSY.Editor.add("templates",function(w){var q=KISSY.Editor,z=KISSY,p=z.Node,v=q.TripleButton,B=q.SimpleOverlay;q.TplUI||function(){function l(y){this.editor=y;this._init()}z.augment(l,{_init:function(){(new v({container:this.editor.toolBarDiv,contentCls:"ke-toolbar-template",title:"\u6a21\u677f"})).on("click",this._show,this);q.Utils.lazyRun(this,"_prepare","_real")},_prepare:function(){for(var y=this.editor,i=y.cfg.pluginConfig.templates,g="<div class='ke-tpl'>",j=0;j<i.length;j++)g+="<a href='javascript:void(0)' class='ke-tpl-list' tabIndex='-1'>"+
i[j].demo+"</a>";g+="</div>";this._initDialogOk=true;var k=new B({mask:true,title:"\u5185\u5bb9\u6a21\u677f"});k.body.html(g);g=k.body.all(".ke-tpl-list");k.on("hide",function(){y.focus()});g.on("click",function(r){r.halt();r=(new p(r.target))._4e_index();r!=-1&&y.insertHtml(i[r].html);k.hide()});this.ui=k},_real:function(){this.ui.show()},_show:function(){this._prepare()}});q.TplUI=l}();w.addPlugin(function(){new q.TplUI(w)})});
KISSY.Editor.add("undo",function(w){var q=KISSY.Editor,z=KISSY,p=q.Utils.arrayCompare,v=z.UA,B=z.Event;q.UndoManager||function(){function l(m){var s=m._getRawData();m=s&&m.getSelection();this.contents=s;this.bookmarks=m&&m.createBookmarks2(true)}function y(m,s,a){this.s=m;this.fn=s;this.scope=a||window;this.bufferTimer=null}function i(m){this.history=[];this.index=0;this.editor=m;this.bufferTimer=new y(500,this.save,this);this._init()}function g(m,s,a,b){this.editor=m;this.title=a;this.text=s;this.contentCls=
b;this._init()}z.augment(l,{equals:function(m){if(this.contents!=m.contents)return false;var s=this.bookmarks;m=m.bookmarks;if(s||m){if(!s||!m||s.length!=m.length)return false;for(var a=0;a<s.length;a++){var b=s[a],h=m[a];if(b.startOffset!=h.startOffset||b.endOffset!=h.endOffset||!p(b.start,h.start)||!p(b.end,h.end))return false}}return true}});z.augment(y,{run:function(){if(this.bufferTimer){clearTimeout(this.bufferTimer);this.bufferTimer=null}var m=this;this.bufferTimer=setTimeout(function(){m.fn.call(m.scope)},
this.s)}});var j={16:1,17:1,18:1},k={37:1,38:1,39:1,40:1};z.augment(i,{_keyMonitor:function(){var m=this.editor;B.on(m.document,"keydown",function(s){var a=s.keyCode;if(!(a in k||a in j))if(a===90&&(s.ctrlKey||s.metaKey)){m.fire("restore",{d:-1});s.halt()}else if(a===89&&(s.ctrlKey||s.metaKey)){m.fire("restore",{d:1});s.halt()}else m.fire("save",{buffer:1})})},_init:function(){var m=this,s=m.editor;s.on("save",function(a){a.buffer?m.bufferTimer.run():m.save()});s.on("restore",this.restore,this);m._keyMonitor()},
save:function(){this.history.length>this.index+1&&this.history.splice(this.index+1,this.history.length-this.index-1);var m=this.editor,s=this.history.length>0?this.history[this.history.length-1]:null,a=new l(this.editor);if(!s||!s.equals(a)){this.history.length===30&&this.history.shift();this.history.push(a);this.index=this.history.length-1;m.fire("afterSave",{history:this.history,index:this.index})}},restore:function(m){m=m.d;var s=this.editor,a=this.history.length>0?this.history[this.index+m]:null;
if(a){s._setRawData(a.contents);if(a.bookmarks)this.editor.getSelection().selectBookmarks(a.bookmarks);else if(v.ie){a=this.editor.document.body.createTextRange();a.collapse(true);a.select()}this.index+=m;s.fire("afterRestore",{history:this.history,index:this.index});s.notifySelectionChange()}}});var r=q.TripleButton,u={redo:1,undo:-1};z.augment(g,{_init:function(){var m=this,s=m.editor;m.el=new r({contentCls:m.contentCls,title:m.title,container:s.toolBarDiv});this.el.set("state",r.DISABLED);s.on("afterSave",
this._respond,this);s.on("afterRestore",this._respond,this);m.el.on("offClick",function(){s.fire("restore",{d:u[m.text]})})},_respond:function(m){this.updateUI(m.history,m.index)},updateUI:function(m,s){if(this.text=="undo")s>0&&m.length>0?this.el.set("state",r.OFF):this.el.set("state",r.DISABLED);else if(this.text=="redo")s<m.length-1?this.el.set("state",r.OFF):this.el.set("state",r.DISABLED)}});q.UndoManager=i;q.RestoreUI=g}();w.addPlugin(function(){new q.UndoManager(w);new q.RestoreUI(w,"undo",
"\u64a4\u9500","ke-toolbar-undo");new q.RestoreUI(w,"redo","\u91cd\u505a","ke-toolbar-redo")})});
