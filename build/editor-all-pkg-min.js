KISSY.add("editor",function(x,t){function B(v,a){var d=this;if(!(d instanceof B))return new B(v,a);if(x.isString(v))v=x.one(v);v[0]||(v=new Node(v));d.cfg=a||{pluginConfig:{}};x.app(d,x.EventTarget);d.use=function(g){x.use.call(d,g,function(){d.on("dataReady",function(){d.setData(v.val())})},{order:true,global:B})};d.init(v);return t}function p(v){if(!u)return"build/"+v.replace(/\.(js|css)/i,"-min.$1");if(u==="dev")return v;return"build/"+v}x.app(B,x.EventTarget);B.Config.base=x.Config.base+"editor/";
var u=x.Config.debug,A={htmlparser:{attach:false,path:p("plugins/htmldataprocessor/htmlparser/htmlparser.js")}},m=["utils","focusmanager","definition","dtd","dom","elementpath","walker","range","domiterator","selection","styles"],w=["clipboard",{name:"color"},{name:"elementpaths"},"enterkey","fakeobjects",{name:"flash",requires:["contextmenu","fakeobjects","overlay"]},{name:"font",requires:["select"]},"format",{name:"htmldataprocessor",requires:["htmlparser-text"]},{name:"image",requires:["overlay"]},
"indent","justify",{name:"link",requires:["bubbleview"]},"list","maximize","music","preview","removeformat",{name:"smiley"},"sourcearea",{name:"table",requires:["overlay","contextmenu"]},{name:"templates",requires:["overlay"]},"undo"],j=[{name:"htmlparser-basicwriter",requires:["htmlparser"]},{name:"htmlparser-element",requires:["htmlparser-fragment"]},{name:"htmlparser-filter",requires:["htmlparser-element"]},{name:"htmlparser-fragment",requires:["htmlparser-htmlwriter"]},{name:"htmlparser-htmlwriter",
requires:["htmlparser-basicwriter"]},{name:"htmlparser-text",requires:["htmlparser-comment"]},{name:"htmlparser-comment",requires:["htmlparser-filter"]}],f=[{name:"button"},{name:"overlay"},{name:"contextmenu",requires:["overlay"]},{name:"bubbleview",requires:["overlay"]},{name:"select",requires:["overlay"]}],i,l,r,q,o;i=0;for(l=f.length;i<l;i++){q=r=f[i];o=t;if(!x.isString(r)){o=r.requires;q=r.name}A[q]={attach:false,requires:o,path:p("ui/"+q+".js"),csspath:r.useCss?p("ui/"+q+".css"):""}}i=0;for(l=
w.length;i<l;i++){q=r=w[i];o=["button"];if(!x.isString(r)){r.requires&&(o=o.concat(r.requires));q=r.name}A[q]={attach:false,requires:o,csspath:r.useCss?p("plugins/"+q+"/plugin.css"):t,path:p("plugins/"+q+"/plugin.js")}}i=0;for(l=j.length;i<l;i++){r=j[i];o=t;if(!x.isString(r)){o=r.requires;r=r.name}A[r]={attach:false,requires:o,path:p("plugins/htmldataprocessor/htmlparser/"+r.substring(11)+".js")}}B.add(A);A={};i=0;for(l=m.length;i<l;i++){r=m[i];A[r]={host:"editor",requires:i>0?m[i-1]:[]}}B.add(A);
x.Editor=B});
KISSY.Editor.add("utils",function(x){var t=KISSY,B=t.Node,p=t.DOM,u=t.Config.debug,A=t.UA;x.Utils={getFlashUrl:function(m){var w="",j=x.NODE;if(m._4e_name()=="object"){m=m[0].childNodes;for(var f=0;f<m.length;f++)if(m[f].nodeType==j.NODE_ELEMENT)if((p.attr(m[f],"name")||"").toLowerCase()=="movie")w=p.attr(m[f],"value");else if(p._4e_name(m[f])=="embed")w=p.attr(m[f],"src");else p._4e_name(m[f])=="object"&&p.attr(m[f],"data")}else if(m._4e_name()=="embed")w=m.attr("src");return w},debugUrl:function(m){if(!u)return"build/"+m.replace(/\.(js|css)/i,
"-min.$1");if(u==="dev")return m;return"build/"+m},lazyRun:function(m,w,j){var f=m[w],i=m[j];m[w]=function(){f.apply(this,arguments);m[w]=m[j];return i.apply(this,arguments)}},getXY:function(m,w,j,f){j=j.defaultView||j.parentWindow;m-=p.scrollLeft(j);w-=p.scrollTop(j);if(f)if(j!=(f.defaultView||f.parentWindow)&&j.frameElement){f=p._4e_getOffset(j.frameElement,f);m+=f.left;w+=f.top}return{left:m,top:w}},tryThese:function(){for(var m,w=0,j=arguments.length;w<j;w++){var f=arguments[w];try{m=f();break}catch(i){}}return m},
arrayCompare:function(m,w){if(!m&&!w)return true;if(!m||!w||m.length!=w.length)return false;for(var j=0;j<m.length;j++)if(m[j]!==w[j])return false;return true},getByAddress:function(m,w,j){m=m.documentElement;for(var f=0;m&&f<w.length;f++){var i=w[f];if(j)for(var l=-1,r=0;r<m.childNodes.length;r++){var q=m.childNodes[r];if(!(j===true&&q.nodeType==3&&q.previousSibling&&q.previousSibling.nodeType==3)){l++;if(l==i){m=q;break}}}else m=m.childNodes[i]}return m?new B(m):null},clearAllMarkers:function(m){for(var w in m)m[w]._4e_clearMarkers(m,
true)},htmlEncodeAttr:function(m){return m.replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/,"&gt;")},ltrim:function(m){return m.replace(/^\s+/,"")},rtrim:function(m){return m.replace(/\s+$/,"")},trim:function(m){return this.ltrim(this.rtrim(m))},mix:function(){for(var m={},w=0;w<arguments.length;w++)m=t.mix(m,arguments[w]);return m},isCustomDomain:function(){if(!A.ie)return false;var m=document.domain,w=window.location.hostname;return m!=w&&m!="["+w+"]"}}});
KISSY.Editor.add("focusmanager",function(x){function t(){this.iframeFocus=true;w=this}function B(){this.iframeFocus=false;w=null}var p=KISSY,u=p.DOM,A=p.Event;p={};var m={},w;p={refreshAll:function(){for(var j in m){var f=m[j];f.document.designMode="off";f.document.designMode="on"}},currentInstance:function(){return w},getInstance:function(j){return m[j]},add:function(j){var f=u._4e_getWin(j.document);A.on(f,"focus",t,j);A.on(f,"blur",B,j)},register:function(j){m[j._UUID]=j},remove:function(j){delete m[j._UUID];
var f=u._4e_getWin(j.document);A.remove(f,"focus",t,j);A.remove(f,"blur",B,j)}};x.focusManager=p});
KISSY.Editor.add("definition",function(x){function t(o){return f+"<html><head><title>kissy-editor</title><link href='"+x.Config.base+i+"' rel='stylesheet'/></head><body class='ke-editor'>&nbsp;</body><html>"+(o?'<script id="ke_actscrpt" type="text/javascript">'+(x.Utils.isCustomDomain()?'document.domain="'+document.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+o+'");<\/script>':"")}var B=KISSY,p=B.UA,u=B.DOM,A=B.Node,m=B.Event,w=x.focusManager,j=x.Utils.tryThese,f="<!doctype html>",i=
x.Utils.debugUrl("assets/editor-iframe.css"),l=1,r="document.open();"+(x.Utils.isCustomDomain()?'document.domain="'+document.domain+'";':"")+"document.close();",q="<div  class='ke-editor-wrap'  > <div class='"+".ke-editor-tools".substring(1)+"'></div><div class='"+".ke-textarea-wrap".substring(1)+'\'><iframe  style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor"  src="'+(p.ie?"javascript:void(function(){"+encodeURIComponent(r)+"}())":"")+'"  tabIndex="'+
(p.webkit?-1:"$(tabIndex)")+'"  allowTransparency="true" ></iframe></div><div class=\''+".ke-editor-status".substring(1)+"'></div></div>";B.augment(x,{init:function(o){var v=this,a=new A(q.replace(/\$\(tabIndex\)/,o.attr("tabIndex")));a.on("mousedown",function(h){if(p.webkit){var c=u._4e_name(h.target);if(c=="select"||c=="option")return true}h.halt()});v.editorWrap=a;v._UUID=l++;w.register(v);v.wrap=a.one(".ke-textarea-wrap");v.iframe=v.wrap.one("iframe");v.toolBarDiv=a.one(".ke-editor-tools");v.textarea=
o;v.statusDiv=a.one(".ke-editor-status");v.toolBarDiv._4e_unselectable();v._commands={};v._plugins={};var d=o._4e_style("width"),g=o._4e_style("height");if(d){a.css("width",d);o.css("width","100%")}v.textarea.css("display","none");a.insertAfter(o);v.wrap[0].appendChild(o[0]);if(g){v.wrap.css("height",g);o.css("height","100%")}o=v.iframe;v.on("dataReady",function(){v.ready=true;x.fire("instanceCreated",{editor:v})});p.gecko?o.on("load",v._setUpIFrame,v):v._setUpIFrame()},addCommand:function(o,v){this._commands[o]=
v},execCommand:function(o){this.fire("save");this._commands[o].exec(this);this.fire("save")},getData:function(){if(this.htmlDataProcessor)return this.htmlDataProcessor.toHtml(this.document.body.innerHTML,"p");return this.document.body.innerHTML},setData:function(o){if(this.htmlDataProcessor)o=this.htmlDataProcessor.toDataFormat(o,"p");this.document.body.innerHTML=o},sync:function(){this.textarea.val(this.getData())},_getRawData:function(){return this.document.body.innerHTML},_setRawData:function(o){this.document.body.innerHTML=
o},_hideSource:function(){this.iframe.css("display","");this.textarea.css("display","none");this.toolBarDiv.children().css("visibility","");this.statusDiv.children().css("visibility","")},_showSource:function(){this.textarea.css("display","");this.iframe.css("display","none");this.toolBarDiv.children().css("visibility","hidden");this.toolBarDiv.all(".ke-tool-editor-source").css("visibility","");this.statusDiv.children().css("visibility","hidden");p.ie<8&&this.textarea.css("height",this.wrap.css("height"))},
_prepareIFrameHtml:t,getSelection:function(){var o=new x.Selection(this.document);return!o||o.isInvalid?null:o},focus:function(){var o=u._4e_getWin(this.document);p.webkit&&o&&o.parent&&o.parent.focus();o&&o.focus();this.document&&this.document.body.focus();this.notifySelectionChange()},blur:function(){u._4e_getWin(this.document).blur();this.document&&this.document.body.blur()},_setUpIFrame:function(){function o(){h=g.document;v.document=h;a.detach();h.open("text/html","replace");h.write(d);h.close()}
var v=this,a=v.iframe,d=t(v._UUID),g=a[0].contentWindow,h;try{h=g.document}catch(c){a[0].src=a[0].src;if(p.ie&&p.ie<7){setTimeout(o,10);return}}o()},addPlugin:function(o){this.ready?o():this.on("dataReady",o)},_monitor:function(){var o=this;o._monitorId&&clearTimeout(o._monitorId);o._monitorId=setTimeout(function(){var v=o.getSelection();if(v&&!v.isInvalid){v=v.getStartElement();var a=new x.ElementPath(v);if(!o.previousPath||!o.previousPath.compare(a)){o.previousPath=a;o.fire("selectionChange",{selection:o,
path:a,element:v})}}},200)},notifySelectionChange:function(){this.previousPath=null;this._monitor()},insertElement:function(o){var v=this;v.focus();var a=o._4e_name(),d=x.XHTML_DTD,g=x.RANGE,h=x.NODE,c=d.$block[a],k=v.getSelection(),b=k.getRanges(),e,n,z,s,D;v.fire("save");for(var H=b.length-1;H>=0;H--){e=b[H];e.deleteContents();n=!H&&o||o._4e_clone(true);if(c)for(;(s=e.getCommonAncestor(false,true))&&(D=d[s._4e_name()])&&!(D&&D[a]);)if(s._4e_name()in d.span)e.splitElement(s);else if(e.checkStartOfBlock()&&
e.checkEndOfBlock()){e.setStartBefore(s);e.collapse(true);s._4e_remove()}else e.splitBlock();e.insertNode(n);z||(z=n)}e.moveToPosition(z,g.POSITION_AFTER_END);(o=z._4e_nextSourceNode(true))&&o.type==h.NODE_ELEMENT&&e.moveToElementEditablePosition(o);k.selectRanges([e]);v.focus();n&&n._4e_scrollIntoView();setTimeout(function(){v.fire("save")},10)},insertHtml:function(o){var v=this;if(v.htmlDataProcessor)o=v.htmlDataProcessor.toDataFormat(o);if(p.webkit){o=u.create(o,null,this.document);o=o.nodeType==
11?B.makeArray(o.childNodes):[o];for(var a=0;a<o.length;a++)v.insertElement(new A(o[a]))}else{v.focus();v.fire("save");a=v.getSelection();if(p.ie){a=a.getNative();a.type=="Control"&&a.clear();a.createRange().pasteHTML(o)}else v.document.execCommand("inserthtml",false,o);v.focus();setTimeout(function(){v.fire("save")},10)}}});x._initIFrame=function(o){function v(s){j(function(){g.designMode="on";setTimeout(function(){g.designMode="off";c.focus();if(!arguments.callee.retry)arguments.callee.retry=true},
10)},function(){g.designMode="off";u.attr(c,"contentEditable",false);u.attr(c,"contentEditable",true);!s&&v(1)})}var a=w.getInstance(o);o=a.textarea[0];var d=a.iframe[0].contentWindow,g=a.document,h=g.getElementById("ke_actscrpt");h.parentNode.removeChild(h);var c=g.body;if(p.ie){c.hideFocus=true;c.disabled=true;c.contentEditable=true;c.removeAttribute("disabled")}else setTimeout(function(){if(p.gecko||p.opera)c.contentEditable=true;else if(p.webkit)c.parentNode.contentEditable=true;else g.designMode=
"on"},0);try{g.execCommand("enableObjectResizing",false,true)}catch(k){}try{g.execCommand("enableInlineTableEditing",false,true)}catch(b){}p.webkit&&m.on(g,"mousedown",function(s){s=new A(s.target);B.inArray(s._4e_name(),["img","hr","input","textarea","select"])&&a.getSelection().selectElement(s)});if(p.webkit){m.on(g,"click",function(s){var D=new A(s.target);B.inArray(D._4e_name(),["input","select"])&&s.preventDefault()});m.on(g,"mouseup",function(s){var D=new A(s.target);B.inArray(D._4e_name(),
["input","textarea"])&&s.preventDefault()})}if(p.gecko||p.ie||p.opera){var e;e=new A(u.insertAfter((new A('<span style="position:absolute; left:-10000"></span>'))[0],o));e.on("focus",function(){a.focus()});a.on("destroy",function(){})}if(p.ie&&g.compatMode=="CSS1Compat"||p.gecko||p.opera){var n=new A(g.documentElement);n.on("mousedown",function(s){if(s.target===n[0]){p.gecko&&v(false);e[0].focus()}})}m.on(d,"focus",function(){if(p.gecko)v(false);else p.opera&&c.focus();a.notifySelectionChange()});
p.gecko&&m.on(a.document,"mousedown",function(){a.iframeFocus||v(false)});if(p.ie){m.on(g,"keydown",function(s){if(s.keyCode in{8:1,46:1}){var D=a.getSelection(),H=D.getSelectedElement();if(H){a.fire("save");var y=D.getRanges()[0].createBookmark();H._4e_remove();D.selectBookmarks([y]);a.fire("save");s.preventDefault()}}});if(g.compatMode=="CSS1Compat"){var z={33:1,34:1};m.on(g,"keydown",function(s){s.keyCode in z&&setTimeout(function(){a.getSelection().scrollIntoView()},0)})}}setTimeout(function(){p.ie&&
setTimeout(function(){if(g){c.runtimeStyle.marginBottom="0px";c.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){a.fire("dataReady")},10);w.add(a)};p.gecko&&function(){var o=document.body;if(o){var v=o.getAttribute("onpageshow");o.setAttribute("onpageshow",(v?v+";":"")+"event.persisted && KISSY.Editor.focusManager.refreshAll();")}else window.addEventListener("load",arguments.callee,false)}()});
KISSY.Editor.add("dtd",function(x){x.XHTML_DTD=function(){var t=function(k){for(var b=arguments.length-1;b>0;)KISSY.mix(k,arguments[b--]);return k},B={isindex:1,fieldset:1},p={input:1,button:1,select:1,textarea:1,label:1},u=t({a:1},p),A=t({iframe:1},u),m={hr:1,ul:1,menu:1,div:1,blockquote:1,noscript:1,table:1,center:1,address:1,dir:1,pre:1,h5:1,dl:1,h4:1,noframes:1,h6:1,ol:1,h1:1,h3:1,h2:1},w={ins:1,del:1,script:1,style:1},j=t({b:1,acronym:1,bdo:1,"var":1,"#":1,abbr:1,code:1,br:1,i:1,cite:1,kbd:1,
u:1,strike:1,s:1,tt:1,strong:1,q:1,samp:1,em:1,dfn:1,span:1},w),f=t({sub:1,img:1,object:1,sup:1,basefont:1,map:1,applet:1,font:1,big:1,small:1},j),i=t({p:1},f);p=t({iframe:1},f,p);f={img:1,noscript:1,br:1,kbd:1,center:1,button:1,basefont:1,h5:1,h4:1,samp:1,h6:1,ol:1,h1:1,h3:1,h2:1,form:1,font:1,"#":1,select:1,menu:1,ins:1,abbr:1,label:1,code:1,table:1,script:1,cite:1,input:1,iframe:1,strong:1,textarea:1,noframes:1,big:1,small:1,span:1,hr:1,sub:1,bdo:1,"var":1,div:1,object:1,sup:1,strike:1,dir:1,map:1,
dl:1,applet:1,del:1,isindex:1,fieldset:1,ul:1,b:1,acronym:1,a:1,blockquote:1,i:1,u:1,s:1,tt:1,address:1,q:1,pre:1,p:1,em:1,dfn:1};var l=t({a:1},p),r={tr:1},q={"#":1},o=t({param:1},f),v=t({form:1},B,A,m,i),a={li:1},d={base:1,link:1,meta:1,title:1},g=t(d,{style:1,script:1}),h={head:1,body:1},c={address:1,blockquote:1,center:1,dir:1,div:1,dl:1,fieldset:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,isindex:1,menu:1,noframes:1,ol:1,p:1,pre:1,table:1,ul:1};return{$nonBodyContent:t({html:1},h,d),$block:c,
$blockLimit:{body:1,div:1,td:1,th:1,caption:1,form:1},$inline:l,$body:t({script:1,style:1},c),$cdata:{script:1,style:1},$empty:{area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},$listItem:{dd:1,dt:1,li:1},$list:{ul:1,ol:1,dl:1},$nonEditable:{applet:1,button:1,embed:1,iframe:1,map:1,object:1,option:1,script:1,textarea:1,param:1},$removeEmpty:{abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},$tabIndex:{a:1,area:1,button:1,input:1,object:1,select:1,textarea:1},$tableContent:{caption:1,col:1,colgroup:1,tbody:1,td:1,tfoot:1,th:1,thead:1,tr:1},html:h,head:g,style:q,body:v,base:{},link:{},meta:{},title:q,col:{},tr:{td:1,th:1},img:{},colgroup:{col:1},noscript:v,td:v,br:{},th:v,center:v,kbd:l,button:t(i,m),basefont:{},h5:l,h4:l,samp:l,h6:l,ol:a,h1:l,h3:l,option:q,h2:l,form:t(B,A,m,i),select:{optgroup:1,option:1},font:l,ins:l,menu:a,abbr:l,label:l,table:{thead:1,
col:1,tbody:1,tr:1,colgroup:1,caption:1,tfoot:1},code:l,script:q,tfoot:r,cite:l,li:v,input:{},iframe:v,strong:l,textarea:q,noframes:v,big:l,small:l,span:l,hr:{},dt:l,sub:l,optgroup:{option:1},param:{},bdo:l,"var":l,div:v,object:o,sup:l,dd:v,strike:l,area:{},dir:a,map:t({area:1,form:1,p:1},B,w,m),applet:o,dl:{dt:1,dd:1},del:l,isindex:{},fieldset:t({legend:1},f),thead:r,ul:a,acronym:l,b:l,a:p,blockquote:v,caption:l,i:l,u:l,tbody:r,s:l,address:t(A,i),tt:l,legend:l,q:l,pre:t(j,u),p:l,em:l,dfn:l}}()});
KISSY.Editor.add("dom",function(x){function t(a){return a.replace(/-(\w)/g,function(d,g){return g.toUpperCase()})}var B=KISSY,p=B.DOM,u=B.UA,A=B.Node,m=x.Utils,w={abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};x.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_COMMENT:8,NODE_DOCUMENT_FRAGMENT:11};x.POSITION={};var j=x.NODE,f=x.POSITION;f.POSITION_IDENTICAL=0;f.POSITION_DISCONNECTED=
1;f.POSITION_FOLLOWING=2;f.POSITION_PRECEDING=4;f.POSITION_IS_CONTAINED=8;f.POSITION_CONTAINS=16;var i={},l={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},r={hr:1},q=function(a){return a[0]||a},o=function(a){if(!a[0])return new A(a);return a},v={_4e_equals:function(a,d){if(!a&&!d)return true;if(!a||!d)return false;a=q(a);d=q(d);return a===d},_4e_isBlockBoundary:function(a,
d){a=o(a);d=B.mix(B.mix({},r),d||{});return l[a.css("display")]||d[a._4e_name()]},_4e_getWin:function(a){return a&&"scrollTo"in a&&a.document?a:a&&a.nodeType===9?a.defaultView||a.parentWindow:false},_4e_index:function(a){a=q(a);for(var d=a.parentNode.childNodes,g=0;g<d.length;g++)if(d[g]===a)return g;return-1},_4e_first:function(a,d){a=q(a);if((a=(a=a.firstChild)&&new A(a))&&d&&!d(a))a=a._4e_next(d);return a},_4e_move:function(a,d,g){a._4e_remove();a=q(a);d=q(d);g?d.insertBefore(a,d.firstChild):d.appendChild(a)},
_4e_name:function(a){a=q(a);var d=a.nodeName.toLowerCase();if(u.ie)if((a=a.scopeName)&&a!="HTML")d=a.toLowerCase()+":"+d;return d},_4e_isIdentical:function(a,d){if(a._4e_name()!=d._4e_name())return false;var g=a[0].attributes,h=d[0].attributes,c=g.length,k=h.length;if(!u.ie&&c!=k)return false;for(var b=0;b<c;b++){var e=g[b];if((!u.ie||e.specified&&e.nodeName!="_ke_expando")&&e.nodeValue!=d.attr(e.nodeName))return false}if(u.ie)for(b=0;b<k;b++){e=h[b];if(e.specified&&e.nodeName!="_ke_expando"&&e.nodeValue!=
a.attr(e.nodeName))return false}return true},_4e_isEmptyInlineRemoveable:function(a){a=q(a).childNodes;for(var d=0,g=a.length;d<g;d++){var h=a[d],c=h.nodeType;if(!(c==j.NODE_ELEMENT&&h.getAttribute("_ke_bookmark")))if(c==j.NODE_ELEMENT&&!v._4e_isEmptyInlineRemoveable(h)||c==j.NODE_TEXT&&B.trim(h.nodeValue))return false}return true},_4e_moveChildren:function(a,d,g){a=q(a);d=d[0]||d;if(a!=d)if(g)for(;g=a.lastChild;)d.insertBefore(a.removeChild(g),d.firstChild);else for(;g=a.firstChild;)d.appendChild(a.removeChild(g))},
_4e_mergeSiblings:function(){function a(d,g,h){if(g[0]&&g[0].nodeType==j.NODE_ELEMENT){for(var c=[];g.attr("_ke_bookmark")||g._4e_isEmptyInlineRemoveable();){c.push(g);g=h?new A(g[0].nextSibling):new A(g[0].previousSibling);if(!g[0]||g[0].nodeType!=j.NODE_ELEMENT)return}if(d._4e_isIdentical(g)){for(var k=h?d[0].lastChild:d[0].firstChild;c.length;)c.shift()._4e_move(d,!h);g._4e_moveChildren(d,!h);g._4e_remove();k[0]&&k[0].nodeType==j.NODE_ELEMENT&&k._4e_mergeSiblings()}}}return function(d){if(d[0])if(w[d._4e_name()]||
d._4e_name()=="a"){a(d,new A(d[0].nextSibling),true);a(d,new A(d[0].previousSibling))}}}(),_4e_unselectable:u.gecko?function(a){a=q(a);a.style.MozUserSelect="none"}:u.webkit?function(a){a=q(a);a.style.KhtmlUserSelect="none"}:function(a){a=q(a);if(u.ie||u.opera){var d,g=0;for(a.unselectable="on";d=a.all[g++];)switch(d.tagName.toLowerCase()){case "iframe":case "textarea":case "input":case "select":break;default:d.unselectable="on"}}},_4e_getOffset:function(a,d){a=q(a);var g,h=0;g=0;var c=a.ownerDocument.defaultView||
a.ownerDocument.parentWindow,k=a.ownerDocument,b=k.documentElement;d=d||k;if(a.getBoundingClientRect){if(a!==k.body&&b!==a){g=a.getBoundingClientRect();h=g.left+(d===k?p.scrollLeft(c):0);g=g.top+(d===k?p.scrollTop(c):0)}if(d)if(c!=(d.defaultView||d.parentWindow)&&c.frameElement){d=v._4e_getOffset(c.frameElement,d);h+=d.left;g+=d.top}}return{left:h,top:g}},_4e_getFrameDocument:function(a){return(a=q(a))&&a.contentWindow.document},_4e_splitText:function(a,d){a=q(a);var g=a.ownerDocument;if(!(!a||a.nodeType!=
j.NODE_TEXT)){if(u.ie&&d==a.nodeValue.length){g=g.createTextNode("");p.insertAfter(g,a);return g}a=new A(a.splitText(d));if(u.ie==8){g=g.createTextNode("");p.insertAfter(g,a[0]);g.parentNode.removeChild(g)}return a}},_4e_parents:function(a,d){a=o(a);var g=[];do g[d?"push":"unshift"](a);while(a=a.parent());return g},_4e_clone:function(a,d,g){a=q(a);a=a.cloneNode(d);if(!g){var h=function(c){if(c.nodeType==j.NODE_ELEMENT){c.removeAttribute("id",false);c.removeAttribute("_ke_expando",false);c=c.childNodes;
for(var k=0;k<c.length;k++)h(c[k])}};h(a)}return new A(a)},_4e_nextSourceNode:function(a,d,g,h){a=q(a);if(h&&!h.call){var c=h[0]||h;h=function(b){b=b[0]||b;return b!==c}}d=!d&&a.firstChild;var k=new A(a);if(!d){if(a.nodeType==j.NODE_ELEMENT&&h&&h(this,true)===false)return null;d=a.nextSibling}for(;!d&&(k=k.parent());){if(h&&h(k,true)===false)return null;d=k[0].nextSibling}if(!d)return null;d=new A(d);if(h&&h(d)===false)return null;if(g&&g!=d[0].nodeType)return d._4e_nextSourceNode(false,g,h);return d},
_4e_previousSourceNode:function(a,d,g,h){a=q(a);if(h&&!h.call){var c=h[0]||h;h=function(b){b=b[0]||b;return b!==c}}d=!d&&a.lastChild;var k=new A(a);if(!d){if(a.nodeType==j.NODE_ELEMENT&&h&&h(a,true)===false)return null;d=a.previousSibling}for(;!d&&(k=k.parent());){if(h&&h(k,true)===false)return null;d=k[0].previousSibling}if(!d)return null;d=new A(d);if(h&&h(d)===false)return null;if(g&&d[0].nodeType!=g)return d._4e_previousSourceNode(false,g,h);return d},_4e_contains:u.ie||u.webkit?function(a,d){a=
q(a);d=q(d);return d.nodeType!=j.NODE_ELEMENT?a.contains(d.parentNode):a!=d&&a.contains(d)}:function(a,d){a=q(a);d=q(d);return!!(a.compareDocumentPosition(d)&16)},_4e_commonAncestor:function(a,d){if(a._4e_equals(d))return a;if(d[0].nodeType!=j.NODE_TEXT&&d._4e_contains(a))return d;a=a[0].nodeType==j.NODE_TEXT?a.parent():a;do if(a[0].nodeType!=j.NODE_TEXT&&a._4e_contains(d))return a;while(a=a.parent());return null},_4e_ascendant:function(a,d,g){a=q(a);if(!g)a=a.parentNode;if(d&&!B.isFunction(d)){var h=
d;d=function(c){return c._4e_name()==h}}for(;a&&a.nodeType!=9;){if(!d||d(new A(a))===true)return new A(a);a=a.parentNode}return null},_4e_hasAttribute:function(a,d){a=q(a);a=a.attributes.getNamedItem(d);return!!(a&&a.specified)},_4e_hasAttributes:u.ie?function(a){a=q(a);for(var d=a.attributes,g=0;g<d.length;g++){var h=d[g];switch(h.nodeName){case "class":if(a.getAttribute("class"))return true;break;case "_ke_expando":continue;default:if(h.specified)return true}}return false}:function(a){a=q(a);u.gecko&&
a.removeAttribute("_moz_dirty");a=a.attributes;return a.length>1||a.length==1&&a[0].nodeName!="_ke_expando"},_4e_position:function(a,d){var g=q(a),h=q(d);if(g.compareDocumentPosition)return g.compareDocumentPosition(h);if(g==h)return f.POSITION_IDENTICAL;if(g.nodeType==j.NODE_ELEMENT&&h.nodeType==j.NODE_ELEMENT){if(g.contains){if(g.contains(h))return f.POSITION_CONTAINS+f.POSITION_PRECEDING;if(h.contains(g))return f.POSITION_IS_CONTAINED+f.POSITION_FOLLOWING}if("sourceIndex"in g)return g.sourceIndex<
0||h.sourceIndex<0?f.POSITION_DISCONNECTED:g.sourceIndex<h.sourceIndex?f.POSITION_PRECEDING:f.POSITION_FOLLOWING}a=a._4e_address();d=d._4e_address();g=Math.min(a.length,d.length);for(h=0;h<=g-1;h++)if(a[h]!=d[h]){if(h<g)return a[h]<d[h]?f.POSITION_PRECEDING:f.POSITION_FOLLOWING;break}return a.length<d.length?f.POSITION_CONTAINS+f.POSITION_PRECEDING:f.POSITION_IS_CONTAINED+f.POSITION_FOLLOWING},_4e_address:function(a,d){a=q(a);var g=[],h=a.ownerDocument.documentElement;for(a=a;a&&a!=h;){var c=a.parentNode,
k=-1;if(c){for(var b=0;b<c.childNodes.length;b++){var e=c.childNodes[b];if(!(d&&e.nodeType==3&&e.previousSibling&&e.previousSibling.nodeType==3)){k++;if(e==a)break}}g.unshift(k)}a=c}return g},_4e_breakParent:function(a,d){var g=new x.Range(a[0].ownerDocument);g.setStartAfter(a);g.setEndAfter(d);d=g.extractContents();g.insertNode(a._4e_remove());a[0].parentNode.insertBefore(d,a[0].nextSibling)},_4e_style:function(a,d,g){if(g!==undefined)return a.css(d,g);a=a[0]||a;return a.style[t(d)]},_4e_remove:function(a,
d){var g=q(a),h=g.parentNode;if(h){if(d)for(;d=g.firstChild;)h.insertBefore(g.removeChild(d),g);h.removeChild(g)}return a},_4e_trim:function(a){p._4e_ltrim(a);p._4e_rtrim(a)},_4e_ltrim:function(a){a=q(a);for(var d;d=a.firstChild;){if(d.nodeType==j.NODE_TEXT){var g=m.ltrim(d.nodeValue),h=d.nodeValue.length;if(g){if(g.length<h){(new A(d))._4e_splitText(h-g.length);a.removeChild(a.firstChild)}}else{a.removeChild(d);continue}}break}},_4e_rtrim:function(a){a=q(a);for(var d;d=a.lastChild;){if(d.type==j.NODE_TEXT){var g=
m.rtrim(d.nodeValue),h=d.nodeValue.length;if(g){if(g.length<h){(new A(d))._4e_splitText(g.length);a.removeChild(a.lastChild)}}else{a.removeChild(d);continue}}break}if(!u.ie&&!u.opera)(d=a.lastChild)&&d.nodeType==1&&d.nodeName.toLowerCase()=="br"&&d.parentNode.removeChild(d)},_4e_appendBogus:function(a){a=q(a);for(var d=a.lastChild;d&&d.nodeType==j.NODE_TEXT&&!B.trim(d.nodeValue);)d=d.previousSibling;if(!d||d.nodeType==j.NODE_TEXT||p._4e_name(d)!=="br"){d=u.opera?a.ownerDocument.createTextNode(""):
a.ownerDocument.createElement("br");u.gecko&&d.setAttribute("type","_moz");a.appendChild(d)}},_4e_previous:function(a,d){a=q(a);var g;do g=(a=a.previousSibling)&&new A(a);while(g&&d&&!d(g));return g},_4e_last:function(a,d){if((a=(a=a[0].lastChild)&&new A(a))&&d&&!d(a))a=a._4e_previous(d);return a},_4e_next:function(a,d){a=q(a);var g;do g=(a=a.nextSibling)&&new A(a);while(g&&d&&!d(g));return g},_4e_outerHtml:function(a){a=q(a);if(a.outerHTML)return a.outerHTML.replace(/<\?[^>]*>/,"");var d=a.ownerDocument.createElement("div");
d.appendChild(a.cloneNode(true));return d.innerHTML},_4e_setMarker:function(a,d,g,h){a[0]||(a=new A(a));var c=a._4e_getData("list_marker_id")||a._4e_setData("list_marker_id",B.guid())._4e_getData("list_marker_id"),k=a._4e_getData("list_marker_names")||a._4e_setData("list_marker_names",{})._4e_getData("list_marker_names");d[c]=a;k[g]=1;return a._4e_setData(g,h)},_4e_clearMarkers:function(a,d,g){a=o(a);var h=a._4e_getData("list_marker_names"),c=a._4e_getData("list_marker_id");for(var k in h)a._4e_removeData(k);
a._4e_removeData("list_marker_names");if(g){a._4e_removeData("list_marker_id");delete d[c]}},_4e_setData:function(a,d,g){var h=p._4e_getUniqueId(a);(i[h]||(i[h]={}))[d]=g;return a},_4e_getData:function(a,d){a=q(a);return(a=(a=a.getAttribute("_ke_expando"))&&i[a])&&a[d]},_4e_removeData:function(a,d){a=q(a);var g=a.getAttribute("_ke_expando");var h=(g=g&&i[g])&&g[d];typeof h!="undefined"&&g&&delete g[d];B.isEmptyObject(g)&&p._4e_clearData(a);return h||null},_4e_clearData:function(a){a=q(a);var d=a.getAttribute("_ke_expando");
d&&delete i[d];d&&a.removeAttribute("_ke_expando")},_4e_getUniqueId:function(a){a=q(a);var d=a.getAttribute("_ke_expando");if(d)return d;d=B.guid();a.setAttribute("_ke_expando",d);return d},_4e_copyAttributes:function(a,d,g){a=q(a);var h=a.attributes;g=g||{};for(var c=0;c<h.length;c++){var k=h[c],b=k.nodeName.toLowerCase(),e;if(!(b in g))if(b=="checked"&&(e=p.attr(a,b)))d.attr(b,e);else if(k.specified||u.ie&&k.nodeValue&&b=="value"){e=p.attr(a,b);if(e===null)e=k.nodeValue;d.attr(b,e)}}if(a.style.cssText!==
"")d[0].style.cssText=a.style.cssText},_4e_isEditable:function(a){a=p._4e_name(a);var d=x.XHTML_DTD;return(a=!d.$nonEditable[a]&&(d[a]||d.span))&&a["#"]},_4e_scrollIntoView:function(a){a=o(a);var d=a[0].ownerDocument,g=p.scrollLeft(d),h=p.scrollTop(d),c=a.offset(),k=c.left;c=c.top;if(p.viewportHeight(d)+h<c||c<h||p.viewportWidth(d)+g<k||k<g)a.scrollIntoView(d)},_4e_getElementsByTagName:function(a,d,g){a=q(a);if(!u.ie&&g)d=g+":"+d;g=[];a=a.getElementsByTagName(d);for(d=0;d<a.length;d++)g.push(new A(a[d]));
return g}};B.DOM._4e_inject=function(a){B.mix(p,a);for(var d in a)a.hasOwnProperty(d)&&function(g){A.prototype[g]=function(){var h=[].slice.call(arguments,0);h.unshift(this);return a[g].apply(null,h)}}(d)};B.DOM._4e_inject(v)});
KISSY.Editor.add("elementpath",function(x){function t(i){var l=null,r=null,q=[];for(i=i;i&&i[0];){if(i[0].nodeType==A.NODE_ELEMENT){if(!this.lastElement)this.lastElement=i;var o=i._4e_name();if(m.ie&&i[0].scopeName!="HTML")o=i[0].scopeName.toLowerCase()+":"+o;if(!r){if(!l&&w[o])l=i;if(j[o])if(!l&&o=="div"&&!f(i))l=i;else r=i}q.push(i);if(o=="body")break}i=i.parent()}this.block=l;this.blockLimit=r;this.elements=q}var B=KISSY,p=B.DOM,u=x.XHTML_DTD,A=x.NODE,m=B.UA,w={address:1,blockquote:1,dl:1,h1:1,
h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},j={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1},f=function(i){i=i[0]||i;i=i.childNodes;for(var l=0,r=i.length;l<r;l++){var q=i[l];if(q.nodeType==A.NODE_ELEMENT&&u.$block[q.nodeName.toLowerCase()])return true}return false};t.prototype={compare:function(i){var l=this.elements;i=i&&i.elements;if(!i||l.length!=i.length)return false;for(var r=0;r<l.length;r++)if(!p._4e_equals(l[r],i[r]))return false;return true},contains:function(i){for(var l=
this.elements,r=0;r<l.length;r++)if(l[r]._4e_name()in i)return l[r];return null}};x.ElementPath=t});
KISSY.Editor.add("walker",function(x){function t(j,f){if(this._.end)return null;var i=this.range,l,r=this.guard,q=this.type,o=j?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start){this._.start=1;i.trim();if(i.collapsed){this.end();return null}}if(!j&&!this._.guardLTR){var v=i.endContainer,a=new w(v[0].childNodes[i.endOffset]);this._.guardLTR=function(c,k){return(!k||!m._4e_equals(v,c))&&(!a[0]||c[0]!==a[0])&&(c[0].nodeType!=A.NODE_ELEMENT||!k||c._4e_name()!="body")}}if(j&&!this._.guardRTL){var d=
i.startContainer,g=i.startOffset>0&&new w(d[0].childNodes[i.startOffset-1]);this._.guardRTL=function(c,k){return c&&c[0]&&(!k||d[0]!==c[0])&&(!g[0]||c[0]!==g[0])&&(c[0].nodeType!=A.NODE_ELEMENT||!k||c._4e_name()!="body")}}var h=j?this._.guardRTL:this._.guardLTR;l=r?function(c,k){if(h(c,k)===false)return false;return r(c,k)}:h;if(this.current)j=this.current[o](false,q,l);else if(j){j=i.endContainer;if(i.endOffset>0){j=new w(j[0].childNodes[i.endOffset-1]);if(l(j)===false)j=null}else j=l(j,true)===
false?null:j._4e_previousSourceNode(true,q,l)}else{j=i.startContainer;if((j=new w(j[0].childNodes[i.startOffset]))&&j[0]){if(l(j)===false)j=null}else j=l(i.startContainer,true)===false?null:i.startContainer._4e_nextSourceNode(true,q,l)}for(;j&&j[0]&&!this._.end;){this.current=j;if(!this.evaluator||this.evaluator(j)!==false){if(!f)return j}else if(f&&this.evaluator)return false;j=j[o](false,q,l)}this.end();return this.current=null}function B(j){for(var f,i=null;f=t.call(this,j);)i=f;return i}function p(j){this.range=
j;this._={}}var u=KISSY,A=x.NODE,m=u.DOM,w=u.Node;u.augment(p,{end:function(){this._.end=1},next:function(){return t.call(this)},previous:function(){return t.call(this,true)},checkForward:function(){return t.call(this,false,true)!==false},checkBackward:function(){return t.call(this,true,true)!==false},lastForward:function(){return B.call(this)},lastBackward:function(){return B.call(this,true)},reset:function(){delete this.current;this._={}}});p.blockBoundary=function(j){return function(f){f[0]||(f=
new w(f));return!(f[0].nodeType==A.NODE_ELEMENT&&f._4e_isBlockBoundary(j))}};p.listItemBoundary=function(){return this.blockBoundary({br:1})};p.bookmark=function(j,f){function i(l){return l&&l[0]&&l._4e_name()=="span"&&l.attr("_ke_bookmark")}return function(l){var r,q;r=l&&l[0]&&l[0].nodeType==A.NODE_TEXT&&(q=l.parent())&&i(q);r=j?r:r||i(l);return f^r}};p.whitespaces=function(j){return function(f){f=(f=f[0]||f)&&f.nodeType==A.NODE_TEXT&&!u.trim(f.nodeValue);return j^f}};p.invisible=function(j){var f=
p.whitespaces();return function(i){i=f(i)||i[0].nodeType==A.NODE_ELEMENT&&!i[0].offsetHeight;return j^i}};x.Walker=p});
KISSY.Editor.add("range",function(x){function t(b){this.endOffset=this.endContainer=this.startOffset=this.startContainer=null;this.collapsed=true;this.document=b}function B(b){var e=b[0].nodeType!=j.NODE_TEXT&&b._4e_name()in v.$removeEmpty,n=!w.trim(b[0].nodeValue);b=!!b.parent().attr("_ke_bookmark");return e||n||b}function p(b){return!c(b)&&!k(b)}function u(b){var e=false,n=l.bookmark(true);return function(z){if(n(z))return true;if(z[0].nodeType==j.NODE_TEXT){if(w.trim(z[0].nodeValue).length)return false}else if(z[0].nodeType==
j.NODE_ELEMENT)if(!h[z._4e_name()])if(!b&&!o.ie&&z._4e_name()=="br"&&!e)e=true;else return false;return true}}function A(b,e){function n(z){return z&&z.nodeName=="span"&&z.getAttribute("_ke_bookmark")}return function(z){var s,D;s=z&&!z.nodeName&&(D=z.parentNode)&&n(D);s=b?s:s||n(z);return e^s}}function m(b){return function(e){e=(e=e[0]||e)&&e.nodeType==j.NODE_TEXT&&!w.trim(e.nodeValue);return b^e}}x.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,
ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,STARTEND:3,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var w=KISSY,j=x.NODE,f=x.RANGE,i=x.POSITION,l=x.Walker,r=w.DOM,q=x.Utils.getByAddress,o=w.UA,v=x.XHTML_DTD,a=x.ElementPath,d=w.Node,g={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1};t.prototype.toString=function(){var b=[];b.push((this.startContainer[0].id||this.startContainer[0].nodeName)+":"+this.startOffset);b.push((this.endContainer[0].id||this.endContainer[0].nodeName)+
":"+this.endOffset);return b.join("<br/>")};w.augment(t,{updateCollapsed:function(){this.collapsed=this.startContainer&&this.endContainer&&r._4e_equals(this.startContainer,this.endContainer)&&this.startOffset==this.endOffset},optimize:function(){var b=this.startContainer,e=this.startOffset;if(b[0].nodeType!=j.NODE_ELEMENT)if(e)e>=b[0].nodeValue.length&&this.setStartAfter(b);else this.setStartBefore(b);b=this.endContainer;e=this.endOffset;if(b[0].nodeType!=j.NODE_ELEMENT)if(e)e>=b[0].nodeValue.length&&
this.setEndAfter(b);else this.setEndBefore(b)},setStartAfter:function(b){this.setStart(b.parent(),b._4e_index()+1)},setStartBefore:function(b){this.setStart(b.parent(),b._4e_index())},setEndAfter:function(b){this.setEnd(b.parent(),b._4e_index()+1)},setEndBefore:function(b){this.setEnd(b.parent(),b._4e_index())},optimizeBookmark:function(){var b=this.startContainer,e=this.endContainer;b&&b._4e_name()=="span"&&b.attr("_ke_bookmark")&&this.setStartAt(b,f.POSITION_BEFORE_START);e&&e._4e_name()=="span"&&
e.attr("_ke_bookmark")&&this.setEndAt(e,f.POSITION_AFTER_END)},setStart:function(b,e){if(b[0].nodeType==j.NODE_ELEMENT&&g[b._4e_name()]){b=b.parent();e=b._4e_index()}this.startContainer=b;this.startOffset=e;if(!this.endContainer){this.endContainer=b;this.endOffset=e}this.updateCollapsed()},setEnd:function(b,e){if(b[0].nodeType==j.NODE_ELEMENT&&g[b._4e_name()]){b=b.parent();e=b._4e_index()+1}this.endContainer=b;this.endOffset=e;if(!this.startContainer){this.startContainer=b;this.startOffset=e}this.updateCollapsed()},
setStartAt:function(b,e){switch(e){case f.POSITION_AFTER_START:this.setStart(b,0);break;case f.POSITION_BEFORE_END:b[0].nodeType==j.NODE_TEXT?this.setStart(b,b[0].nodeValue.length):this.setStart(b,b[0].childNodes.length);break;case f.POSITION_BEFORE_START:this.setStartBefore(b);break;case f.POSITION_AFTER_END:this.setStartAfter(b)}this.updateCollapsed()},setEndAt:function(b,e){switch(e){case f.POSITION_AFTER_START:this.setEnd(b,0);break;case f.POSITION_BEFORE_END:b[0].nodeType==j.NODE_TEXT?this.setEnd(b,
b[0].nodeValue.length):this.setEnd(b,b[0].childNodes.length);break;case f.POSITION_BEFORE_START:this.setEndBefore(b);break;case f.POSITION_AFTER_END:this.setEndAfter(b)}this.updateCollapsed()},execContentsAction:function(b,e){var n=this.startContainer,z=this.endContainer,s=this.startOffset,D=this.endOffset,H,y;this.optimizeBookmark();if(z[0].nodeType==j.NODE_TEXT)z=z._4e_splitText(D);else if(z[0].childNodes.length>0)if(D>=z[0].childNodes.length){z=new d(z[0].appendChild(this.document.createTextNode("")));
y=true}else z=new d(z[0].childNodes[D]);if(n[0].nodeType==j.NODE_TEXT){n._4e_splitText(s);if(r._4e_equals(n,z))z=new d(n[0].nextSibling)}else if(s)if(s>=n[0].childNodes.length){H=new d(this.document.createTextNode(""));n[0].appendChild(H[0]);n=H;H=true}else n=new d(n[0].childNodes[s].previousSibling);else{H=new d(this.document.createTextNode(""));r.insertBefore(H[0],n[0].firstChild);n=H;H=true}s=n._4e_parents();D=z._4e_parents();var C,I,J;for(C=0;C<s.length;C++){I=s[C];J=D[C];if(I[0]!==J[0])break}for(var N=
e,M,Q,R,W=C;W<s.length;W++){M=s[W];if(N&&M[0]!==n[0])Q=N.appendChild(M._4e_clone()[0]);for(M=M[0].nextSibling;M;){if(D[W]&&M==D[W][0]||M==z[0])break;R=M.nextSibling;if(b==2)N.appendChild(M.cloneNode(true));else{M.parentNode.removeChild(M);b==1&&N.appendChild(M)}M=R}if(Q)N=Q}N=e;for(e=C;e<D.length;e++){M=D[e];if(b>0&&M[0]!==z[0])Q=N.appendChild(M._4e_clone()[0]);if(!s[e]||M[0].parentNode!==s[e][0].parentNode)for(M=M[0].previousSibling;M;){if(s[e]&&M==s[e][0]||M===n[0])break;R=M.previousSibling;if(b==
2)N.insertBefore(M.cloneNode(true),N.firstChild);else{M.parentNode.removeChild(M);b==1&&N.insertBefore(M,N.firstChild)}M=R}if(Q)N=Q}if(b==2){J=this.startContainer[0];if(J.nodeType==j.NODE_TEXT&&J.nextSibling&&J.nextSibling.nodeType==j.NODE_TEXT){J.data+=J.nextSibling.data;J.parentNode.removeChild(J.nextSibling)}J=this.endContainer[0];if(J.nodeType==j.NODE_TEXT&&J.nextSibling&&J.nextSibling.nodeType==j.NODE_TEXT){J.data+=J.nextSibling.data;J.parentNode.removeChild(J.nextSibling)}}else{if(I&&J&&(n[0].parentNode!=
I[0].parentNode||z[0].parentNode!=J[0].parentNode)){b=J._4e_index();H&&J[0].parentNode==n[0].parentNode&&b--;this.setStart(J.parent(),b)}this.collapse(true)}H&&n._4e_remove();y&&z[0].parentNode&&z._4e_remove()},collapse:function(b){if(b){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=this.endOffset}this.collapsed=true},clone:function(){var b=new t(this.document);b.startContainer=this.startContainer;b.startOffset=this.startOffset;
b.endContainer=this.endContainer;b.endOffset=this.endOffset;b.collapsed=this.collapsed;return b},getEnclosedNode:function(){var b=this.clone();b.optimize();if(b.startContainer[0].nodeType!=j.NODE_ELEMENT||b.endContainer[0].nodeType!=j.NODE_ELEMENT)return null;b=b.startContainer[0].childNodes[b.startOffset];for(var e=A(true,undefined),n=m(true),z=function(s){return n(s)&&e(s)};b&&z(b);)b=(new d(b))._4e_nextSourceNode()[0];return new d(b)},shrink:function(b,e){if(!this.collapsed){b=b||f.SHRINK_TEXT;
var n=this.clone(),z=this.startContainer,s=this.endContainer,D=this.startOffset,H=this.endOffset,y=1,C=1;if(z&&z[0].nodeType==j.NODE_TEXT)if(D)if(D>=z[0].nodeValue.length)n.setStartAfter(z);else{n.setStartBefore(z);y=0}else n.setStartBefore(z);if(s&&s[0].nodeType==j.NODE_TEXT)if(H)if(H>=s[0].nodeValue.length)n.setEndAfter(s);else{n.setEndAfter(s);C=0}else n.setEndBefore(s);n=new l(n);n.evaluator=function(J){J=J[0]||J;return J.nodeType==(b==f.SHRINK_ELEMENT?j.NODE_ELEMENT:j.NODE_TEXT)};var I;n.guard=
function(J,N){J=J[0]||J;if(b==f.SHRINK_ELEMENT&&J.nodeType==j.NODE_TEXT)return false;if(N&&J==I)return false;if(!N&&J.nodeType==j.NODE_ELEMENT)I=J;return true};if(y)(z=n[b==f.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(z,e?f.POSITION_AFTER_START:f.POSITION_BEFORE_START);if(C){n.reset();(n=n[b==f.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(n,e?f.POSITION_BEFORE_END:f.POSITION_AFTER_END)}return!!(y||C)}},getTouchedStartNode:function(){var b=this.startContainer;if(this.collapsed||
b[0].nodeType!=j.NODE_ELEMENT)return b;return b.childNodes[this.startOffset]||b},createBookmark2:function(b){var e=this.startContainer,n=this.endContainer,z=this.startOffset,s=this.endOffset,D,H;if(!e||!n)return{start:0,end:0};if(b){if(e[0].nodeType==j.NODE_ELEMENT)if((D=new d(e[0].childNodes[z]))&&D[0]&&D[0].nodeType==j.NODE_TEXT&&z>0&&D[0].previousSibling.nodeType==j.NODE_TEXT){e=D;z=0}for(;e[0].nodeType==j.NODE_TEXT&&(H=e._4e_previous())&&H[0].nodeType==j.NODE_TEXT;){e=H;z+=H[0].nodeValue.length}if(!this.collapsed){if(n[0].nodeType==
j.NODE_ELEMENT)if((D=new d(n[0].childNodes[s]))&&D[0]&&D[0].nodeType==j.NODE_TEXT&&s>0&&D[0].previousSibling.nodeType==j.NODE_TEXT){n=D;s=0}for(;n[0].nodeType==j.NODE_TEXT&&(H=n._4e_previous())&&H[0].nodeType==j.NODE_TEXT;){n=H;s+=H[0].nodeValue.length}}}return{start:e._4e_address(b),end:this.collapsed?null:n._4e_address(b),startOffset:z,endOffset:s,normalized:b,is2:true}},createBookmark:function(b){var e,n,z,s;e=new d("<span></span>",null,this.document);e.attr("_ke_bookmark",1);e.css("display","none");
e.html("&nbsp;");if(b){z=w.guid("ke_bm_");e.attr("id",z+"S")}if(!this.collapsed){n=e._4e_clone();n.html("&nbsp;");b&&n.attr("id",z+"E");s=this.clone();s.collapse();s.insertNode(n)}s=this.clone();s.collapse(true);s.insertNode(e);if(n){this.setStartAfter(e);this.setEndBefore(n)}else this.moveToPosition(e,f.POSITION_AFTER_END);return{startNode:b?z+"S":e,endNode:b?z+"E":n,serializable:b}},moveToPosition:function(b,e){this.setStartAt(b,e);this.collapse(true)},trim:function(b,e){var n=this.startContainer,
z=this.startOffset,s=this.collapsed;if((!b||s)&&n[0]&&n[0].nodeType==j.NODE_TEXT){if(z)if(z>=n[0].nodeValue.length){z=n._4e_index()+1;n=n.parent()}else{b=n._4e_splitText(z);z=n._4e_index()+1;n=n.parent();if(r._4e_equals(this.startContainer,this.endContainer))this.setEnd(b,this.endOffset-this.startOffset);else if(r._4e_equals(n,this.endContainer))this.endOffset+=1}else{z=n._4e_index();n=n.parent()}this.setStart(n,z);if(s){this.collapse(true);return}}n=this.endContainer;z=this.endOffset;if(!(e||s)&&
n[0]&&n[0].nodeType==j.NODE_TEXT){if(z){z>=n.nodeValue.length||n._4e_splitText(z);z=n._4e_index()+1}else z=n._4e_index();n=n.parent();this.setEnd(n,z)}},insertNode:function(b){this.optimizeBookmark();this.trim(false,true);var e=this.startContainer,n=e[0].childNodes[this.startOffset];this.optimizeBookmark();this.trim(false,true);n?r.insertBefore(b[0]||b,n):e[0].appendChild(b[0]||b);r._4e_equals(b.parent(),this.endContainer)&&this.endOffset++;this.setStartBefore(b)},moveToBookmark:function(b){if(b.is2){var e=
q(this.document,b.start,b.normalized),n=b.startOffset,z=b.end&&q(this.document,b.end,b.normalized);b=b.endOffset;this.setStart(e,n);z?this.setEnd(z,b):this.collapse(true)}else{e=(n=b.serializable)?w.one("#"+b.startNode,this.document):b.startNode;b=n?w.one("#"+b.endNode,this.document):b.endNode;this.setStartBefore(e);e._4e_remove();if(b&&b[0]){this.setEndBefore(b);b._4e_remove()}else this.collapse(true)}},getCommonAncestor:function(b,e){var n=this.startContainer,z=this.endContainer;b=r._4e_equals(n,
z)?b&&n[0].nodeType==j.NODE_ELEMENT&&this.startOffset==this.endOffset-1?new d(n[0].childNodes[this.startOffset]):n:n._4e_commonAncestor(z);return e&&b[0].nodeType==j.NODE_TEXT?b.parent():b},enlarge:function(b){switch(b){case f.ENLARGE_ELEMENT:if(this.collapsed)return;b=this.getCommonAncestor();var e=new d(this.document.body),n,z,s,D,H,y=false,C,I;C=this.startContainer;I=this.startOffset;if(C[0].nodeType==j.NODE_TEXT){if(I){C=!w.trim(C[0].nodeValue.substring(0,I)).length&&C;y=!!C}if(C)if(!(D=C[0].previousSibling))s=
C.parent()}else{if(I)D=C[0].childNodes[I-1]||C[0].lastChild;D||(s=C)}for(;s||D;){if(s&&!D){if(!H&&r._4e_equals(s,b))H=true;if(!e._4e_contains(s))break;if(!y||s.css("display")!="inline"){y=false;if(H)n=s;else this.setStartBefore(s)}D=s[0].previousSibling}for(;D;){C=false;if(D.nodeType==j.NODE_TEXT){I=D.nodeValue;if(/[^\s\ufeff]/.test(I))D=null;C=/[\s\ufeff]$/.test(I)}else if(D.offsetWidth>0&&!D.getAttribute("_ke_bookmark"))if(y&&v.$removeEmpty[D.nodeName.toLowerCase()]){I=r.text(D);if(/[^\s\ufeff]/.test(I))D=
null;else for(var J=D.all||D.getElementsByTagName("*"),N=0,M;M=J[N++];)if(!v.$removeEmpty[M.nodeName.toLowerCase()]){D=null;break}if(D)C=!!I.length}else D=null;if(C)if(y)if(H)n=s;else s&&this.setStartBefore(s);else y=true;if(D){C=D.previousSibling;if(!s&&!C){s=new d(D);D=null;break}D=C}else s=null}if(s)s=s.parent()}C=this.endContainer;I=this.endOffset;s=D=null;H=y=false;if(C[0].nodeType==j.NODE_TEXT){C=!w.trim(C[0].nodeValue.substring(I)).length&&C;y=!(C&&C[0].nodeValue.length);if(C)if(!(D=C[0].nextSibling))s=
C.parent()}else(D=C[0].childNodes[I])||(s=C);for(;s||D;){if(s&&!D){if(!H&&r._4e_equals(s,b))H=true;if(!e._4e_contains(s))break;if(!y||s.css("display")!="inline"){y=false;if(H)z=s;else s&&this.setEndAfter(s)}D=s[0].nextSibling}for(;D;){C=false;if(D.nodeType==j.NODE_TEXT){I=D.nodeValue;if(/[^\s\ufeff]/.test(I))D=null;C=/^[\s\ufeff]/.test(I)}else if(D.offsetWidth>0&&!D.getAttribute("_ke_bookmark"))if(y&&v.$removeEmpty[D.nodeName.toLowerCase()]){I=r.text(D);if(/[^\s\ufeff]/.test(I))D=null;else{J=D.all||
D.getElementsByTagName("*");for(N=0;M=J[N++];)if(!v.$removeEmpty[M.nodeName.toLowerCase()]){D=null;break}}if(D)C=!!I.length}else D=null;if(C)if(y)if(H)z=s;else this.setEndAfter(s);if(D){C=D.nextSibling;if(!s&&!C){s=new d(D);D=null;break}D=C}else s=null}if(s)s=s.parent()}if(n&&z){b=n._4e_contains(z)?z:n;this.setStartBefore(b);this.setEndAfter(b)}break;case f.ENLARGE_BLOCK_CONTENTS:case f.ENLARGE_LIST_ITEM_CONTENTS:s=new t(this.document);e=new d(this.document.body);s.setStartAt(e,f.POSITION_AFTER_START);
s.setEnd(this.startContainer,this.startOffset);s=new l(s);var Q,R,W=l.blockBoundary(b==f.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:null),$=function(aa){var E=W(aa);E||(Q=aa);return E};n=function(aa){var E=$(aa);if(!E&&aa[0]&&aa._4e_name()=="br")R=aa;return E};s.guard=$;s=s.lastBackward();Q=Q||e;this.setStartAt(Q,Q._4e_name()!="br"&&(!s&&this.checkStartOfBlock()||s&&Q._4e_contains(s))?f.POSITION_AFTER_START:f.POSITION_AFTER_END);s=this.clone();s.collapse();s.setEndAt(e,f.POSITION_BEFORE_END);s=new l(s);s.guard=
b==f.ENLARGE_LIST_ITEM_CONTENTS?n:$;Q=null;s=s.lastForward();Q=Q||e;this.setEndAt(Q,!s&&this.checkEndOfBlock()||s&&Q._4e_contains(s)?f.POSITION_BEFORE_END:f.POSITION_BEFORE_START);R&&this.setEndAfter(R)}},checkStartOfBlock:function(){var b=this.startContainer,e=this.startOffset;if(e&&b[0].nodeType==j.NODE_TEXT)if(w.trim(b[0].nodeValue.substring(0,e)).length)return false;this.trim();b=new a(this.startContainer);e=this.clone();e.collapse(true);e.setStartAt(b.block||b.blockLimit,f.POSITION_AFTER_START);
b=new l(e);b.evaluator=u(true);return b.checkBackward()},checkEndOfBlock:function(){var b=this.endContainer,e=this.endOffset;if(b[0].nodeType==j.NODE_TEXT)if(w.trim(b[0].nodeValue.substring(e)).length)return false;this.trim();b=new a(this.endContainer);e=this.clone();e.collapse(false);e.setEndAt(b.block||b.blockLimit,f.POSITION_BEFORE_END);b=new l(e);b.evaluator=u(false);return b.checkForward()},deleteContents:function(){this.collapsed||this.execContentsAction(0)},extractContents:function(){var b=
this.document.createDocumentFragment();this.collapsed||this.execContentsAction(1,b);return b},checkBoundaryOfElement:function(b,e){var n=this.clone();n[e==f.START?"setStartAt":"setEndAt"](b,e==f.START?f.POSITION_AFTER_START:f.POSITION_BEFORE_END);b=new l(n);b.evaluator=B;return b[e==f.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var b=this.startContainer,e=this.endContainer,n=this.startOffset,z=this.endOffset,s;if(b[0].nodeType==j.NODE_ELEMENT){s=b[0].childNodes.length;if(s>
n)b=new d(b[0].childNodes[n]);else if(s<1)b=b._4e_previousSourceNode();else{for(b=b[0];b.lastChild;)b=b.lastChild;b=new d(b);b=b._4e_nextSourceNode()||b}}if(e[0].nodeType==j.NODE_ELEMENT){s=e[0].childNodes.length;if(s>z)e=(new d(e[0].childNodes[z]))._4e_previousSourceNode(true);else if(s<1)e=e._4e_previousSourceNode();else{for(e=e[0];e.lastChild;)e=e.lastChild;e=new d(e)}}if(b._4e_position(e)&i.POSITION_FOLLOWING)b=e;return{startNode:b,endNode:e}},fixBlock:function(b,e){var n=this.createBookmark();
e=new d(this.document.createElement(e));this.collapse(b);this.enlarge(f.ENLARGE_BLOCK_CONTENTS);e[0].appendChild(this.extractContents());e._4e_trim();o.ie||e._4e_appendBogus();this.insertNode(e);this.moveToBookmark(n);return e},splitBlock:function(b){var e=new a(this.startContainer),n=new a(this.endContainer),z=e.block,s=n.block,D=null;if(e.blockLimit[0]!==n.blockLimit[0])return null;if(b!="br"){if(!z){z=this.fixBlock(true,b);s=(new a(this.endContainer)).block}s||(s=this.fixBlock(false,b))}b=z&&this.checkStartOfBlock();
e=s&&this.checkEndOfBlock();this.deleteContents();if(z&&r._4e_equals(z,s))if(e){D=new a(this.startContainer);this.moveToPosition(s,f.POSITION_AFTER_END);s=null}else if(b){D=new a(this.startContainer);this.moveToPosition(z,f.POSITION_BEFORE_START);z=null}else{s=this.splitElement(z);!o.ie&&!w.inArray(z._4e_name(),["ul","ol"])&&z._4e_appendBogus()}return{previousBlock:z,nextBlock:s,wasStartOfBlock:b,wasEndOfBlock:e,elementPath:D}},splitElement:function(b){if(!this.collapsed)return null;this.setEndAt(b,
f.POSITION_BEFORE_END);var e=this.extractContents(),n=b._4e_clone(false);n[0].appendChild(e);n.insertAfter(b);this.moveToPosition(b,f.POSITION_AFTER_END);return n},moveToElementEditablePosition:function(b,e){var n,z=x.XHTML_DTD;if(z.$empty[b._4e_name()])return false;for(;b&&b[0].nodeType==j.NODE_ELEMENT;){if(n=b._4e_isEditable())this.moveToPosition(b,e?f.POSITION_BEFORE_END:f.POSITION_AFTER_START);else if(z.$inline[b._4e_name()]){this.moveToPosition(b,e?f.POSITION_AFTER_END:f.POSITION_BEFORE_START);
return true}if((b=z.$empty[b._4e_name()]?b[e?"_4e_previous":"_4e_next"](p):b[e?"_4e_last":"_4e_first"](p))&&b[0].nodeType==j.NODE_TEXT){this.moveToPosition(b,e?f.POSITION_AFTER_END:f.POSITION_BEFORE_START);return true}}return n},selectNodeContents:function(b){this.setStart(b,0);this.setEnd(b,b[0].nodeType==j.NODE_TEXT?b[0].nodeValue.length:b[0].childNodes.length)}});var h={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},c=new l.whitespaces,k=new l.bookmark;x.Range=t});
KISSY.Editor.add("domiterator",function(x){function t(q){if(!(arguments.length<1)){this.range=q;this.forceBrBreak=false;this.enlargeBr=true;this.enforceRealBlocks=false;this._||(this._={})}}var B=KISSY,p=B.UA,u=x.Walker,A=x.Range,m=x.RANGE,w=x.NODE,j=x.ElementPath,f=B.Node,i=B.DOM,l=/^[\r\n\t ]*$/,r=u.bookmark();B.augment(t,{getNextParagraph:function(q){var o,v,a,d,g;if(!this._.lastNode){v=this.range.clone();v.enlarge(this.forceBrBreak||!this.enlargeBr?m.ENLARGE_LIST_ITEM_CONTENTS:m.ENLARGE_BLOCK_CONTENTS);
var h=new u(v),c=u.bookmark(true,true);h.evaluator=c;this._.nextNode=h.next();h=new u(v);h.evaluator=c;h=h.previous();this._.lastNode=h._4e_nextSourceNode(true);if(this._.lastNode&&this._.lastNode[0].nodeType==w.NODE_TEXT&&!B.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()){c=new A(v.document);c.moveToPosition(this._.lastNode,m.POSITION_AFTER_END);if(c.checkEndOfBlock()){c=new j(c.endContainer);this._.lastNode=(c.block||c.blockLimit)._4e_nextSourceNode(true)}}if(!this._.lastNode){this._.lastNode=
this._.docEndMarker=new f(v.document.createTextNode(""));i.insertAfter(this._.lastNode[0],h[0])}v=null}c=this._.nextNode;h=this._.lastNode;for(this._.nextNode=null;c;){var k=false,b=c[0].nodeType!=w.NODE_ELEMENT,e=false;if(b){if(c[0].nodeType==w.NODE_TEXT)if(l.test(c[0].nodeValue))b=false}else{var n=c._4e_name();if(c._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if(n=="br")b=true;else if(!v&&!c[0].childNodes.length&&n!="hr"){o=c;a=c._4e_equals(h);break}if(v){v.setEndAt(c,m.POSITION_BEFORE_START);
if(n!="br")this._.nextNode=c}k=true}else{if(c[0].firstChild){if(!v){v=new A(this.range.document);v.setStartAt(c,m.POSITION_BEFORE_START)}c=new f(c[0].firstChild);continue}b=true}}if(b&&!v){v=new A(this.range.document);v.setStartAt(c,m.POSITION_BEFORE_START)}a=(!k||b)&&c._4e_equals(h);if(v&&!k)for(;!c[0].nextSibling&&!a;){n=c.parent();if(n._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){k=true;a||n._4e_equals(h);break}c=n;b=true;a=c._4e_equals(h);e=true}b&&v.setEndAt(c,m.POSITION_AFTER_END);c=c._4e_nextSourceNode(e,
null,h);a=!c;if((k||a)&&v){b=v.getBoundaryNodes();k=new j(v.startContainer);if(b.startNode.parent()._4e_equals(k.blockLimit)&&r(b.startNode)&&r(b.endNode)){v=null;this._.nextNode=null}else break}if(a)break}if(!o){if(!v){this._.docEndMarker&&this._.docEndMarker._4e_remove();return this._.nextNode=null}k=new j(v.startContainer);c=k.blockLimit;b={div:1,th:1,td:1};o=k.block;if((!o||!o[0])&&!this.enforceRealBlocks&&b[c._4e_name()]&&v.checkStartOfBlock()&&v.checkEndOfBlock())o=c;else if(!o||this.enforceRealBlocks&&
o._4e_name()=="li"){o=new f(this.range.document.createElement(q||"p"));o[0].appendChild(v.extractContents());o._4e_trim();v.insertNode(o);d=g=true}else if(o._4e_name()!="li"){if(!v.checkStartOfBlock()||!v.checkEndOfBlock()){o=o._4e_clone(false);o[0].appendChild(v.extractContents());o._4e_trim();g=v.splitBlock();d=!g.wasStartOfBlock;g=!g.wasEndOfBlock;v.insertNode(o)}}else if(!a)this._.nextNode=o._4e_equals(h)?null:v.getBoundaryNodes().endNode._4e_nextSourceNode(true,null,h)}if(d){v=new f(o[0].previousSibling);
if(v[0]&&v[0].nodeType==w.NODE_ELEMENT)if(v._4e_name()=="br")v._4e_remove();else v[0].lastChild&&v[0].lastChild.nodeName.toLowerCase()=="br"&&i._4e_remove(v[0].lastChild)}if(g){v=u.bookmark(false,true);d=new f(o[0].lastChild);if(d[0]&&d[0].nodeType==w.NODE_ELEMENT&&d._4e_name()=="br")if(p.ie||d._4e_previous(v)||d._4e_next(v))d._4e_remove()}if(!this._.nextNode)this._.nextNode=a||o._4e_equals(h)?null:o._4e_nextSourceNode(true,null,h);return o}});A.prototype.createIterator=function(){return new t(this)}});
KISSY.Editor.add("selection",function(x){function t(h){this.document=h;this._={cache:{}};if(A.ie){var c=this.getNative().createRange();if(!c||c.item&&c.item(0).ownerDocument!=h||c.parentElement&&c.parentElement().ownerDocument!=h)this.isInvalid=true}}function B(h){h=new t(h);return!h||h.isInvalid?null:h}function p(h){var c=h.document,k=new f(c.body),b=new f(c.documentElement);if(A.ie){if(A.ie<8||document.documentMode==7)b.on("click",function(D){m._4e_name(D.target)==="html"&&h.getSelection().getRanges()[0].select()});
var e,n;k.on("focusin",function(D){if(D.target.nodeName.toUpperCase()=="BODY")if(e){try{e.select()}catch(H){}e=null}});k.on("focus",function(){n=true;s()});k.on("beforedeactivate",function(D){D.relatedTarget||(n=false)});A.ie<8&&w.on(m._4e_getWin(c),"blur",function(){c.selection.empty()});k.on("mousedown",z);k.on("mouseup",function(){n=true;setTimeout(function(){s(true)},0)});k.on("keydown",z);k.on("keyup",function(){n=true;s()});w.on(c,"selectionchange",s);var z=function(){n=false},s=function(D){if(n){var H=
h.document,y=h.getSelection(),C=y&&y.getNative();if(D&&C&&C.type=="None")if(!H.queryCommandEnabled("InsertImage")){setTimeout(function(){s(true)},50);return}var I;if(!(C&&C.type=="Text"&&(I=C.createRange().parentElement().nodeName.toLowerCase())&&I in{input:1,textarea:1})){e=C&&y.getRanges()[0];h._monitor()}}}}else{w.on(c,"mouseup",h._monitor,h);w.on(c,"keyup",h._monitor,h)}}x.SELECTION={};var u=KISSY,A=u.UA,m=u.DOM,w=u.Event,j=x.Utils.tryThese,f=u.Node,i=x.SELECTION,l=x.RANGE,r=x.NODE,q=x.Walker,
o=x.Range;i.SELECTION_NONE=1;i.SELECTION_TEXT=2;i.SELECTION_ELEMENT=3;var v={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};u.augment(t,{getNative:A.ie?function(){return this._.cache.nativeSel||(this._.cache.nativeSel=this.document.selection)}:function(){return this._.cache.nativeSel||(this._.cache.nativeSel=m._4e_getWin(this.document).getSelection())},getType:A.ie?function(){var h=this._.cache;if(h.type)return h.type;
var c=i.SELECTION_NONE;try{var k=this.getNative(),b=k.type;if(b=="Text")c=i.SELECTION_TEXT;if(b=="Control")c=i.SELECTION_ELEMENT;if(k.createRange().parentElement)c=i.SELECTION_TEXT}catch(e){}return h.type=c}:function(){var h=this._.cache;if(h.type)return h.type;var c=i.SELECTION_TEXT,k=this.getNative();if(k){if(k.rangeCount==1){k=k.getRangeAt(0);var b=k.startContainer;if(b==k.endContainer&&b.nodeType==r.NODE_ELEMENT&&k.endOffset-k.startOffset===1&&v[b.childNodes[k.startOffset].nodeName.toLowerCase()])c=
i.SELECTION_ELEMENT}}else c=i.SELECTION_NONE;return h.type=c},getRanges:A.ie?function(){var h=function(c,k){c=c.duplicate();c.collapse(k);k=c.parentElement();for(var b=k.childNodes,e,n=0;n<b.length;n++){var z=b[n];if(z.nodeType==r.NODE_ELEMENT){e=c.duplicate();e.moveToElementText(z);z=e.compareEndPoints("StartToStart",c);var s=e.compareEndPoints("EndToStart",c);e.collapse();if(z>0)break;else if(!z||s==1&&z==-1)return{container:k,offset:n};else if(!s)return{container:k,offset:n+1};e=null}}if(!e){e=
c.duplicate();e.moveToElementText(k);e.collapse(false)}e.setEndPoint("StartToStart",c);c=e.text.replace(/(\r\n|\r)/g,"\n").length;try{for(;c>0;)c-=b[--n].nodeValue.length}catch(D){c=0}return c===0?{container:k,offset:n}:{container:b[n],offset:-c}};return function(){var c=this._.cache;if(c.ranges)return c.ranges;var k=this.getNative(),b=k&&k.createRange(),e=this.getType();if(!k)return[];if(e==i.SELECTION_TEXT){k=new o(this.document);e=h(b,true);k.setStart(new f(e.container),e.offset);e=h(b);k.setEnd(new f(e.container),
e.offset);return c.ranges=[k]}else if(e==i.SELECTION_ELEMENT){c=this._.cache.ranges=[];for(e=0;e<b.length;e++){var n=b.item(e),z=n.parentNode,s=0;for(k=new o(this.document);s<z.childNodes.length&&z.childNodes[s]!=n;s++);k.setStart(new f(z),s);k.setEnd(new f(z),s+1);c.push(k)}return c}return c.ranges=[]}}():function(){var h=this._.cache;if(h.ranges)return h.ranges;var c=[],k=this.getNative();if(!k)return[];for(var b=0;b<k.rangeCount;b++){var e=k.getRangeAt(b),n=new o(this.document);n.setStart(new f(e.startContainer),
e.startOffset);n.setEnd(new f(e.endContainer),e.endOffset);c.push(n)}return h.ranges=c},getStartElement:function(){var h=this._.cache;if(h.startElement!==undefined)return h.startElement;var c,k=this.getNative();switch(this.getType()){case i.SELECTION_ELEMENT:return this.getSelectedElement();case i.SELECTION_TEXT:var b=this.getRanges()[0];if(b)if(!b.collapsed){for(b.optimize();;){c=b.startContainer;if(b.startOffset==(c[0].nodeType===r.NODE_ELEMENT?c[0].childNodes.length:c[0].nodeValue.length)&&!c._4e_isBlockBoundary())b.setStartAfter(c);
else break}c=b.startContainer;if(c[0].nodeType!=r.NODE_ELEMENT)return c.parent();c=new f(c[0].childNodes[b.startOffset]);if(!c[0]||c[0].nodeType!=r.NODE_ELEMENT)return b.startContainer;for(b=c[0].firstChild;b&&b.nodeType==r.NODE_ELEMENT;){c=new f(b);b=b.firstChild}return c}if(A.ie){b=k.createRange();b.collapse(true);c=b.parentElement()}else if((c=k.anchorNode)&&c.nodeType!=r.NODE_ELEMENT)c=c.parentNode}return h.startElement=c?new f(c):null},getSelectedElement:function(){var h=this._.cache;if(h.selectedElement!==
undefined)return h.selectedElement;var c=this,k=j(function(){return c.getNative().createRange().item(0)},function(){for(var b=c.getRanges()[0],e,n,z=2;z&&!((e=b.getEnclosedNode())&&e[0].nodeType==r.NODE_ELEMENT&&v[e._4e_name()]&&(n=e));z--)b.shrink(l.SHRINK_ELEMENT);return n[0]});return h.selectedElement=k?new f(k):null},reset:function(){this._.cache={}},selectElement:function(h){var c;if(A.ie)try{c=this.document.body.createControlRange();c.addElement(h[0]);c.select()}catch(k){c=this.document.body.createTextRange();
c.moveToElementText(h[0]);c.select()}finally{}else{c=this.document.createRange();c.selectNode(h[0]);h=this.getNative();h.removeAllRanges();h.addRange(c)}this.reset()},selectRanges:function(h){if(A.ie)h[0]&&h[0].select();else{var c=this.getNative();if(!c)return;c.removeAllRanges();for(var k=0;k<h.length;k++){var b=h[k],e=this.document.createRange(),n=b.startContainer;b.collapsed&&A.gecko&&A.gecko<1.09&&n[0].nodeType==r.NODE_ELEMENT&&!n[0].childNodes.length&&n[0].appendChild(this.document.createTextNode(""));
e.setStart(n[0],b.startOffset);e.setEnd(b.endContainer[0],b.endOffset);c.addRange(e)}}this.reset()},createBookmarks2:function(h){for(var c=[],k=this.getRanges(),b=0;b<k.length;b++)c.push(k[b].createBookmark2(h));return c},createBookmarks:function(h){for(var c=[],k=this.getRanges(),b=k.length,e,n=0;n<b;n++){c.push(e=k[n].createBookmark(h,true));var z=(h=e.serializable)?u.one("#"+e.startNode):e.startNode;e=h?u.one("#"+e.endNode):e.endNode;for(var s=n+1;s<b;s++){var D=k[s],H=D.startContainer,y=D.endContainer;
m._4e_equals(H,z.parent())&&D.startOffset++;m._4e_equals(H,e.parent())&&D.startOffset++;m._4e_equals(y,z.parent())&&D.endOffset++;m._4e_equals(y,e.parent())&&D.endOffset++}}return c},selectBookmarks:function(h){for(var c=[],k=0;k<h.length;k++){var b=new o(this.document);b.moveToBookmark(h[k]);c.push(b)}this.selectRanges(c);return this},getCommonAncestor:function(){var h=this.getRanges();return h[0].startContainer._4e_commonAncestor(h[h.length-1].endContainer)},scrollIntoView:function(){this.getStartElement()._4e_scrollIntoView()}});
x.Selection=t;var a={table:1,tbody:1,tr:1},d=q.whitespaces(true),g=/\ufeff|\u00a0/;o.prototype.select=A.ie?function(h){var c=this.collapsed,k,b;if(this.startContainer[0]===this.endContainer[0]&&this.endOffset-this.startOffset==1){var e=this.startContainer[0].childNodes[this.startOffset];if(e.nodeType==r.NODE_ELEMENT){(new t(this.document)).selectElement(new f(e));return}}if(this.startContainer[0].nodeType==r.NODE_ELEMENT&&this.startContainer._4e_name()in a||this.endContainer[0].nodeType==r.NODE_ELEMENT&&
this.endContainer._4e_name()in a)this.shrink(r.NODE_ELEMENT,true);var n=this.createBookmark();e=n.startNode;var z;if(!c)z=n.endNode;n=this.document.body.createTextRange();n.moveToElementText(e[0]);n.moveStart("character",1);if(z){h=this.document.body.createTextRange();h.moveToElementText(z[0]);n.setEndPoint("EndToEnd",h);n.moveEnd("character",-1)}else{for(k=e[0].nextSibling;k&&!d(k);)k=k.nextSibling;k=!(k&&k.nodeValue&&k.nodeValue.match(g))&&(h||!e[0].previousSibling||e[0].previousSibling&&m._4e_name(e[0].previousSibling)==
"br");b=this.document.createElement("span");b.innerHTML="&#65279;";b=new f(b);m.insertBefore(b[0],e[0]);k&&m.insertBefore(this.document.createTextNode("\ufeff"),e[0])}this.setStartBefore(e);e._4e_remove();if(c){if(k){n.moveStart("character",-1);n.select();this.document.selection.clear()}else n.select();if(b){this.moveToPosition(b,l.POSITION_BEFORE_START);b._4e_remove()}}else{this.setEndBefore(z);z._4e_remove();n.select()}}:function(){var h=this.startContainer;this.collapsed&&h[0].nodeType==r.NODE_ELEMENT&&
!h[0].childNodes.length&&h[0].appendChild(this.document.createTextNode(""));var c=this.document.createRange();c.setStart(h[0],this.startOffset);try{c.setEnd(this.endContainer[0],this.endOffset)}catch(k){if(k.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=0){this.collapse(true);c.setEnd(this.endContainer[0],this.endOffset)}else throw k;}h=B(this.document).getNative();h.removeAllRanges();h.addRange(c)};x.on("instanceCreated",function(h){p(h.editor)})});
KISSY.Editor.add("styles",function(x){function t(E,F){for(var G in E)E[G]=E[G].replace(aa,function(L,K){return F[K]})}function B(E,F){if(F){E=z.clone(E);t(E.attributes,F);t(E.styles,F)}F=this.element=(E.element||"*").toLowerCase();this.type=F=="#"||R[F]?D.STYLE_BLOCK:W[F]?D.STYLE_OBJECT:D.STYLE_INLINE;this._={definition:E}}function p(E,F){F=F?this.removeFromRange:this.applyToRange;E.body.focus();E=new y(E);for(var G=E.getRanges(),L=0;L<G.length;L++)F.call(this,G[L]);E.selectRanges(G)}function u(E,
F){var G=E.element;if(G=="*")G="span";F=new N(F.createElement(G));return A(F,E)}function A(E,F){var G=F._.definition;F=G.attributes;G=B.getStyleText(G);if(F)for(var L in F)E.attr(L,F[L]);if(G)E[0].style.cssText=G;return E}function m(E){var F=E.createBookmark(true),G=E.createIterator();G.enforceRealBlocks=true;G.enlargeBr=true;for(var L,K=E.document;L=G.getNextParagraph();){var O=u(this,K);i(L,O)}E.moveToBookmark(F)}function w(E,F,G){var L="",K="";E=E.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,
function(O,P,S){P&&(L=P);S&&(K=S);return""});return L+E.replace(F,G)+K}function j(E,F){var G=E.html();G=w(G,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,"");G=G.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1");G=G.replace(/([ \t\n\r]+|&nbsp;)/g," ");G=G.replace(/<br\b[^>]*>/gi,"\n");if(M.ie){E=E[0].ownerDocument.createElement("div");E.appendChild(F[0]);F[0].outerHTML="<pre>"+G+"</pre>";F=new N(E.firstChild);F._4e_remove()}else F.html(G);return F}function f(E){var F=[];w(E._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,
function(G,L,K){return L+"</pre>"+K+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(G,L){F.push(L)});return F}function i(E,F){var G=F._4e_name=="pre",L=E._4e_name=="pre",K=!G&&L;if(G&&!L)F=j(E,F);else if(K)F=r(f(E),F);else E._4e_moveChildren(F);E[0].parentNode.replaceChild(F[0],E[0]);G&&l(F)}function l(E){var F;if((F=E._4e_previousSourceNode(true,C.NODE_ELEMENT))&&F._4e_name()=="pre"){var G=w(F.html(),/\n$/,"")+"\n\n"+w(E.html(),/^\n/,"");if(M.ie)E[0].outerHTML="<pre>"+G+"</pre>";else E.html(G);
F._4e_remove()}}function r(E,F){for(var G=F[0].ownerDocument.createDocumentFragment(),L=0;L<E.length;L++){var K=E[L];K=K.replace(/(\r\n|\r)/g,"\n");K=w(K,/^[ \t]*\n/,"");K=w(K,/\n$/,"");K=w(K,/^[ \t]+|[ \t]+$/g,function(P,S){return P.length==1?"&nbsp;":S?" "+(new Array(P.length)).join("&nbsp;"):(new Array(P.length)).join("&nbsp;")+" "});K=K.replace(/\n/g,"<br>");K=K.replace(/[ \t]{2,}/g,function(P){return(new Array(P.length)).join("&nbsp;")+" "});var O=F._4e_clone();O.html(K);G.appendChild(O[0])}return G}
function q(E){var F=E.document;if(E.collapsed){F=u(this,F);E.insertNode(F);E.moveToPosition(F,H.POSITION_BEFORE_END)}else{var G=this.element,L=this._.definition,K,O=x.XHTML_DTD[G]||(K=true,x.XHTML_DTD.span),P=E.createBookmark();E.enlarge(H.ENLARGE_ELEMENT);E.trim();var S=E.createBookmark(),da=S.startNode;S=S.endNode;for(var U=da,X;U&&U[0];){var T=false;if(s._4e_equals(U,S)){U=null;T=true}else{var V=U[0].nodeType,ba=V==C.NODE_ELEMENT?U._4e_name():null;if(ba&&U.attr("_ke_bookmark")){U=U._4e_nextSourceNode(true);
continue}if(!ba||O[ba]&&(U._4e_position(S)|I.POSITION_PRECEDING|I.POSITION_IDENTICAL|I.POSITION_IS_CONTAINED)==I.POSITION_PRECEDING+I.POSITION_IDENTICAL+I.POSITION_IS_CONTAINED&&(!L.childRule||L.childRule(U))){var ca=U.parent();if(ca&&ca[0]&&((x.XHTML_DTD[ca._4e_name()]||x.XHTML_DTD.span)[G]||K)&&(!L.parentRule||L.parentRule(ca))){if(!X&&(!ba||!x.XHTML_DTD.$removeEmpty[ba]||(U._4e_position(S)|I.POSITION_PRECEDING|I.POSITION_IDENTICAL|I.POSITION_IS_CONTAINED)==I.POSITION_PRECEDING+I.POSITION_IDENTICAL+
I.POSITION_IS_CONTAINED)){X=new J(F);X.setStartBefore(U)}if(V==C.NODE_TEXT||V==C.NODE_ELEMENT&&!U[0].childNodes.length){V=U;for(var Y;!V[0].nextSibling&&(Y=V.parent(),O[Y._4e_name()])&&(Y._4e_position(da)|I.POSITION_FOLLOWING|I.POSITION_IDENTICAL|I.POSITION_IS_CONTAINED)==I.POSITION_FOLLOWING+I.POSITION_IDENTICAL+I.POSITION_IS_CONTAINED&&(!L.childRule||L.childRule(Y));)V=Y;X.setEndAfter(V);V[0].nextSibling||(T=true)}}else T=true}else T=true;U=U._4e_nextSourceNode()}if(T&&X&&!X.collapsed){T=u(this,
F);for(V=X.getCommonAncestor();T&&V&&T[0]&&V[0];){if(V._4e_name()==G){for(var Z in L.attributes)T.attr(Z)==V.attr(Z)&&T[0].removeAttribute(Z);for(var ea in L.styles)T._4e_style(ea)==V._4e_style(ea)&&T._4e_style(ea,"");if(!T._4e_hasAttributes()){T=null;break}}V=V.parent()}if(T){T[0].appendChild(X.extractContents());b(this,T);X.insertNode(T);T._4e_mergeSiblings();M.ie||T[0].normalize()}X=null}}da._4e_remove();S._4e_remove();E.moveToBookmark(P);E.shrink(H.SHRINK_TEXT)}}function o(E){E.enlarge(H.ENLARGE_ELEMENT);
var F=E.createBookmark(),G=F.startNode;if(E.collapsed){for(var L=new Q(G.parent()),K,O=0,P;O<L.elements.length&&(P=L.elements[O]);O++){if(P==L.block||P==L.blockLimit)break;if(this.checkElementRemovable(P)){var S=E.checkBoundaryOfElement(P,H.END),da=!S&&E.checkBoundaryOfElement(P,H.START);if(da||S){K=P;K.match=da?"start":"end"}else{P._4e_mergeSiblings();P._4e_name()==this.element?c(this,P):e(P,h(this)[P._4e_name()])}}}if(K&&K[0]){P=G;for(O=0;;O++){S=L.elements[O];if(s._4e_equals(S,K))break;else if(S.match)continue;
else S=S._4e_clone();S[0].appendChild(P[0]);P=S}s[K.match=="start"?"insertBefore":"insertAfter"](P[0],K[0])}}else{var U=F.endNode,X=this;L=function(){for(var T=new Q(G.parent()),V=new Q(U.parent()),ba=null,ca=null,Y=0;Y<T.elements.length;Y++){var Z=T.elements[Y];if(Z==T.block||Z==T.blockLimit)break;if(X.checkElementRemovable(Z))ba=Z}for(Y=0;Y<V.elements.length;Y++){Z=V.elements[Y];if(Z==V.block||Z==V.blockLimit)break;if(X.checkElementRemovable(Z))ca=Z}ca&&U._4e_breakParent(ca);ba&&G._4e_breakParent(ba)};
L();for(K=new N(G[0].nextSibling);K[0]!==U[0];){O=K._4e_nextSourceNode();if(K[0]&&K[0].nodeType==C.NODE_ELEMENT&&this.checkElementRemovable(K)){K._4e_name()==this.element?c(this,K):e(K,h(this)[K._4e_name()]);if(O[0].nodeType==C.NODE_ELEMENT&&O._4e_contains(G)){L();O=new N(G[0].nextSibling)}}K=O}}E.moveToBookmark(F)}function v(E){var F={};E.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(G,L,K){F[L]=K});return F}function a(E,F){typeof E=="string"&&(E=v(E));typeof F==
"string"&&(F=v(F));for(var G in E)if(!(G in F&&(F[G]==E[G]||E[G]=="inherit"||F[G]=="inherit")))return false;return true}function d(E,F){if(F!==false){F=document.createElement("span");F.style.cssText=E;E=F.style.cssText||""}else E=E;return E.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function g(E){var F=E._AC;if(F)return F;F={};var G=0,L=E.attributes;if(L)for(var K in L){G++;F[K]=L[K]}if(L=B.getStyleText(E)){F.style||G++;F.style=L}F._length=G;return E._AC=
F}function h(E){if(E._.overrides)return E._.overrides;var F=E._.overrides={},G=E._.definition.overrides;if(G){z.isArray(G)||(G=[G]);for(var L=0;L<G.length;L++){var K=G[L],O,P;if(typeof K=="string")O=K.toLowerCase();else{O=K.element?K.element.toLowerCase():E.element;P=K.attributes}K=F[O]||(F[O]={});if(P){K=K.attributes=K.attributes||[];for(var S in P)K.push([S.toLowerCase(),P[S]])}}}return F}function c(E,F){var G=E._.definition,L=z.mix(z.mix({},G.attributes),h(E)[F._4e_name()]);G=G.styles;var K=z.isEmptyObject(L)&&
z.isEmptyObject(G);for(var O in L)if(!((O=="class"||E._.definition.fullMatch)&&F.attr(O)!=k(O,L[O]))){K=K||!!F._4e_hasAttribute(O);F.removeAttr(O)}for(var P in G)if(!(E._.definition.fullMatch&&F._4e_style(P)!=k(P,G[P],true))){K=K||!!F._4e_style(P);F._4e_style(P,"")}K&&n(F)}function k(E,F,G){var L=new N("<span></span>");L[G?"_4e_style":"attr"](E,F);return L[G?"_4e_style":"attr"](E)}function b(E,F){for(var G=h(E),L=F.all(E.element),K=L.length;--K>=0;)c(E,new N(L[K]));for(var O in G)if(O!=E.element){L=
F.all(O);for(K=L.length-1;K>=0;K--){var P=new N(L[K]);e(P,G[O])}}}function e(E,F){if(F=F&&F.attributes)for(var G=0;G<F.length;G++){var L=F[G][0],K;if(K=E.attr(L)){var O=F[G][1];if(O===null||O.test&&O.test(K)||typeof O=="string"&&K==O)E[0].removeAttribute(L)}}n(E)}function n(E){if(!E._4e_hasAttributes()){var F=E[0].firstChild,G=E[0].lastChild;E._4e_remove(true);if(F){F.nodeType==C.NODE_ELEMENT&&s._4e_mergeSiblings(F);G&&!F===G&&G.nodeType==C.NODE_ELEMENT&&s._4e_mergeSiblings(G)}}}var z=KISSY,s=z.DOM,
D=x.STYLE={},H=x.RANGE,y=x.Selection,C=x.NODE,I=x.POSITION,J=x.Range,N=z.Node,M=z.UA,Q=x.ElementPath,R={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},W={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},$=/\s*(?:;\s*|$)/,aa=/#\((.+?)\)/g;D.STYLE_BLOCK=1;D.STYLE_INLINE=2;D.STYLE_OBJECT=3;B.prototype={apply:function(E){p.call(this,E,false)},remove:function(E){p.call(this,E,true)},applyToRange:function(E){return(this.applyToRange=this.type==D.STYLE_INLINE?
q:this.type==D.STYLE_BLOCK?m:this.type==D.STYLE_OBJECT?null:null).call(this,E)},removeFromRange:function(E){return(this.removeFromRange=this.type==D.STYLE_INLINE?o:null).call(this,E)},applyToObject:function(E){A(E,this)},checkElementRemovable:function(E,F){if(!E)return false;var G=this._.definition;if(E._4e_name()==this.element){if(!F&&!E._4e_hasAttributes())return true;G=g(G);if(G._length){for(var L in G)if(L!="_length"){var K=E.attr(L)||"";if(L=="style"?a(G[L],d(K,false)):G[L]==K){if(!F)return true}else if(F)return false}if(F)return true}else return true}if(G=
h(this)[E._4e_name()]){if(!(G=G.attributes))return true;for(F=0;F<G.length;F++){L=G[F][0];if(L=E.attr(L)){K=G[F][1];if(K===null||typeof K=="string"&&L==K||K.test&&K.test(L))return true}}}return false},checkActive:function(E){switch(this.type){case D.STYLE_BLOCK:return this.checkElementRemovable(E.block||E.blockLimit,true);case D.STYLE_OBJECT:case D.STYLE_INLINE:for(var F=E.elements,G=0,L;G<F.length;G++){L=F[G];if(!(this.type==D.STYLE_INLINE&&(s._4e_equals(L,E.block)||s._4e_equals(L,E.blockLimit))))if(!(this.type==
D.STYLE_OBJECT&&!(L._4e_name()in W)))if(this.checkElementRemovable(L,true))return true}}return false}};B.getStyleText=function(E){var F=E._ST;if(F)return F;F=E.styles;var G=E.attributes&&E.attributes.style||"",L="";if(G.length)G=G.replace($,";");for(var K in F){var O=F[K],P=(K+":"+O).replace($,";");if(O=="inherit")L+=P;else G+=P}if(G.length)G=d(G);G+=L;return E._ST=G};x.Style=B});
KISSY.Editor.add("bubbleview",function(){function x(j){x.superclass.constructor.apply(this,arguments);j.init&&j.init.call(this)}function t(j){j=w[j];if(!j.bubble)j.bubble=new x(j.cfg);return j.bubble}var B=KISSY.Editor,p=KISSY,u=p.Event,A=p.DOM,m=p.Node,w={};x.attach=function(j){var f=j.pluginInstance,i=j.pluginName;j=f.editor;var l=w[i].cfg.func,r=w[i].bubble;j.on("selectionChange",function(q){q=q.path;var o=q.elements;if(q&&o)if(q=q.lastElement)if(q=l(q)){r=t(i);r._selectedEl=q;r._plugin=f;r.show()}else if(r){r._selectedEl=
r._plugin=null;r.hide()}});u.on(j.document,"scroll",function(){r&&r.hide()});u.on(A._4e_getWin(j.document),"blur",function(){r&&r.hide()})};x.register=function(j){w[j.pluginName]={cfg:j}};x.ATTRS={focusMgr:{value:false}};p.extend(x,B.SimpleOverlay,{_initEl:function(){var j=new m('<div class="ke-bubbleview-bubble" onmousedown="return false;"></div>');j.appendTo(document.body);this.el=j;this.set("el",j)},show:function(){var j=this._selectedEl,f=j._4e_getOffset(document);f.top+=j.height()+5;x.superclass.show.call(this,
f)}});B.BubbleView=x});
KISSY.Editor.add("button",function(){function x(u){x.superclass.constructor.call(this,u);this._init()}var t=KISSY.Editor,B=KISSY,p=B.Node;x.ON="on";x.OFF="off";x.DISABLED="disabled";x.ON_CLASS="ke-triplebutton-on";x.OFF_CLASS="ke-triplebutton-off";x.DISABLED_CLASS="ke-triplebutton-disabled";x.ATTRS={state:{value:"off"},container:{},text:{},contentCls:{},cls:{}};B.extend(x,B.Base,{_init:function(){var u=this.get("container")[0]||this.get("container");this.el=new p("<a class='ke-triplebutton ke-triplebutton-off' href='#' role=\"button\"></a>");this.el._4e_unselectable();
this._attachCls();if(this.get("text"))this.el.html(this.get("text"));else if(this.get("contentCls")){this.el.html("<span class='ke-toolbar-item "+this.get("contentCls")+"'></span>");this.el.one("span")._4e_unselectable()}this.get("title")&&this.el.attr("title",this.get("title"));u.appendChild(this.el[0]);this.el.on("click",this._action,this);this.on("afterStateChange",this._stateChange,this)},_attachCls:function(){var u=this.get("cls");u&&this.el.addClass(u)},_stateChange:function(u){this["_"+u.newVal]();
this._attachCls()},_action:function(u){this.fire(this.get("state")+"Click",u);this.fire("click",u);u.preventDefault()},_on:function(){this.el[0].className="ke-triplebutton ke-triplebutton-on"},_off:function(){this.el[0].className="ke-triplebutton ke-triplebutton-off"},_disabled:function(){this.el[0].className="ke-triplebutton ke-triplebutton-disabled"}});t.TripleButton=x});
KISSY.Editor.add("contextmenu",function(){function x(f){this.cfg=p.clone(f);B.Utils.lazyRun(this,"_prepareShow","_realShow")}function t(f,i){for(var l=0;l<i.length;l++)if(A.test(f,i[l]))return true;return false}var B=KISSY.Editor,p=KISSY,u=p.Node,A=p.DOM,m=p.Event,w=[];x.register=function(f,i){var l=new x(i);w.push({doc:f,rules:i.rules,instance:l});if(!f.ke_contextmenu){f.ke_contextmenu=1;m.on(f,"mousedown",x.hide);m.on(f,"contextmenu",function(r){x.hide.call(this);for(var q=new u(r.target);q;){var o=
false;if(q._4e_name()=="body")break;for(var v=0;v<w.length;v++){var a=w[v].instance,d=w[v].rules;if(f===w[v].doc&&t(q[0],d)){r.preventDefault();o=true;setTimeout(function(){a.show(B.Utils.getXY(r.pageX,r.pageY,f,document))},30);break}}if(o)break;q=q.parent()}})}return l};x.hide=function(){for(var f=0;f<w.length;f++){var i=w[f].instance;this===w[f].doc&&i.hide()}};var j=B.SimpleOverlay;p.augment(x,{_init:function(){var f=this,i=f.cfg,l=i.funcs;f.elDom=new u("<div class='ke-menu' onmousedown='return false;'></div>");
var r=f.elDom;r.css("width",i.width);document.body.appendChild(r[0]);f.el=new j({el:r});for(var q in l){i=new u("<a href='#'>"+q+"</a>");r[0].appendChild(i[0]);(function(o,v){o._4e_unselectable();o.on("click",function(a){f.hide();a.halt();setTimeout(v,30)})})(i,l[q])}},hide:function(){this.el&&this.el.hide()},_realShow:function(f){this.el.show(f)},_prepareShow:function(){this._init()},show:function(f){this._prepareShow(f)}});B.ContextMenu=x});
KISSY.Editor.add("overlay",function(){function x(){var i=this;x.superclass.constructor.apply(i,arguments);i._init();if(B.UA.ie===6){i.on("show",function(){var l=i.get("el"),r=parseInt(l.css("width"));l=l[0].offsetHeight;f&&f.css({width:r+"px",height:l+"px"});f&&f.offset(i.get("el").offset())});i.on("hide",function(){f&&f.offset({left:-999,top:-999})})}if(i.get("mask")){i.on("show",function(){w&&w.css({left:"0px",top:"0px"});j&&j.css({left:"0px",top:"0px"})});i.on("hide",function(){w&&w.css({left:"-9999px",
top:"-9999px"});j&&j.css({left:"-9999px",top:"-9999px"})})}i.hide()}var t=KISSY.Editor,B=KISSY,p=B.UA,u=t.focusManager,A=B.Node,m=B.DOM,w,j,f;x.init=function(){var i=document.body;w=new A('<div class="ke-mask">&nbsp;</div>');w.css({left:"-9999px",top:"-9999px"});w.css({width:"100%",height:m.docHeight()+"px",opacity:0.4});w.appendTo(i);if(p.ie&&p.ie==6){f=new A("<iframe class='ke-dialog-iframe'></iframe>");f.appendTo(i);j=new A("<iframe class='ke-mask'></iframe>");j.css({left:"-9999px",top:"-9999px"});
j.css({width:"100%",height:m.docHeight()+"px",opacity:0.4});j.appendTo(i)}x.init=null};x.ATTRS={title:{value:""},width:{value:"450px"},visible:{value:false},focusMgr:{value:true},mask:{value:false}};B.extend(x,B.Base,{_init:function(){var i=this;i._initEl();var l=i.get("el");i.on("afterVisibleChange",function(r){if(r=r.newVal){typeof r=="boolean"?i.center():l.offset(r);i.fire("show")}else{l.css({left:"-9999px",top:"-9999px"});i.fire("hide")}});if(i.get("focusMgr")){i._initFocusNotice();i.on("beforeVisibleChange",
i._editorFocusMg,i)}l.css({left:"-9999px",top:"-9999px"})},_initEl:function(){var i=this,l=i.get("el");if(l)i.el=l;else{l=new A("<div class='ke-dialog' style='width:"+i.get("width")+"'><div class='ke-hd'><span class='ke-hd-title'>"+i.get("title")+"</span><span class='ke-hd-x'><a class='ke-close' href='#'>X</a></span></div><div class='ke-bd'></div><div class='ke-ft'></div></div>");document.body.appendChild(l[0]);i.set("el",l);i.el=l;i.body=l.one(".ke-bd");i.foot=l.one(".ke-ft");i._close=l.one(".ke-close");
i._title=l.one(".ke-hd-title").one("h1");i._close.on("click",function(r){r.preventDefault();i.hide()})}},center:function(){var i=this.get("el"),l=parseInt(i.css("width")),r=i[0].offsetHeight,q=m.viewportWidth(),o=m.viewportHeight();l=(q-l)/2+m.scrollLeft();r=(o-r)/2+m.scrollTop();if(r-m.scrollTop()>200)r-=150;i.css({left:l+"px",top:r+"px"})},_prepareShow:function(){x.init()},_getFocusEl:function(){if(this._focusEl)return this._focusEl;this._focusEl=new A("<a href='#' class='ke-focus' style='width:0;height:0;margin:0;padding:0;overflow:hidden;outline:none;font-size:0;'></a>");
this._focusEl.appendTo(this.el);return this._focusEl},_initFocusNotice:function(){var i=this,l=i._getFocusEl();l.on("focus",function(){i.fire("focus")});l.on("blur",function(){i.fire("blur")})},_editorFocusMg:function(i){var l=this._focusEditor;if(i.newVal){l=this._focusEditor=u.currentInstance();this._getFocusEl()[0].focus();var r=this.el.one("input");if(r)setTimeout(function(){try{r[0].focus();r[0].select()}catch(q){}},0);else if(p.ie&&l)if(i=l.document.selection.createRange())if(i.item&&i.item(0).ownerDocument==
l.document){l=document.body.createTextRange();l.moveToElementText(this.el._4e_first()[0]);l.collapse(true);l.select()}}else l&&l.focus()},_realShow:function(i){this.get("el");this.set("visible",i||true)},show:function(i){this._prepareShow(i)},hide:function(){this.get("el");this.set("visible",false)}});t.Utils.lazyRun(x.prototype,"_prepareShow","_realShow");t.SimpleOverlay=x});
KISSY.Editor.add("select",function(){function x(m){x.superclass.constructor.call(this,m);this._init()}var t=KISSY,B=t.Node,p=t.Event,u=t.DOM,A=t.Editor;x.ATTRS={container:{},doc:{},value:{},width:{},title:{},items:{}};t.extend(x,t.Base,{_init:function(){var m=this.get("container"),w=new B("<a href='#' class='ke-select'><span class='ke-select-text'></span><span class='ke-select-drop'></span></a>"),j=this.get("title"),f=w.one(".ke-select-text");w.one(".ke-select-drop");f.html(j);f.css("width",this.get("width"));
w._4e_unselectable();w.attr("title",j);w.appendTo(m);w.on("click",this._click,this);this.el=w;this.title=f;A.Utils.lazyRun(this,"_prepare","_real");this.on("afterValueChange",this._valueChange,this)},_valueChange:function(m){m=m.newVal;for(var w=this.get("title"),j=this.get("items"),f=0;f<j.length;f++){var i=j[f];if(i.value==m){w=i.name;break}}this.title.html(w)},_prepare:function(){var m=this.el,w=new B("<div class='ke-menu' onmousedown='return false;'></div>"),j=new A.SimpleOverlay({el:w,focusMgr:false}),
f=this.get("items");this.get("title")&&(new B("<div class='ke-menu-title ke-select-menu-item' style='margin-top:-6px;' >"+this.get("title")+"</div>")).appendTo(w);for(var i=0;i<f.length;i++){var l=f[i];l=new B("<a class='ke-select-menu-item' href='#' data-value='"+l.value+"'>"+l.name+"</a>",l.attrs);l._4e_unselectable();l.appendTo(w)}this.get("popUpWidth")&&w.css("width",this.get("popUpWidth"));w.appendTo(document.body);this.menu=j;j.on("show",function(){m.addClass("ke-select-active")});j.on("hide",
function(){m.removeClass("ke-select-active")});p.on([document,this.get("doc")],"click",function(q){m._4e_contains(q.target)||j.hide()});w.on("click",this._select,this);var r=this.as=w.all("a");p.on(w[0],"mouseenter",function(){r.removeClass("ke-menu-selected")})},_select:function(m){m.halt();var w=this.menu,j=w.el;if(m=(new B(m.target))._4e_ascendant(function(l){return j._4e_contains(l)&&l._4e_name()=="a"},true)){var f=this.get("value"),i=m.attr("data-value");this.set("value",i);this.fire("click",
{newVal:i,preVal:f,name:m.html()});w.hide()}},_real:function(){var m=this.el.offset();m.top+=this.el.height()+8;m.left+=1;if(m.left+this.menu.el.width()>u.viewportWidth()-60)m.left=u.viewportWidth()-this.menu.el.width()-60;this.menu.show(m)},_click:function(m){m.preventDefault();var w=this.get("value");if(this.el.hasClass("ke-select-active"))this.menu.hide();else{this._prepare();w&&this.menu&&this.as.each(function(j){j.attr("data-value")==w?j.addClass("ke-menu-selected"):j.removeClass("ke-menu-selected")})}}});
A.Select=x});
KISSY.Editor.add("clipboard",function(x){var t=KISSY.Editor,B=KISSY,p=B.Node,u=B.UA,A=t.Range,m=t.RANGE,w=B.Event;t.Paste||function(){function j(f){this.editor=f;this._init()}B.augment(j,{_init:function(){var f=this.editor;u.ie?w.on(f.document,"keydown",this._paste,this):w.on(f.document,"paste",this._paste,this)},_paste:function(f){if(!(f.type==="keydown"&&!(f.keyCode===86&&(f.ctrlKey||f.metaKey)))){var i=this.editor;f=i.document;var l=i.getSelection(),r=new A(f),q=new p(u.webkit?"<body></body>":"<div></div>",
null,f);u.webkit&&q[0].appendChild(f.createTextNode("\u00a0"));f.body.appendChild(q[0]);q.css({position:"absolute",top:l.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});q.css("left","-1000px");var o=l.createBookmarks();r.setStartAt(q,m.POSITION_AFTER_START);r.setEndAt(q,m.POSITION_BEFORE_END);r.select(true);setTimeout(function(){q._4e_remove();var v;q=u.webkit&&(v=q._4e_first())&&v[0]&&v.hasClass("Apple-style-span")?v:q;l.selectBookmarks(o);i.insertHtml(q.html())},
0)}}});t.Paste=j}();x.addPlugin(function(){new t.Paste(x)})});
KISSY.Editor.add("color",function(x){function t(c){return("0"+c).slice(c.length-1,c.length+1)}function B(c){c=u.trim(c);if(c.charAt(0)=="#")c=c.substring(1);c=c.replace(/\s+/g,"");var k="";if(/^[0-9a-f]{3,3}$/i.test(c))k=c.replace(/[0-9a-f]/ig,function(e){return e+e});else{var b=c.match(i);if(b&&b[0])for(c=1;c<4;c++)k+=t(parseInt(b[c]).toString(16));else k=c}return"#"+k.toLowerCase()}for(var p=KISSY.Editor,u=KISSY,A=u.Node,m=u.Event,w=p.SimpleOverlay,j=p.Style,f=u.DOM,i=/^rgb\((\d+),(\d+),(\d+)\)$/i,
l="000,800000,8B4513,2F4F4F,008080,000080,4B0082,696969,B22222,A52A2A,DAA520,006400,40E0D0,0000CD,800080,808080,F00,FF8C00,FFD700,008000,0FF,00F,EE82EE,A9A9A9,FFA07A,FFA500,FFFF00,00FF00,AFEEEE,ADD8E6,DDA0DD,D3D3D3,FFF0F5,FAEBD7,FFFFE0,F0FFF0,F0FFFF,F0F8FF,E6E6FA,FFF".split(/,/),r={element:"span",styles:{color:"#(color)"},overrides:[{element:"font",attributes:{color:null}}]},q={element:"span",styles:{"background-color":"#(color)"}},o="<div class='ke-popup-wrap ke-color-wrap'><a class='ke-color-remove' href=\"javascript:void('\u6e05\u9664');\"><span>\u6e05\u9664</span></a><table>",
v={},a={},d=0;d<5;d++){o+="<tr>";for(var g=0;g<8;g++){var h=B(l[8*d+g]);o+="<td>";o+="<a href='javascript:void(0);' class='ke-color-a'><span style='background-color:"+h+"'></span></a>";o+="</td>";v[h]=new j(q,{color:h});a[h]=new j(r,{color:h})}o+="</tr>"}v.inherit=new j(q,{color:"inherit"});a.inherit=new j(r,{color:"inherit"});o+="</table></div>";p.ColorSupport||function(){function c(b){c.superclass.constructor.call(this,b);this._init()}var k=p.TripleButton;c.ATTRS={editor:{},styles:{},contentCls:{},
text:{}};u.extend(c,u.Base,{_init:function(){var b=this.get("editor").toolBarDiv;b=new k({container:b,title:this.get("title"),contentCls:this.get("contentCls")});b.on("offClick",this._showColors,this);this.el=b;p.Utils.lazyRun(this,"_prepare","_real")},_hidePanel:function(b){var e=this;f._4e_ascendant(b.target,function(n){return n[0]===e.el.el[0]},true)||this.colorWin.hide()},_selectColor:function(b){b.halt();var e=this.get("editor");b=b.target;if(f._4e_name(b)=="span"||f._4e_name(b)=="a"){b=new A(b);
if(b._4e_name()=="a")b=b.one("span");var n=this.get("styles");e.fire("save");b._4e_style("background-color")?n[B(b._4e_style("background-color"))].apply(e.document):n.inherit.remove(e.document);e.fire("save");this.colorWin.hide()}},_prepare:function(){this.colorPanel=new A(o);this.colorWin=new w({el:this.colorPanel,mask:false,focusMgr:false});document.body.appendChild(this.colorPanel[0]);this.colorPanel.on("click",this._selectColor,this);m.on(document,"click",this._hidePanel,this);m.on(x.document,
"click",this._hidePanel,this)},_real:function(){var b=this.el.el.offset();b.top+=this.el.el.height()+5;if(b.left+this.colorPanel.width()>f.viewportWidth()-60)b.left=f.viewportWidth()-this.colorPanel.width()-60;this.colorWin.show(b)},_showColors:function(b){this._prepare(b)}});p.ColorSupport=c}();x.addPlugin(function(){new p.ColorSupport({editor:x,styles:v,title:"\u80cc\u666f\u989c\u8272",contentCls:"ke-toolbar-bgcolor",text:"bgcolor"});new p.ColorSupport({editor:x,styles:a,title:"\u6587\u672c\u989c\u8272",
contentCls:"ke-toolbar-color",text:"color"})})});
KISSY.Editor.add("elementpaths",function(x){var t=KISSY.Editor,B=KISSY,p=B.Node,u=B.DOM;t.ElementPaths||function(){function A(m){this.cfg=m;this._cache=[];this._init()}B.augment(A,{_init:function(){var m=this.cfg.editor;this.holder=new p("<div>");this.holder.appendTo(m.statusDiv);m.on("selectionChange",this._selectionChange,this)},_selectionChange:function(m){var w=this.cfg.editor,j=this.holder;j=j[0]||j;m=m.path.elements;var f,i;f=this._cache;for(i=0;i<f.length;i++){f[i].detach("click");f[i]._4e_remove()}this._cache=
[];for(i=0;i<m.length;i++){f=m[i];var l=new p("<a href='#' class='elementpath'>"+(f.attr("_ke_real_element_type")||f._4e_name())+"</a>");this._cache.push(l);(function(r){l.on("click",function(q){q.halt();w.focus();setTimeout(function(){w.getSelection().selectElement(r)},50)})})(f);j.firstChild?u.insertBefore(l[0],j.firstChild):j.appendChild(l[0])}}});t.ElementPaths=A}();x.addPlugin(function(){new t.ElementPaths({editor:x})})});
KISSY.Editor.add("enterkey",function(x){var t=KISSY.Editor,B=KISSY,p=B.UA,u=/^h[1-6]$/,A=t.XHTML_DTD,m=B.Node,w=B.Event,j=t.Walker,f=t.ElementPath;t.enterBlock||function(){function i(q){q=q.getSelection().getRanges();for(var o=q.length-1;o>0;o--)q[o].deleteContents();return q[0]}function l(q){var o=i(q),v=o.document;if(o.checkStartOfBlock()&&o.checkEndOfBlock()){var a=(new f(o.startContainer)).block;if(a&&(a._4e_name()=="li"||a.parent()._4e_name()=="li")){q.execCommand("outdent");return}}var d=o.splitBlock("p");
if(d){q=d.previousBlock;a=d.nextBlock;var g=d.wasStartOfBlock,h=d.wasEndOfBlock,c;if(a){c=a.parent();if(c._4e_name()=="li"){a._4e_breakParent(c);a._4e_move(a._4e_next(),true)}}else if(q&&(c=q.parent())&&c._4e_name()=="li"){q._4e_breakParent(c);o.moveToElementEditablePosition(q._4e_next());q._4e_move(q._4e_previous())}if(!g&&!h){if(a._4e_name()=="li"&&(c=a._4e_first(j.invisible(true)))&&B.inArray(c._4e_name(),["ul","ol"]))(p.ie?new m(v.createTextNode("\u00a0")):new m(v.createElement("br"))).insertBefore(c);
a&&o.moveToElementEditablePosition(a)}else{var k;if(q){if(q._4e_name()=="li"||!u.test(q._4e_name()))k=q._4e_clone()}else if(a)k=a._4e_clone();k||(k=new m("p",null,v));if(c=d.elementPath){d=0;for(var b=c.elements.length;d<b;d++){var e=c.elements[d];if(e._4e_equals(c.block)||e._4e_equals(c.blockLimit))break;if(A.$removeEmpty[e._4e_name()]){e=e._4e_clone();k._4e_moveChildren(e);k.append(e)}}}p.ie||k._4e_appendBogus();o.insertNode(k);if(p.ie&&g&&(!h||!q[0].childNodes.length)){o.moveToElementEditablePosition(h?
q:k);o.select()}o.moveToElementEditablePosition(g&&!h?a:k)}if(!p.ie)if(a){v=new m(v.createElement("span"));v.html("&nbsp;");o.insertNode(v);v._4e_scrollIntoView();o.deleteContents()}else k._4e_scrollIntoView();o.select()}}function r(q){w.on(q.document,"keydown",function(o){if(o.keyCode===13)if(!o.shiftKey){q.execCommand("enterBlock");o.preventDefault()}})}r.enterBlock=l;t.EnterKey=r}();x.addPlugin(function(){x.addCommand("enterBlock",{exec:t.EnterKey.enterBlock});t.EnterKey(x)})});
KISSY.Editor.add("fakeobjects",function(x){var t=KISSY.Editor,B=KISSY,p=B.Node,u=t.NODE,A=t.HtmlParser,m=B.Editor,w=(x=x.htmlDataProcessor)&&x.htmlFilter,j={elements:{$:function(f){var i=f.attributes;if((i=(i=(i=i&&i._ke_realelement)&&new A.Fragment.FromHtml(decodeURIComponent(i)))&&i.children[0])&&f.attributes._ke_resizable){var l=f.attributes.style;if(l){var r=/(?:^|\s)width\s*:\s*(\d+)/i.exec(l);f=r&&r[1];l=(r=/(?:^|\s)height\s*:\s*(\d+)/i.exec(l))&&r[1];if(f)i.attributes.width=f;if(l)i.attributes.height=
l}}return i}}};w&&w.addRules(j);x&&B.mix(x,{createFakeParserElement:function(f,i,l,r){var q;q=new A.BasicWriter;f.writeHtml(q);q=q.getHtml();var o=f.attributes.style;if(f.attributes.width)o="width:"+f.attributes.width+"px;"+o;if(f.attributes.height)o="height:"+f.attributes.height+"px;"+o;f={"class":i,src:t.Config.base+"assets/spacer.gif",_ke_realelement:encodeURIComponent(q),_ke_real_node_type:f.type,style:o,align:f.attributes.align||""};if(l)f._ke_real_element_type=l;if(r)f._ke_resizable=r;return new A.Element("img",
f)}});B.augment(m,{createFakeElement:function(f,i,l,r,q){var o=f.attr("style")||"";if(f.attr("width"))o="width:"+f.attr("width")+"px;"+o;if(f.attr("height"))o="height:"+f.attr("height")+"px;"+o;f={"class":i,src:t.Config.base+"assets/spacer.gif",_ke_realelement:encodeURIComponent(q||f._4e_outerHtml()),_ke_real_node_type:f[0].nodeType,align:f.attr("align")||"",style:o};if(l)f._ke_real_element_type=l;if(r)f._ke_resizable=r;return new p("<img/>",f,this.document)},restoreRealElement:function(f){if(f.attr("_ke_real_node_type")!=
u.NODE_ELEMENT)return null;f=decodeURIComponent(f.attr("_ke_realelement"));var i=new p("<div>",null,this.document);i.html(f);return i._4e_first(function(l){return l[0].nodeType==u.NODE_ELEMENT})._4e_remove()}})});
KISSY.Editor.add("flash",function(x){function t(g){g=g.attributes;return g.type=="application/x-shockwave-flash"||r.test(g.src||"")}function B(g){return g.indexOf(o)!=-1}var p=KISSY.Editor,u=KISSY,A=u.DOM,m=u.Event,w=p.ContextMenu,j=u.Node,f=p.NODE,i=p.TripleButton,l=p.SimpleOverlay,r=/\.swf(?:$|\?)/i,q=x.htmlDataProcessor,o="niftyplayer.swf",v=p.Utils.getFlashUrl,a=q&&q.dataFilter,d=["img.ke_flash"];a&&a.addRules({elements:{object:function(g){var h=g.attributes,c="ke_flash",k="flash";if(!(h.classid&&
String(h.classid).toLowerCase())){for(h=0;h<g.children.length;h++)if(g.children[h].name=="embed"){if(!t(g.children[h]))return null;if(B(g.children[h].attributes.src)){c="ke_music";k="music"}return q.createFakeParserElement(g,c,k,true)}return null}for(h=0;h<g.children.length;h++){var b=g.children[h];if(b.name=="param"&&b.attributes.name=="movie")if(B(b.attributes.value)){c="ke_music";k="music";break}}return q.createFakeParserElement(g,c,k,true)},embed:function(g){if(!t(g))return null;var h="ke_flash",
c="flash";if(B(g.attributes.src)){h="ke_music";c="music"}return q.createFakeParserElement(g,h,c,true)}}},5);p.Flash||function(){function g(c){this.editor=c;c._toolbars=c._toolbars||{};c._toolbars.flash=this;this._init()}u.augment(g,{_init:function(){var c=this.editor,k={};this.el=new i({container:c.toolBarDiv,contentCls:"ke-toolbar-flash",title:"Flash"});this.el.on("click",this._showConfig,this);m.on(c.document,"dblclick",this._dbclick,this);for(var b in h)(function(e){k[e]=function(){c.fire("save");
h[e](c);c.fire("save")}})(b);w.register(c.document,{rules:d,width:"120px",funcs:k});p.Utils.lazyRun(this,"_prepareShow","_realShow");c.on("selectionChange",this._selectionChange,this)},_selectionChange:function(c){c=c.path;var k=c.elements;if(c&&k)if(c=c.lastElement)(c=c._4e_ascendant(function(b){return b._4e_name()==="img"&&!!b.hasClass("ke_flash")},true))?this._showTip(c):this._hideTip()},_showTip:function(c){this._prepareTip(c)},_hideTip:function(){g.tipwin&&g.tipwin.hide()},_prepareTip:function(){g.tip&&
g.tip()},_realTip:function(c){var k=this.editor,b=c._4e_getOffset(document);b.top+=c.height()+5;g.tipwin.show(b);this.selectedFlash=c;c=k.restoreRealElement(this.selectedFlash);g.tipwin.flash=this;g.tipurl.html(v(c));g.tipurl.attr("href",v(c))},_dbclick:function(c){var k=new j(c.target);if(k._4e_name()==="img"&&k.hasClass("ke_flash")){this.selectedFlash=k;this._showConfig();c.halt()}},_prepareShow:function(){var c=this;c.d=new l({title:"\u7f16\u8f91flash",width:"350px",mask:true});c.d.on("hide",function(){c.selectedFlash=
null});c.d.body.html("<div><p><label>\u5730\u5740\uff1a <input class='ke-flash-url' style='width:280px' /></label></p><p style='margin:5px 0'><label>\u5bbd\u5ea6\uff1a <input class='ke-flash-width' style='width:110px' /></label>&nbsp;&nbsp;<label>\u9ad8\u5ea6\uff1a<input class='ke-flash-height' style='width:110px' /></label></p>");c.d.foot.html("<button class='ke-flash-ok'>\u786e\u5b9a</button> <button class='ke-flash-cancel'>\u53d6\u6d88</button></div>");c._initD()},_realShow:function(){this.d.show()},
_showConfig:function(){var c=this.editor,k=this.selectedFlash;this._prepareShow();if(k){c=c.restoreRealElement(k);c.attr("width")&&this.dWidth.val(parseInt(c.attr("width")));c.attr("height")&&this.dHeight.val(parseInt(c.attr("height")));if(c._4e_name()=="object"){c=c[0].childNodes;for(k=0;k<c.length;k++)if(c[k].nodeType==f.NODE_ELEMENT)if((A.attr(c[k],"name")||"").toLowerCase()=="movie")this.dUrl.val(A.attr(c[k],"value"));else if(A._4e_name(c[k])=="embed")this.dUrl.val(A.attr(c[k],"src"));else A._4e_name(c[k])==
"object"&&this.dUrl.val(A.attr(c[k],"data"))}else c._4e_name()=="embed"&&this.dUrl.val(c.attr("src"))}else{this.dUrl.val("");this.dWidth.val("");this.dHeight.val("")}},_initD:function(){var c=this,k=c.d;c.dHeight=k.el.one(".ke-flash-height");c.dWidth=k.el.one(".ke-flash-width");c.dUrl=k.el.one(".ke-flash-url");var b=k.el.one(".ke-flash-ok");k=k.el.one(".ke-flash-cancel");b.on("click",c._gen,c);k.on("click",function(){c.d.hide()})},_gen:function(){var c=this.editor,k=this.dUrl.val();if(k){k="<object "+
(parseInt(this.dWidth.val())?" width='"+parseInt(this.dWidth.val())+"' ":" ")+(parseInt(this.dHeight.val())?" height='"+parseInt(this.dHeight.val())+"' ":" ")+' classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"  codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,0,0"><param name="quality" value="high" /><param name="movie" value="'+k+'" /><embed '+(parseInt(this.dWidth.val())?" width='"+parseInt(this.dWidth.val())+"' ":" ")+(parseInt(this.dHeight.val())?" height='"+
parseInt(this.dHeight.val())+"' ":" ")+'pluginspage="http://www.macromedia.com/go/getflashplayer" quality="high"  src="'+k+'"  type="application/x-shockwave-flash"/></object>';var b=new j(k,null,c.document);k=c.createFakeElement?c.createFakeElement(b,"ke_flash","flash",true,k):b;c.insertElement(k);this.selectedFlash&&c.getSelection().selectElement(k);this.d.hide()}}});p.Utils.lazyRun(g.prototype,"_prepareTip","_realTip");p.Flash=g;g.tip=function(){var c=this,k=new j('<div class="ke-bubbleview-bubble" onmousedown="return false;">Flash \u7f51\u5740\uff1a  <a class="ke-bubbleview-url" target="_blank" href="#"></a> -     <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -     <span class="ke-bubbleview-link ke-bubbleview-remove">\u5220\u9664</span></div>'),
b=k.one(".ke-bubbleview-change"),e=k.one(".ke-bubbleview-remove");k._4e_unselectable();c.tipwin=new l({el:k,focusMgr:false});document.body.appendChild(k[0]);c.tipurl=k.one(".ke-bubbleview-url");c.tipwin.on("hide",function(){var n=c.tipwin.flash;n&&(!n.d||!n.d.get("visible"))&&(n.selectedFlash=null)});m.on(document,"click",function(){c.tipwin.hide()});b.on("click",function(n){c.tipwin.flash._showConfig();n.halt()});e.on("click",function(n){var z=c.tipwin.flash;z.selectedFlash._4e_remove();z.editor.notifySelectionChange();
z.selectedFlash=null;n.halt()});c.tip=null};var h={"\u7f16\u8f91Flash":function(c){var k=c.getSelection();if(k=(k=k&&k.getStartElement())&&k._4e_ascendant("img",true))if(k.hasClass("ke_flash")){c=c._toolbars.flash;c.selectedFlash=k;c._showConfig()}}}}();x.addPlugin(function(){new p.Flash(x);var g=A._4e_getWin(x.document);m.on(g,"scroll",function(){p.Flash.tipwin&&p.Flash.tipwin.hide()})})});
KISSY.Editor.add("font",function(x){var t=KISSY.Editor,B=KISSY,p=t.Style,u=t.TripleButton,A=x.cfg.pluginConfig["font-size"]||["8px","10px","12px","14px","18px","24px","36px","48px","60px","72px","84px","96px","108px"],m={},w=[],j={element:"span",styles:{"font-size":"#(size)"},overrides:[{element:"font",attributes:{size:null}}]},f=x.cfg.pluginConfig["font-family"]||["\u5b8b\u4f53","\u9ed1\u4f53","\u96b6\u4e66","\u6977\u4f53_GB2312","\u5fae\u8f6f\u96c5\u9ed1","Georgia","Times New Roman","Impact","Courier New",
"Arial","Verdana","Tahoma"],i={},l=[],r={element:"span",styles:{"font-family":"#(family)"},overrides:[{element:"font",attributes:{face:null}}]},q;x.cfg.pluginConfig["font-size"]=A;x.cfg.pluginConfig["font-family"]=f;for(q=0;q<A.length;q++){var o=A[q];m[o]=new p(j,{size:o});w.push({name:o,value:o})}for(q=0;q<f.length;q++){A=f[q];i[A]=new p(r,{family:A});l.push({name:A,value:A,attrs:{style:"font-family:"+A}})}t.Font||function(){function v(d){v.superclass.constructor.call(this,d);this._init()}function a(d){a.superclass.constructor.call(this,
d);this._init()}v.ATTRS={title:{},html:{},styles:{},editor:{}};B.extend(v,B.Base,{_init:function(){var d=this.get("editor"),g=d.toolBarDiv;this.get("html");this.el=new t.Select({container:g,doc:d.document,width:this.get("width"),popUpWidth:this.get("popUpWidth"),title:this.get("title"),items:this.get("html")});this.el.on("click",this._vChange,this);d.on("selectionChange",this._selectionChange,this)},_vChange:function(d){var g=this.get("editor"),h=d.newVal;d=d.preVal;var c=this.get("styles");g.focus();
g.fire("save");if(h==d){c[h].remove(g.document);this.el.set("value","")}else c[h].apply(g.document);g.fire("save")},_selectionChange:function(d){this.get("editor");d=d.path.elements;for(var g=this.get("styles"),h=0,c;h<d.length;h++){c=d[h];for(var k in g)if(g[k].checkElementRemovable(c,true)){this.el.set("value",k);return}}this.el.reset("value")}});a.ATTRS={editor:{},text:{},contentCls:{},title:{},style:{}};B.extend(a,B.Base,{_init:function(){var d=this.get("editor"),g=this.get("text");this.get("style");
var h=this.get("title");this.el=new u({text:g,title:h,contentCls:this.get("contentCls"),container:d.toolBarDiv});this.el.on("offClick",this._on,this);this.el.on("onClick",this._off,this);d.on("selectionChange",this._selectionChange,this)},_on:function(){var d=this.get("editor");this.get("text");var g=this.get("style");this.get("title");d.fire("save");g.apply(d.document);d.fire("save");d.notifySelectionChange();d.focus()},_off:function(){var d=this.get("editor");this.get("text");var g=this.get("style");
this.get("title");d.fire("save");g.remove(d.document);d.fire("save");d.notifySelectionChange();d.focus()},_selectionChange:function(d){this.get("editor");this.get("text");var g=this.get("style");this.get("title");g.checkActive(d.path)?this.el.set("state",u.ON):this.el.set("state",u.OFF)}});v.SingleFont=a;t.Font=v}();x.addPlugin(function(){new t.Font({editor:x,title:"\u5927\u5c0f",width:"30px",popUpWidth:"55px",styles:m,html:w});new t.Font({editor:x,title:"\u5b57\u4f53",width:"110px",popUpWidth:"130px",
styles:i,html:l});new t.Font.SingleFont({contentCls:"ke-toolbar-bold",title:"\u7c97\u4f53 ",editor:x,style:new p({element:"strong",overrides:[{element:"b"},{element:"span",attributes:{style:"font-weight: bold;"}}]})});new t.Font.SingleFont({contentCls:"ke-toolbar-italic",title:"\u659c\u4f53 ",editor:x,style:new p({element:"em",overrides:[{element:"i"},{element:"span",attributes:{style:"font-style: italic;"}}]})});new t.Font.SingleFont({contentCls:"ke-toolbar-underline",title:"\u4e0b\u5212\u7ebf ",
editor:x,style:new p({element:"u",overrides:[{element:"span",attributes:{style:"text-decoration: underline;"}}]})});new t.Font.SingleFont({contentCls:"ke-toolbar-strikeThrough",title:"\u5220\u9664\u7ebf ",editor:x,style:new p({element:"del",overrides:[{element:"span",attributes:{style:"text-decoration: line-through;"}},{element:"s"}]})})})});
KISSY.Editor.add("format",function(x){var t=KISSY.Editor,B=KISSY,p=[],u={"\u666e\u901a\u6587\u672c":"p","\u6807\u98981":"h1","\u6807\u98982":"h2","\u6807\u98983":"h3","\u6807\u98984":"h4","\u6807\u98985":"h5","\u6807\u98986":"h6"},A={p:"1em",h1:"2em",h2:"1.5em",h3:"1.17em",h4:"1em",h5:"0.83em",h6:"0.67em"},m={},w=t.Style;for(var j in u)if(u[j]){m[u[j]]=new w({element:u[j]});p.push({name:j,value:u[j],attrs:{style:"font-size:"+A[u[j]]}})}t.Format||function(){function f(i){f.superclass.constructor.call(this,
i);this._init()}f.ATTRS={editor:{}};B.extend(f,B.Base,{_init:function(){var i=this.get("editor");this.el=new t.Select({container:i.toolBarDiv,value:"",doc:i.document,width:this.get("width"),popUpWidth:this.get("popUpWidth"),title:this.get("title"),items:this.get("html")});this.el.on("click",this._vChange,this);i.on("selectionChange",this._selectionChange,this)},_vChange:function(i){var l=this.get("editor"),r=i.newVal;i=i.preVal;l.fire("save");if(r!=i)m[r].apply(l.document);else{m.p.apply(l.document);
this.el.set("value","p")}l.fire("save")},_selectionChange:function(i){this.get("editor");i=i.path;for(var l in m)if(m[l].checkActive(i)){this.el.set("value",l);return}this.el.reset("value")}});t.Format=f}();x.addPlugin(function(){new t.Format({editor:x,html:p,title:"\u6807\u9898",width:"100px",popUpWidth:"120px"})})});
KISSY.Editor.add("htmlparser-basicwriter",function(){function x(){this._={output:[]}}var t=KISSY.Editor,B=t.Utils;if(!t.HtmlParser.BasicWriter){KISSY.augment(x,{openTag:function(p){this._.output.push("<",p)},openTagClose:function(p,u){u?this._.output.push(" />"):this._.output.push(">")},attribute:function(p,u){if(typeof u=="string")u=B.htmlEncodeAttr(u);this._.output.push(" ",p,'="',u,'"')},closeTag:function(p){this._.output.push("</",p,">")},text:function(p){this._.output.push(p)},comment:function(p){this._.output.push("<!--",
p,"--\>")},write:function(p){this._.output.push(p)},reset:function(){this._.output=[];this._.indent=false},getHtml:function(p){var u=this._.output.join("");p&&this.reset();return u}});t.HtmlParser.BasicWriter=x}});
KISSY.Editor.add("htmlparser-comment",function(){function x(p){this.value=p;this._={isBlockLike:false}}var t=KISSY.Editor,B=t.NODE;if(!t.HtmlParser.Comment){t.HtmlParser.Comment=x;x.prototype={constructor:x,type:B.NODE_COMMENT,writeHtml:function(p,u){var A=this.value;if(u){if(!(A=u.onComment(A,this)))return;if(typeof A!="string"){A.parent=this.parent;A.writeHtml(p,u);return}}p.comment(A)}}}});
KISSY.Editor.add("htmlparser-element",function(){function x(u,A){this.name=u;this.attributes=A||(A={});this.children=[];var m=A._ke_real_element_type||u;A=t.XHTML_DTD;m=!!(A.$nonBodyContent[m]||A.$block[m]||A.$listItem[m]||A.$tableContent[m]||A.$nonEditable[m]||m=="br");var w=!!A.$empty[u];this.isEmpty=w;this.isUnknown=!A[u];this._={isBlockLike:m,hasInlineStarted:w||!m}}var t=KISSY.Editor;if(!t.HtmlParser.Element){var B=t.NODE,p=function(u,A){u=u[0];A=A[0];return u<A?-1:u>A?1:0};KISSY.augment(x,{type:B.NODE_ELEMENT,
add:t.HtmlParser.Fragment.prototype.add,clone:function(){return new x(this.name,this.attributes)},writeHtml:function(u,A){var m=this.attributes,w=this,j=w.name,f,i,l,r;w.filterChildren=function(){if(!r){var v=new t.HtmlParser.BasicWriter;t.HtmlParser.Fragment.prototype.writeChildrenHtml.call(w,v,A);w.children=(new t.HtmlParser.Fragment.FromHtml(v.getHtml())).children;r=1}};if(A){for(;;){if(!(j=A.onElementName(j)))return;w.name=j;if(!(w=A.onElement(w)))return;w.parent=this.parent;if(w.name==j)break;
if(w.type!=B.NODE_ELEMENT){w.writeHtml(u,A);return}j=w.name;if(!j){this.writeChildrenHtml.call(w,u,r?null:A);return}}m=w.attributes}u.openTag(j,m);for(var q=[],o=0;o<2;o++)for(f in m){i=f;l=m[f];if(o==1)q.push([f,l]);else if(A){for(;;)if(i=A.onAttributeName(f))if(i!=f){delete m[f];f=i}else break;else{delete m[f];break}if(i)if((l=A.onAttribute(w,i,l))===false)delete m[i];else m[i]=l}}u.sortAttributes&&q.sort(p);m=q.length;for(o=0;o<m;o++){f=q[o];u.attribute(f[0],f[1])}u.openTagClose(j,w.isEmpty);if(!w.isEmpty){this.writeChildrenHtml.call(w,
u,r?null:A);u.closeTag(j)}},writeChildrenHtml:function(){t.HtmlParser.Fragment.prototype.writeChildrenHtml.apply(this,arguments)}});t.HtmlParser.Element=x}});
KISSY.Editor.add("htmlparser-filter",function(){function x(j){this._={elementNames:[],attributeNames:[],elements:{$length:0},attributes:{$length:0}};j&&this.addRules(j,10)}function t(j,f){for(var i=0;j&&i<f.length;i++){var l=f[i];j=j.replace(l[0],l[1])}return j}function B(j,f,i){if(typeof f=="function")f=[f];var l,r;r=j.length;var q=f&&f.length;if(q){for(l=0;l<r&&j[l].pri<i;l++);for(r=q-1;r>=0;r--)if(q=f[r]){q.pri=i;j.splice(l,0,q)}}}function p(j,f,i){if(f)for(var l in f){var r=j[l];j[l]=u(r,f[l],
i);r||j.$length++}}function u(j,f,i){if(f){f.pri=i;if(j){if(j.splice)B(j,f,i);else{j=j.pri>i?[f,j]:[j,f];j.filter=A}return j}else return f.filter=f}}function A(j){for(var f=j.type||j instanceof m.HtmlParser.Fragment,i=0;i<this.length;i++){if(f)var l=j.type,r=j.name;var q=this[i].apply(window,arguments);if(q===false)return q;if(f){if(q&&(q.name!=r||q.type!=l))return q}else if(typeof q!="string")return q;q!=undefined&&(j=q)}return j}var m=KISSY.Editor,w=m.NODE;if(!m.HtmlParser.Filter){KISSY.augment(x,
{addRules:function(j,f){if(typeof f!="number")f=10;B(this._.elementNames,j.elementNames,f);B(this._.attributeNames,j.attributeNames,f);p(this._.elements,j.elements,f);p(this._.attributes,j.attributes,f);this._.text=u(this._.text,j.text,f)||this._.text;this._.comment=u(this._.comment,j.comment,f)||this._.comment;this._.root=u(this._.root,j.root,f)||this._.root},onElementName:function(j){return t(j,this._.elementNames)},onAttributeName:function(j){return t(j,this._.attributeNames)},onText:function(j){var f=
this._.text;return f?f.filter(j):j},onComment:function(j,f){var i=this._.comment;return i?i.filter(j,f):j},onFragment:function(j){var f=this._.root;return f?f.filter(j):j},onElement:function(j){for(var f=[this._.elements["^"],this._.elements[j.name],this._.elements.$],i,l=0;l<3;l++)if(i=f[l]){i=i.filter(j,this);if(i===false)return null;if(i&&i!=j)return this.onNode(i);if(j.parent&&!j.name)break}return j},onNode:function(j){var f=j.type;return f==w.NODE_ELEMENT?this.onElement(j):f==w.NODE_TEXT?new m.HtmlParser.Text(this.onText(j.value)):
null},onAttribute:function(j,f,i){if(f=this._.attributes[f]){j=f.filter(i,j,this);if(j===false)return false;if(typeof j!="undefined")return j}return i}});m.HtmlParser.Filter=x}});
KISSY.Editor.add("htmlparser-fragment",function(){function x(){this.children=[];this.parent=null;this._={isBlockLike:true,hasInlineStarted:false}}var t=KISSY.Editor;if(!t.HtmlParser.Fragment){var B={colgroup:1,dd:1,dt:1,li:1,option:1,p:1,td:1,tfoot:1,th:1,thead:1,tr:1},p=KISSY,u=t.Utils,A=t.NODE,m=t.XHTML_DTD,w=u.mix({table:1,ul:1,ol:1,dl:1},m.table,m.ul,m.ol,m.dl),j=m.$list,f=m.$listItem;x.FromHtml=function(i,l){function r(e){var n;if(d.length>0)for(var z=0;z<d.length;z++){var s=d[z],D=s.name,H=
m[D],y=h.name&&m[h.name];if((!y||y[D])&&(!e||!H||H[e]||!m[e])){if(!n){q();n=1}s=s.clone();s.parent=h;h=s;d.splice(z,1);z--}}}function q(){for(;g.length;)h.add(g.shift())}function o(e,n,z){n=n||h||a;if(l&&!n.type){var s,D;if((s=e.attributes&&(D=e.attributes._ke_real_element_type)?D:e.name)&&!(s in m.$body)&&!(s in m.$nonBodyContent)){s=h;h=n;v.onTagOpen(l,{});n=h;if(z)h=s}}if(e._.isBlockLike&&e.name!="pre"){z=e.children.length;if((s=e.children[z-1])&&s.type==A.NODE_TEXT)if(D=u.rtrim(s.value))s.value=
D;else e.children.length=z-1}n.add(e);if(e.returnPoint){h=e.returnPoint;delete e.returnPoint}}var v=new t.HtmlParser,a=new x,d=[],g=[],h=a,c=false,k;v.onTagOpen=function(e,n,z){var s=new t.HtmlParser.Element(e,n);if(s.isUnknown&&z)s.isEmpty=true;if(m.$removeEmpty[e])d.push(s);else{if(e=="pre")c=true;else if(e=="br"&&c){h.add(new t.HtmlParser.Text("\n"));return}if(e=="br")g.push(s);else{var D=h.name,H=D&&(m[D]||(h._.isBlockLike?m.div:m.span));if(H&&!s.isUnknown&&!h.isUnknown&&!H[e]){H=false;var y;
if(e in j&&D in j){D=h.children;(D=D[D.length-1])&&D.name in f||o(D=new t.HtmlParser.Element("li"),h);k=h;y=D}else if(e==D)o(h,h.parent);else{if(w[D])k||(k=h);else{o(h,h.parent,true);B[D]||d.unshift(h)}H=true}h=y?y:h.returnPoint||h.parent;if(H){v.onTagOpen.apply(this,arguments);return}}r(e);q();s.parent=h;s.returnPoint=k;k=0;if(s.isEmpty)o(s);else h=s}}};v.onTagClose=function(e){for(var n=d.length-1;n>=0;n--)if(e==d[n].name){d.splice(n,1);return}for(var z=[],s=[],D=h;D.type&&D.name!=e;){D._.isBlockLike||
s.unshift(D);z.push(D);D=D.parent}if(D.type){for(n=0;n<z.length;n++){var H=z[n];o(H,H.parent)}h=D;if(h.name=="pre")c=false;D._.isBlockLike&&q();o(D,D.parent);if(D==h)h=h.parent;d=d.concat(s)}if(e=="body")l=false};v.onText=function(e){if(!h._.hasInlineStarted&&!c){e=u.ltrim(e);if(e.length===0)return}q();r();if(l&&(!h.type||h.name=="body")&&u.trim(e))this.onTagOpen(l,{});c||(e=e.replace(/[\t\r\n ]{2,}|[\t\r\n]/g," "));h.add(new t.HtmlParser.Text(e))};v.onCDATA=function(){};v.onComment=function(e){h.add(new t.HtmlParser.Comment(e))};
v.parse(i);for(q();h.type;){i=h.parent;var b=h;if(l&&(!i.type||i.name=="body")&&!m.$body[b.name]){h=i;v.onTagOpen(l,{});i=h}i.add(b);h=i}return a};p.augment(x,{add:function(i){var l=this.children.length;if(l=l>0&&this.children[l-1]||null){if(i._.isBlockLike&&l.type==A.NODE_TEXT){l.value=u.rtrim(l.value);if(l.value.length===0){this.children.pop();this.add(i);return}}l.next=i}i.previous=l;i.parent=this;this.children.push(i);this._.hasInlineStarted=i.type==A.NODE_TEXT||i.type==A.NODE_ELEMENT&&!i._.isBlockLike},
writeHtml:function(i,l){var r;this.filterChildren=function(){var q=new t.HtmlParser.BasicWriter;this.writeChildrenHtml.call(this,q,l,true);q=q.getHtml();this.children=(new x.FromHtml(q)).children;r=1};!this.name&&l&&l.onFragment(this);this.writeChildrenHtml(i,r?null:l)},writeChildrenHtml:function(i,l){for(var r=0;r<this.children.length;r++)this.children[r].writeHtml(i,l)}});t.HtmlParser.Fragment=x}});
KISSY.Editor.add("htmlparser",function(){function x(){this._={htmlPartsRegex:new RegExp("<(?:(?:\\/([^>]+)>)|(?:!--([\\S|\\s]*?)--\>)|(?:([^\\s>]+)\\s*((?:(?:[^\"'>]+)|(?:\"[^\"]*\")|(?:'[^']*'))*)\\/?>))","g")}}var t=KISSY.Editor;if(!t.HtmlParser){var B=/([\w\-:.]+)(?:(?:\s*=\s*(?:(?:"([^"]*)")|(?:'([^']*)')|([^\s>]+)))|(?=\s|$))/g,p={checked:1,compact:1,declare:1,defer:1,disabled:1,ismap:1,multiple:1,nohref:1,noresize:1,noshade:1,nowrap:1,readonly:1,selected:1},u=t.XHTML_DTD;KISSY.augment(x,{onTagOpen:function(){},
onTagClose:function(){},onText:function(){},onCDATA:function(){},onComment:function(){},parse:function(A){for(var m,w,j=0,f;m=this._.htmlPartsRegex.exec(A);){w=m.index;if(w>j){j=A.substring(j,w);f?f.push(j):this.onText(j)}j=this._.htmlPartsRegex.lastIndex;if(w=m[1]){w=w.toLowerCase();if(f&&u.$cdata[w]){this.onCDATA(f.join(""));f=null}if(!f){this.onTagClose(w);continue}}if(f)f.push(m[0]);else if(w=m[3]){w=w.toLowerCase();var i={},l;m=m[4];var r=!!(m&&m.charAt(m.length-1)=="/");if(m)for(;l=B.exec(m);){var q=
l[1].toLowerCase();l=l[2]||l[3]||l[4]||"";i[q]=!l&&p[q]?q:l}this.onTagOpen(w,i,r);if(!f&&u.$cdata[w])f=[]}else if(w=m[2])this.onComment(w)}A.length>j&&this.onText(A.substring(j,A.length))}});t.HtmlParser=x}});
KISSY.Editor.add("htmlparser-htmlwriter",function(){function x(){x.superclass.constructor.call(this);this.indentationChars="\t";this.selfClosingEnd=" />";this.lineBreakChars="\n";this.forceSimpleAmpersand=false;this.sortAttributes=true;this._.indent=false;this._.indentation="";this._.rules={};var p=t.XHTML_DTD;for(var u in B.mix({},p.$nonBodyContent,p.$block,p.$listItem,p.$tableContent))this.setRules(u,{indent:true,breakBeforeOpen:true,breakAfterOpen:true,breakBeforeClose:!p[u]["#"],breakAfterClose:true});
this.setRules("br",{breakAfterOpen:true});this.setRules("title",{indent:false,breakAfterOpen:false});this.setRules("style",{indent:false,breakBeforeClose:true});this.setRules("pre",{indent:false})}var t=KISSY.Editor,B=t.Utils;if(!t.HtmlParser.HtmlWriter){KISSY.extend(x,t.HtmlParser.BasicWriter,{openTag:function(p){var u=this._.rules[p];if(this._.indent)this.indentation();else if(u&&u.breakBeforeOpen){this.lineBreak();this.indentation()}this._.output.push("<",p)},openTagClose:function(p,u){p=this._.rules[p];
if(u)this._.output.push(this.selfClosingEnd);else{this._.output.push(">");if(p&&p.indent)this._.indentation+=this.indentationChars}p&&p.breakAfterOpen&&this.lineBreak()},attribute:function(p,u){if(typeof u=="string"){this.forceSimpleAmpersand&&(u=u.replace(/&amp;/g,"&"));u=B.htmlEncodeAttr(u)}this._.output.push(" ",p,'="',u,'"')},closeTag:function(p){var u=this._.rules[p];if(u&&u.indent)this._.indentation=this._.indentation.substr(this.indentationChars.length);if(this._.indent)this.indentation();
else if(u&&u.breakBeforeClose){this.lineBreak();this.indentation()}this._.output.push("</",p,">");u&&u.breakAfterClose&&this.lineBreak()},text:function(p){if(this._.indent){this.indentation();p=B.ltrim(p)}this._.output.push(p)},comment:function(p){this._.indent&&this.indentation();this._.output.push("<!--",p,"--\>")},lineBreak:function(){this._.output.length>0&&this._.output.push(this.lineBreakChars);this._.indent=true},indentation:function(){this._.output.push(this._.indentation);this._.indent=false},
setRules:function(p,u){var A=this._.rules[p];if(A)B.mix(A,u);else this._.rules[p]=u}});t.HtmlParser.HtmlWriter=x}});KISSY.Editor.add("htmlparser-text",function(){function x(B){this.value=B;this._={isBlockLike:false}}var t=KISSY.Editor;if(!t.HtmlParser.Text){KISSY.augment(x,{type:t.NODE.NODE_TEXT,writeHtml:function(B,p){var u=this.value;p&&!(u=p.onText(u,this))||B.text(u)}});t.HtmlParser.Text=x}});
KISSY.Editor.add("htmldataprocessor",function(x){function t(c){if(/mso-list\s*:\s*Ignore/i.test(c.attributes&&c.attributes.style))return true;return m}function B(c,k){var b=new w.HtmlParser.Element("ke:listbullet"),e;if(c)if(c[2]){c=isNaN(c[1])?/^[a-z]+$/.test(c[1])?"lower-alpha":/^[A-Z]+$/.test(c[1])?"upper-alpha":"decimal":"decimal";e="ol"}else{c=/[l\u00B7\u2002]/.test(c[1])?"disc":/[\u006F\u00D8]/.test(c[1])?"circle":/[\u006E\u25C6]/.test(c[1])?"square":"disc";e="ul"}else{c="decimal";e="ol"}b.attributes=
{"ke:listtype":e,style:"list-style-type:"+c+";"};b.add(new w.HtmlParser.Text(k));return b}function p(c){var k=c.attributes,b;if((b=c.removeAnyChildWithName("ke:listbullet"))&&b.length&&(b=b[0])){c.name="ke:li";if(k.style)k.style=u([["text-indent"],["line-height"],[/^margin(:?-left)?$/,null,function(e){e=e.split(" ");e=e[3]||e[1]||e[0];e=parseInt(e,10);if(!v&&a&&e>a)v=e-a;k["ke:margin"]=a=e}]],m)(k.style,c)||"";b=b.attributes;c.addStyle(b.style);j.mix(k,b);return true}return false}function u(c,k){return function(b,
e){var n=[];b.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(z,s,D){s=s.toLowerCase();s=="font-family"&&(D=D.replace(/["']/g,""));for(var H,y,C,I=0;I<c.length;I++)if(c[I]){z=c[I][0];H=c[I][1];y=c[I][2];C=c[I][3];if(s.match(z)&&(!H||D.match(H))){s=C||s;k&&(y=y||D);if(typeof y=="function")y=y(D,e,s);if(y&&y.push){s=y[0];y=y[1]}typeof y=="string"&&n.push([s,y]);return}}!k&&n.push([s,D])});for(b=0;b<n.length;b++)n[b]=n[b].join(":");return n.length?n.join(";")+";":false}}
function A(c){c=c.children;for(var k,b,e,n,z,s,D,H=0;H<c.length;H++){k=c[H];if("ke:li"==k.name){k.name="li";b=k.attributes;e=k.attributes["ke:listtype"];n=parseInt(b["ke:indent"],10)||v&&Math.ceil(b["ke:margin"]/v)||1;b.style&&(b.style=u([["list-style-type",e=="ol"?"decimal":"disc"]],m)(b.style)||"");if(s){if(n>D){s=new w.HtmlParser.Element(e);s.add(k);z.add(s)}else{if(n<D){z=D-n;for(var y;z--&&(y=s.parent);)s=y.parent}s.add(k)}c.splice(H--,1)}else{s=new w.HtmlParser.Element(e);s.add(k);c[H]=s}z=
k;D=n}else s=null}v=0}var m=m,w=KISSY.Editor,j=KISSY,f=j.UA,i=w.HtmlParser,l=new i.Filter,r=new i.Filter,q=w.XHTML_DTD;if(!x.htmlDataProcessor){(function(){var c=w.HtmlParser.Fragment.prototype,k=w.HtmlParser.Element.prototype;c.onlyChild=k.onlyChild=function(){var b=this.children;return b.length==1&&b[0]||null};k.removeAnyChildWithName=function(b){for(var e=this.children,n=[],z,s=0;s<e.length;s++){z=e[s];if(z.name){if(z.name==b){n.push(z);e.splice(s--,1)}n=n.concat(z.removeAnyChildWithName(b))}}return n};
k.getAncestor=function(b){for(var e=this.parent;e&&!(e.name&&e.name.match(b));)e=e.parent;return e};c.firstChild=k.firstChild=function(b){for(var e,n=0;n<this.children.length;n++){e=this.children[n];if(b(e))return e;else if(e.name)if(e=e.firstChild(b))return e}return null};k.addStyle=function(b,e,n){var z="";if(typeof e=="string")z+=b+":"+e+";";else{if(typeof b=="object")for(var s in b){if(b.hasOwnProperty(s))z+=s+":"+b[s]+";"}else z+=b;n=e}if(!this.attributes)this.attributes={};b=this.attributes.style||
"";b=(n?[z,b]:[b,z]).join(";");this.attributes.style=b.replace(/^;|;(?=;)/,"")};q.parentOf=function(b){var e={};for(var n in this)if(n.indexOf("$")==-1&&this[n][b])e[n]=1;return e}})();var o=u([[/mso/i],[/font-size/i,"",function(c){for(var k=x.cfg.pluginConfig["font-size"],b=0;b<k.length;b++)if(c.toLowerCase()==k[b])return c;return false},"font-size"],[/font-family/i,"",function(c){for(var k=x.cfg.pluginConfig["font-family"],b=0;b<k.length;b++)if(c.toLowerCase()==k[b].toLowerCase())return c;return false},
"font-family"],[/line-height/i],[/display/i,/none/i]],m),v,a=0,d=q.parentOf("ol"),g={elementNames:[[/^script$/i,""],[/^iframe$/i,""],[/^style$/i,""],[/^link$/i,""],[/^meta$/i,""],[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],root:function(c){c.filterChildren();A(c)},elements:{font:function(c){delete c.name},p:function(c){c.filterChildren();if(p(c))return m},$:function(c){var k=c.name||"";k.indexOf(":")!=-1&&k.indexOf("ke")==-1&&delete c.name;var b=c.attributes.style;if(k=="span"&&(!b||!o(b)))delete c.name;
if(k in d){c.filterChildren();A(c)}},table:function(c){var k=c.attributes.border;if(!k||k=="0")c.attributes["class"]="ke_show_border"},span:function(c){if(!f.gecko&&t(c.parent))return false;if(!f.gecko&&t(c)){c=(c=c.firstChild(function(b){return b.value||b.name=="img"}))&&(c.value||"l.");var k=c.match(/^([^\s]+?)([.)]?)$/);return B(k,c)}}},comment:!f.ie?function(c,k){var b=c.match(/<img.*?>/);if(c=c.match(/^\[if !supportLists\]([\s\S]*?)\[endif\]$/)){b=(k=c[1]||b&&"l.")&&k.match(/>([^\s]+?)([.)]?)</);
return B(b,k)}if(f.gecko&&b){b=w.HtmlParser.Fragment.FromHtml(b[0]).children[0];(k=(k=(k=k.previous)&&k.value.match(/<v:imagedata[^>]*o:href=['"](.*?)['"]/))&&k[1])&&(b.attributes.src=k);return b}return false}:function(){return false},attributes:{"class":function(c){if(/^ke_/.test(c))return c;return false},style:function(c){c=o(c);if(!c)return false;return c}},attributeNames:[[/^on/,"ck_on"],[/^lang$/,""]]},h={elementNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],elements:{embed:function(c){var k=c.parent;
if(k&&k.name=="object"){var b=k.attributes.width;k=k.attributes.height;b&&(c.attributes.width=b);k&&(c.attributes.height=k)}},param:function(c){c.children=[];c.isEmpty=true;return c},a:function(c){if(!(c.children.length||c.attributes.name))return false},span:function(c){if(!c.children.length)return false}},attributes:{style:function(c){if(!j.trim(c))return false}},attributeNames:[[/^ck_on/,"on"],[/^ke:.*$/,""]]};if(f.ie)h.attributes.style=function(c){return c.toLowerCase()};l.addRules(h);r.addRules(g);
x.htmlDataProcessor={htmlFilter:l,dataFilter:r,toHtml:function(c,k){var b=new i.HtmlWriter;i.Fragment.FromHtml(c,k).writeHtml(b,l);return b.getHtml(true)},toDataFormat:function(c,k){if(f.gecko)c=c.replace(/(<!--\[if[^<]*?\])--\>([\S\s]*?)<!--(\[endif\]--\>)/gi,"$1$2$3");var b=new i.BasicWriter;c=i.Fragment.FromHtml(c,k);b.reset();c.writeHtml(b,r);return b.getHtml(true)}}}});
KISSY.Editor.add("image",function(x){var t=KISSY.Editor,B=KISSY,p=B.Node,u=B.DOM,A=B.Event,m=t.SimpleOverlay;t.ImageInserter||function(){function w(f){w.superclass.constructor.call(this,f);this._init()}var j=t.TripleButton;w.ATTRS={editor:{}};B.extend(w,B.Base,{_init:function(){var f=this.get("editor").toolBarDiv;this.el=new j({contentCls:"ke-toolbar-image",title:"\u56fe\u50cf",container:f});this.el.on("offClick",this.show,this);t.Utils.lazyRun(this,"_prepare","_real")},_prepare:function(){var f=
this,i=f.get("editor");f.d=new m({title:"\u63d2\u5165\u56fe\u7247",mask:true,width:"350px"});var l=f.d;l.body.html("<div><p><label><span style='color:#0066CC;font-weight:bold;'>\u56fe\u7247\u7f51\u5740\uff1a</span><input class='ke-img-url' style='width:230px' value='http://'/></label></p></div>");l.foot.html("<button class='ke-img-insert'>\u63d2\u5165</button> <button class='ke-img-cancel'>\u53d6\u6d88</button>");f.content=l.el;l=f.content;var r=l.one(".ke-img-cancel"),q=l.one(".ke-img-insert");f.imgUrl=
l.one(".ke-img-url");r.on("click",function(o){f.d.hide();o.halt()});A.on(document,"click",f.hide,f);A.on(i.document,"click",f.hide,f);q.on("click",function(){f._insert()})},hide:function(f){var i=this;u._4e_ascendant(f.target,function(l){return l[0]===i.content[0]||l[0]===i.el.el[0]},true)||this.d.hide()},_real:function(){this.d.show()},_insert:function(){var f=this.get("editor"),i=this.imgUrl.val();if(i){i=new p("<img src='"+i+"'/>",null,f.document);f.insertElement(i);this.d.hide()}},show:function(){this._prepare()}});
t.ImageInserter=w}();x.addPlugin(function(){new t.ImageInserter({editor:x})})});
KISSY.Editor.add("indent",function(x){var t=KISSY.Editor,B={ol:1,ul:1},p=KISSY,u=t.Walker,A=p.DOM,m=p.Node,w=p.UA,j=t.NODE;t.Indent||function(){function f(g){this.type=g;this.indentCssProperty="margin-left";this.indentOffset=40;this.indentUnit="px"}function i(g){return g.type=CKEDITOR.NODE_ELEMENT&&g.is("li")}function l(g,h,c){var k=h.startContainer;for(g=h.endContainer;k&&k.parent()[0]!==c[0];)k=k.parent();for(;g&&g.parent()[0]!==c[0];)g=g.parent();if(k&&g){var b=k;k=[];for(var e=false;!e;){if(b[0]===
g[0])e=true;k.push(b);b=b.next()}if(!(k.length<1)){b=c._4e_parents(true);for(g=0;g<b.length;g++)if(B[b[g]._4e_name()]){c=b[g];break}b=this.type=="indent"?1:-1;g=k[0];e=k[k.length-1];k={};var n=t.ListUtils.listToArray(c,k),z=n[e._4e_getData("listarray_index")].indent;for(g=g._4e_getData("listarray_index");g<=e._4e_getData("listarray_index");g++){n[g].indent+=b;var s=n[g].parent;n[g].parent=new m(s[0].ownerDocument.createElement(s._4e_name()))}for(g=e._4e_getData("listarray_index")+1;g<n.length&&n[g].indent>
z;g++)n[g].indent+=b;e=t.ListUtils.arrayToList(n,k,null,"p",0);b=[];if(this.type=="outdent"){var D;if((D=c.parent())&&D._4e_name()=="li"){n=e.listNode.childNodes;var H;for(g=n.length-1;g>=0;g--)if((H=new m(n[g]))&&H._4e_name()=="li")b.push(H)}}if(e){A.insertBefore(e.listNode,c[0]);c._4e_remove()}if(b&&b.length)for(g=0;g<b.length;g++){for(H=c=b[g];(H=H.next())&&H._4e_name()in B;){w.ie&&!c._4e_first(function(y){return v(y)&&a(y)})&&c[0].appendChild(h.document.createTextNode("\u00a0"));c[0].appendChild(H[0])}A.insertAfter(c[0],
D[0])}for(g in k)k[g]._4e_clearMarkers(k,true)}}}function r(g,h){h=h.createIterator();h.enforceRealBlocks=true;h.enlargeBr=true;for(var c;c=h.getNextParagraph();)q.call(this,g,c)}function q(g,h){g=parseInt(h._4e_style(this.indentCssProperty),10);if(isNaN(g))g=0;g+=(this.type=="indent"?1:-1)*this.indentOffset;if(g<0)return false;g=Math.max(g,0);g=Math.ceil(g/this.indentOffset)*this.indentOffset;h.css(this.indentCssProperty,g?g+this.indentUnit:"");h[0].style.cssText===""&&h[0].removeAttribute("style");
return true}function o(g){o.superclass.constructor.call(this,g);g=this.get("editor").toolBarDiv;this.el=new d({container:g,contentCls:this.get("contentCls"),title:this.get("title")});this.indentCommand=new f(this.get("type"));this._init()}var v=u.whitespaces(true),a=u.bookmark(false,true);p.augment(f,{exec:function(g){for(var h=g.getSelection(),c=h&&h.getRanges()[0],k=c.startContainer,b=c.endContainer,e=c.getCommonAncestor();e&&!(e[0].nodeType==j.NODE_ELEMENT&&B[e._4e_name()]);)e=e.parent();if(e&&
k[0].nodeType==j.NODE_ELEMENT&&k._4e_name()in B){k=new u(c);k.evaluator=i;c.startContainer=k.next()}if(e&&b[0].nodeType==j.NODE_ELEMENT&&b._4e_name()in B){k=new u(c);k.evaluator=i;c.endContainer=k.previous()}b=h.createBookmarks(true);if(e){for(k=e._4e_first();k&&k[0]&&k._4e_name()!="li";)k=k.next();var n=c.startContainer;(k[0]==n[0]||k._4e_contains(n))&&q.call(this,g,e)||l.call(this,g,c,e)}else r.call(this,g,c);h.selectBookmarks(b)}});var d=t.TripleButton;o.ATTRS={type:{},contentCls:{},editor:{}};
p.extend(o,p.Base,{_init:function(){var g=this.get("editor"),h=this.el;h.on("offClick",this.exec,this);this.get("type")=="outdent"?g.on("selectionChange",this._selectionChange,this):h.set("state",d.OFF)},exec:function(){var g=this.get("editor"),h=this;g.fire("save");setTimeout(function(){h.indentCommand.exec(g);g.fire("save");g.notifySelectionChange()},10)},_selectionChange:function(g){this.get("editor");this.get("type");var h=g.path,c=h.blockLimit;g=this.el;if(h.contains(B))g.set("state",d.OFF);
else(h=h.block||c)&&h._4e_style(this.indentCommand.indentCssProperty)?g.set("state",d.OFF):g.set("state",d.DISABLED)}});t.Indent=o}();x.addPlugin(function(){x.addCommand("outdent",new t.Indent({editor:x,title:"\u51cf\u5c11\u7f29\u8fdb\u91cf ",contentCls:"ke-toolbar-outdent",type:"outdent"}));x.addCommand("indent",new t.Indent({editor:x,title:"\u589e\u52a0\u7f29\u8fdb\u91cf ",contentCls:"ke-toolbar-indent",type:"indent"}))})});
KISSY.Editor.add("justify",function(x){var t=KISSY.Editor,B=KISSY,p=t.TripleButton;t.Justify||function(){function u(m,w,j,f){this.editor=m;this.v=w;this.contentCls=f;this.title=j;this._init()}var A=/(-moz-|-webkit-|start|auto)/i;B.augment(u,{_init:function(){var m=this.editor;this.el=new p({contentCls:this.contentCls,title:this.title,container:m.toolBarDiv});m.on("selectionChange",this._selectionChange,this);this.el.on("click",this._effect,this)},_effect:function(){var m=this.editor,w=m.getSelection(),
j=this.el.get("state");if(w){var f=w.createBookmarks(),i=w.getRanges(),l,r;m.fire("save");for(var q=i.length-1;q>=0;q--){l=i[q].createIterator();for(l.enlargeBr=true;r=l.getNextParagraph();){r.removeAttr("align");j==p.OFF?r.css("text-align",this.v):r.css("text-align","")}}m.notifySelectionChange();w.selectBookmarks(f);m.fire("save")}},_selectionChange:function(m){var w=this.el;m=m.path;if(m=m.block||m.blockLimit){m=m.css("text-align").replace(A,"");m==this.v||!m&&this.v=="left"?w.set("state",p.ON):
w.set("state",p.OFF)}}});t.Justify=u}();x.addPlugin(function(){new t.Justify(x,"left","\u5de6\u5bf9\u9f50 ","ke-toolbar-alignleft");new t.Justify(x,"center","\u5c45\u4e2d\u5bf9\u9f50 ","ke-toolbar-aligncenter");new t.Justify(x,"right","\u53f3\u5bf9\u9f50 ","ke-toolbar-alignright")})});
KISSY.Editor.add("link",function(x){var t=KISSY.Editor;t.Link||function(){function B(r){this.editor=r;this._init()}function p(r){return r._4e_ascendant(function(q){return q._4e_name()==="a"&&!!q.attr("href")},true)}var u=KISSY,A=t.TripleButton,m=t.Style,w=u.Node,j=t.Range,f=t.SimpleOverlay,i=t.BubbleView,l={element:"a",attributes:{href:"#(href)",target:"#(target)"}};B.init=function(){var r=new f({title:"\u4fee\u6539\u94fe\u63a5",mask:true,width:"300px"});this.dialog=r;r.body.html("<div><p><label><span style='color:#0066CC;font-weight:bold;'>\u7f51\u5740\uff1a </span><input class='ke-link-url' style='width:230px' value='http://'/></label></p><p style='margin-top: 5px;padding-left:45px'><label><input class='ke-link-blank' type='checkbox'/> &nbsp; \u5728\u65b0\u7a97\u53e3\u6253\u5f00\u94fe\u63a5</label></p></div>");
r.foot.html("<button class='ke-link-ok'>\u786e\u5b9a</button> <button class='ke-link-cancel'>\u53d6\u6d88</button>");r.urlEl=r.body.one(".ke-link-url");r.targetEl=r.body.one(".ke-link-blank");var q=r.foot.one(".ke-link-cancel");r.foot.one(".ke-link-ok").on("click",function(o){r.link._link();o.halt()},this);q.on("click",function(o){r.hide();o.halt()},this);B.init=null};i.register({pluginName:"link",func:p,init:function(){var r=this,q=r.el;q.html('\u524d\u5f80\u94fe\u63a5\uff1a  <a href=""  target="_blank" class="ke-bubbleview-url"></a> -  <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -  <span class="ke-bubbleview-link ke-bubbleview-remove">\u53bb\u9664</span>');
var o=q.one(".ke-bubbleview-url"),v=q.one(".ke-bubbleview-change");q=q.one(".ke-bubbleview-remove");v._4e_unselectable();o._4e_unselectable();q._4e_unselectable();v.on("click",function(a){r._plugin.show();a.halt()});q.on("click",function(a){r._plugin._removeLink(r._selectedEl);a.halt()});r.on("afterVisibleChange",function(){var a=r._selectedEl;if(a){o.html(a.attr("href"));o.attr("href",a.attr("href"))}})}});u.augment(B,{_init:function(){this.el=new A({container:this.editor.toolBarDiv,contentCls:"ke-toolbar-link",
title:"\u7f16\u8f91\u8d85\u94fe\u63a5 "});this.el.on("click",this.show,this);i.attach({pluginName:"link",pluginInstance:this})},_removeLink:function(r){var q=this.editor,o={href:r.attr("href")};if(r._4e_hasAttribute("target"))o.target=r.attr("target");r=new m(l,o);q.fire("save");r.remove(q.document);q.fire("save");q.notifySelectionChange()},_getSelectedLink:function(){var r=this.editor.getSelection().getRanges()[0].getCommonAncestor();if(r)r=p(r);return r},_link:function(){var r,q=this.editor,o=B.dialog,
v=o.urlEl.val(),a;if(u.trim(v)){o.hide();if(a=this._getSelectedLink()){r=new j(q.document);r.selectNodeContents(a);q.getSelection().selectRanges([r]);this._removeLink(a)}a={href:v};a.target=o.targetEl[0].checked?"_blank":"_self";r=q.getSelection().getRanges()[0];if(r.collapsed){r=new w("<a href='"+v+"' target='"+a.target+"'>"+v+"</a>",null,q.document);q.insertElement(r)}else{q.fire("save");r=new m(l,a);r.apply(q.document);q.fire("save")}q.notifySelectionChange()}},_prepare:function(){B.init&&B.init()},
_real:function(){var r=B.dialog,q=this._getSelectedLink();r.link=this;if(q){r.urlEl.val(q.attr("href"));r.targetEl[0].checked=q.attr("target")=="_blank"}r.show()},show:function(){this._prepare()}});t.Utils.lazyRun(B.prototype,"_prepare","_real");t.Link=B}();x.addPlugin(function(){new t.Link(x)})});
KISSY.Editor.add("list",function(x){var t=KISSY.Editor,B={ol:1,ul:1},p=["ol","ul"],u=KISSY,A=t.RANGE,m=t.ElementPath,w=t.Walker,j=t.NODE,f=u.UA,i=u.Node,l=u.DOM;t.List||function(){function r(d){this.type=d}function q(d){q.superclass.constructor.call(this,d);d=this.get("editor").toolBarDiv;this.el=new a({contentCls:this.get("contentCls"),title:this.get("title"),container:d});this.listCommand=new r(this.get("type"));this.listCommand.state=this.get("status");this._init()}var o={listToArray:function(d,
g,h,c,k){if(!B[d._4e_name()])return[];c||(c=0);h||(h=[]);for(var b=0,e=d[0].childNodes.length;b<e;b++){var n=new i(d[0].childNodes[b]);if(n._4e_name()=="li"){var z={parent:d,indent:c,element:n,contents:[]};if(k)z.grandparent=k;else{z.grandparent=d.parent();if(z.grandparent&&z.grandparent._4e_name()=="li")z.grandparent=z.grandparent.parent()}g&&n._4e_setMarker(g,"listarray_index",h.length);h.push(z);for(var s=0,D=n[0].childNodes.length,H;s<D;s++){H=new i(n[0].childNodes[s]);H[0].nodeType==j.NODE_ELEMENT&&
B[H._4e_name()]?o.listToArray(H,g,h,c+1,z.grandparent):z.contents.push(H)}}}return h},arrayToList:function(d,g,h,c){h||(h=0);if(!d||d.length<h+1)return null;for(var k=d[h].parent[0].ownerDocument,b=k.createDocumentFragment(),e=null,n=h,z=Math.max(d[h].indent,0),s=null;;){var D=d[n];if(D.indent==z){if(!e||d[n].parent._4e_name()!=e._4e_name()){e=d[n].parent._4e_clone(false,true);b.appendChild(e[0])}s=e[0].appendChild(D.element._4e_clone(false,true)[0]);for(var H=0;H<D.contents.length;H++)s.appendChild(D.contents[H]._4e_clone(true,
true)[0]);n++}else if(D.indent==Math.max(z,0)+1){n=o.arrayToList(d,null,n,c);s.appendChild(n.listNode);n=n.nextIndex}else if(D.indent==-1&&!h&&D.grandparent){s=B[D.grandparent._4e_name()]?D.element._4e_clone(false,true)[0]:D.grandparent._4e_name()!="td"?k.createElement(c):k.createDocumentFragment();for(H=0;H<D.contents.length;H++)s.appendChild(D.contents[H]._4e_clone(true,true)[0]);if(s.nodeType==j.NODE_DOCUMENT_FRAGMENT&&n!=d.length-1){s.lastChild&&s.lastChild.nodeType==j.NODE_ELEMENT&&s.lastChild.getAttribute("type")==
"_moz"&&l._4e_remove(s.lastChild);l._4e_appendBogus(s)}if(s.nodeType==j.NODE_ELEMENT&&l._4e_name(s)==c&&s.firstChild){l._4e_trim(s);e=s.firstChild;if(e.nodeType==j.NODE_ELEMENT&&l._4e_isBlockBoundary(e)){e=k.createDocumentFragment();l._4e_moveChildren(s,e);s=e}}e=l._4e_name(s);if(!f.ie&&(e=="div"||e=="p"))l._4e_appendBogus(s);b.appendChild(s);e=null;n++}else return null;if(d.length<=n||Math.max(d[n].indent,0)<z)break}if(g)for(d=new i(b.firstChild);d&&d[0];){d[0].nodeType==j.NODE_ELEMENT&&d._4e_clearMarkers(g,
true);d=d._4e_nextSourceNode()}return{listNode:b,nextIndex:n}}},v=/^h[1-6]$/;r.prototype={changeListType:function(d,g,h,c){var k=o.listToArray(g.root,h),b=[];for(d=0;d<g.contents.length;d++){var e=g.contents[d];e=e._4e_ascendant("li",true);if(!(!e||!e[0]||e._4e_getData("list_item_processed"))){b.push(e);e._4e_setMarker(h,"list_item_processed",true)}}e=new i(g.root[0].ownerDocument.createElement(this.type));for(d=0;d<b.length;d++){var n=b[d]._4e_getData("listarray_index");k[n].parent=e}h=o.arrayToList(k,
h,null,"p");var z;k=h.listNode.childNodes.length;for(d=0;d<k&&(z=new i(h.listNode.childNodes[d]));d++)z._4e_name()==this.type&&c.push(z);l.insertBefore(h.listNode,g.root[0]);g.root._4e_remove()},createList:function(d,g,h){var c=g.contents;d=g.root[0].ownerDocument;var k=[];if(c.length==1&&c[0][0]===g.root[0]){var b=new i(d.createElement("div"));c[0][0].nodeType!=j.NODE_TEXT&&c[0]._4e_moveChildren(b);c[0][0].appendChild(b[0]);c[0]=b}g=g.contents[0].parent();for(b=0;b<c.length;b++)g=g._4e_commonAncestor(c[b].parent());
for(b=0;b<c.length;b++)for(var e=c[b],n;n=e.parent();){if(n[0]===g[0]){k.push(e);break}e=n}if(!(k.length<1)){c=new i(k[k.length-1][0].nextSibling);b=new i(d.createElement(this.type));for(h.push(b);k.length;){h=k.shift();e=new i(d.createElement("li"));if(v.test(h._4e_name()))e[0].appendChild(h[0]);else{h._4e_copyAttributes(e);h._4e_moveChildren(e);h._4e_remove()}b[0].appendChild(e[0]);f.ie||e._4e_appendBogus()}c[0]?l.insertBefore(b[0],c[0]):g[0].appendChild(b[0])}},removeList:function(d,g,h){function c(H){if((s=
new i(z[H?"firstChild":"lastChild"]))&&!(s[0].nodeType==j.NODE_ELEMENT&&s._4e_isBlockBoundary())&&(D=g.root[H?"_4e_previous":"_4e_next"](w.whitespaces(true)))&&!(s[0].nodeType==j.NODE_ELEMENT&&D._4e_isBlockBoundary({br:1})))l[H?"insertBefore":"insertAfter"](d.document.createElement("br"),s[0])}for(var k=o.listToArray(g.root,h),b=[],e=0;e<g.contents.length;e++){var n=g.contents[e];n=n._4e_ascendant("li",true);if(!(!n||n._4e_getData("list_item_processed"))){b.push(n);n._4e_setMarker(h,"list_item_processed",
true)}}n=null;for(e=0;e<b.length;e++){n=b[e]._4e_getData("listarray_index");k[n].indent=-1;n=n}for(e=n+1;e<k.length;e++)if(k[e].indent>Math.max(k[e-1].indent,0)){b=k[e-1].indent+1-k[e].indent;for(n=k[e].indent;k[e]&&k[e].indent>=n;){k[e].indent+=b;e++}e--}var z=o.arrayToList(k,h,null,"p").listNode,s,D;c(true);c();l.insertBefore(z,g.root);g.root._4e_remove()},exec:function(d){var g=d.getSelection(),h=g&&g.getRanges();if(!(!h||h.length<1)){for(var c=g.createBookmarks(true),k=[],b={};h.length>0;){var e=
h.shift(),n=e.getBoundaryNodes(),z=n.startNode,s=n.endNode;z[0].nodeType==j.NODE_ELEMENT&&z._4e_name()=="td"&&e.setStartAt(n.startNode,A.POSITION_AFTER_START);s[0].nodeType==j.NODE_ELEMENT&&s._4e_name()=="td"&&e.setEndAt(n.endNode,A.POSITION_BEFORE_END);e=e.createIterator();for(e.forceBrBreak=false;n=e.getNextParagraph();){z=new m(n);s=z.elements;var D=null,H=false,y=z.blockLimit,C;for(z=s.length-1;z>=0&&(C=s[z]);z--)if(B[C._4e_name()]&&y.contains(C)){y._4e_removeData("list_group_object");if(z=C._4e_getData("list_group_object"))z.contents.push(n);
else{z={root:C,contents:[n]};k.push(z);C._4e_setMarker(b,"list_group_object",z)}H=true;break}if(!H)if(y._4e_getData("list_group_object"))y._4e_getData("list_group_object").contents.push(n);else{z={root:y,contents:[n]};y._4e_setMarker(b,"list_group_object",z);k.push(z)}}}for(h=[];k.length>0;){z=k.shift();if(this.state=="off")B[z.root._4e_name()]?this.changeListType(d,z,b,h):this.createList(d,z,h);else this.state=="on"&&B[z.root._4e_name()]&&this.removeList(d,z,b)}for(z=0;z<h.length;z++){D=h[z];var I=
this;(d=function(J){var N=D[J?"_4e_previous":"_4e_next"](w.whitespaces(true));if(N&&N[0]&&N._4e_name()==I.type){N._4e_remove();N._4e_moveChildren(D,J?true:false)}})();d(true)}t.Utils.clearAllMarkers(b);g.selectBookmarks(c)}}};var a=t.TripleButton;q.ATTRS={editor:{},type:{},contentCls:{}};u.extend(q,u.Base,{_init:function(){var d=this,g=d.get("editor"),h=d.el;d=d;h.on("click",d._change,d);g.on("selectionChange",d._selectionChange,d)},_change:function(){var d=this.get("editor");this.get("type");var g=
this.el;d.fire("save");this.listCommand.state=g.get("state");this.listCommand.exec(d);d.fire("save");d.notifySelectionChange()},_selectionChange:function(d){this.get("editor");var g=this.get("type"),h=d.path,c;d=this.el;var k=h.blockLimit;if(h=h.elements)for(var b=0;b<h.length&&(c=h[b])&&c[0]!==k[0];b++){var e=u.indexOf(h[b]._4e_name(),p);if(e!==-1)if(p[e]===g){d.set("state",a.ON);return}else break}d.set("state",a.OFF)}});t.ListUtils=o;t.List=q}();x.addPlugin(function(){new t.List({editor:x,title:"\u9879\u76ee\u5217\u8868",
contentCls:"ke-toolbar-ul",type:"ul"});new t.List({editor:x,title:"\u7f16\u53f7\u5217\u8868",contentCls:"ke-toolbar-ol",type:"ol"})})});
KISSY.Editor.add("maximize",function(x){var t=KISSY.Editor,B=KISSY,p=B.UA,u=B.Node,A=B.Event,m=t.TripleButton,w=B.DOM,j;t.Maximize||function(){function f(i){this.editor=i;this._init()}f.init=function(){j=new u("<iframe style='position:absolute;top:-9999px;left:-9999px;' frameborder='0'></iframe>");document.body.appendChild(j[0]);f.init=null};B.augment(f,{_init:function(){this.el=new m({container:this.editor.toolBarDiv,cls:"ke-tool-editor-source",title:"\u5168\u5c4f",contentCls:"ke-toolbar-maximize"});
this.el.on("offClick",this.maximize,this);this.el.on("onClick",this.restore,this);t.Utils.lazyRun(this,"_prepare","_real")},restore:function(){var i=this,l=i.editor;A.remove(window,"resize",i._maximize,i);this._saveEditorStatus();l.wrap.css({height:i.iframeHeight});(new u(document.body)).css({width:"",height:"",overflow:""});document.documentElement.style.overflow="";l.editorWrap.css({position:"static",width:i.editorWrapWidth});j.css({left:"-99999px",top:"-99999px"});window.scrollTo(i.scrollLeft,
i.scrollTop);i.el.set("state",m.OFF);setTimeout(function(){i._restoreEditorStatus()},30);l.notifySelectionChange()},_saveSate:function(){var i=this.editor;this.iframeHeight=i.wrap._4e_style("height");this.editorWrapWidth=i.editorWrap._4e_style("width");this.scrollLeft=w.scrollLeft();this.scrollTop=w.scrollTop();window.scrollTo(0,0)},_saveEditorStatus:function(){var i=this.editor;if(p.gecko&&i.iframeFocus)this.savedRanges=(i=i.getSelection())&&i.getRanges()},_restoreEditorStatus:function(){var i=this.editor,
l=i.getSelection();if(p.gecko&&i.iframeFocus){this.el.el[0].focus();i.focus();this.savedRanges&&l&&l.selectRanges(this.savedRanges)}if(i.iframeFocus&&l)(i=l.getStartElement())&&i[0]&&i._4e_scrollIntoView()},_maximize:function(){var i=this.editor,l=w.viewportHeight(),r=w.viewportWidth(),q=i.statusDiv?i.statusDiv.height():0,o=i.toolBarDiv.height();if(p.ie){document.documentElement.style.overflow="hidden";document.body.style.overflow="hidden"}else(new u(document.body)).css({width:0,height:0,overflow:"hidden"});
i.editorWrap.css({position:"absolute",zIndex:990,width:r+"px"});j.css({zIndex:985,height:l+"px",width:r+"px"});i.editorWrap.offset({left:0,top:0});j.css({left:0,top:0});i.wrap.css({height:l-q-o-14+"px"});i.notifySelectionChange()},_real:function(){var i=this;this._saveEditorStatus();this._saveSate();this._maximize();this._maximize();A.on(window,"resize",i._maximize,i);this.el.set("state",m.ON);setTimeout(function(){i._restoreEditorStatus()},30)},_prepare:function(){f.init&&f.init()},maximize:function(){this._prepare()}});
t.Maximize=f}();x.addPlugin(function(){new t.Maximize(x)})});
KISSY.Editor.add("music",function(x){var t=KISSY,B=t.Node,p=t.DOM,u=t.Editor,A=t.Event;u.MusicInserter||function(){function m(a){m.superclass.constructor.call(this,a);a=this.get("editor");a._toolbars=a._toolbars||{};a._toolbars.music=this;this._init()}function w(a){return a.replace(/^.+niftyplayer\.swf\?file=/,"")}var j=u.ContextMenu,f=u.SimpleOverlay,i=u.TripleButton,l=u.Utils.getFlashUrl,r='<object  width="165" height="37" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,0,0" classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"><param value="'+(u.Config.base+
'plugins/music/niftyplayer.swf?file=#(music)"')+' name="movie"/><param value="high" name="quality"/><param value="#FFFFFF" name="bgcolor"/><embed width="165" height="37" type="application/x-shockwave-flash" swliveconnect="true" src="'+(u.Config.base+'plugins/music/niftyplayer.swf?file=#(music)"')+'quality="high" pluginspage="http://www.macromedia.com/go/getflashplayer" bgcolor="#FFFFFF" /></object>',q=/#\(music\)/g,o=["img.ke_music"];m.ATTRS={editor:{}};m.tip=function(){var a=this,d=new B('<div class="ke-bubbleview-bubble" onmousedown="return false;">\u97f3\u4e50\u7f51\u5740\uff1a  <a class="ke-bubbleview-url" target="_blank" href="#"></a> -     <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -     <span class="ke-bubbleview-link ke-bubbleview-remove">\u5220\u9664</span></div>');
d._4e_unselectable();a.tipwin=new f({el:d,focusMgr:false});document.body.appendChild(d[0]);a.tipurl=d.one(".ke-bubbleview-url");var g=d.one(".ke-bubbleview-change");d=d.one(".ke-bubbleview-remove");g.on("click",function(h){a.tipwin.music.show();h.halt()});a.tipwin.on("hide",function(){var h=a.tipwin.music;h&&(!h.d||!h.d.get("visible"))&&(h.selectedFlash=null)});A.on(document,"click",function(){a.tipwin.hide()});d.on("click",function(h){var c=a.tipwin.music;c.selectedFlash._4e_remove();c.get("editor").notifySelectionChange();
h.halt()});a.tip=null};t.extend(m,t.Base,{_init:function(){var a=this.get("editor"),d={};this.el=new i({contentCls:"ke-toolbar-music",title:"\u5206\u4eab\u97f3\u4e50",container:a.toolBarDiv});A.on(a.document,"dblclick",this._dblclick,this);for(var g in v)(function(h){d[h]=function(){v[h](a)}})(g);j.register(a.document,{rules:o,width:"120px",funcs:d});this.el.on("offClick",this.show,this);u.Utils.lazyRun(this,"_prepare","_real");a.on("selectionChange",this._selectionChange,this)},_selectionChange:function(a){a=
a.path;var d=a.elements;if(a&&d)if(a=a.lastElement)(a=a._4e_ascendant(function(g){return g._4e_name()==="img"&&!!g.hasClass("ke_music")},true))?this._showTip(a):this._hideTip()},_showTip:function(a){this._prepareTip(a)},_hideTip:function(){m.tipwin&&m.tipwin.hide()},_prepareTip:function(){m.tip&&m.tip()},_realTip:function(a){var d=this.get("editor"),g=a._4e_getOffset(document);g.top+=a.height()+5;m.tipwin.show(g);this.selectedFlash=a;a=d.restoreRealElement(this.selectedFlash);m.tipwin.music=this;
m.tipurl.html(w(l(a)));m.tipurl.attr("href",w(l(a)))},_prepare:function(){var a=this,d=a.get("editor");a.d=new f({title:"\u7f16\u8f91\u97f3\u4e50",mask:true,width:"350px"});var g=a.d;g.body.html("<div><p><label><span style='color:#0066CC;font-weight:bold;'>\u97f3\u4e50\u7f51\u5740\uff1a </span><input class='ke-music-url' style='width:230px' value='http://'/></label></p></div>");g.foot.html("<button class='ke-music-insert'>\u786e\u5b9a</button> <button class='ke-music-cancel'>\u53d6\u6d88</button>");
a.content=g.el;var h=a.content;g.on("hide",function(){a.selectedFlash=null});g=h.one(".ke-music-cancel");var c=h.one(".ke-music-insert");a.musicUrl=h.one(".ke-music-url");g.on("click",function(k){a.d.hide();k.halt()});A.on(document,"click",a.hide,a);A.on(d.document,"click",a.hide,a);c.on("click",function(){a._insert()})},hide:function(a){var d=this;p._4e_ascendant(a.target,function(g){return g[0]===d.content[0]||g[0]===d.el.el[0]})||this.d.hide()},_real:function(){this.d.show()},_insert:function(){var a=
this.get("editor"),d=this.musicUrl.val();if(d){d=r.replace(q,d);var g=new B(d,null,a.document);d=a.createFakeElement?a.createFakeElement(g,"ke_music","music",true,d):g;a.insertElement(d);this.selectedFlash&&a.getSelection().selectElement(d);this.d.hide()}},_dblclick:function(a){var d=new B(a.target);if(d._4e_name()==="img"&&d.hasClass("ke_music")){this.selectedFlash=d;this.show();a.halt()}},show:function(){this._prepare();if(this.selectedFlash){var a=this.get("editor").restoreRealElement(this.selectedFlash);
this.musicUrl.val(w(l(a)))}else this.musicUrl.val("")}});u.Utils.lazyRun(m.prototype,"_prepareTip","_realTip");u.MusicInserter=m;var v={"\u7f16\u8f91\u97f3\u4e50":function(a){var d=a.getSelection();if(d=(d=d&&d.getStartElement())&&d._4e_ascendant("img",true))if(d.hasClass("ke_music")){a=a._toolbars.music;a.selectedFlash=d;a.show()}}}}();x.addPlugin(function(){new u.MusicInserter({editor:x});var m=p._4e_getWin(x.document);A.on(m,"scroll",function(){u.MusicInserter.tipwin&&u.MusicInserter.tipwin.hide()})})});
KISSY.Editor.add("preview",function(x){var t=KISSY.Editor,B=KISSY,p=t.TripleButton;t.Preview||function(){function u(A){this.editor=A;this._init()}B.augment(u,{_init:function(){this.el=new p({container:this.editor.toolBarDiv,cls:"ke-tool-editor-source",title:"\u9884\u89c8",contentCls:"ke-toolbar-preview"});this.el.on("offClick",this._show,this)},_show:function(){var A=this.editor,m=640,w=420,j=80;try{var f=window.screen;m=Math.round(f.width*0.8);w=Math.round(f.height*0.7);j=Math.round(f.width*0.1)}catch(i){}A=
A._prepareIFrameHtml().replace(/<body[^>]+>.+<\/body>/,"<body>\n"+A.getData()+"\n</body>");m=window.open("",null,"toolbar=yes,location=no,status=yes,menubar=yes,scrollbars=yes,resizable=yes,width="+m+",height="+w+",left="+j);m.document.open();m.document.write(A);m.document.close()}});t.Preview=u}();x.addPlugin(function(){new t.Preview(x)})});
KISSY.Editor.add("removeformat",function(x){function t(l){this.editor=l;this._init()}function B(l,r){for(var q=0;q<r.length;q++)l.removeAttr(r[q])}var p=KISSY.Editor,u=KISSY,A=p.RANGE,m=p.ElementPath,w=p.NODE,j=p.TripleButton,f="b,big,code,del,dfn,em,font,i,ins,kbd,q,samp,small,span,strike,strong,sub,sup,tt,u,var,s",i="class,style,lang,width,height,align,hspace,valign".split(",");f=new RegExp("^(?:"+f.replace(/,/g,"|")+")$","i");u.augment(t,{_init:function(){this.el=new j({title:"\u6e05\u9664\u683c\u5f0f",
contentCls:"ke-toolbar-removeformat",container:this.editor.toolBarDiv});this.el.on("offClick",this._remove,this)},_remove:function(){var l=this.editor,r=f;r.lastIndex=0;var q=l.getSelection().getRanges();l.fire("save");for(var o=0,v;v=q[o];o++)if(!v.collapsed){v.enlarge(A.ENLARGE_ELEMENT);var a=v.createBookmark(),d=a.startNode,g=a.endNode,h=function(c){for(var k=new m(c),b=k.elements,e=1,n;n=b[e];e++){if(n._4e_equals(k.block)||n._4e_equals(k.blockLimit))break;r.test(n._4e_name())&&c._4e_breakParent(n)}};
h(d);h(g);for(d=d._4e_nextSourceNode(true,w.NODE_ELEMENT);d;){if(d._4e_equals(g))break;h=d._4e_nextSourceNode(false,w.NODE_ELEMENT);d._4e_name()=="img"&&d.attr("_cke_realelement")||(r.test(d._4e_name())?d._4e_remove(true):B(d,i));d=h}v.moveToBookmark(a)}l.getSelection().selectRanges(q);l.fire("save")}});x.addPlugin(function(){new t(x)})});
KISSY.Editor.add("smiley",function(x){var t=KISSY.Editor,B=KISSY,p=B.DOM,u=B.Event,A=B.Node,m=t.SimpleOverlay,w=t.TripleButton;t.Smiley||function(){function j(l){this.editor=l;this._init()}for(var f="<div class='ke-popup-wrap'><div class='ke-smiley-sprite'>",i=0;i<=98;i++)f+="<a href='#' data-icon='http://a.tbcdn.cn/sys/wangwang/smiley/48x48/"+i+".gif'></a>";f+="</div></div>";B.augment(j,{_init:function(){this.el=new w({contentCls:"ke-toolbar-smiley",title:"\u63d2\u5165\u8868\u60c5",container:this.editor.toolBarDiv});
this.el.on("offClick",this._show,this);t.Utils.lazyRun(this,"_prepare","_real")},_hidePanel:function(l){var r=this;p._4e_ascendant(l.target,function(q){return q[0]===r.el.el[0]})||this.smileyWin.hide()},_selectSmiley:function(l){l.halt();var r=this.editor;l=l.target;var q;if(p._4e_name(l)=="a"&&(q=p.attr(l,"data-icon"))){q=new A("<img src='"+q+"'/>",null,r.document);r.insertElement(q);this.smileyWin.hide()}},_prepare:function(){var l=this.editor;this.smileyPanel=new A(f);this.smileyWin=new m({el:this.smileyPanel,
focusMgr:false,mask:false});document.body.appendChild(this.smileyPanel[0]);this.smileyPanel.on("click",this._selectSmiley,this);u.on(document,"click",this._hidePanel,this);u.on(l.document,"click",this._hidePanel,this)},_real:function(){var l=this.el.el.offset();l.top+=this.el.el.height()+5;if(l.left+this.smileyPanel.width()>p.viewportWidth()-60)l.left=p.viewportWidth()-this.smileyPanel.width()-60;this.smileyWin.show(l)},_show:function(l){this._prepare(l)}});t.Smiley=j}();x.addPlugin(function(){new t.Smiley(x)})});
KISSY.Editor.add("sourcearea",function(x){var t=KISSY.Editor,B=KISSY,p=B.UA,u=t.TripleButton;t.SourceArea||function(){function A(m){this.editor=m;this._init()}B.augment(A,{_init:function(){var m=this.editor;this.el=new u({container:m.toolBarDiv,cls:"ke-tool-editor-source",title:"\u6e90\u7801",contentCls:"ke-toolbar-source"});this.el.on("offClick",this._show,this);this.el.on("onClick",this._hide,this);m.textarea.on("mousedown",function(w){w.stopPropagation()})},_show:function(){var m=this.editor,w=
this.el;m.textarea.val(m.getData());m._showSource();w.set("state",u.ON)},_hide:function(){var m=this.editor,w=m.textarea,j=this.el;m._hideSource();m.setData(w.val());if(p.gecko&&m.iframeFocus){j.el[0].focus();m.focus()}j.set("state",u.OFF)}});t.SourceArea=A}();x.addPlugin(function(){new t.SourceArea(x)})});
KISSY.Editor.add("table",function(x,t){var B=KISSY.Editor,p=KISSY,u=p.Node,A=p.DOM,m=B.Walker,w=p.UA,j=B.NODE,f=B.TripleButton,i=B.SimpleOverlay,l=B.ContextMenu,r=["tr","th","td","tbody","table"],q=p.trim,o;o=(w.ie===6?["table.%2,","table.%2 td, table.%2 th,","{","border : #d3d3d3 1px dotted","}"]:[" table.%2,"," table.%2 > tr > td,  table.%2 > tr > th,"," table.%2 > tbody > tr > td,  table.%2 > tbody > tr > th,"," table.%2 > thead > tr > td,  table.%2 > thead > tr > th,"," table.%2 > tfoot > tr > td,  table.%2 > tfoot > tr > th",
"{","border : #d3d3d3 1px dotted","}"]).join("").replace(/%2/g,"ke_show_border");var v=x.htmlDataProcessor,a=v&&v.dataFilter;v=v&&v.htmlFilter;a&&a.addRules({elements:{table:function(d){d=d.attributes;var g=d["class"],h=parseInt(d.border,10);if(!h||h<=0)d["class"]=(g||"")+" ke_show_border"}}});v&&v.addRules({elements:{table:function(d){d=d.attributes;var g=d["class"];if(g)d["class"]=p.trim(g.replace("ke_show_border","").replace(/\s{2}/," "))}}});B.TableUI||function(){function d(y){this.editor=y;this.selectedTable=
null;y._toolbars=y._toolbars||{};y._toolbars.table=this;this._init()}function g(y){return q(y).length!=0}function h(y){function C($){if(!(N.length>0))if($[0].nodeType==j.NODE_ELEMENT&&D.test($._4e_name())&&!$._4e_getData("selected_cell")){$._4e_setMarker(M,"selected_cell",true);N.push($)}}for(var I=y.createBookmarks(),J=y.getRanges(),N=[],M={},Q=0;Q<J.length;Q++){var R=J[Q];if(R.collapsed){R=R.getCommonAncestor();(R=R._4e_ascendant("td",true)||R._4e_ascendant("th",true))&&N.push(R)}else{R=new m(R);
var W;for(R.guard=C;W=R.next();)if((W=W.parent())&&D.test(W._4e_name())&&!W._4e_getData("selected_cell")){W._4e_setMarker(M,"selected_cell",true);N.push(W)}}}B.Utils.clearAllMarkers(M);y.selectBookmarks(I);return N}function c(y){y=y.cells;for(var C=0;C<y.length;C++){y[C].innerHTML="";w.ie||(new u(y[C]))._4e_appendBogus()}}function k(y,C){if(y=y.getStartElement()._4e_ascendant("tr")){var I=y._4e_clone(true);I.insertBefore(y);c(C?I[0]:y[0])}}function b(y){if(y instanceof B.Selection){var C=h(y),I=C.length;
y=[];for(var J,N,M=0;M<I;M++){var Q=C[M].parent(),R=Q[0].rowIndex;!M&&(J=R-1);y[R]=Q;M==I-1&&(N=R+1)}M=Q._4e_ascendant("table");J=new u(N<M[0].rows.length&&M[0].rows[N]||J>0&&M[0].rows[J]||M[0].parentNode);for(M=y.length;M>=0;M--)y[M]&&b(y[M]);return J}else if(y instanceof u){M=y._4e_ascendant("table");M[0].rows.length==1?M._4e_remove():y._4e_remove()}return 0}function e(y,C){y=y.getStartElement();if(y=y._4e_ascendant("td",true)||y._4e_ascendant("th",true))for(var I=y._4e_ascendant("table"),J=y[0].cellIndex,
N=0;N<I[0].rows.length;N++){var M=I[0].rows[N];if(!(M.cells.length<J+1)){y=new u(M.cells[J].cloneNode(false));w.ie||y._4e_appendBogus();M=new u(M.cells[J]);C?y.insertBefore(M):y.insertAfter(M)}}}function n(y){var C=[],I=y[0]&&y[0]._4e_ascendant("table"),J,N,M,Q;J=0;for(N=y.length;J<N;J++)C.push(y[J][0].cellIndex);C.sort();J=1;for(N=C.length;J<N;J++)if(C[J]-C[J-1]>1){M=C[J-1]+1;break}M||(M=C[0]>0?C[0]-1:C[C.length-1]+1);y=I[0].rows;J=0;for(N=y.length;J<N;J++)if(Q=y[J].cells[M])break;return Q?new u(Q):
I._4e_previous()}function z(y){if(y instanceof B.Selection){var C=h(y),I=n(C);for(y=C.length-1;y>=0;y--)C[y]&&z(C[y]);return I}else if(y instanceof u){C=y._4e_ascendant("table");if(!C)return null;I=y[0].cellIndex;for(y=C[0].rows.length-1;y>=0;y--){var J=new u(C[0].rows[y]);if(!I&&J[0].cells.length==1)b(J);else J[0].cells[I]&&J[0].removeChild(J[0].cells[I])}}return null}function s(y,C){var I=new B.Range(y[0].ownerDocument);if(!I.moveToElementEditablePosition(y,C?true:t)){I.selectNodeContents(y);I.collapse(C?
false:true)}I.select(true)}p.augment(d,{_init:function(){var y=this.editor,C={};this.el=new f({contentCls:"ke-toolbar-table",title:"\u8868\u683c",container:y.toolBarDiv});this.el.on("offClick",this._tableShow,this);for(var I in H)(function(J){C[J]=function(){y.fire("save");H[J](y);y.fire("save")}})(I);l.register(y.document,{rules:r,width:"120px",funcs:C});B.Utils.lazyRun(this,"_prepareTableShow","_realTableShow")},_tableInit:function(){var y=this,C=new i({width:"350px",mask:true,title:"\u7f16\u8f91\u8868\u683c"});
C.body.html("<table class='ke-table-config'><tr><td><label>\u884c\u6570\uff1a <input value='2' class='ke-table-rows ke-table-create-only' size='8'/></label></td><td><label>\u5bbd\u5ea6\uff1a <input value='200' class='ke-table-width' size='8'/></label> <select class='ke-table-width-unit'><option value='px'>\u50cf\u7d20</option><option value='%'>\u767e\u5206\u6bd4</option></select></td></tr><tr><td><label>\u5217\u6570\uff1a <input class='ke-table-cols ke-table-create-only' value='3' size='8'/></label></td><td><label>\u9ad8\u5ea6\uff1a <input value='' class='ke-table-height' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td><label>\u5bf9\u9f50\uff1a <select class='ke-table-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option><option value='center'>\u4e2d\u95f4\u5bf9\u9f50</option></select></label></td><td><label>\u95f4\u8ddd\uff1a <input value='1' class='ke-table-cellspacing' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td><label>\u6807\u9898\u683c\uff1a <select class='ke-table-head ke-table-create-only'><option value=''>\u65e0</option><option value='1'>\u6709</option></select></td><td><label>\u8fb9\u8ddd\uff1a <input value='1' class='ke-table-cellpadding' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td></td><td><label>\u8fb9\u6846\uff1a <input value='1' class='ke-table-border' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td colspan='2'><label>\u6807\u9898\uff1a<input class='ke-table-caption' style='width:270px'></label></td></tr></table>");
C.foot.html("<button class='ke-table-ok'>\u786e\u5b9a</button> <button class='ke-table-cancel'>\u53d6\u6d88</button>");C.twidth=C.body.one(".ke-table-width");C.theight=C.body.one(".ke-table-height");C.tcellspacing=C.body.one(".ke-table-cellspacing");C.tcellpadding=C.body.one(".ke-table-cellpadding");C.tborder=C.body.one(".ke-table-border");C.tcaption=C.body.one(".ke-table-caption");C.talign=C.body.one(".ke-table-align");C.trows=C.body.one(".ke-table-rows");C.tcols=C.body.one(".ke-table-cols");C.thead=
C.body.one(".ke-table-head");var I=C.foot.one(".ke-table-ok"),J=C.foot.one(".ke-table-cancel");C.twidthunit=C.body.one(".ke-table-width-unit");y.tableDialog=C;I.on("click",y._tableOk,y);C.on("hide",function(){y.selectedTable=null});J.on("click",function(){C.hide()})},_tableOk:function(){this.selectedTable?this._modifyTable():this._genTable()},_modifyTable:function(){var y=this.tableDialog,C=this.selectedTable,I=C.one("caption");g(y.talign.val())&&C.attr("align",q(y.talign.val()));g(y.tcellspacing.val())&&
C.attr("cellspacing",q(y.tcellspacing.val()));g(y.tcellpadding.val())&&C.attr("cellpadding",q(y.tcellpadding.val()));g(y.tborder.val())&&C.attr("border",q(y.tborder.val()));!g(y.tborder.val())||y.tborder.val()=="0"?C.addClass("ke_show_border"):C.removeClass("ke_show_border");g(y.twidth.val())&&C.css("width",q(y.twidth.val())+y.twidthunit.val());g(y.theight.val())&&C.css("height",q(y.theight.val()));if(g(y.tcaption.val()))I&&I[0]?I.html(q(y.tcaption.val())):(new u("<caption><span>"+q(y.tcaption.val())+
"</span></caption>")).insertBefore(C[0].firstChild);else I&&I._4e_remove();y.hide()},_genTable:function(){var y=this.tableDialog,C="<table ",I,J=parseInt(y.tcols.val()),N=parseInt(y.trows.val()),M=w.ie?"&nbsp;":"<br/>",Q=this.editor;if(p.trim(y.talign.val()).length!=0)C+="align='"+p.trim(y.talign.val())+"' ";if(p.trim(y.tcellspacing.val()).length!=0)C+="cellspacing='"+p.trim(y.tcellspacing.val())+"' ";if(p.trim(y.tcellpadding.val()).length!=0)C+="cellpadding='"+p.trim(y.tcellpadding.val())+"' ";if(p.trim(y.tborder.val()).length!=
0)C+="border='"+p.trim(y.tborder.val())+"' ";if(p.trim(y.twidth.val()).length!=0||p.trim(y.theight.val()).length!=0){C+="style='";if(p.trim(y.twidth.val()).length!=0)C+="width:"+p.trim(y.twidth.val())+y.twidthunit.val()+";";if(p.trim(y.theight.val()).length!=0)C+="height:"+p.trim(y.theight.val())+"px;";C+="' "}if(p.trim(y.tborder.val()).length==0||p.trim(y.tborder.val())=="0")C+="class='ke_show_border' ";C+=">";if(p.trim(y.tcaption.val()))C+="<caption><span>"+p.trim(y.tcaption.val())+"</span></caption>";
if(y.thead.val()){C+="<thead>";C+="<tr>";for(I=0;I<J;I++)C+="<th>"+M+"</th>";C+="</tr>";C+="</thead>"}C+="<tbody>";for(var R=0;R<N;R++){C+="<tr>";for(I=0;I<J;I++)C+="<td>"+M+"</td>";C+="</tr>"}C+="</tbody>";C+="</table>";C=new u(C,null,Q.document);Q.insertElement(C);y.hide()},_fillTableDialog:function(){var y=this.tableDialog,C=this.selectedTable,I=C.one("caption");y.talign.val(C.attr("align")||"");y.tcellspacing.val(C.attr("cellspacing")||"");y.tcellpadding.val(C.attr("cellpadding")||"");y.tborder.val(C.attr("border")|
"");var J=C._4e_style("width")||"";y.twidth.val(J.replace(/px|%/i,""));J.indexOf("%")!=-1?y.twidthunit.val("%"):y.twidthunit.val("px");y.theight.val((C._4e_style("height")||"").replace(/px|%/i,""));J="";if(I)J=I.text();y.tcaption.val(J);y.trows.val(C.one("tbody").children().length);y.tcols.val(C.one("tr").children().length);y.thead.val(C._4e_first(function(N){return N._4e_name()=="thead"})?"1":"")},_realTableShow:function(){if(this.selectedTable){this._fillTableDialog();this.tableDialog.body.all(".ke-table-create-only").attr("disabled",
"disabled")}else this.tableDialog.body.all(".ke-table-create-only").removeAttr("disabled");this.tableDialog.show()},_prepareTableShow:function(){this._tableInit()},_tableShow:function(){this._prepareTableShow()}});var D=/^(?:td|th)$/,H={"\u8868\u683c\u5c5e\u6027":function(y){var C=y.getSelection();if(C=(C=C&&C.getStartElement())&&C._4e_ascendant("table",true)){y=y._toolbars.table;y.selectedTable=C;y._tableShow()}},"\u5220\u9664\u8868\u683c":function(y){var C=(y=y.getSelection())&&y.getStartElement();
if(C=C&&C._4e_ascendant("table",true)){y.selectElement(C);var I=y.getRanges()[0];I.collapse();y.selectRanges([I]);y=C.parent();y[0].childNodes.length==1&&y._4e_name()!="body"?y._4e_remove():C._4e_remove()}},"\u5220\u9664\u884c ":function(y){y=y.getSelection();s(b(y),t)},"\u5220\u9664\u5217 ":function(y){y=y.getSelection();(y=z(y))&&s(y,true)},"\u5728\u4e0a\u65b9\u63d2\u5165\u884c":function(y){y=y.getSelection();k(y,true)},"\u5728\u4e0b\u65b9\u63d2\u5165\u884c":function(y){y=y.getSelection();k(y,t)},
"\u5728\u5de6\u4fa7\u63d2\u5165\u5217":function(y){y=y.getSelection();e(y,true)},"\u5728\u53f3\u4fa7\u63d2\u5165\u5217":function(y){y=y.getSelection();e(y,t)}};B.TableUI=d}();x.addPlugin(function(){var d=x.document;new B.TableUI(x);var g=A.create("<style>",null,d);d.getElementsByTagName("head")[0].appendChild(g);if(g.styleSheet)g.styleSheet.cssText=o;else g.appendChild(d.createTextNode(o))})});
KISSY.Editor.add("templates",function(x){var t=KISSY.Editor,B=KISSY,p=B.Node,u=t.TripleButton,A=t.SimpleOverlay;t.TplUI||function(){function m(w){this.editor=w;this._init()}B.augment(m,{_init:function(){(new u({container:this.editor.toolBarDiv,contentCls:"ke-toolbar-template",title:"\u6a21\u677f"})).on("click",this._show,this);t.Utils.lazyRun(this,"_prepare","_real")},_prepare:function(){for(var w=this.editor,j=w.cfg.pluginConfig.templates,f="<div class='ke-tpl'>",i=0;i<j.length;i++)f+="<a href='javascript:void(0)' class='ke-tpl-list' tabIndex='-1'>"+
j[i].demo+"</a>";f+="</div>";this._initDialogOk=true;var l=new A({mask:true,title:"\u5185\u5bb9\u6a21\u677f"});l.body.html(f);l.body.all(".ke-tpl-list").on("click",function(r){r.halt();r=(new p(r.target))._4e_index();r!=-1&&w.insertHtml(j[r].html);l.hide()});this.ui=l},_real:function(){this.ui.show()},_show:function(){this._prepare()}});t.TplUI=m}();x.addPlugin(function(){new t.TplUI(x)})});
KISSY.Editor.add("undo",function(x){var t=KISSY.Editor,B=KISSY,p=t.Utils.arrayCompare,u=B.UA,A=B.Event;t.UndoManager||function(){function m(o){var v=o._getRawData();o=v&&o.getSelection();this.contents=v;this.bookmarks=o&&o.createBookmarks2(true)}function w(o,v,a){this.s=o;this.fn=v;this.scope=a||window;this.bufferTimer=null}function j(o){this.history=[];this.index=0;this.editor=o;this.bufferTimer=new w(500,this.save,this);this._init()}function f(o,v,a,d){this.editor=o;this.title=a;this.text=v;this.contentCls=
d;this._init()}B.augment(m,{equals:function(o){if(this.contents!=o.contents)return false;var v=this.bookmarks;o=o.bookmarks;if(v||o){if(!v||!o||v.length!=o.length)return false;for(var a=0;a<v.length;a++){var d=v[a],g=o[a];if(d.startOffset!=g.startOffset||d.endOffset!=g.endOffset||!p(d.start,g.start)||!p(d.end,g.end))return false}}return true}});B.augment(w,{run:function(){if(this.bufferTimer){clearTimeout(this.bufferTimer);this.bufferTimer=null}var o=this;this.bufferTimer=setTimeout(function(){o.fn.call(o.scope)},
this.s)}});var i={16:1,17:1,18:1},l={37:1,38:1,39:1,40:1};B.augment(j,{_keyMonitor:function(){var o=this.editor;A.on(o.document,"keydown",function(v){var a=v.keyCode;if(!(a in l||a in i))if(a===90&&(v.ctrlKey||v.metaKey)){o.fire("restore",{d:-1});v.halt()}else if(a===89&&(v.ctrlKey||v.metaKey)){o.fire("restore",{d:1});v.halt()}else o.fire("save",{buffer:1})})},_init:function(){var o=this,v=o.editor;v.on("save",function(a){a.buffer?o.bufferTimer.run():o.save()});v.on("restore",this.restore,this);o._keyMonitor()},
save:function(){this.history.length>this.index+1&&this.history.splice(this.index+1,this.history.length-this.index-1);var o=this.editor,v=this.history.length>0?this.history[this.history.length-1]:null,a=new m(this.editor);if(!v||!v.equals(a)){this.history.length===30&&this.history.shift();this.history.push(a);this.index=this.history.length-1;o.fire("afterSave",{history:this.history,index:this.index})}},restore:function(o){o=o.d;var v=this.editor,a=this.history.length>0?this.history[this.index+o]:null;
if(a){v._setRawData(a.contents);if(a.bookmarks)this.editor.getSelection().selectBookmarks(a.bookmarks);else if(u.ie){a=this.editor.document.body.createTextRange();a.collapse(true);a.select()}this.index+=o;v.fire("afterRestore",{history:this.history,index:this.index});v.notifySelectionChange()}}});var r=t.TripleButton,q={redo:1,undo:-1};B.augment(f,{_init:function(){var o=this,v=o.editor;o.el=new r({contentCls:o.contentCls,title:o.title,container:v.toolBarDiv});this.el.set("state",r.DISABLED);v.on("afterSave",
this._respond,this);v.on("afterRestore",this._respond,this);o.el.on("offClick",function(){v.fire("restore",{d:q[o.text]})})},_respond:function(o){this.updateUI(o.history,o.index)},updateUI:function(o,v){if(this.text=="undo")v>0&&o.length>0?this.el.set("state",r.OFF):this.el.set("state",r.DISABLED);else if(this.text=="redo")v<o.length-1?this.el.set("state",r.OFF):this.el.set("state",r.DISABLED)}});t.UndoManager=j;t.RestoreUI=f}();x.addPlugin(function(){new t.UndoManager(x);new t.RestoreUI(x,"undo",
"\u64a4\u9500","ke-toolbar-undo");new t.RestoreUI(x,"redo","\u91cd\u505a","ke-toolbar-redo")})});
